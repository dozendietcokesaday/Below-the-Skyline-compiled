<!DOCTYPE html>
<html>
<!--
Copyright 2010 by Dan Fabulich.

Dan Fabulich licenses this file to you under the
ChoiceScript License, Version 1.0 (the "License"); you may
not use this file except in compliance with the License. 
You may obtain a copy of the License at

 http://www.choiceofgames.com/LICENSE-1.0.txt

See the License for the specific language governing
permissions and limitations under the License.

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
either express or implied.
-->
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name = "viewport" content = "width = device-width, initial-scale = 1.0, maximum-scale = 1.0">
<!-- INSERT correct meta values -->
<!-- <title>Below the Skyline</title> -->

<script>window.version="UNKNOWN"</script>





<style id="dynamic"></style>






<!--[if IE 6]><style>.alertify-logs { position: absolute; }</style><![endif]-->
<meta name="apple-mobile-web-app-capable" content="yes" />
<script>
// INSERT store name; disabled by default because it's confusing for newbie authors
window.storeName = "Below the Skyline";
//Scene.generatedFast = true;
var rootDir = "../";
</script><meta property="ifiction:ifid" content="8537D9F5-10FA-45BB-916E-73403C5C79EA" prefix="ifiction: http://babel.ifarchive.org/protocol/iFiction/"><script>allScenes = {"startup": {"crc":1784120676, "lines":["*create implicit_control_flow true","*title Below the Skyline","*author dozendietcokesaday","*ifid 8537d9f5-10fa-45bb-916e-73403c5c79ea","*scene_list","    chapter0","    chapter1","    chapter2","    chapter3","    chapter4","    chapter5","    ending","    eric_fight","    eric_subplot","    katie_fight","    katie_subplot","    danny_fight","    danny_subplot","    chloe_fight","    chloe_subplot","    afterhours","    training_montages","    upgrades","    utils","","*comment Show stats increase or not. TODO: not implemented yet","*create show_stats_increase False","","*comment Date information","*comment spring: March-May, summer: June-August, autumn (September-November), winter (December-February)","*create current_month \"April\"","*create current_year \"2024\"","*create current_season \"spring\"","","*comment Gender choice. 1 = Female, 2 = Male, 3 = Nonbinary","*create gender \"None\"","*create gender_num 1","*create first_name \"Boxing\"","*create last_name \"Enthusiast\"","*create he \"he\"","*create him \"him\"","","*comment core stats","*create stat_power 10","*create stat_technique 10","*create stat_toughness 10","*create stat_mental 10","*create stat_energy 100","*create adj_power 10","*create adj_technique 10","*create adj_toughness 10","*create adj_mental 10","*create boxing_insights_unspent 0","*create boxing_insights_spent 0","","*comment Analysis: Calculation, Framing, Observation.","*comment Composure: Discipline, Restraint, Equanimity.","*comment Empathy: Sensitivity, Resonance, Recognition","*create trait_analysis 0","*create trait_composure 0","*create trait_empathy 0","*create highest_trait \"analysis\"","*create highest_trait_num 0","","*comment starting boxing moves","*create jab \"[i]Fast Jab[/i]\"","*create jab_level 0","*create flurry \"[i]Desperate Rush[/i]\"","*create flurry_level 0","*create combo \"[i]Beginner's Luck[/i]\"","*create combo_level 0","*create block \"[i]Panicked Block[/i]\"","*create block_level 0","*create dodge \"[i]No Dodge Training[/i]\"","*create dodge_level 0","*create counter \"[i]Untrained Counter[/i]\"","*create counter_level 0","","*comment story flags","*create police_crackdown_active False","*create eric_fought False","*create katie_fought False","*create danny_fought False","*create chloe_fought False","*create camille_fought False","","*comment characters","*comment char_subplot_status enum is \"locked\", \"available\", \"rejected\", \"finished\", \"lapsed\"","*create highest_friendship \"none\"","*create highest_friendship_num 0","","*create eric_subplot_scene 1","*create eric_subplot_status \"locked\"","*create eric_friendship 0","*create eric_romance 0","*create eric_harmony 50","*comment harmony vs ambition","","*create katie_subplot_scene 1","*create katie_subplot_status \"locked\"","*create katie_friendship 0","*create katie_romance 0","","*create danny_subplot_scene 1","*create danny_subplot_status \"locked\"","*create danny_friendship 0","*create danny_investigation_success False","","*create chloe_subplot_scene 1","*create chloe_subplot_status \"locked\"","*create chloe_friendship 0","*create chloe_romance 0","*create chloe_trauma 0","*comment her assessment of your trauma, more trauma -> less pressure from her","","*comment character cooldowns","*create eric_plot_timer 0","*create katie_plot_timer 0","*create danny_plot_timer 0","*create chloe_plot_timer 0","","*comment character consecutive unvisited count","*create eric_unvisited_timer 0","*create katie_unvisited_timer 0","*create danny_unvisited_timer 0","*create chloe_unvisited_timer 0","*create eric_almost_lapsed False","*create katie_almost_lapsed False","*create danny_almost_lapsed False","*create chloe_almost_lapsed False","","","*comment internal calculations for fighting power","*create fighting_power 0","*create trait_bonus_amount 0","*create trait_bonus_applied 0","*create upgrade_multiplier 0","*create upgrade_bonus 0","","*comment fight momentum ranges from 0 to 10. 0 means PC almost lost, 10 means PC almost won","*create fight_momentum 3","*create fight_opponent_name \"Opponent\"","","*comment stats screen display info","*create record_wins 1","*create record_losses 0","*create record_draws 0","","*comment training options unlocks","*create unlocked_eric_training False","*create unlocked_katie_training False","*create unlocked_danny_training False","*create unlocked_chloe_training False","","*comment Boxing insight mechanics","*create can_spend_insight False","*create jab_upgradeable False","*create flurry_upgradeable False","*create combo_upgradeable False","*create block_upgradeable False","*create dodge_upgradeable False","*create counter_upgradeable False","","*comment Training montage trackers","*create training_power_scene 0","*create training_technique_scene 0","*create training_toughness_scene 0","*create training_mental_scene 0","*create training_eric_available_scene 0","*create training_eric_unavailable_scene 0","*create training_katie_available_scene 0","*create training_katie_unavailable_scene 0","*create training_danny_available_scene 0","*create training_danny_unavailable_scene 0","*create training_chloe_available_scene 0","*create training_chloe_unavailable_scene 0","*create training_rest_scene 0","","*comment randomise initial scenes","*rand training_rest_scene 0 8","","*finish",""], "labels":{}},
"choicescript_stats": {"crc":-1441209020, "lines":["[b]${first_name} ${last_name}, a boxing enthusiast[/b]","*line_break","\"I just want to improve my boxing.\"","","[b]Stats[/b]","*line_break","[i]Power: ${adj_power} current, ${stat_power} maximum[/i]","*line_break","Raw strength, heavy punches. Powering through resistance.","","[i]Technique: ${adj_technique} current, ${stat_technique} maximum[/i]","*line_break","Footwork, timing, evasion. Dodges, slips, parries on defense, exploiting openings on offense.","","[i]Toughness: ${adj_toughness} current, ${stat_toughness} maximum[/i]","*line_break","Endurance. Taking hits on your guard and lasting through long exchanges.","","[i]Mental: ${adj_mental} current, ${stat_mental} maximum[/i]","*line_break","Awareness, focus, reading opponents. Determines your success at reading and countering opponent actions.","","Each action in a fight tests one or two of these stats. Your energy determines close your current stats are to their maximum values.","","[b]Traits[/b]","*line_break","*if highest_trait_num >= 2","    *if highest_trait = \"analysis\"","        [i]Your current dominant trait is: Analysis[/i]","        *line_break","        You examine situations with a logical approach. You observe, deduce, and try to recognise the patterns. Your decisions are rarely carried by emotion.","    *elseif highest_trait = \"composure\"","        [i]Your current dominant trait is: Composure[/i]","        *line_break","        You're in control of your emotions. You rarely panic. You're grounded and disciplined, and this often has a calming effect on others.","    *elseif highest_trait = \"empathy\"","        [i]Your current dominant trait is: Empathy[/i]","        *line_break","        You notice subtleties and tells that most people wouldn't. You have an intuitive sense of what others are feeling, and you make decisions based on that.","    *else","        *bug Invalid highest_trait","*else","    [i]You don't have a dominant trait yet.[/i]","    *line_break","    There's no pattern to your decisions. This may change as the story unfolds.","","[b]Boxing Skills[/b]","*line_break","*if jab_level = 0","    ${jab} \u2014 A light, fast strike. Can interrupt momentum or maintain distance.","*elseif jab_level = 1","    ${jab} \u2014 A clean, tight strike that probes for weaknesses or interrupts their attack.","*elseif jab_level = 2","    ${jab} \u2014 An accurate, powerful blow. A jab you can throw without thinking.","*else","    *bug Jab only upgradeable to level 2","*line_break","*if flurry_level = 0","    ${flurry} \u2014 Charge forward with a flurry of arm punches. Applies pressure, but exhausts you quickly.","*elseif flurry_level = 1","    ${flurry} \u2014 A rapid sequence of strikes. Lands more cleanly than before. Applies pressure and keeps opponents on the defensive.","*elseif flurry_level = 2","    ${flurry} \u2014 A burst of sustained pressure. Reliable aggression that doesn't leave you too open.","*else","    *bug Flurry only upgradeable to level 2","*line_break","*if combo_level = 0","    ${combo} \u2014 A jab-cross-hook that sometimes finds its mark. Still telegraphed, still mechanical.","*elseif combo_level = 1","    ${combo} \u2014 Reliable basic combinations, efficient force generation. Effective when there's an opening.","*elseif combo_level = 2","    ${combo} \u2014 Flowing combinations that can exploit openings or create pressure.","*else","    *bug Combo only upgradeable to level 2","*line_break","*if block_level = 0","    ${block} \u2014 An instinctive block. Often leaves the body exposed.","*elseif block_level = 1","    ${block} \u2014 A stable shell defence that absorbs hits on the arms and gloves. Surrenders the initiative, but protects effectively.","*elseif block_level = 2","    ${block} \u2014 A reactive guard that anticipates incoming attacks and absorbs pressure.","*else","    *bug Block only upgradeable to level 2","*if dodge_level = 0","    *comment unable to dodge/slip","*elseif dodge_level = 1","    *line_break","    ${dodge} \u2014 Avoid telegraphed strikes with footwork and head movement.","*elseif dodge_level = 2","    *line_break","    ${dodge} \u2014 Smooth weight transfer enables fluid bobbing, weaving, slipping. Clears the line of attack, then resets to neutral.","*elseif dodge_level > 2","    *bug Dodge only upgradeable to level 2","*if counter_level = 0","    *comment unable to counter","*elseif counter_level = 1","    *line_break","    ${counter} \u2014 Avoid a predictable strike and reply with a clean hit. Breaks the opponent's rhythm.","*elseif counter_level = 2","    *line_break","    ${counter} \u2014 Stay close, baiting an overextension, then an instinctive punish.","*elseif counter_level > 2","    *bug Counter only upgradeable to level 2","","[b]Fight record[/b]","*line_break","${record_wins}","*if record_wins = 1","    win,","*else","    wins,","${record_losses}","*if record_losses = 1","    loss,","*else","    losses,","${record_draws}","*if record_draws = 1","    draw","*else","    draws","","[b]Boxing Insights[/b]","*line_break","${boxing_insights_unspent} unspent, ${(boxing_insights_unspent + boxing_insights_spent)} total"], "labels":{}},
"choicescript_upgrade": {"crc":0, "lines":[""], "labels":{}},
"chapter0": {"crc":1053090011, "lines":["*image header.jpg","","Three months ago, you started training at a Mong Kok boxing gym tucked above a small [i]char siu[/i] eatery. Now you're leaving work early to punch accountants in warehouses and empty rooftop bars.","","Yesterday, you traded blows inside the half-abandoned Kwun Tong ferry pier. The crowd cheered for fighters they didn't know the names of. Technically, you were the victor. You won a glutinous rice dumpling in a thin plastic bag, and a lukewarm Vita lemon tea with its paper straw missing.","","No money, no glory, just another night getting hit. But some fighters do things that shouldn't be possible. Some say a man threw a fireball. Others call it an energy wave, splitting the air.","","There's no final boss. Only basements, abandoned nightclubs, and a city disappearing at the edges.","","You're not here to save the world. Just here to see what happens when you stop sitting it out.","","*page_break","A half-open [i]ding uk[/i] rooftop, the rusted metal floor fan doing nothing against the stale air. A volunteer at a white plastic folding table, empty [i]poon choi[/i] basins stacked nearby. \"The form's in English, but I don't read English. Just write something.\"","","*choice","    #She/Her. I'll use the default name of Claire Lau.","        *set gender \"Female\"","        *set first_name \"Claire\"","        *set last_name \"Lau\"","    #She/Her. I'd like to specify my own name.","        *set gender \"Female\"","        *gosub choose_name","    #He/Him. I'll use the default name of Steve Parker.","        *set gender \"Male\"","        *set first_name \"Steve\"","        *set last_name \"Parker\"","    #He/Him. I'd like to specify my own name.","        *set gender \"Male\"","        *gosub choose_name","    #They/Them. I'll use the default name of Leslie Wong.","        *set first_name \"Leslie\"","        *set last_name \"Wong\"","        *set gender \"Nonbinary\"","    #They/Them. I'd like to specify my own name.","        *set gender \"Nonbinary\"","        *gosub choose_name","*gosub set_pronouns","*finish","","","*label choose_name","What name will you declare to this underground world?","","My first name is:","*input_text first_name","","My surname is:","*input_text last_name","*return","","*label set_pronouns","*if gender = \"Female\"","    *set gender_num 1","    *set he \"she\"","    *set him \"her\"","*elseif gender = \"Male\"","    *set gender_num 2","    *set he \"he\"","    *set him \"him\"","*elseif gender = \"Nonbinary\"","    *set gender_num 3","    *set he \"they\"","    *set him \"them\"","*else","    *bug Invalid gender","*return"], "labels":{"choose_name":41,"set_pronouns":51}},
"chapter1": {"crc":-2116203322, "lines":["*set fight_opponent_name \"Eric\"","Chapter 1: Eric \"Blazefist\" Jiang ","","Cold office air, an uncooperative chair, a cramp in your toe. Three more market research reports to read. Someone two cubicles over grumbles about a client who sent six versions of the same Excel file, all of them 'final'.","","Your phone buzzes. You stare at the message. \"Opponent confirmed: Eric 'Blazefist' Jiang. 29th April.\"","","You close it.","","Last month, he knocked his opponent out with a flaming uppercut. There's a video of it: his fist connects with their jaw, fire trailing his arm in a long arc. Another time, he launched into a flying kick, missed, and toppled a folding chair.","","The forums argue about him every day. A newcomer. Some nights he's on fire, other times he burns himself.","","Three months in, your jab's okay. Your wrists aren't. You still remember the first time you slammed a haymaker into the heavy bag. It moved. Sure, it was supposed to, but you want that feeling again.","","Now you're refusing overtime and claiming you need to attend a cousin's wedding. Your team leader paused before nodding. How can one person have so many cousins named 'Winnie'?","","And your next fight is against someone who's not allowed near petrol stations.","","6:05 PM. Still early enough to get to the gym.","","*temp tutorial_mode False","*choice","    #Get a quick explanation of how the month works. (Recommended for first-time players.)","        *set tutorial_mode True","        Monday, 1 April 2024","","        Welcome to the circuit. Here's how each month works.","","        Each month is split into two fortnights. In each one, you'll make two key choices:","","        [b]Train.[/b] Focus on power, technique, toughness, mental game, or recovery. ","","        [b]Visit.[/b] Spend time with one character. A visit may unlock additional training options, deepen your relationship, or grant [i]Boxing Insights[/i].","","        At the end of the month, you can crystallise any [i]Boxing Insights[/i] into a stronger version of a boxing move.","","        You'll only have enough time to complete the stories of one or two characters. Plan accordingly.","","        When the month ends: you fight.","","        *page_break","    #Skip explanation.","        Monday, 1 April 2024","","        Engine fumes, curry fishballs, air-conditioner exhaust. Five minutes from now, it'll be sweat and leather and Tiger Balm.","","        Mong Kok's alleys are pasted with decaying flyers promoting questionable saunas and bygone concerts. Near the entrance to [i]MK Fight Gym[/i], a crumbling poster shows a child in uniform saluting. \"Embrace National Identity, Love Hong Kong.\" The corner peels a little more every week. Nobody touches it.","","        You push the creaking wooden door and it all hits at once. The smell of old gloves, the smack of limbs on heavy bags. You breathe deeper. Your body knows what to do here.","","        [i]MK[/i] isn't polished. The ceiling fans rattle. Your shoes scuff against the torn mats. But there are no fancy personal trainers here. Just impact, exhaustion, and people who remember your name.","","How will you use the first fortnight?","*gosub_scene utils fortnight_choice","Monday, 15 April 2024","*gosub_scene utils show_stats","","Your fight against Eric Jiang is near.","","You're in your tiny Mong Kok flat, but your hands curl into fists, ready to hit some pads. The gym's five minutes away, and it's like a second home.","","A flimsy calendar hangs on the wall, a promotional freebie salvaged from the office bin. [i]29th April[/i] is circled with thick black ink. You've barely enough time to nail down the fundamentals, let alone fight someone whose punches literally catch fire.","","The early months felt playful. Now, though, there's no room to coast. This is your last chance to sharpen your skills before you step into the ring.","","At [i]MK Fight Gym[/i], the mood is different. The cramped third-storey space on Tung Choi Street, usually full of trash talk, is quieter. The regulars know about your upcoming fight. Nods of recognition, of cautious respect. Coach Lam watches from the corner, arms folded across his faded T-shirt.","","*gosub_scene utils fortnight_choice","Monday, 29 April 2024","*gosub_scene utils show_stats","*if boxing_insights_unspent > 0","    *gosub_scene upgrades spend_insight_choices","","You leave the office at 6:00 PM on the dot. Brief nods to your colleagues, who nod back. They all suspect nothing.","","You squeeze into an MTR train packed with office workers. The air conditioning makes you shiver, despite the heat of the bodies around you. The station signs for Yau Ma Tei and Jordan flash by. Your stomach tightens.","","Tsim Sha Tsui. You ride the escalators up to gleaming skyscrapers and tourists flooding the streets. It feels different here. Mong Kok's streets collect food wrappers and cigarette butts, but Tsim Sha Tsui hides everything. Too clean.","","At the waterfront, you pause as laser lights sweep the harbour and tourists swarm the promenade. You're just another office worker. For now.","","The skyline glitters across Victoria Harbour, a thousand tiny lights, waiting to see who burns next.","","*page_break","*gosub_scene eric_fight fight","*set eric_subplot_status \"available\"","*set eric_fought True","*set eric_unvisited_timer 0","*finish"], "labels":{}},
"chapter2": {"crc":1309598243, "lines":["*set fight_opponent_name \"Katie\"","Chapter 2: Katie \"Pressure Point\" Reynolds","","Monday, 29 April 2024","","The exhaustion hits you as you reach your flat. You fumble with your key and push through the door, collapse onto your mattress, still in your street clothes. You click the button and the fan whirs overhead, useless against the April heat.","","It's barely anything. A fold-up bed, desk, pull-up bar, all packed into one overheated box. There's no space to partition work, sleep, training. Just a place for different kinds of tired.","","Outside, traffic snarls ten floors below. A noodle stall and 7-Eleven at street level. The rent eats half your salary. The rest goes to wraps, gloves, coaching. But the gym's five minutes away. The MTR's even closer. That's enough.","","*page_break","Tuesday, 30 April 2024","","You catch yourself tracking your team leader's hand movements. Tells. Her hand just now, tensed, so she's going to lunge at you with a cross \u2014","","You shake your head. The fight's over, but your mind hasn't caught up. You try to focus again, listen to what she's saying, but it arrives as a jumble of static.","","You still see it: Eric's [i]Energy Wave[/i], violent, sudden, real. Your first clean hit in a real match. You keep replaying it.","*if record_losses = 0","    The crowd cheered like it shouldn't have happened. Like they couldn't believe it.","*elseif record_losses = 1","    You lost. No surprise in the crowd. No shame in the ring.","*else","    *bug Invalid fight record","","Your colleague's mouth moves. Something about industry analysis, market segments. It keeps moving. The muscles in your neck tighten, expecting something that never comes.","","*page_break","*set current_month \"May\"","Wednesday, 1 May 2024","","Your phone shows a message from Coach Lam. \"Heard about last night.\"","","You grab buttered bread and wonton noodles from the stall downstairs. Your jaw still aches when you chew. The gym's quiet today \u2014 public holiday. Coach Lam doesn't ask how you feel. He just watches you move.","","\"You're doing this,\" he says finally.","","He passes you a slip of paper: Katie 'Pressure Point' Reynolds.","","Lam turns away, but not before adding, \"People fight for different reasons. Not all of them involve winning.\"","","*page_break","*gosub_scene utils show_stats","","Back at the office, you search for information about Katie. Oddly enough, you can't find any videos. Instead, there's page after page of comments:","","[i]\"Scariest fight of my life.\"[/i]","*line_break","[i]\"She was smiling the whole time.\"[/i]","*line_break","[i]\"Sheer terror.\"[/i]","","At last, hosted on a questionable file sharing site, you find a grainy, dark video. A tall brunette woman in mismatched aerobics gear faces off against a larger man. The fight starts normally, both of them in cautious guards. Then the woman dashes in and presses her fingers into his arm. He screams, drops to the floor, cradling his elbow. She smiles brightly and says something you can't make out. He tries to crawl away. She takes her time closing in, still smiling.","","You snap the laptop shut, and your heel taps the floor, restless. Your fight with Eric involved energy waves and flaming fists. This is different. Colder.","","You stare at the blinking cursor on your marketing campaign spreadsheet, but all you can see is Katie, smiling. And the scream.","","Four weeks. The spreadsheet can wait.","","*gosub_scene utils fortnight_choice","*gosub_scene utils show_stats","","Between training sessions, you have time to check in with one person. Eric's offer to train at Eastside still stands, and there's value in learning from someone who's already seen the circuit from the inside. Later on, your options will widen, and the trade-offs will get sharper. But for now, this one's simple.","","*gosub_scene utils character_visit_choice","Thursday, 16 May 2024","*gosub_scene utils show_stats","","You've found three more photos of Katie online. Same bright smile in each. Same cheerful workout clothes. Nothing that explains why grown men scream when she touches them.","","You print the clearest one and tape it next to your workout schedule. Her fingers look normal. Slender. Manicured. The kind that might teach yoga.","","You touch your elbow.","","Your training plan stares back, half-finished. Two weeks to prepare for something you don't understand.","","*gosub_scene utils fortnight_choice","*gosub_scene utils show_stats","*gosub_scene utils tick_character_cooldowns","*gosub_scene utils character_unvisited_check","*gosub_scene utils character_visit_options","*gosub_scene utils character_visit_choice","Thursday, 30 May 2024","*gosub_scene utils show_stats","*if boxing_insights_unspent > 0","    *gosub_scene upgrades spend_insight_choices","","You leave at 6PM sharp, saying you have a family dinner to attend. The marketing reports can wait.","","The strap of your gym bag digs into your shoulder as you ride the train. Someone in the carriage stifles a sneeze, then quickly puts on a mask, eyes downcast. The station announcements echo, all three languages blurring together. Your heart pulses, deep and quick. ","","The fight is in Mong Kok. A drab high-rise looms over the side street, paint peeling, its windows blacked out. Your sneaker sticks to old chewing gum on the pavement. You leave it. Each step drags. A mustachioed man at the side entrance nods you through when you give your name.","","An old lift, dimpled plastic buttons that creak when you push them. It rattles its way to the basement, opening into what looks like a former nightclub. Peeling posters, a bar counter against one wall, and the smell of stale beer. There's a full-size ring, canvas stretched tight but ropes slightly sagging. A small crowd, two uneven rows of fold-out metal chairs, thin wooden partitions sectioning off space for fighters.","","You drop your bag, stretch, wrap your hands. Calisthenics, breathing. ","","The bookmaker from your match with Eric is here, near the ropes, hunched over a tablet. He glances at you for half a second, nods quickly, then looks back down, already updating something.","","As you get ready for the fight, you catch a fragment of conversation from two fighters nearby. \"... too many new faces lately,\" one says. They see you looking. Silence.","","Not your concern. Tonight, you focus on Katie. Whatever strange techniques she brings, you'll stick to what you know: boxing punches.","","*page_break","*gosub_scene katie_fight fight","*set katie_subplot_status \"available\"","*set katie_fought True","*set katie_unvisited_timer 0","*finish"], "labels":{}},
"chapter3": {"crc":1096361533, "lines":["*set fight_opponent_name \"Danny\"","Chapter 3: Danny \"The Dragon\" Chan","","Friday, 31 May 2024","","You wake the next morning from uneasy dreams to find yourself confronted by an enormous mosquito. You grab the electric racket where it leans against the wall. The crackling [i]bzzt[/i] is too satisfying.","*if highest_trait = \"analysis\"","    You're already fully awake. Heart beating fast. ","*elseif highest_trait = \"composure\"","    Muscles ready. Still on edge after yesterday's fight.","*elseif highest_trait = \"empathy\"","    You feel everything. Even the fried mosquito smells of electricity.","*else","    *bug Invalid highest_trait","","The heat is a furnace without respite. It clings to you through the day like plastic wrap. You move slowly whenever you're in the open, drink more water. You even feel thankful when you're at the office, for the cool air conditioning. It makes the spreadsheets feel more meaningful.","","*page_break","The next morning, your phone buzzes with a message from your promoter. \"Danny Chan. 30th June.\"","","You look it up. Danny \"The Dragon\" Chan, always clad in a distinctive yellow tracksuit with black stripes, has a large online presence. You find lots of forum posts and fan websites, enthusiastically analysing his technique. You find many high-resolution videos portraying a lean, middle-aged man who performs Bruce Lee's moves passionately, yet slowly. Surprisingly, you don't see any evidence that he's won a single match.","","The next day at [i]MK[/i], you ask Coach Lam if he knows anything more about Danny Chan. His expression changes. Respect?","","\"Danny Chan,\" he begins slowly. \"Self-taught Jeet Kune Do. Not the most talented fighter I've seen, but possibly the most dedicated.\" He guides your elbows lower. \"Don't let his record fool you. It might look like an easy win, but no one leaves a fight with Danny feeling like they've won.\"","","You nod. A guy who loses every match but still draws a crowd. Someone who gets tribute posts and dragon emojis and forum threads to celebrate his endless losses. Something makes people stay. You don't know why. But you keep watching.","","*choice","    #There's something admirable about that. The conviction. The devotion.","        *gosub_scene utils increase_composure","        It's not pride. Not stubbornness. Something else. You don't fully grasp it. A promise, or a vow. It feels close to something you've been feeling ever since you started fighting.","","        You can't yet imagine what it must mean to have this kind of faith. But you respect it.","","    #You're trying to feel if this is noble or just deluded.","        *gosub_scene utils increase_empathy","        He keeps getting knocked down. Keeps getting back up. You don't know if this is courage or folly.","","        But you know what happens when people stop. When they give up, when they back down.","","        Maybe this is what it looks like when someone refuses to disappear.","","    #His popularity makes sense. He doesn't need to win; he just needs to tell a compelling story.","        *gosub_scene utils increase_analysis","        Danny is a fighter, but he's also a mirror. His fans all see the losses. But each of them learns something different from that.","        ","        You keep reading. Detailed technical breakdowns. Match analyses. Even fan fiction. What you never find: excuses for his match record. The legend endures.","","*page_break","Saturday, 1 June 2024","*set current_month \"June\"","*set current_season \"summer\"","*gosub_scene utils show_stats","","You find yourself rewatching Danny's fights in the evening. In one clip, he takes a brutal liver shot that should end the fight instantly. The camera zooms in on his prone form. He rises slowly, standing at the count of seven, then adjusts his black wristband and continues. In another video, completely outclassed, he absorbs heavy punishment but is unable to lay a finger on the opponent. Between rounds, he sits peacefully in his corner with the calm of a monk.","","A kind of legend, built on refusal alone.","","Your flat feels especially cramped tonight.  You close your laptop and press your face against the window. Hong Kong's night skyline compresses into a light show, thousands of lit and unlit windows reduced to pixels. A silent film playing out on a distant screen. You wonder if you're missing something, or if this is all there is.","","You push away from the window.","*if highest_trait = \"analysis\"","    Somewhere in that grid of light, Danny is training. The same inputs leading to the same outputs.","*elseif highest_trait = \"composure\"","    Somewhere out there, Danny trains. Same as yesterday, same as tomorrow.","*elseif highest_trait = \"empathy\"","    Somewhere out there, Danny trains, alone, unnoticed. And he's fine with that.","*else","    *bug Invalid trait","","*gosub_scene utils fortnight_choice","*gosub_scene utils show_stats","*gosub_scene utils tick_character_cooldowns","*gosub_scene utils character_unvisited_check","*gosub_scene utils character_visit_options","*gosub_scene utils character_visit_choice","Saturday, 15 June 2024","*gosub_scene utils show_stats","","The second half of June. The heat outside blooms early and lingers late. Inside, though, it's the opposite. The office is a refrigerator. The MTR is cold enough that even the tight press of bodies doesn't provide enough warmth. You shiver through meetings, sweat on the brief walk to lunch, then shiver again back at your desk.","","At [i]MK Fight Gym[/i], the fans rattle and squeak, completely failing to dispel the heat. You sweat through it and walk home with your shirt stuck to your body. Your mind drifts to Danny again. You find yourself mouthing phrases he might say. [i]\"Adaptation, not imitation.\" \"Be like water.\"[/i] The words sound wise, until you picture him saying them while getting punched in the face.","","You give a short, involuntary laugh. But it doesn't feel funny.","*if highest_trait = \"analysis\"","    Maybe you need to approach things differently. You've been training for a physical fight. But he's fighting on a different level.","*elseif highest_trait = \"composure\"","    Whether he's a fighter, a symbol, or a myth, nothing changes. You train. You fight.","*elseif highest_trait = \"empathy\"","    Maybe you're missing something here. Danny doesn't seem to be trying to win. But he keeps showing up.","*else","    *bug Invalid trait","","You still have no idea how this fight will play out. Regardless, you'll be there.","","*gosub_scene utils fortnight_choice","*gosub_scene utils show_stats","*gosub_scene utils tick_character_cooldowns","*gosub_scene utils character_unvisited_check","*gosub_scene utils character_visit_options","*gosub_scene utils character_visit_choice","Sunday, 30 June 2024","*gosub_scene utils show_stats","*if boxing_insights_unspent > 0","    *gosub_scene upgrades spend_insight_choices","","You tell your team leader that you have a family obligation and need to leave early. The underground circuit is increasingly interfering with your office life. And with several matches under your belt, you're no longer a total unknown.","","You push through the evening crowds, gym bag pressed against your shoulder. Your gear has improved since your first match: a properly fitted mouthguard, quality hand wraps, and sturdy leather gloves.","","Tonight you're fighting at an abandoned warehouse in Kwun Tong. The taxi driver shoots you a knowing look when you give him the address, but says nothing.","","The corrugated metal walls of the warehouse throw long shadows as the sun sets. Some kind of drum and bass track pulses through your feet before you even reach the entrance. Across the street, a small surveillance camera on a utility pole blinks red.","*if highest_trait = \"analysis\"","    Government, not private.","","The warehouse is dense and hot, hitting you with a cocktail of sweat, metal, and tropical fruits. The crowd strikes you the most. It must be almost a thousand strong, the warehouse packed nearly to capacity. Almost everyone sports yellow T-shirts with a black dragon silhouette.","","As you pass through the crowd, you spot Danny seated in a corner. He's staring at his shoes. A fan tries to snap a selfie with him. Danny doesn't notice.","","The bookmaker from your previous fights is seated near the front, tablet in hand, wearing a yellow dragon T-shirt like the rest of the audience. \"No odds tonight,\" he says. \"It's not that kind of fight.\"","","He gestures at the crowd with his arm. \"People are here to witness.\"","","A thousand pilgrims, united in purpose. A sea of yellow. You don't know what role you play in this story. Disciple? Heretic? Your stomach tightens.","","*if highest_trait = \"analysis\"","    This feels familiar. Uniforms, symbols, chants. You recognise the pattern \u2014 it's the same energy that fuels mass movements. But there's no message, no demand. Just a collective promise to keep showing up.","*elseif highest_trait = \"composure\"","    You've been in crowds like this before, for causes you believed in. The most important principle is to keep showing up. For yourself, and for everyone else.","*elseif highest_trait = \"empathy\"","    This is a vigil. A vigil for an idea, one that might already be gone. The crowd isn't expecting Danny to win. They're just here to witness.","*else","    *bug Invalid trait","","*page_break","*gosub_scene danny_fight fight","*set danny_subplot_status \"available\"","*set danny_fought True","*set danny_unvisited_timer 0","*finish"], "labels":{}},
"chapter4": {"crc":1606522239, "lines":["*set fight_opponent_name \"Chloe\"","Chapter 4: Chloe \"Wildcard\" Lee","","[b]Content Advisory:[/b] This chapter's fight contains a scene of restricted breathing. Players sensitive to this theme should proceed with awareness.","","*page_break","*set current_month \"July\"","Monday, 1 July 2024","","Your flat feels small this morning. You stay in your bed, letting the weight of yesterday's fight press down.","","*if (highest_trait = \"analysis\")","    It was technically a victory, but there's still one variable you couldn't calculate. Danny's serenity wasn't fear, showmanship, or discipline. An outlier that doesn't fit any pattern.","*elseif (highest_trait = \"composure\")","    It was technically a victory, but you're still off balance. Danny was calm, too calm. It wasn't defensive. It had nothing to do with victory or defeat. Just a quiet presence. You can't reduce it to a single aspect, like Eric's fire or Katie's precision.","*elseif (highest_trait = \"empathy\")","    It was technically a victory, but it didn't feel like one. One moment stands out: how Danny welcomed it. He wasn't stoic, wasn't proud. He was just there, his presence unchanged by victory or defeat.","*else","    *bug Invalid trait","","Danny hits the canvas from your combination. He rises. Again and again he rises, undisturbed despite the punishment. The scene keeps replaying throughout the day, pushing aside memories of Eric's blazing techniques and Katie's pressure point manipulation.","","Today is your office team barbecue. Someone's cousin booked a pit at Tai Mei Tuk to take advantage of the public holiday, and now twenty of your colleagues are sweating under a metal roof, half-heartedly waving paper fans as they crouch over glowing charcoal. The weather is oppressively humid, but the charcoal pit radiates dry heat, a sauna and steam bath at once. Sweat seeps through your clothes. You find yourself thinking about training.","","The food is a chaotic jumble. Fishballs shrivelling on bamboo skewers. Salty steam mixing with clouds of soot. Foil-wrapped corn cobs hissing weakly, nestled in their pockets around the charcoal. Pineapple slices charring at the edges. Hot dogs in plain buns, slathered with sweet chilli sauce. Someone hands you a skewer of honey-drizzled white bread, the edges charred black. \"You have to try this,\" they say, like it's a normal thing to eat. Charcoal, sugar, meat juice, citrus. Every breath is a buffet.","","\"Nice, ${first_name},\" someone says, glancing at your arms. \"Still keeping up the boxing?\"","","\"Looking strong,\" another adds, with a half-laugh that trails off. You smile, say something about early mornings and discipline, and they nod. Impressed, maybe, or just not sure what to say. It's not unfriendly. Just a small gap that didn't used to be there. Someone calls you over to help toast more bread, and the moment passes.","","*page_break","","Tuesday, 2 July 2024","*gosub_scene utils show_stats","","\"July card scheduled. Chloe 'Wildcard' Lee at The Cauldron. 27th, 9PM.\"","*if (eric_subplot_scene >= 2)","    The name rings a bell. You remember a woman named Chloe barging into Eastside and provoking Eric.","","Coach Lam frowns. \"Chloe Lee? They say she's a rich kid playing at being a fighter. But she's complicated. Dangerous in her own way.\"","","\"How so?\" you ask.","","He pauses. \"She might look like a wild one, but she's technically skilled. And she particularly enjoys fighting at The Cauldron. Be prepared for anything to happen.\" He breaks eye contact and looks out the window.","","You search online but find few details about Chloe. There are a few clips showing a young woman wearing designer athletic wear that looks worn and dirty. When she fights, it's subtly off \u2014 in one clip, there's a brief delay between her preparation and her strike. But it somehow lands anyway. You can't tell if she's untrained, improvising, or baiting mistakes from her opponent. The forums describe her as the \"forgotten child of some property tycoon\", someone with something to prove, who fights recklessly and isn't afraid to cross lines. She's \"erratic but effective,\" a \"chaotic performer\" who hides solid Muay Thai fundamentals.","","Danny fought like he had long stopped expecting to win: each strike, each movement performed with quiet certainty, knowing that the result would always be the same. From your cursory investigation, the fight against Chloe will be nothing like that.","*if highest_trait = \"analysis\"","    You review the clips carefully. Her timing is wrong on purpose. Strikes are too early or too late, to disrupt the opponent's rhythm. She becomes unpredictable.","*elseif highest_trait = \"composure\"","    You can see it on her face. She's trying to unsettle the opponent, to provoke a flinch, a hesitation. To sow doubt. You'll have to stay centred and weather the storm.","*elseif highest_trait = \"empathy\"","    She fights like she wants to throw the opponent off-balance, physically and emotionally. Not going for a straight-line route to victory.","*else","    *bug Invalid trait","","*gosub_scene utils fortnight_choice","*gosub_scene utils show_stats","*gosub_scene utils tick_character_cooldowns","*gosub_scene utils character_unvisited_check","*gosub_scene utils character_visit_options","*gosub_scene utils character_visit_choice","Tuesday, 14 July 2024","*gosub_scene utils show_stats","","Two weeks left. It's still frustratingly hard to piece together a clear picture of what Chloe Lee will bring to the fight. You unearth another video, this time not a fight, but a short clip from a gym session. She's shadowboxing. Her entire body leans back for a wild haymaker, arm windmilling in exaggerated circles. There's a flash of focus in her expression as she swings forward with the haymaker, and it transforms instantly into a brutal elbow slash. She redirects the elbow just before it slices their face, then dissolves into laughter. \"She's all song and dance until she isn't,\" a comment beneath it reads. \"And you don't know when she's switched until you're on the mat.\"","","Discussion boards whisper of psychological games, of someone who derives more pleasure from disrupting her opponent as from winning the match. Stories about how some fighters manage to keep it together, but others fall apart. One comment is short: \"Chloe Lee? Yeah, watch out. If she gets you down, you're staying down.\"","","It's hard to reconcile the image of a spoiled rich kid with the clear evidence of extensive Muay Thai training. In one fight, she starts off with clean teeps and roundhouse kicks but then mixes in wild haymakers and stumbling footwork. It's part performance art, part serious fighting, without any clear distinction between them. Maybe that's how you should approach this too. An elaborate prank, until it isn't.","","You picture her movements, loose, chaotic, half a second ahead or behind. Nothing clean to counter. No patterns, no rhythm, no tells. Just noise, and something else underneath. And despite your best efforts, the Cauldron itself remains a mystery. \"Fights at The Cauldron always feel like they're always about to spiral out of control,\" one forum post notes.","","You finish your drills, and belatedly notice that the gym feels different today. There's an oppressive quiet instead of the usual slaps and thuds, leaving only the faint whirring of the overhead fans. Even your own breathing sounds too loud. As you pack up, Coach Lam lingers by the equipment rack, adjusting hand wraps that don't need adjusting.","","\"Names are disappearing from the fight sheets,\" he says in a low voice, unwinding a length of hand wrap. \"Happening in a few spots. No one's talking. Something feels off.\"","","He doesn't elaborate further. Preoccupied with winding some hand wraps into a neat roll.","","*gosub_scene utils fortnight_choice","*gosub_scene utils show_stats","*gosub_scene utils tick_character_cooldowns","*gosub_scene utils character_unvisited_check","*gosub_scene utils character_visit_options","*gosub_scene utils character_visit_choice","Saturday, 27 July 2024","*gosub_scene utils show_stats","*if boxing_insights_unspent > 0","    *gosub_scene upgrades spend_insight_choices","","Tonight's card: Chloe \"Wildcard\" Lee. A skilled practitioner of chaos, impossible to read. Maybe a heiress. And the fight is at The Cauldron, famed for its wild reputation. All of this is unsettling.","","You've drilled your fundamentals. Rehearsed for scenarios that probably won't happen. Nothing helps. The rhythm slips away the moment you try to picture it. ","","The ride to Sheung Wan passes quickly, the carriage less crowded on weekend nights. The escalators stretch longer than they should, like a prank some architect got away with. At street level, the night suffocates you with its wet heat, the air tasting of salt and dried squid. Heat radiates from the pavement as the last of the seafood shops close for the day. You check your reflection in a metal nameplate. Posture okay. Ready for battle. But a tension lingers.","","You follow the directions down a side street, then into a small alley. No signs about, just a grey door, the surface thick and uneven with splotched paint. Bass leaks out from under the door and up through your bones, and you catch a whiff of cigarette smoke. Your hand rests lightly on the handle, the metal still warm.","","You already know. This fight won't go according to plan.","*if highest_trait = \"analysis\"","    Too many variables: Chloe's unpredictability, The Cauldron's irregular conditions, Coach Lam's cryptic warning.","*elseif highest_trait = \"composure\"","    The test is to outlast the chaos and stay standing.","*elseif highest_trait = \"empathy\"","    Something feels off. Not just danger, but wrongness.","*else","    *bug Invalid trait","You step through anyway.","","*page_break","*gosub_scene chloe_fight fight","*set chloe_subplot_status \"available\"","*set chloe_fought True","*set chloe_unvisited_timer 0","*finish"], "labels":{}},
"chapter5": {"crc":54394720, "lines":["Chapter 5: The Hungry Ghost Festival","*set fight_opponent_name \"None\"","","Thursday, 1 August 2024","","The photocopier whirs as you make more copies of the latest pitch book. Your boss, Janet (jan-NET, she corrected you once), approaches and asks you to join her for a quick meeting in her office. Seeing your blank expression, she nods repeatedly, then goes back to her room.","","Has she noticed that you've been coasting this year, ever since your new hobby? There's nothing to be done either way. You need to get this over with, so you drop the pitch books on someone's desk, take a deep breath, and knock on her door.","","\"${first_name}, have a seat! First of all, I want to thank you for your hard work and how you're always so proactive about...\" She glances down at a notepad on her desk. \"...about completing your CPT hours on time.\"","","You're pretty sure you don't even need CPT hours, but she clears her throat and powers through. \"I've noticed your enthusiasm. I can tell you're hungry to climb the ladder and make something of yourself. Unfortunately the economy's rough and we just don't have the budget for promotions right now. I'm sure you understand. But keep up the good work. It's people like you who make this company run.\"","","It's good that your afternoon daydreaming is so vital. \"Thanks Janet, I get what you mean. Some things can't be helped. Thanks for letting me know.\"","","Back at your desk, your mind refuses to think about the conversation at all. You place your fingers on the keyboard, but no letters appear on the screen. You shift in your chair and take a deep breath.","","A dull pain flares in your ribs. Yesterday's fight. Chloe started out chaotic and undisciplined, but dropped the act the moment you saw through it. Does that still count as chaos, then?","","*if chloe_trauma = 0","    And you still remember her standing on you, after the first round ended. Unpleasant. But if she was playing dirty, it was a strange way of going about it.","*elseif chloe_trauma = 1","    You can't forget her standing on you, driving the air out of your lungs. Terrifying in the moment, although fortunately you didn't suffer any lasting damage. A strange way to behave in an underground fight, with no obvious benefit.","*elseif chloe_trauma = 2","    Your breathing becomes shallow as you recall the terror and humiliation of her standing on your vulnerable stomach, denying you your breath, helpless to do anything under her. An experience you would rather forget, but it won't fade easily.","*else","    *bug Invalid chloe_trauma","","Suddenly you're filled with the desire to craft the greatest spreadsheet of all time.","","*page_break","Saturday, 3 August 2024","*gosub_scene utils show_stats","","You still haven't received this month's fight card. Usually your promoter tells you at the start of the month. You message her.","","\"No fight this month. Bad luck. Ghosts.\"","","Ghosts? What?","","Then you remember. Of course. August is the Hungry Ghost Festival, when the gates of the underworld open. It would be foolhardy to fight. Not only would venues be contaminated by wandering spirits, it would also invite misfortune.","","You head to [i]MK[/i], wondering how you'll fill the time.","","*gosub_scene utils fortnight_choice","*gosub_scene utils show_stats","*gosub_scene utils tick_character_cooldowns","*gosub_scene utils character_unvisited_check","*gosub_scene utils character_visit_options","*gosub_scene utils character_visit_choice","Sunday, 11 August 2024","*gosub_scene utils update_highest_friendship","","The bus wheezes as it comes to a stop outside Statue Square. Thousands of women relaxing under HSBC's canopy, cardboard mats spread out, chattering happily and munching on palabok, kare-kare, nasi bungkus, gado-gado. There's a plump Filipino in wrap-around sunglasses and black silk shirt, strutting on a small raised stage.","","You stroll past the fountain onto the elevated walkway, more women and their makeshift mats lining both sides of the footbridge, and take the slow escalator to the ground level, where burly men are wrapping entirely too much packing tape around a bulging [i]balikbayan[/i] box, the cardboard straining to contain toothpaste, luncheon meat, tiny baby shoes. No businessmen in sharp suits striding through, no office ladies shopping for snacks in side alleys, no tourists.","","Jollibee beckons, the scent of fried chicken already apparent from a block away. You order your Chickenjoy set and find a high table and stool on one side. The air is filled with Tagalog and laughter.","","*if highest_friendship = \"Eric\"","    The crispy skin crunches in your mouth as you think about Eric. How he would be at Eastside every day, training until the air conditioning cut off, body still moving in the silence.","    *if eric_subplot_scene > 3","        How he hesitated before knocking on Master Wong's door, then bowing deep. The tight jaw and the grimace when he pushed back on Master Wong's advice.","    *if eric_subplot_scene > 4","        And more, how Eric keeps asking you to accompany him, the way his smile reaches his eyes when you arrive, and how he takes a deep breath before the words tumble out quietly.","    You wonder if he's found his rhythm yet, or if his fists still burn himself.","*elseif highest_friendship = \"Katie\"","    The crispy skin crunches in your mouth as you think about Katie. You remember her cheerful commentary during your fight, even as she set your elbow on fire.","    *if katie_subplot_scene > 1","        Her eyes, wide and bright, taking in the smallest twitches of your body, as she carefully pressed your nerves in her lab.","    *if katie_subplot_scene > 3","        That time she unexpectedly asked you for help, and you ended up having lunch, listening to her as she tried to land every word just right.","    *if katie_subplot_scene > 4","        You remember when her research was rejected: slumped over, eyes red, voice wavering. How you helped with a small suggestion, and she sat up, straighter, closer.","    You wonder what it's like to be her, surrounded by lab equipment and research notes, her monologues disappearing into concrete walls.","*elseif highest_friendship = \"Danny\"","    The crispy skin crunches in your mouth as you think about Danny. The thousand-strong crowd, a sea of yellow, roaring and hushing as one.","    *if danny_subplot_scene > 1","        How you decided, on some unknown urge, to look for him. The disinfectant smell and the crackling PA at the community centre, and the empty function room, wax on the floor worn away.","    *if danny_subplot_scene > 2","        That led to a morning stroll through Kowloon Park, sitting with tai chi practitioners. Sitting on a cold stone bench, watching men and women wince as they walk barefoot on pebbles.","    You wonder what it's like. Whether it would wear you down. You wonder why you keep seeking him out.","*elseif highest_friendship = \"Chloe\"","    The crispy skin crunches in your mouth as you think about Chloe. Wild, stumbling haymakers that didn't leave any openings. Then her weight on you, your breath no longer yours to control.","    *if chloe_subplot_scene > 1","        The rooftop lounge with the zen pebbles surrounding hollow-eyed bankers, where the fighter was gone and the socialite appeared, the tuxedoed waiters anticipating her requests before she voiced them.","    *if chloe_subplot_scene > 2","        And at the exercise studio, where Hong Kong itself was sealed out, nothing but the sterile room and the beeping timer, her training, and her desperation. Reading other people like a case study, every weakness catalogued.","    You wonder what it would be like to live like that, slipping into roles as easily as changing outfits.","*else","    *bug Invalid highest_friendship","","*page_break","Friday, 16 August 2024","*gosub_scene utils show_stats","","At [i]MK[/i] today, there's only three people stretching and running laps, their footsteps pattering in the empty space. Even the heat isn't as oppressive, the ceiling fans finally coping. It's the humidity, the Hungry Ghost month, everything combining to push people away.","","Coach Lam gave you the same exercise twice in a row, and forgot to reset the timer in between. A few days ago he kept counting reps wrong.","","Your fists move, but it feels like filing paperwork, not fighting. The bag takes your punches without enthusiasm. Still. Have to push through.","","*gosub_scene utils fortnight_choice","*gosub_scene utils show_stats","*gosub_scene utils tick_character_cooldowns","*gosub_scene utils character_unvisited_check","*gosub_scene utils character_visit_options","*gosub_scene utils character_visit_choice","Friday, 30 August 2024","*gosub_scene utils show_stats","","*gosub_scene afterhours afterhours","","*finish"], "labels":{}},
"ending": {"crc":1488799513, "lines":["This is the end of Book 1. Stay tuned for Book 2! Be sure to \"like\" and \"subscribe\" if you enjoyed it.","","*ending"], "labels":{}},
"eric_fight": {"crc":1356868684, "lines":["*label fight","*temp dc_easy 10","*temp dc_medium 14","*temp dc_hard 18","*set fight_momentum 5","*set trait_bonus_amount 2","*gosub_scene utils calc_adj_stats","*comment If the player trains two separate stats, they'll be at effective stats 14/14/8/8. If they train one stat twice, 18/8/8/8","The Kowloon side of Victoria Harbour, early twilight, away from the tourist crowds. Waist-high metal barricades and rusting bleachers form a crude rectangle, floodlights at the corners illuminating a circle of thick rope in the centre. There's a small crowd on the bleachers, a few dozen strong, mostly staring at their phones. A bookmaker paces along the edge of the promenade, displaying odds and taking bets, his eyes glazed. A passing Star Ferry blares its horn, high and sharp. ","","You're in the second match of the night against Eric \"Blazefist\" Jiang. His red gi catches the light as he warms up in his corner, black belt knotted twice in the traditional style, the fabric frayed only where the knot crosses. You look up at his face, dense eyebrows and neat cropped hair framing a square, heavyset jaw. His features remind you of the bronze lions outside the HSBC building. He's bouncing on the balls of his feet as he shadowboxes, and the air seems to shimmer with his punches.","","You size up the arena. The rope circle looks to be six metres across, with a one-metre safety strip separating it from the bleachers. On the far side, Victoria Harbour itself bumps right against the edge of the rope circle, a concrete railing at chest height the only protection against a tumble into the water.","","Stretching in your corner, you adjust your headgear. The padding feels slightly loose, and you can't get a comfortable fit. Three suited spectators, out of place amongst the T-shirts and casual wear, watch with unreadable expressions. You shake your head slightly, turning your attention back to wrapping your hands.","","Done. You pull on your red 10oz gloves, the insides stiff with dried sweat, and stand. The referee gestures you towards the rope circle. The fight is live.","","*choice","    #You regulate your breathing and ground yourself.","        *gosub_scene utils increase_composure","        You let your arms hang loose, shoulders soft, and take a slow breath. In through the nose. Out through the mouth. Nothing dramatic. You notice the floodlights, the crowd noise, Eric's warm-up, but they don't affect you. You're not here to react. You're new, but you're not rattled. You're grounded.","    #You tune into the energy in the air.","        *gosub_scene utils increase_empathy","        You feel it before you move. A tightness in the chest. Your rhythm resonating with Eric's. He hasn't looked your way, but his breathing's suddenly regular. Slower. He's grounding himself. You match it instinctively. The crowd fades.","    #You break the fight down before it begins.","        *gosub_scene utils increase_analysis","        You break it down piece by piece. Ring dimensions: six metres across. Ropes: low enough to step over, tight enough to cut off lateral movement. Lighting: harsh, angled. Hides high kicks, highlights feints, blinds you if you look up. Eric's stance: relaxed, but the bounce in his rear foot suggests aggression out of the gate. You tune out the crowd. This is just another problem to solve.","","You touch gloves, a firm tap of leather on hand wraps. The referee nods, steps back, and chops his hand downward. \"Fight!\"","","You start cautiously, arms tight to your centreline, breath shallow. Eric sinks into a low stance. He draws both hands back near his right hip, palms cupped like they're holding water. A flicker of heat pulses between them. Then he pivots on his rear foot and drives forward in a single flowing thrust. His hands snap open, revealing a sphere of compressed light.","","The hairs on your arms stiffen as the space around you tightens. His [i]Energy Wave[/i] rushes forward, no wider than your torso. The air ripples with distorted light.","","It's too fast. Almost on you.","","*gosub_scene utils show_fight_momentum","","*choice","    #Use a ${block} to weather the impact.","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *if (adj_toughness + trait_bonus_applied) >= dc_easy","            You set your guard firmly as the energy projectile crashes against your defence with a sound like a wet basketball bouncing, the force jarring your arms. Eric rolls his shoulders back as you recover. \"Still standing, huh? Most people tense up too much and eat it.\"","        *else","            You raise your defence too late, the energy projectile crashing against the top of your guard. The force drives your own gloves into your face with a blunt smack. You stumble, nearly falling. Eric drives forward, head low, steps sharp and direct.","            *set fight_momentum -1","    #Touching that energy projectile can't be good. Attempt a sidestep.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *if (adj_technique + trait_bonus_applied) >= dc_hard","            Your legs move by instinct, your torso barely avoiding the projectile. Your trailing leg brushes the outer rope, the scrape of the coarse hemp a reminder of how little breathing room there is. Spectators gasp as the energy wave hisses past and splashes against the harbour railing. You retain enough awareness to see that Eric is still recovering from throwing the energy wave, and you close the distance with a ${jab} that cleanly connects with Eric's shoulder. He steps back, resetting the match, but his confidence flickers, his stance no longer casually relaxed.","            *set fight_momentum +1","        *elseif (adj_technique + trait_bonus_applied) >= dc_medium","            You manage to dodge most of the energy projectile, suffering only a glancing blow to your ribs that still sends a sting through your side. As you reset your stance, Eric finishes his recovery from the energy wave, and any advantage you might have had dissipates. \"Clever footwork. Most people freeze,\" he says, adjusting his stance.","        *else","            You try to evade the energy projectile, but you're caught off guard, the projectile striking you in the chest before you finish your dodge. The impact steals your breath and shoves you two steps towards the edge. Your foot hits the boundary rope, which halts your momentum with a jolt as Eric presses his advantage.","            *set fight_momentum -1","","    #Throw a quick ${jab} to disperse the Energy Wave.","        You try to dissipate the energy projectile by jabbing it. It drives your gloved fist forcefully back, making you punch yourself in the face. Eric pauses, eyebrows furrowed in puzzlement. \"First time facing energy techniques?\" he asks, as he prepares to close the distance again.","        *set fight_momentum -1","","*if fight_momentum <= 4","    No time to dwell. You circle. You duck. You fire off jabs. The crowd blurs. Eric crowds you with sharp footwork, your space shrinking, but you keep throwing.","","    When you land a clean cross through his defence, people look up from their phones. Eric's footwork quickens. \"Good shot,\" he says, as energy flares around him.","*elseif fight_momentum = 5","    No time to dwell. You circle. You duck. You fire off jabs. The crowd blurs.","","    People look up from their phones when you land a clean cross through Eric's defence. He tightens his stance and sets his jaw. \"Your form is good,\" he remarks, as energy flares around him.","*else","    No time to dwell. You circle. You duck. You fire off jabs. The crowd blurs. ","    ","    You land a clean cross, catching Eric off guard with your timing. The crowd is on its feet. For a second, a part of you wonders: [i]Am I really holding my own?[/i]","","    \"You're good.\" That's all he says, as energy flares around him.","","He shifts his weight with a feint left, then pushes off hard from his rear leg, launching into a spinning jump. One leg tucks in tight, the other whips outwards \u2014 horizontal, fast, spinning. The [i]Tornado Kick[/i] turns his whole body into a blade, his extended leg slicing straight towards your head.","","*gosub_scene utils show_fight_momentum","","*choice","    #Raise your guard and angle your ${block} towards his leg.","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *if (adj_toughness + trait_bonus_applied) >= dc_medium","            You raise your guard and angle it into the strike. One. Two. Three. Three times his spinning kick smashes into your forearms, and three times you shift your weight to absorb it, each impact clean and controlled.","","            He lands, momentum dissipated, and immediately resets, alert for whatever counterattack you might have.","","            Instead, you settle into a ready stance. Your forearms pulse faintly, but your structure holds.","        *else","            You raise your guard and angle it into the strike. The first hit slams into your forearms, a hammer that staggers you. The second and third send you stumbling back, until your heel snags the rope.","","            He lands smoothly and immediately resets. \"Still standing,\" he says, his eyes narrowing. Calculation, not doubt.","","            You shake out your trembling arms, lift your guard again. Just in time.","            *set fight_momentum -1","    #Backstep until he runs out of momentum.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *if (adj_technique + trait_bonus_applied) >= dc_medium","            Your feet retreat in rapid half-steps, staying just ahead, as his kicks slice the air, so close that a wind brushes your face. On the third rotation, his momentum starts to slow. You pivot fractionally. He lands, crouching, and his guard's open for a moment.","","            \u2014 But you stay still. You let the window close. Eric straightens up and looks at you, an eyebrow raised. \"Surprised you didn't go for it,\" he says.","","            Respect. Or maybe caution?","","            You settle back into your stance and breathe steady. Patience.","        *else","            Your feet are already moving, rapid half-steps, trying to stay ahead of the whirlwind. The first kick misses, cleaving the air, so close that a wind brushes your face. But Eric is faster than you expected. The second kick crashes into your shoulder, a blunt and heavy impact that numbs your muscles. The third one hammers your hastily raised guard. You stagger.","","            Your heel catches on the rope circle. No more room. But Eric's momentum is exhausted, and he lands, crouched. You both reset at the same time.","","            Still standing.","            *set fight_momentum -1","    #Attempt to duck under the whirling kicks.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *if (((adj_technique * 0.5) + (adj_toughness * 0.5)) + trait_bonus_applied) >= ((dc_medium * 0.8) + (dc_hard * 0.2))","            You drop nearly to the floor. Eric's kick slices the air overhead, the wind howling in your ears. He spins twice more before landing with his back to you.","","            You rise, lunging forward, and slam a cross into his ribs as he turns. A deep [i]thwump[/i] reverberates as it drives the air from his lungs. He staggers, but then quickly resets, his raised forearms glowing with heat.","","            \"Impressive reactions. Didn't expect that.\"","","            You settle back into your stance and breathe steady.","            *set fight_momentum +1","        *elseif (((adj_technique * 0.5) + (adj_toughness * 0.5)) + trait_bonus_applied)  >= dc_medium","            You drop to the floor as Eric spins past. It's too low, your face touching the asphalt. He whirls past you, but now you're stuck, all your weight on your arms. You push up awkwardly with your boxing gloves, and scramble upright just as he lands and resets.","","            The window closes. \"Was worth a try,\" he comments.","","            You settle back into your stance and breathe steady.","        *else","            Too slow. Eric's spinning kick catches your forehead. Another kick slams into your guard, staggering you.","","            The next one catches you on the shoulder and slams you down. You land on your back, hard, skidding on the asphalt.","","            The referee starts the count. It's hard to focus with the floodlights blinding you. You rise by seven and blink hard. Legs still shaky, but everything else steady.","","            Eric gives you space. Once you're set, he advances.","            *set fight_momentum -2","","More grinding exchanges. Sweat, breath, grunts. Heavier steps, sagging guard. Your lungs protest as you suck in air.","","Eric takes a step back and sinks low into Horse Stance: base wide, hips locked. His fists, near his hips, glow amber.","","He waits.","","*gosub_scene utils show_fight_momentum","","*choice","    #Throw a technical jab, then punish his likely counterattack.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *if (adj_technique + trait_bonus_applied) >= dc_hard","            You throw out a feather-light ${jab}, more of a tap than a real punch. Then you immediately turtle up into a tight guard.","","            Eric absorbs your jab and responds with a palm thrust, but it bounces harmlessly off your gloves. The slight overextension gives you the opening for a one-two, enough to score cleanly.","            *set fight_momentum +1","        *else","            You test Eric with a feather-light ${jab}, more of a tap than a real punch. But your timing is off, and you take too long raising your guard.","","            Eric's [i]Focus Counter[/i] arrives before you're ready, and his palm thrust smacks you in the chest. You stumble back, the impact driving the air from your lungs.","            *set fight_momentum -1","    #Keep your distance, waiting out his counter.","        You maintain distance, guard tight, eyes fixed on Eric. Seeing that you're waiting him out, he exhales, the glow around his fists dissipating. He advances again.","","Then the air tightens around Eric's fists. Flame erupts, a dry heat washing over you. His feet dig in, his knees bend.","","You see every detail as he rises. The knotted belt whipping on his crimson [i]gi[/i], the veins standing out on his fist, his clenched teeth. Burnt ozone, the low roar of fire.","","Then he explodes upwards, fist rising in a blazing uppercut.","","You're in its path.","","*temp match_result 0","*gosub_scene utils show_fight_momentum","*temp uppercut_response \"none\"","*choice","    #Stand your ground. Brace for impact.","        *set uppercut_response \"guard\"","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *if (adj_toughness + trait_bonus_applied) >= dc_medium","            *set fight_momentum +1","        You sink in, legs set, breath held, core locked. Heat rushes up. You'll meet it head-on.","","    #Try to sidestep at the last second.","        *set uppercut_response \"sidestep\"","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *if (adj_technique + trait_bonus_applied) >= ((dc_medium * 0.5) + (dc_hard * 0.5))","            *set fight_momentum +1","        You shift your weight to your lead leg. To the side. Wait. Wait. Now \u2014","","*if fight_momentum < 3","    *if uppercut_response = \"guard\"","        Eric launches his [i]Rising Uppercut[/i], driving upwards in a tight leap, fire spiralling from his fist. The trailing flame lashes behind him like a whip. You try to raise your arms, but they're too slow, too heavy. His punch crashes through your guard, driving your own gloves into your face before slamming into your chin.","","        Your jaw snaps back. Vision whites out. You hit the mat like dead weight. The ref starts the count, but even sitting up feels like dragging your body through water. You're done.","    *elseif uppercut_response = \"sidestep\"","        Eric launches his [i]Rising Uppercut[/i], driving upwards in a tight leap, fire spiralling from his fist. The trailing flame lashes behind him like a whip. You're a half-step too slow. Before you can move, his fist catches you clean under the jaw, snapping your head back hard.","","        The ring tilts. Your legs give out. You crash to the mat in a blur of lights and noise. The ref starts the count, but even sitting up feels like dragging your body through water. You're done.","    *else","        *bug invalid choice","    *set match_result 1","","*elseif fight_momentum < 5","    *if uppercut_response = \"guard\"","        Eric launches his [i]Rising Uppercut[/i], driving upwards, fire spiralling from his fist. The trailing flame lashes behind him like a whip. You brace, and your guard holds. The impact rattles through your bones, but you stay up.","","        He lands hard, off balance, grey smoke trailing from his fist. You throw your ${combo} with the last of your strength, but the hits land without weight.","    *elseif uppercut_response = \"sidestep\"","        Eric launches his [i]Rising Uppercut[/i], driving upwards, fire spiralling from his fist. The trailing flame lashes behind him like a whip. Every muscle screams as you throw yourself outside the arc. Still close enough to feel the heat streak past your jaw.","","        You counter with your ${combo}, but the hits land without weight. Nothing left to give.","    *else","        *bug invalid choice","","    He moves immediately, arms chambered, another [i]Energy Wave[/i] coming out fast, slamming into your chest. You lose your footing, and he sweeps your legs out from under you.","","    You lie there, dazed, staring vacantly at the bright floodlights.","","    *set match_result 2","*else","    *if uppercut_response = \"guard\"","        Eric launches his [i]Rising Uppercut[/i], driving upwards, fire spiralling from his fist. The trailing flame lashes behind him like a whip. You absorb the shock on your forearms. The force rattles through you, but you hold.","    *elseif uppercut_response = \"sidestep\"    ","        Eric launches his [i]Rising Uppercut[/i], driving upwards, fire spiralling from his fist. The trailing flame lashes behind him like a whip. Your muscles scream as you lunge sideways, heat streaking past your jaw. ","    *else","        *bug invalid choice","","    He lands hard, off balance, grey smoke trailing from his fist.","","    Now.","","    You close in with your ${combo}, connecting hard and breaking his guard. You step forward and finish with an uppercut that catches him right on the jaw.","","    His head snaps back, and he drops.","","    The ref starts counting. A hush falls over the crowd.","","    Four. Five.","","    Eric sits up slowly and glances at you. Whatever he sees makes him smile. He exhales, leans back on his palms. Makes no move to rise.","","    Nine... ten.","","    Breathing hurts. The strength leaves your arms. It takes a moment to register: you won.","    *set match_result 3","","*page_break","*if match_result = 1","    \"Winner is: Jiang!\" the referee announces, raising his hand. You catch your breath, then push yourself up.","","    Eric offers you a handshake. It radiates heat when you take it, uncomfortably warm. \"You made a good effort. Solid fundamentals. You just need more experience.\"","","    \"Thanks. I've been training for four months. Wanted to test myself. I learnt a lot today.\"","","    \"Keep at it.\" He pauses, then adds quietly, \"I train at Eastside Combat Club most weekdays. You're welcome to come over for a training session if you want.\"","","    He bows, then walks off. Your heartbeat slows, and your sweat-soaked shirt suddenly feels cold against your skin.","","    This wasn't your day. But you still fought to the end. That's enough.","    *set record_losses +1","*elseif match_result = 2","    \"Winner is: Jiang!\" the referee announces, raising his hand. You catch your breath, then push yourself up.","","    Eric offers you a handshake. It radiates heat when you take it, uncomfortably warm. \"You did well. Good combat sense. How long have you been training for?\"","","    \"Thanks. I've been training for four months.\"","","    His eyes widen. \"Four months? That's... incredible. You're talented.\" He pauses, then adds quietly, \"Look, I train at Eastside Combat Club most weekdays. You should drop by sometime. I'd like to train with you.\"","","    He bows slowly, then walks off. Your heartbeat slows, and your sweat-soaked shirt suddenly feels cold against your skin.","","    Maybe next time you'll win, or you'll get knocked down again. But this time, you stood your ground and fought. That's enough.","    *set record_losses +1","*elseif match_result = 3","    \"Winner is: ${last_name}!\" the referee announces, raising your hand. Eric pushes himself up slowly, eyebrows drawn together. Confusion? Doubt? He meets your gaze anyway. Finally, he bows deeply to you. The crowd is on their feet, shouting both your names.","","    \"You find openings fast. How long you been doing this?\"","","    \"Thanks. I've been training for four months.\"","","    Eric's jaw drops. \"Four months? That can't be.\" He studies your face closely. Then he nods.","","    \"Damn. Four months. I was just punching sandbags at that point. That's crazy.\" He pauses, then adds, \"Look, I train at Eastside Combat Club most weekdays. I think we could learn a lot from each other. Come by sometime.\"","","    He bows deep, then walks off. Your heartbeat slows, your sweat-soaked shirt suddenly feeling cold against your skin.","","    Maybe he's right. And if not, it doesn't matter. You fought. That's what counts.","    *set record_wins +1","*else","    *bug Unknown match result","","[i]Winning's not the point.[/i]","    ","[i]Showing up is.[/i]","*return"], "labels":{"fight":0}},
"eric_subplot": {"crc":398068004, "lines":["*label scene_introduction","*if eric_subplot_scene = 1","    After your fight with Eric, he invited you to train with him at Eastside Combat Club. You remember his disciplined footwork, his energy waves, the blazing uppercut. You've never seen anything like that at [i]MK[/i]. One doubt nags at your mind: it's unclear what you could offer him in return.","    *if (eric_almost_lapsed)","","        You haven't taken up Eric's invitation yet. His invitation may not remain open forever.","*elseif eric_subplot_scene = 2","    Last time you trained with Eric, you saw his disciplined training. But he struggled trying to integrate his energy techniques with his karate, finding it too volatile to control. Eric's invited you to train with him again. You don't know why he finds it helpful to train with you, but he keeps asking you back.","    *if (eric_almost_lapsed)","","        Eric hasn't seen you in a while. His time is valuable, and he might find other training partners if you don't reconnect soon.","*elseif eric_subplot_scene = 3","    *if eric_plot_timer = 0","        Eric's been training with you again, but there's a noticeable change in his approach. He's pausing for longer between drills, and not working as much on perfecting his technique. Instead, it seems like he's trying to understand his own motivations. At the end of your last session, he said, \"I want to show you something next time.\" No explanation. Whatever it is, it's not a regular practice session at Eastside.","        *if (eric_almost_lapsed)","","            Eric's been waiting to 'show you something' for a while, but he won't wait forever.","    *else","        Eric's last message was direct: \"Need some time alone. Hit an energy blockage.\" After the confrontation with Chloe, he seemed withdrawn. From the looks of it, he won't be reaching out for a training session this week.","*elseif eric_subplot_scene = 4","    *if eric_plot_timer = 0","        The Pearl River Cup is almost here. Eric's rhythm has changed again \u2014 tighter form, relentless repetitions, longer silences that settle slowly. After another few days of radio silence, he messaged you. \"I've been thinking about why I fight.\" That was it. You don't know what he wants: talk about it, unpack it through fighting, or just let it hang in the air.","        *if (eric_almost_lapsed)","","            The tournament is days away, and this sounds important to Eric. If you don't reach out soon, he might assume you're not interested.","    *else","        The Pearl River Cup is nearing, and Eric's messages have become terse. He's training privately, spending long hours at the Hong Kong Sports Institute, perfecting something he calls the \"Volcanic Dragon Ascent.\" No more sessions at Eastside. No offer to join him. If he's not ready to show you, you'll just have to wait.","*elseif eric_subplot_scene = 5","    *if eric_plot_timer = 0","        Since the Pearl River Cup concluded, there's been an evolution in Eric's bearing \u2014 his posture, his timing, even his silences. The volatility's still there, but it's no longer boiling over \u2014 now more of a soft simmer, like he's harnessing it. A different Eric from the one you've known. This time, just a short message. A time and a place. Whatever this is about, he wants you nearby.","        *if (eric_almost_lapsed)","","            TODO: ERIC_ALMOST_LAPSED WARNING TEXT SCENE 5","    *else","        You haven't seen Eric since the Pearl River Cup. His last message simply said, \"Got something to work out. Visiting Master Wong.\" Even the regulars at Eastside Combat Club haven't heard from him. Whatever revelations he discovered, he's not ready to talk about it.","*elseif eric_subplot_scene = 6","    *if eric_plot_timer = 0","        Eric's latest message wasn't a text, but a voice message, quiet and deliberate. He says he's been staying at Master Wong's new training centre. \"I've found it,\" the message says. \"I want to show you.\"","        *if (eric_almost_lapsed)","","            TODO: ERIC_ALMOST_LAPSED WARNING TEXT SCENE 6","    *else","        Eric's last communication: a disorganised jumble of messages and voice memos, consisting of fragmented thoughts about cultivation, harmony, intention, performance. Then nothing for days, your response left unread. The gathering at Master Wong's training centre must have opened something up. Whatever he's doing, it's consuming all of his focus.","*else","    *bug Eric subplot scene not found","*return","","*label scene_choice","*if eric_subplot_scene = 1","    *comment earliest: chapter 2, first fortnight","    *comment eric_friendship from this chapter: 1-4 for accept, 0-3 for reject","    *comment cumulative eric_friendship after this chapter: 1-4","    *gosub event_1","    *set stat_technique %+2","*elseif eric_subplot_scene = 2","    *comment earliest: chapter 2, second fortnight","    *comment eric_friendship from this chapter: 0-2","    *comment cumulative eric_friendship after this chapter: 1-6","    *gosub event_2","    *set boxing_insights_unspent +1","    *set eric_plot_timer 2","*elseif eric_subplot_scene = 3","    *comment earliest: chapter 3, second fortnight","    *comment eric_friendship from this chapter: 2-4","    *comment cumulative eric_friendship after this chapter: 3-10","    *gosub event_3","    *set stat_technique %+4","    *set unlocked_eric_training True","    *set eric_plot_timer 2","*elseif eric_subplot_scene = 4","    *comment earliest: chapter 4, second fortnight","    *comment eric_friendship from this chapter: []","    *comment cumulative eric_friendship after this chapter: []","    *comment eric_romance from this chapter: []","    *comment cumulative eric_romance after this chapter: []","    *gosub event_4","    *set boxing_insights_unspent +1","    *set eric_plot_timer 3","*elseif eric_subplot_scene = 5","    *comment earliest: chapter 6, first fortnight","    *comment eric_friendship from afterhours: 0-4","    *comment eric_friendship from this chapter: []","    *comment cumulative eric_friendship after this chapter: []","    *comment eric_romance from afterhours: 0-2","    *comment eric_romance from this chapter: []","    *comment cumulative eric_romance after this chapter: []","    *gosub event_5","    *set eric_plot_timer 3","*elseif eric_subplot_scene = 6","    *comment earliest: chapter 7, second fortnight","    *gosub event_6","    *set eric_subplot_status \"finished\"","*else","    *bug Eric subplot scene not found","*return","","*label event_1","Quarry Bay: a business district defined by its efficiency. Office towers, metal and charmless, press against ageing apartment blocks. A bakery vents fragrant steam into the street. You pass a construction site, silent, wrapped in green netting, a pigeon lounging on a bamboo pole. Then you arrive at the building Eric directed you to.","","A facade of grey concrete, a brushed steel door, no signage \u2014 it could easily house a cram school or a property management company. You punch the code into the numeric keypad. It lights up green and emits a cheerful, annoying electronic melody. A narrow stairwell of raw concrete leads downwards, and with each step the air becomes cooler. The doors of the gym are open, and you already hear the rhythmic breathing, the squeak of shoes pivoting, the [i]crack[/i] of a solid strike on a training bag.","","You spot Eric before he notices you. His red gi stands out amongst the plain white karate gis, boxing shorts, and Muay Thai pants in Eastside Combat Club. As you step through the doorway, the muffled sound of training sharpens. The sweat and old leather smells the same as in [i]MK[/i], but infused with the cool bite of aggressive air-conditioning. Fighters glide across clean blue mats, rows of overhead fluorescents flooding the space with white light. A few glance at your outfit before returning to their training.","","Eric's coaching a young fighter at the open mat area. \"Elbow higher,\" he says calmly, as he adjusts the student's arm with a light touch. \"Now rotate from your centre.\" The student twists from her core, forearm sweeping across in a flowing parry. Eric nods in approval.","","You recall Eric's confidence, his explosive energy, the relentless aggression during your fight. Now, he carefully studies people's stances and adjusts their form with light touches.","","He finally looks up and spots you near the entrance, the corner of his mouth lifting into a slight smile. He bends slightly to say something to his student and then approaches you.","","\"${first_name} ${last_name},\" he says. \"Didn't think you'd actually show up.\"","","*choice","    #\"I thought it was worth checking out.\"","        \"I thought it was worth checking out,\" you reply. You nod at the expensive equipment. \"This place is professional.\"","    #\"Your fighting style was unique.\"","        *gosub_scene utils increase_empathy","        *set eric_friendship +1","        \"Your fighting style was unique,\" you reply, watching the students around you. \"Spectacular, but also effective. I want to learn more about that.\"","    #\"I wanted to see how different people train.\"","        *gosub_scene utils increase_analysis","        *set eric_friendship +2","        \"I wanted to see how different people train,\" you reply. \"My gym is great, but it's... duct taped training bags and coaches yelling.\"","","\"Been training here for a year,\" Eric says, his gaze sweeping across the room. \"The facilities are good, but more importantly, they let me train my specialised techniques.\"","","He leads you towards the mats. \"Come on.\"","","You work with Eric on some boxing drills. He focusses intently on your form as you go through basic combinations.","","\"Your guard is dropping.\" He taps your chin lightly with his focus mitt. You reset your guard and land a one-two, drawing a soft grunt of approval.","","\"Don't telegraph. Less wind-up. Faster, like a whip.\"","","Six more reps. \"Your shoulder drops when you go for the cross. Keep it level and snap from your guard.\"","","He adjusts his mitts, then pauses. You're breathing hard. He doesn't comment.","","\"You know, I used to think power solved everything,\" he says, half-smiling. \"Turns out it only solves... a specific kind of problem.\"","","He watches your guard reset. \"It's good seeing you work on the basics. Reminds me how much the fundamentals matter. I forget that, sometimes.\"","","He claps the focus mitts together. \"Again.\"","","*page_break","*if (fight_opponent_name = \"Katie\")","    \"Your fundamentals are decent for having only trained a few months,\" he says during a water break, handing you a clean white towel. \"But your guard still drops when you throw anything beyond a jab. Anyone with experience will punish that immediately. Who are you fighting next?\"","","    \"Katie Reynolds. Ring name 'Pressure Point'. Haven't been able to find out much about her.\"","","    \"Ugh. Reynolds? She's... it's not even like a normal fight. More like she's conducting experiments that involve a lot of screaming. You're going to have a bad time if you go into the fight like this.\"","","*else","    \"Your fundamentals are decent for having only trained a few months,\" he says during a water break, handing you a clean white towel. \"But your guard still drops when you throw anything beyond a jab. Anyone with experience will punish that immediately.\"","","Eric notices your concern. \"We'll work on your form. That's the best way to prepare right now,\" he says, gesturing towards the mat again. Another half hour of pad work. Your shirt is soaked, and you're grateful for the fierce air-conditioning they have here.","","Sitting down again, you wipe the sweat from your forehead and think back to the fight with Eric. \"You found the weaknesses in my defence pretty quickly in our match.\"","","A small nod. \"Yeah. I kept dropping my left hand all the time when I was starting out. My coach would whack me with a mitt every time it happened.\" He mimes bringing his guard up, and smiles.","","Then, his gaze wanders over the room, taking in the groups of fighters working on grappling, striking, kickboxing, karate. A comfortable silence settles between you on the bench.","","\"Can I ask you something?\" he says, his voice lower. \"What made you step into the ring?\"","","You notice he's looking directly at you. The gym noise fades.","","*choice","    #Tell him you were looking for a new challenge.","        *gosub_scene utils increase_composure","        *set eric_friendship +1","        You explain how you feel stuck in your office job. Fighting provides a real challenge, with real consequences.","    #Talk about how you want to test your limits.","        *gosub_scene utils increase_analysis","        \"I want to know what I'm capable of,\" you explain. Some questions can only be answered in the ring.","    #Say that it started as a hobby, but then became something more.","        *gosub_scene utils increase_empathy","        *set eric_friendship +1","        \"I just wanted to improve my boxing,\" you explain. Then one thing led to another.","","Eric nods thoughtfully, studying your face. \"I see something in you. It reminds me of when I started.\" He flexes his fingers, and the veins pulse on the back of his hand. \"You have potential. But more than that, you have spirit.\"","","He pauses. \"I like to train newcomers, give something back.\" He looks down at his sleeve, smooths out a crease in the red cotton fabric. \"I've been working on my own techniques as well. I want to balance my energy techniques with my karate.\"","","He flexes his hand, clenching and relaxing it. \"Most people want to see me perform party tricks. A few others don't want me to use my power at all.\"","","Eric stares at his hands, lost in thought. A fighter calls Eric from across the gym, pointing at the speed bags, and Eric rises, exhaling softly. ","","\"I have to go, but I'd like to continue this. If you're interested, I train here Tuesday and Thursday evenings. You're welcome to join. I think we could learn from each other.\"","","\"Learn from me?\" The words escape your mouth before you can stop them. \"I'm barely keeping up.\"","","Eric just extends his hand.","","\"Training partners?\"","","*choice","    #\"Training partners.\"","        *set eric_friendship +1","        \"Training partners.\"","        ","        His handshake is firm and warm. \"Good. Thursday, six o'clock. Be ready to work hard.\"","","        He takes a step towards the fighter who called his name, then turns around, glancing at your hands.","        ","        \"Bring proper hand wraps next time. Your form is actually pretty good overall, but you don't want an injury there.\"","","        Eric's already back to work. He kneels beside his student, tapping her heel gently with his fingers. You sling your bag over your shoulder and take one more breath of the cool air.","","    #Decline his offer.","        *set eric_subplot_status \"rejected\"","        \"I think I'll pass. It was a good session, but I'm not sure this is the path for me.\"","","        Eric nods. \"All right. It's not for everyone. I'm sure I'll see you around.\"","","        He shakes your hand firmly, then turns and walks away, kneeling beside the student who called him over. He taps her heel gently with his fingers. You watch him, but he doesn't look back.","","*return","","*label event_2","Weight machines clank, timers buzz, fighters shout [i]kiai[/i]s. You ram another cross into the heavy bag, savouring the shudder as it connects. You review your stance, feeling for a connection with the floor, as you assume the position Eric's drilling.","","\"Pivot more,\" Eric calls to you. He then demonstrates on the bag next to you: feet planted, a seamless rotation from his centre, thighs, core, shoulder, arm moving as a single whip, power driving through his fist. The heavy bag shudders. \"Power comes from the ground up, not just from your arm.\"","","You adjust your stance, narrowing your feet for better hip rotation, and throw another cross. The bag swings a bit further this time, sending another jolt up your arm all the way to your shoulder.","","\"Better,\" Eric says, allowing a brief smile. \"Now try the jab. Remember, speed without proper form is wasted energy, ${first_name}.\"","","You pace the jabs, each snap sending a brief jolt through the bag. Then, on Eric's call, you drill the one-two, the heavy bag beginning to gallop from the rhythm.","","\"Most fighters dream about the sizzle. They forget the part where you actually learn to cook. The [i]mise en place[/i] of combat.\"","","You pause. Just as you're about to respond, the front door swings open with a force that silences the gym. The air stops moving. Fighters freeze mid-spar. Backs straighten. Conversations are forgotten as every head turns towards the entrance.","","*page_break","\"Well, well! Fancy finding actual [i]fighters[/i] in this dump!\"","","A young woman strides through the entrance, shoulders relaxed, advancing with quick, deliberate steps. Her jet black hair is cropped in a precise bob, her eyes flicking from the heavy bags to the fighters to the mirrors. A sleeveless shirt with a small logo. Bare arms tight with lean muscle. A phone held loose in one hand, the other clutching a bundle of shopping bag handles.","","She sees Eric, and a smile snaps into place. Her white sneakers squeak on the mat as she makes a beeline for him, a fighter stumbling out of her way as she steps right through his space. She doesn't flinch, doesn't slow down, doesn't acknowledge him, never breaks rhythm.","","\"[i]Blazefist[/i] himself! Just the man I was hoping to see.\"","","Eric's jaw twitches, and a small vein at his neck pulses. \"Chloe,\" he says, each syllable slow and flat.","","*choice","    #Stay out of it for now, but observe the situation. ","        *gosub_scene utils increase_composure","        Chloe says Eric's name with just a bit too much space around it, like she's a circus ringmaster introducing a well-trained lion. Her footsteps stop a metre from Eric with a final squeak.","","        You look from Chloe to Eric. His jaw's tight, but his hands remain loose and open at his sides. This isn't your fight. Not yet.","","    #Study her. There's something off about the way she carries herself.","        *set eric_friendship +1","        *gosub_scene utils increase_analysis","        She covered ground quickly. Her strides were long, but the movement didn't ripple through her hips. The shopping bags in her hand: embossed logos, thin tissue peeking out from the top. The heavy arc of their swing would make most people shift their weight, but she doesn't compensate. ","","        She stops her advance a metre from Eric, then stands still. A smile that looks like a glare.","","    #Let her see you watching. She's abrasive, but rather fascinating.","        *set chloe_friendship +1","        *gosub_scene utils increase_empathy","        You watch as she stops her approach in front of Eric, slightly inside his personal space. The shopping bags swing like a pendulum, but her arm stays steady.","","        She gives Eric a smile that's all teeth. Her posture doesn't change. Eric's weight shifts backwards.","","        Her eyes flick briefly to you, noticing your attention. You don't say anything, but you don't look away, either. The slightest eyebrow raise, then back to Eric.","","\"Just finished some retail therapy,\" she casually says, lifting her shopping bags above her head, forcing everyone's eyes upwards. \"Thought I'd stop by and see what all the fuss is about.\" Her gaze shifts to you, a quick smirk dismissing your tattered gloves.","","\"Eric always did have a soft spot for... underdogs,\" she remarks, in a stage whisper that carries to the whole room.","","You inhale slowly, raise your eyebrows, but say nothing.","","She's close enough that her amber perfume cuts sharply through the gym's usual sweat and leather. \"Still working on that jab, cross, hook, Eric?\" She mimics the combination with wobbly hands, but her shopping bags somehow keep pace perfectly.","","\"Where's the fire? Where's the dragon stuff that actually makes you worth watching?\"","","\"We're working on fundamentals,\" Eric replies, his tone flat. \"Foundation work.\"","","Chloe rolls her eyes and sighs with her whole body. You almost hear an \"ugh\" come out with it. \"Boring! You know what people pay to see.\" She flicks her fingers at Eric's fists with a small laugh. \"The flames. The crackle. The stuff that makes you [i]special[/i]. Pearl River Cup is next month, Eric. Nobody's packing the stands to watch basic combos.\"","","\"How I train is none of your business, Chloe.\" He's speaking slower now, every word controlled.","","\"Just looking out for a fellow fighter,\" she says, all wide eyes and halo. \"Playing it safe, basic fundamentals...\" she looks directly at you, \"might be fine for beginners with nothing special.\"","","Her attention returns to Eric. \"You, though? You're wasting your potential.\"","","You catch a whiff of ozone. A brief crackle, then a spark flickers on the knuckles of Eric's right hand before vanishing. He glances at his hand, stares at Chloe, and then takes a long, slow breath.","","*choice","    #Watch Eric's hands, how he struggles to keep his temper.","        *gosub_scene utils increase_empathy","    #Feel indignation at Chloe's antagonistic attitude.","    #Look around at the other fighters, see how they don't want to get involved.","        *gosub_scene utils increase_analysis","","\"My energy techniques aren't party tricks\", he says, his voice now firm. \"They require discipline. Control. Otherwise, everyone gets hurt.\"","","Chloe takes a step closer, less than an arm's length from him. \"Discipline? Control? Sounds like something a coward would say. People are starting to wonder if you're stale bread, Blazefist. They're saying you don't have it any more.","","Eric's chest expands slightly. His stance drops slightly lower. He inhales deeply, and you recognise it as the same breath before the flaming uppercut in your fight.","","The air seems to crackle between them. Then Eric's shoulders relax slightly, although his gaze remains fixed and unwavering on her.","","\"My training methods are my own business, Chloe,\" he says, his voice quiet. \"I don't need to justify them to you or anyone else.\"","","*choice","    #Stay silent. Let Eric handle this.","        *gosub_scene utils increase_composure","        Eric doesn't need backup. Not right now. You keep vigil nearby.","    #Try to anticipate Chloe's next move.","        *gosub_scene utils increase_analysis","        Chloe's words don't seem accidental. But you can't tell if she's improvising, or if it's calculated.","    #Watch Eric carefully. Get a sense of why his reaction is so intense.","        *gosub_scene utils increase_empathy","        His voice sounds calm, and he dismisses Chloe's provocation, but his stance tells another story.","","Chloe steps closer, her smile sharp. \"Oh, but you [i]do[/i] need to, Eric, you do. The Pearl River Cup committee was specifically asking about you yesterday. Wondering if the 'Blazefist' they're promoting will live up to the hype this year. Wondering if they should feature someone more... committed to giving the audience what they want.\"","","Eric tightens up with a sharp breath, a wave of heat pulsing across your forearm. \"The committee knows what I'm capable of.\"","","\"Of course they do. But they also know what sells tickets.\" Chloe glances at you, eyes narrowed, before continuing. \"Your reputation won't help if you never show your signature moves.\"","","Her voice softens. \"Look, there's an exhibition match next week at Central Plaza. The big sponsors will all be there. Come and show them you've still got it. Or people will start saying you've lost your edge.\"","","\"I haven't lost anything.\"","","\"Prove it, then. Or don't. Keep on throwing one-twos while someone else steals your spot.\"","","She flicks her shopping bags, bunching all of them cleanly onto one shoulder. \"Unless you think you're too good for flashy techniques now. Master Wong would love to hear that.\"","","She smiles as if she'd just ticked something off her to-do list, turns her back to Eric, and glides towards the exit. ","","The silence in the gym lifts, conversations gradually resuming. Eric still hasn't moved. His expression is blank, but you see the stiffness in his neck, the tension in his jaw.","","*choice","    #Wonder if she was actually trying to help him.","        *gosub_scene utils increase_empathy","        She wanted him off-balance, shaken. Then she hit him with her ultimatum. An insult, but also a challenge.","","    #Analyse how she carefully set up her proposal. This was planned from the start.","        *gosub_scene utils increase_analysis","        You see how much information she embedded into her proposal. The committee's concerns, the exhibition match, the sponsors. All of it dropped casually into the conversation.","","    #Stay focussed on Eric. This confrontation hasn't ended for him.","        *gosub_scene utils increase_composure","        Eric is still rooted in place. Shoulders raised. Lips pressed into a thin line. He might as well be in the ring.","","Eric exhales slowly and turns to you. \"Sorry about that. Chloe... she loves to make things complicated.\"","","\"Yeah,\" you say. At the far end, a timer beeps longer.","","\"She mentioned Master Wong. Is that your [i]sifu[/i]?\"","","Eric nods as he loosens his hand wraps. \"Been training with him since I first discovered these abilities.\" A faint amber glow briefly envelopes his knuckles. \"But he believes energy projection should be used to connect with nature, not for combat.\"","","He looks down and shakes his head slightly. \"I understand where he's coming from. But that doesn't win championships.\"","","\"So what will you do about the exhibition match?\"","","He doesn't answer, his gaze drifting across the gym, where a few fighters stretch in silence. \"Master Wong says I rely too much on the energy techniques. That I'll burn myself out.\" He shakes his head, runs his palm absently over the knuckles of his other hand.","","*page_break","As you finish towelling off, Eric approaches you again. He starts to speak, but then stops. One hand reaches for the wraps on the other hand, but they're no longer there.","","\"${first_name}, I've been working on something with Master Wong,\" he finally says. \"My energy techniques. Not about controlling them, but about intent.\"","","He looks down at his hands. \"He doesn't usually receive visitors.\" The only sound is the low hum of the air conditioning.","","\"I think it might help. If you wanted to see it. What I've been trying to learn.\"","","*choice","    #\"I'd like that.\"","        *set eric_friendship +1","        You consider his offer. It doesn't sound like a casual invitation.","","        \"I'd like that.\"","","        Eric nods, but there's a momentary twitch at the corner of his eye, and he glances away.","","    #\"That sounds... intense. Can I think about it?\"","        You consider his offer. It doesn't sound like a casual invitation.","","        \"That sounds... intense. Can I think about it?\"","","        \"Of course.\" Eric nods, too quickly. \"I'll text you the details anyway. Just in case.\"","","You gather your things and head towards the exit. Eric waves, and sits on the bench, eyes closed, hands on his lap. A faint golden glow flares from his hands, occasionally flashing crimson, never quite settling.","","[i]A Boxing Insight takes shape, sharp and half-formed.[/i]","*return","","*label event_3","The red minibus rattles along the rural Yuen Long road, three-storey New Territories village houses giving way to corrugated metal warehouses, then to storage depots and bare concrete. Half-abandoned villages dot the countryside, overrun by wild vegetation. Eric stares out the smudged window, his body hunched in the small minibus seat. He opens his mouth, then closes it again. The minibus slows as the road gets bumpier. ","","\"We're almost there,\" Eric says, as a small store and a few dilapidated houses come into view. \"Master Wong's a short hike from the nearest settlement. He doesn't get many visitors.\"","","The minibus stops in front of a small village. You drop a ten-dollar coin into the fare box and step off. The air is cool against your skin, smelling of earth, wet leaves, and moss, a stark contrast with the vehicle exhaust and food aromas in the city. The few stone houses are old, with faded tile roofs, clustered around some paved paths. A few chickens wander casually around the open areas and peck at insects, their clucks drifting through the open doorways and rusted iron railings. You don't see anyone around, not even any elderly villagers at the stone Chinese chess table.","","Eric silently leads the way through the village, turning onto a dirt trail that climbs upwards through bamboo groves. Your footsteps fall crisply on dry leaves and loose gravel. The air is cooler here, in the shade, and you breathe in the distinctive fragrance of wild lemongrass and camphor.","","Fifteen minutes later, the trail widens into a forest clearing, bordered on one side by a waist-high brick wall. A yellow hard hat rests against its base. At the centre of the clearing, behind a neat vegetable garden, stands a Hakka dwelling. Blue-grey brick walls, red clay roof tiles, small metal-barred windows, and a squat stone chimney.","","\"Here we are,\" Eric whispers. He pauses before the faded wooden door.","","*choice","    #You drink in the stillness. No need to act right now.","        *gosub_scene utils increase_composure","        Eric hasn't knocked. He's standing in front of the door, arms relaxed at his sides. You match his stillness. The only sound is of the wind whistling through bamboo.","","    #You sense Eric's careful tension. He looks like he's returning to a memory.","        *gosub_scene utils increase_empathy","        Eric's standing in front of the door, weight shifting from one leg to the other. His neck and shoulders stiffen, but it's not the anticipatory energy of competition.","","    #You assess your surroundings. Remote location, and a methodical garden.","        *gosub_scene utils increase_analysis","        A single, winding path. Dense vegetation providing natural concealment. The garden: orderly rows, evenly spaced. A caretaker's precision.","","The door silently swings open and a short elderly man emerges. He's dressed simply in a plain brown shirt, trousers, and cloth shoes. He doesn't hurry, but he closes the distance effortlessly. His eyes, sharp and piercing, settle on you briefly, before moving to Eric.","","\"Eric. You're here.\"","","Eric bows low. \"Master Wong, this is ${first_name} ${last_name}, the training partner I mentioned.\" ","","Master Wong nods. The silence lingers as he studies Eric, his expression unchanging. After several more seconds, he turns back towards the house. \"Come inside.\"","","*page_break","The house smells of aged cedarwood and oolong tea. The main room occupies most of the interior, wooden staves leaning against one wall, beneath a calligraphy scroll: \u4ee5\u548c\u70ba\u8cb4 \u2014 'regard harmony as precious.' On the opposite wall, wooden racks hold red-tasselled sabres and swords. The middle contains a low wooden table with a clay teapot and three delicate porcelain cups. Your feet move across the wooden floor, a small window spilling amber light across the floorboards.","","Master Wong extends a hand towards the table. He lifts the teapot and pours tea in an unbroken stream into the three cups, sliding one each to you and Eric. The tea, mahogany brown, smells earthy, so rich it's almost overpowering. You bring it to your lips, the steam warming your face, and take a sip, the tannins hitting sharp, settling deep into your body.","","Master Wong studies you, his eyes clear and sharp. \"So you are Eric's new student,\" he says, turning towards Eric.","","\"Training partner,\" Eric says gently. \"We've been training together for more than a month now.\"","","Master Wong clears his throat and lifts his teacup, taking a slow sip. His attention returns to you. You adjust your hips slightly on the cushion, and notice how particles of dust dance in the air where the light streams in from the window.","","He speaks quietly, but the words seem to reach you in an instant. \"Eric says you fight without formal sanction. That carries danger, ${first_name} ${last_name}, and no reward. And he says you're not interested in fame and glory. So why do you fight?\"","","*choice","    #\"To find something real, something different from my office job.\"","        *gosub_scene utils increase_composure","        You explain your office life, reading through reports, clicking on spreadsheets, sitting through endless meetings. \"Fighting felt different, right away. When I land a punch or take a hit, it's real. The bruises on the next day prove it.","","    #\"To discover where my limits are, and maybe push them.\"","        *gosub_scene utils increase_analysis","        \"Every time I fight, I learn something new about myself,\" you tell Master Wong. \"What I do under pressure, how much I can endure. I see my flaws, fix them, and try to do the best I can.\"","","    #\"I'm still figuring that out. But I know this is something I need.\"","        *gosub_scene utils increase_empathy","        \"I'm not sure why, myself,\" you admit to Master Wong. \"When I land a good punch, or when I'm totally exhausted and can't go further... all of that, it feels right. This all started as exercise, but it's more, now. I can't just go through the motions like before.\"","","He leans slightly forward as he listens to you, never interrupting. Then he nods slowly. \"You do not lie to yourself. A promising beginning.\"","","Turning to Eric, he continues, \"How about you, Eric? Have you found the answers to your questions?\"","","\"I'm refining my energy techniques, Master Wong. Working on control and using them at the proper moments. It's challenging, but I'm making some progress.\"","","\"Hmm.\" Master Wong sets down his tea cup. \"Show me.\"","","Eric rises and moves to the open space between the table and the entrance. He begins a flowing [i]kata[/i] that you haven't seen before, involving slow, whole-body movements. Instead of fire, a faint amber glow envelops his fists and feet.","","Master Wong watches, eyes focussed on the energy flow. Eric finishes, returning to a standing ready stance, and bows. Master Wong nods once, then touches two fingers to his chin, eyes narrowed.","","\"Better,\" he notes. \"You do not fear your power like you did before. And so you no longer fight it. But you still see it as something you need to control.\"","","Eric's forehead creases as he glances at Master Wong. \"I thought the point of our training was to control it.\"","","\"That means you think of it as something separate from you. How can it become part of you, when you push it away?\" He stands up, then nods at the doorway. \"Come, both of you.\"","","He leads you outside to a small practice yard behind the house, a circle of packed dirt twenty paces across. In the middle, there's a line of six wooden poles, the shortest barely above your knee, the tallest rising above you, each one just wide enough for a single foot.","","\"Watch,\" he says.","","*page_break","Arms behind his back, Master Wong walks over to the shortest pole, and signals for you to stay a few paces away. He steps onto the short pole, balancing on one foot as if it were solid ground.","","Then he brings one arm out from behind his back. The hand holds a palm-sized porcelain bowl, but it's too high for you to see what it holds. Master Wong bends his knee, and hops to the next pole, landing on it with the same foot. He then climbs up the line of poles, hopping each time, without looking at his feet. He stays at the highest pole for a few seconds, shoulders relaxed, breath steady.","","He looks from Eric to you, then to his bowl. He steps down the poles at a steady pace, landing in front of you as if returning from a walk.","","Then you see the contents of the bowl. It's filled with tofu pudding, a golden film of ginger syrup and a small heap of yellow rock sugar on top, undisturbed. Master Wong reveals a porcelain spoon in his other hand, scoops a mouthful of the tofu, and savours it.","","After a few more seconds, he looks at Eric and raises his eyebrows.","","Eric sighs, closing his eyes for a moment, then makes a sound that's almost a laugh. \"Master Wong... I know what you mean. I want that too. But in tournaments... it's all about winning.\"","","\"Yes, yes. The shiny trophies, the cheering crowds. But...\"","","\"I haven't forgotten your teachings, Master.\" Eric straightens up, inhales deeply. \"I do it to test myself. To measure my skills against others.\"","","\"And how do you measure that? Can the judges score it?\"","","Master Wong steadily lifts a spoonful of tofu to his mouth, his eyes fixed on Eric. Eric holds his gaze.","","*choice","    #Focus on Eric's posture, and what it says about his state of mind.","        *gosub_scene utils increase_empathy","        You see how Eric's jaw is slightly clenched, how his hand has slowly curled into a loose fist. The quiet tension of a familiar argument.","    #Recall Eric's frustration at the gym when Chloe challenged him.","        *gosub_scene utils increase_analysis","        When Chloe questioned Eric's ability to impress the committee, his reaction was similar. Same tension in the jaw, same intense stare. But more restrained here. Everything staying within safe limits.","    #Focus on your own breathing. Don't get involved.","        *gosub_scene utils increase_composure","        You breathe deep. This isn't your place to intervene.","","\"Enough.\" Master Wong turns to you. \"Stand here.\"","","You step forward.","","\"Attack Eric. Light contact only.\"","","Master Wong fills the next hour with the most basic of drills. Blocks, one-twos, footwork. He nudges your elbow down, and pushes your wrist to the left with his palm. His foot taps your knee back into alignment. Even your jab feels clumsy. He taps Eric's shoulder with two fingers as he reminds him, \"Softer. You're trying to overpower the energy flow.\"","","At the end of the hour you see Eric sweating, his arms occasionally shaking. Then Master Wong turns to you.","","\"Close your eyes,\" he says softly. \"Feel the air around you. Don't focus on your skin. Try to feel it from your centre. Sense the presence of others.\"","","You shut your eyes and try to follow his directions.","","*choice","    #Try to sense Master Wong's energy.","        At first, the only thing you can sense is your own heartbeat and your breath. Gradually, your senses heighten, and you notice how your shirt clings to your skin, the coolness of the air entering your lungs, the pressure of the ground beneath your feet.","","        Then something else. Your focus seems like something physical now, something to be moved around at will. You focus it on where you think Master Wong is, attempting to detect any energy there. Nothing. Just darkness behind your closed eyes. You fight the urge to open them.","","        After many more minutes, you become aware of a presence. It feels like something faint, imperceptible, that hits all five senses. A steady, barely detectable warmth emanating from Master Wong. You can't think of any words to explain it. Like a quiet pressure in the air, that vanishes if you try to think about it.","","        \"Mmm,\" you hear Master Wong say softly, as if from far away. \"Most people cannot sense this sort of restrained energy.\"","","    #Try to sense Eric's energy.","        At first, the only thing you can sense is your own heartbeat and your breath. Gradually, your senses heighten, and you notice how your shirt clings to your skin, the coolness of the air entering your lungs, the pressure of the ground beneath your feet.","","        Then something else. Your focus seems like something physical now, something to be moved around at will. You focus it on where you think Eric is, attempting to detect any energy there. Nothing. Just darkness behind your closed eyes. You fight the urge to open them.","","        After many more minutes, you become aware of a presence. It feels like something faint, imperceptible, that hits all five senses. A pulsing warmth that feels almost electric, surging and receding like waves breaking on a shore. Several bright points, steady and intense, that must come from his hands and core.","","        \"Yes,\" Master Wong says softly. \"You sense the cadence of his energy.\"","    ","    #Try to sense the threshold between your energy and the surroundings.","        At first, the only thing you can sense is your own heartbeat and your breath. Gradually, your senses heighten, and you notice how your shirt clings to your skin, the coolness of the air entering your lungs, the pressure of the ground beneath your feet.","","        Then something else. Your focus seems like something physical now, something to be moved around at will. Rather than directing it outwards, you turn it inwards, trying to find the border where \"you\" ends and the rest of the world begins. The more you focus, the more the boundary becomes unclear. The hairs on your skin seem to reach out; your breath merges with the air. You sense that there's some kind of field that extends inches from your body, responsive to your intent.","","        \"You are beginning to understand,\" Master Wong says softly.","","*page_break","The afternoon sun begins to sink below the bamboo, and Master Wong concludes the session. Inside again, simple bowls of tofu pudding await. Eric takes his with yellow rock sugar, while you add ginger syrup to yours. The ginger barely bites, its sweetness blending with the silky tofu to create an exquisite balance of texture and flavour.","","Dessert finished and tea poured, Master Wong's shoulders drop slightly, and Eric leans back. The conversation turns to Eric's latest activities. He brings up the approaching Pearl River Cup, although he doesn't mentions Chloe or the situation with the committee.","","\"These commercial events,\" Master Wong says, as he sets down his teacup with a soft clink. \"They encourage the wrong things. Spectacle over substance.\"","","\"They also pay the bills, Master,\" Eric counters. \"And they raise my profile. In today's world, I need a platform to reach people. Then I'll be able to show them what real skill looks like.\"","","\"True. But will you get around to that?\"","","Silence returns to the room. You stare at the tea in your cup, watching how the surface ripples with every tremor of your hand.","","Master Wong sighs, long and slow. Then he looks at Eric, his gaze soft, though his smile doesn't quite reach his eyes. \"Your improvement is impressive, Eric. Your control is better, your understanding is deeper. But technical mastery... that was never the true challenge for you.\"","","He turns to you, his eyes bright and piercing. \"What about you, ${first_name}? What do you think of my former student and his struggles?\"","","*choice","    #Say that you admire Eric's commitment and discipline.","        *gosub_scene utils increase_empathy","        You tell Master Wong that you admire Eric's commitment to improving his skills and his determination to keep pushing forward. That you appreciate his willingness to teach others and give back.","","        He listens to you, eyes never leaving yours, and then nods. \"He has always worked hard, and he has always been willing to support others.\"","    #Acknowledge the conflict that you've observed in him.","        *gosub_scene utils increase_analysis","        *set eric_friendship +1","        You choose your words carefully: that he's intensely competitive, yet also appreciates his mentor's teachings. Eric still seems to be wrestling with this tension.","","        He considers your words for a long time, his eyes becoming distant. Finally he says, \"this kind of conflict will show up in the ring, whether Eric's ready or not.\"","    #Note that Eric respects Master Wong more than he lets on.","        *gosub_scene utils increase_composure","        *set eric_friendship +2","        You note that their disagreement about the right path forward is clear, but Eric still speaks of his mentor with deep respect, and often draws from his wisdom in his training.","","        Master Wong's expression is almost unchanged, but a flicker of a smile crosses his face. \"That is good. Respectful disagreement is healthy.\"","","He says nothing more. Motioning for you to stay, he rises, and walks outside to the garden. He returns with a small cloth bag, tied with a hemp cord.","","\"Just as a precaution,\" he tells Eric. \"Use this healing salve sparingly. And I've included something for your friend's wrist.\" He glances briefly at you. \"I noticed ${he} @{gender_num favours|favours|favour} it slightly during the cross.\"","","You instinctively touch your wrist, where you hadn't noticed anything.","","\"Thank you, Master Wong,\" Eric says, bowing as he accepts the bag in both hands.","","*page_break","Master Wong escorts you to the edge of the clearing. \"Eric. The energy flows to where your attention is. The world will always try to steal your attention. What you refuse is more important than what you accept.\"","","Eric lowers his head, eyes closed. His eyelids flutter slightly. \"I will give it my best effort,\" he says finally, meeting Master Wong's eyes. \"I don't know if I can. But I will try.\"","","Master Wong nods, and places a hand on his shoulder, lingering longer than tradition would require. Then he turns to you. \"It was interesting to meet you, ${first_name}. Perhaps you will help Eric work things out.\" A smile dances at the corners of his eyes. \"He has always been better at teaching than listening.\"","","*choice","    #You become aware of your position in this dynamic.","        *gosub_scene utils increase_composure","        You've been quietly included into their mentor-disciple relationship, not as a student or stranger, but as something in between. A messenger. You feel a slight weight on your shoulders. It's not unpleasant.","    #You pick up on how Master Wong watches over Eric.","        *gosub_scene utils increase_empathy","        On the surface, frustration and amusement. You see his smile flicker, then return. Pride, maybe. But then the silence after, longer than expected. There's more beneath, and you doubt he will ever put it into words.","    #You observe how Master Wong balances criticism with praise.","        *gosub_scene utils increase_analysis","        A raised eyebrow after his agility demonstration. Praise for Eric's effort, then subtle disapproval that he feels the need to impress. A rhythm, though not quite a conscious strategy.","","You and Eric walk back to the village in silence, your shoes crunching on the dirt path, a few crickets chirping in the dusk. Memories bubble to the surface, of Master Wong's graceful movements, of the first moment you sensed the energy around you. As you leave the village behind and wait on the dusty road, Eric clears his throat.","","\"So.... that's Master Wong,\" he says, with a wry smile. \"He taught me how to use my energy powers. Then he spent years telling me to never use them.\"","","He gazes back at the village, shaking his head slightly. \"You know how I first discovered I could project energy? It was an accident, during a junior tournament. The next day, Master Wong found me. Said he felt the energy resonance, that he'd been watching for someone like me.\"","","Eric exhales softly. The minibus pulls up beside you, and you board together, tapping your Octopus to the fare reader. You sit side by side as the minibus pulls away.","","\"He taught me to understand it. But he also had strong opinions on the right way to use these skills.\"","","The village disappears from view. The surroundings soon return to the familiar urban landscape. Eric stares out the window, one hand cradling the cloth bag in his lap.","","\"He's not wrong,\" he says quietly. \"But it's not enough. Not for me.\"","","The reflection in the window shows his lips pressed tight, the flicker in his eyes. Then it's gone, a thin smile pasted over it.","","[i]Master Wong didn't officially train you. But you know enough now to practise what he taught, alone.[/i]","*set eric_friendship +2","*return","","*label event_4","Night has settled in. Gym bag slung over your shoulder, you walk to Mong Kok East to take the East Rail. You exit at Fo Tan, where the high-rises crowd you on all sides as you emerge on to the almost-deserted street, and duck into a narrow overpass that crosses a six-lane highway.","","The Hong Kong Sports Institute appears ahead, a large, squat complex of glass and steel.","*if current_season = \"winter\"","    The automatic glass doors slide apart.","*else","    The automatic glass doors slide apart and a puff of cool air hits you.","Inside, the walls are lined with busts of former Olympic medallists, inspirational billboards from bespectacled politicians, donor plaques featuring property tycoons. You head straight past. The creaking lift takes you to the wushu training hall, where Eric has the entire space to himself at this late hour.","","Eric greets you. He's in a worn white [i]gi[/i] today, sweat already darkening the back despite the cool air-conditioning. He sweeps a hand over the large hall, empty except for metal benches along one wall and a digital signboard mounted high above them. You set your bag down slowly on the bench, next to his. It slides off and hits the floor with a soft thud that echoes through the hall. You leave it.","","\"Told the director it would be safer if no one else was around,\" he says, his voice tight. He passes you a pair of focus mitts, not meeting your eyes. They feel twice as heavy as the ones at [i]MK[/i].","","\"I can almost control the fire during basic combinations. These mitts are reinforced, fire resistant. We'll take it slow.\"","","*choice","    #Feel the strain in Eric's posture and voice.","        *gosub_scene utils increase_empathy","        Eric sounds like he's in control. Too controlled. No friendly greeting, straight to the point. He handed you the mitts like they're dynamite. Something's on his mind, but you don't know what it is yet.","    #Assess the precautions Eric has taken.","        *gosub_scene utils increase_analysis","        Empty hall. Reinforced mitts. Everything points to an attempt at damage control. Eric's worried about the worst-case scenario. What is he planning?","    #Prepare yourself mentally for whatever might happen.","        *gosub_scene utils increase_composure","        You try on the mitts, test their weight. The heaviness is almost comforting.","","        Eric's unanchored. He needs someone steady. That's you. You meet his eyes and nod.","","He carefully winds his hand wraps, and you notice the metal strands embedded in the cloth, glinting in the white light. You hold the mitts as he instructs: both high, then angled left, then a left-right-left sequence. A faint amber glow surrounds his fists, and warm heat radiates to your arms when he makes contact, although your mitts stay cool to the touch.","","He starts with basic punches, and then moves on to more complex sequences. The force seems to come more from his arms than his body, sharp and insistent punches without much follow-through. As he works through longer combinations, the glow intensifies but becomes unstable, wavering, flickering, like a torch in wind. Sweat runs down his face, his jaw clenched tight.","","Straight punch, elbow, straight punch. But on the last punch, a crack, like thunder. Eric exhales sharply through his teeth, stifling a yell. The air smells of scorched ozone. He gasps, then wobbles slightly before steadying.","","Then he sits down, takes a long drink from his water bottle, and wipes his face with a towel. He doesn't say a word. ","","*choice","    #Compliment his effort and his progress with the energy integration.","        *set eric_harmony -1","        \"The fire looks like it's following your movement now.\"","","        \"Thanks. I just need to control it better.\" Eric smiles at you like he's grabbing a lifeline. ","    #Consider what Master Wong would advise in this situation.","        *set eric_harmony +1","        You think back to the visit with Eric to Master Wong's abode. Master Wong wouldn't approve of this. Forcing the energy, he'd say.","","        Although you haven't said anything, Eric notices your frown. He sighs. \"I know. I shouldn't over-exert myself. But...\"","    #Ask about how this relates to the upcoming Pearl River Cup.","        \"Are you training so hard because of the Pearl River Cup?\"","","        \"Yeah. The sponsors want winners, but they also want them to look good while doing so.\"","","        Makes sense. The audience wants entertainment, and Eric needs to win. This training serves both purposes.","","He takes another sip of water, and looks into the distance.","","\"This next technique, I've been training it for months. The Cup is the first time anyone will see it. It has to be perfect.\"","","Eric stands up slowly, then looks down at his hands. A frown crosses his face. Then he turns his head to look at you, and forces a smile.","*if eric_harmony < 50","    You return a small smile.","*elseif eric_harmony > 50","    You don't smile back.","*else","    You nod slightly.","","The muscles on his arms go taut, his hands balling into fists.","","\"The [i]Volcanic Dragon Ascent[/i].\"","","Eric strides to the middle of the training hall, well away from you, and extends his arm towards you, palm out.","","He bends his knees, his face tight with concentration, and takes in a deep breath. You feel a vacuum pulling you towards him. A roar of flame erupts in a column around him. He spirals upwards, fist extended skyward. The fire intensifies into a vortex around him.","","Then the flames disappear in a flash as he lands unsteadily on one knee, hands planted on the floor, sweat dripping onto the singed mat. Wisps of black smoke float up, distorting the air. The smell of ash and ozone reaches you. It's several seconds before he rises.","","A sharp cough. \"Damn. Still unstable. I can't use this.\" ","","He walks over, cradling his right hand at the wrist, where it trembles slightly.","","*choice","    #Tell him not to injure himself before the Cup, then steady his wrist.","        *set eric_romance +1","        *set eric_friendship +1","        You see the veins at his wrist pulsing rapidly, the skin reddened. You almost tell him to rest, but you see his clenched teeth, the tension around his eyes. Not the time for words.","","        You take his wrist between your hands, feeling the residual heat, the trembling muscles. You press your thumbs gently along the tendons.","","        His hand jerks, but he doesn't pull it away. You feel him holding his breath. The rest of his body doesn't move.","","        \"I couldn't control the fire.\" He cuts off the words with a short laugh.","","        \"You don't have to do this for me.\" His eyes are studying the floor mats.","    #Ask him what makes the [i]Volcanic Dragon Ascent[/i] so challenging.","        \"That's... a lot of energy. What makes it so hard to control?\"","","        \"The energy always needs to be in motion. If I lose focus for even a second, it will go out of control.\" He points at the scorched floor mat.","","        \"So it's about focus? Intention? Something like that?\"","","        \"Exactly. Guiding it, letting it know where I want it to go.\"","","        The hall is silent except for the sound of your breathing. The faint burning smell starts to clear.","","*page_break","Eric shakes his head with a slight smile. \"Master Wong would never approve. Too flashy.\"","","He stares at the scorched floor mat for a few seconds. Then, his jaw set, he pulls on his wrist wraps and quickly stands up.","","He begins the [i]Volcanic Dragon Ascent[/i]. The flame column blasts you with a wave of heat, and this time the tendrils of fire move smoothly. He lands on both feet, his chest heaving with effort.","","As soon as his breath evens out, he launches into another one. But this time the flames split. A loud snap cracks through the air, and the pillar collapses before he completes the ascent. A smell like burning honey reaches you.","","He lands hard on the mat with a thump. Pale, trembling, his hands and knees on the floor.","","*choice","    #Encourage him to push through and make the move work.","        *set eric_harmony -1","        *set eric_friendship +1","        \"You almost had it. Catch your breath and give it another shot if you feel up to it.\"","        ","        Eric takes a deep breath. \"Okay. I'm... fine,\" he manages. \"Just pushed it too far on the last one.\"","","    #Suggest that he take a breather.","        *set eric_harmony +1","        *set eric_friendship +1","        \"You look pretty drained. Do you want to ease off a bit?\"","","        Eric takes a deep breath. \"Yeah. That's a good idea. Pushed it a bit too far on that one.\"","","He lowers himself onto the floor mats. Your eyes drift to his hands. They're still shaking.","","\"What happened?\" you ask, taking a seat beside him.","","\"Burnout. I didn't move the energy fast enough, and it burned me from the inside.\"","","He winces. \"It... it makes me feel disconnected from my body. Master Wong warned me about this. Many times.\"","","*if (eric_romance >= 1)","    You rest a hand on his shoulder.","*else","    You give him space.","Eric swallows hard and looks directly at you. \"But the Pearl River Cup is too important. I need it. I need the recognition.\"","","He forms a fist with his right hand. But his fingers loosen and tremble. Eric shakes his head, and his eyes drop to the floor.","","\"Recognition,\" he repeats.","","He goes over to his gym bag and takes a bottle out, which you recognise as the bottle Master Wong gave him last time. He opens it, massaging the ointment into his arm. A faint smell of mint, camphor, medicinal roots. The trembling eases, gradually.","","*page_break","\"One last attempt,\" he whispers.","*if eric_harmony > 50","    Seeing your expression, he adds, \"different this time.\"","*else","    Seeing your expression, his mouth twitches, then he flashes you a brief smile.","","\"Less fire. Maybe that works better.\"","","He stands slowly and smooths out the fabric of his [i]gi[/i]. He breathes deliberately. In, out, in, out. Then he nods at you, and you retreat to the bench.","","He rises again in the [i]Volcanic Dragon Ascent[/i]. The fire is golden, not crimson. The flames seem to move almost languidly, expanding and contracting with his movements. A wave of warmth reaches you, softer on your skin, and more sustained.","","He lands smoothly on his feet, the fire melting away. Quick but not laboured breaths. The warmth lingers.","","\"That... felt different.\" He looks at you with the slightest frown, but his eyes are gleaming.","","*choice","    #Confirm that it looked and felt different.","        *gosub_scene utils increase_analysis","        \"Yes, it was different. Gold fire, not red. The flames stayed tight and moved with you.\"","        ","        He smiles, his voice steadier than before. \"Well, what do you think? Is this version better?\"","","    #Ask him how it felt compared to previous tries.","        *gosub_scene utils increase_empathy","        \"How did it feel to channel the energy this way?\"","","        His eyes go out of focus for a moment, as if he was replaying the move. \"Hmm. Not as hot. I mean, internally as well. I didn't feel myself burning inside much.\"","","        You point at the space above him where the flames rose up. \"It looked different too. More natural, like the fire was in sync with you.\"","        ","        He smiles, his voice steadier than before. \"So what do you think? Is this version good enough?\"","","    #Note the practical advantages of this modified move.","        *gosub_scene utils increase_composure","        *set eric_harmony -1","        \"This is much more controlled. You'll be able to rely on it in the tournament.\"","        ","        He rolls his shoulders back and nods. \"Yeah. It didn't take as much out of me either.\"","        ","        He smiles, his voice steadier than before. \"So do you think this version is tournament-ready?\"","","\"Yeah. You're ready, Eric. You can win it.\"","","Eric shrugs his shoulders, smiles, and slowly rolls his neck. \"Guess I'll find out soon.\"","","He opens his mouth to speak again, but nothing comes out. After a pause, he clears his throat, forcing the silence to break. He stares at you, making sure you're looking at him before he continues. \"You shouldn't come.\"","","You want to object right away, but you wait for him to continue.","","\"If I know you're watching, I'll try to impress you.","*if eric_harmony > 50","    That's the wrong reason to fight.\"","*else","    I won't be focussed on the fight.\"","","*label cup_choice","*choice","    #Say that he's right. It'll be easier to focus without distractions.","        *set eric_harmony +1","        \"You're right. It'll be easier to focus without distractions.\"","","        Eric nods slowly. \"I'm happy you understand what it means to me.\"","    #Agree with his reasoning, and remind him not to hold back.","        *set eric_harmony -1","        \"You're right. Don't hold back.\"","","        Eric nods and lightly claps you on the shoulder. \"I'll give it my best effort. That's the least I can do for you.\"","    #Say that you'll miss seeing him at the Cup, but you'll still be thinking of him.","        *set eric_romance +1","        \"I'll miss seeing you at the Cup, Eric. But I'll still be thinking of you.\"","","        Eric's ears redden slightly. He breaks eye contact, his gaze dropping to your neck.","","        \"I'll be thinking of you too, ${first_name}. Thank you, for being here with me.\" He clasps your hand in his, and smiles. After a moment, he releases his grip.","    *hide_reuse #Tell him you're attending anyway.","        *set eric_friendship -2","        Eric's jaw tightens. He takes a slow breath before he speaks. \"If you show up, ${first_name}, I won't be able to keep training with you.\"","","        Are you sure you want to go?","","        *choice","            #Yes.","                \"I'm going.\"","                ","                Eric doesn't say anything at first. His mouth opens part way. Then the warmth leaves his eyes, and he closes his mouth again.","","                \"Okay,\" he says. It sounds almost formal.","","                \"Then we stop here. Take care, ${first_name}.\"","                ","                He steps back from you, straightens up, and leaves.","                ","                *page_break","                A week later, you go to the Pearl River Cup. From the back of the crowd, you see glimpses of Eric's red [i]gi[/i], golden flames. After the match, he scans the spectators. His eyes settle on you for a moment.","                ","                He doesn't react. Not even a flicker.","                ","                Then he turns away.","                ","                You never see him again.","                *set eric_subplot_status \"rejected\"","                *set eric_subplot_scene 0","                *set eric_friendship 0","                *set eric_romance 0","                *goto event_end","            #Let me reconsider.","                Eric's shoulders ease slightly.","                ","                \"Thank you,\" he says quietly. \"I need to be completely focussed when I'm in the ring.\"","                *goto cup_choice","","The ventilation system powers down, and the training hall becomes completely quiet. Eric spares a last glance at the charred floor mat.","","*temp temperature_adj \"warm\"","*if current_season = \"summer\"","    *set temperature_adj \"hot\"","*elseif current_season = \"winter\"","    *set temperature_adj \"cool\"","Both of you step outside into the ${temperature_adj} evening air. A small bow from Eric, bending at the neck. \"See you soon, ${first_name}.\"","","*if eric_romance >= 1","    He turns to you one last time, his gaze lingering a bit too long. Then he's gone.","*else","    Then he's gone.","","[i]A new Boxing Insight settles into your body. Energy, flowing as it should.[/i]","","*label event_end","*return","","*label event_5","*return","","*label event_6","*return"], "labels":{"scene_introduction":0,"scene_choice":47,"event_1":96,"event_2":218,"event_3":392,"event_4":628,"cup_choice":836,"event_end":908,"event_5":911,"event_6":914}},
"katie_fight": {"crc":-1794788161, "lines":["*label fight","*temp dc_easy 10","*temp dc_medium 14","*temp dc_hard 19","*set fight_momentum 5","*set trait_bonus_amount 2","*set upgrade_multiplier 4","*gosub_scene utils calc_adj_stats","*comment If the player trains three times and rests once, and visits Eric both times, they'll be at effective stats of 9 for untrained stats, 14 for trained-once, 20 for trained-twice","*comment 1 = loss, 2 = win","*temp match_result 0","\"Hi! Are you ${first_name}?\" A cheerful voice, too bright for the mood, makes you jump.","","You turn to see a tall woman in neon pink Jazzercise leggings, teal headband, leg warmers and a \"Pressure Point Basics\" T-shirt. Her long brunette ponytail is bound with a purple scrunchie, and she cradles an anatomy textbook under her left arm. She adjusts her fingerless gloves, the black leather accentuating her long fingers.","","\"Yeah, that's me...?\" you reply.","","\"I'm Katie! They call me 'Pressure Point' in the ring.\" She smiles and extends her hand, ponytail swishing. \"We're up next. I've been looking forward to fighting a boxer. Boxers have such interesting upper body nerve points!\"","","You hesitate slightly before shaking her hand. Her grip is firm, and her strong fingers press into the back of your hand.","","\"I'm a pressure point fighter. I try to win by finding nerve points and inflicting debilitating pain,\" she says, like she's discussing the weather. \"But don't worry! Everything's temporary. There's no actual damage at all!\"","","She smiles and pats your shoulder lightly. \"I'm investigating pain responses for my kinesiology research. Your feedback after the match would be super helpful.\"  ","","You try to respond, but the announcer calls your names before you can gather your words. Katie waves cheerfully and bounds towards the ring. You follow her slowly, your brain still trying to process her words.","","The crowd's energy is different tonight. No cheering, no chanting. Feels like everyone's holding their breath.","","*choice","    #You wonder why she's so interested in causing pain.","        *gosub_scene utils increase_empathy","        She's extremely upbeat, that's for sure. And something compels her to inflict pain. You're not yet sure what that is.","    #You think about nerve point attacks and what adjustment you should make.","        *gosub_scene utils increase_analysis","        If she's telling the truth, one strategy suggests itself immediately: don't let her get close to you. You need to keep her at range, somehow.","    #Her willingness to tell you her fighting style is reassuring.","        *gosub_scene utils increase_composure","        Her methods may be brutal, but you don't sense any malice. She seems to think it's just another fighting style.","","You ease into your boxing stance, finding your footing on the firm canvas, as you wait for the referee to start the match. Katie stretches her fingers and enters what appears to be a Jazzercise pose that also incorporates three or four clashing martial arts styles.","","\"Remember, your joints aren't actually going to be damaged, even if it feels like it!\" she calls across to you.","","You swallow hard.","","The ref studiously examines a scuff mark on the canvas as he recites the standard instructions, words tumbling out as if he's trying to rush through a pre-flight safety announcement. His hand chop for \"Begin!\" is more of a twitch, and he steps back a little too quickly.","","*page_break","You advance with careful steps, eyes fixed on her long fingers, and test her with a few tentative jabs. Katie bobs and weaves past all of them, anticipating your punches before they're fully extended.","","\"Good punching form,\" she says, slipping yet another of your punches. \"You're using your muscle chains well!\"","","You advance more aggressively, landing a solid jab to Katie's right shoulder with a hefty thud. She absorbs the hit, not showing any reaction, the relaxed smile still on her face. But as you move in for another combination, Katie's posture tightens up. She slips inside your guard, her fingers pressing a point on your elbow as she applies leverage to your wrist with her other hand.","","A thunderbolt of silver, immobilising pain crashes through your arm. It radiates from the elbow, first down to the fingertips, then surging upward to the shoulder. You can't move, can't flex, can't do anything but experience the pulsing white-hot agony.","","\"AARGH!\" you scream. Agony rips through your elbow, the pain so intense that black spots appear on the edges of your vision.","*set fight_momentum -1","","*gosub_scene utils show_fight_momentum","","*choice","    #You fight to stay functional.","        *gosub_scene utils increase_composure","        No time for diagnosis. You brace and adapt. The fight continues until the ref stops it.","    #You assess the pain like a checklist.","        *gosub_scene utils increase_analysis","        Pain floods the joint, but the elbow still moves. No crack, no slackness. Not confirmation, but a clue.","    #You glance at Katie, searching for malice.","        *gosub_scene utils increase_empathy","        She's watching. Not triumphant. Just... interested. Like she's logging the results.","","\"Totally normal,\" Katie says, still pressing. \"Just your nerves sending the wrong signals to your brain. It only [i]feels[/i] like your elbow's bending backwards. It's not.\"","","She lets go. Like flipping a switch, the pain vanishes. The joint bends easily. Full mobility, like nothing happened.","","\"Back to normal! Neat, right?\"","","You flex your elbow, prod it with your other gloved hand. The crowd cheers.","","*choice","    #You steady your breath and reset.","        *gosub_scene utils increase_composure","        You don't look at your arm. Don't ask questions. Just breathe, reset, and raise your guard. The pain is gone. That's enough for now. You tighten your positioning and keep close track of where her hands are moving.","    #You watch her, not your arm.","        *gosub_scene utils increase_empathy","        She's still watching you. Not like a fighter. Like a scientist, waiting to see if the result matches the hypothesis. You flex your elbow. It's fine. Whatever happened just now, it seemed important to her.","","    #You ask her how it works.","        *gosub_scene utils increase_analysis","        *set katie_friendship +1","        \"What did you just do?\" you ask.","","        Delight sparkles in Katie's eyes. \"Nerve manipulation,\" she enthuses. \"I'm stimulating specific pathways that transmit pain signals to your brain. It all happens without any physical damage. I'm writing my dissertation on it!\"","","        The referee clears his throat loudly, and both of you snap back and focus on the fight again.","","A brief lull follows. You maintain distance with quick jabs, buying space while your brain recalibrates. The crowd grumbles impatiently. Katie waits, loose and curious.","","*gosub_scene utils show_fight_momentum","","*choice","    #Try your ${flurry} to overwhelm her defences.","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *set upgrade_bonus (upgrade_multiplier * flurry_level)","        *if (((adj_technique * 0.7) + (adj_power * 0.3)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.85) + (dc_hard * 0.15))","            You suddenly dash forward with your ${flurry}, a fast flurry of punches that catches Katie with her arms lowered. Several punches land before she can react, not dealing serious damage but knocking her off-balance. Katie focusses on careful defence as she retreats, clearly surprised by your aggression so soon after her pressure point technique.","","            \"Excellent tactics,\" Katie beams, even as she's on the defensive. \"Most fighters hesitate after experiencing a pressure point technique!\"","            *set fight_momentum +2","        *else","            You suddenly dash forward with your ${flurry}, a fast flurry of punches that you hope will overwhelm Katie's defences. Unfortunately, your attack is too slow, and she easily sidesteps. As you overextend and lose your positioning, her fingers find a nerve junction at your rib cage, applying a tender pressure that causes debilitating pain to radiate through your torso.","","            \"That's your intercostal nerve cluster,\" Katie explains as you struggle to catch a breath.","            *set fight_momentum -1","    #Maintain distance and probe with cautious jabs.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *set upgrade_bonus (upgrade_multiplier * jab_level)","        *if (((adj_technique * 0.3) + (adj_mental * 0.7)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.9) + (dc_easy * 0.1))","            You theorise that Katie needs to be at close range to use her pressure point techniques. Therefore, why not keep her outside of that range? You maintain distance with well-timed jabs that control space and shut down most of her approach angles, which forces Katie to overcommit to an attack. When she lunges forward, you tag her with a clean ${jab} that sends her retreating with a subdued \"Oof.\"","","            \"Very good distance management,\" Katie commends you. \"Your spacing shows fairly developed fight awareness!\"","","            The crowd leans in to see how Katie will adjust her approach.","            *set fight_momentum +1","        *else","            You theorise that Katie needs to be at close range to use her pressure point techniques. Therefore, why not keep her outside of that range? You try to maintain distance with jabs to control space and shut down Katie's approach angles. However, Katie comes in close, sidesteps twice, and then ducks forward to slip past your misdirected guard. Before you can recover, her fingers find a nerve cluster at your shoulder as her other hand presses on your bicep. You scream in pain as your shoulder feels like it's been hyper-extended.","","            \"This is just referred pain from your shoulder nerves,\" Katie explains as your eyes involuntarily shut from the pain. \"Your brain thinks your joint is moving wrong, but it's actually in a perfectly normal position!\"","            *set fight_momentum -1","    *selectable_if (counter_level > 0) #Wait for her approach and attempt a counter.","        *gosub_scene utils calculate_trait_bonus \"empathy\"","        *set upgrade_bonus (upgrade_multiplier * counter_level)","        *if (((adj_technique * 0.7) + (adj_mental * 0.3)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.9) + (dc_hard * 0.1))","            You patiently await Katie's advance, searching for the tells that signal her approach attempts. When she finally commits to an attack, your legs have already begun to move. You sidestep her approach and deliver a ${counter} that completely stops her forward momentum with a resonant thwack. The punch lands cleanly, while her fingers are nowhere near any pressure points.","","            \"Exceptional pattern recognition,\" Katie exclaims. \"Your timing suggests innate talent in noticing movement cues!\"","","            Light applause rises from the crowd as they see you getting the better of the exchange.","            *set fight_momentum +2","        *else","            You patiently await Katie's advance, looking for the tells that signal her approach attempts. She approaches casually, her hands moving in varied patterns. While you were focussed on reading her hand patterns, she circles to your left, closing the distance while you're still frozen in place. Katie's fingers find pressure points on your forearm while applying precise leverage to your wrist.","","            \"Fascinating response patterns,\" she notes as you flinch from the searing pain in your wrist. ","            *set fight_momentum -1","","*if fight_momentum <= 4","    You try to adapt to Katie's unusual fighting style, but she continues finding vulnerable pressure points with clinical precision. You manage to land the occasional punch, but your body reflexively flinches when you are near her, and your attacks don't land at full power. Katie remains talkative, a bright smile on her face as she encourages you.","","    \"Your nervous system is very resilient for a beginner,\" she observes, delighted. \"Most people are completely overwhelmed by now!\"","*elseif fight_momentum = 5","    You hold your own in the match, delivering brief but effective combinations even as Katie's finger strikes continue to land. The crowd watches with interest, some spectators standing up.","","    \"Fascinating adaptations,\" she comments after you successfully evade one of her techniques. \"Your neural pathways show high natural resistance!\"","*else","    You've managed to take the initiative in this unusual match, your jabs and basic combinations impeding Katie's attempts to achieve full pressure point contact. You're beginning to sense which areas she's targeting, a subtle warning sensation that aids your blocks. The crowd rumbles softly as you push Katie onto the defensive.","    ","    \"Extraordinary natural defences,\" Katie exclaims, her tone still friendly and buoyant. \"Your proprioception is remarkable!\"","","Katie takes a step back and flexes her fingers, the joints popping softly. Then she darts forward, aiming for pressure points at your left shoulder and neck, hands slicing in like she's tracing lines only she can see.","","*gosub_scene utils show_fight_momentum","","*choice","    #Prioritise protecting your neck, focusing on safety.","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *set upgrade_bonus (upgrade_multiplier * block_level)","        *if (((adj_toughness * 0.5) + (adj_mental * 0.5)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.7) + (dc_easy * 0.3))    ","            You hunch up, raising your guard fully and denying Katie access to exposed nerve areas. She advances with both hands striking, uncaring about defence, fingers outstretched. You feel the rush of air as she misses the nerve junction on your upper shoulder she was aiming for. Her fingers still find a pressure point on the outside of your shoulder, sending a jolt through your arm, but your guard holds, and she finds no further purchase.","            ","            \"Excellent protective instinct,\" Katie chirps.","            ","            You create some space, the pain already faded. Although you didn't land any blows, you neutralised her attack and prevented her from gaining any advantage. Katie nods and smiles brightly, though you're not sure what she's pleased about.","            *set fight_momentum +1","        *else","            You hunch up, raising your guard fully and denying Katie access to exposed nerve areas. She comes in with both hands striking, uncaring about defence, and her fingers slip easily past your gloves. One hand goes for a point on your upper shoulder that you deflect, but her other hand finds your ribcage.","","            Her warm fingers press firmly at the soft point at the bottom of your left ribcage, and it feels like your ribcage has been forcibly torn from your sternum. You scream silently, unable to breathe as your diaphragm spasms, arms immediately dropping to shield your vital organs. Her other hand holds you under your right armpit, immobilising your arms as your shoulders seize up. ","            ","            \"The intercostal nerve bundles are so fascinating,\" Katie remarks as you struggle with basic bodily functions. \"When I press here, your brain thinks your ribcage is collapsing, even though it's just a bit of pressure!\"","            ","            You manage to take a laboured breath through the pain and finally swat away her fingers with your other hand.","            *set fight_momentum -1","    #Sidestep and weave, attempting to create favourable angles.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *set upgrade_bonus (upgrade_multiplier * dodge_level)","        *if (((adj_toughness * 0.35) + (adj_technique * 0.65)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.9) + (dc_easy * 0.1))  ","            Biceps tensed, you read Katie's approach and slide to your right as she reaches for your shoulder. Her hands miss completely as you lean back and counter with a one-two combination. It doesn't land with full power, but it's enough to cause Katie to exhale sharply with an audible \"boof!\"","","            Katie's still facing the side and you capitalise by advancing with your ${flurry}, landing several solid blows before she rolls away. \"Excellent manoeuvring,\" Katie exclaims, her voice higher-pitched than normal.","","            You smile and nod, as you're gradually finding effective strategies against her unusual techniques.","            *set fight_momentum +2","        *else","            You attempt to slide to your right as Katie reaches for your shoulder. Her right hand misses completely, finding only air. But her left hand is already changing trajectory, arriving in a wide arc to land on the nerve bundle at the top of your left shoulder.","","            Her fingers press down with force like a concert pianist. Electric pain explodes throughout your left arm, shoulder, neck, and the left side of your head, accompanied by a high-pitched ringing in your left ear. You involuntarily shut your left eye as your mouth distorts into a pained grimace, your body seizing up around your shoulder as if it was lanced by a red-hot needle.","            ","            \"It feels like your entire upper body is being torn apart because there are multiple nerve pathways,\" Katie explains. ","            ","            The pain lasts for a brief moment as Katie doesn't have the leverage to maintain the hold. When she releases the pressure point, the pain vanishes completely, and suddenly the position is reset, neither of you having the advantage.","            *set fight_momentum -1","    #Intercept her with a power punch as she moves in.","        *gosub_scene utils calculate_trait_bonus \"empathy\"","        *set upgrade_bonus (upgrade_multiplier * counter_level)","        *if (((adj_power * 0.8) + (adj_technique * 0.2)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.8) + (dc_hard * 0.2))","            You cock your left arm and watch Katie's approach intently, waiting for the split second before she explodes forward. The crowd is silent, no one daring to move.","","            As Katie lunges forward, fingers extended towards your neck and shoulder, your left fist pistons forward, striking her chest like a sunlit hammer. The blow hurls her back, any thought of reaching pressure points forgotten, her mouth wide open as all the air whooshes from her lungs.","            ","            Katie wobbles, temporarily unable to breathe, hands limp by her sides. You land a cross to her face, sending her to the floor. She manages to rise by the count of 5, fighting stance regained, although her eyes track you more slowly now.","","            \"S... superb risk taking and technical execution,\" she gasps. \"Courage and judgement too!\"","","            The crowd applauds politely, several of them complimenting the brilliant tactical exchange.","            *set fight_momentum +3","        *elseif (((adj_power * 0.8) + (adj_technique * 0.2)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.8) + (dc_easy * 0.1))","            You cock your left arm and watch Katie's approach intently, waiting for the split second before she explodes forward. The crowd is silent, adding to the tension.","","            As Katie lunges forward, fingers extended towards your neck and shoulder, your left fist pistons forward, aiming to hammer her backwards. Unfortunately, accurately hitting a fast-moving target with full power is beyond your current skill. Your punch grazes her shoulder, slightly rotating her body, and you feel a fleeting pressure as her fingers briefly press the veins on your neck before they slip.","","            A brief wave of icy pain courses from your neck to your skull, but the dizziness lasts for no more than a moment before it disappears. You immediately find your bearings, but Katie has also recovered. She takes three steps back, rolling her shoulder and finding it uninjured.","        *else","            You cock your left arm and watch Katie's approach intently, waiting for the split second before she explodes forward. The crowd is silent, adding to the tension.","","            As Katie lunges forward, fingers extended towards your neck and shoulder, your left fist pistons forward, aiming to hammer her backwards. Unfortunately, accurately hitting a fast-moving target with full power is beyond your current skill. Your punch is way too slow, not even halfway there before you feel the touch of her fingers on your neck and upper shoulder.","","            Your throat feels like it's being crushed in a vice. Your collarbone seems to detach. \"AAAAAAAAH!\" you scream, tears streaming down your face as your body refuses to move.","            ","            \"Receiving pain signals from different areas overwhelms your brain,\" Katie explains with a smile, \"and it gets registered as catastrophic damage!\"","            ","            She maintains the hold for several more seconds, until your scream fades into a wordless exhale.","","            \"The human body is so amazing. Let's try another pressure point!\"","","            Katie's fingers stab into your diaphragm. Spots appear in your vision, your face red, lungs refusing to cooperate. Your knees buckle. The referee runs in to start the count, but your body recovers quickly once you get your breath back, and you stand up steadily.","            *set fight_momentum -3","","*page_break","*if fight_momentum <= 0","    *goto fight_momentum_zero","The fight continues, a whirlwind of punches, holds, and Katie's cheerful commentary. Time blurs into a series of sharp pains and dull impacts.","","Between rounds, Katie stretches her fingers like a pianist. You sit, your T-shirt soaked with sweat, watching her bounce in place. She glances over with the same bright smile.","","Your muscles start to ache. But Katie's movements seem more familiar now. There's always a tell when she moves in for an attack: a quick hip twist, fingers spread out and flexing, or a weight shift. Her pace hasn't slackened, compliments and observations never stopping.","","*if fight_momentum > 6","    Your guard's intact and you have enough in the tank. Every time Katie tries to find a pressure point, you block it or twist clear. Then when she over-commits, you punish with a ${jab} or a quick combination.","","    You counter another deflected strike with a fast hook. Undaunted, she compliments you. \"Remarkable instincts and spatial judgement!\"","","    Her left hand drops. An opening.","","*elseif fight_momentum > 4","    You manage to prevent Katie from landing any significant attacks. But no matter what you try, she evades or parries everything. Combinations, jabs, flurries, nothing lands. Occasional cheers and shouts of encouragement rise from the crowd.","","    \"Impressive instincts and spatial judgement!\" Katie says, after you avoid a fast strike aimed at your ribs.","","    She doesn't show any sign of tiring, her hands high and her footwork still light. But just now, after she blocked your cross. She's leaning too far back. An opening.","","*else","    Katie circles you relentlessly. She peppers your guard with fast strikes, pinpricks of pain that numb your arms. You try to reset, but you can't cover all the angles. Each adjustment opens up a new nerve point. You're barely landing anything.","","    She lets out a short breath and her arms drop slightly as she studies your guard. An opening. You lunge forward.","","*gosub_scene utils show_fight_momentum","","*choice","    #Launch a ${flurry} to overwhelm her defences.","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *set upgrade_bonus (upgrade_multiplier * flurry_level)","        *if (((adj_power * 0.5) + (adj_technique * 0.5)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.8) + (dc_hard * 0.2))","            You spring forward, unleashing a rapid flurry of distance-closing punches. You focus on punch quantity, directing them vaguely at Katie's upper body, trusting that quality will take care of itself.","","            Katie ducks under your first punch, then sidesteps the second. She jerks her head away from your hook. She opens her mouth to speak but only an exhale escapes as she twists away from another jab. Her hands fly up, but only to shield her face. Her feet shuffle backwards. With each punch, her smile tightens.","","            A clean hit to her ribcage is immediately followed by glancing blows to her head and chest. She retreats in shambles. The crowd erupts in applause, although you tire quickly and can't fully convert your advantage.","            *set fight_momentum +3","        *else","            You spring forward, unleashing a rapid flurry of distance-closing punches. You focus on punch quantity, directing them vaguely at Katie's upper body, trusting that quality will take care of itself.","","            Katie's eyes widen at your tactic. She's unable to find any pressure points through your constant movement and barrage of punches. Even her running commentary falters as she struggles to mount an effective response.","","            But you quickly begin to tire. Your punches become slower, weaker. Katie immediately closes the distance, footwork still as agile as ever, and her fingers find the nerve cluster under your right armpit. Pain shoots down your right side as she presses firmly, temporarily paralysing your right arm.","            *set fight_momentum -1","    #Attempt your ${combo} \u2014 the jab-cross-hook combination you've been drilling.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *set upgrade_bonus (upgrade_multiplier * combo_level)","        *if (((adj_mental * 0.4) + (adj_technique * 0.6)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.9) + (dc_easy * 0.1))","            You recall your coach's advice: stick to what you've practised. You launch into your ${combo}. The jab sticks Katie in place. The cross forces her to block. The hook connects with the side of her head, the pressure on your fist muffled.","","            Katie staggers from the impact of the hook, her eyes unfocussed. The crowd erupts in applause, some now clapping with inflatable plastic tubes. Katie has instinctively retreated and crouched low, complicating your efforts to capitalise.","            *set fight_momentum +2","        *else","            You recall your coach's advice: stick to what you've practised. You launch into your ${combo}. The jab sticks Katie in place. The cross forces her to block. The hook hits her hasty guard, the pressure on your fist muffled.","","            Katie converts the forward momentum from your punches into an unnaturally fast crouch. She absorbs the energy into her legs and immediately stabs for a nerve cluster at your inner thigh. A jolt of frozen pain radiates from your thigh and your leg buckles involuntarily.","","            \"Boxing relies on footwork to generate power,\" Katie exclaims. \"Disrupting the nerve signals means that your foundation can't support any offence!\"","            *set fight_momentum -1","","    #Throw caution to the wind with a massive uppercut.","        *gosub_scene utils calculate_trait_bonus \"empathy\"","        *if (((adj_power * 0.9) + (adj_technique * 0.1)) + trait_bonus_applied) >= ((dc_medium * 0.3) + (dc_hard * 0.7))","            You crouch slightly, preparing for a full-body uppercut. Katie sees your crouch and misreads it as a defensive adaptation, moving forward with elbows cocked for a fast strike. As she comes close, you rocket your entire body up in a massive punch.","","            The uppercut catches Katie cleanly under her chin. Her head snaps back. Her body briefly leaves the ground, a long curved line like a hunted rabbit. The crowd roars, Katie's feet wobbling before collapsing completely, out cold for the ten count.","","            Ringside medics immediately rush to Katie, checking her vitals. She regains consciousness and takes a few moments to sit, dazed but content.","            *set match_result 2","            *goto match_conclusion","        *if (((adj_power * 0.9) + (adj_technique * 0.1)) + trait_bonus_applied) >= ((dc_medium * 0.9) + (dc_hard * 0.1))    ","            You crouch slightly, preparing for a full-body uppercut. Katie sees your crouch and moves forward with elbows by her side, ready for a counterstrike. As she nears, you rocket up in a massive punch.","","            Katie sees your body tense just in time to partially turn her head. Your uppercut grazes the side of her face instead of catching her cleanly on the chin. It's enough to stun her. You have enough time to reset your positioning, and keep her counter attempt away with a quick ${jab}.","        *else","            You crouch slightly and lock your knees, preparing for a full-body uppercut. Katie sees your crouch and moves forward with elbows by her side, ready for a counterstrike. As she nears, you rocket up in a massive punch.","","            Katie sidesteps the uppercut casually. She presses a node of nerves near your exposed armpit. Your arm feels as if it's dislocated at the shoulder.","            *set fight_momentum -2","*if fight_momentum <= 0","    *goto fight_momentum_zero","","*page_break","You recover your footing. Katie doesn't advance. Instead, she steps back slowly, blinking hard. Around you, the crowd sits up straight, like they're bracing for a storm.","","Katie's pupils dilate. She begins a bizarre wave-like [i]kata[/i], arms flapping in wide jumping-jack arcs, knees pumping high in Jazzercise bursts.","","\"Okay, pulling out the [i]big[/i] one now! [i]Total Sensory Override[/i]. Brace yourself!\" she announces.","","The crowd falls silent.","","Katie keeps shifting side to side, wrists rotating, fingers flexing. Her breath deepens into a slow, meditative rhythm. Then she suddenly starts hyperventilating. All the time, her face is plastered with a cheerful grin. Droplets of sweat appear on her forehead.","","\"Let's go!\" she smiles, charging forward, hands raised like forked lightning.","","Around you, everything vanishes into a blur. Your ears ring. There's no referee, no crowd, no warehouse. Just her hands, and whatever storm she's about to bring down.","","A final check: hips low, guard high, weight even. Every muscle ready. You didn't choose this. Your body did.","","*gosub_scene utils show_fight_momentum","","*choice","    #Defend and weather the storm.","        You plant your feet firmly, raising your guard to protect your vital areas. Katie lurches towards you like an assassin that's had one too many drinks. The crowd's collective intake of breath tells you all you need to know about what's coming.","","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *set upgrade_bonus (upgrade_multiplier * block_level)","        *if (((adj_mental * 0.5) + (adj_toughness * 0.5)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.8) + (dc_easy * 0.2))","            Katie's fingers dart towards you at oblique angles, but your complete focus on defence pays dividends. You tuck your chin fully. Your arms tighten in a very compact guard. You hunch your back to reduce your profile. Katie can't find any exposed nerves, her fingers hovering and darting ineffectually, bees unable to sting through a bear's thick skin.","","            \"Excellent decision!\" she says brightly. \"Most fighters don't prioritise nerve shielding. Too much ego.\"","","            You feel her fingers brush against you repeatedly, each near-miss raising the hairs on your skin. Her probes abruptly stop as she lets out a long breath, her pupils contracting to their normal size. The crowd exhales, the [i]Total Sensory Override[/i] defused, the oppressive tension lifted from the room.","        *else","            You tuck your chin fully. Your arms tighten in a very compact guard. You hunch your back to reduce your profile. But it's not enough. Katie is too fast, striking like lightning from all directions, your turtle defence allowing her to focus entirely on offence.","","            *goto total_sensory_override","    #Time a desperate counter-attack.","        Your attention locks onto Katie's movement patterns. You wait for the split-second commitment: your one chance. You feel the slight tension in her shoulders, the minute adjustment of her fingers, the shift in her breathing pattern. ","","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *if (((adj_mental * 0.6) + (adj_technique * 0.4)) + trait_bonus_applied) >= ((dc_medium * 0.5) + (dc_hard * 0.5))","            Katie shifts her weight, a tell in her right heel. There. The base of your neck. Her hands lunge for the nerve cluster.","","            You launch forward, colliding with her like a desperate battering ram. Your uppercut connects with Katie's chin with a thud that vibrates through your arm. Her head snaps back, eyes unfocussed, as she crumples to the floor, out cold.","            ","            The crowd erupts as the referee reaches ten. Katie comes to, blinking rapidly, her hands patting the canvas. She tilts her head, gazing at a spot on the floor, her mouth slowly opening and closing twice. After a few seconds, she brightens and stands up slowly.","","            \"Wow! That was an AMAZING uppercut! I didn't see it coming at all!\"","","            *set match_result 2","            *page_break","            *goto match_conclusion","        *elseif (((adj_mental * 0.6) + (adj_technique * 0.4)) + trait_bonus_applied) >= (dc_medium)","            You shift your weight to your back foot and take a sharp breath as Katie charges. Then you drive forward, your jab aimed at her chest. But she twists impossibly fast. You graze her shoulder, disrupting her technique but not stopping it completely. Her fingers land on your extended arm, sparking a burst of electric pain.","            ","            \"Excellent counter-timing!\"","            ","            You weave to the side. Katie's calmed down, her breathing back to normal. You managed to survive.","            *set fight_momentum -1","        *else","            You lunge forward with a body jab just as Katie starts her charge. It's a critical miscalculation. You miss completely as Katie twists to one side.","","            *goto total_sensory_override","    #Dodge and create distance.","        Clashing head-on with her technique seems foolhardy, so you choose evasion. Your legs tense as she charges forwards. Everything goes silent. All that reaches you is the squeak of shoes on the canvas.","        ","        *gosub_scene utils calculate_trait_bonus \"empathy\"","        *set upgrade_bonus (upgrade_multiplier * dodge_level)","        *if (((adj_mental * 0.5) + (adj_toughness * 0.5)) + (trait_bonus_applied + upgrade_bonus)) >= (dc_medium)","            The split second when she extends her arms, you leap backwards. Katie misses completely, and her momentum carries her forward. She stumbles slightly and quickly recovers your balance, but you don't advance. You stay out of her reach.","","            Her breathing returns to normal, and her movements slow. You spot the opening and capitalise with a ${flurry}, landing several clean hits that rock her head back.","            *set fight_momentum +2","        *else","            You attempt to create distance, but Katie adjusts her angle as she advances. She reaches you before you can reset, her fingers already extending.","            ","            *goto total_sensory_override","*page_break","","*if fight_momentum >= 5","    The referee's whistle cuts through the air, sharp and final. Three rounds, supposedly. It felt like one long blur. You lower your guard cautiously. Katie straightens her posture, rolling her shoulders with a satisfied smile.","","    \"So fun!\" Katie exclaims. \"You compensated for nerve interference while maintaining strategic control. That's [i]really[/i] rare!\"","","    The judges tally their scores quickly. You and Katie step to the centre as the referee raises his hand.","","    \"Winner by unanimous decision: ${first_name} ${last_name}!\"","    *set match_result 2","*else","    The referee's whistle cuts through the air, sharp and final. Three rounds, supposedly. It felt like one long blur. You lower your guard cautiously. Katie straightens her posture, letting out a contented sigh.","","    \"So fun!\" Katie exclaims. \"You compensated for nerve interference while maintaining strategic control. That's [i]really[/i] rare!\"","","    The judges tally their scores quickly. You and Katie step to the centre as the referee raises his hand.","","    \"Winner by unanimous decision: Katie Reynolds!\"","    *set match_result 1","*page_break","*goto match_conclusion","*return","","*label total_sensory_override","Katie methodically strikes points all over your body. Blood pounds your ears. Your jaw seizes open. Your ribs separate. Your joints surrender one by one, torn apart by invisible hands.  Every nerve ignites. Your muscles lock up. You can't tell where one agony ends and another begins. Your eyes stay open, but all you see is crimson.","","\"The Total Sensory Override creates a complete neural hijacking!\" You think Katie says something like that. It's hard to tell over the screams coming from somewhere nearby.","","You try to raise your guard. Your arms refuse. Your knees buckle. You collapse, palms smacking the canvas.","","\"Your brain is receiving signals from every major nerve centre simultaneously! The central nervous system doesn't know what to do, so it just tries anything at all,\" Katie continues. She stands over your twitching body, eyes bright, jotting down notes on the scratchpad she's conjured from somewhere.","","Through the symphony of pain, the referee's count hits you like a tiny headache. \"...seven...eight...\"","","Your arms scream as your force yourself to your knees. Katie leans forward, head tilted slightly like a parrot, as she observes you and scribbles something in her scratchpad. Her eyes stay fixed on you, taking in every micro-reaction like a scientist running a revolutionary experiment.","","\"...nine...ten!\" The referee waves his arms. \"Winner by knockout: Katie Reynolds!\"","","You straighten slowly as the pain recedes. You rotate your wrist, bend your elbow, roll your shoulder. All functioning normally again.","","*page_break","*set match_result 1","*goto match_conclusion","*return","","*label fight_momentum_zero","The cascade of pain doesn't let up, and you drop your guard. Just for a second, but it's enough.","","Katie darts in. Fingers press the nerve along your right arm. Fire shoots from elbow to wrist. Your arm gives up, drops completely.","","Katie holds the back of your neck with her left hand, warm to the touch, and presses on a point near the vertebra. No pain. But your knees buckle. You lurch sideways. The floor rises to meet you.","","\"Wait, it's okay!\" Katie calls, staying away. You think she looks concerned, but your vision is spinning too much to be sure. \"You just need to re-sync. Breathe!\"","","Your breathing is fine. You just don't control anything in your body.","","\"Five... six... seven...\"","","Left is right. Up is sideways. You try to get up, but you just flail in the air.","","\"Nine... ten!\"","*page_break","*set match_result 1","*goto match_conclusion","*return","","*label match_conclusion","*if match_result = 1","    Your face is wet from tears you don't remember shedding. Your hearing returns, and you take in the cheering and applause. You check: feet, knees, hips, shoulders, neck. Eyesight. Hearing. All normal. You notice a faint metallic taste from a small tear in your mouth.","","    Katie scans you with her eyes, from your legs to your hands to your face. Then away.","","    \"That... might have been too much,\" she stammers. \"I was too \u2014\"","","    She exhales sharply. \"No, I shouldn't make excuses. I got carried away. Forget the data. Are you okay?\"","","    She stares at the floor, presses a foil packet into your glove.","","    \"Chew, don't swallow,\" she adds, managing a half-smile. \"It'll help flush the residual spikes. Works best if you hydrate soon, too.\"","","    She lingers, biting her lip, eyes staring at you slightly too long before she looks away.","","    \"You know...\" she starts, then trails off. She brushes her ponytail, wipes a hand over her headband. \"I can show you how to build resistance. How to process pain. The university lab's quiet on weekends.\" Slips you a name card.","","    She's walking towards the officials, but she glances back one last time.","","    \"Text me if your visions goes blurry or your limbs spasm,\" she calls out. \"Although that usually fades in, like, twelve hours tops.\"","","    Then she's gone, all ponytail and kinetic energy.","    *set record_losses +1","*elseif match_result = 2","    Katie straightens unsteadily. A bruise is forming along her jaw, but she has a huge grin on her face, eyes crinkling. She's swaying happily, like a sunflower.","","    \"Wow!\" she exclaims, \"You're an amazing fighter! You instinctively knew what to do. And your proprioceptive awareness is extraordinary!\"","","    She bounds over to her gym bag and pulls out a flyer, half-crumpling it in her enthusiasm. \"Okay, listen. This might sound weird, but I [i]need[/i] you to come to my lab. I'm running a research study on neural adaptation and your resilience is [i]off the charts[/i].\"","","    She takes a deep breath and then rushes out more words. \"I made some notes during our fight, but if you came in, then... look, just trust me, you'll love it.\"","","    Katie's practically vibrating, bouncing on her toes, fidgeting with her headband. She presses the flyer into your hand. \"PAIN: IT'S ALL IN THE MIND\" in Comic Sans, anatomical sketches, tiny footnotes, and a glittering unicorn sticker in the corner.","","    \"No obligation. Except, you know, you would really benefit too, because I can help you increase your pain thresholds. My thesis is on this stuff!\"","","    She suddenly cuts herself off. Looks down at the floor, biting her lip. \"Sorry for oversharing. I keep doing that.\"","","    Noticing that you haven't moved yet, she slowly raises her eyes. \"You're... still here. Still listening to me.\"","","    She smiles for a second, then it fades. \"Thanks for not walking away.\"","","    A bright grin forces itself back on her face. \"Anyway! See you soon! Bring snacks if you can. The lab vending machine only has bottled water.\"","","    Then she's gone, all ponytail and kinetic energy.","    *set record_wins +1","*else","    *bug Unknown match result","*return"], "labels":{"fight":0,"total_sensory_override":425,"fight_momentum_zero":447,"match_conclusion":468}},
"katie_subplot": {"crc":1228240622, "lines":["*label scene_introduction","*if katie_subplot_scene = 1","    Katie didn't fight with raw power or speed; she applied precise techniques to create debilitating pain. She's invited you to her lab with the promise of helping you control your subjective experience of pain. Her systematic understanding of the nervous system could be useful during fights, although you're unsure what form her instruction will take. You palm your elbow, remembering the control she demonstrated.","    *if (katie_almost_lapsed)","","        If you don't respond to her invitation soon, she will likely assume you're not interested.","*elseif katie_subplot_scene = 2","    Katie mentioned she would teach you a set of exercises designed to stop your nervous system from \"overreacting.\" This time she's bringing tools that she crafted herself. She didn't elaborate. Nobody else is doing what she's doing, she said, which doesn't surprise you. More surprising is the way your body seems eager to continue.","    *if (katie_almost_lapsed)","","        Katie can't wait forever. If you don't meet her now, she'll keep on experimenting without you.","*elseif katie_subplot_scene = 3","    \"I want to practise being around normal people. Can you help me?\" she writes. Katie's message \u2014 unfiltered, almost plaintive \u2014 matches what you've seen during your sessions together. It might be an unstructured chat, or a meticulously planned interaction. She didn't offer to teach you anything. That means something.","    *if (katie_almost_lapsed)","","        Given what you know of Katie, waiting weeks before responding would feel like rejection to her.","*elseif katie_subplot_scene = 4","    *if katie_plot_timer = 0","        Katie's last message: the university is pushing back on her research. She's facing yet another review, and she's worried they will keep her in limbo indefinitely. The pressure has built to a point where the cracks are showing. You're not sure how it resolves.","        *if (katie_almost_lapsed)","","            You have a busy schedule, but Katie sounds like she's under serious pressure. Much longer and she will assume she's on her own.","    *else","        Katie hasn't replied to your messages. The last one she sent was a voice message at 2:56 AM. Lab noise, rustling, a stack of books toppling. Then her whisper: \"Some issues with my research. University committee... questions about ethics. Will explain later. Don't come by.\"","        *if highest_trait = \"analysis\"","            You check the audio metadata. Sent from her campus lab Wi-Fi, no edits. She didn't rehearse this one.","        *elseif highest_trait = \"empathy\"","            You replay the memo. A tension, even panic, is creeping in at the edges. She's clinging to her systems, even as they fail.","        *elseif highest_trait = \"composure\"","            You don't follow up again. If she needs help, she'll ask.","        *else","            *bug Invalid highest_trait","*elseif katie_subplot_scene = 5","    *if katie_plot_timer = 0","        Katie's finished modifying her thesis. She wants to do a practice defence with her supervisor, another professor from the kinesiology department, and you. You'd be the demonstration subject.","        *if (katie_almost_lapsed)","","            Katie's thesis defence is time sensitive. If you don't make time for it, she'll handle it alone, and that will be the end of your involvement.","    *else","        Katie's in a frenzy, rewriting entire sections, replacing figures, revising arguments. She messages you occasionally to bounce ideas, but she's too absorbed in her work to meet. She won't be free until she's finished.","*elseif katie_subplot_scene = 6","    *if katie_plot_timer = 0","        Katie asked if you were free to meet her after her thesis defence. You won't be allowed to attend in person, but meeting her afterwards makes sense.","        *if (katie_almost_lapsed)","","            Katie wants to share this moment with you. If you leave her hanging, she'll take it as a no.","    *else","        Katie said she needed a few weeks to refine her thesis defence. She promised to meet you once it's over. The rest is in her hands now.","*elseif katie_subplot_scene = 7","    With Katie's thesis defence now over, she asked you to celebrate with her. Privately. It sounds like she has something special planned.","    *if (katie_almost_lapsed)","","            TODO: KATIE_ALMOST_LAPSED WARNING TEXT SCENE 7","*else","    *bug Katie subplot scene not found","*return","","*comment katie_friendship from katie_fight: 0-1","*label scene_choice","*if katie_subplot_scene = 1","    *comment earliest: chapter 3, first fortnight","    *comment katie_friendship from this chapter: 2-3 for accept, 0-1 for reject","    *comment cumulative katie_friendship after this chapter: 3-4","    *gosub event_1","    *set stat_mental %+2","    *set unlocked_katie_training True","*elseif katie_subplot_scene = 2","    *comment earliest: chapter 3, second fortnight","    *comment katie_friendship from this chapter: 1-2","    *comment cumulative katie_friendship after this chapter: 4-6","    *gosub event_2","    *set boxing_insights_unspent +1","*elseif katie_subplot_scene = 3","    *comment earliest: chapter 4, first fortnight","    *comment katie_friendship from this chapter: 1-4","    *comment cumulative katie_friendship after this chapter: 5-10","    *gosub event_3","    *set stat_mental %+4","    *set stat_energy +5","    *gosub_scene utils clamp_energy","    *set katie_plot_timer 2","*elseif katie_subplot_scene = 4","    *comment earliest: chapter 5, first fortnight","    *comment katie_friendship from this chapter: 1-3","    *comment cumulative katie_friendship after this chapter: 6-13","    *comment katie_romance from this chapter: 0-1","    *comment cumulative katie_romance after this chapter: 0-1","    *gosub event_4","    *set stat_mental %+5","    *set katie_plot_timer 2","*elseif katie_subplot_scene = 5","    *comment earliest: chapter 6, first fortnight","    *comment katie_friendship from afterhours: 2-6","    *comment katie_friendship from this chapter: []","    *comment cumulative katie_friendship after this chapter: []","    *comment katie_romance from afterhours: 0-2","    *comment katie_romance from this chapter: []","    *comment cumulative katie_romance after this chapter: []","","    *gosub event_5","*elseif katie_subplot_scene = 6","    *gosub event_7","    *set katie_subplot_status \"finished\"","*else","    *bug Katie subplot scene not found","*return","","*label event_1","The kinesiology wing is mostly dark, smelling faintly of disinfectant. There's a sharp wedge of light spilling from the gap under the door at the end of the corridor. You proceed quietly, not wanting to disturb the silence. A brushed metal nameplate next to the door announces:","","LAB 3B-19","*line_break","\u61c9\u7528\u808c\u52d5\u5b78","*line_break","Applied Kinesiology","","You flex your elbow. No pain. You try your wrists, shoulders, waist, knees, ankles, cataloguing the responses. All fine. No memory in the joints; just in the nerves.","","You knock.","","From inside, the sound of a falling stack of paper, then a voice. \"You're early! Or on time! Hold on!\"","","The door swings inward, a little too fast. A small vacuum tugs at your shirt, pulling you into bright light. ","","*page_break","Anatomy charts. Plastic joint models. Nerve diagrams. A skeleton in the corner wearing a party hat and a laminated name tag: SKELETOR - TEACHING ASSISTANT. A desk piled high with papers and folders.","","Skeletor grins at you. So does Katie.","","She's wearing bright teal leggings and a T-shirt that says \"PAIN: IT'S ALL IN THE MIND.\" Near the hem, a tiny print-on-demand logo. She heaves a duffel bag onto the lab table. It lands with a thud and several quiet clacks. Doesn't sound like any gym gear you know of.","","\"Hi! You came!\" she beams. \"Usually people never show up.\"","","*choice","    #You nod. Better to see the full picture before deciding how to handle this.","        *gosub_scene utils increase_composure","        She greeted you lightly, but then followed with a weighty admission. You nod briefly. See how things develop first, before committing to a position.","    #You think that didn't sound like someone making a joke.","        *gosub_scene utils increase_empathy","        The words take the form of a joke, but there's no lightness in her voice, no smile in her eyes. Just something to float into the air.","","        You nod, just once. More is unnecessary.","    #Consider the subtext in the words.","        *gosub_scene utils increase_analysis","        She says it too fast, like a rehearsed line. Bright voice, nothing in her eyes.","","        You nod. More data needed.","","Katie registers your slight nod. Swallows. One hand tugs at her ponytail, fingers circling the elastic again and again.","","\"Okay. You're steady. That's good.\" She claps once, the smack loud in the heavy air of the lab. \"Let's get to it then.\"","","She points to a padded exam table at waist height in the centre of the room. The pleather upholstery is cracked in places, mended with a patchwork of clear, duck, and metallic tape. \"Lie down here,\" she says. Katie rummages through her duffel bag and extracts a short wooden rod that looks like a dowel or pestle.","","\"We'll establish your baseline response to stimulus before we start the real work,\" she says, then adds with bright formality, \"${first_name} ${last_name}.\"","","\"Most people think all nerves respond the same way. But that's too simplified.\" Her smile returns. \"Your body already knows this. Your brain just hasn't realised it yet.\" She gestures you towards the exam table.","","*if highest_trait = \"analysis\"","    \"So the response is different for everyone. Individualised mapping.\"","","    \"Exactly. Every signal is a unique conversation.\" She smiles at you, lines below her eyes creasing.","","*elseif highest_trait = \"composure\"","    \"All right. Just tell me where you want the arm.\"","","    \"You make a good subject,\" she says, quieter now. \"Steady and controlled. That helps more than most people realise.\"","","*elseif highest_trait = \"empathy\"","    \"That sounds rehearsed.\"","","    Her shoulders sag as she lets out a soft sigh. Then she shrugs. \"Yeah.\" A pause. \"Most people pretend they don't realise it.\"","","    She doesn't elaborate. You don't push.","","*else","    *bug Invalid trait","","You slide onto the table, sinking into the creased leather. Katie holds the wooden dowel in her hand like a baton. It's hand-carved, with dark notches and chipped edges, and one end is pointed. She smiles at you, her intensity softening, now almost tender.","","\"Okay,\" she says gently, almost to herself. \"Just above the elbow, first.\"","","You don't feel it right away. Then the nerve fires. A clean, precise pain. Some part of you watches your hand twitch. It doesn't feel connected.","","*choice","    #You stay still. Let it pass.","        *gosub_scene utils increase_composure","        The pain crests, then vanishes. No lingering, no echo. You don't even need to breathe deep. Nothing needs adjusting.","    #You focus on her technique instead of the pain.","        *gosub_scene utils increase_analysis","        She wasn't jabbing your elbow randomly. Her eyes tracked the joint line, first your wrist, then your elbow. The notches on the rod are for calibration.","    #You track her face instead of the pain.","        *gosub_scene utils increase_empathy","        The pain cuts clean and then fades. You keep your arm steady and watch her.","","        Her smile holds, but there's no crease around her eyes. You don't say anything. You're not the one who needs the check-in.","","Your hand relaxes again. Perfectly functional. Katie rotates your wrist gently, presses a spot below the elbow, and nods to herself.","","\"Okay, here is where it gets interesting,\" she says. \"You can change how you receive pain signals. Right now, when they activate, your nerves send a flood of pain signals to your brain, and their arrival overrides everything else. That's why you freeze up and scream.\" ","","She talks faster. \"This time when I press, don't think about the pain. Look into my eyes. It creates an alternative focus for your brain, providing a large amount of neural distraction. Most of the time.\"","","Katie takes a deep breath, sucking in air through her teeth. \"Okay, okay. Eye contact, then pressure. Keep the gaze.\" Then she makes eye contact with you, pupils dilated. When she has your gaze, she presses the dowel into the spot below your elbow again.","","A dull throb, still present, but not insistent.","","The wooden rod withdraws. The pain fades. Katie looks away, scanning your elbow, the veins on your neck, your autonomic responses.","","*if highest_trait = \"analysis\"","    You process her words. Pain as a signal, not as a fact. It makes sense, even though it's counter-intuitive. To do later: apply this to other assumptions.","*elseif highest_trait = \"composure\"","    You replay the two nerve patterns. Identical. But only one felt like a threat.","*elseif highest_trait = \"empathy\"","    You felt her intense concentration, how she steadied herself before proceeding. She [i]needs[/i] to do this right.","*else","    *bug Invalid trait","","\"Good attenuation.\" She hands you the rod, pointing at her own elbow. \"With practice, you can redirect a lot of your attention. Here, press like I did and watch my reaction.\" She looks at you for a second, then closes her eyes.","","*choice","    #You match her technique exactly. Watch for response patterns.","        *gosub_scene utils increase_analysis","        You press at the crook of her elbow, mirroring her earlier grip and angle. Her skin is warm. The resistance is subtle, the nerves seeming to yield and compress before the rod's pressure point.","","        Her body shifts slightly. No tension. Just a soft exhale through her nose. The tiniest dilation of her pupils. Then her relaxed smile returns.","","        You mentally log her responses. No vocalisation. No reflexive withdrawal. Only barely detectable autonomic hints that she felt anything at all.","    #You study her face as much as her response.","        *gosub_scene utils increase_empathy","        You press gently into the crook of her elbow, minding the pressure and pace. Her skin is warm, but you don't track her muscles or nerves. Instead, you watch how she flows with the sensation. How she stays with it, accepts it.","","        When she exhales, she does so quietly, evenly. Trust, maybe. Or habit.","","    #You follow her instructions with care.","        *gosub_scene utils increase_composure","        You press at the crook of her elbow, just like she showed you. No sudden motion. Just clean, steady pressure.","","        Katie exhales through her nose. No tension. Her pupils dilate slightly, like she's forgetting something she just saw. Her shoulders stay level. A modest smile reappears.","","        \"Good pacing,\" she says softly. \"Most people rush.\"","","        You nod. You see it now. Pain received, not resisted.","","After a few more exercises, Katie's animated chatter returns. \"Okay, that's a good baseline! Your proprioceptive feedback is surprisingly consistent. I think that's all for today, let me just make sure I didn't forget anything.\"","","She scoots over to the desk and rifles through the untidy stack of papers. As she's shuffling papers like a jittery mail sorter, you notice a manuscript float to the top, thicker than the others. \"REJECTED\" is stamped on the front, obscuring the title. Katie sees it too, and snatches it, sliding it to the bottom of the paper pile. She glances back, notices you watching, and her shoulders sag. But she doesn't say anything.","","*choice","    #You step back so she doesn't have to explain.","        *gosub_scene utils increase_empathy","        *set katie_friendship +1","        She's not ready to open up. You tidy up the wooden dowels, arranging them into a loose xylophone shape.","    #You stay quiet. Not the right moment to press.","        *gosub_scene utils increase_composure","        *set katie_friendship +1","        You want to say something, but you hold your tongue. Pushing now would drive her away. So you let her recover at her own pace.","    #You think about what it means.","        *gosub_scene utils increase_analysis","        She shoved the paper into the pile like it was an unwanted flashback. Not upset or angry, primarily. Embarrassment?","","        You make a mental note. No intervention needed at the moment.","","Suddenly, her smile reappears, too fast and too wide. \"Okay! First session complete!\" she chirps, wrenching the cap on a jar of green ointment tight. \"I'll email you some exercises you can do in the meantime.\"","","She hands you a squeeze ball with metal studs embedded in its surface like tiny teeth. \"For homework. Press it until it stings. Try not to flinch.\" Her smile is back, wide and bright, but her hand keeps squeezing the handle of her duffel bag. Tight, loose, tight again. The plastic handle creaks.","","You nod. ","","\"Thanks for showing up, by the way. Most people...\" She trails off. \"Anyway. Same time next week?\"","","*choice","    #\"Same time next week.\"","        *set katie_friendship +2","        \"Same time next week,\" you say.","","        Katie blinks once, surprised. Her hand eases off the duffel handle. \"Okay. Cool. Yes. That works.\"","","        She glances at the squeeze ball in your hand. \"Make a note of your reactions if you can. Words, sensations, anything weird. Doesn't have to be formal.\"","","        She opens the door, and her voice drops even more. \"Glad you came. I mean that.\"","","    #\"I don't think I'll come back.\"","        *set katie_subplot_status \"rejected\"","        You give a small shake of your head. \"Probably not. But thanks for today.\"","","        The smile stays, but the rest of her face doesn't bother pretending. \"Ah. Got it. Yeah, no problem.\"","","        \"Still,\" she says, her smile retreating. \"Got some good data. Thanks for that.\"","","        She opens the lab door and retreats.","","        As you leave, you take one last glance back. She's still at the desk, gazing at the empty hallway, like she identified the signal but responded on the wrong frequency.","","*return","","*label event_2","Fluorescent tubes flicker behind cracked plastic coverings, throwing sickly yellow light onto the room. From the far side, an air conditioner emits a low hum, circulating recycled air that tastes stale in your throat. A standard function room in a standard podium clubhouse in a standard private housing estate.","","Katie's already here, kneeling by a row of tape measures on the carpet. A large duffel bag is by the wall, sensor cables and unidentifiable wood and metal implements peeking out from it. She's arranging the tape measures and doesn't notice you entering.","","You stand a few metres away, and she finally notices. The smile comes too fast, like she had rehearsed the expression in front of a mirror.","","\"You came, ${first_name}! That's cool. I wasn't sure if I confirmed the time properly. I always forget that step. Anyway, you're here!\"","","She launches into an explanation of how she managed to book the place \u2014 how she's not a resident here, but their website uses an old reservation portal, so she logged in as admin, she doesn't remember how, clicked the wrong thing and got in, now it's technically unlisted, which means no one should be here, and then she talked to the maintenance guy until he surrendered the door key.","","She looks like she's going to keep going, but then suddenly stops.","","\"Sorry. That was too much info. I'm trying to talk more... normally. Um... but this space is okay, right?\"","","*choice","    #You notice how everything sounds rehearsed.","        *gosub_scene utils increase_analysis","        A practised smile, no eye contact, excessive detail. Her words speed up as she speaks, trying to make up for your silence.","    #You wonder how other people would think about her monologues.","        *gosub_scene utils increase_empathy","        This kind of infodumping would overwhelm most people. She flinched before you even said anything, like she's expecting you to give a polite excuse and leave.","    #You keep silent for now, giving her space.","        *gosub_scene utils increase_composure","        You just nod. She's unsettled. Let her gather her bearings first.","","Katie hands you a folded white towel and a metallic object that looks like a hostile TV remote control, all weird angles and protrusions. \"The haptic sensors adapt to your nerve signals!\" she says, the words flooding out. \"It adjusts in real-time to your muscles as they expand and contract. There's a gyroscope for inertial compensation. Filters out noise so we only measure the nerve responses.\"","","Her arms wave energetically as she explains the design. Adaptations for skin pressure, electrical reactivity, biofeedback, and dermal adaptations. Your eyes start to drift, but she continues for a few more breathless sentences before she notices.","","\"Oh. I was too technical again. I just assume people are interested in the same things I am...\" Her shoulders drop slightly. \"Never mind...\"","","A moment later, you realise the sentence was a reflex, offered, then retracted, like muscle memory.","","She peels the backing tape off a sensor, the adhesive coming off with a wet ripping sound. Holding the sensor delicately, she looks at you. \"You can ask stuff if you want, by the way. Some people like to know what's going on.\"","","An uncertain pause, her mouth twitching into a brief frown. \"Some people don't. That's fine too. Either way.\"","","*choice","    #You wonder whether she's memorised this entire sequence.","        *gosub_scene utils increase_analysis","        You can hear it in her speech. Her tone is too polished, like a flight attendant reciting safety guidelines. No spontaneity. Even the way she checks in with you is part of the script; you can almost imagine a line in a programme, \"detect confusion, apologise, offer clarification, continue.\" You wonder how many blank stares she's received with this routine.","    #You make it clear that you're still listening.","        *gosub_scene utils increase_empathy","        \"I'm following,\" you say, trying to bring warmth into your voice. \"It sounds interesting. I'd like to know more.\"","","        She blinks rapidly, and her gaze meets yours for a moment. \"Really?\" A half-smile appears on her face.","    #You keep steady and wait for her.","        *gosub_scene utils increase_composure","        You stay silent, unmoving. Katie's trying to read your non-response, and it's somehow short-circuiting her script. The silence stretches. You let the moment stay, until she finds her footing again.","","Katie starts explaining again, but this time she talks more slowly, watches your face while speaking. Like she's trying to adjust in real time.","","She bounds over to her duffel bag and retrieves the wooden dowels from last time. Three exercises this time, each one targeting different nerve clusters. First, gentle pressure to familiarise the nerves with discomfort. Then, slightly more pressure, but not enough to trigger a panic response, followed by progressive conditioning exercises to build resistance. She explains that the exercises were inspired by judo principles.","","\"Not published. Yet.\" Her voice lifts slightly on the [i]yet[/i].","","After you complete each exercise, she runs her eyes quickly over the sensor readouts and taps on her tablet, and makes small adjustments to how you hold the rods.","","*choice","    #You consider her approach, how she integrates the data into her adjustments.","        *gosub_scene utils increase_analysis","        She reads your micro-expressions and cross-references them with the sensor data. Rapid calculation, precise modifications. Repeat. It's a loop. Her eyes dart from the table to the wooden dowel to your face in a regular sequence.","","        It's nothing like the hesitancy of her social interactions. Her movements here are efficient, her decision-making rapid and confident.","    #You notice how she studies you, looking for signs of discomfort.","        *gosub_scene utils increase_empathy","        Her gaze is intense and focussed when she observes you. She scans for discomfort, noticing the tightening around your eyes, the small clench in your jaw when pressing on a nerve bundle, your cheeks tensing slightly. There's a gentleness in how she applies the pressure. ","","        It's not what you expect. She's hyper-aware of your smallest reactions now, even though normally she's so disconnected from others. \"This one might spike,\" she says, softly. You realise she's mirroring your reactions.","    #You hold still through the exercises, to make it easier for her to calibrate.","        *gosub_scene utils increase_composure","        You hold still, your breathing steady even while applying pressure to your nerve clusters. Katie's taught you that flinching only amplifies the nerve sensations.","","        She pauses after another adjustment cycle. \"Most people can't control their twitching. You've learnt to control your response in a really short time.\"","","        The room is almost silent, the only sound being the soft tap of her fingertips on the tablet screen.","","Katie retrieves something that looks like a tuning fork from the duffel bag. The two prongs are wrapped in a layer of black electrical tape, and the handle is made of plain plastic. A copper wire extends from the base of the handle, leading to a battery pack.","","\"This tool is different from the others. It doesn't suppress pain, it [i]modulates[/i] it. It interferes with the actual nerve signals so that your brain doesn't even receive the pain. No one has ever made anything like this before.\"","","*page_break","She looks at it for a second, runs her fingers gently down the tines, and then flicks a tiny switch on the side of the handle. You don't hear anything, but you feel a low, deep vibration, like you're standing in front of a subwoofer. Your skin tightens, and your arms tense up reflexively.","","\"It delivers targeted vibrations at harmonic frequencies. If it's calibrated correctly to your nervous system, it can scramble nerve signals, exactly like jamming a radio channel with static,\" Katie explains. She breaks out into a wide grin as she admires the device.","","\"If the brain gets a scrambled signal from a nerve, it downplays it. This fork distorts the signal just enough to do that, without causing any harm. It's not electrical, it's haptic, like what they use in neural rehab for phantom limb pain.\"","","She kneels at your side and raises the fork to your forearm. You notice her grip on the plastic handle, so tight that her knuckles are white and the veins stand out at her wrist. \"It should be fine,\" she says, more to herself than to you.","","Her eyes are fixed on you. Her hand hovers, the fork a whisper from your skin. She takes a deep breath.","","She touches the fork to your forearm.","","*page_break","There's no pain.","","Something vibrates in your bones. There's no sound. No pressure. Your muscles twitch, like they're reacting to a stimulus that hasn't arrived.","","Then it hits. A dislocation. Your arm is still there, but it's no longer yours.","","Katie leans forward and looks up at your eyes. Her breathing has quickened, now shallow and irregular. She's staring right at you, looking for any sign, any micro-expression that could tell her if she made a mistake.","","\"Did that feel okay?\" Her voice is thin, like the rehearsal stopped.","","Then the words tumble out. \"It's a lot to take in. Like, your arm doesn't feel like it's yours any more, and it feels weird, not pain, but... Sorry. It's not... I'm not trying to lecture you.\"","","She rises and steps back, looking down at the floor, pulling the fork away with her. As the fork breaks contact, your arm feels like it's returned, but still not quite right. Katie swallows, glances at the tablet, then looks up at you again. \"It... worked. Should have worked. You can choose whether you want to feel pain in your arm or not... for the next hour or so.\"","","You pinch your arm, to test. A pinching sensation, but numb. It reminds you of dental anaesthetic. Then you try again, this time expecting pain, and a sharp sting arrives.","","Katie's voice wavers. \"I can make more. For you. If you want.\"","","She's not looking at her instruments, her data, or your arm now. Just your face. She looks away, then back, like someone approaching a dog that might bite them.","","\"You're... patient. You don't just... shut down when I talk.\" She braces, the pupils of her eyes contracting.","","Then with a breath, she plunges onwards. \"Would it be weird if I asked you for help, ${first_name}? Help with just... being normal?\"","","*choice","    #You sense how much courage it took for her to ask.","        *gosub_scene utils increase_empathy","        *set katie_friendship +2","        The change in her face is clear. The scientific armour has crumbled, and what's underneath is raw. She's barely breathing, staying still as a statue, like she's regretting it already. But she hasn't turned away.","","        You speak quietly. \"That took guts to ask. And no, it's not weird.\"","","        She continues staring at you, as if your words didn't reach her.","","        \"I'm not great at this either,\" you say. \"But if you want... we can figure it out together.\"","    #You keep your expression neutral, your voice even.","        *gosub_scene utils increase_composure","        *set katie_friendship +1","        This needs careful handling. She's already defensive, shoulders drawn in, braced for rejection. You maintain steady eye contact and keep your voice even, hoping that your steadiness will reach her.","","        \"It's not weird to want help with social interaction. But I'm not an expert either. Let me think about how I might be able to help.\"","","        You see her posture ease. She stops holding her breath. A small step.","","        \"If you want, we can figure this out together.\"","    #You recognise this as an important moment in your interactions with Katie.","        *gosub_scene utils increase_analysis","        *set katie_friendship +2","        You were half expecting her to ask. When she's doing her research, her competency is exceptional, even when it comes to reading your facial cues. But in social situations, it's absent. She's applying a structured approach to human interaction, trying to create a framework and follow patterns.","","        \"I could provide feedback,\" you say. \"But I want to know what 'normal' means for you. Normal depends on the context.\"","","Katie nods once and mouths 'thank you', though the words are inaudible. She tries to form a smile, but it breaks halfway through, becoming just a slight crease at the corner of her mouth. She straightens, says she needs to pack up. Her hands move easily, like she's playing [i]Bishi Bashi Champ[/i], clearing cables, snapping lids shut, collecting sensors.","","The silence returns, but this time it's comfortable, neither of you desperate to fill it with words. From somewhere nearby comes the low noise of water as it glugs through old pipes.","","\"Thanks for coming today,\" Katie says, not looking at you. She crams all of the gear into her duffel bag. The zip gets stuck halfway.","","Your arm still feels like it's vibrating. Still different, still disembodied. You raise your hand, and your fingers automatically curl into a loose fist.","","Katie opens the door for you. The hallway outside looks exactly like it did before. \"I'll send you a link, for scheduling,\" she says as you leave.","","The buzz in your forearm follows you home.","","[i]Insight settles in your body. Possibility.[/i]","*return","","*label event_3","The HKU canteen is a long, brightly lit hall. Polished laminate flooring, plastic plants in plastic pots, sagging ceiling lights. Plastic chopsticks clatter on plastic trays as pillar-mounted flatscreens silently cycle through campus announcements. A few students sit in ones and twos on hard unyielding chairs at rectangular wooden tables. The lunch rush has subsided, the tabletops littered with half-finished trays that exude the scent of baked tomato pork chop rice and some kind of cream soup.","","You spot her at the far end of the hall, seated at a booth for four next to one of the big grid-patterned windows. A few rays of sunlight filter in. Katie's visible there, but it seems like she's occupying a separate space from the other students.","","A neat ponytail, a hint of makeup. An unzipped navy windbreaker frames a white T-shirt with \"Bonjour Tristesse\" splashed across the front. Dark bootcut jeans, clean canvas sneakers, and a black crossbody bag beside her on the seat. Every item in her outfit is ordinary.","","Her posture is anything but. Back rigid, shoulders square, like she's locked into place. Both her hands are flat on the table, palms down, elbows at a perfect right angle. A laminated card peeks out from under one hand.","","The food on her tray is untouched. A plate of steamed rice, flanked by two thick slabs of chicken thigh, pan-fried to dryness and lacquered in a glossy, rust-coloured gravy. A few scraps of steamed broccoli and half-translucent cabbage huddle at the edge of the plate. Milk tea in a chipped white mug. A thin, unbroken skin has formed on the surface.","","She's scanning the hall without trying to look like she's watching. She spots you, and instantly rearranges her face into a smile. Recognition, execution.","","*choice","    #You analyse her actions. She's running a script.","        *gosub_scene utils increase_analysis","        The smile arrives in stages. Eyes first, then mouth, then a slight head tilt, like she's following a checklist for \"greeting a friend.\" Her shoulders drop at the right time.","","        The same systematic approach she used at the lab, now applied to social interaction.","    #You note her presentation, without commenting on it.","        *gosub_scene utils increase_composure","        She's set up her formation. Chosen her position, her appearance, her expression. You note it without judgement and approach.","    #You sense the effort behind her actions. This is courage for her.","        *gosub_scene utils increase_empathy","        The smile wavers, from concentration. She's putting in so much effort that the strain seeps through. Sitting in public, outfit assembled with care, waiting for someone who might not show. This is what bravery looks like for her.","","\"Hi!\" Her voice is too high, but she quickly brings it down. \"Thanks for coming. I got here early to get a good table. This one has the best lighting. Natural light.\" She flings her right arm at the window, then freezes. \"Sorry. I said too much about table selection.\"","","Her hands return to their original positions, stuck to the table. Bullet points in neat handwriting peek out from the laminated card under her palm. She slides the card into her jeans pocket.","","Your order number flashes on the overhead screen, so you go and get your seafood ramen. On your return, you see that Katie has loosened up her posture slightly, and she's torn the paper wrapper from her chopsticks into a pile of small scraps.","","*page_break","\"So.\" She pauses, rearranging the paper scraps into a tiny pyramid. \"I asked you here because... I need practice. With this.\" A vague sweep of her hand indicates the canteen, the untouched food, and you.","","Her voice softens, no longer sharply enthusiastic. Tired, even. \"I want to be able to just... talk. How other people do. I know I'm intense. I say too much, too fast. I miss cues.\"","","She exhales, then stares at your ramen with a tight-lipped smile. \"Sometimes I see it when it happens. They stare through me, then their eyes snap back into focus. Their smile turns stiff. They pretend to listen, but they've already disengaged. Waiting for the first excuse to exit.\"","","Katie stares at her milk tea, the skin on top still unbroken. She steadies herself, then speaks to her hands.","","\"I read about how to succeed socially. I practise in front of a mirror. But whatever I do, it feels like... like I know the words, but they never land in the right order.\" She looks at you. \"Does that make sense?\"","","Her hands are still flat on the table. Her forearms tighten.","","\"I don't want to hide who I am.\" It's almost a whisper. \"I just want to speak the same language everyone else does.\"","","*choice","    #\"You're learning rules that were never written down. That's hard work.\"","        *gosub_scene utils increase_empathy","        *set katie_friendship +1","        Katie's eyes widen. \"But it looks so natural for everyone else. They just know what to do in any situation.\"","","        \"They learned it without realising they were learning. You're actively trying to learn. That's harder, but more admirable.\"","","        \"Really?\"","    #\"Let's start simple. Tell me about something you enjoyed this week.\"","        *gosub_scene utils increase_composure","        Katie looks at the pyramid of paper scraps and exhales slowly. \"Something I enjoyed this week...\"","","        \"Yes,\" you say. \"You don't have to have a goal. Just say anything.\"","","        She nods, although her lips are pursed in a slight frown. \"Okay, I'll try. Let me think about this a bit.\"","    #\"Maybe it's also about finding people you're compatible with.\"","        *gosub_scene utils increase_analysis","        *set katie_friendship +1","        \"Finding people I'm compatible with,\" Katie repeats softly.","","        \"So... learning how to connect, but also, finding the right people to connect with.\"","","        She looks at you and smiles, her forehead creasing slightly. \"You're right. I need to do both.\"","","Katie breathes in deep. Her arms and shoulders relax slightly, but her back is still straight. She picks up her milk tea with both hands, raises it to her mouth, and takes a sip. The skin breaks and swirls away.","","\"You know what's weird?\" she says, glancing out the window. \"I spent ten minutes this morning rehearsing this. The flowchart had a node for asking if you wanted to sit here. But you just... sat down.\"","","A quiet laugh, this time accompanied by a slight smile. \"Maybe I've been focussing on the wrong things.\"","","Someone nearby slurps loudly as they drink their soup. \"So, I never asked. What do you... do, ${first_name}? When you're not fighting, I mean.\"","","Direct, unwavering eye contact. You can almost see the memorised list of chat topics reflected in her eyes.","","\"Work, mostly. Marketing reports that no one reads.\" You pluck out the lone prawn floating in your ramen. \"You?\"","","\"Research and lab work. I'm finishing up my master's thesis.\" She pauses. \"I've been trying to learn Cantonese recently.\"","","\"Nice. How's it going?\"","","\"I'm not sure. I can say vasovagal reflex but not pineapple bun.\"","","\"Useful.\"","","\"Not really. One time, I apparently pronounced black coffee like Buddhist vegetarian mock chicken. The waitress said, 'We don't serve that here,' and gave me hot water.\"","","Katie laughs, teeth showing, relaxing into her seat. It trails off naturally. You see a flash of surprise in her face, like this wasn't in her script.","","She continues, in the same easy tone. \"There's this theory in neurotrauma. They say language rewires itself around pain perception. Like, people recovering from strokes, they relearn words and body mapping at the same time.\"","","It hangs in the air, a bit too long. Her cheeks flush slightly. She stares at her tray, where the chicken still sits, untouched. Her hands drop to her lap.","","*choice","    #\"When you talk about this, your passion is obvious. That's a good thing.\"","        *gosub_scene utils increase_empathy","        *set katie_friendship +1","        She blinks, and looks back up. \"Huh. That could be true. Still, I need to figure out better timing.\"","","        She lightly brushes her neck with her fingers, and then smiles. It falters into a frown, but just a small one. \"No one else says that, ${first_name}. Everyone else, their eyes glaze over. It's nice that my rambling isn't scaring you off.\"","","        She spears her chicken thigh with her fork and raises the entire thing to her mouth, taking a big bite. She chews for a while.","","        \"So... the enthusiasm, I should keep that. And look for situations where it fits.\"","    #\"No pressure at all. Let's talk about something simple.\"","        *gosub_scene utils increase_composure","        \"Okay, right. Let's do that.\" She looks up at your, her expression blank. \"What's your favourite food?\"","","        You answer, then wait. Katie tilts her head slightly. \"That felt different from what I did.\"","","        She beings to slowly nod her head. \"Talking about easy things, it's relaxing. That's why people do it.\"","    #\"We can take turns. I'll tell you all about spreadsheets.\"","        *gosub_scene utils increase_analysis","        *set katie_friendship +1","        Katie looks back up, unsure if you mean it.","","        \"Let me explain the difference between VLOOKUP and INDEX MATCH.\" You launch into a detailed, methodical explanation. She stares at you, mouth parted slightly, eyes starting to glaze. Then, she collects herself, sits back up straight. A smile.","","        \"Oh,\" she says. \"This is what I sound like when I do that.\"","","        \"Pretty much.\"","","        She strokes her chin. \"Thanks. This is useful.\"","","A janitor wheels past with a cart of abandoned meals. Katie watches her disappear into the service entrance.","","\"Do I make you uncomfortable, ${first_name}?\" she asks suddenly. She fishes out a rubber band from her pocket and hooks it between her thumb and index finger. The rubber makes a tiny, mosquito-like zinging sound each time she stretches it.","","\"I'm still weird, right? I'm trying not to be. Does it... work?\"","","She's not asking if it's making you uncomfortable. She's asking if you'll stay.","","*if highest_trait = \"analysis\"","    \"You're regulating your emotions with that rubber band. That's not weird. People handle nervousness in different ways.\"","","    Katie's mouth falls open, and she quickly covers it with one hand. Then, she mumbles, \"... yeah. You're right.\"","*elseif highest_trait = \"composure\"","    \"If I thought you were weird, I wouldn't be here.\"","","    Katie's fidgeting slows. \"Maybe I'm improving,\" she says quietly, more to herself.","*elseif highest_trait = \"empathy\"","    You lean forward slightly. \"You're not weird. You're trying really hard. I can see that.\"","","    Katie stops fidgeting entirely. Her eyes brighten even as she bites her lower lip. She looks down at her meal, a smile ghosting across her face.","*else","    *bug Invalid highest_trait","","*page_break","The conversation flows more naturally. Katie asks how you train for fights, whether you prefer morning or evening sessions, how you find the time to fit in your training. She stops monitoring her reactions and facial expressions as much. She starts to ask follow-up questions instead of running through a stack of invisible cue cards.","","You're in the middle of explaining your pre-dawn Star Ferry sprints when her face goes blank and her hands go still on the table.","","\"You don't have to stay if this is making you uncomfortable. I know this isn't how people normally talk.\" The words come out flat.","","The noise doesn't stop. Muted chatter, the beep of a kitchen timer, the rattle of a dropped pair of chopsticks. The air smells faintly of overcooked greens. But the space between you seems to shrink.","","\"I feel like... I'm doing my best to act normal, but it's not working. Like I'm faking it and everyone knows.\"","","It's almost a whisper now. \"I can tell when someone looks at me and decides it's not worth the effort. They eyes just... drift past me.\"","","Her voice cracks, but she keeps going. \"Sometimes I can't even tell. That's worse.\"","","Her arms remain on the table, palms flat, fingers braced, but they're shaking. She's looking at you, searching your face.","","She's waiting for the moment you look away. But she hasn't looked away herself.","","*choice","    #You recognise that she's spiralling and point out the pattern.","        *gosub_scene utils increase_analysis","        *set katie_friendship +2","        \"You're looking for any sign of rejection, to confirm your fears,\" you say. \"But faces aren't actually that easy to read. Someone might make a face because they're feeling cold, and you just assume that they don't like you.\"","","        Katie draws in a breath, then slowly releases it. \"So maybe someone looks away, and I think they're looking for an excuse to leave, when actually they're thinking about something.\"","","        \"Yeah. It's pretty common. You trained yourself to expect rejection.\"","","        She stares at the ceiling, mouth slightly open, as she lightly rubs her chin with one hand. \"That is... good to know. I didn't realise I was doing this.\"","","        She looks back at you and nods slowly. A hint of a smile crosses her face. She leans forward slightly, hands clasped on the table.","    #You lean forward slightly and affirm that you're here for her.","        *gosub_scene utils increase_empathy","        *set katie_friendship +2","        \"I'm still here,\" you say. \"I'm here for you.\"","","        \"Really?\" Katie's eyes widen, and she searches your face, her breath held. Whatever she finds there, it makes her smile.","","        \"You mean that,\" she says. It's not a question.","","        \"You don't have to pretend with me.\"","","        She blinks once, then looks to the side. \"${first_name}... thank you.\"","    #You stay steady, grounding yourself and her.","        *gosub_scene utils increase_composure","        *set katie_friendship +1","        You maintain eye contact, staying where you are, breath steady.","","        \"I'm still here,\" you say, after a moment.","","        Katie relaxes, her grip on the table loosening.","","        \"You never have to pretend for me.\"","","        She looks to the side, but a smile peeks through, before flickering out.","","*page_break","Katie takes a long sip from her milk tea. \"I... I should finish this chicken.\" She scrapes the gravy away and stabs the chicken thigh with her fork. She chews slowly, her attention fixed on the chicken.","","You both finish your meals quietly, chopsticks scraping against plastic. A drink machine hisses, and the ventilation system kicks in with a rumble.","","The sun cuts in at a low angle, throwing soft golden light onto the table. Katie packs her bag. Unhurried. Just someone gathering her things.","","\"Next time, maybe we can go somewhere with better food.\" She looks at the floor while she's saying it.","","\"If you're free,\" she adds, this time meeting your eyes.","","Then she's gone, without waiting for your reply.","","*return","","*label event_4","A familiar pneumatic hiss as the MTR carriage opens in sync with the screen doors. HKU Station is less busy in mid-afternoon, the university nestled awkwardly in a hilly residential area. Up, out of the station, take in the smell of damp earth, cross the footbridge, escalators, until you arrive at the relatively open space of Centennial Campus. West, up, through another hallway. A slight ache in your thighs.","","A glass-fronted entrance, a reception desk, card-access doors. The only sound is the ticking of the wall clock. You give the receptionist Katie's room number and write your name on the clipboard. A few words into the phone, then a click. Soon, a young woman emerges from the lifts. You don't recognise her, but she waves at you, nods to the receptionist, and leads you to the waiting lift.","","She clears her throat. \"Hey. Katie's been really off these few days. Hope you can help her out of it.\" You mumble something about trying your best. You imagine Katie and her roommates.","","Beige corridor, number plates on the doors, tiled flooring. She opens the main door, leads you in, and disappears into the bedroom. You take a moment to catalogue the space. The rectangular wooden table by the wall is dotted with four flimsy plastic chairs. It's flanked by the bedroom door and a small kitchen area with just a sink and a microwave. The table bears only a box file binder and a slim laptop computer, the cover shut. No food crumbs, no water rings. ","","Katie's sitting silently on the plastic chair at the long end of the table.","","*page_break","She's dressed in a plain sloganless T-shirt, loose sweatpants, cheap plastic slippers. Her unkempt brunette hair flows behind her, reaching slightly below her shoulders. Her eyes, slightly puffy, have bags under them. You've come to expect the [i]snap, snap, snap[/i] of the elastic on her wrist, but there's no sound today. Her legs stay still. No bounce.","","You ease into the chair closest to Katie. Her mouth opens to say hello, but it closes again without uttering a word. She stares at the binder on the coffee table. Pulls her legs up, hugging her knees to her chest, arms wrapped around her shins.","","*choice","    #Notice how this feels different from her usual frustrations.","        *gosub_scene utils increase_empathy","        It's not only defeat, it feels more like despair. She doesn't usually let failure deter her. What's different this time? You look at her and mouth a silent question.","    #Sit a while more. Let her know you're here for her.","        *gosub_scene utils increase_composure","        Katie looks defeated. But there's no need to rush into action. Sit with her for a while, steady her first.","    #Ask Katie what's wrong.","        *gosub_scene utils increase_analysis","        She's clearly not her usual self. Reason currently unknown. But you suspect the binder will have clues. You glance at her, then at the binder.","","You sense it's not the right moment to examine the binder. You continue sitting, resting your gaze somewhere past her shoulder, keeping her in your peripheral vision.","","She continues to stare at the binder. After a while, she meets your eyes and then immediately looks away.","","\"I should get us some water to drink,\" she sighs, and trudges over to the sink. You hear the tap running, see her open the top cupboard, then close it, then retrieve two tumblers from the drying rack. She stands there, water flowing, waiting. Stalling. But it helps.","","After enough time to fill a bucket with water, Katie returns and sets the tumblers on the table, still dripping with water. She's sitting upright now, looking up and to her right, at some blank section of the ceiling.","","Then she looks at you. She tries to arrange her lips into a smile, but they barely twitch. Her shoulders sag slightly, and she gives a small nod towards the binder.","","\"They've killed it.\"","","You pick up the binder. You don't know what you were expecting, but it feels ordinary, unremarkable.","","*page_break You start reading.","[b]PAIN TOLERANCE ENHANCEMENT THROUGH SYSTEMATIC NERVE DESENSITISATION[/b]","","BY","","KATHERINE REYNOLDS","","A thesis submitted in partial fulfilment of the requirements for the degree of Master of Philosophy in Public Health at The University of Hong Kong","","School of Public Health, Division of Kinesiology","","${current_month} ${current_year}","","*page_break You flip through the binder.","You leaf through, eyes scanning quickly. An abstract, a background with more than twenty key citations. Phrases that you've vaguely heard before: \"linear mixed models,\" \"multiple-comparison control,\" \"primary/secondary endpoints.\" An ethics submission cover page, stamped \"HREC Ref: EA/2024/0108\". A power-analysis printout from something called [i]G*Power[/i] with a pile of numbers for [i]f[/i], [i]\u03b1[/i], and [i]\u03b7\u00b2[/i], whatever that means. Repeated-measures design. ANOVA.","","More charts, tables showing \"test-retest reliability\". Booking confirmations for a sensory-testing room. Loan agreements for a \"pressure algometer loan via Dept. of Anaesthesiology Pain Research Unit.\" Questionnaires with names like \"Pain Catastrophising Scale\" and \"State-Trait Anxiety Inventory.\"","","It's well over two hundred pages.","","*page_break You reach the final page.","Katie's voice is flat and mechanical. \"That's what I've been working on.\"","","\"Impressive.\" It slips out before you can find better words.","","\"Here's what they said, though.\"","","She flips open the laptop and turns the screen to you, showing Outlook with the \"thesis\" folder open. She exhales slowly, nudges the laptop towards you, and leans back into her chair.","","You scroll through the emails. The timeline unfolds:","","\"Clarify stimulus calibration protocol \u2014 additional documentation required\"","*line_break","\"Recruitment materials: remove word 'pain' from poster\"","*line_break","\"Referral to Full Board due to deception component\"","*line_break","\"Primary reviewers indicate substantial revisions would be required for an approvable version\"","*line_break","\"HKU HREC Decision Notice \u2014 EA/2024/0108\"","","You click on that last one.","*page_break","[i]Thank you for your application EA/2024/0108. Following review by the Human Research Ethics Committee, approval cannot be granted in its current form. The Committee identified substantive issues relating to risk mitigation, consent documentation, and the adverse-event plan.[/i]","","Ah.","","*if highest_trait = \"analysis\"","    You see the pattern. The university began with reasonable requests and constructive feedback. As the review continued, their position morphed into systematic rejection.","*elseif highest_trait = \"composure\"","    You recognise the emails as a shift in the university's stance. The initial moves were subtle, asking for more documentation and changes in procedures. As pushback escalated, it inevitably became an earthquake.","*elseif highest_trait = \"empathy\"","    You sense the escalating pattern of resistance in the emails. Initially, they were merely suggestions and requests for additional information. As events unfolded, the university became increasingly obstructive. A drawn-out rejection in the form of endless demands.","*else","    *bug Invalid highest_trait","","The bluntness of the rejection is like a silent slap. A single paragraph, erasing months or years of work.","","The laptop fan whirs faintly. You glance up. Katie's looking at you, but she's managed to sink into the hard plastic chair with her shoulders drawn in. Now her gaze is drifting past you, unfocussed, like a student outside the principal's office.","","You can see the damage. But the problems aren't fatal.","","You drink from your glass, then slide Katie's towards her. She reluctantly takes a sip and places it back on the table.","","There might be a way forward. First:","","*choice","    #\"Could I show you something about these emails?\"","        *gosub_scene utils increase_analysis","        *set katie_friendship +1","        \"Could I show you something about these emails? I think I have a pretty good idea of what they're looking for.\"","","        She looks at you. \"They're looking to shut it down.\"","","    #\"Take a breath. This isn't over.\"","        *gosub_scene utils increase_composure","        \"Take a breath. This isn't over. There's a way forward, as long as we have the right strategy.\"","","        She looks at you. \"I don't think so. You read the emails. They're not interested.\"","    #\"You don't have to fight this battle alone.\"","        *gosub_scene utils increase_empathy","        *set katie_friendship +1","        \"You don't have to fight this battle alone.\"","","        She looks at you. \"I... don't know how to fight this kind of battle.\"","","But she sits up straight and takes a deep breath. Her hands clasp the water glass, and she continues.","","\"I did everything they wanted. They wanted detailed risk mitigation protocols, I spent days writing contingency procedures for every possible adverse event. I haven't even included the neural feedback devices we used. They would never approve it. [i]Unacceptable participant risk.[/i]\" She makes air quotes. \"I submit everything they ask for, and then they respond with new compliance demands. Nothing I do will ever be enough for them.\"","","She slows down. \"You see it too, right?\"","","You're not as sure. Katie's looking at you expectantly. You collect your thoughts.","","Something about Katie's approach has set off institutional alarm bells at the review committee. Most likely, reputational risk. However, they can't outright reject her research, because the methodology is sound. They're burying her in paperwork so she takes the hint or abandons the research.","","How to explain this tactfully?","","Then you see it. You recall an office project. The approval process checked all the boxes, but legal kept bouncing it back, asking for 'additional liability documentation'. Your team leader finally pushed it through by getting a coffee with Dorothy from compliance, finding out their actual concerns, and restructuring the proposal document to address their worries.","","*fake_choice","    #\"Here's how to play this game.\"","        You explain how the review committee actually works. That it feels risky to them, but they can't say it directly. ","    #\"I might know how to get through to them.\"","        You explain the institutional dynamics, what adjustments might help to address their real concerns.","    #\"I'll go through this with you.\"","        You say that this can be worked around, and you'll be there with her to navigate the process.","","The familiar snapping sound of Katie's hair elastic returns. You outline a plan: find her supervisor and have an informal chat with them. Submit again, avoiding the areas they're concerned about.","","She looks away from you. \"${first_name}... I know you're trying to help me. I really do. But I can't do this. That's lying. That's... wrong.\"","","Her hands clench around the water glass, knuckles almost white, but her right knee's bouncing rapidly under the table.","","*choice","    #Consider what this reveals about her core values.","        *gosub_scene utils increase_empathy","        You heard how her voice wavered. But even now, she's here, waiting for you to respond. Her eyes still meet yours, though she's blinking rapidly.","    #Accept her refusal before deciding what to do next.","        *gosub_scene utils increase_composure","        She's closed the door. Forcing it open won't help. You breathe steadily, letting her objection exist without needing to meet it.","    #Think about how to overcome her objections.","        *gosub_scene utils increase_analysis","        She said, \"that's lying.\" To her, omission is deceit. You could tell her it's about emphasis, not avoidance.","","You tell her a story. \"We had this client once. A government division.\"","","Katie leans forward, an elbow on the table, head resting on the palm of her hand, focussed on you. You continue. \"We told the back office like usual. But Dorothy from compliance kept bouncing things back, sometimes with these lists of questions, sometimes with request for forms to be filled in. All this paperwork was taking weeks and holding things up.","","\"Some of us bumped into Dorothy at lunchtime one day. We were lining up at Fairwood, and my boss asked Dorothy what in the world was going on, just like that. Dorothy said, that compliance stuff is whatever, but are you prepared to take responsibility if your client does something that ends up in the newspaper?","","\"The client was just handling sewage treatment.\"","","Katie shakes her head. Then she squeezes her eyes shut. Her leg bounces. Her mouth opens as she takes in a gulp of air, and she takes two more quick breaths, as if she suddenly remembered air was necessary. A smile tugs at one corner of her mouth, but it twitches, becomes a grimace.","","Her eyes are still closed as she speaks. \"I didn't understand them, is that it? I didn't understand them. I just never tried to... never thought about what they were really...\"","","She looks straight down, chin lowered to her chest. Her shoulders rise and fall. Up, down, up-down.","","*choice","    #Say that she doesn't have to talk about it.","        \"You don't have to talk about it right now. Take your time.\"","","        \"Okay. Thank you.\" She closes her eyes briefly.","","    #Lightly rest your hand on her back.","        *set katie_friendship +2","        You rest your hand gently between her shoulder blades. You feel her warmth through the fabric, a steady heat. Katie's shoulders tense up, and her eyes widen. Then, after a moment, she allows herself to lean into your touch, gaze still lowered. A tiny smile wavers at the corners of her mouth.","","    #Sit quietly beside her.","        *set katie_friendship +1","        You sit with her. Giving her space. You match her breathing. She doesn't notice, but her breathing evens out, her body stills.","","\"Maybe... you could see your supervisor some time. Do they have office hours? Just something casual.\"","","She sits up straight. Her words come faster now, precise. \"Yes, I could. She's free on Wednesday and Thursday afternoons. I could email her to book a time.\"","","\"That works. See her and listen to what she has to say? Just some info gathering.\"","","\"Yes, I could discover the actual problems, and then I could explain how I can address all of their concerns \u2014\"","","\"Hmm, maybe sleep on it first? Give yourself some time to process it before you respond.\"","","\"Why wait?\"","","You see it: the need to act immediately. Move first, think later. But it doesn't leave space for other people to feel heard.","","*choice","    #Suggest learning more instead of rushing to act.","        *gosub_scene utils increase_analysis","        \"Katie, it's understandable that you want to take action straight away. But we're going in without any real information. We'll be acting blind.\"","    #Remind her that she doesn't need to have all the answers straight away.","        *gosub_scene utils increase_empathy","        \"Katie, I know that you want to fix things. But right now, that starts with listening.\"","    #Explain how waiting can be strategic.","        *gosub_scene utils increase_composure","        \"Katie, holding back here actually keeps you in control.\"","","Katie nods slowly, then swallows. \"${first_name}, will... will this really work?\"","","She covers her mouth briefly with one hand, eyes searching your face.","","\"It could. It could work. I think it's the best way forward.\" You maintain eye contact. \"Don't rush things. Practise. I can rehearse it with you, if you want.\"","","\"Don't rush. Practise. Rehearse... together?\" Her eyes widen slightly, then she repeats the words under her breath.","","But then she runs one hand through her hair, tangling it further. \"What... what if they just shut me down? What if they don't tell me anything?\" She looks at the floor, then her eyes dart to you and to the wall clock and back.","","*fake_choice","    #\"It will work. Trust me.\"","    #\"No guarantees. But it's the best shot we have.\"","    #\"If this fails, we try something else. That's all.\"","","She nods a bit too quickly. Then she notices you've gone quiet, and studies your face. She drums her fingers on the table.","","Katie clears her throat. \"You know, the fighting is simpler than this stuff. At least the punches hit you.\" She laughs, as if it were a joke.","","Her smile falters. You realise she really was trying to make a joke.","","You try to arrange your face into a reassuring smile, then abandon the attempt. Better not to force it.","","\"Uhh...\" She sighs. \"This goes against my instincts. I [i]need[/i] to do something, you know? But... I'll try it, ${first_name}. I trust you.\"","","Katie says she should prepare to meet her supervisor straight away. Even though she's looking right at you, it sounds like she's saying it to herself.","","She moves to grab her water glass, pulling her chair nearer as she does so. Close enough that the smallest lean would close the gap. She takes a sip, sets the glass down, then her fingers tap lightly against the glass. Then she stops. She doesn't breathe out yet.","","\"Yeah... my supervisor, right? I can just email her to meet up. She has office hours, that's good, that's when people see her.\" She nods to herself too quickly.","","*choice","    #You give her space, respecting the boundary between you.","        *set katie_friendship +1","        You sit beside Katie, motionless, grounding her with your presence. The rapid chatter continues, but becomes quieter with each sentence.","","        She realises that you're just sitting next to her. She stops mid-sentence, whispers some reminder to herself. Sits up a bit straighter. Her fingers stop tapping, leg stops bouncing.","","        \"Yeah.\"","        ","    #You rest your hand on the table near hers, an unspoken offer of connection.","        *set katie_friendship +2","        You rest your hand on the table, palm down, in the space between you. You lower your gaze, letting your eyes drift to the table.","","        Katie notices. Her nodding abruptly stops. She stares at you, eyes wide, then looks down at your hand.","","        *if (katie_friendship >= 9)","            *set katie_romance +1","","            She swallows hard. Then she hovers her hand in mid-air for a moment, and lets it drift down. Her hand wavers, then lands short, finding your wrist instead of your hand.","","            \"Ah...\" The sound's so soft that you feel it more than hear it. She steals a look at you. Then, eyes down, she inches her hand forwards, laying it over yours.","","            Her palm is warm against you, her touch light, but deliberate. The space between you seems to shrink, as the moment pauses.","","        *else","            She snaps her hair elastic, legs jittering. \"Right. Supervisor. Yeah.\" She stares at your hand, but then looks down at the floor.","","            The distance between you remains, unbroken. Her hand lifts slightly, but the moment passes, and it settles back down. You don't push.","            ","*if katie_romance >= 1","    She looks at you, steady and quiet, her hand staying on yours. \"Thank you, ${first_name}. When you're with me, I feel like... I don't have to pretend.\"","*else","    She looks at you, steady and quiet. \"Thank you, ${first_name}. It's so easy to talk with you.\"","","*if highest_trait = \"analysis\"","    *page_break Consider the situation.","*elseif highest_trait = \"composure\"","    *page_break Acknowledge the friction.","*elseif highest_trait = \"empathy\"","    *page_break Recognise the struggle.","*else","    *bug Invalid highest_trait","Hundreds of pages of scholarly analysis. Meetings in sterile research labs and borrowed function rooms. Experimental neural feedback devices. Underground fighting for data collection. You've seen what she's given up, and what she's not willing to give up.","","This is how she lives. No compromise, no second thoughts. You find yourself wondering what it would mean, to live like that.","","But that can wait. Right now, you're here with her.","*if katie_friendship <= 8","    And you can tell that if you ever found yourself in need, she wouldn't look away.","*elseif katie_friendship <= 10","    And you know that if you ever found yourself in need, she would be there for you.","*else","    And you know that she will stand with you.","*return","","*label event_5","Unofficial pre-defense colloquium/internal review. PC attends.","PC main choice: how much to encourage Katie to \"bend\" to the bureaucracy.","*return","","*label event_6","After real thesis defense. Katie meets you outside the building.","Either pass with minor revisions or pass with major revisions, depending on PC's choices.","If not romance path, this is the end of the arc.","*return","","*label event_7","This event only happens on romance path. End of arc for romance path.","*return"], "labels":{"scene_introduction":0,"scene_choice":58,"event_1":107,"event_2":296,"event_3":459,"event_4":685,"event_5":990,"event_6":995,"event_7":1001}},
"danny_fight": {"crc":-276073154, "lines":["","*label fight","*temp dc_easy 9","*temp dc_medium 12","*temp dc_hard 15","*set fight_momentum 5","*set trait_bonus_amount 2","*set upgrade_multiplier 4","","Yellow banners flutter everywhere in the crowd, flags of a nameless faith. Some are hand-drawn, others professionally printed. All of them bear a silhouette of a black dragon.","","A chant starts near the front, low and slow. \"Dragon... dragon... dragon...\" It spreads steadily through the crowd, pilgrims joining the call. No exuberance, no excitement. A chorus of controlled conviction.","","You're at the edge of the prep area, catching glimpses of the crowd through the thin cloth curtains. Other fighters are wrapping their hands, stretching, preparing.","","Danny sits alone, his buzz cut revealing threads of grey hair. His yellow tracksuit is worn at the elbows and knees, but it's spotless. His frame is small, but he holds himself motionless, like the deity statue of a household shrine. He draws a thin black wristband from the outer pocket of his gym bag. Ties it with the care of a Taoist performing a sacrament.","","He closes his eyes, withdrawing into himself. A slow exhale. Then he stands and meets your eyes. A nod. There's no announcement, but the crowd's chant deepens. A few spectators lean over the barricades.","","*choice","    #You consider the scene. The banners, the uniforms, the chanting.","        *gosub_scene utils increase_analysis","        It's not spontaneous. But neither is it planned. [i]Mak kai[/i]: an unspoken rhythm that everyone in the crowd shares. Danny is the centre of this devotional act. But you're not sure whether he's the saint or the sacrifice.","    #You watch how the crowd leans towards him, like they're hoping he'll carry something for them.","        *gosub_scene utils increase_empathy","        They're cheering for a fighter, but that's not the main point. They're protecting an idea. And Danny lets them. He carries it for them.","    #You focus on your breath. Let the noise pass through you.","        *gosub_scene utils increase_composure","        The crowd's heat, the warehouse noise, Danny's absolute calm. You take all of it in without needing to process it. You're not here to analyse. You're here to remain steady.","","Danny steps out.","","The chant gathers weight, resonating even deeper. \"Dragon... dragon...\" It's the kind of chant that makes its way into your bones.","","You follow.","","The ring is just a square of canvas bordered by steel barricades and mats. The moment you step onto the canvas, the space changes. The crowd, the banners seem to close in. The air feels warmer. Even the floodlights overhead seem like they've turned to watch you.","","Danny bows once to each side of the crowd. He offers you the traditional salute, fist pressed to open palm. Then he drops into his stance: side on, lead hand extended, rear foot angled back, like he's been transported here from a Shaw Brothers film. It looks like something practised for thousands of times.","","The bell rings. The crowd silences as one.","","You circle cautiously. Danny doesn't advance; he beckons with his hand.","","*page_break","Your first ${jab} lands cleanly, a light but solid hit. His counter whooshes past your cheek, a full extension that slices air and nothing else. His face betrays no surprise, no emotion. He resets his stance, weight shifting to his back leg.","","Another jab. Another light hit. You can see it now: he's reacting much too slow, a beat behind. Perfect form, no rhythm. But there's no frustration in his expression, no tension. He exhales smoothly, resetting again, like he's done this a thousand times.","","Barely half a minute has passed, but sweat has already started to gather on his jaw. A kind of electric charge clings to him, intensity and calm blended at the wrong frequency.","","You keep distance. One-two. Nothing reckless. Danny responds with crisp interceptions, graceful footwork, arms moving in smooth circles. But there's no weight behind his movements. No threat. You could be shadowboxing.","","*if highest_trait = \"analysis\"","    Every movement is executed with textbook precision. But it doesn't react to your actions. You're not sparring a fighter. You're appraising a museum piece.","*elseif highest_trait = \"composure\"","    There's no urgency in him, despite losing every exchange. Perfect form, preserved since who knows when. Detailed, precise. Immune to external input.","*elseif highest_trait = \"empathy\"","    His strikes lack hunger. No killer instinct. Each one is a ghost, already vanishing. He's not here to win. Just to honour something.","*else","    *bug Invalid trait","","*set fight_momentum +1","*gosub_scene utils show_fight_momentum","","*choice","    #Probe his defences with a ${jab}.","        *gosub_scene utils increase_analysis","        *set upgrade_bonus (upgrade_multiplier * jab_level)","        *if (((adj_mental * 0.5) + (adj_technique * 0.5)) + upgrade_bonus) >= ((dc_medium * 0.5) + (dc_easy * 0.5))","            *set fight_momentum +1","            You work the jab, precise, persistent. His stance is solid, and his movements precise. But you see it: the rigidity, the lack of improvisation.","","            There's discipline, but no adaptation. No spark.","        *else","            You work the jab, precise, persistent. Danny's stance holds. Your jabs bounce off a wall of discipline, although he declines to go on the offence.","","            It's like testing a door you think is unlocked, only to find it's not even a door. Just paint on an unmoving wall.","    #Exploit his poor timing with an aggressive ${combo}.","        *set upgrade_bonus (upgrade_multiplier * combo_level)","        *if (((adj_power * 0.5) + (adj_technique * 0.5)) + upgrade_bonus) >= ((dc_medium * 0.8) + (dc_easy * 0.2))","            *set fight_momentum +1","            You throw jab-cross-hook combinations, gradually increasing the pressure. Danny reacts late each time, his blocks too slow, trailing behind your strikes.","","            A clean hook thuds into his cheek, snapping his head to the side. He recovers gracefully, focus steady, but the crowd's chant falters.","        *else","            You throw jab-cross-hook combinations, gradually increasing the pressure. Danny retreats, letting you have the space.","","            Your strikes only land as glancing blows. Gloved thuds on forearms, shoulders. Danny intercepts your hook, then continues smoothly with a punch that lands on your guard. Like you're taking turns to demonstrate techniques.","    #Test his limits with a ${flurry}.","        *set upgrade_bonus (upgrade_multiplier * flurry_level)","        *if (((adj_toughness * 0.5) + (adj_technique * 0.5)) + upgrade_bonus) >= (dc_medium)","            *set fight_momentum +2","            You press forward, fists snapping out in a quick barrage. Danny's movements are precise but lifeless. Like someone following a script two pages behind.","","            Glove meets fist. Glove meets guard. Glove meets ribs.","","            You've read his pattern. Your punches land clean. He doesn't adapt, his movements becoming predictable. ","        *else","            You press forward, fists snapping out in a quick barrage. Danny bends with your assault like bamboo in the wind. Your punches are deflected and intercepted, and his defence holds steady. But there's no aggression coming from him. No attempt to counterattack.","","            The storm ends. He remains.","    #Fight at his pace. See what he's trying to express.","        *gosub_scene utils increase_empathy","        *set danny_friendship +1","        You match his rhythm instead of breaking it. Let his slow counters arrive at his speed. You want to see what he's trying to achieve. He returns each strike with purpose, like he's honouring a memory.","","        The moment stretches. The crowd chants. You both stand taller.","","The first round continues with your probing attacks against Danny's formal, unwavering defence. The crowd's chant continues, the choir accompanying the combatants.","","You advance, and Danny launches an [i]Intercepting Fist[/i], a textbook Jeet Kune Do move designed to meet your attack. As you step in with your hook, his fist is still travelling to your previous position, completely whiffing. Your fist connects fully, rocking his head; his own strike hits empty air.","","For the first time, the crowd's chant dies.","","Danny staggers from the impact, but he doesn't collapse. He [i]folds[/i], welcoming gravity with dignity, hitting the canvas with a soft thud. He lies there, as if in prayer, dust clinging to his tracksuit where he fell.","","He stands up. The chant restarts.","","Steady inhale, steady exhale. His stance is perfectly aligned, as if he never fell.","","You land another combination. Jab, body shot, cross. Danny falls again. He gets back up before the referee starts the count.","","The chant grows. Deep, resonant.","","Until \u2014","","The chant vanishes. The rhythm vanishes. Your mind is no longer in the fight. It's somewhere else, waiting for your body to catch up.","","*gosub_scene utils show_fight_momentum","*page_break Out of sync.","You no longer hear the crowd.","","They've stopped. Danny's stopped too, mid-breath, mid-blink, mid-step. One heel lifted, just slightly. Frozen.","","So is the referee. So is the light. So is the dust in the air.","","And so are you.","","You take in the suspended world around you. A young fan in a yellow T-shirt, barely old enough to be here alone, sitting forward in his seat, eyes wide. The bookmaker, his expression somewhere between enlightenment and despair. The ceiling fan, blades paused mid-rotation.","","Your gloves are up. Feet planted. You could move if you wanted to. You're in control. But you don't have any [i]intention[/i]. You don't want to strike or dodge. You're just... uninterested in continuing.","*if highest_trait = \"analysis\"","    Body responsive, mind clear, but no goal to pursue.","*elseif highest_trait = \"composure\"","    There's no threat to manage. You simply [i]are[/i]. ","*elseif highest_trait = \"empathy\"","    The urgency fades. There's nothing that needs doing, in this quiet space.","*else","    *bug Invalid trait","","The absence of intention washes over you. You're simply here, in this moment, with no need to know how you got here. It feels empty, but not hollow.","","Movement would mean something. But there's no need for meaning. So you stay.","","*choice","    #You stay a moment longer.","        *gosub_scene utils increase_composure","        The desire to act returns gradually. You don't hurry it. You breathe. In. Out. In. Out.","","        Then you decide: you're ready.","    #You watch Danny's stance again.","        *gosub_scene utils increase_analysis","        He still hasn't moved. But you see it now. His feet, slightly too wide. His shoulders, hunched up. He's telegraphing his intentions.","","        You were trying to read his moves. But concealment was never the point. It's a loop, meant to be replayed again and again.","    #You look at Danny without disturbing the moment.","        *gosub_scene utils increase_empathy","        Whatever this moment is, it belongs to Danny, and he's sharing it with you.","","        You remain here for a while longer. You're not participating, not directly. You're just accepting his invitation.","","*page_break The world exhales.","Sound returns, slow at first, then all at once. The lights buzz. A banner shifts in the air.","","You haven't moved.","","Your guard is still up. Feet planted. Head steady.","","The crowd is watching. The warehouse holds its breath. A cough, faint and distant. ","","Danny hasn't moved. He gazes at you, patiently. Quietly.","","They all saw it. You were gone, somewhere.","","And they're still here. Waiting for your return.","","*set fight_momentum 5","*gosub_scene utils show_fight_momentum","","*choice","    #Recognise that Danny shared something with you.","        *gosub_scene utils increase_empathy","        *set danny_friendship +1","        His gaze tells you everything. He's been here before, in the strange space you just left. And he waited for you to find your way back.","    #Accept it without needing to explain it.","        *gosub_scene utils increase_composure","        *set danny_friendship +1","        You accept what happened without trying to explain it. Some things resist analysis. You breathe, let the moment settle. Whatever happened, it's part of you now.","    #Try to understand what just happened.","        *gosub_scene utils increase_analysis","        You analyse what just happened. Your body remained functional. But Danny's conviction, the crowd's reverence, the place itself \u2014 something about the whole situation affected you. Your intention evaporated.","","The chant doesn't resume. Not time for that yet. But the audience stays with you, silent and heavy.","","Fist pressed to palm, a nod. Then Danny moves. His [i]Side Kick[/i] arrives, flawless and beautiful. No power behind it.","","You absorb the kick on your guard. It's almost soft in its impact, but it fits the moment. You don't counterattack.","","The fight continues, in a new rhythm. Exchanging techniques. Comparing craftsmanship.","","You exchange a few more blows. Light contact. Heavy intention. Each strike lands as it should, neither too loud nor too quiet.","","*set fight_momentum +1","","*if highest_trait = \"analysis\"","    You've adjusted your responses. Efficiency, not effort. No need to dominate. Just understand.","*elseif highest_trait = \"composure\"","    You hold your ground. Your stance breathes now, no longer scaffolding but something alive. Every block, every counter, every blow, arriving at the right time.","*elseif highest_trait = \"empathy\"","    You read his breathing more than his movements. When he makes contact, it's not to harm. It's to connect.","*else","    *bug Invalid trait","","*page_break","The crowd doesn't cheer. But everyone is standing.","","The bell is close now. One last exchange.","","*gosub_scene utils show_fight_momentum","","*choice","    #Fight seriously. This is still a competition.","        *gosub_scene utils increase_analysis","        *set danny_friendship +1","        *if ((adj_mental * 0.5) + (adj_technique * 0.5)) >= ((dc_medium * 0.5) + (dc_easy * 0.5))","            *set fight_momentum +1","            You step forwards to meet Danny. There's no urgency now, only clarity. Your feet move gracefully, each step mirroring Danny. He's shared his Jeet Kune Do. Now you share your boxing.","","            Your ${jab} lands clean past his guard. Your cross follows, his counter whiffing again, as you both knew would happen. Clean, technical boxing.","","            Danny absorbs each controlled punch wordlessly. His movements remain formal, rehearsed, perfect. The circle completes.","","            In the closing seconds, you deliver a final one-two. The essence of boxing. It lands with a sense of finality, like solving a puzzle. Danny nods.","        *else","            Your feet move gracefully, each step mirroring Danny. There's no urgency now. He's sharing his Jeet Kune Do with you, so you share your boxing with him.","","            His guard absorbs your ${jab}. You follow with a cross, deflected by his parry. Next, you slip his straight lead punch, and you both reset. Technical boxing against disciplined Jeet Kune Do.","","            Your punches land on his guard or slide past into air. His strikes remain controlled, deliberate.","","            You deliver a final one-two. The essence of boxing. It lands smoothly on his flowing guard, deflected like water.","    #Respect the moment. Focus on your form.","        *gosub_scene utils increase_composure","        *set danny_friendship +2","        You match Danny's rhythm instead of pressuring him. His guard absorbs your ${jab}. You follow with a cross, deflected by his parry. Next, you slip his straight lead punch, and you both reset. Respectful exchanges that honour the moment he shared with you.","","        You continue the conversation. Jeet Kune Do. Boxing. Two ways to arrive at the same destination.","","        His strikes are controlled, deliberate. Your punches land on his guard or slide past into air. You could dodge his slow backfist, but instead you take it on your guard, a gentle impact that lands on your gloves.","","        The dance continues, neither of you wanting to break the rhythm.","","        Your eyes meet. A wordless acknowledgement.","    #Try to knock him down with a full-force uppercut.","        *if ((adj_toughness * 0.3) + (adj_power * 0.7)) >= ((dc_medium * 0.5) + (dc_hard * 0.5))","            *set danny_friendship -1","            *set fight_momentum +2","            You build tension within yourself, gathering intention like drawing a bowstring. One massive strike to shatter whatever this is.","","            Danny advances with a flurry of straight punches, his guard dropping as if welcoming your blow. Your uppercut launches forwards. It connects cleanly, fully, with Danny's chin. His head snaps back. He falls backwards and lands sitting. ","","            The crowd collectively inhales, caught between awe and reverence. Danny sits there in absolute calm, motionless as a statue. His eyes remain fully open, present, staring straight ahead. ","","            He rises at the count of seven, unhurried. The crowd rises to their feet, a thousand people in silent ovation.","","            He meets your eyes. There's no resentment there, but it's hard to tell what it is. Gratitude, maybe. Or relief.","        *else","            You build tension within yourself, gathering intention like drawing a bowstring. One massive strike to shatter whatever this is. ","","            Danny's hands move in slow circles as he readies for your assault. Your uppercut launches forwards. It flies through space, completely missing, like a letter addressed to someone who has long since moved away. You stumble forwards, off-balance, as Danny continues his slow retreat.","","            You reset your stance, breathing hard from the effort. You knew Danny wouldn't counterattack. The wrong time for that.","","            His expression hasn't changed. No acknowledgement of your attempt. Just the same practised movements.","","The final bell signals the end of the third round, the metallic clang absorbed by the thick, reverent silence.","","*page_break","You're not sure what you expected. Applause? Relief? Serenity?","","Instead, silence. Dense and gravitational. The referee raises your hand. The crowd doesn't respond.","","Danny stands beside you, unbowed. Shoulders square, eyes looking straight ahead, standing straight.","","Something gathers, something low and primal. Not a cheer. Not a chant.","","A thousand people on their feet, not in applause, but in acknowledgement. A tribute to one who gave so much, and keeps returning, again and again.","","It doesn't matter that he lost. The crowd is here to witness.","","Danny gave them something worth witnessing.","","*page_break","*if (danny_friendship <= 0)","    Danny doesn't look your way, his attention pulled elsewhere. Still, as he steps past you, there's a change in his posture. The way his shoulders settle. He knows you're watching, but he doesn't mind being seen.","*elseif (danny_friendship >= 1)","    As the noise rises, Danny turns slightly. A momentary glance, just long enough to acknowledge your presence. His bow includes you this time. Not personal, but respectful. A silent nod to what passed between you.","","    Then he turns again, facing the crowd. One hand to his heart, bowing to each side in turn. Still ritual. But now you know what it costs.","*else","    Danny stops. One hand rises. Not for the crowd, but for you. He touches his black wristband, then his heart. Then his hand extends, palm open. A gesture of welcome. A thank-you.","","You look down. Your arms are still tense, and your breathing is shallow. The fight is over, but something of what Danny shared remains with you.","","*choice","    #Stay with the feeling, without analysis or judgement.","        *gosub_scene utils increase_composure","        You don't try to give it a name. You just let it flow through your body, experiencing it without judgement. Your fists are still soaked with sweat. Your muscles pulse with residual energy, or maybe it's relief. Whatever it was, it's a part of you now. No need for explanations.","    #Think about this intangible feeling. Try to understand it.","        *gosub_scene utils increase_analysis","        The rhythm, the serenity, the restraint. Danny wasn't aiming for victory. He wanted to communicate something, to you, to the crowd. Defeat didn't matter. Only meaning did.","        ","    #Wonder how much Danny has sacrificed to become who he is now.","        *gosub_scene utils increase_empathy","        You imagine Danny, practising the same kick, ten thousand times. Meanwhile, the world moved on. How long does it take for a dream to die? Or maybe he never believed in it himself.","","As Danny leaves the ring, fans reach out. Not looking for autographs or selfies, but with open hands, just to touch, fingers brushing lightly against his shoulder. As if he's carrying something precious from the arena back into the world outside, for all of them.","","A fan tries take a selfie with him. He politely declines. \"Just here to train,\" he mumbles. He exits. ","","You walk out of the ring, through the prep room, out onto the street. A gentle wind blows, cooling the sweat on your neck. The night air doesn't feel like relief.","","*if highest_trait = \"analysis\"","    You saw the flaws in his techniques, the fixed sequences. The price of a man trying to embody an ideal. Yet by experiencing those flaws and inflexible patterns, your own intuition improved.","","    [i]A Boxing Insight emerges, subtle, but precise.[/i]","*elseif highest_trait = \"composure\"","    The fight no longer lingers in your muscles. Instead, you carry its lessons in your posture. Something in Danny's absolute conviction has straightened your spine.","","    [i]A Boxing Insight crystallises, born of understanding.[/i]","*elseif highest_trait = \"empathy\"","    You didn't beat him. You moved with him. Somewhere, in that rhythm that you both shared: a lesson learnt.","","    [i]A Boxing Insight. Not taught. Discovered.[/i]","*else","    *bug Invalid highest trait","*set boxing_insights_unspent +1","*set record_wins +1","","*return"], "labels":{"fight":1}},
"danny_subplot": {"crc":-838363438, "lines":["*label scene_introduction","*if danny_subplot_scene = 1","    Danny's easy to find online: dozens of forum posts analysing his philosophy, video clips with thousands of views, fan comments full of dragon emojis. But his physical presence is a different story. No contact information, no known gym affiliation, no way to reach the man behind the legend. If there's any way to reach Danny \"The Dragon\" Chan, it will involve your contacts in the scene.","    *if (danny_almost_lapsed)","","        Your leads are freshest right after the fight. Wait too long, and Danny's trail will go cold.","*elseif danny_subplot_scene = 2","    *if danny_plot_timer = 0","        Coach Lam handed you a piece of paper. Neatly folded, edges sharp. \"Kowloon Park, Chinese Garden. Morning.\" No signature. Lam shrugged, saying, \"Could be Danny. Could be someone else doing exercise in a yellow tracksuit. Your call.\" The message came through someone in the same circles you've been asking around in.","        *if (danny_almost_lapsed)","","            You have a time and a place. If you don't show up, you'll never find out if it's Danny.","    *else","        *if (danny_investigation_success)","            Your investigation at Pak Tin community centre paid off: booking records showing \"Chan\", locals who've seen someone in a yellow tracksuit, tai chi practitioners and fruit stall vendors describing a polite man. It's strong evidence of Danny's presence. But Danny himself remains out of reach. Returning now would cross the line from curiosity into stalking.","        *else","            Your investigation at Pak Tin community centre offered some tantalising clues: booking records showing a \"Chan\", a local who thinks she saw someone in a yellow tracksuit, fragments of a morning exercise routine. But each lead turned out to be inconclusive. Danny remains out of reach. ","            *if danny_plot_timer = 2","                It's not something you can rush. Returning now would cross the line from curiosity into stalking.","            *else","                You've done all that you can. What happens next isn't up to you.","*elseif danny_subplot_scene = 3","    *if danny_plot_timer = 0","        Danny invited you out for dinner. It's at a claypot rice stall. You recall it's a famous one, known for the quality of its crispy rice crust.","        *if (danny_almost_lapsed)","","            Danny's doesn't invite people to dinner often. If you don't make time for him, he'll assume you're not interested.","    *else","        Danny's gently turning down offers to meet up again. He says only, \"Needs time to cook.\"","*else","    *bug Danny subplot scene not found","*return","","*comment danny_friendship from danny_fight: -1 to 4","*label scene_choice","*if danny_subplot_scene = 1","    *comment earliest: chapter 4, first fortnight","    *comment danny_friendship from this chapter: 0 for accept, 0 for reject","    *comment cumulative danny_friendship after this chapter: -1 to 4","    *gosub event_1","    *set stat_mental %+3","    *set stat_energy +5","    *gosub_scene utils clamp_energy","    *comment danny_plot_timer is set to either 2 or 3 based on the investigation result","*elseif danny_subplot_scene = 2","    *comment earliest: chapter 5, first fortnight","    *comment danny_friendship from this chapter: 2-4","    *comment cumulative danny_friendship after this chapter: 1-8","    *gosub event_2","    *set stat_mental %+3","    *set stat_energy +5","    *gosub_scene utils clamp_energy","    *set boxing_insights_unspent +1","    *set danny_plot_timer 2","*elseif danny_subplot_scene = 3","    *comment earliest: chapter 6, first fortnight","    *comment danny_friendship from afterhours: 0-4","    *comment danny_friendship from this chapter: []","    *comment cumulative danny_friendship after this chapter: []","    *gosub event_3","    *set unlocked_danny_training True","*elseif danny_subplot_scene = 4","    *gosub event_4","*elseif danny_subplot_scene = 5","    *gosub event_5","    *set danny_subplot_status \"finished\"","*else","    *bug Danny subplot scene not found","*return","","*label event_1","*temp minutes_passed 0","*temp info_gathered 0","[i]MK Fight Gym[/i] buzzes with energy as you finish your evening session with Coach Lam. The scent of sweat, leather, and Tiger Balm lingers in the air as your ears register the sound of gloves and shins on heavy bags. You spot one of the regulars cooling down, a large, muscular guy who always brings a small pile of Japanese rice balls with him. You wait for him to finish his stretches and approach.","","\"Danny Chan?\" He stands up straight and loosens his shoulders. \"The Bruce Lee guy? I've heard about him, but he's never trained here.\"","","He leans in slightly. \"Heard he trains somewhere in Sham Shui Po.\" His eyes scan for familiar faces in the gym. \"Hey, Eunice! Where does that yellow tracksuit guy train now?\"","","A tall woman, now wearing thick glasses after removing her contact lenses, wipes her mouth with the back of her hand. \"Some community centre in Sham Shui Po, I think? Or maybe it was a sports ground. No, it was renovated just last year. Wait, actually, I think I've gotten that backwards. Pretty sure it's a community centre now.\"","","\"Early mornings. Tuesdays. Or Thursdays. Tuesdays and Thursdays just blend in together, you know?\" She shrugs and reaches for her water bottle. \"Or maybe it alternates?\"","","You don't interrupt. You just remember the information, chaotic as it is.","","The muscular guy nods. \"Kelvin said the same. But he thought it was an outdoors park, not a community centre.\"","","Eunice frowns. \"No, Auntie Ng insisted it was a community centre. True, she's not the most reliable one. Her tofu pudding is great though.\"","","Sham Shui Po. A community centre, maybe Tuesdays. Or Thursdays.","","*choice","    #Head to Sham Shui Po early on Tuesday to investigate.","        Have to start somewhere. You set your alarm for 5 AM. Should provide enough time to scout the community centres and maybe catch the breakfast crowd. Someone practising Jeet Kune Do in a yellow tracksuit at dawn should be fairly conspicuous.","","        You thank them for the lead and return to your stretches. Ankles still tight. Hamstrings need work too.","","    #Let it go. This is too vague to chase.","        *set danny_subplot_status \"rejected\"","        Unreliable gossip about someone who might be training somewhere in Sham Shui Po isn't worth losing sleep over. If Danny wanted to be found, he would have contacted you.","","        You thank them for the information and return to your stretches. Not every thread needs to be pulled.","        *return","*page_break","You breathe in the smell of coconut milk and diesel exhaust. There's no rush in Sham Shui Po, unlike in the downtown areas. Here, only the leisurely rhythm of people preparing for another long day. You pass by a dessert shop window, misty with condensation. Trays of red bean soup and mango pudding peek out from behind the glass, resting in their large metal trays.","","The Pak Tin community complex rises ahead, harsh green and white metal panels reflecting the morning light, flanked by ageing public housing blocks that are adorned with laundry strung out of the windows.","","Inside, past the entrance doors, the main hall opens into a vast, empty space, with high ceilings, scratched wooden floors, and lime green plastic chairs stacked along the walls. Overhead lights bathe the space in a white fluorescent brightness. At the far end of the hall, there's a raised stage framed by heavy velvet curtains. Even with all of these features, the room still feels vacant.","","No one in a yellow tracksuit. No one practising Jeet Kune Do or tai chi. No one here at all, in fact.","","So far, you haven't found any traces of Danny. The lack of evidence doesn't mean the rumours are wrong. But his trail feels more distant now.","","*choice","    #Study the hall, looking for evidence of Danny.","        *gosub_scene utils increase_analysis","        You sweep your eyes over the room. The floor is waxed and polished, and there are no scratches that would suggest martial arts practice. You scrutinise the green plastic chairs stacked against the wall. In one section, the chairs are pulled out more often, the floor wax worn away. Group exercises of some sort occur here regularly, though it's unclear whether Danny is involved.","    #Feel the mood in the main hall.","        *gosub_scene utils increase_empathy","        The fluorescent lights are on, fighting with the early morning sunlight. A harsh atmosphere. But this sterile hall demands nothing of its users. The green plastic chairs, the waxed wooden floor, the faint antiseptic smell, these would belong anywhere, in community centres, in elderly care homes, in school assembly halls. It's somewhere Danny would visit, precisely because it's so ordinary.","    #Absorb the silence. Expect nothing.","        *gosub_scene utils increase_composure","        The fluorescent lighting throws the court lines on the floor into sharp relief. Badminton in blue, basketball in red, some sport you don't recognise in green. You stand at the centre, where all the lines meet. You inhale the filtered air. Nothing comes to mind. Danny trains here, or he doesn't. ","","Now to colour in the rest of the map. Here in this building or in the streets nearby, you might find more clues. The residue of daily routines, the small details only apparent to those who've spent years in the neighbourhood. Several angles seem promising: the building staff who might know the regulars, or the shopkeepers and early morning exercisers. You could gather your thoughts, see if you missed anything in this sterile building. An hour to ask the right questions \u2014 if you know what they are.","*label search_carousel","","*if minutes_passed >= 60","    *goto carousel_finished","*elseif minutes_passed <= 9","    It's 7:0${minutes_passed} AM. ","*else","    It's 7:${minutes_passed} AM.","You'll need to leave at 8:00 AM to reach work on time.","","*choice","    *hide_reuse #Ask building staff about anyone practising martial arts.","        The reception desk is staffed by a disinterested middle-aged man in a rumpled uniform who yawns and dismisses your questions. \"No, nothing, sorry, bye bye.\" He stares blankly at the wall behind you.","","        A janitor in a Baguio vest overhears you and pauses her mopping. \"A tai chi group's here every morning at seven.\" She gestures vaguely at the hallway. \"A man wearing a yellow tracksuit? Not sure. There's a polite man who books the hall early sometimes. Good man, comes alone, cleans up after himself.\"","","        At the booking counter, you find a clerk who helps you look up the computer system. \"Here we are. Private booking under the name [i]Chan[/i]. Last Thursday at 7 AM.\" He shrugs.","","        \"He used to stay longer,\" the janitor comments. \"Now he leaves after an hour. Doesn't stop to chat any more.\"","","        She doesn't elaborate.","","        *if highest_trait = \"analysis\"","            Chan. Common name. By itself, not very useful. But the time and date match. A potential connection. Spending less time here suggests change of some sort. Maybe a busier schedule, maybe caution.","        *elseif highest_trait = \"empathy\"","            Chan. Common name. By itself, not very useful. But the routine changed. That's enough for now. You don't need to know why. ","        *elseif highest_trait = \"composure\"","            Chan. Common name. By itself, not very useful. The way the janitor told you about his reduced hours sounded sad. Like she was watching someone slowly fade away.","        *else","            *bug Invalid highest trait","        *set info_gathered +2","        *set minutes_passed +10","        *goto search_carousel","    *hide_reuse #Examine bulletin boards and booking schedules.","        *gosub_scene utils increase_analysis","        You peruse the bulletin board. The usual flyers for yoga, tai chi, badminton, and private tutoring. But near the top corner, obscured by a cooking class flyer, is a weekly printout for hall bookings. You focus on one entry that repeats every Tuesday and Thursday: \"Private booking \u2014 7:00 AM to 8:00 AM \u2014 no course listed.\"","","        *if highest_trait = \"analysis\"","            It's not proof. But it fits with the picture you're assembling.","            *set info_gathered +2","        *else","            It's not proof. But at least it's consistent with the rest of your knowledge.","            *set info_gathered +1","        *set minutes_passed +10","        *goto search_carousel","    *hide_reuse #Walk outside and chat with the tai chi practitioners and joggers at the park.","        *gosub_scene utils increase_empathy","        Outside, seniors move through a slow tai chi exercise on the basketball court. An elderly instructor leads the group, calling out poetic instructions: cloud hands, single whip. Their silent movements seem to create gentle currents in the morning air. You wait for them to finish and then approach.","","        \"Yellow tracksuit?\" A woman in a plain cotton T-shirt considers your description. \"I do see someone like that sometimes. I'm pretty sure he wears yellow tracksuit bottoms, at least.\" She turns to a man who's adjusting his wire-rimmed glasses. \"You remember? The serious young man?\"","","        He nods. \"Very polite man. Always walks into the community centre alone. Stands tall, back straight. Never seen him checking his phone, not even once.\"","","        *if highest_trait = \"empathy\"","            \"There's something slow about him,\" the woman says. \"I don't mean how he moves. It's like... nothing touches him.\"","","        They smile at you and pick up their tai chi swords. You bow slightly as they return to their practice.","        *if highest_trait = \"empathy\"","            *set info_gathered +3","        *else","            *set info_gathered +2","        *set minutes_passed +20","        *goto search_carousel","    *hide_reuse *if (minutes_passed >= 10) #Make small talk with the fruit and congee vendors.","        *gosub_scene utils increase_empathy","        The congee stall owner barely looks up from her massive pot, ignoring the steam wafting over her face. \"Yellow tracksuit? Maybe. Hard to remember everyone. Do you want some congee or not?\" She adds some raw beef slices to one bowl, then ladles the thick porridge over them.","","        You have more success with the fruit vendor. \"Oh, the Bruce Lee guy? Comes by sometimes. Always the same thing: one apple, one orange. Exact change.\" He shows you something that looks like a Jeet Kune Do side-step, hands down by his hips, bouncing from one foot to the other. \"Very polite but doesn't chat.\"","","        \"When does he arrive?\" you ask.","","        \"Early morning. Sometimes he comes twice a week, but sometimes he doesn't show up for an entire month.\" He offers you a mango.","","        You decline politely and buy an apple and an orange instead. Exact change.","","        *if highest_trait = \"empathy\"","            As you hand him the cash, he leans over, voice low. \"There's something strange about him though. Like he's always ready for bad news. Always prepared for the worst. You know that look?\"","","            He adds, \"One time, he took a call. Listened for a long time. Then he just replied, 'okay'. Stood there and didn't move for a while. It felt like the whole world went silent.\"","","            He glances sideways, then straightens up.","        *else","            As you hand him the cash, he adds quietly, \"He always looks at the sky before he leaves.\"","","        Someone who comes early, alone, and pays with exact change. Never makes small talk. You don't know whether this is Danny or not. You thank the vendor, then make your way back to the community centre.","        *if highest_trait = \"empathy\"","            *set info_gathered +3","        *else","            *set info_gathered +2","        *set minutes_passed +15","        *goto search_carousel","    *hide_reuse *if (minutes_passed >= 30) #Wait by the doors. Observe the clientele.","        You ease into a green plastic chair near the entrance. The morning traffic picks up: women with yoga mats, a janitor wheeling cleaning supplies, a pair of badminton players. Outside, children in school uniforms pass by.","","        No one in a yellow tracksuit. There are a few people in athletic wear, but they take the stairs to the basketball courts. You note how subdued they are. Queuing, checking boxes, submitting papers. Defeated by the building itself.","","        Ten minutes pass. No yellow tracksuit. You sense the rhythm: sports gear, school uniforms.","","        Only afterwards do you realise you were reading people's gaits. The same way you do in fights.","","        *set minutes_passed +10","        *if (minutes_passed >= 50)","            You check your phone. Time to leave soon, whether Danny appears or not. ","        *else","            You check your phone. Time to try something else, whether Danny appears or not. ","        *goto search_carousel","    *hide_reuse *if (minutes_passed >= 30) #Sit quietly. Consider why Danny might practise here.","        *gosub_scene utils increase_composure","        You find a chair near the wall and observe the morning activity. Early risers, getting in their exercise before the day's work. Maintenance staff pushing a large cart. The PA system with its garbled announcements.","","        Your thoughts settle. If Danny is indeed here, what would attract him to this place? Simple: it doesn't demand anything from him. A place where he can be Danny Chan, not \"The Dragon.\"","","        Any community centre would suffice. But this one sits in the heart of working-class Sham Shui Po. Unpretentious, honest. Even if he were to be recognised by others, they would give him his space.","        *if highest_trait = \"composure\"","            You understand the appeal. An ordinary space, capable of extraordinary acceptance.","            *set info_gathered +2","        *else","            *set info_gathered +1","        *set minutes_passed +10","        *goto search_carousel","","*label carousel_finished","*page_break","The booking terminal continues to loop idly. Outside, commuters brave the morning rush, queuing for double-decker buses and MTR trains with weary efficiency. It's 8:00 AM.","","*if info_gathered <= 5","    *set danny_plot_timer 3","    *set danny_investigation_success False","    You didn't find proof of Danny's whereabouts. Just a handful of fragments: a \"Chan\" on the booking sheet, some unreliable secondhand accounts, the vague outlines of a routine revealed through repetition. Weak signals, all of them, but they rhyme.","*else","    *set danny_plot_timer 2","    *set danny_investigation_success True","    You didn't find proof of Danny's presence here. But the pattern is unmistakable: regular early bookings, multiple mentions of a polite man, secondhand stories. All of it fits together. Danny. Probably.","","You sit for a while longer. There doesn't seem to be anything further to do. An understanding emerges. A sense of why Danny's hard to find.","*if highest_trait = \"analysis\"","    The inconsistencies aren't noise. They're the pattern. He exists, in indirect observations, secondhand sightings, half a routine. Not deliberate evasion. Just declining to leave a consistent signature.","","*elseif highest_trait = \"composure\"","    Some people want to be seen. Danny prefers the opposite. You came to discover his routine, his habits. But he'll make contact only when he chooses to.","","*elseif highest_trait = \"empathy\"","    Many people here recall him. But no one claims to [i]know[/i] him. Always polite, but always careful.","","Eventually, you stand. Outside again, you're hit with exhaust fumes, fragrant steam from breakfast stalls, the press of the crowd. As you reach the MTR escalator, your reflection stares back at you from a glass panel. For a moment, the tilt of your shoulders is unfamiliar. Quieter, deliberate. Resigned, maybe.","","The train arrives. You step on.","","*return","","*label event_2","The smog hits you as you exit the MTR at Tsim Sha Tsui into the early morning air. The mosque on Nathan Road emits a faint call to prayer, already drowned out by the rumble of traffic. You turn onto Haiphong Road, where the electronics shops are hidden behind steel shutters at this hour, and pass a gaunt elderly woman struggling with a huge pushcart stacked high with dirty cardboard. You step around her without slowing down.","","The traffic fades as you continue past the congee vendors, with only the occasional delivery truck trudging down this smaller street. You enter Kowloon Park at the side entrance, where the stone wall gives way to a sloped expanse of asphalt and wet earth. The trill of a songbird comes from somewhere ahead. The city noise has faded entirely. Around the bend: a dozen white-haired enthusiasts, absorbed in tai chi, wushu, or dance. And there, you see him. Seated on the long stone bench by the moss-covered pond, in a simple black cotton shirt and trousers, straight and motionless.","","Danny sees you and stands. You're suddenly unsure what to do \u2014 go for a handshake? Bow slightly? You settle for a small nod. Danny doesn't smile, but he gestures to the bench, and you both sit down, silently watching the morning exercisers perform their tai chi routines.","","You're not entirely sure why you want to meet Danny. But it feels important, somehow.","","*choice","    #Spirituality. Danny's conviction, the way he never wavers. Learning from this would be nourishing.","        You loop through your fight with him again. Sure in defeat, unwavering, somehow making you not want to knock him down. An absolute certainty in himself, something you don't possess and may never possess. But even absorbing a part of this could strengthen you.","    #Curiosity. An itch that doesn't go away. The need to know what sustains Danny through his defeats.","        How can Danny continue, undaunted, when the outcome is always the same? What inner force sustains him, in the absence of a path to victory? He's aware that his technique doesn't match up, and yet he persists. You must know why.","    #Boredom. Ennui. Alienation. His sense of purpose contrasts with your restlessness.","        You're enduring a corporate job, bearable but not meaningful. Danny's enduring an unending series of losses, yet he takes them in stride and finds purpose in defeat. You're idly puzzled by why he's so content with his path.","","Danny quietly watches the group perform graceful circular movements. You stay seated beside him, hands on your lap, patiently taking in the scene.","","Minutes pass. One of the tai chi aunties wobbles in crane stance. Danny rises smoothly and adjusts her form with a gentle touch at her shoulder. She smiles at him and mouths a silent thanks. Danny returns and sits down next to you.","","The group finish their routine, hands resting at their sides. They acknowledge Danny with respectful nods. Then they collect their water bottles and towels, dispersing quietly, leaving the Chinese Garden to you, Danny, and some elderly men tending to a songbird in a bamboo cage. Danny continues to sit in silence, gazing straight ahead.","","*choice","    #Comment on the peaceful atmosphere here.","        \"This place is very peaceful,\" you say.","","        Danny nods, and extends his hand, palm up, towards the tai chi group. \"They come here every day.\"","","        Both of you settle into a comfortable silence, watching the exercisers without any commentary.     ","        ","    #Wait for Danny to speak.","        *set danny_friendship +1","        You remain quiet, letting the moment breathe. Whether Danny wants to open up or not, rushing things won't help.","","\"${first_name}. When people seek me out, usually they want a curiosity to gawk at. That's not right for me. I just want to train.\"","","He stands up and motions at the path to the Sculpture Walk. You walk at a relaxed pace, passing by the outdoor amphitheatre, the picnic lawn where the sprinklers catch you both in a fine mist, enjoying the silence. Upon your arrival, you see a group of younger fighters practising some form of wushu. One of them nods at Danny and salutes him, fist over palm, which Danny returns respectfully.","","Danny stands at the edge of the practice area and continues quietly. \"I don't mind being recognised within the underground fighting circuit. People see me as a symbol of something. But I don't want that in my personal life. Outside the circuit, I'm just another person.\"","","*choice","    #\"The tai chi group seemed to know you. Do you come here often?\"","        You nod politely to acknowledge Danny's wishes. The tai chi group recognised him, and he seemed happy with that. He's not looking for complete anonymity. But you understand. These people aren't burdening him with expectations. You file away the information for later.","","        \"The tai chi group seemed to know you. Do you come here often?\"","","        \"Not every day. Maybe once a week. I learn a lot from just being here.\"","","    #\"What do you see when you watch them practise?\"","        You nod politely to acknowledge Danny's wishes. The tai chi group recognised him, and he seemed happy with that. He's not looking for complete anonymity. But you understand. These people aren't burdening him with expectations. You file away the information for later.","","        \"What do you see when you watch them practise?\"","","        Danny thinks for a while before answering. \"Repetition.\"","","    #\"Why keep a low profile when most fighters seek glory?\"","        You nod politely to acknowledge Danny's wishes. The tai chi group recognised him, and he seemed happy with that. He's not looking for complete anonymity. But you understand. These people aren't burdening him with expectations. You file away the information for later.","","        \"Why keep a low profile when most fighters seek glory?\"","","        \"Glory doesn't teach you anything.\"","","The silence stretches. You don't hurry the moment. After a while, Danny speaks again.","","\"I was at the workshop in Wan Chai when Ah Lam struck up a conversation with me. Your coach. He said you were looking for me, actually went to Sham Shui Po and politely asked around. Vouched for your character. So I said, since you think highly of ${him}, I'd like to meet ${him} properly.\"","","No mention of how he picked a public place where he could observe you first, with multiple paths to leave if needed.","","\"${first_name}, I enjoy your company. But I can't offer you anything. You must know that I don't win fights. Neither can I teach you how to win. And I don't think training Jeet Kune Do with me would improve your boxing technique.\"","","*choice","    #Consider why Danny would agree to meet you, but then refuse to train with you.","        *gosub_scene utils increase_analysis","        You analyse the sequence: your initial fight, your investigation in Sham Shui Po, his message passed through intermediaries, his explanation and refusal. One detail stands out \u2014 most recently, he took the initiative, yet now he's shutting you down pre-emptively.","","        Conclusion: he doesn't want to train you, but he's interested in some other form of rapport.","    #Settle with the quiet conviction shown in Danny's words and demeanour.","        *gosub_scene utils increase_composure","        You notice his posture, his expression. No change from baseline. He won't be easily swayed from his decision.","","        No matter. There are other reasons to know someone. Now to discover what they might be.","    #Understand what lies behind Danny's refusal, whether it's fear of disappointing you or something else.","        *gosub_scene utils increase_empathy","        He doesn't seem apologetic or regretful. Your sense is that he really believes that training you wouldn't be right. Unlikely to be a matter of ability. More likely a discomfort with taking on the role of teacher.","","Danny doesn't say anything further. He sits alongside you, on the stone bench, continuing to take in the morning scene.","","A procession of two dozen middle-aged women, most wearing silk scarves and colourful tracksuits, parade into the clearing. The leader sets down a wheeled speaker the size of a carry-on suitcase and assembles the group into formation. As they begin a [i]dama[/i] dance, the speaker fills the air with cheerful pop music. The tai chi practitioners give them a resigned look and relocate elsewhere.","","Danny stands up and quietly turns his head towards the path. The insistent beat of the music fades gradually behind you, or maybe it's not even there any more. You follow him towards the fitness stations, matching his pace.","","You find a low stone ledge and you both sit down. The air is damp and earthy here, near the lotus pond, and irregular squeaks reach your ears from the elderly man at the leg press station.","","Danny draws your attention to a few middle-aged health enthusiasts at the reflexology track.  It's a narrow concrete path embedded with irregular stone pebbles, each about the size of a walnut. Each person takes off their shoes and walks gingerly along the pebbles, wincing from the pain. Danny observes, \"The pebbles dig into the soles of your feet. It hurts every time.\"","","Slight pause. \"They keep on walking every day.\"","","You consider his meaning. Seems straightforward. Still, it's somehow unexamined.","","*choice","    #Comment on the persistence of the reflexology enthusiasts.","        *set danny_friendship +1","        You say to Danny that these people certainly don't look like they're enjoying it, and it's admirable that they return day after day. A smile plays across Danny's lips.","","        \"Admirable in its own way, is it not?\"","    #Question why they choose this discomforting form of therapy.","        You say to Danny that these people don't look like they are having fun. Surely, they could find some other therapeutic method that is more pleasant. Danny is silent for a moment, eyes looking straight ahead. He breathes out slowly. Then he replies, \"Yes, but they choose it freely.\"","    #Thank Danny, then watch in silence.","        *set danny_friendship +1","        You thank Danny for his observation, then continue to watch the walkers. Some of them lightly place their feet one ahead of the other, slowly shifting their weight. Others power through at a regular walking pace, grimacing as they do so. Danny glances at you, and the briefest smile plays across his lips.","","Danny stands to leave, then pauses. \"Good to meet you properly, ${first_name}. Until next time.\"","","You nod, seated, and watch him walk steadily towards the main path. He doesn't look back.","","The sun climbs higher into the sky, warming your face. You absently watch the exercisers, as you replay the conversation with Danny. Nothing immediately solidifies. You wonder about Danny's approach. Then, your attention is slowly drawn to activity near the fitness stations.","","A young, athletic man enters the fitness area at a rapid jog, sweaty from his run. Setting down his plastic hip flask, he moves directly to the pull-up bar and pumps out five rapid pull-ups. Taking a few breaths, he transitions to the incline sit-up bench and cranks out twenty sit-ups. ","","You watch his enthusiastic movements. Maximum results, minimum effort. A different tempo entirely.","","[i]Only later will you notice: a Boxing Insight had taken shape, on its own.[/i]","*set danny_friendship +2","*return","","*label event_3","Meets Danny, they have a meal together. Wait 2 hours for claypot rice","E.g.","You watch the vendor layer the ingredients in silence: a glug of oil, then raw rice, already soaking in broth. The pot hits the flame. A hiss starts low and builds slowly \u2014 steam condensing around the lip.","","Danny doesn't shift. His gaze stays fixed on the pot, not impatient but tracking something invisible. You follow it too, now \u2014 the gradual tightening of scent, the curl of sliced sausage at the edges.","","Ten minutes later, the vendor cracks the lid, stirs once, and reseals it. A rustle of crust at the base. The smell changes \u2014 deeper now, almost bitter.","","Ninety minutes in, the vendor opens the claypot again \u2014 this time for real. He stirs gently, lets the edges catch a little longer, then seals the lid for the last few minutes. Danny hasn't moved. He watches the process like it's a form being executed.","","\"They cook the rice from raw,\" he says. First words all night.","","He doesn't elaborate. Doesn't need to.","","Have the PC glance at their phone earlier \u2014 show their discomfort with the wait, in contrast to Danny.","","Let the vendor glance at Danny knowingly \u2014 suggesting he's a regular or simply one of the few who waits without complaint.","","A small beat after eating, like:","","Danny chews slowly, eyes half-lidded. No commentary. No approval. Just the kind of silence that means the thing met expectation.","*return","","*label event_4","*return","","*label event_5","*return"], "labels":{"scene_introduction":0,"scene_choice":34,"event_1":70,"search_carousel":126,"carousel_finished":247,"event_2":276,"event_3":402,"event_4":426,"event_5":429}},
"chloe_fight": {"crc":-271200670, "lines":["*label fight","*temp dc_easy 13","*temp dc_medium 18","*temp dc_hard 24","*temp struggle_physical 0","*temp struggle_emotional 0","*temp struggle_insight 0","*temp struggle_total 0","*temp struggle_time 0","*temp struggle_trait_bonus 0","*temp difficulty_check 0","*temp no_quarter_state \"unaffected\"","*temp match_result \"unknown\"","*set fight_momentum 5","*set trait_bonus_amount 2","*set upgrade_multiplier 4","","The door clicks shut behind you, deadening the street noise. The Cauldron. It looks like it was once a yoga studio, with a waxed wooden floor and tall mirrors along one wall. Now, the mirrors are cracked and pasted over with promotional flyers and fight cards, while the floor is gouged and scarred. Noisy, rusting tower fans churn at the corners, and below each one is a battered speaker that thumps bass through your ribs.","","At the centre is a Muay Thai ring, seven metres square. Worn canvas, four rows of ropes in red and blue, corner posts wrapped in dirty padding. A row of thin metal barricades separates the ring from the crowd, the kind the city stockpiled and never quite put away. The air conditioner wheezes from a single ceiling unit, losing to the July heat and the crowd of about a hundred spectators. Cantonese fills the air, expletives and banter tossed back and forth.","","The referee's at a folding table set against the far wall. He's glued to his phone as he shoves the last bite of a [i]char siu bao[/i] into his mouth. His official T-shirt sports a name badge with \"REFEREE\" printed on it, and hangs untucked over his food-stained jeans.","","*choice","    #Sense the energy in the room. See what the crowd is looking for.","        *gosub_scene utils increase_empathy","        You survey the crowd from your corner. It's not the usual pre-fight energy. Feels sharper. Their eyes dart around, like they're looking for something else. A few of them size you up, eyes narrowed.","","    #Shut out the noise. Concentrate on the fight.","        *gosub_scene utils increase_composure","        You straighten up in your corner of the ring, letting the commotion wash over you. Cracked mirrors, casual refereeing, metal barricades. Different, but it doesn't change what you're here to do. You breathe out, and centre yourself.","","    #Review the arena: the crowd, acoustics, layout.","        *gosub_scene utils increase_analysis","        The crowd shouts and jostles, but they're separated from the ring by the barricades. The music is excessive, but it won't matter after the opening bell. The referee's table is far from the ringside. Most interesting is the ref's indifference.","","Heads turn towards the entrance. Voices yell and scream, but it sounds more like habit than surprise.","","Chloe \"Wildcard\" Lee bounces through the doorway, her footsteps landing hard and loud on the wooden floor. She's around 5'4\", young, maybe early twenties, lean but solid. Her hair's in a blunt bob, sections clipped back with black snaps, the rest stiff with gel that reflects the harsh white light.","","She's wearing a beige Lululemon sports bra, the logo ripped off with just the outline visible. The leather on her MMA gloves is flaking off. Her Muay Thai trunks are real silk, but it's frayed and worn. Expensive gear, zero upkeep.","","She spots you. \"Someone new! This will be fun.\" Her Cantonese sounds too clean, like she learnt it from TV.","","She shadowboxes in place, exhaling loud \"Sshh sshh! Soo soo!\" sounds with her punches. The crowd cheers. Someone yells her name. She blows a kiss at the ceiling above them.","","You slip through the ropes. Chloe vaults over them and lands with a thud, before snapping upright. She flashes you a smile.","","The referee's made his way to ringside, looking like someone just woke him up from a nap. He taps his cheap microphone, which makes the speakers squeal painfully. Sighing loudly, he switches off the mic and mumbles at the floor. \"Okay. Lee versus ${last_name}.\"","","He waves his hand once, barely lifting it past his waist. \"Fight.\"","","*page_break","*if (eric_subplot_scene >= 2)","    Chloe bounces on her toes, hands loose at her sides. \"Wait, wait, wait,\" she says, switching to English. \"You're Eric's star pupil.\"","","    She throws a wild haymaker without even trying to close the distance. You don't bother responding.","","    \"Did he teach you that meditation crap yet?\" She launches an elbow strike, again at empty air, then steps back and grins. \"Harmony this, harmony that. Like, please.\"","*else","    Chloe bounces on her toes, hands loose at her sides, then switches to English. \"You're that office drone who beat Danny Chan last month? Wow, standards have really dropped.\"","","    She throws a wild haymaker without even trying to close the distance. You don't bother responding.","","    \"Let me guess, you found your inner peace after beating him?\" She launches an elbow strike, again at empty air, then steps back and grins. \"So spiritual now.\"","","You circle carefully, guard up. Her stance shifts from orthodox to southpaw and back, the weight distribution all wrong. You advance, lead hand ready, but she drifts to the side and the angle closes.","","*gosub_scene utils show_fight_momentum","","*choice","    #Establish your ${jab} and control the range.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *set upgrade_bonus (upgrade_multiplier * jab_level)","        *if (((adj_technique * 0.6) + (adj_mental * 0.4)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.7) + (dc_easy * 0.3))","            *set fight_momentum +1","            Your ${jab} snaps out as she saunters into range. She twists away at the last second and it barely clips her face. She wipes her mouth with the back of her glove, grinning.","","            *if eric_subplot_scene >= 2","                \"Textbook jab. Eric would be so proud.\"","            *else","                \"Jab. So interesting. Show me the one-two next!\"","","            She fires a quick, lazy elbow that you absorb on your guard, then skips back out. Still bouncing, still talking.","        *else","            *set fight_momentum -1","            Your ${jab} snaps out as she ambles forward, but she isn't where you expected her to be. Her sloppy footwork carries her inside, and a knee drives up. You lean back, but it still lands on your ribs with a dull thud.","","            \"Whoops!\" she laughs, skipping back out. \"Lucky shot!\"","","            Her approach seemed wild, but in hindsight, she never lost her base.","","    #Pressure her with your ${flurry} and force her to respond.","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *set upgrade_bonus (upgrade_multiplier * flurry_level)","        *if (((adj_power * 0.5) + (adj_technique * 0.5)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.8) + (dc_hard * 0.2))","            *set fight_momentum +2","            You wait until she switches her stance again, and rush forwards with your ${flurry}. Caught square, she backpedals, her guard suddenly tight. Your shots land on her arms, shoulders, one of them finding her ribs. She's no longer laughing.","","            She stumbles, foot snagging on nothing. You advance \u2014","","            And her rear foot plants hard. The stumble flows into a forward drop. Arms wrap around your neck. She shoves you to the side, creating space again.","","            \"Easy with the punches there, champ,\" she calls out. Her eyes remain sharp.","        *else","            *set fight_momentum -1","            You rush forwards with your ${flurry}, but she slips one way, dodges another, bobs and weaves. You can't pin her down, and she's throwing out wild counters that somehow make it past your guard.","","            \"Easy with the punches there, champ,\" she calls out. You launch another flurry, but she's already gone, dancing to the side as she tags you with a careless hook. A teep catches you in the stomach, pushing you back. She winks at you with a crooked grin on her face.","    #Study her patterns, reading what's bait and what's real.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *if (adj_mental + trait_bonus_applied) >= dc_medium","            *set fight_momentum +1","            You hang back, watching. There. She moves her weight back when showboating, pushing the distance. But it locks her in place.","","            She turns her head and shoulder for an exaggerated spinning backfist. All show \u2014 her back leg is rooted. You dart in and land a clean body hook.","","            \"Oof!\" She winces, breath hissing out. Then she beams at you. \"You can read!\"","","        *else","            *set fight_momentum -1","            You hang back, watching. You can't spot any pattern. Roundhouse kicks, low kicks, she doesn't let you maintain range.","","            \"Try to keep up!\" she laughs, mixing in punches and elbows from all angles as she advances. The barrage forces your arms up. As you're watching high, a teep catches you in the stomach, pushing you back and forcing out your breath.","","\"You're fun,\" she says during a brief separation. She's not even breathing hard. Her gaze flicks to your midsection before she looks back up. Measuring range?","","She flashes you a grin, eyes too bright to match the smile. But low kicks keep peppering you, chopping at your thigh. You're forced to square up, losing your natural angles. The grin is still there, like she forgot to drop it, even as the kicks keep coming.","","*gosub_scene utils show_fight_momentum","","*choice","    #Read her mood. \"You're enjoying this.\"","        *gosub_scene utils increase_empathy","        She pauses for a moment, eyebrows narrowed. A flash in her eyes.","","        Then the grin returns. \"Of course I enjoy fighting against such a worthy opponent!\"","","        Hard to tell if she's mocking you. Or herself.","","    #Stay silent and adapt.","        *gosub_scene utils increase_composure","        *set chloe_friendship +1","        You adjust: tighter guard, careful distance management, controlled pressure. She notices immediately.","","        \"Switching gears? Good.\" She bounces on her toes, hands out in a long guard.","","        Genuine appreciation. Unexpected.","","    #Wait for her to show off, and exploit the openings.","        *gosub_scene utils increase_analysis","        *set fight_momentum +1","        You hang back, reading her movements. She shuffles forward \u2014 you tag her with a step jab.","        ","        \"Hey! That's not fair?\" Her voice pitches higher.","","        She drops for a low kick, but retreats the moment you move in. She's already adjusted.","","Chloe comes at you again, jab into roundhouse, guard snapping into place to receive your counterpunch. She slips your cross, peppers you with two body shots that you barely block.","","Clean, sharp strikes and orthodox weight transfers. But she plays with the spacing, closing in and floating away. You can see it happen, but your adjustments come too slow, like your body is reacting on a delay. The seconds stretch out, although she doesn't manage to land a decisive blow.","","Then the bell rings, ending the round.","","*page_break","","You exhale out of habit. Your arms relax by your sides.","","Then you notice Chloe hasn't moved.","","Slow, quiet steps in your direction.","","The referee's untangling a pair of over-ear headphones. He slips them on and bops to an invisible beat. From his trouser pocket, he pulls out a laminated \"Do Not Disturb\" sign and slips it over his microphone like it's a hotel doorknob.","","You don't register the sweep until you're already down.","","Your back hits the mat with a soft thud. The canvas smells of sweat and disinfectant. Then she steps up. [i]Onto[/i] you.","","*page_break","","Her heels press hard into your abdomen. The balls of her feet land just below your ribs.","*if (highest_trait = \"composure\")","    *set struggle_trait_bonus 2","*else","    *set struggle_trait_bonus 0","*if ((adj_toughness * 0.8) + ((adj_mental * 0.2) + struggle_trait_bonus)) >= ((dc_medium * 0.6) + (dc_hard * 0.4))","    *set struggle_physical +1","    *set struggle_emotional +1","    You partially tense your core, just enough to steal one breath before her weight settles fully. She leans forward, pressing your diaphragm. The breath rushes out.","*else","    She rocks back and forth. Your breath is forced out in shallow gasps, a soft wheeze escaping with each exhale.","","You're pinned to the canvas. The crowd doesn't cheer. Silence. The only sound is the rattle of the air conditioning and your own desperate breathing.","","You don't know what's going on. Is it punishment? Performance?","","Hard to say, with the air squeezed out of you.","","*set fight_momentum -1","*gosub_scene utils show_fight_momentum","","*label struggle","*set struggle_time +10","*if (struggle_time <= 10)","    *page_break Can't breathe.","    Chloe's weight presses down into you. You don't control your breath any more.  Each time she shifts her weight \u2014 slightly forward, slightly higher \u2014 the pressure moves from your stomach to just beneath your chest. You feel it press down all across your solar plexus. Not a sharp pain. Just suffocating force.","","    You try to brace, but there's no air to brace with. Your core remains slack, unable to draw air to tense. You can't [i]do[/i] anything.","","    Somewhere above you, Chloe watches. You can't see her face. Just feel the subtle movements of her feet, the weight redistributing, like she's tuning an instrument. Her pressure avoids your liver, stays below your ribs. She knows exactly where to press. It's a constricting force designed to control your very breath.","","    \"You're feeling something,\" she says.","","    A rising swell of panic starts to flood your awareness.","","    *gosub_scene utils show_fight_momentum","","*elseif (struggle_time <= 20)","    *page_break Endure.","    Chloe looks down at you. A small smile forms on her lips. Not cruel. More like a child who's finally beaten a difficult level.","","    She rocks back on her heels. Air rushes into your lungs, a sharp relief. You inhale too deeply out of reflex.","","    Then she shifts forward again. You don't get to use the air. It's all forced out by her systematic assault. Chloe studies every flutter of your breathing, every strained inhale. ","","    Breathing should be automatic. Now it runs on her schedule.","","    You try to draw a breath. Doesn't work.","","    Your body doesn't want to try anything now. Lungs struggling. Shallow panting.","","    *if (struggle_insight >= 2)","        Some part of you notices that she's not trying to harm you; she's moving in sync with your reactions, making calculated adjustments.","    *elseif (struggle_emotional >= 2)","        Through the haze, you catch a glimpse of her face, her steady eyes, her frown.","    *else","        Despite trying everything, you can't dislodge her.","","    You need this to stop.","","    Out of the corner of your awareness, you see the referee fumbling with his headphones, like he's trying to remember why he's here.","","    *gosub_scene utils show_fight_momentum","","*elseif (struggle_time <= 30)","    *page_break Time passes.","    The referee has finally removed his headphones. He's staring blankly at the \"Do Not Disturb\" sign in his hand like he's trying to remember what it's for.","","    Your body has stopped fighting the weight. Your chest rises and falls, but not on your terms. A weight shift that steals your breath. Then a sliver of air, before another compression empties your lungs again.","","    You're pinned in place, your body unresponsive.","","    Chloe leans in one last time.","","    You don't know what you're feeling now. Like your awareness isn't inside your body, and you're observing all this from far away.","","    *gosub_scene utils show_fight_momentum","","*else","","    *gosub_scene utils show_fight_momentum","","    *page_break Move on.","    *goto round_2","","*choice","    *hide_reuse #Focus. Steady yourself first.","        *if (highest_trait = \"empathy\")","            *set struggle_trait_bonus 2","        *else","            *set struggle_trait_bonus 0","        *if (adj_mental + struggle_trait_bonus) >= ((dc_easy * 0.5) + (dc_medium * 0.5))","            *set struggle_emotional +2","            You try to clamp down on the panic. You take in the small breaths of air she allows you. It becomes a challenge to endure, not an overwhelming threat.","","            Chloe notices.","","            \"Most people panic when they realise how helpless they are. They break down. You're just... dealing with it.\" She says it softly.","","        *else","            *set fight_momentum -1","            You try to take in air, but your body's already decided to panic. Shallow air, stuck at the top of your lungs. Each attempt at focus crumbles under her weight pressing into you.","            ","            Pinned. Breath stolen.","","            A part of your brain insists that this is just a tactic. Yet the sensation floods your mind, overriding conscious thought.","","        *goto struggle","","    *hide_reuse #Try to understand why she's doing this.","        *if (highest_trait = \"analysis\")","            *set struggle_trait_bonus 2","        *elseif (highest_trait = \"empathy\")","            *set struggle_trait_bonus 1","        *else","            *set struggle_trait_bonus 0","        *if (adj_mental + struggle_trait_bonus) >= ((dc_easy * 0.4) + (dc_medium * 0.6))","            *set struggle_insight +2","            She bears down with her full weight, adjusting her position, but it's a gradual movement. Keeping the pressure steady, not driving it in all at once. ","","            She's tracking your responses \u2014 the cadence of your breath, the redness in your face. Rocking back when your breathing stops, pressing down when you recover.","","            Reaction. She wants your reaction. She needs it.","","        *else","            *set struggle_insight +1","            She bears down with her full weight. She's tracking your responses \u2014 the cadence of your breath, the redness in your face. Rocking back when your breathing stops, pressing down when you recover.","","            What does she want? You can't be sure. ","","            You sense a need driving her, a hunger to feel... something.","","        *goto struggle","","    *hide_reuse *if (struggle_time >= 20) #Let her get comfortable. Then try to disrupt her balance.","        *if (highest_trait = \"composure\")","            *set struggle_trait_bonus 2","        *else","            *set struggle_trait_bonus 0","        *if ((adj_toughness * 0.6) + ((adj_power * 0.4) + struggle_trait_bonus)) >= ((dc_medium * 0.7) + (dc_hard * 0.3))","            *set struggle_insight +1","            *set struggle_physical +1","            You go still, just breathing shallowly, nothing else. She moves back onto her heels, giving you a breath. That's when you move. A quick jerk of your hips to one side, the most you can manage under her weight.","","            She catches the movement and tightens her core, knees bending slightly. Just a half second before she's back into position. But it's enough for one quick, clean inhale. Relief, for a moment.","","            \"Hmm.\" She widens her base and presses forward again. The air leaves you. But her weight now feels more distributed, more predictable.","","        *else","            *set fight_momentum -1","            You go still, just breathing shallowly, nothing else. She moves back onto her heels, giving you a breath. That's when you move. A quick jerk of your hips to one side, the most you can manage under her weight.","","            No effect. The moment you begin your move, she counterbalances with a slight lean forward.","            ","            \"I'm paying attention,\" she says, like she's stating a fact. Her weight settles into your diaphragm again.","","        *goto struggle","","    *hide_reuse #Try to push her off with your hands.","        *set fight_momentum -1","        Your hands move before your brain catches up. Gloves pressing against her shins, trying to shove her off through sheer desperation. A slight give. Your arms shake. But nothing moves.","        ","        She doesn't even shift her weight.","        ","        \"Really...\" she says, watching your arms tremble with exertion.","        ","        Your strength ebbs. Every breath is still a shallow gasp.","","        *goto struggle","","    *hide_reuse *if (struggle_emotional >= 1) #Go limp and feign surrender. Maybe she'll lose interest.","        *if (highest_trait = \"empathy\")","            *set struggle_trait_bonus 2","        *elseif (highest_trait = \"analysis\")","            *set struggle_trait_bonus 1","        *else","            *set struggle_trait_bonus 0","        *if (adj_mental + struggle_trait_bonus) >= ((dc_easy * 0.4) + (dc_medium * 0.6))","            *set struggle_emotional +1","            *set struggle_insight +1","            You let everything go slack. Your eyes lose focus, your limbs sag. Chloe notices immediately. Her weight shifts slightly, testing if you'll respond. You don't react. ","","            \"Still there?\" There's no satisfaction in her voice. No celebration.","","            She shifts back onto her heels, allowing some air into your lungs. The fog in your head clears a bit with the breath. ","","        *else","            *set struggle_emotional +1","            *set fight_momentum -1","            You let everything go slack. Your eyes lose focus, your limbs sag. ","","            But to your body, it's real. The will to fight drains away. Your muscles feel heavy. Awareness dims. Chloe on top of you, the weight pressing down, it doesn't matter any more.","","            Chloe shifts back onto her heels as she feels your surrender. A sliver of air enters your lungs.","","            \"Still there?\" she says. She doesn't sound satisfied.","","        *goto struggle","","    *hide_reuse #Thrash around blindly. Just get her off you.","        *set struggle_emotional -1","        *set fight_momentum -1","        Arms flailing, legs jerking. Pure panic. You burn through air you don't have. Your muscles scream for oxygen.","","        Chloe leans forward slightly to compensate. That's it.","","        \"No,\" she says, her voice flat. \"That won't work.\"","","        Out of energy. Everything goes slack again.","","        *goto struggle","","*label round_2","*set struggle_total (struggle_physical + (struggle_emotional + struggle_insight))","*if (struggle_total >= 4)","    *set no_quarter_state \"unaffected\"","*elseif (struggle_total >= 2)","    *set no_quarter_state \"holding\"","*else","    *set no_quarter_state \"rattled\"","The referee heaves himself up from his seat and shuffles over to the ring. Chloe steps off without looking down, one foot after the other.","","\"Don't rush it,\" she says, as she strolls back to her corner.","","Deep breaths. More. Blessed air returning to your body. ","","You don't move yet. Sensation returns to your fingers first. You feel strength return to your legs, and your core aches. A flash of pain in your muscles. ","","The referee ambles over, seeing you splayed out on the canvas. \"Cannot lie down. House rules ah.\"","","He sighs wearily and motions with his hand for you to get up. Then he turns away, walking back to the referee table, without bothering to see if you obey.","","You slowly stand up. A brief dizziness that fades in seconds.","","A few people clap. The applause dies out in seconds. You wonder if they care about what just happened, or if they were even watching.","","*page_break","The bell rings. Round two.","","*if (no_quarter_state = \"rattled\")","    Your body still remembers her weight. Each breath feels like it's borrowed. Your core tightens, bracing for pressure that isn't there. You try to focus, but you can't think about anything else.","*elseif (no_quarter_state = \"holding\")","    You test your body. Everything's working, but it feels like there's a pressure on your ribs, refusing to fade. You roll your shoulders, trying to shrug it off.","*elseif (no_quarter_state = \"unaffected\")","    You test your body. Breath steady, core functional. It's not slowing you down. Time to process it later. Right now, it's time to fight.","*else","    *bug Invalid no_quarter_state","","Chloe bounces on her toes, shifting her weight from side to side, hips loose, as she moves forward. She watches you, eyebrows raised, smiling slightly.","","She's almost within range, and her arms are still down by her sides.","","*choice","    #Tag her with a ${combo}. Punish her overconfidence.","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *set upgrade_bonus (upgrade_multiplier * combo_level)","        *if (no_quarter_state = \"rattled\")","            *set difficulty_check ((dc_medium * 0.9) + (dc_hard * 0.1))","        *elseif (no_quarter_state = \"holding\")","            *set difficulty_check ((dc_medium * 0.8) + (dc_easy * 0.2))","        *elseif (no_quarter_state = \"unaffected\")","            *set difficulty_check ((dc_medium * 0.6) + (dc_easy * 0.4))","        *else","            *bug Invalid no_quarter_state","        *if (((adj_technique * 0.6) + (adj_mental * 0.4)) + (trait_bonus_applied + upgrade_bonus)) >= difficulty_check","            *set fight_momentum +1","            You seize the chance, your ${combo} snapping out on reflex. The snap jab catches her clean on the cheek, although the cross glances off her shoulder as she weaves. Your final hook lands on her ribs with a thud.","","            Her hands are back up now. Her eyes brighten as the corners of her mouth twitch up.","","        *else","            You seize the chance, your ${combo} snapping out on reflex. The snap jab skids off her cheek, the cross glances off her shoulder as she weaves, and your final hook thumps into her forearm.","","            Her hands are back up now. The corners of her mouth twitch up, then flatten again. She lets out a short breath through her nose.","","    #Launch into a ${flurry}, taking the initiative.","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *set upgrade_bonus (upgrade_multiplier * flurry_level)","        *if (no_quarter_state = \"rattled\")","            *set difficulty_check ((dc_medium * 0.9) + (dc_hard * 0.1))","        *elseif (no_quarter_state = \"holding\")","            *set difficulty_check ((dc_medium * 0.7) + (dc_easy * 0.3))","        *elseif (no_quarter_state = \"unaffected\")","            *set difficulty_check ((dc_medium * 0.5) + (dc_easy * 0.5))","        *else","            *bug Invalid no_quarter_state","        *if (((adj_power * 0.4) + (adj_technique * 0.6)) + (trait_bonus_applied + upgrade_bonus)) >= difficulty_check","            *set fight_momentum +2","            You seize the opening and unleash with your ${flurry}. Your punches fly fast, and find her ribs, her chest, her shoulder. She absorbs the blows, her stance loose, watching your face more than the punches. She takes her time raising her guard.","","            Eventually she shells up, elbows tight, waiting. You summon the strength for another flurry that pounds against her arms.","","            Your energy spent for the moment, you back away. She resets, and her eyes brighten as the corners of her mouth twitch up.","","        *else","            You seize the opening and unleash with your ${flurry}. Sloppy punches, but a few land on her chest and shoulder. She absorbs the blows, her stance loose, watching your face more than the punches. She takes her time raising her guard.","","            Eventually she shells up, elbows tight, waiting. Your energy spent for now, you back away. She resets, and the corners of her mouth twitch up, then flatten again. She lets out a short breath through her nose.","","    *if (counter_level > 0) #Watch for a trap and prepare your ${counter}.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *set upgrade_bonus (upgrade_multiplier * counter_level)","        *if (no_quarter_state = \"rattled\")","            *set difficulty_check ((dc_medium * 0.7) + (dc_hard * 0.3))","        *elseif (no_quarter_state = \"holding\")","            *set difficulty_check (dc_medium)","        *elseif (no_quarter_state = \"unaffected\")","            *set difficulty_check ((dc_medium * 0.8) + (dc_easy * 0.2))","        *else","            *bug Invalid no_quarter_state","        *if (((adj_mental * 0.7) + (adj_technique * 0.3)) + (trait_bonus_applied + upgrade_bonus)) >= difficulty_check","            *set fight_momentum +2","            You scan her limbs, eyes flicking from arms to legs, looking for a trap. Chloe leans forward, her right arm beginning to rise from her hip. A clinch attempt?","","            You drive forward with a single, sharp body cross. It hits her square, landing on her upper chest with a solid thud. She rocks back half a step. You immediately reset.","","            She raises her guard slowly. Her eyes brighten as the corners of her mouth twitch up.","","        *else","            You scan her limbs, eyes flicking from arms to legs, looking for a trap. Chloe sways slightly, then it looks like her right arm is starting to lift. You're not sure if it's a strike, a clinch attempt, or something else.","","            You snap out with a jab. No power, but fast, ready to respond to whatever she does.","","            It grazes her in the temple, then slides off as she twists away. She steps back and raises her guard. The corners of her mouth twitch up, then flatten again, and she lets out a short breath through her nose.","","*if (no_quarter_state = \"rattled\")","    Chloe's eyes lock on to your feet. It seems like she can read your tension in your footwork, and a hint of a smile appears. Yet she doesn't capitalise. She rises onto her tiptoes, calf muscles taut, and then she pats her ribs with one hand. ","","    Seeing you hesitate, she advances with slow steps, watching you steadily.","","*elseif (no_quarter_state = \"holding\")","    Chloe's eyes lock on to your feet. It seems like she can read the lingering stiffness in your footwork, and a hint of a smile appears. ","","    Yet she makes no move to close in, instead looking at your chest, observing the cadence of your breath. Whatever she sees, it seems to please her, as she advances with the same loose posture as before.","","*elseif (no_quarter_state = \"unaffected\")","    Chloe's eyes lock on to your feet, reading your footwork. Her eyebrows rise as a smile flashes for a moment.","","    \"Impressive. Good control.\"","","    She tucks her chin and raises her guard as she advances. Careful steps forward.","","*else","    *bug Invalid no_quarter_state","","Out of the corner of your eye, you catch the referee trudging over to ringside, glaring at his phone with increasing irritation. The spectators at the front lean over the barricades. The air conditioner catches and rattles, then stops completely. You can hear your breath.","","*gosub_scene utils show_fight_momentum","","*choice","    #Stay tight, waiting for her to overreach.","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *if (no_quarter_state = \"rattled\")","            *set difficulty_check ((dc_medium * 0.7) + (dc_hard * 0.3))","        *elseif (no_quarter_state = \"holding\")","            *set difficulty_check (dc_medium)","        *elseif (no_quarter_state = \"unaffected\")","            *set difficulty_check ((dc_medium * 0.7) + (dc_easy * 0.3))","        *else","            *bug Invalid no_quarter_state","        *set upgrade_bonus (upgrade_multiplier * ((block_level + (dodge_level + counter_level)) * 0.67))","        *if (((adj_toughness * 0.7) + (adj_mental * 0.3)) + (trait_bonus_applied + upgrade_bonus)) >= difficulty_check","            *set fight_momentum +1","            *if (no_quarter_state = \"rattled\")","                A tightness lingers in your chest. But you remain focussed. You block the kicks, slip the punches. Tag her with a jab when she tries for an elbow. Nothing flashy.","            ","            *else","                Your defence answers her attempts. Block the kicks, slip the punches. You tag her with a jab when she tries for an elbow, fire a cross counter when she goes for a clinch. Not flashy, but it works.","                        ","            She steps back, then fires off a flurry of roundhouse kicks. A dozen of them, quick and repetitive, like a pad drill. They thud against your guard, easily absorbed. You don't respond further.","","        *else","            *set fight_momentum -1","            *if (no_quarter_state = \"rattled\")","                You try to weather the storm, but a tightness lingers in your chest. Your forearms take her strikes instead of your gloves. Nothing catastrophic, but she's putting you under pressure.","","            *else","                You try to weather the storm, but your forearms take her strikes instead of your gloves. Nothing catastrophic, but she's putting you under pressure.","","            She steps back, smiles, then fires off a flurry of roundhouse kicks. A dozen of them, quick and repetitive, like a pad drill. They thud against your guard, easily absorbed, but you're stuck in place.","","    #Close in and seize this last moment.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *if (no_quarter_state = \"rattled\")","            *set difficulty_check (dc_hard)","        *elseif (no_quarter_state = \"holding\")","            *set difficulty_check ((dc_medium * 0.6) + (dc_hard * 0.4))","        *elseif (no_quarter_state = \"unaffected\")","            *set difficulty_check (dc_medium)","        *else","            *bug Invalid no_quarter_state","        *set upgrade_bonus (upgrade_multiplier * ((dodge_level + counter_level) * 0.5))","        *if (((adj_technique * 0.6) + (adj_toughness * 0.4)) + (trait_bonus_applied + upgrade_bonus)) >= difficulty_check","            *set fight_momentum +2","            *if (no_quarter_state = \"unaffected\")","                You slip her probes and create angles she doesn't expect. Your shoulders brush the ropes as you pivot out. Each time she thinks she has your timing, you've already shifted. You move efficiently, making her work for every attack.","                ","                \"Slippery,\" she spits. You catch her with a hook as she tries to cut off your movement, glove landing with a thud on the soft spot below her ribs. She stumbles back, grinning even as she winces.","","                You intercept her with a ${jab}, tagging her before she even starts her counterattack, following it with a hook to the ribs. A body blow sinks deep, driving a gasp of air from her lungs. \"Oof,\" she coughs, back-pedalling before you can capitalise.","","            *else","                You force your body to move despite your shallow breath. Sidesteps, pivots, dodges. As much unpredictability as you can muster, making her work for every hit. Her attacks find empty air.","                ","                She misses yet another elbow. Kicks become sloppy, punches overextend.","                ","                An opportunity. Your cross lands clean on her cheek as she rebalances from a roundhouse, the impact vibrating up your arm.","","        *else","            *set fight_momentum -1","            You try to create angles, but your weight doesn't move with your footwork. Your steps land heavy, planting into the canvas. You pivot until you're facing the wrong way. Chloe doesn't even pursue. She just waits for you to stumble into range.","                ","            \"Interesting boxing,\" she mutters, shaking her head. She steers you into the corner with basic teeps.","                            ","            Ropes press into your back. Another roundhouse thuds into your thigh. Her close-range elbows and knees punish your forearms.","","The referee cups his phone closer to his ear, yelling to make himself heard. \"Tung Loi Lane, right side. You know the one with the... What do you mean which building? The one next to the 7-Eleven! No, the [i]other[/i] 7-Eleven near the roast goose! Forget it, I'm coming down.\"","","The bell clangs. Then again.","","*page_break","The referee finally looks up at the fight, crumbs of [i]char siu bao[/i] still on his shirt. He ambles to centre-ring, taps the mic once, decides it isn't worth fixing, and just talks over the house PA hiss.","","\"Okay la, enough fighting. [i]Aiya[/i], better than last time. Call it a day.\"","","He squints at both of you, flips over a crumpled sheet of paper.","","*if fight_momentum >= 6","    *set match_result \"win\"","*else","    *set match_result \"loss\"","*if match_result = \"win\"","    \"Winner is... ${last_name}.\" He reaches for your hand, but then decides it's too much effort. \"If you want a photo, hurry up. Air-con expensive.\"","*elseif match_result = \"loss\"","    \"Winner is... Lee.\" He reaches for her hand, but then decides it's too much effort. \"If you want a photo, hurry up. Air-con expensive.\"","*else","    *bug Invalid match result","","He nods to himself, then walks off, engrossed in his food delivery logistics. Chloe is already in her corner, wiping her face with a towel.","","You stay standing in the middle of the ring. The canvas feels solid under your feet again. A smattering of applause.","","You assumed there'd be another round. But apparently two was enough for the referee.","","*choice","    #Accept what happened, then work on recovery.","        *gosub_scene utils increase_composure","        What happened was unfair. The referee's negligence, Chloe's violation, the crowd's passivity \u2014 all of it. But you banish the feeling. No point dwelling on it. The damage is superficial: bruised stomach, sore muscles. No internal damage, no problem breathing.","","        You now know that some opponents will try to exploit every available angle. But that's for another day. Right now it's time for recovery, training, improvement.","    #Wonder why she needs that kind of control over another person.","        *gosub_scene utils increase_empathy","        The physical damage is superficial: bruised stomach, sore muscles. But the question nags at you. Why does Chloe so desperately need this kind of control? You remember her intense concentration. How she tracked every shallow breath, welcomed every struggle. She carefully shifted her weight to keep you at the edge of breathlessness. She moved with your breath. When you tried to tense up, she adjusted instantly. Always keeping you right at the breaking point, but never past it.","","        You don't understand why she needs this. But you recognise that the necessity is there.","    #Analyse what happened here. The fight, the referee, the venue.","        *gosub_scene utils increase_analysis","        The warning signs were there from the start: the referee's casual indifference, checking his phone before the fight. The perfunctory introductions. The crowd reaction to Chloe's entrance, the nervous laughter. All of this should have triggered more caution. ","","        You add this to your checklist: the venue matters. Next time, you'll evaluate the referee, read the crowd.","","Metal chairs scrape the floor as people turn in betting slips. The air conditioning kicks into life. People pick up empty drink cans and food wrappers. Chloe approaches you, expression completely blank, like a security guard at a housing estate.","","*if match_result = \"win\"","    *set record_wins +1","    Her shoulders are relaxed. She wipes her mouth with the back of her glove.","","    \"Congratulations on your win,\" she says. \"You didn't panic. Most people lose it.\"","*elseif match_result = \"loss\"","    *set record_losses +1","    She doesn't taunt you. She just nods and wipes her mouth with the back of her glove.","","    \"You didn't panic,\" she says. \"Most people lose it.\"","*else","    *bug Invalid match result","","Her eyes refocus on you, and she notices your expression. \"I didn't break the rules. You knew where you were fighting.\"","","She steps closer, close enough that you can see a vein in her neck pulsing rapidly.","","*choice","    #\"That crossed a line. It wasn't fighting any more.\"","        You keep your voice level. \"That crossed a line. It wasn't fighting any more.\"","","        Her jaw tightens. \"You didn't like it.\"","","        No apology, but no denial either.","","    #Maintain eye contact. Say nothing. ","        *gosub_scene utils increase_composure","        *set chloe_friendship +1","        You don't reply. You let the silence stretch. Chloe fidgets with her hair clips, then purses her lips.","","        \"I know what you're thinking,\" she starts, but doesn't complete the sentence.","    ","    *selectable_if (struggle_insight >= 1) #\"You wanted to see how I'd react under pressure.\"","        *gosub_scene utils increase_analysis","        *set chloe_friendship +1","        \"You were tracking my responses and adjusting to what I did. You were trying something on me.\"","","        Her eyes widen slightly before she can catch herself. She pauses before she responds. \"Maybe.\" A small frown.","","    *selectable_if (struggle_emotional >= 2) #\"It felt like you were searching for something.\"","        *gosub_scene utils increase_empathy","        *set chloe_friendship +1","        \"It felt like you were searching for something. Some kind of feeling.\"","","        Her eyebrows pull down and her lips press together. \"I \u2014\"","","        She stops, takes a moment to gather herself. \"You don't know what you're talking about.\"","","","For ten seconds, maybe fifteen, she just watches you. She takes in your stance, your breathing, your hands.","","Her fingers fumble with the strap on her right glove. She looks past you towards the exit, where the last stragglers are escaping.","","Then she turns back to you. She begins tentatively: \"We should talk. At the Upper House. Not here. I thought maybe \u2014\"","","She stops.","","\"I could tell you more.\"","","She pulls a name card from her waistband, slips it to you. \"6PM. Text me the day before.\"","","She strides past you to the exit, not looking back to see your reaction.","*if no_quarter_state = \"rattled\"","    *set chloe_trauma 2","*elseif no_quarter_state = \"holding\"","    *set chloe_trauma 1","*elseif no_quarter_state = \"unaffected\"","    *set chloe_trauma 0","*else","    *bug Invalid no_quarter_state","*return"], "labels":{"fight":0,"struggle":201,"round_2":392}},
"chloe_subplot": {"crc":128508485, "lines":["*label scene_introduction","*if chloe_subplot_scene = 1","    After the fight at The Cauldron, Chloe didn't apologise at all. Instead, she invited you to meet her at the Upper House. It's a rooftop bar in Admiralty, far from the basement where you fought. She was vague about why exactly she wanted to meet, only saying that she had things to talk about.","    *if (chloe_almost_lapsed)","","        Chloe's invitation won't stay open for long. If you don't show up soon, she'll move on.","*elseif chloe_subplot_scene = 2","    Chloe invited you to a private training session, saying she wants to \"get serious,\" though you're not sure what she means.","    *if (chloe_almost_lapsed)","","        Chloe doesn't seem like the kind of woman to wait around forever. She'll lose interest if you don't take her up on it soon.","*else","    *bug Chloe subplot scene not found","*return","","*label scene_choice","*if chloe_subplot_scene = 1","    *comment earliest: chapter 5, first fortnight","    *comment chloe_friendship from other events: 0-1 from eric_subplot, event_2","    *comment chloe_friendship from this chapter: 3-4 for accept, 0-2 for reject","    *comment cumulative chloe_friendship after this chapter: 0-5","    *gosub event_1","    *set stat_mental %+6","*elseif chloe_subplot_scene = 2","    *comment earliest: chapter 5, second fortnight","    *comment chloe_friendship from this chapter: 1-4","    *comment cumulative chloe_friendship after this chapter: 4-8","    *gosub event_2","    *set stat_toughness %+3","    *set stat_power %+3","    *set stat_mental %+3","    *set chloe_plot_timer 2","*elseif chloe_subplot_scene = 3","    *comment earliest: chapter 6, second fortnight","    *comment chloe_friendship from afterhours: 0-4","    *comment chloe_friendship from this chapter: []","    *comment cumulative chloe_friendship after this chapter: []","    *comment chloe_romance from afterhours: 0-2","    *comment chloe_romance from this chapter: []","    *comment cumulative chloe_romance after this chapter: []","*else","    *bug Chloe subplot scene not found","*return","","*label event_1","@{gender_num Black midi dress, beige cardigan, black patent flats.|White dress shirt, grey blazer and chinos, scuffed leather shoes.|Collarless shirt, slim black trousers, leather ankle boots.} The outfit you usually only pull out for the company annual dinner or cousin Winnie's weddings. It fits uncomfortably on you as you ride the MTR to Admiralty.","","Admiralty is a fancy commercial and hotel district, the internationalist face that Hong Kong likes to present to the world. Gleaming skyscrapers, polished glass and steel, stacked and layered on top of each other like a Jenga puzzle gone wrong. A network of elevated walkways infests the shopping complexes and office towers. You could roam the entire area and never touch the ground.","","You stride out of the MTR exit onto the polished marble of the Pacific Place mall, rows and rows of luxury boutiques always empty of shoppers yet always profitable. It's too high-class for even a food court to exist. Several long escalators bring you out for a brief breath of traffic-choked air, then it's up an even fancier set of escalators \u2014 custom handholds, curved tunnel \u2014 to the Upper House hotel.","","This was the place Chloe indicated. Perched above the mere five-star JW Marriott, the Upper House boasts floor-to-ceiling windows displaying panoramic views of the Hong Kong skyline. You wait in the lift to the lounge level, ginger scent cloying, as your shoes sink into the thick carpet.","","The lift doors glide open silently, revealing an expansive atrium wrapped in warm almond wood panelling. Mushroom-coloured banquettes dot the marble floor. Weighty art and architecture books anchor the low wooden coffee tables alongside algae-green armchairs with towering backrests. An enormous fireplace, showcasing genuine gas-powered wood logs, is at the far end of the lounge, recessed into a white marble monolith. The usual crowd of bankers engage in muted conversation, most of them with the hollow stares of expatriates and jet-setters. None of them give you a second glance.","","*page_break","You approach the concierge stand hesitantly, finding there a severe-looking young woman in a power suit. \"Winky\" proclaims the nameplate pinned too high, almost at her collarbone.","","\"Good evening. Do you have a reservation with us tonight?\" she asks, almost succeeding at hiding her distaste for your attire.","","\"Yes.\"","","She looks at you, a tight-lipped smile the only change in her expression.","","\"Oh, right. Sorry. I'm here to see Chloe Lee.\"","","The hint of a raised eyebrow. A pause, a second too long. \"Certainly, please come this way.\" She escorts you through the atrium, staying close like an incident manager. At the threshold to the rooftop lounge, she gestures you through. She's back at reception before you can thank her.","","The Lawn is an elaborate bubble above the city. All around, manicured hedges frame the twilight skyline. Enormous white candles shed their unneeded vanilla fragrance. You walk across flawless, unfeeling stone tiles towards a central seating area, crossing a strip of zen pebbles. A large artificial lawn hosts a concrete fire bowl flanked by hardy C-shaped outdoor sofas. Tuxedoed waiters with silver trays of smoked salmon on blinis drift through the terrace.","","You don't spot Chloe immediately. Instead, you see a young Chinese woman seated on a sofa, leaning comfortably into the cushions. Black hair neatly tucked behind both ears, a small skull earring on one side. A black silk slip dress that hangs easily on her, high neckline, the fabric moving like knives. Legs crossed casually at the ankles, minimalist black leather slides. A small handbag with no logo you can recognise rests on the sofa, while she idly scrolls her well-worn phone.","","You realise this must be the same woman you fought at The Cauldron, even as part of your brain insists it can't be.","","*choice","    #Wonder what it takes to present yourself so differently.","        *gosub_scene utils increase_empathy","        Which one is the real Chloe? Will she transgress boundaries here?","    #Centre yourself. It's still the same Chloe.","        *gosub_scene utils increase_composure","        Unfamiliar environment to you. Familiar environment to her. No matter. Breathe. Relax.","    #Evaluate the difference in her appearance, and what it suggests.","        *gosub_scene utils increase_analysis","        She's comfortable playing different roles. But even here, she's slightly off-kilter. Deliberately or not, you don't know.","","You've stood there unmoving for too long when she looks up. Her smile is a cocktail of delight, gratitude, and calculation. She sits up straight, commanding the central seat of the C-shaped sofa, and waves you towards the short arm. A low ottoman rests in the curve of the sofa.","","\"All dressed up! I half expected you to show up in boxing gloves.\" The words are sharp, but the edge isn't there. She raises a finger, and a waiter immediately scurries over, sporting a strained smile. Chloe turns to you. \"Would my honoured guest like a drink?\"","","\"Oh. Water please, thank you.\"","*if highest_trait = \"analysis\"","    You notice the waiter came over immediately, like he was assigned to her.","*elseif highest_trait = \"composure\"","    No need to disrupt things just now.","*elseif highest_trait = \"empathy\"   ","    You can feel the tension. Better to make things simple here.","*else","    *bug Invalid highest_trait","She gives an offhand instruction, and the waiter nods quickly and hurries away. You sit carefully on the sofa arm, back straight, palms on your knees.","","\"Actually didn't know if you'd come.\" You look at her to see what she means, but her face has suddenly become unreadable.","","*choice","    #Ask why she invited you here.","        *gosub_scene utils increase_analysis","        Chloe clearly knows how to navigate this social space. But one detail has been occupying your thoughts since you first arrived at this elaborate venue.","","        \"Why did you invite me?\" The question spills out.","","    #Say she's a different person today.","        *gosub_scene utils increase_empathy","        Chloe is at home in this environment, a world away from The Cauldron. You remember the tension in the waiter's eyes. You imagine how much she must need to perform, to be able to navigate such different worlds.","","        \"Why do you want me here?\" Simple and direct.","","    #Remain silent. Wait for her to make the next move.","        *gosub_scene utils increase_composure","        *set chloe_friendship +1","        You maintain your bearing, revealing nothing. You feel the artificial lawn rustle under your shoes, grounding you. This might be her territory, but she asked you here. She's the one who should make the next move.","","        She studies you. Then a small twitch plays on the edges of her lips.","","\"I asked you here because I enjoy your company, of course,\" Chloe says with a smile that could mean anything. \"All this...\" she waves a careless hand at the curated elegance around you, \"it gets tiresome, you know?\"","","\"Must be hard to frequent rooftop lounges all the time.\"","","A clipped laugh from her, more like a cough. Her eyes move past the clump of bankers at an adjacent sofa, gazing at the distant evening skyline. \"Don't get me wrong. Having money solves problems. But I've seen this city from enough rooftops and bars that it all looks the same now.\"","","The staff hover in the background, reading her cues, not yours. The luxury here seems to flow through her.","","\"${first_name}, you see that stupid building across the harbour? The one that looks like a giant dildo? My family built that. Those two rectangular towers that look like they're stuck together? Those too.\" Her gaze remains fixed on the skyline, not meeting your eyes.","","*choice","    #Consider what this reveals about her intent.","        *gosub_scene utils increase_analysis","        She's disclosing her wealthy background, but she sounds conflicted by it. It's not what matters to her, and she wants you to know that.","    #Take her perspective to see why she's sharing this.","        *gosub_scene utils increase_empathy","        She's unimpressed by her wealth. You sense a dissatisfaction that runs deeper than she's letting on.","    #Absorb what she's said, but don't rush to respond.","        *gosub_scene utils increase_composure","        The wealth doesn't interest her. You don't respond. She'll tell you her reasons soon enough.","","\"Living the dream, right?\" A breath escapes her. \"Luxury yachts, private jets, exotic holidays.\"","","She sits forward. \"All these people around us, that's what they dream of. But it comes with a price. I can enjoy helicopter rides to tasting dinners in Macau, but I can't even fight someone who fights back. My Muay Thai coaches are afraid to push me. Wouldn't want the delicate princess to strain a muscle or something. I'm only allowed to have glorified aerobics classes.\"","","The waiter brings you a crystal highball glass of water nestled in a small paper napkin, then retreats.","","Chloe shivers. Might be the wind, but maybe not. Her gaze lingers on your glass, then she takes a short breath and looks right at you. You see steel there.","","\"You're not afraid of me. I want you to train me.\"","","She continues. \"And I could teach you a few things. How people get into your head, how to prevent that. You've got grit, but you don't have the experience.\"","","*choice","    #\"That's a bold ask, considering what you did at the Cauldron. Why should I trust you?\"","        *set chloe_friendship +1","        \"That's a bold ask, considering what you did at the Cauldron. Why should I trust you?\"","","        Chloe doesn't answer immediately, instead directing her gaze to the ottoman between you. Then she speaks without looking at you.","","        \"It's underground fighting. Things happen that wouldn't happen elsewhere. I'm exploiting the rules. I'm not saying I'm an angel. But finding advantages is a legitimate part of fighting. I'm playing to win.\"","","        She meets your eyes, but seeing your expression, she glances away.","","        \"I know how this sounds, but I needed it. It felt like a moment when everything was real, when things mattered.\"","","        She continues. \"You probably had a totally different experience. This crazy bitch is crushing me as part of some twisted game. You're totally justified in feeling that.\"","","        She waits. Not forcing a response, but leaving room for one.","","        *if highest_trait = \"analysis\"","            What she said wasn't an apology. It was a justification. She's explaining why she did it: to see how you'd respond, whether you measured up.","        *elseif highest_trait = \"composure\"","            You recognise that it was difficult for her to say this, but she said it nevertheless. You stay silent, give it space.","        *elseif highest_trait = \"empathy\"","            You sense the need, the hunger that drives her. It doesn't excuse her actions. But you understand what she needs: someone who can make her feel real.","        *else","            *bug Invalid highest_trait","    ","        \"You, ${first_name}... you're tough. You didn't crumble. You got up and went for round two.\"","","        She observes you for a moment, lips pursed. \"Why should you trust me after what I did? Good question. Well... I don't fuck people over?\"","","        A pause, like she's realised the irony of her words. \"I guess that sounds like bullshit right now.\"","","        You make a noncommittal [i]hmm[/i], which she takes as a signal to continue. \"I take care of my people though. Mostly.\"","","        \"And most people who can read people like I can, they're dangerous. I'm not, you know, the bad kind of dangerous. I just want... to know I matter?\"","","        *choice","                #\"Okay, I'm willing to give it a try. But if you cross any lines, I'm done.\"","                    *set chloe_friendship +2","                    Chloe leans back, arms crossed. Then she freezes. She processes your words. She breaks into a broad grin, crinkles appearing at the corners of her eyes.","","                    \"Wow, ${first_name}, I was half-expecting... this is great. Thanks. Thanks for accepting. I mean, it's not something you get offered every day. Um.\"","","                    *if highest_trait = \"analysis\"","                        She genuinely didn't expect you to accept her offer. An unexpected development.","                    *elseif highest_trait = \"composure\"","                        She wasn't expecting you to accept. You're the calm one now, despite being on her turf.","                    *elseif highest_trait = \"empathy\"","                        She wants to feel something. But she doesn't even know what she wants to feel.","                    *else","                        *bug Invalid highest_trait","","                    Now that her hands are unclenched, you realise how tense she was. There are faint red marks where her fingernails dug in. She made the offer even though she was expecting rejection. Maybe she took the risk because she's reckless.","","                    No, that can't be right \u2014 everything she did at The Cauldron was calculated. Risking rejection for the slim chance of a 'yes' means she almost never gets chances like this.","","                    Chloe shifts slightly on the sofa, her foot tapping rapidly on the floor. \"It felt scary asking you. I don't usually do stuff like this. Uh... well, let's celebrate! To the future!\"","","                    She summons the waiter again, and you overhear her order some kind of caviar service. Then she looks at you, smile faltering, and fidgets with her earring. \"It's all on my father's tab anyway. Not like he cares about the money.\"","","                    Chloe then takes in a deep breath and stands up abruptly. \"I... need to go. Thanks. I'll be in touch.\" She leaves quickly, stumbling slightly as she crosses the strip of zen pebbles.","","                    You wait a while more, sitting by yourself on the spacious sofa, surrounded by the elite of Hong Kong high society, just letting things settle.","","                    The waiter returns with a silver platter the size of a steering wheel, upon which rests a crystal bowl filled with gleaming black caviar pearls, two tiny silver spoons, and a stack of fluffy blinis. Another waitress arrives with a fold-out service table and carefully arranges the caviar service.","","                    No reason to waste food. You pinch a spoon with your thumb and index finger, scoop a big pile of caviar onto a blini, and pop it into your mouth. It tastes good. You fit in now, with your big caviar.","","            #\"No thanks. I'm not comfortable with this.\"","                *goto event_1_reject","","    #\"No thanks. I'm not getting drawn into your games.\"","        *label event_1_reject","        *set chloe_subplot_status \"rejected\"","","        Chloe's gaze falls to the ground. You see an almost imperceptible pinkness briefly appear on her cheeks, but it fades almost immediately. After just a few seconds, she looks at you again, but her shoulders sag.","","        \"No big deal. My methods can be off-putting. You're being sensible, playing it safe. Expected something like this to happen. Was a long shot anyway.\"","","        She tries to smile, though it comes out as more of a grimace. A slow exhale. Then she crosses her arms, sits up straighter, and slowly looks around the rooftop like she's reminding herself where she is.","","        \"You'll do fine without me. Good luck ${first_name}. Anyway. This is all on my father's tab, order whatever you want. I... I should go. Later.\"","","        She stands, strides to the exit. The nearest group of bankers pause their conversation and intently study the floor, only resuming their talk when she's completely out of sight.","*return","","*label event_2","You step out into Kowloon Station. MTR stations rarely give you this: brushed metal, glass rails, the exit leading to an atrium with a ceiling so high it faintly echoes. The refrigerated air smells like it's been endlessly recirculated. In the evening, the atrium still holds a trickle of airport-goers, suitcases clacking on the polished tile, but the expanse of open floor is almost empty. Grinding escalators rise at a steep angle, carrying you out of the station and into Elements.","","You emerge at the 'Water Zone'. You know how this works: the mall has five zones, one for each element, and you're supposed to remember the order. You don't want to, so you approach the touchscreen directory and tap the International Commerce Centre button, and a glowing path shows the way to the Metal Zone. They say the ICC is there because it's made of metal.","","A procession of escalators, each one identical to the last. Your path cuts through Prada, Louis Vuitton, Zara. And Citysuper, for some reason. Eventually, the mall spits you out into the office lobby on level 9.","","Not much activity this Saturday evening, the lift lobby now just metal and white fluorescents, staffed by a lone receptionist at the concierge desk past the electronic turnstiles. He's patting his cheeks steadily, barely aware of his surroundings. You give him your name, and he prints a visitor badge, hands you the lanyard, and directs you to the far bank of lifts. ","","Out again at the 86th floor. The corridor's LED strip lights glow white and the dense carpet mutes your footsteps. A metallic grinding sound intrudes from the ceiling vents, followed by a puff of cold air that raises goosebumps on your forearms. A plain, frosted-glass door with an angled steel handle. A nameplate: 'Studio 3'. You push the solid door, slowly, and the latch clicks open, bright golden light flooding into the corridor.","","*page_break","The dense grey rubber yields with a soft groan as you step on it. You scan the room: white drywall with grey metal panels, narrow steel bench against a wall, Chloe's sports bag and navy Asics sneakers tucked neatly underneath. You breathe in the faint smells of sweat and disinfectant, more Pilates than boxing. On the far side, floor-to-ceiling windows span the entire width, a thin metal grid as support. The windows lead to a view of Victoria Harbour and Hong Kong Island below, skyline still shining, but whole towers already dark, ones that once glowed until midnight.","*if (eric_subplot_scene > 1)","    It feels different from Eastside. Both of them professional, but this place offers less breathing room. It's all about function.","","Chloe's standing by the window, left arm extended above her head, leaning into a side stretch. She's wearing a black sports bra and athletic shorts, all function, no logos or decorations. Hair clipped back, barefoot, hand wraps and gloves beside her on the floor.","","\"Good timing.\" She looks at you and flashes you a grin, upper teeth bared. After a moment, she steps over to the wall and presses a button. The skyline vanishes as the windows turn frosted white.","","*page_break","\"Okay, warm up, and then let's do it. We'll start with contact sparring. Don't go soft on me tonight. I've had enough of that.\"","","Chloe skips rope and jogs on the spot. She sets the rope aside as you finish your warm-up stretches, but then stares at the far wall, looking at nothing in particular.","*if highest_trait = \"analysis\"","    You note how her routine has been efficient: no small talk, a disciplined warm-up, even turning the windows opaque to eliminate distractions.","*elseif highest_trait = \"composure\"","    The room feels airless, even claustrophobic, with the city shut out. You breathe evenly, grounding yourself.","*elseif highest_trait = \"empathy\"","    The city's gone, behind frosted glass. Maybe to ensure there are no distractions. But you can't help feeling that it's a retreat, a way of shutting everything out.","*else","    *bug Invalid highest_trait","","\"We'll start with a jab drill. Step in. I'll check and teep you back. Start slow.\" She retrieves a stopwatch from her bag and sets it for three minutes.","","You don your gloves and settle into your ready stance. Chloe stands opposite you and nods, her arms extended in front of her in a long guard, timer already ticking.","","You start light, singles and doubles, probing her guard. Jabs meet gloves and forearms. Nothing gets through. Her eyes are narrowed, following your every movement.","","She swats one away, lands a gentle push-kick to your chest, steps off to the side as you give ground. A brief smile, then her guard snaps back up.","","You move forward again, double jab blocked, a satisfying thud against her outstretched palm. The next one parried, another light teep. ","","A jab gets through, lightly tapping her forehead. A grin, sharp and toothy. She backsteps, teeps, centres herself. The stopwatch beeps, already counting down the next minute.","","Chloe strides over to the bench, stays standing, and takes a quick mouthful of water. You fumble through your gym bag and grab your own bottle. Chloe breathes lightly, fires off instructions. \"Next. Short combos. Two or three punches, your choice. I'll block and kick back. Full power. No head-hunting.\"","","*temp pc_sparring_power 0","*choice","    #Go light. Keep it technical.","        *set pc_sparring_power 0","        The timer signals the start of the next round, and you go straight to it. Jab, body jab, cross, your leather absorbed by her guard. She fires back with a low roundhouse to your thigh, a clean tap.","","        Jab, hook. Another roundhouse.","","        Jab cross hook. Textbook combos, controlled impacts.","","        After the next basic combo, Chloe narrows her eyes. The roundhouse lands stronger this time, an audible [i]thwack[/i] against your upper thigh.","","        You give her another controlled combination, jab jab cross. Her shin finds your lead leg again, stinging lightly. You close out the round with a clean jab cross, your breathing still steady.","","    #Match her power.","        *set pc_sparring_power 1","        *set chloe_friendship +1","        The timer signals the start of the next round, and you go straight to it. Jab to forehead, cross to chest, hook to the glove line. She absorbs them on her guard, fires back with a low roundhouse to your thigh, a clean tap.","","        Jab, jab, cross to the chest. Roundhouse.","","        Jab, cross, body hook. Solid, honest punches.","","        More short combinations, some of your punches slipping through as you vary your angles. A hook lands on her ribs, a check jab to her forehead, Chloe rolling with the impacts. After your next sequence, she looks you in the eye, nods, satisfied. Her return roundhouses come with force, matching your power, slightly numbing your thigh. You close out the round with another string of punches, solid but controlled, your breath fast but steady.","","    #Go hard, see how she handles it.","        *set pc_sparring_power 2","        *set chloe_friendship +2","        The timer signals the start of the next round, and you go straight to it. If she wants full power, you'll give her that. A light jab to the forehead, then your cross pistons forward, crashing against her guard. The impact staggers her briefly, but she manages to tag your lead leg with a quick roundhouse.","","        Jab jab cross. Roundhouse. Then you unleash with a hook, cross, hook to the body. Full force.","","        Chloe shells up, guard high, no time for her counter kick. She looks at you, eyes wide, and can't suppress a broad smile. She bounces on her feet, breathes out sharply through pursed lips, and signals for you to continue.","","        More combinations. A hook lands on her ribs, staggering her. She barely registers it, firing back with a roundhouse that lands with a [i]thwack[/i] on your thigh. You close out the round with another heavy combination, breathing hard through your nose.","","The timer signals the end of the round, and both of you head to the bench.","*if highest_trait = \"analysis\"","    She's showed restraint, always hitting back with a single controlled kick, never striking the same spot twice.","*elseif highest_trait = \"composure\"","    Despite the intensity of the sparring, she wipes her forehead slowly and deliberately, eyes tracing arcs and angles in the air.","*elseif highest_trait = \"empathy\"","    This second round of sparring is fiercer than usual, but you sense that Chloe wants even more. Not satisfied until she reaches her limits.","*else","    *bug Invalid highest_trait","*if pc_sparring_power = 1","    Her breathing remains steady","*elseif pc_sparring_power = 2","    Her chest rises and falls quickly,","*elseif pc_sparring_power = 3","    She takes laboured breaths, sweat running down her face,","as she immediately dictates the next drill. \"High volume. Nonstop flurries. I'll block, counter once. Full power, don't hold back, this is the last round.\"","","She's calling for a pad-work barrage, except this time it's her body taking the shots. You can already see the bruises, the blue-black patches. A moment ago, she smiled when your punches connected, took them without blinking.","","*choice","    #Work her body with strong, controlled shots. If she won't show restraint, you will.","        You lay in as soon as the timer beeps. Jab cross, jab cross, jab cross, exhaling sharply on the first. More jabs, more crosses, now hooks, uppercuts to the chest.","","        Chloe deflects most of them, absorbing shots on her guard, slipping jabs to her head, parrying body shots. But some of them find their mark. Gloves smack on flesh, unbalancing her. Body shots force air from her lungs. Flurries on her guard push her back. Occasional roundhouses from her land on your thighs and ribs, light taps that are counters in name only.","","        A smile, one where the lines crinkle at the corners of her eyes. \"Good,\" she huffs out, as she settles into her guard again.","","        More strikes dig into her ribs, chest, sternum. Her guard rises slower after each flurry. Your shoulders start to burn, gloves becoming heavy.","    #Unload with full power.","        *set pc_sparring_power +3","        *set chloe_friendship +1","        You lay in as soon as the timer beeps. Full power, unapologetic. Jab cross, jab cross, jab cross, exhaling sharply on the first. More jabs, more crosses, now hooks, uppercuts to the body.","","        Chloe deflects most of them, absorbing shots on her guard, slipping jabs to her head, parrying body shots. Occasional roundhouses from her land on your thighs and ribs, light taps that are counters in name only. More of your punches find their mark. Gloves crack on flesh, staggering her. Body shots force sharp exhales. Flurries on her guard send her stumbling back. She smiles, cheeks tight and flushed. ","","        A cross crashes into her upper chest with a heavy, muffled thud. Her eyes snap shut and her mouth opens wide, then the next moment her composure returns. \"Good shot,\" she says, dragging her guard back up.","","        More strikes bypass her defences, digging into her ribs, chest, sternum. Her guard rises slower after each flurry. Your shoulders start to burn, gloves becoming heavy.","","*comment pc_sparring_power from 0 to 5","*page_break","The timer rings out, signalling an end to the gruelling drill. You take a deep breath, the cool, filtered air hitting your lungs, then both of you shuffle over to the bench. The metal feels cold against your warm thighs.","*if pc_sparring_power <= 1","    Chloe wipes her forehead with her towel, her breath quickly finding its normal rhythm.","*elseif pc_sparring_power <= 3","    Chloe wipes her face with her towel, her breathing becoming steady, as she runs a hand over her ribs.","*else","    Chloe wipes her face with her towel, her breathing still sharp and uneven. She presses her hand on her chest, eyes closing when she finds the bruise.","","A minute later, she stands up, strides to the centre of the room, and motions you over. \"That's it for physical. Now let's see your mental game.\"","","Once you're beside her, she speaks with the detachment of someone delivering a report. \"Everyone flinches. Everyone gives something away. I want to show you where it happens.\"","","She suddenly steps forward and bars her arm across your chest. Her foot catches your ankle as she drives you down. You crash onto the rubber mat, Chloe grinning down at you, eyes fierce.","","*if chloe_trauma = 0","    You tense up as you recall the fight at The Cauldron. But this isn't the same. It can't be.","","    *page_break","    Chloe hasn't moved. She's still standing at your side, peering down at you. The spike of adrenaline's faded completely. It's obvious now: after you fell, she was at ease, studying you, with no intention of escalating. You should have caught that in the moment.","    ","    Apparently satisfied, she clicks her tongue and says, \"You knew it wasn't real. But for a moment there, your body didn't.\"","","    She offers a hand. You take it, and she hauls you up.","","*elseif chloe_trauma = 1","    Your body tenses up as your mind replays her assault on you at The Cauldron. Panic flares briefly. She wouldn't.","","    *page_break","    Chloe hasn't moved. She's still standing at your side, peering down at you. The immediate danger gone, you replay what happened: the jolt hit before you could think. Your body acted first, brain lagging behind.","","    She rubs her chin, and then says, \"You knew I wasn't going to do anything, but your body didn't.\"","","    She offers a hand. You take it, and she hauls you up.","","*elseif chloe_trauma = 2","    You freeze, muscles rigid, as The Cauldron crashes back into you, the crushing weight, the suffocation. You can't think, can't move.","","    *page_break","    Chloe hasn't moved. She's crouched at your side, eyebrows drawn together, gaze soft, but jaw stiff. Her mouth opens slightly, as she searches for words.","","    You see this from a distance. Your muscles locked down. Chloe. The way your brain sends commands but receives no response.","","    She touches a hand to the side of your shoulder, and you gradually come back. \"That bad, huh.\"","","    Chloe clears her throat. Pauses. \"You really thought I would.\"","","    She slides both hands under your shoulders and drags you up to a sitting position. Then she stands up before you do.","","*else","    *bug Invalid chloe_trauma","*page_break","Sitting side-by-side on the metal bench, you feel your breathing slow and your heartbeat settle. Chloe takes the opportunity to elaborate.","","\"We think we have things under control, but that's just the story we tell ourselves. In reality, we leak so much information that anyone with experience can read it all. You saw it when I swept you. But even now, just sitting here. An open book.\"","","She turns to you. \"Watch my eyes. The corners.\" The skin there tightens by a millimetre. \"See that? That's contempt, but pretending to be boredom. Easy to miss. Now look at my mouth.\" Her lips press together, not quite thin. \"Anger? No, that's fear. No white in the lips.\"","","Her voice is low, intense, the restless energy in her body wholly directed into the lesson. The specifics pass by quickly, but some of it stays in your bones.","","Chloe's half-smiling, her shoulders relaxed. You realise it's not part of the lesson. \"Dad's always been good at reading people. I got that part. I can use it against them. And then? They're gone. Always gone.\"","","She catches herself and stops talking. Stands up too quickly, strides over to the window. The evening skyline appears again, a few more lights winked out.","","Chloe stays still, looking at the city below. You join her at the window.","","\"Whatever,\" she says, flicking her hand like she's swatting away the topic. \"Enough of that. You've been fighting for a while. Who can you still not figure out?\"","","You can feel the distance settle back in. You back off, for now. Still, her question lingers in the air.","","*temp character_read_choice \"\"","*choice","    #Eric \"Blazefist\" Jiang.","        *set character_read_choice \"Eric\"","        *if eric_subplot_scene > 2","            \"Eric, huh? He's like an open book. Remember at Eastside? I just said a few words, and he looked ready to ignite the entire gym.\"","","            You remember that time. You were training with Eric. Chloe barged in through the front door and provoked him with a few cheap shots. Eric started out steady and controlled, but in less than a minute the fire was leaking through.","","            \"He tries so hard to stay calm, but he can't do it. You can see the exact moment when he slips. His eyes give him away before he even knows it himself. Easy to see why Master Wong is so exasperated with him.\"","","            She lets out a quiet laugh. \"He's desperate to prove himself. You can literally smell it. Even his fire moves are more for showing off than for maximum effectiveness.\"","","            \"Chloe, what was that for, anyway? Why did you provoke him like that?\"","","            \"I wanted to see if he learnt anything. Turns out, not really.\" She chugs some water, sloshing it around before swallowing. \"And I mean, he's a mess, but he does have it. He needs to go there. He'll own the exhibition match, as long as he doesn't choke.\"","","        *else","            \"Eric, huh? He's like an open book. He wears everything on his sleeve. All that lofty talk about discipline, control, honour.\"","","            She chugs some water, sloshing it around before swallowing. \"That fire he uses? It's inside him too. He tries so hard to stay calm, but he can't do it. You can see the exact moment when he slips. His eyes give him away before he even knows it himself.\"","","            You towel off, suddenly aware of the cooling sweat on your skin. Chloe adds, \"He's terrified of his power, but desperate to prove he's special. Makes him really erratic. Just stay out of his way and he'll knock himself out.\"","","    #Katie \"Pressure Point\" Reynolds.","        *set character_read_choice \"Katie\"","        \"Katie? Weird ones are usually dangerous. But there's a rhythm to what she does. Easy once you know what to look for.\"","","        She explains more. \"She's smiling while she's torturing you. She wants to see what pain does to people. Most people get creeped out by that. But have you ever looked at her while she's doing it?\"","","        She lets out a short laugh. \"I guess it's hard when you're screaming because your arm feels broken. But Katie's not enjoying your agony, she's just collecting data. Once you understand that, you stop being her lab rat.\"","","        *if katie_subplot_scene > 1","            You remember Katie's exam table, her eyes bright as she scribbled furiously. Chloe's right. You're a data point.","        *else","            You remember how Katie grinned, the casual chatter as she pressed her fingers into your elbow. Clinical, not personal. But your body couldn't tell the difference.","","        She chugs some water, sloshing it around before swallowing. \"Whatever. Point is, don't get distracted by the smile. The smile's for you, but her hands telegraph her intentions. Watch her hands.\"","","    #Danny \"The Dragon\" Chan.","        *set character_read_choice \"Danny\"","        \"Ugh, Danny. Can't stand that guy. Still, you have to respect it.\"","","        \"What do you mean?\"","","        \"He's built his entire life around his ritual. Doesn't even care whether it wins or not. Single-minded devotion to a stupid idea. People like that, they don't even see you. You're just part of the scenery.\"","","        She chugs some water, sloshing it around before swallowing. \"Every move is flawless, but they're not even relevant to the fight. It's like he's a machine. Doesn't matter what you do, he just runs the same routine.\"","","        You remember the Danny fight. You knew, after the first exchange, how the rest of it would play out. How nothing you did would change the sequence he was locked into.","","        \"Still, though. Most people yield eventually. He won't. I kind of admire that, in a way. I couldn't do that.\"","","        You both sit there, staring at nothing in particular.","","*page_break","The quiet returns. Beyond the window, the evening lights fade. Your thoughts drift to Chloe's comments on ${character_read_choice}. She went straight to the weakest point. Precise, but never gentle.","","You pack your things, shoulder your bag, and look over at her. She's zipping up her bag, then running a hand over her ribs. Hunched over her equipment, head bowed.","","But then she jerks upright. Looks straight at you, unblinking. \"We could go get a drink.\"","","She looks away. \"Forget it.\"","","Chloe marches out, the door left half-open.","*set chloe_friendship +1","*return","","*label event_3","- In intro text, Chloe says that her brother asked to meet the PC. She sells it as:","    - Analysis: \"Come meet my brother. You'll see what the family empire looks like up close. Think of it as a free anthropology tour.\"","    - Composure: \"He's basically a CEO in training. Perfect hair, perfect suit, perfect stress wrinkles. You'll love it.\"","    - Empathy: \"He wants to know who I trust. So... I want him to meet you.\"","- Visit brother (reasons: he wants to understand why Chloe is hanging out with you. Wants to size you up, wondering if you're a bad influence or not.)","- Chloe teases him \"hey CEO!\", he replies \"hey warrior princess!\". Obvious warmth.","- Adjusts his collar, says he's lost some weight","- Brother sees you, bring his mug to his lips, drinks while still looking. The mug obscures his facial features so you can't read him.","- But with Chloe, he's very warm.","- Brother's tone towards PC is polite/businesslike, but shows curiosity, asks probing questions","- Chloe watches brother closely, looking for signs of stress/exhaustion/pressure","- Brother asks PC a question","- Brother explains: granddad built the company from the ground up. dad honours granddad's legacy.","- Chloe says dad's overworking himself, has had health problems. mum tries her best.","- PC asks a question","- Chloe mutters about how dad needs to stop drinking so much, they don't need the China business anyway","- Chloe says, yeah, and you'll go down the same path as dad. I'll be living quietly while you suffer your entire life. I can't bear to watch","- Brother says it's not so bad. Gives life meaning. You know it has to be the eldest son.","- Chloe looks close to tears. Approaches the brother, hugs him tightly.","- Brother looks over her shoulder at PC, eyebrows raised.","- PC interiority","*return","","*label event_4","- Aberdeen Marina Club superyacht","- Chloe apologizes to the PC for standing on them at the Cauldron","- Apology is sincere but clumsy","- She starts to reflexively minimize it, but then stops. Says something like, I have my own stuff going on, but that's no excuse","- She says that she's been thinking about it. Also told her brother everything, and he encouraged her to apologise","- PC reaction:","-- Acceptance (empathy)","-- Sceptical forgiveness (analysis)","-- Deflection or humour (composure)","-- Polite distance (neutral)"," ","- non-romance path:","-- Chloe says, you don't owe me anything, you don't have to accept my apology. (or something that indicates character growth)","-- PC reaction:","---- \"What did you get out of it?\"","---- \"I'll have to think about it\"","- romance path:","-- Chloe says, since I'm confessing anyway. I did enjoy it. Psychologically, but also physically.","-- PC reaction:","---- \"Oh? Tell me more\" (+romance)","---- \"As you can imagine, I didn't really\" (friendship)","*return"], "labels":{"scene_introduction":0,"scene_choice":15,"event_1":44,"event_1_reject":227,"event_2":241,"event_3":502,"event_4":526}},
"afterhours": {"crc":-251121111, "lines":["*comment TODO: add friendship bonuses throughout chapter","*label afterhours","*temp companion \"\"","Normally, at this point, you'd be finishing up your preparations for the fight card. But now there's only dead air, empty gyms, emptier streets. Even the undercover policemen avert their eyes.","","Hungry Ghost month. People walk with their shoulders drawn in, weaving around the incense, oranges splattered with wax, suckling pig heads. A double-decker brakes hard, metal squealing against metal, an Alphard barging into its lane. You flinch before you realise.","","The city itself smells different. Burnt offerings in the air, a faint sourness in the smog. A bubble tea shop with a few dozen drinks on the countertop, plastic seals sagging, pearls bloated, no one to claim them. Red marker on a yellow post-it note that's stamped onto a glass shopfront, fluttering under the sodium streetlight. You want to move through all this, to feel what it's like.","","In the distance, a basketball thuds onto concrete, each bounce dull and heavy. It might be easier if you had someone with you, against all this.","","*comment char_friendship max amounts: Eric 15, Katie 13, Danny 7, Chloe 8","*label invite_companion","*choice","    *disable_reuse *selectable_if (eric_subplot_scene >= 2) #Ask Eric if he's free for a walk tomorrow night.","        *if (eric_friendship >= 7)","            *set companion \"Eric\"","            Eric's text comes back promptly. \"A walk? Tomorrow? I have training...\"","","            You answer with an acknowledgement of how important training is to him. Then another message arrives. \"I almost never skip training.","            *if (eric_romance >= 1)","                But I will, for you. Just this once.\"","            *else","                But I'll make an exception for you. One time only.\"","        *else","            Eric's text comes back promptly. \"Hey ${first_name}, can't tomorrow. Tournament prep. Maybe next time.\"","","            Maybe someone else will be free, but if not, a solo walk might be what you need anyway.","            *goto invite_companion","    *disable_reuse *selectable_if (katie_subplot_scene >= 2) #Ask Katie if she's free for a walk tomorrow night.","        *if (katie_friendship >= 6)","            *set companion \"Katie\"","            Katie's response arrives almost instantly, a real-time cascade of messages.","            *if (katie_romance >= 1)","                \"Really? You asked me?\" A short pause, the [i]Katie is typing...[/i] notification pulsing.","","                \"Yes! Absolutely! I'd love to! Oh. Sorry for rambling, I wasn't expecting this. See you tomorrow!\"","            *else","                \"Really? A walk? That sounds great! I could use a break. I've been glued to my chair all day!\"","        *else","            Katie's response arrives quickly. \"I'm sorry ${first_name}, I can't make it tomorrow. Lab session booked in.\"","","            She's buried in her work. Not a surprise.","            *goto invite_companion","    *disable_reuse *selectable_if (danny_subplot_scene >= 2) #Ask Danny if he's free for a walk tomorrow night.","        *if (danny_friendship >= 4)","            *set companion \"Danny\"","            Danny sends back a brief Cantonese voice clip. \"A walk would be good tomorrow.\"","","            That's surprising. He rarely agrees to anything on such short notice.","        *else","            Danny sends back a brief message. \"Sorry, group lesson tomorrow.\"","","            No room for spontaneity.","            *goto invite_companion","    *disable_reuse *selectable_if (chloe_subplot_scene >= 2) #Ask Chloe if she's free for a walk tomorrow night.","        *if (chloe_friendship >= 3)","            *set companion \"Chloe\"","            \"You can't be serious. A walk? On the pavement?\"","","            You confirm that this is your intention.","","            \"God, that's insane. Fine, let's do it. Can't wait to see what I'm missing.\"","        *else","            \"Charity dinner tomorrow. Ask me earlier next time.\"","","            Of course her schedule's full.","            *goto invite_companion","    #Go for a walk by yourself.","        *set companion \"None\"","        Better to walk alone. Just you and the restless streets.","","*page_break","Saturday, 31 August 2024","","The lighting at the MTR entrance is out, the shadows pooling in the stairwell. You take the bus instead. You stay on the lower deck, leaning onto a steel pole as cold blasts of air drag the sweat from your shirt, and a few minutes later you step out at Ferry Street into the choking evening air.","","You round the corner, circling some metal fencing, to Kansu Street outside the Jade Hawker Bazaar. Its tiny entrance is lacquered in red and gold, black lettering announcing greetings in half a dozen languages: Bem-vindo, Swaagat, Benvenuti. It's shut for the night."," ","*if (companion = \"Eric\")","    Eric's waiting there at the entrance, hair combed back more neatly than usual. His gi is nowhere to be seen today, replaced by a red polo shirt that's tucked into black jeans, leather belt a notch too loose. His leather shoes gleam, too shiny for his casual attire. He looks straight at you, a wide grin forming before he reins it back, and ","    *if (eric_romance >= 1)","        embraces you in a tight, warm hug.","    *else","        claps you on the shoulder, his hand firm yet gentle.","","    \"${first_name}! Looking forward to this.\"","*elseif (companion = \"Katie\")","    Katie's standing at the entrance, sporting a plain pastel top tucked into black jeans, a slim belt, and spotless white sneakers, laces tied into neat bunny ears. She smooths her shirt, then gives you a warm smile, eyes crinkling, and","    *if (katie_romance >= 1)  ","        embraces you in a slightly awkward hug, her body not quite touching you.","    *else  ","        lifts a hand, pausing for a beat before waving.  ","","    \"${first_name}! I wasn't sure if this was casual or, like... never mind. I'm happy you asked!\"","*elseif (companion = \"Danny\")","    Danny's already at the entrance, dressed in a loose black T-shirt, faded khaki chinos, and sneakers that look like they're been through a marathon. Slung over one shoulder is a threadbare cloth bag with a bottle of water inside. He gives you a short nod, adjusts the strap on his shoulder, and falls in beside you.","","    \"${first_name}. Walking's good. Clears the head.\"","*elseif (companion = \"Chloe\")","    Chloe's already there, leaning against the wall. Her black cropped top hangs loose above black drawstring pants and scuffed white sneakers. Her eyes are sharp in the streetlights, lines too clean. A small silver stud sparkles in the light as she turns her head, then it's gone.","","    \"${first_name}, this better not be boring,\" she says, walking alongside you. A hint of peach drifts from her direction.","*elseif (companion = \"None\")","    You pause a moment, then keep walking.","*else","    *bug Invalid companion","","*if companion != \"None\"","    Together, you set off towards the main road.","You pass a half-built highway flyover, its plastic barricades spilled onto the pavement, almost melting in the heat. A vacant retail store, its metal shutters plastered with Midland and Centaline [i]For Rent[/i] signs, each new layer pasted over the others. A herbal tea and turtle jelly shop, one of the old ones, with the giant metal urn, not the bright red plastic chain stores where they put too much honey in. The bitter smell of medicinal roots drifts out.","","*if (companion = \"Eric\")","    Eric observes, \"It's interesting that they serve turtle jelly like a dessert here. Back in Shunde it was more like a medicine thing.\" He looks over at you, eyes gauging your interest.","","    *choice","        #Ask about Shunde.","            *set eric_friendship +1","            \"Shunde? We have way better dessert, that's for sure. I've lived in Hong Kong for years but I still go back for the food.\"","","            You ask him what he thinks of his hometown, whether he likes it here in Hong Kong.","","            \"Hong Kong has a lot more restaurants. But in Shunde they cook with more care. They make the dace stuffing for the peppers by hand, pounding it for hours.\" He slows, then stops walking, looking down at the pavement.","","            \"My mum made the best stuffed peppers. I kept hogging them, so one time she left the seeds in one of the peppers. I took a huge bite and my throat was on fire. I thought I would literally die, and she's laughing, patting me on the shoulder. I was seven then.\"","","            You try not to laugh, picturing a young Eric gasping for air. He nods and starts walking again, a brief smile bubbling to the surface. ","        #Ask about turtle jelly.","            \"Nah, turtle jelly isn't really my thing. Kind of feels like a kiddie food. But what about you? Do you like it? Or do you like herbal tea more?\"","","            You mention five-flowers tea, kudzu root tea.","","            \"Yeah, I like the kudzu too. It's more like soup, right? You add some salt to it. Always good to have some soup with meals.\" He smiles to himself, gaze becoming distant.","*elseif (companion = \"Katie\")","    \"Do you like turtle jelly ${first_name}? I tried both kinds, I actually liked the bitter one more. Made me shiver and almost seize up, you know? So fun! Uh. It's fine to like that, right?\" She glances at you, bites her lower lip.","","    *choice","        #Tell her your thoughts on turtle jelly.","            \"People say it's healthy,\" you say. \"That's enough for me. At least it's better than something like 24-herb tea.\"","","            Katie nods quickly. \"Yeah, exactly.\"","","            You continue walking together. She fidgets with her belt, then her eyes pause on a scam alert roadside banner, a frown flickering across her face, before moving on.","        #Tell her you admire her attitude.","            *set katie_friendship +1","            \"I don't think many people enjoy eating it,\" you say. \"But you turned it into an adventure. That's pretty cool.\"","","            Katie breaks into a broad smile. \"Wow... thanks, ${first_name}. I... no one says this kind of thing to me, usually...\"","","            *if (katie_romance >= 1)","                She blurts out, \"do you want to... eat some?\" You're already past the shop. You open your mouth, and a soft \"uhh\" escapes. A faint blush appears on her cheeks as she looks straight ahead. Her hand twitches at her side, close to yours.","*elseif (companion = \"Danny\")","    Danny notices your gaze lingering on the turtle jelly. \"They're not supposed to use turtle shell in it now. I prefer the 24-herb tea.\"","","    *choice","        #Ask why he likes 24-herb tea.","            \"24-herb tea is very bitter. But if you accept it, the bitterness loses meaning.\"","","            His gaze fixes on an elderly couple on the opposite sidewalk, arguing loudly. They're taking turns complaining, but they're walking in sync, bodies easy with each other. ","            ","            \"Drink it every day, you don't even taste it any more.\"","","            You wonder what else might fade the same way.","        #Question whether it's more about habit than medicinal benefit.","            *set danny_friendship +1","            \"Does the tea really help you? Or is it just a habit by now?\"","            ","            \"Habit is medicine.\"","","            You stare at him. It sounds like nonsense. But you understand it in your gut.","","            Danny sees the change in your expression and nods. He permits himself the briefest smile.","","            You notice you stopped walking a while ago. You move forward again, but the pavement beneath you feels just a bit heavier.","*elseif (companion = \"Chloe\")","    Chloe boots a stray rock aside. \"You're serious, aren't you? We're just going to walk like this.\" She smirks, one eyebrow arched, as she continues alongside you.","","    *choice","        #Tell her that boredom clears the mind.","            Chloe clutches her head with both hands and lets out a groan.","","            \"What are you doing, Chloe?\"","","            She lets go. \"Your great wisdom gave me a headache.\"","","            She flicks your forehead with her index finger. It stings, just for a moment. \"Must be clear inside there now, huh?\"","","            *if highest_trait = \"composure\"","                You rub your forehead but don't answer. She laughs, satisfied, and continues walking.","            *else","                You swat her hand away. She laughs hard.","        #Say that your biggest joy in life is walking on pavement and achieving nothing.","            *set chloe_friendship +1","            Chloe stops walking, rooted in place, and looks at you, eyes wide open, mouth hanging open. She stares for another second. Then a smile dances across her lips.","","            \"The scary thing is, you could have been serious.\"","","            She runs a hand through her hair. \"This walking... it's... not bad, actually.\"","","            She grimaces, then bumps your shoulder with hers, unbalancing you for a moment. She flashes you a cheeky grin, and lightly pulls you along by the elbow.","*elseif (companion = \"None\")","    You consider stopping for a herbal tea, but decide against it. Better to keep things moving. The sidewalk feels wider without anyone beside you.","*else","    *bug Invalid companion","","*page_break","A few minutes later, you arrive at a major intersection, where the foot traffic thickens. As you're waiting at the pedestrian light, a passing red double-decker blasts you with exhaust, the fumes mixing with the smell of heated metal. A half-burnt hell banknote flutters across your path, the short edge crisped into black ash as it brushes across your shin.","","The Gascoigne Road flyover looms above the traffic, its concrete pillars pressing down on the street below. A truck roars by overhead, rusted steel rods clanking as they grind against themselves. You turn right onto Nathan Road, grimy vehicles inching forwards on all six lanes. A van darts forward; a horn screeches as the bus slams on the brakes.","*if highest_trait = \"analysis\"","    The traffic's jammed up, but the sidewalk is half-empty. The imbalance is obvious.","*elseif highest_trait = \"composure\"","    The stop-start traffic hits you in waves, testing your balance.","*elseif highest_trait = \"empathy\"","    Engines rumble, but the pavement is half-empty, like the city's pulse is missing.","*else","    *bug Invalid highest_trait","","Walking along, you see the Eaton HK hotel across the street, its big billboard showing a series of arthouse Pride snapshots. No one spares it a glance. Then behind it, a love hotel, a discreet crescent moon logo above the entrance. You pass a roadside newsstand, with triad pulp comics, soft-core magazines sealed in black plastic, horse racing tip sheets. Hard to imagine it will last the year.","","*if (companion = \"Eric\")","    Eric notices the love hotel and flashes you a half-smile. \"I like it. Clean, simple. A room with a purpose. There's no private space in this city.\"","    *choice","        #Say that might be true, but it feels a bit transactional.","            He frowns slightly. \"Transactional? Maybe. Doesn't mean it's not real.\"","","            A small silence, then he shrugs. \"You're right. But people don't have the luxury of space.\"","","            He looks straight ahead, his jaw working silently, as you continue walking.","        #Agree that it's a practical option borne of necessity.","            *set eric_friendship +1","            \"Yeah. An entire family sharing a hundred square feet. People don't have a choice.\"","","            He waves a hand at an old apartment block, dozens of storeys high. \"That's just life here. We get used to anything.\"","            ","            He rubs his chin with one hand as he stares up at the apartment block. Then a smile, like he's happy with the thought.","","            \"Some people look down on it, but it's giving people a door they can close.\"","*elseif (companion = \"Katie\")","    Katie's gaze lingers on the newsstand. \"I've never actually seen anyone buy anything from these news vendors. Wonder how they make any money.\"","    *choice","        #Say that you're seeing less and less of them around.","            *set katie_friendship +1","            Katie smiles and nods energetically in agreement. \"Yeah! Feels like most of them just disappeared.\"","","            She steals a glance at the vendor, who's slouched in his flimsy fold-out chair, and looks at you. Lowers her voice. \"Feels kind of sad, right? Like you look away for a while, and when you look back, part of the city's gone.\"","","            She runs her eyes slowly over the newsstand, and her smile fades. For the moment, there's no one else on this stretch of the pavement.","            *if (katie_romance >= 1)","                She grabs your forearm lightly, palm not quite touching, and hesitantly pulls you along with her.","        #Suggest that not everyone wants to read everything on their phone.","            Katie looks up, her eyebrows drawing together. \"True... having actual paper you can flip through, it does feel different.\"","","            She looks over the newspaper stall again, running her eyes over the offerings. \"When I read while eating, I'm always scared of spilling my drink on my phone. That's one advantage of paper.\"","","            She beams, but then her face falls as her words sink in. \"Although, um... that wouldn't be good for a magazine either...\"","","            She trails off and looks down at the ground.","            *if (katie_romance >= 1)","                Then she brushes your elbow with her hand, hesitating, before gently pulling you along with her.","*elseif (companion = \"Danny\")","    Danny's gaze lingers on the newsstand vendor. He shrugs slightly and says, \"Probably been doing it for years now. Look at how his arm is wrapped around the cash tray, like a reflex.\"","    *choice","        #Suggest that maybe he just doesn't know how to do anything else.","            Danny's jaw tightens for a moment before it relaxes again. He nods.","","            \"Yeah. Do something long enough, and stopping isn't a choice.\"","","            His hand rests briefly against his chest, like he's grounding himself. He exchanges a few words with the vendor and buys a stick of Doublemint gum.","            ","            He offers you one as you walk onwards.","        #Observe that the vendor looks like he'll continue even if no one buys anything.","            *set danny_friendship +1","            Danny nods. \"Can't let something like having no customers affect you.\"","","            You're about to say something, and he continues. \"That's how the [i]dai pai dongs[/i] died out. You can't insist on everything making sense.\"","","            You don't know if that's good business advice.","            ","            He exchanges a few words with the vendor and buys a stick of Doublemint gum. He offers you one as you walk onwards.","*elseif (companion = \"Chloe\")","    Chloe points at the moon logo. \"I'd take the moon hotel over the fancy one any day. Eaton forces you to pretend to be romantic.\"","    *choice","        #Say that you'd take the moon hotel too. Being direct has its advantages.","            *set chloe_romance +1","            *set chloe_friendship +1","            Her eyes gleam, sharp as glass. \"Direct, huh? Dangerous. I like it.\"","","            Chloe moves in, close enough that you feel the warmth from her arm. \"Makes me wonder if you'd actually follow through.\" She holds eye contact with you, just inches away.","","            You realise you've been taking shallow breaths, and draw in a deep one. She moves back a step. \"Anyway. Moon hotel. No contest.\"","","            She slides her hands into her pockets and keeps walking.","        #Counter that Eaton has its place. Some people like the game.","            *set chloe_friendship +1","            She scoffs, but turns to look at you. \"You like that stuff? Pretending together?\"","","            \"It's just another kind of dance.\"","","            Chloe shrugs. \"Huh. Sounds like work to me. I see what you mean though.\"","","            She stares straight ahead, not speaking, rubbing her thumb across her fingertips.","        #Say that both hotels serve their purpose. No need to compare.","            She snorts. \"Boring! You dragged me out here, and now this!\"","","            A short silence, then a laugh. \"Whatever. I guess sometimes I'd be in the mood for Eaton. When I feel like getting hurt.\"","","            She keeps walking, doesn't push the issue.","*elseif (companion = \"None\")","    You scan your eyes over the newspaper headlines. Nothing worth printing.","*else","    *bug Invalid companion","","*page_break","You continue along Nathan Road, a rapid-fire chime accompanying the green pedestrian light. A smell like damp cardboard wafts out of a cul-de-sac, as large warm droplets plop on the pavement, splashing onto your shoes, steady drips from air-conditioning units high above. You look up at the [i]tong lau[/i] with their protruding balconies, and sidestep the worst of the splatter zone.","","Another pedestrian crossing, then you stroll past a plaster wall, empty but for the ghost of a pawn shop sign, the scar left behind where the lettering was removed. Just above head height, reflexology and foot massage billboards in simplified Chinese. On the street, sandwich boards in faded, coated plastic. Through a break in the phalanx of buildings above, you glimpse a bare metal frame, several storeys high, where the neon signs used to hang.","","Ahead, clothes shops and property agencies and a burger joint. A vacant shopfront with an overflowing jumble of [i]For Rent[/i] signs, Centaline and Midland and more you don't recognise, enthusiastically pasted over each other, contoured like a three-dimensional map. You take a deep breath, the fresh air steadying you. A man approaches, hawking loudly, then sees you and redirects his spit to the gutter. ","","A bright orange cylindrical rubbish bin stands near the railing, the shallow metal bowl on top full of cigarette butts, some still glowing amber. Black-and-white road signs announce Ning Po Street, Nanking Street. A sign advertises karaoke, backlit by an array of white fluorescents, the right half gone dark. Pink and blue neons beckon you into a \"health centre\", the blinking arrow pointing up a dark narrow staircase like bait. From a mahjong parlour comes the sharp crack of a tile slammed on wood.","","An old woman blocks most of the sidewalk, an iron rod in her hand. She's stoking the flames in a metal barrel alongside offerings of poached chicken and barbecued pork in oily styrofoam boxes. The makeshift furnace blazes, spitting out ash and embers and choking black smoke that overpowers the minibus exhaust at the kerbside.","","*if (companion = \"Eric\")","    Eric nods his head towards the furnace. \"Can you see that? It's an entire mansion, with windows and cars and all, made out of paper. Burnt in a minute.\"","","    He lowers his eyes, a faint frown on his face, something that could be sorrow. It looks like he wants to say more, but he swallows his words and stares at the old woman and the flames.","","    *choice","        #Remark that the house shows an incredible level of detail.","            You remark on the see-through windows and the tiny imitation security cameras. They make the house seem so real, it almost feels wrong to burn.","","            Eric makes a soft 'mmm' sound. \"Yeah. It's not just something they print out. Someone needs to fold it up. I wonder what they feel when they make it, knowing it will be tossed into a fire.\"","","            He continues staring at the flames, as if he could find an answer there. You stay with him. Then, satisfied, he turns to the narrow gap between the concrete wall and the woman, who's stoking the flames again.","        #Admit that you don't know much about this tradition.","            *set eric_friendship +1","            You confess that you've seen these furnaces around this time of year, but you've never thought about what they represent.","","            Eric brightens, turning his head to face you. \"Yeah, it's an interesting story. Around this time the barrier between earth and hell weakens. So the hungry ghosts can come and visit. They call it hungry, but I think it's more like, restless, or something like that.\"","","            He clears his throat. \"Anyway, that's why people don't fight. But it also means you can give them things more easily. So this woman is sending gifts to someone she knew.\"","","            He gazes at the furnace for a bit more. Then, satisfied, he turns towards the narrow gap between the concrete wall and the woman.","    *if (eric_romance >= 1) ","        You squeeze past, Eric guiding you forward with a steady hand on your back.","    *else","        You squeeze past. Eric gives you space, then slips in behind you.","*elseif (companion = \"Katie\")","    \"Wow... is that a [i]paper house[/i]?\"","","    Katie's eyes widen. \"A stack of banknotes too. So many zeroes... wouldn't that, I don't know, mess up the economy on the other side?\"","","    You see her eyes narrow slightly as she listens to her own words, then a slight frown. She looks at you, her head slightly tilted.","","    *choice","        #Consider her question thoughtfully and build on it.","            *set katie_friendship +1","            \"That's fascinating to think about. If they have banknotes, that means they spend money in hell. But what would they buy?\"","","            Katie beams and nods enthusiastically. \"Clothes? Food? Air conditioners! Wait, no, this underworld isn't hot. It's different, right?\"","","            \"I saw [i]Journey to the West[/i] on TV a while ago. I think they have a lot of different things. Like one of them is that your bed is made of iron.\"","","            She bursts into laughter. \"That sounds terrible! You'd get a sore back when you woke up! Maybe your pillow is iron too!\"","","            The old woman stops tending the fire and looks over, one eye narrowed in confusion. Katie mumbles a \"sorry\", still grinning, and gestures you towards the narrow gap between the concrete wall and the woman.","        #Suggest that it's more about showing care.","            \"I think it's not really about the economy there. It's more for the living than the dead. People feel good, express their care for others.\"","","            Katie nods quickly. \"Yeah, you're right. It's... practical. From what I can tell, people like to find meaning in rituals.\" Her voice trails off near the end.","","            She looks from the furnace to the woman. She becomes quieter as she studies the woman's heavy, repetitive movements. Then, clasping her arms in front of her, Katie inclines her head respectfully. She glances at you, then indicates the gap between the concrete wall and the old woman.","    *if (katie_romance >= 1)","        As you squeeze past, Katie follows, close enough that you don't need to look back to feel her presence.","    *else","        You squeeze past, and Katie follows, her sneakers padding softly on the pavement.","*elseif (companion = \"Danny\")","    Danny stands a few metres away from the old woman, giving her space.","","    \"Not many young ones carry on the traditions now.\"","","    He's quiet, just watching the smoke curl up.","","    *choice","        #Watch quietly with Danny.","            You watch the metal furnace, flames flickering above the rim. The old woman heaves a miniature paper house in, an intricately detailed one, with see-through windows and tiny imitation security cameras. It sinks slowly, edges blackening and crumpling, a cloud of white-grey flakes floating onto the road. The woman says nothing, just prods the remains of the house with her metal rod.","            ","            Your gaze turns to Danny. His eyes are fixed on the rod in her hands, tracking its every movement, staring at the way she clasps it tight, the veins visible on her wrinkled skin. You can't tell what he sees in it.","","            Danny still hasn't said anything, but you realise his body has turned subtly towards the gap between the concrete wall and the old woman. Time to move.","        #Ask what it means to him.","            *set danny_friendship +1","            \"What does this mean to you?\"","","            \"It's not about the ghosts. It's about making sure we don't forget.\"","            ","            You think back to your fight with him. You wonder what he's trying not to forget.","            ","            The old woman fans out a stack of hell banknotes and drops them into the fire, handfuls at a time. Her hand shakes slightly when she stops. ","","            Danny says something to the woman, who replies 'yes' without turning to look. He nods, then extends a hand towards the gap between the concrete wall and the old woman.","        #Admit that you don't know much about this tradition.","            *set danny_friendship +1","            You confess that you've seen these furnaces around this time of year, but you've never thought about what they represent.","","            \"The paper houses turn into real houses on the other side.\" Danny gazes at the woman. \"But really... it's for us. A reminder.\"","","            You want to ask what kind of reminder he means, but he's transfixed by the flames.","            ","            The old woman gently lowers a paper Playstation into the fire. It crackles as it burns, too loud for something made out of paper. You don't think about who it might be for.","","            Danny turns his gaze away. He moves to a gap between the concrete wall and the old woman, and signals with his eyes for you to come along.","    You squeeze past, and Danny follows, a last glance at the fire before he catches up.","*elseif (companion = \"Chloe\")","    Chloe grins suddenly, the twitching kind you've seen before. You take a deep breath.","","    \"Imagine being stuck in hell and a big bowl of paper noodles pops up on your table. What would you do?\"","","    You picture it. Joss paper, run through a shredder. Unappetising.","","    *choice","        #Say you'd be excited about the taste of paper noodles.","            *set chloe_friendship +1","            \"That would be interesting. Imagine biting down on that!\"","","            Chloe bursts into laughter. \"Yes! Everyone watching you out of the corner of their eyes, and you have to pretend to enjoy choking it down!\"","","            *if (chloe_romance >= 1)","                She steps in close, slurping some invisible noodles right in front of your face, then clutching her throat with her hand, before pulling back. A few passers-by glance over at her.","","                Still grinning, she points at the gap between the concrete wall and the woman. You squeeze past; Chloe's hands land on your shoulders, steering you forward.","            *else","                She mimes gagging, doubled over, then flashes you a wild grin, teeth showing, before straightening up. A few passers-by glance over at her.","","                She strides forward confidently and motions at the gap between the concrete wall and the woman. You squeeze past, Chloe catching up to you, still grinning.","        #Say you never liked noodles to begin with.","            \"Was never a big fan of noodles to begin with, unfortunately.\"","","            She rolls her eyes in slow motion, like her entire head's being pulled up by an invisible string. \"Wow, no imagination at all,\" she says, shaking her head.","","            But then her attention is drawn to the old woman, who's just lowered a paper Playstation into the fire. She straightens up, feet together, and her expression becomes unreadable.","","            Then she brightens with a smile that looks like she produced it on demand, and waves you forward. You squeeze past in the gap between the concrete wall and the woman, and Chloe trails behind, snickering about how some people are basically robots.","","*elseif (companion = \"None\")","    The paper house disintegrates into ash. The smoke sticks to your clothes as you keep moving.","*else","    *bug Invalid companion","","*page_break","You're a block away from Jordan MTR now. The traffic is louder, but there's also the chatter of overlapping Cantonese and Mandarin conversations, music blaring from phone accessory shops. You pass a metal cart, a plastic cut-out window showing the [i]tong cung beng[/i] inside, honeycomb-like sugar cylinders dusted with coconut flakes and wrapped in a thin pancake. The vendor lifts the lid and chips at the honeycomb with a metal spatula. [i]Tink, tink, tink[/i]. A warm, nutty smell hits you. Don't see those much any more.","","Overtaking you, a pair of shoppers wheeling Rimowas, the man sweating in chinos, dress shirt and blazer, the woman in a pink Juicy Couture tracksuit, oversized sunglasses to shield her from the dim light. She plants a quick, quiet peck on his cheek. He leans in, still looking forward, and they continue walking.","*if highest_trait = \"analysis\"","    The clothes suggest they're mainland tourists. Not many of those still come.","*elseif highest_trait = \"composure\"","    The kiss is just a gesture. Something that keeps them going.","*elseif highest_trait = \"empathy\"","    The way he received the kiss. An easy familiarity, people who have been together for decades. How that would feel: comfortable, or stifling?","*else","    *bug Invalid highest_trait","","You can't tell if it was habit or intimacy. Either way, it was something fragile.","","As you wait at the pedestrian light, you're bombarded by a cacophony of honking. A plug of taxis has blocked the intersection, and a truck driver is stabbing his finger at them and mouthing a stream of obscenities behind his rolled-up window. More cars and more taxis join in the honking, a medley of long, continuous screeches and rapid jabs of noise.","","The light turns green, and you cross and approach the mouth of the MTR station. A pair of policemen straddle the entrance, clad in light blue shirts and dark blue cargo trousers. They scan the foot traffic, eyes sharp, hunting for anyone wearing the wrong clothes. No one looks up.","","*if (companion = \"Eric\")","    Eric casts a glance at the policemen, scanning their posture more than their faces. \"Discipline isn't holding your breath. Their energy is stagnant.\"","","    *choice","        #Agree with Eric's observation.","            \"All of that energy, pent up for so long without release. Can't be good.\"","        #Reply that they might not be concerned about their energy.","            \"Maybe they don't even care about energy. They're just doing what the uniform demands.\"","","    Eric doesn't reply, preferring to move past as soon as possible.","*elseif (companion = \"Katie\")","    Katie gives the policemen a wide berth as you pass, but then turns to you. \"I always wonder what their training is like. Do they get lessons on how to make everyone uncomfortable?\"","","    *choice","        #Agree and brainstorm what they might be learning.","            \"There's probably a whole course on it. Intro to staring people down.\"","","            Katie's cheeks dimple as she smiles, ","        #Offer a more systematic explanation.","            \"Maybe it just happens, when you put on the uniform.\"","","            One side of Katie's mouth moves down in a grimace,","    then she pulls you along by the","    *if (katie_romance >= 1)","        wrist.","    *else","        shoulder.","    \"Let's keep moving.\"","*elseif (companion = \"Danny\")","    Danny doesn't look at the policemen. After you pass them, he keeps looking forward. \"Every day they stand there. Imagine carrying that home.\"","","    *choice","        #Acknowledge the burden they bear.","            \"That kind of weight is light at first, but it accumulates.\"","        #Suggest they've learnt to leave it behind.","            \"Maybe they don't. Take off the uniform, leave it behind.\"","","    Danny exhales softly and keeps walking, his pace unchanged.","*elseif (companion = \"Chloe\")","    Chloe ignores the policemen, but after you pass, she remarks, \"Money gets you everything in this city. Except immunity from those brutes.\"","","    *choice","        #Agree that power defeats money.","            \"All the money in the world won't protect you from raw power.\"","        #Say it isn't that simple.","            \"They're not untouchable either. We're just not the ones who can touch them.\"","","    Chloe smirks, but her eyes are hard for a moment. \"Anyway. Come on.\"","*elseif (companion = \"None\")","    Doesn't feel like the police are here to catch anyone. They're here to keep everyone small.","*else","    *bug Invalid companion","","You pass a jewellery shop, its lone signpost still standing where the street used to shine. Your eyes sweep across the display window. Diamond specks framed in gold and platinum. A necklace, showcasing a fat pig in solid gold, with half a dozen dangling gold piglets. The pig's smiling.","","A man in a grey T-shirt and shorts walks past you, pausing regularly to drill a Muay Thai block, knee rising, elbow dropping.","*if (companion = \"Chloe\")","    You catch Chloe's face twisting, her lips curled, eyebrows drawn together.","*elseif (companion = \"Eric\")","    You catch Eric squinting at him, his mouth opening slightly then closing.","*else","    You catch the salt and sweat as he passes.","The crowd thickens at Austin Road, so you slip back onto Tak Shing Street, where the sidewalk breathes again. A 7-Eleven's there, next to an overly orange Mannings pharmacy. Two teens shuffle out, each holding malt Vitasoys and an opened bag of [i]Ethnicans[/i] potato chips, the smell of onion and garlic trailing behind them.","","*if (companion = \"None\")","    You duck inside","*else","    You nod at ${companion} and duck inside","the 7-Eleven, the electronic door chime sharp and grating. You squeeze sideways between stacked shelves. You head for the hot food counter and order some takeaway [i]siu mai[/i]. He ladles a dozen of them into a flimsy plastic tray, pasty yellow skin wrapped around a lump of grey fish paste. He tosses a handful of thin bamboo skewers on top and hands it to you.","","*page_break","Carrying the food in one hand, you walk down Tak Shing street. It's just off the main road, but a few steps in and it's quiet. An unmanned currency booth on your left, the frozen exchange rates ghosted into the display. A Japanese restaurant, styrofoam box of dead mackerel left at the entrance. Property agencies, signs shouting HUGE DISCOUNT, EMIGRATION SALE. The prices are still seven figures.","","At the end, a playground. Crumb rubber flooring, a slide barely a metre high, a swing with rust on the chains. No children. Around it, clusters of metal chairs, the steel a cold shock even in the summer heat. A few elderly residents are seated, reading newspapers, waving small hand fans, listening to stock tips on the radio.","","*if (companion = \"Eric\")","    You rest your arm on the armrest, then lift it away from the film of dried syrup. Eric's still.","","    \"They built this place for movement. But no one moves.\"","","    *choice","        #\"Not every place has to serve its intended function. It's fine if they find new purposes.\"","            \"Not every place has to serve its intended function. It's fine if they find new purposes.\"","","            Eric gazes at the swing and the tiny rocking horse next to it. One of the screws is missing from the base, so the rocking horse is tilted at an angle. \"Maybe. Kind of like the cycle of life. But it does mean that the park's failed at its original purpose.\"","","            He keeps looking at the rocking horse. It sways whenever a wind blows.","        #\"Movement leaves echoes, even if no one's here now.\"","            *set eric_friendship +1","            \"Movement leaves echoes, even if no one's here now.\"","","            Eric watches the swing twist in the wind, never completely still. \"Echoes. Yeah. They're like a faint copy of the real thing. You can hear them, but you can't build on them.\"","","            He keeps watching the swing, but his eyes are somewhere else entirely.","        #\"The stillness doesn't bother me. I'm here, beside you.\"","            *set eric_friendship +1","            *set eric_romance +1","            \"The stillness doesn't bother me. I'm here, beside you.\"","","            His eyes close as he breaks into a smile, though he catches himself almost immediately.","","            \"Thank you, ${first_name}. That's enough for me.\"","","            You've seen him blaze in the ring. This is something else entirely.","","    *if (eric_romance >= 1)","        At a far row of seats, an old woman stands, mumbles something to her friends, then drifts away. Eric leans back slightly, spine still straight, and skewers a [i]siu mai[/i], lifting it to you. As you take it from him, there's barely any space between your hands.","","        *choice","            #Take the skewer naturally, brushing your hand across his.","                *set eric_romance +1","                He smiles, and there's the faintest flush across his cheeks. You eat the [i]siu mai[/i], not even noticing the rubbery taste, and then let your hand settle on the armrest between you.","","                Eric places his hand on yours. The warmth is steady, contained. He keeps his gaze straight forward, but the silence feels shared.","","                The swing creaks once in the breeze, then goes still.","            #Take the skewer carefully, avoiding contact.","                *set eric_romance -1","                He nods, then leans back slightly, spine still straight. His face stays carefully neutral. You eat the [i]siu mai[/i]. It's rubbery and bland.","","                Eric eats one too. He makes a face. \"This barely counts as food.\"","","                The swing creaks once in the breeze. Eric watches the swing, then closes his eyes. The silence holds.","    *else","        At a far row of seats, an old woman stands, mumbles something to her friends, then drifts away. Eric leans back slightly, spine still straight, and skewers a [i]siu mai[/i]. He takes a bite. \"This barely counts as food.\"","","        Unconvinced, you pop one in your mouth. It's rubbery and bland, the skin sticking to your teeth. You finish the rest of the [i]siu mai[/i].","","        Eric watches the swing a moment longer, then closes his eyes. His breath moves with the breeze, but his back is rigid against the seat. You find yourself sitting straighter too.","","*elseif (companion = \"Katie\")","    You rest your arm on the armrest, then lift it away from the film of dried syrup. You shift slightly on the metal seat. Katie fidgets, then reaches for the tray. She skewers a [i]siu mai[/i] into her mouth without looking at it. A grimace, then she forces a swallow. \"That's... not how it's supposed to taste.\"","","    Looking around, her eyes land on a row of metal chairs. \"These chairs are warm, but your skin insists that it's cold. Nerves are so subjective.\"","","    *choice","        #\"That's just physics. Metal is more conductive, so it pulls the heat away more.\"","            *set katie_friendship +1","            \"That's just physics. Metal is more conductive, so it pulls the heat away more.\"","","            She snaps her fingers. \"Oh yeah! Thermal conductivity. I knew that. But still, what matters is how we perceive it, right?\"","","            The correction lands like a gift. She's leaning back, shoulders loose, hands moving as she talks.","        #\"Makes sense to me. Our bodies only tell us what we need to know.\"","            *set katie_friendship +1","            \"Makes sense to me. Our bodies only tell us what we need to know.\"","","            Katie nods vigorously. \"Exactly! We only notice a tiny fraction of the stimuli we get. Our brains edit everything.\"","            ","            Her gratitude feels outsized, like you've given her air to breathe.","        #\"Cold or not, I just want to be next to you.\"","            *set katie_friendship +2","            *set katie_romance +1","            \"Cold or not, I just want to be next to you.\"","","            Her face reddens instantly, impossible to miss. She presses her palms against her cheeks, then drops them. You let the moment breathe. It's a while before she speaks again.","","            \"That... makes me very happy. Thanks.\"","","            As her face slowly returns to its regular complexion, she looks down at your [i]siu mai[/i] tray.","","    *if (katie_romance >= 2)","        Then, Katie sits up straight. She blurts out, \"Do you... like me? Like not just for the research?\"","","        She digs her fingers into her thighs as her legs bounce. \"No, no! I didn't mean...\"","","        Staring intently at the [i]siu mai[/i], she shoves one into her mouth. \"These are... um, high in amino acids. Very functional,\" she mumbles through the mouthful. You think she just swallowed the entire thing without chewing.","","        *choice","            #\"I like you.\"","                *set katie_friendship +1","                *set katie_romance +1","                Katie swallows hard, then faces you and starts to lean in. Then her brain catches up. Her eyes widen as she freezes, breath still, halfway to you.","","                She's completely stuck, so you gently lean in to meet her. Katie closes her eyes, a bit too hard.","","                A quick kiss on her lips.","","                Katie doesn't dare to look, trembling slightly as she holds the moment, a smile melting onto her face.","","                You ease her back, and she sinks into the seat with a contented sigh.","","                The swing creaks in the faint breeze.","","            #\"Relax, Katie. We're just eating [i]siu mai[/i].\"","                Katie blinks rapidly. \"Right. Siu mai.\"","","                She nods fast, like she's rebooting her brain. Tries to stab at another [i]siu mai[/i], but her hands are shaking and she misses.","","                She finally spears one and holds it up in triumph, but her smile wobbles.","","                \"Motor control: restored!\" she announces. The bright smile reappears.","","                You can't help but laugh. Her shoulders loosen, and she lets out a quiet breath.","","                The swing creaks in the faint breeze.","    *elseif (katie_romance = 1)","        She pops another one in her mouth, then says, \"They're still terrible. But... somehow better, with you here.\"","","        The delivery needs work, but the meaning comes through.","","        *choice","            #\"Yeah. Everything's better with you.\"","                *set katie_friendship +1","                *set katie_romance +1","                Katie freezes, her hands halfway to another [i]siu mai[/i]. Then a smile forms on her face, slow and automatic.","","                \"That's...\" she starts to say, then laugh softly. \"That's... nice to hear.\"","","                She lets out a breath and then looks down at the [i]siu mai[/i] like it's suddenly fascinating again. A moment passes, then she adds quietly, \"Thanks.\"","","                You put your arm around her shoulder. She leans into you. The fit isn't perfect, all angles and elbows, but it's comfortable.","","                The swing creaks in the faint breeze. She's warm against your side.","            #\"Wow, I'm being compared to bad dim sum here.\"","                *set katie_friendship +1","                Katie laughs out loud, then nearly chokes on her food. You pat her back and she manages a quick recovery. \"You made me laugh while I was eating! That's dangerous.\"","","                She wipes her mouth, but can't wipe the grin from her face. \"Bad dim sum, but good company. Conclusion: favourable outcome.\"","                ","                She nudges the [i]siu mai[/i] plate to you. \"Now it's your turn to suffer.\"","","                Her laugh sounds lighter now. The swing creaks in the faint breeze.","    *else","        *set katie_friendship +1","        She pops another [i]siu mai[/i] into her mouth, winces, then laughs. \"I don't know why I keep doing this. Each piece is going to be just as bad, right?\"","","        You laugh and take one too. Pasty and rubbery, just like she said.","","        \"At least I'm eating them together with you. That's not so bad.\"","","        \"Yeah, it's not so bad.\"","","        You lean back, watching the swing creak in the faint breeze.","*elseif (companion = \"Danny\")","    You rest your arm on the armrest, then lift it away from the film of dried syrup. You shift slightly on the metal seat.","","    Danny says nothing, eyes fixed on the empty swing as it sways in the breeze. You eat a [i]siu mai[/i], rubbery and bland, the skin sticking to your teeth. The silence lasts until Danny finally speaks.","","    \"The children left. The elderly remain.\"","","    *choice","        #\"Yeah. Only the elderly have time to sit here.\"","            *set danny_friendship +1","            \"Yeah. Only the elderly have time to sit here.\"","","            Danny nods. \"Time is more of a burden for them.\"","","            You watch an old man, hunched forward on his seat, peel an orange with his bare hands. The peel tears from the pulp with an invisible mist that stains his fingers. One peel detaches, then another.","","            It's like time works differently for him, its passage marked only by the orange.","        #\"The kids probably show up during the day time.\"","            \"The kids probably show up during the day time.\"","","            \"Maybe. Each hour belongs to someone different.\"","","            You watch an old man, hunched forward on his seat, peel an orange with his bare hands. The peel tears from the pulp with an invisible mist that stains his fingers. One peel detaches, then another.","","            The orange belongs to this hour. When it's gone, so is his time.","","    Danny's noticed your gaze on the man, and he watches him too. He says, \"After he's peeled the orange, he will eat it.\"","","    You nod.","","    The slightest hint of citrus drifts over. A group of teenagers cut across the playground, absorbed in their phones. The man pulls off orange slices one by one, eats them methodically. It's a sour one.","","    There's nothing more to say. The swing sways in the faint breeze.","*elseif (companion = \"Chloe\")","    You rest your arm on the armrest, then lift it away from the film of dried syrup. You shift slightly on the metal seat. Chloe sprawls back in her chair, legs spread wide. She grabs a [i]siu mai[/i] from your tray with her fingers and pops it into her mouth. She grimaces at you, then swallows.","","    *if (chloe_romance >= 1)","        \"A playground with no kids. Such a romantic date. You're really spoiling me.\"","    *else","        \"A playground with no kids. So romantic. You're really spoiling me.\"","","    *choice","        #\"Gourmet siu mai, scenic playground view. What more could anyone ask for?\"","            *set chloe_friendship +1","            \"Gourmet siu mai, scenic playground view. What more could anyone ask for?\"","","            Chloe laughs, shaking her head. Her eyes flicker over your face, reading it.","","            \"If this is your idea of a date, I'm both impressed and concerned.\"","","            You study the [i]siu mai[/i] tray with interest, instead of answering.","        #\"Don't blame me. You're the one stealing my food.\"","            \"Don't blame me. You're the one stealing my food.\"","","            \"You snooze, you lose!\" She pulls a mock-childish face and sticks her tongue out at you.","","            You watch her pretend to enjoy the [i]siu mai[/i]. Then she grins and swipes another one. \"I'm doing you a favour here. You know how bad these things taste?\"","            ","            Stealing is wrong. Especially from someone who's already sharing.","        #\"Call it whatever you want. I just wanted to spend the night with you.\"","            \"Call it whatever you want. I just wanted to spend the night with you.\"","            *set chloe_friendship +1","            *set chloe_romance +1","","            Chloe's grin disappears. She stares at you. \"You actually mean that, don't you...\"","","            The playground slide suddenly becomes very interesting to her. \"Careful. I don't... I don't know how to deal with people who mean it.\"","","            \"Feels good, though.\" She's looking at you again.","","            You're expecting a joke, an eye roll, a grin snapping back into place. But she just sits there, her shoulders tight, like she's holding something in.","","            \"Ugh. Listen to me. Gross.\" She says this even as she moves closer, her shoulder touching yours.","","    *if (chloe_romance >= 1)","        Chloe becomes still for a moment, then picks up another [i]siu mai[/i] with her fingers, brings it halfway to her mouth, and pauses. She raises her eyebrows, a slow smile spreading on her face, and she offers it to you.","","        *choice","            #Lean forward and open your mouth.","                *set chloe_romance +1","                *set chloe_friendship +1","                You lean forward and open your mouth.","","                She leaves you hanging for a moment, then slides the [i]siu mai[/i] in. As she pulls away, she slowly brushes your lower lip with her fingers.","","                Chloe just watches you, her fingers resting on her lips. You chew slowly, not even tasting it, stretching out each second.","","                She doesn't look away, nor can you read her expression. ","                ","                A radio crackles with a weather report. Rain tomorrow.","            #Take it from her hand.","                *set chloe_friendship +1","                You hold the [i]siu mai[/i], fingers touching hers, waiting for her to let go.","                ","                She doesn't. Her fingers stay where they are, light but deliberate, like she's seeing how long you'll hold on.","                ","                Then she releases. A slight smile, impossible to read. She watches you chew. You don't really taste it.","","                You pick another one from the plastic tray, and lift it towards her.","","                A radio crackles with a weather report. Rain tomorrow.","    *else","        Chloe points at the plastic tray while leaning away so much she's over the far armrest. \"Hey, you bought it. You have to suffer too.\"","","        You pop a [i]siu mai[/i] in your mouth. Pasty and rubbery. Her face hadn't lied.","","        \"Good, good. Shared suffering.\" She grins, then looks down at her sneakers.","","        \"Guess that's all it ever is, huh?\"","","        She starts to laugh, but it dies halfway. She stares at the empty playground. The swing creaks in the faint breeze.","*elseif (companion = \"None\")","    You find an empty row of chairs and sit down. You eat the [i]siu mai[/i] one by one. They collapse in your mouth. The taste of fish paste.","","    It's okay.","*else","    *bug Invalid companion","","*return"], "labels":{"afterhours":1,"invite_companion":12}},
"training_montages": {"crc":-1404302338, "lines":["*label power","*temp max_scene 2","*if (training_power_scene > max_scene)","    *set training_power_scene 0","*if training_power_scene = 0","    He holds pads and doesn't speak. Doesn't flinch. Just watches.","","    You start light. Testing range, rhythm, breath. No reaction.","","    You hit harder. Sharpen the hook. Snap the cross. Breathing quicker. He still doesn't move.","","    No feedback. Just the pads, held perfectly still, as if mocking the idea of progress.","","    Stance tighter, hips loaded, angles cleaner. Again. And again. Until your lungs rasp and your arms go heavy.","","    Then one lands. A left hook, full weight behind it. Something loose and ugly in the torque.","","    The pad shifts. Just a little.","","    He nods, once.","","*elseif training_power_scene = 1","    The afternoon light cuts golden rectangles across the gym floor as Coach Lam points to your lead hand. \"Show me your hook.\" You rotate your hips and throw the hook, gloved fist thumping against his focus mitt from the side.","","    \"Again.\"","","    You continue throwing hooks. Two seconds. Two seconds. He just absorbs the impact. \"Again,\" he repeats. ","","    You throw another, feeling your weight shift through your hips, your fist travelling the same arc it has for the past ten minutes. Your muscles burn, slow, grinding fire with every hook.","","    Your form collapses. Elbow drops. Wrist bends. Hip rotation falters. Your coach taps your elbow with the mitt. Next hook is better. Knuckles vertical, elbow at ninety degrees, arm horizontal, hip rotating, lead foot pivoting. A nice [i]smack[/i] against the pad. Then another. Another.","","    The rectangles of light have dimmed, and your hook has evolved into pure muscle memory, bypassing thought entirely. Your coach steps back, nodding. \"Tomorrow we do your other hand,\" he says, peeling off the mitt like it's just another day.","","*elseif training_power_scene = 2","    Sweat stings your eyes. You blink hard, smear your forearm across your face. Half an hour of cardio. Three rounds of mitts. Two sparring sessions. A desperate, satisfying pull from your water bottle, blessed relief glugging down your parched throat.","","    You're mid-stretch, leaning into a deep lunge, when Coach Lam points to the heavy bag in the corner. Doesn't speak. Just walks away.","","    The leather is torn in places, shredded fabric spilling from a long tear. You start to punch. One-two. One-two-one-two.","","    Your fists feel like soaked meat, and the bag doesn't care. You keep punching. Your shoulders go. Then your legs. Your hands too. No, wait. They're still moving.","","    You're just knocking politely now.","","    Then: \"Good.\" That's the only word you hear all day.","*else","    *bug invalid training_power_scene","*set training_power_scene +1","*return","","*label technique","*temp max_scene 2","*if (training_technique_scene > max_scene)","    *set training_technique_scene 0","*if training_technique_scene = 0","    You draw chalk circles on the gym mat. Two feet wide. One for each foot. \"Stay inside,\" Coach Lam says. \"No wasted motion.\"","","    You shadowbox. Jab cross hook. Slip left. Duck, roll right. The circles are too small. Your feet feel shackled. Your rear foot smudges the chalk.","","    He shakes his head.","","    You reset. Ankles ache. Your hips can't rotate. You're too upright. The angles are all wrong. You're punching like your joints are gears.","","    Your foot slips again.","","    \"Nope.\"","","    Eventually, you stop looking at the lines. You feel them instead, each time you pivot. Your weight flows. The jab extends gently, clean and direct.","","    Your coach says nothing. Just nods, barely.","","*elseif training_technique_scene = 1","    The gym is quiet except for the metronome. Click. Jab. Click. Cross. Your breath syncs to the beat, sharp and fast. You're shadowboxing. Like a torturous version of that arcade game where you stomp coloured arrows in time, except the lights are off, and the only feedback is sweat.","","    The tempo quickens. Click jab click cross. Coach motions for footwork now. You start switching your feet in place. Front foot back, back foot forward, over and over. The Ali shuffle. Click shuffle shuffle. Pointless in a fight. Perfect for tempo.","","    You're in the groove. The tempo slows, but you stay locked in. You don't have to think any more. Your hips twist without waiting for permission. Your jab slips out like an Octopus tap, smooth and automatic. You glance at your coach. He's already turning the dial.","*elseif training_technique_scene = 2","    You're told to mirror another fighter's form exactly. Not spar, just mimic. Same combos, same timing, same angles.","","    At first, it's like copying brushstrokes in a script you can't read. The rhythms are wrong. The distances don't work.","","    But something changes. Your hips twist before your mind catches up. You breathe in. They breathe out.","","    You're not sure where your movements end, where theirs begin. You match their guard, their pivots, their steps. Even when resting, your posture starts to resemble theirs.","","    When the drill ends, you're still holding the stance. Still waiting for their next move.","*else","    *bug invalid training_technique_scene","*set training_technique_scene +1","*return","","*label toughness","*temp max_scene 2","*if (training_toughness_scene > max_scene)","    *set training_toughness_scene 0","*if training_toughness_scene = 0","    You sprint the length of the empty Star Ferry terminal. The metal shutters are still down. Ferry horns echo distantly across the harbour like a forgotten alarm clock. At the far end, you slap the concrete pillar. Glimpse your reflection in the plexiglass, mouth half-open, eyes somewhere else. Fifteen seconds. Then sprint again.","","    No timekeeper. No coach. Just your worn running shoes on the slick floor, the tang of sea brine and diesel exhaust. You run past an elderly man laying out meditation leaflets beneath a printed banner, past the ticket machines, past the chained turnstiles. Fifteen seconds. One more lap.","","    At some point you forget the count. You stop touching the pillar. Your reflection is still there, but you don't look any more. You just run.","","*elseif training_toughness_scene = 1","    You run at night, when the humidity clings like syrup and the air barely moves. Past shuttered jade shops, a gaudy ceremonial archway, and electronics stores with dusty display cases and bored shopkeepers eyeing empty streets.","","    A group of old men huddle over a Chinese chess game on plastic stools and a folding table. One glances up, then nudges his friend. \"Boxer again,\" you hear.","","    The roads narrow in places. You weave between signposts and wayward plastic buckets, a nighttime slalom course. You nearly run into a newsstand stacked high with newspapers and bottled drinks. You wave to the gap-toothed newspaper vendor and keep going.","","    At the fruit market, the crates are being hosed down. Oranges today. Always oranges. Tonight, the citrus scent is in a futile battle against the durian's unstoppable assault.","","    You run faster, not to escape it, but to keep it from settling into your skin.","","*elseif training_toughness_scene = 2","    The stairwell smells like damp concrete and mildewed bookshelves. The air doesn't move.","","    You run loops between floors six and fourteen. Down eight flights. Up eight flights. Again.","","    Your footsteps bounce, first from your shoes, then from the walls. The air sticks in your throat. Every slap of sole on a stair sounds like your own echo hunting you.","","    You lose count, but not pace. You register the turns without looking. Your breathing is heavy in the silence. Thighs start to burn, knees begin to click. But the rhythm holds.","","    A door creaks open. Someone stares. You don't stop.","","*else","    *bug invalid training_toughness_scene","*set training_toughness_scene +1","*return","","*label mental","*temp max_scene 2","*if (training_mental_scene > max_scene)","    *set training_mental_scene 0","*if training_mental_scene = 0","    You dissect the same fight ten times in a row, logging every feint, slip, and failed setup.","","    You start seeing things before they unfold. Movements look wrong now, even when they land.","","    That night, you dream in slow motion and miss your stop on the train.","*elseif training_mental_scene = 1","    The gym is a mess of noise today. Cantopop from three decades ago blares from a tinny speaker. Someone nearby performs calisthenics while yelling \"Yah!\" at full volume. Coach Lam doesn't seem to notice.","","    He fires instructions over the noise: \"One two! Slip left! Hook! No no, jab-jab-hook! Roll! Step out!\"","","    You try to follow; already a new set of orders. \"One two one two! Uppercut! Angle out! Jab jab! Why are you square?!\"","","    Three minutes later, your brain's fried. Your gloves don't know where they're going.","","    But somehow, your feet stayed moving. The rhythm got through. Nothing else did.","*elseif training_mental_scene = 2","    The gym lights hum like flies. Coach Lam has you shadowbox while five kids run around screaming nonsense. One recites items from the [i]cha chaan teng[/i] menu. Another is definitely making up words.","","    It's stupid. It's chaotic. And yet your footwork smooths out. The noise stops mattering. You start hearing only your breath and the floor.","","    When the bell rings, you don't stop right away. You didn't hear it.","*else","    *bug invalid training_mental_scene","*set training_mental_scene +1","*return","","*label eric","*if ((eric_plot_timer = 0) and (eric_subplot_status = \"available\"))","    *temp max_scene 1","    *if (training_eric_available_scene > max_scene)","        *set training_eric_available_scene 0","    *if training_eric_available_scene = 0","        Evening at Eastside Combat Club. The air conditioning rumbles quietly, while fluorescent lights cast long shadows across the mats. A small MMA group in the corner finishes their padwork. It smells of clean sweat tonight. Even the perspiration is disciplined.","","        Eric has you spar an energetic teenage boxer. Gloves on gloves. He watches from the edge of the ring, arms crossed. Doesn't say anything between rounds, doesn't offer any advice.","","        After the second round, you glance over at him. \"Thoughts?\" you ask.","","        He takes a step closer. \"You're punching like you want to impress. Not like you believe.\"","","        You nod.","","        Next round, your punches aren't stronger. They're quieter. You remember something Eric said: don't punch with your hand, punch with your heart. Still doesn't make sense.","","        The teenager dominates the entire round. But you don't mind.","    *elseif training_eric_available_scene = 1","        Evening at Eastside Combat Club. The air conditioning hums steadily, mixing the scents of clean leather and fresh tape wraps. A few stragglers are finishing their stretches and packing their gym bags.","","        Eric stands in the middle of the mats, one fist held out straight. Occasional flames rise from his fist, the air shimmering like torchfire. The flames start to lessen, then fade.","","        You wait. He doesn't acknowledge you. Deep in concentration. The insistent beeping of the timer drifts from the far side of the gym.","","        He turns slightly and nods at you. You stand beside him and raise your fist, matching his posture. The flames reappear around his fist, rhythmic and even. Nothing happens with yours.","","        You continue to hold the pose. After a few seconds, your wrist warms. Not heat. More like pressure. Like your hand is meeting the air, becoming part of it.","","        Eric glances at you. \"Don't push,\" he says. \"Just notice it.\"","","        You note the warmth for a few more seconds before it departs. Just a fist now. But you feel a faint tingling at the outer edge of your hand.","","        You stay still for a few seconds longer. Whatever it was, it didn't last.","    *else","        *bug invalid training_eric_available_scene","    *set training_eric_available_scene +1","*else","    *temp max_scene 1","    *if (training_eric_unavailable_scene > max_scene)","        *set training_eric_unavailable_scene 0","    *if training_eric_unavailable_scene = 0","        Your water bottle drips with condensation, forming a ring of water where it meets the table. You move the bottle aside and stare at the circle for too long, visualising the energy diagram Eric once sketched in quick, confident strokes. Circular, flowing, imperfect. You run a fingertip along the water, smudging it into a flat loop.","    ","        The air conditioning drops to an idling hum. You trace the circle again, slower. Trying to feel what Eric meant.","","        There's no sudden flash of insight. You wait.","","        A faint pulse travels through your shoulder. Maybe muscle memory. It doesn't feel like understanding, but your hand traces the same path again. ","    *elseif training_eric_unavailable_scene = 1","        You sit cross-legged on the wooden floorboards, the waxed boards smooth under your thighs. Hands on knees, palms up. Eyes closed. Eric said when you breathed this way, you could feel the energy flowing.","","        A minute of stillness. The edge of something, hairs rising on your forearms. Then a [i]krrk-krrk-screee[/i] from above, plastic chair scraping the floor. A voice, harsh and irritable.","","        You let it pass over you and through you. A breath. Another.","","        Warmth accumulates in your chest. Your breathing slows. The warmth spreads outwards, through your arms, through your legs. Not something to control, just something to notice.","","        You stay.","","        Your head feels heavy as you lift it. Eyes open. Half an hour gone, somehow. You remember Eric saying that beginners lose track of time. You don't agree.","    *else","        *bug invalid training_eric_unavailable_scene","    *set training_eric_unavailable_scene +1","*return","","*label katie","*if ((katie_plot_timer = 0) and (katie_subplot_status = \"available\"))","    *temp max_scene 1","    *if (training_katie_available_scene > max_scene)","        *set training_katie_available_scene 0","    *if training_katie_available_scene = 0","        Dimmed lab room, after hours. Curtains drawn, overhead lights dim. The table supports a tray lined with tuning forks, dowels, heat packs.","","        Katie points to the chair without looking up. Presses the first dowel to your forearm.","","        \"Three.\"","","        She nods once, writes it down.","","        She moves methodically through the tools \u2014 dull pressure that sinks deep but doesn't cut, sudden heat that makes you flinch, low vibrations that travel through bone. Each time, you state a number. She adjusts. She writes it down.","","        Halfway through, she pauses. \"This one might spike,\" she says. \"Breathe through it.\" Katie's hand steadies your wrist. Contact. A sharp edge. You keep still, exhale.","","        You call it \"five.\"","","        She glances at you. \"Really?\"","","        Her face reveals nothing. No accusation. But she doesn't write it down. Repositions the dowel, slower this time. Not doubting your answer, just tracking the gap between your words and your reaction.","","        She doesn't believe your \"five.\" Not enough to challenge it. Just enough to check again.","","        When it's over, she starts packing the tray. You both stay silent as she seals the equipment bag.","    *elseif training_katie_available_scene = 1","        HKU rooftop, dusk. The skyline glows amber and violet, concrete towers melting into shadow. A gentle wind drifts across the concrete. Katie arrives without a word, sets down her duffel bag, and kneels to tape a sensor to your palm. Her fingers steady your wrist as she smooths the tape. Brief touch. No eye contact.","","        \"Arms up. Hold.\"","","        You raise both arms to shoulder height. Katie stays kneeling, gaze fixed on the biometric scanner. The skyline deepens to rose, then steel-grey. The wind picks up, stirring dust across the concrete.","","        A slight burn spreads through your shoulders.","","        Barely audible: \"Most people give up before ten minutes. Not from pain. Just from the doubt, the idea that they're doing it wrong.\"","","        When your arms start to drop, she stands behind you and adjusts your posture with one hand on your upper back. The contact is light. Her hand stays a moment too long. No adjustment, no pretext.","","        The scanner beeps. Fifteen minutes.","","        She peels the tape from your skin, then sits beside the gear. \"I'll send you the results,\" she says.","","        You don't leave right away. Neither does she. The skyline dims.","    *else","        *bug invalid training_katie_available_scene","    *set training_katie_available_scene +1","*else","    *temp max_scene 1","    *if (training_katie_unavailable_scene > max_scene)","        *set training_katie_unavailable_scene 0","    *if training_katie_unavailable_scene = 0","        You sit cross-legged on the wooden floor, spine resting against the edge of your bed. One hand cradles the dense rubber ball Katie provided you, its surface studded with short metal prongs that bite faintly into your palm.","","        Outside, rain taps gently against the window, a muffled rhythm that barely registers. Above, a chair scrapes across the floor \u2014 [i]krrk... chk... scree[/i] \u2014 then falls quiet again.","","        You press the ball to your forearm, the metal studs sharp and unyielding against skin. At first, nothing. Then a flare of electric needles that make your teeth clench involuntarily.","","        You note the signal. The sensation is real, but it doesn't require a response.","","        You roll the ball along your forearm, pressing muscle into bone, a patient, deliberate line from wrist to elbow and back again. Your arm begins to feel strange. Not numb, exactly, but off, like something's disconnected and waiting for input.","","        The ball falls into your lap. You rest your arms, tracking the phantom signals still echoing from your nerves.","","        You flex your fingers once. Normal function restored.","    *elseif training_katie_unavailable_scene = 1","        Late evening. The office is silent, long since emptied. The fluorescent light casts a low, exhausted glow over the rows of abandoned desks.","","        You adjust your chair, cranking it too high. Your monitor wakes with a soft whir. You rest one hand on the mouse, wrist hovering unsupported. The other rests on the keyboard, drawn by muscle memory.","","        Your spine curves forward gradually. The chair's cheap foam compresses beneath you, offering no support. You don't correct it.","","        You type and click: not words, just gibberish. Nonsense on a blank document. The familiar aches return: stiffness locking your fingers, pressure building in your wrist, the pinch between the shoulders. Your jaw clenches without needing an invitation.","","        It's a slow accumulation. Discomfort layered upon discomfort. Not enough to drown, just enough to soak through everything.","","        You name each signal quietly: the tension in your lower back, the dull throb behind your eyes, numbness creeping into your left foot. And when the discomfort peaks, when your body wants to escape: you stay.","","        One breath. Slow.","","        Then you close the document. Power down the computer.","","        No stretch. Just stand. Walk away.","    *else","        *bug invalid training_katie_unavailable_scene","    *set training_katie_unavailable_scene +1","*return","","*label danny","*if ((danny_plot_timer = 0) and (danny_subplot_status = \"available\"))","    *temp max_scene 1","    *if (training_danny_available_scene > max_scene)","        *set training_danny_available_scene 0","    *if training_danny_available_scene = 0","        Danny available training scene 0","    *elseif training_danny_available_scene = 1","        Danny available training scene 1","    *else","        *bug invalid training_danny_available_scene","    *set training_danny_available_scene +1","*else","    *temp max_scene 1","    *if (training_danny_unavailable_scene > max_scene)","        *set training_danny_unavailable_scene 0","    *if training_danny_unavailable_scene = 0","        Danny unavailable training scene 0","    *elseif training_danny_unavailable_scene = 1","        Danny unavailable training scene 1","    *else","        *bug invalid training_danny_unavailable_scene","    *set training_danny_unavailable_scene +1","*return","","*label chloe","*if ((chloe_plot_timer = 0) and (chloe_subplot_status = \"available\"))","    *temp max_scene 1","    *if (training_chloe_available_scene > max_scene)","        *set training_chloe_available_scene 0","    *if training_chloe_available_scene = 0","        Chloe available training scene 0","    *elseif training_chloe_available_scene = 1","        Chloe available training scene 1","    *else","        *bug invalid training_chloe_available_scene","    *set training_chloe_available_scene +1","*else","    *temp max_scene 1","    *if (training_chloe_unavailable_scene > max_scene)","        *set training_chloe_unavailable_scene 0","    *if training_chloe_unavailable_scene = 0","        Chloe unavailable training scene 0","    *elseif training_chloe_unavailable_scene = 1","        Chloe unavailable training scene 1","    *else","        *bug invalid training_chloe_unavailable_scene","    *set training_chloe_unavailable_scene +1","*return","","*label rest","*temp max_scene 8","*if (training_rest_scene > max_scene)","    *set training_rest_scene 0","*if training_rest_scene = 0","    You board the ferry to Cheung Chau with no gear, no plan. The benches are slick with sea spray and the air smells like diesel, algae, and fishballs. You pace along the weathered railing and watch the water churn as the wind rustles your face. Inside, a baby cries. A quiet hiss as someone opens a can of drink.","","    You wait for the press of bodies to thin before you step onto the pier. Tourists file dutifully into seafood restaurants, while couples rent bicycles and share tofu pudding. You drift past, ignoring the stalls and the ice cream freezers with their condensation-slicked glass tops, heading inland through narrow alleys where laundry flaps on metal wires and the stonework breaks, fades. ","","    You pause at a tiny shop where the rusted fan rattles above a scratched glass counter, air stirring reluctantly like pedestrians at a crowded crossing. The only indication that it's open is the shopkeeper, squatting lazily, who doesn't look up from his racing newspaper, only motioning his head towards the fridge when you ask. You hand over a ten-dollar coin and take a bottle of Dahongpao oolong tea, barely cold enough. Outside, you twist the cap and sip. It tastes like every school trip you barely remember.","","    A breeze slips through the alleys now and then. Outside a 7-Eleven, a boy shadowboxes at your reflection in the window. One-two, awkward uppercut. You nod, not sure if you're smiling or not.","","    You find a mossy stone bench with a view of the village. You practise your breathing drills without thinking. Air in, air out, slow and even. It feels right.","","*elseif training_rest_scene = 1","    You sleep late. No alarm. Dreamless sleep. A small wet patch of drool on your pillow, like a tiny rebellion. You finally open your eyes, seeing how the room is too quiet. Outside, the sharp squeal from a truck's compression brakes cuts through the midday stillness. A metal gate slams, two floors down.","","    Eventually, you shuffle to the kitchen, chalky toothpaste still coating the inside of your cheeks. The thin plastic crinkles as you rescue the bundle of vermicelli from the wrapper. Boiled for a minute less than it says to. You don't bother to look for the seasoning packet. Just soy sauce, a dull orange bowl, wooden chopsticks flame-blackened at the tips. It's chewy, but still hard at the centre.","","    You sit against the wall, phone propped on your gym bag, old cartoons streaming. The speakers buzz valiantly. You sneeze, a quick thing. \"Bless you,\" the priest in the cartoon says, you think.","","    Your knuckles throb like they're proud of themselves. Your hamstrings sigh in relief. You let them have the moment.","","    The cartoon loops. You don't notice at first. Then you do.","*elseif training_rest_scene = 2","    You drift through Ladies' Market, registering the packed stalls with their corrugated iron roofs claiming the roadway. Bare bulbs overhead, bright and unnatural. The air's heavy, crowded by the colourful pyjamas, basketball jerseys, \"I \u2764 HK\" T-shirts, and incorrect designer bags. A tourist haggles over plastic keychains but doesn't buy. Shopkeeper shrugs. ","","    There's only room for two abreast. You stop at a table stacked with cheap punching pads. Red vinyl, shiny and flaking. Thin foam. You press your thumb into one. It doesn't resist. You imagine hitting it with a full power cross, your coach's hand collapsing before he flings it into the rubbish. You nod at the shopkeeper and move on.","","    Fluorescent light blasts your vision. A young woman, ring light haloing her head, moves backwards, livestreaming. Too much subtle makeup. She has a ballet shoe in one hand, pressed to her face like a vintage telephone. \"Only 88 yuan for this genuine quality shoe! Only 50 yuan more, to make it a pair.\" ","","    The sweet scent of egg-waffle batter passes by, once, but you can't see the [i]gai daan jai[/i] cart anywhere. Somewhere ahead of you, someone yells \"Buy one get one!\" in three languages at once. You keep walking.","*elseif training_rest_scene = 3","    You board the double-decker tram in Sheung Wan, just to sit still. It's one of those new ones with the air conditioning and the friendly driver. Empty tram, so you get the front row seat on the upper deck. Plastic windscreen in front of you, wide and clean. The seat's hard plastic is sun-warmed but still a bit cold on your thighs.","","    The tram starts with a jerk and the distinctive bell. Ding ding... ding. Every brass note feels like it's marking the end of a round. You don't count them, but your body does.","","    The tram meanders east, barely faster than a brisk jog. You crack open a window. Humid air, but at least it's moving. You read somewhere that air-con is bad for you. Can't be worse than the Wan Chai exhaust. ","","    Half a dozen kids in green-and-orange school uniforms climb up and scatter a few rows behind you. Their bulging schoolbags thump onto the floor. They argue about whether something evolves at level 20 or 40. You don't catch the name, just the urgency. You're not close enough to hear, and that feels right.","","    The streets roll by: kudzu drink, a former pawn shop turned tourist trap, Mega Monster Burger. Fortress Hill: polished leather designer sofas in showroom windows, mocking the rabbit hutches packed high above.","","    You ride the line all the way to the end. Quarry Bay again. The tram empties. No one tells you to leave, but you do.","    *if eric_subplot_scene > 1","        Eastside? Not today.","    You walk west, in silence. Not for a reason. Just for the illusion of one.","*elseif training_rest_scene = 4","    The MTR sways gently as it pulls away from Sham Shui Po. You're seated, arms crossed, drifting in and out of awareness as the train rocks rhythmically. The man next to you has a wrinkled brown takeaway bag at his feet, greased half-translucent at the bottom. You think you saw it fall. Maybe. He's engrossed in his phone, stabbing the glass with quick, practised jabs.","","    When the train pulls in at Mei Foo, he rises and adjusts his belt. Just before the doors open, you grab the wrapper and extend it to him. \"You dropped this,\" you say. His eyes flick to it, then to you. His face tightens. His ears twitch. \"Thanks,\" he mutters, pinching it lightly before disappearing into the crowd.","","    The doors hiss shut. You shift back into your seat. A woman says, \"That wrapper was there before he got on.\" She doesn't look at anyone in particular. You don't say anything.","","    The overhead lights flicker for a moment. Your reflection reappears in the glass pane turned mirror: a tidy silhouette, holding nothing, sitting a little too upright.","","*elseif training_rest_scene = 5","    You stroll through the wet market starting from the Wan Chai end. Bowrington Road in late afternoon. Water runs constantly. Hoses flushing guts and meat bits into the gutter, fish splashing water out of their polystyrene crates, block ice and crushed ice melting beneath the geoduck clams, mist spraying over fruit displays.","","    You avoid the biggest puddles, even though your shoes are already damp. You register the coriander. Sharp. Raw pork hangs dense in the air, its damp smell cut by the metallic tang of fish blood. You remember, long ago, a friend who acted tough. Got halfway through and his face turned pale green, had to pinch his nostrils closed and breathe through his mouth. Doesn't churn your stomach now. Just another stimulus to tune out.","","    A woman claps mechanically. Says her pomelos can outlast the others. A lean man in a red plastic apron slits a chicken's throat with a single clean cut. No, that can't be, they banned live chickens after the avian flu. You look again. He's only chopping headless birds along joint lines. Must have misread the movement.","","    You don't need to think. Your legs keep moving. Plastic tubs of oyster meat, bundles of razor clams tied with plastic twine. You're tempted by the Shine Muscat grapes. Chinese, not Japanese. Still sweet enough to pretend they're the real ones.","","    Ahead, Times Square looms. Glass, stone, a giant TV above the plaza, tuned to a cable news channel. You cross when the light changes. A woman hands you a yoga flyer. You take it without looking. You don't stop walking.","*elseif training_rest_scene = 6","    The garden path in Victoria Park loops gently, the low shrubs and small clearings creating pockets of quiet within the retail frenzy of Causeway Bay. There's a pleasant scent of roasted chicken and sambal from the semicircle of Indonesian maids on their day off. Couples sit on wooden benches, enjoying advanced bubble tea concoctions. A toddler trips. Quick swivel of her head. Parents see her. She wails.","","    You take the long way, past the pond with the drowsy turtles stacked three high. A koi swims in the tea-coloured water. Wind rustles through the manicured trees.","","    The garden opens onto an ordered grid of sports fields. Dozens of football pitches, asphalt and mostly empty. A group of lanky schoolboys are on one, kicking a tired football with more enthusiasm than skill. The thump and clang of 3-on-3 basketball comes from behind the concrete divider. You notice your weight shifting. Right foot to left. You're moving with the dribbling without meaning to. It takes a few steps before you even register it.","","    You pass through the park's gate with the Queen Victoria statue. You cross the road to the library, wrong shape for a fight. No clean approach angles. No stance worth taking.","","    Greek pillars collide against modernist steel and plate glass, interrupted by windows shaped like pop-up ads. Huge. Imposing. Somehow flimsy.","","    You stand under the oversized logo-window, feet shoulder width apart. A long breath. Slow in, slower out, body resetting to neutral. The kind you take before a round starts. You don't go in. You keep walking.","","*elseif training_rest_scene = 7","    You sit in a [i]cha chaan teng[/i] near the end of a tram line. Not a nice one. The kind with hard plastic benches, sugar in dented metal cans, table still damp from a half-hearted swipe with a grey rag.","","    You don't look at the menu. You just say \"B1\", like it's the only thing that makes sense. The waitress nods without writing anything down.","","    Someone's transistor radio crackles with race results from Sha Tin. A grunt of disappointment from the corner booth. Your tea arrives first, Hong Kong style, much too strong. You stir in a teaspoon of sugar. Sweet and astringent. You take another sip.","","    Then the set: macaroni in broth, pan-fried spam slice, two pieces of folded ham. A fried egg resting on top. On another plate, a thick slice of toasted white bread charring on the faces, and a thin coat of melted butter. Filling. Honest.","","    No one talks. Behind the glass, cars ease past, indifferent to pedestrians. You chew slowly, half-watching, half somewhere else. The egg yolk breaks onto the spam, turning it glossy. You finish it all.","","    When the waitress brings the bill, she calls you \"boss\" like she might've known you once. You nod, leave exact change on the scratched glass counter, and leave quietly.","*elseif training_rest_scene = 8","    You get off the bus at the Cross Harbour Tunnel. The engine noise fades behind you as it pulls away, leaving diesel fumes hanging in the humid air. You cross the footbridge towards Poly University. No students around on the weekend.","","    You walk without purpose. Past the plaza where students hand out flyers, now littered with only a few leaflets from a kendo club recruitment drive. Five young women in pink T-shirts practice K-pop routines, phone on a tripod recording everything.","","    The campus feels like a stage waiting for the actors to come back. Chairs in neat rows. Umbrellas furled. Everything ready, but the performers have abandoned the show.","","    You take the overpass out towards the main road. The metal grating wasn't always there. You thrum your fingers along the edge as you pass. It's welded tight. One more thing added after things got heated.","","    Pedestrians drift past in both directions, earbuds in, eyes on phones. You hear your own footsteps too clearly. The sound of people alone, together.","","    You keep walking. Past the places where things used to happen.","*else","    *bug invalid training_rest_scene","*set training_rest_scene +1","*return"], "labels":{"power":0,"technique":51,"toughness":93,"mental":131,"eric":162,"katie":229,"danny":318,"chloe":343,"rest":368}},
"upgrades": {"crc":-1800520661, "lines":["*label spend_insight_choices","*gosub check_whether_can_spend_insight","*if (can_spend_insight)","    A pattern noticed. A mistake corrected.","","    You see more clearly into the rhythm of fights now. The tells, the pauses, the gap between action and intent.","","    Insight. Some of your boxing techniques feel like they're ready. Ready for you to notice.","    *gosub choose_where_to_spend_insight","    *gosub check_whether_can_spend_insight","    *if (boxing_insights_unspent > 0) and (can_spend_insight)","","        Insight, crystallised. But another technique presents itself.","        *gosub choose_where_to_spend_insight","        *gosub check_whether_can_spend_insight","        *if (boxing_insights_unspent > 0) and (can_spend_insight)","","            Insight. One more refinement.","            *gosub choose_where_to_spend_insight","*else","    You carry ${boxing_insights_unspent} unspent [i]Boxing Insights[/i].","    ","    But none of your techniques are ready to absorb it. It lingers. A lesson, waiting to take shape.","*page_break","*return","","*label check_whether_can_spend_insight","*set can_spend_insight False","*if (jab_level = 0)","    *if (stat_technique >= 18)","        *set jab_upgradeable True","        *set can_spend_insight True","*elseif (jab_level = 1)","    *if (stat_technique >= 32)","        *set jab_upgradeable True","        *set can_spend_insight True","*if (flurry_level = 0)","    *if ((stat_power >= 15) and (stat_toughness >= 15))","        *set flurry_upgradeable True","        *set can_spend_insight True","*elseif (flurry_level = 1)","    *if ((stat_power >= 24) and (stat_toughness >= 24))","        *set flurry_upgradeable True","        *set can_spend_insight True","*if (combo_level = 0)","    *if ((stat_technique >= 15) and (stat_power >= 15))","        *set combo_upgradeable True","        *set can_spend_insight True","*elseif (combo_level = 1)","    *if ((stat_technique >= 24) and (stat_power >= 24))","        *set combo_upgradeable True","        *set can_spend_insight True","*if (block_level = 0)","    *if (stat_toughness >= 18)","        *set block_upgradeable True","        *set can_spend_insight True","*elseif (block_level = 1)","    *if (stat_toughness >= 32)","        *set block_upgradeable True","        *set can_spend_insight True","*if (dodge_level = 0)","    *if ((stat_mental >= 15) and (stat_toughness >= 15))","        *set dodge_upgradeable True","        *set can_spend_insight True","*elseif (dodge_level = 1)","    *if ((stat_mental >= 24) and (stat_toughness >= 24))","        *set dodge_upgradeable True","        *set can_spend_insight True","*if (counter_level = 0)","    *if (stat_mental >= 18)","        *set counter_upgradeable True","        *set can_spend_insight True","*elseif (counter_level = 1)","    *if (stat_mental >= 32)","        *set counter_upgradeable True","        *set can_spend_insight True","*return","","*label choose_where_to_spend_insight","*choice","    *if ((jab_upgradeable) and (jab_level = 0)) #Sharpen your jab.","        Mid-combination, one of your jabs snaps forward. Fast, clean. The fist retracts by itself.","","        You save the feeling.","        *gosub upgrade_jab","    *if ((jab_upgradeable) and (jab_level = 1)) #Refine your jab further.","        You're practising your footwork and suddenly throw a jab. It feels right, when you move like that.","","        Next time, you push off the floor with your rear foot, and the jab comes straight and sharp.","        *gosub upgrade_jab","    *if ((flurry_upgradeable) and (flurry_level = 0)) #Refine your flurry.","        Your flurry starts to move by itself. Layers of pressure, unpredictable angles.","","        And more of them. You throw more punches now.","        *gosub upgrade_flurry","    *if ((flurry_upgradeable) and (flurry_level = 1)) #Tighten your flurry further.","        You vary the cadence of your flurry, angles adjusting in real time. Speed and volume and irregular timing.","","        Your hands know where to go.","        *gosub upgrade_flurry","    *if ((combo_upgradeable) and (combo_level = 0)) #Develop your combinations.","        One-one-two. One-two-five-two. Three-two-three. One-six-three-two. ","","        The rhythm is built in now. Press a button, get the combo.","        *gosub upgrade_combo","    *if ((combo_upgradeable) and (combo_level = 1)) #Integrate your combinations.","        You see new links between moves. One flows into the next. Less guessing, more reading.","","        You stop thinking. They just come.","        *gosub upgrade_combo","    *if ((block_upgradeable) and (block_level = 0)) #Stabilise your guard.","        You stop hiding behind your hands. Blocking is now active, not passive.","","        You meet incoming attacks, instead of bracing for them.","        *gosub upgrade_block","    *if ((block_upgradeable) and (block_level = 1)) #Adapt your guard.","        You stop waiting for attacks. Blocking is now adaptive, not just active.","","        You adjust before their punch has even arrived.","        *gosub upgrade_block","    *if ((dodge_upgradeable) and (dodge_level = 0)) #Learn to slip and dodge.","        Lines. Arcs. Angles. Your body starts to recognise them all. Space opens up.","","        You move just enough.","        *gosub upgrade_dodge","","    *if ((dodge_upgradeable) and (dodge_level = 1)) #Evade and flow through attacks.","        Your dodges thread through attacks. Your slips are barely movements at all.","","        A step ahead, not a step back.","        *gosub upgrade_dodge","","    *if ((counter_upgradeable) and (counter_level = 0)) #Learn to counter.","        You start to see the openings. The gap between intention and action, where your counter fits.","","        You learn to wait.","        *gosub upgrade_counter","","    *if ((counter_upgradeable) and (counter_level = 1)) #Anticipate openings to counter.","        You counter even before they attack. They miss, and the punch has already arrived. ","        ","        You saw it coming the whole time.","        *gosub upgrade_counter","*return","","*label upgrade_jab","*set boxing_insights_unspent -1","*set boxing_insights_spent +1","*if (jab_level = 0)","    *set jab_level 1","    *set jab \"[i]Sharp Jab[/i]\"","*elseif (jab_level = 1)","    *set jab_level 2","    *set jab \"[i]Tuned Jab[/i]\"","*return","","*label upgrade_flurry","*set boxing_insights_unspent -1","*set boxing_insights_spent +1","*if (flurry_level = 0)","    *set flurry_level 1","    *set flurry \"[i]Fast Flurry[/i]\"","*elseif (flurry_level = 1)","    *set flurry_level 2","    *set flurry \"[i]Controlled Flurry[/i]\"","*return","","*label upgrade_combo","*set boxing_insights_unspent -1","*set boxing_insights_spent +1","*if (combo_level = 0)","    *set combo_level 1","    *set combo \"[i]Standard Combo[/i]\"","*elseif (combo_level = 1)","    *set combo_level 2","    *set combo \"[i]Chain Combo[/i]\"","*return","","*label upgrade_block","*set boxing_insights_unspent -1","*set boxing_insights_spent +1","*if (block_level = 0)","    *set block_level 1","    *set block \"[i]Stable Guard[/i]\"","*elseif (block_level = 1)","    *set block_level 2","    *set block \"[i]Adaptive Guard[/i]\"","*return","","*label upgrade_dodge","*set boxing_insights_unspent -1","*set boxing_insights_spent +1","*if (dodge_level = 0)","    *set dodge_level 1","    *set dodge \"[i]Fluid Evasion[/i]\"","*elseif (dodge_level = 1)","    *set dodge_level 2","    *set dodge \"[i]Predictive Movement[/i]\"","*return","","*label upgrade_counter","*set boxing_insights_unspent -1","*set boxing_insights_spent +1","*if (counter_level = 0)","    *set counter_level 1","    *set counter \"[i]Basic Counter[/i]\"","*elseif (counter_level = 1)","    *set counter_level 2","    *set counter \"[i]Predictive Counter[/i]\"","*return"], "labels":{"spend_insight_choices":0,"check_whether_can_spend_insight":26,"choose_where_to_spend_insight":78,"upgrade_jab":145,"upgrade_flurry":156,"upgrade_combo":167,"upgrade_block":178,"upgrade_dodge":189,"upgrade_counter":200}},
"utils": {"crc":-139597099, "lines":["*comment This displays a 1-liner stat bar","*label show_stats","*gosub calc_adj_stats","","Power: [b]${adj_power}[/b] (${stat_power}) | Technique: [b]${adj_technique}[/b] (${stat_technique}) | Toughness: [b]${adj_toughness}[/b] (${stat_toughness}) | Mental: [b]${adj_mental}[/b] (${stat_mental}) | Energy: [b]${stat_energy}%[/b]","*return","","*comment calculate the stats after adjustment for less than 100% energy","*label calc_adj_stats","*gosub clamp_energy","*temp energy_adjustment (1 - ((100 - stat_energy) * 0.005))","*set adj_power round(stat_power * energy_adjustment)","*set adj_technique round(stat_technique * energy_adjustment)","*set adj_toughness round(stat_toughness * energy_adjustment)","*set adj_mental round(stat_mental * energy_adjustment)","*return","","*comment clamp energy values at 0-100","*label clamp_energy","*if (stat_energy > 100)","   *set stat_energy 100","*if (stat_energy < 0)","   *set stat_energy 0","*return","","*comment set stats and optionally show the adjustment. TODO: not implemented yet","*label set_power","*params power_amount","*set stat_power power_amount","*if show_stats_increase","    [i]Your power is now ${stat_power}.[/i]","*return","","*label increase_analysis","*set trait_analysis +1","*gosub update_highest_trait","*return","","*label increase_composure","*set trait_composure +1","*gosub update_highest_trait","*return","","*label increase_empathy","*set trait_empathy +1","*gosub update_highest_trait","*return","","*label update_highest_trait","*temp highest_value 0","*if (trait_analysis > highest_value)","    *set highest_value trait_analysis","*if (trait_composure > highest_value)","    *set highest_value trait_composure","*if (trait_empathy > highest_value)","    *set highest_value trait_empathy","*if (trait_analysis = highest_value)","    *set highest_trait \"analysis\"","*elseif (trait_composure = highest_value)","    *set highest_trait \"composure\"","*else","    *set highest_trait \"empathy\"","*set highest_trait_num highest_value","*return","","*label update_highest_friendship","*temp highest_value 0","*if (eric_friendship >= highest_value)","    *set highest_value eric_friendship","*if (katie_friendship >= highest_value)","    *set highest_value katie_friendship","*if (danny_friendship >= highest_value)","    *set highest_value danny_friendship","*if (chloe_friendship >= highest_value)","    *set highest_value chloe_friendship","*if (eric_friendship = highest_value)","    *set highest_friendship \"Eric\"","*if (katie_friendship = highest_value)","    *set highest_friendship \"Katie\"","*if (danny_friendship = highest_value)","    *set highest_friendship \"Danny\"","*if (chloe_friendship = highest_value)","    *set highest_friendship \"Chloe\"","*set highest_friendship_num highest_value","*return","","","","*comment sets trait_bonus_applied if the highest trait is the same as the param","*label calculate_trait_bonus","*params trait_type","*if (trait_type = \"analysis\")","    *if (highest_trait = \"analysis\")","        *set trait_bonus_applied trait_bonus_amount","    *else","        *set trait_bonus_applied 0","*elseif (trait_type = \"composure\")","    *if (highest_trait = \"composure\")","        *set trait_bonus_applied trait_bonus_amount","    *else","        *set trait_bonus_applied 0","*elseif (trait_type = \"empathy\")","    *if (highest_trait = \"empathy\")","        *set trait_bonus_applied trait_bonus_amount","    *else","        *set trait_bonus_applied 0","*else","    *bug Incorrect trait parameter passed","*return","","*label tick_character_cooldowns","","*set eric_plot_timer -1","*if (eric_plot_timer < 0)","    *set eric_plot_timer 0","*set katie_plot_timer -1","*if (katie_plot_timer < 0)","    *set katie_plot_timer 0","*set danny_plot_timer -1","*if (danny_plot_timer < 0)","    *set danny_plot_timer 0","*set chloe_plot_timer -1","*if (chloe_plot_timer < 0)","    *set chloe_plot_timer 0","*return","","*label fortnight_choice","*choice","    #Train power with heavy bag work.","        *gosub_scene training_montages power","        *set stat_power %+8","        *set stat_energy -20","        *gosub_scene utils clamp_energy","    #Refine boxing technique with precision drills.","        *gosub_scene training_montages technique","        *set stat_technique %+8","        *set stat_energy -20","        *gosub_scene utils clamp_energy","    #Build stamina with running and conditioning.","        *gosub_scene training_montages toughness","        *set stat_toughness %+8","        *set stat_energy -20","        *gosub_scene utils clamp_energy","    #Practise visualisation and fight strategy.","        *gosub_scene training_montages mental","        *set stat_mental %+8","        *set stat_energy -20","        *gosub_scene utils clamp_energy","    *if (unlocked_eric_training) #Practise energy awareness meditation.","        *gosub_scene training_montages eric","        *set stat_mental %+3","        *set stat_technique %+3","        *set stat_energy -10","        *gosub_scene utils clamp_energy","    *if (unlocked_katie_training) #Train pressure point resistance.","        *gosub_scene training_montages katie","        *set stat_toughness %+3","        *set stat_mental %+3","        *set stat_energy -10","        *gosub_scene utils clamp_energy","    *if (unlocked_danny_training) #Danny option.","        *gosub_scene training_montages danny","        *set stat_power %+3","        *set stat_mental %+3","        *set stat_energy -10","        *gosub_scene utils clamp_energy","    *if (unlocked_chloe_training) #Chloe Option.","        *gosub_scene training_montages chloe","        *set stat_mental %+6","        *set stat_technique %+2","        *set stat_energy -20","        *gosub_scene utils clamp_energy        ","    *if (stat_energy >= 90) #Rest and recover (not needed).","        *gosub_scene training_montages rest","        *set stat_energy +30    ","        *gosub_scene utils clamp_energy","    *if ((stat_energy >= 60) and (stat_energy < 90)) #Rest and recover.","        *gosub_scene training_montages rest","        *set stat_energy +30    ","        *gosub_scene utils clamp_energy","    *if ((stat_energy >= 30) and (stat_energy < 60)) #Rest and recover (recommended).","        *gosub_scene training_montages rest","        *set stat_energy +30    ","        *gosub_scene utils clamp_energy","    *if (stat_energy < 30) #Rest and recover [b](highly recommended)[/b].","        *gosub_scene training_montages rest","        *set stat_energy +30    ","        *gosub_scene utils clamp_energy","*page_break","*return","","*label character_visit_options","*comment reduce the character cooldowns first. This is the first subroutine visited by the chapters","*if (eric_subplot_status = \"available\")","    *gosub_scene eric_subplot scene_introduction","","*if (katie_subplot_status = \"available\")","    *gosub_scene katie_subplot scene_introduction","","*if (danny_subplot_status = \"available\")","    *gosub_scene danny_subplot scene_introduction","","*if (chloe_subplot_status = \"available\")","    *gosub_scene chloe_subplot scene_introduction","*return","","*label character_visit_choice","*if (eric_plot_timer = 0)","    *set eric_unvisited_timer +1","*if (katie_plot_timer = 0)","    *set katie_unvisited_timer +1","*if (danny_plot_timer = 0)","    *set danny_unvisited_timer +1","*if (chloe_plot_timer = 0)","    *set chloe_unvisited_timer +1","*choice","    *if ((eric_subplot_status = \"available\") and (eric_plot_timer = 0)) #Visit Eric","        *gosub_scene eric_subplot scene_choice","        *set eric_subplot_scene + 1","        *set eric_unvisited_timer 0","        *set eric_almost_lapsed False","","    *if ((katie_subplot_status = \"available\") and (katie_plot_timer = 0)) #Visit Katie","        *gosub_scene katie_subplot scene_choice","        *set katie_subplot_scene + 1","        *set katie_unvisited_timer 0","        *set katie_almost_lapsed False","","    *if ((danny_subplot_status = \"available\") and ((danny_plot_timer = 0) and (danny_subplot_scene = 1))) #Search for Danny","        *gosub_scene danny_subplot scene_choice","        *set danny_subplot_scene +1","        *set danny_unvisited_timer 0","        *set danny_almost_lapsed False","","    *if ((danny_subplot_status = \"available\") and ((danny_plot_timer = 0) and not(danny_subplot_scene = 1))) #Visit Danny","        *gosub_scene danny_subplot scene_choice","        *set danny_subplot_scene +1","        *set danny_unvisited_timer 0","        *set danny_almost_lapsed False","","    *if ((chloe_subplot_status = \"available\") and (chloe_plot_timer = 0)) #Visit Chloe","        *gosub_scene chloe_subplot scene_choice","        *set chloe_subplot_scene + 1","        *set chloe_unvisited_timer 0","        *set chloe_almost_lapsed False","","    #Don't visit anyone","        You decide to keep to yourself this fortnight. While this gives you more free time, you miss the opportunity to expand your network in the fighting scene. You'll have to rely solely on what you learn from your regular training.","*page_break","*return","","*label character_unvisited_check","*comment if you don't visit a character for too long, they are no longer available for visiting","*comment Danny is more patient, Chloe is less patient","*comment this runs before character_visit_choice","*if (eric_subplot_status = \"available\")","    *if (eric_subplot_scene = 1) and (eric_unvisited_timer = 1)","        *set eric_almost_lapsed True","    *elseif (eric_subplot_scene = 1) and (eric_unvisited_timer >= 2)","        *set eric_subplot_status \"lapsed\"","        *set eric_almost_lapsed False","    *elseif (eric_subplot_scene > 1) and (eric_unvisited_timer = 2)","        *set eric_almost_lapsed True","    *elseif (eric_subplot_scene > 1) and (eric_unvisited_timer >= 3)","        *set eric_subplot_status \"lapsed\"","        *set eric_almost_lapsed False","*if (katie_subplot_status = \"available\")","    *if (katie_subplot_scene = 1) and (katie_unvisited_timer = 1)","        *set katie_almost_lapsed True","    *elseif (katie_subplot_scene = 1) and (katie_unvisited_timer >= 2)","        *set katie_subplot_status \"lapsed\"","        *set katie_almost_lapsed False","    *elseif (katie_subplot_scene > 1) and (katie_unvisited_timer = 2)","        *set katie_almost_lapsed True","    *elseif (katie_subplot_scene > 1) and (katie_unvisited_timer >= 3)","        *set katie_subplot_status \"lapsed\"","        *set katie_almost_lapsed False","*if (danny_subplot_status = \"available\")","    *if (danny_subplot_scene = 1) and (danny_unvisited_timer = 2)","        *set danny_almost_lapsed True","    *elseif (danny_subplot_scene = 1) and (danny_unvisited_timer >= 3)","        *set danny_subplot_status \"lapsed\"","        *set danny_almost_lapsed False","    *elseif (danny_subplot_scene > 1) and (danny_unvisited_timer = 3)","        *set danny_almost_lapsed True","    *elseif (danny_subplot_scene > 1) and (danny_unvisited_timer >= 4)","        *set danny_subplot_status \"lapsed\"","        *set danny_almost_lapsed False","*if (chloe_subplot_status = \"available\")","    *if (chloe_subplot_scene = 1) and (chloe_unvisited_timer = 1)","        *set chloe_almost_lapsed True","    *elseif (chloe_subplot_scene = 1) and (chloe_unvisited_timer >= 2)","        *set chloe_subplot_status \"lapsed\"","        *set chloe_almost_lapsed False","    *elseif (chloe_subplot_scene > 1) and (chloe_unvisited_timer = 1)","        *set chloe_almost_lapsed True","    *elseif (chloe_subplot_scene > 1) and (chloe_unvisited_timer >= 2)","        *set chloe_subplot_status \"lapsed\"","        *set chloe_almost_lapsed False","*return","","*label show_fight_momentum","*if (fight_momentum <= 0)","    [i]You're one step from defeat.[/i]","*elseif (fight_momentum = 1)","    [i]You're barely holding on.[/i]","*elseif (fight_momentum = 2)","    [i]${fight_opponent_name}'s pressuring you hard.[/i]","*elseif (fight_momentum = 3)","    [i]${fight_opponent_name} has the edge.[/i]","*elseif (fight_momentum = 4)","    [i]${fight_opponent_name} has a slight edge.[/i]","*elseif (fight_momentum = 5)","    [i]The fight is even.[/i]","*elseif (fight_momentum = 6)","    [i]You have a slight edge.[/i]","*elseif (fight_momentum = 7)","    [i]You have the edge.[/i]","*elseif (fight_momentum = 8)","    [i]You have control of the fight.[/i]","*elseif (fight_momentum = 9)","    [i]${fight_opponent_name} is barely holding on.[/i]","*elseif (fight_momentum >= 10)","    [i]${fight_opponent_name} is one step from defeat.[/i]","*else","    *bug Invalid fight_momentum","*return"], "labels":{"show_stats":1,"calc_adj_stats":8,"clamp_energy":18,"set_power":26,"increase_analysis":33,"increase_composure":38,"increase_empathy":43,"update_highest_trait":48,"update_highest_friendship":65,"calculate_trait_bonus":89,"tick_character_cooldowns":110,"fortnight_choice":126,"character_visit_options":191,"character_visit_choice":206,"character_unvisited_check":251,"show_fight_momentum":301}}}</script><script>
;

;
//
// Copyright (c) 2008, 2009 Paul Duncan (paul@pablotron.org)
// 
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
// 
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
//


/* 
 * The contents of gears_init.js; we need this because Chrome supports
 * Gears out of the box, but still requires this constructor.  Note that
 * if you include gears_init.js then this function does nothing.
 */
(function() {
  // We are already defined. Hooray!
  if (window.google && google.gears)
    return;

  // factory 
  var F = null;

  // Firefox
  if (typeof GearsFactory != 'undefined') {
    F = new GearsFactory();
  } else {
    // IE
    try {
      F = new ActiveXObject('Gears.Factory');
      // privateSetGlobalObject is only required and supported on WinCE.
      if (F.getBuildInfo().indexOf('ie_mobile') != -1)
        F.privateSetGlobalObject(this);
    } catch (e) {
      // Safari
      if ((typeof navigator.mimeTypes != 'undefined')
           && navigator.mimeTypes["application/x-googlegears"]) {
        F = document.createElement("object");
        F.style.display = "none";
        F.width = 0;
        F.height = 0;
        F.type = "application/x-googlegears";
        document.documentElement.appendChild(F);
      }
    }
  }

  // *Do not* define any objects if Gears is not installed. This mimics the
  // behavior of Gears defining the objects in the future.
  if (!F)
    return;

  // Now set up the objects, being careful not to overwrite anything.
  //
  // Note: In Internet Explorer for Windows Mobile, you can't add properties to
  // the window object. However, global objects are automatically added as
  // properties of the window object in all browsers.
  if (!window.google)
    google = {};

  if (!google.gears)
    google.gears = {factory: F};
})();

/**
 * Persist - top-level namespace for Persist library.
 * @namespace
 */
Persist = (function() {
  var VERSION = '0.2.0', P, B, esc, init, empty, ec;

  // easycookie 0.2.1 (pre-minified)
  // (see http://pablotron.org/software/easy_cookie/)
  ec = (function(){var EPOCH='Thu, 01-Jan-1970 00:00:01 GMT',RATIO=1000*60*60*24,KEYS=['expires','path','domain'],esc=escape,un=unescape,doc=document,me;var get_now=function(){var r=new Date();r.setTime(r.getTime());return r;}
var cookify=function(c_key,c_val){var i,key,val,r=[],opt=(arguments.length>2)?arguments[2]:{};r.push(esc(c_key)+'='+esc(c_val));for(i=0;i<KEYS.length;i++){key=KEYS[i];if(val=opt[key])
r.push(key+'='+val);}
if(opt.secure)
r.push('secure');return r.join('; ');}
var alive=function(){var k='__EC_TEST__',v=new Date();v=v.toGMTString();this.set(k,v);this.enabled=(this.remove(k)==v);return this.enabled;}
me={set:function(key,val){var opt=(arguments.length>2)?arguments[2]:{},now=get_now(),expire_at,cfg={};if(opt.expires){cfg.expires=new Date(now.getTime()+opt.expires*RATIO);cfg.expires=cfg.expires.toGMTString();}
var keys=['path','domain','secure'];for(i=0;i<keys.length;i++)
if(opt[keys[i]])
cfg[keys[i]]=opt[keys[i]];var r=cookify(key,val,cfg);doc.cookie=r;return val;},has:function(key){key=esc(key);var c=doc.cookie,ofs=c.indexOf(key+'='),len=ofs+key.length+1,sub=c.substring(0,key.length);return((!ofs&&key!=sub)||ofs<0)?false:true;},get:function(key){key=esc(key);var c=doc.cookie,ofs=c.indexOf(key+'='),len=ofs+key.length+1,sub=c.substring(0,key.length),end;if((!ofs&&key!=sub)||ofs<0)
return null;end=c.indexOf(';',len);if(end<0)
end=c.length;return un(c.substring(len,end));},remove:function(k){var r=me.get(k),opt={expires:EPOCH};doc.cookie=cookify(k,'',opt);return r;},keys:function(){var c=doc.cookie,ps=c.split('; '),i,p,r=[];for(i=0;i<ps.length;i++){p=ps[i].split('=');r.push(un(p[0]));}
return r;},all:function(){var c=doc.cookie,ps=c.split('; '),i,p,r=[];for(i=0;i<ps.length;i++){p=ps[i].split('=');r.push([un(p[0]),un(p[1])]);}
return r;},version:'0.2.1',enabled:false};me.enabled=alive.call(me);return me;}());

  // wrapper for Array.prototype.indexOf, since IE doesn't have it
  var index_of = (function() {
    if (Array.prototype.indexOf)
      return function(ary, val) { 
        return Array.prototype.indexOf.call(ary, val);
      };
    else
      return function(ary, val) {
        var i, l;

        for (i = 0, l = ary.length; i < l; i++)
          if (ary[i] == val)
            return i;

        return -1;
      };
  })();


  // empty function
  empty = function() { };

  /**
   * Escape spaces and underscores in name.  Used to generate a "safe"
   * key from a name.
   *
   * @private
   */
  esc = function(str) {
    return 'PS' + str.replace(/_/g, '__').replace(/ /g, '_s');
  };

  C = {
    /* 
     * Backend search order.
     * 
     * Note that the search order is significant; the backends are
     * listed in order of capacity, and many browsers
     * support multiple backends, so changing the search order could
     * result in a browser choosing a less capable backend.
     */ 
    search_order: [
      // TODO: air
      'steamworksStorage',
      'cefStorage',
      'winOldStorage',
      'winStoreStorage',
      'macStorage',
      'iosStorage',
      'localChromeStorage',
      'androidStorage',
      'indexed_db',
      'whatwg_db', 
      'localstorage',
      'globalstorage', 
      'cookie',
      'gears',
      'ie', 
      'flash'
    ],

    // valid name regular expression
    name_re: /^[a-z][a-z0-9_ -]+$/i,

    // list of backend methods
    methods: [
      'init', 
      'get', 
      'set', 
      'remove', 
      'load', 
      'save'
      // TODO: clear method?
    ],

    // sql for db backends (gears and db)
    sql: {
      version:  '1', // db schema version

      // XXX: the "IF NOT EXISTS" is a sqlite-ism; fortunately all the 
      // known DB implementations (safari and gears) use sqlite
      create:   "CREATE TABLE IF NOT EXISTS persist_data (k TEXT UNIQUE NOT NULL PRIMARY KEY, v TEXT NOT NULL)",
      get:      "SELECT v FROM persist_data WHERE k = ?",
      set:      "INSERT INTO persist_data(k, v) VALUES (?, ?)",
      remove:   "DELETE FROM persist_data WHERE k = ?" 
    },

    // default flash configuration
    flash: {
      // ID of wrapper element
      div_id:   '_persist_flash_wrap',

      // id of flash object/embed
      id:       '_persist_flash',

      // default path to flash object
      path: 'persist.swf',
      size: { w:1, h:1 },

      // arguments passed to flash object
      args: {
        autostart: true
      }
    } 
  };

  // built-in backends
  B = {
    // gears db backend
    // (src: http://code.google.com/apis/gears/api_database.html)
    gears: {
      // no known limit
      size:   -1,

      test: function() {
        // test for gears
        return (window.google && window.google.gears) ? true : false;
      },

      methods: {
        transaction: function(fn) {
          var db = this.db;

          // begin transaction
          db.execute('BEGIN').close();

          // call callback fn
          fn.call(this, db);

          // commit changes
          db.execute('COMMIT').close();
        },

        init: function() {
          var db;

          // create database handle (TODO: add schema version?)
          db = this.db = google.gears.factory.create('beta.database');

          // open database
          // from gears ref:
          //
          // Currently the name, if supplied and of length greater than
          // zero, must consist only of visible ASCII characters
          // excluding the following characters:
          //
          //   / \ : * ? " < > | ; ,
          //
          // (this constraint is enforced in the Store constructor)
          db.open(esc(this.name));

          // create table
          db.execute(C.sql.create).close();
        },

        get: function(key, fn, scope) {
          var r, sql = C.sql.get;

          // if callback isn't defined, then return
          if (!fn)
            return;

          // begin transaction
          this.transaction(function (t) {
            var is_valid, val;
            // exec query
            r = t.execute(sql, [key]);

            // check result and get value
            is_valid = r.isValidRow();
            val = is_valid ? r.field(0) : null;

            // close result set
            r.close();

            // call callback
            fn.call(scope || this, is_valid, val);
          });
        },

        set: function(key, val, fn, scope) {
          var rm_sql = C.sql.remove,
              sql    = C.sql.set, r;

          // begin set transaction
          this.transaction(function(t) {
            // exec remove query
            t.execute(rm_sql, [key]).close();

            // exec set query
            t.execute(sql, [key, val]).close();
            
            // run callback (TODO: get old value)
            if (fn)
              fn.call(scope || this, true, val);
          });
        },

        remove: function(key, fn, scope) {
          var get_sql = C.sql.get;
              sql = C.sql.remove,
              r, val = null, is_valid = false;

          // begin remove transaction
          this.transaction(function(t) {
            // if a callback was defined, then get the old
            // value before removing it
            if (fn) {
              // exec get query
              r = t.execute(get_sql, [key]);

              // check validity and get value
              is_valid = r.isValidRow();
              val = is_valid ? r.field(0) : null;

              // close result set
              r.close();
            }

            // exec remove query if no callback was defined, or if a
            // callback was defined and there was an existing value
            if (!fn || is_valid) {
              // exec remove query
              t.execute(sql, [key]).close();
            }

            // exec callback
            if (fn)
              fn.call(scope || this, is_valid, val);
          });
        } 
      }
    }, 

    steamworksStorage: {
      size:   -1,

      test: function() {
        try {
          return (typeof require !== "undefined" && require('steamworks.js'));
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {

        },

        get: function(key, fn, scope) {
          key = this.key(key);

          // if callback isn't defined, then return
          if (!fn)
            return;

          // get callback scope
          scope = scope || this;

          try {
            results = steamworks.cloud.readFile("store" + key);
            // steamworks.js fails with "" when the file doesn't exist
            if (results === "") return fn.call(scope, !"ok");
            var fixedResults = results.replace(/^.*\n/, "");
            if (!fixedResults.length) return fn.call(scope, !"ok");
            fn.call(scope, "ok", results.replace(/^.*\n/, ""));
          } catch (e) {
            fn.call(scope, !"ok");
          }
        },

        set: function(key, val, fn, scope) {
          key = this.key(key);
          scope = scope || this;
          var ok = steamworks.cloud.writeFile("store" + key, key+"\n"+val);
          if (fn) fn.call(scope, ok);
          return val;
        },

        // begin remove transaction
        remove: function(key, fn, scope) {
          key = this.key(key);
          scope = scope || this;
          var ok = steamworks.cloud.deleteFile("store" + key);
          if (fn) fn.call(scope, ok);
        }
      }
    },

    cefStorage: {
      size:   -1,

      test: function() {
        return !!window.cefQuery;
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {

        },

        query: function(method, paramString, callback) {
          cefQuery({request:method+" "+paramString,
            onSuccess: function(response) {
              callback(true, response);
            },
            onFailure: function(error_code, error_message) {
              console.error(method + " error: " + error_message);
              callback(false);
            }
          });
        },

        get: function(key, fn, scope) {
          key = this.key(key);

          // if callback isn't defined, then return
          if (!fn)
            return;

          // get callback scope
          scope = scope || this;

          this.query("StorageGet", key, function(ok, results) {
            fn.call(scope, ok, results);
          });
        },

        set: function(key, val, fn, scope) {
          key = this.key(key);
          scope = scope || this;
          this.query("StorageSet", key + " " + val, function(ok){
            if (fn) fn.call(scope, ok, val);
          });
          return val;
        },

        // begin remove transaction
        remove: function(key, fn, scope) {
          key = this.key(key);
          scope = scope || this;
          this.query("StorageRemove", key, function(ok) {
            // return original value? meh
            if (fn) fn.call(scope, ok);
          });
        }
      }
    },

    indexed_db: {
      size: -1,
      test: function() {
        return window.indexedDB;
      },
      methods: {
        promisifyRequest: function (request) {
          return new Promise(function(resolve, reject) {
            request.oncomplete = request.onsuccess = function() { resolve(request.result) };
            request.onabort = request.onerror = function() { reject(request.error) };
          });
        },

        init: function() {
          var request = indexedDB.open(this.name);
          request.onupgradeneeded = function () { return request.result.createObjectStore('PersistJS'); };
          var dbp = this.promisifyRequest(request);
          this.getStore = function (txMode, callback) {
            return dbp.then(function (db) {
              return callback(db.transaction('PersistJS', txMode).objectStore('PersistJS'));
            });
          };
        },

        get: function (key, fn, scope) {
          scope = scope || this;
          var self = this;
          this.getStore('readonly', function(store) {
            self.promisifyRequest(store.get(key)).then(function (val) {
              fn.call(scope, true, val);
            })
          }).catch(function(error) {
            console.error(error);
            fn.call(scope, false);
          })
        },

        set: function (key, val, fn, scope) {
          scope = scope || this;
          var self = this;
          this.getStore('readwrite', function (store) {
            store.put(val, key);
            self.promisifyRequest(store.transaction).then(function () {
              if (fn) fn.call(scope, true, val);
            })
          }).catch(function (error) {
            console.error(error);
            if (fn) fn.call(scope, false);
          })
        },

        remove: function (key, val, fn, scope) {
          scope = scope || this;
          var self = this;
          this.getStore('readwrite', function (store) {
            store.delete(key);
            self.promisifyRequest(store.transaction).then(function () {
              if (fn) fn.call(scope, true);
            })
          }).catch(function (error) {
            console.error(error);
            if (fn) fn.call(scope, false);
          })
        },

      },
    },

    // whatwg db backend (webkit, Safari 3.1+)
    // (src: whatwg and http://webkit.org/misc/DatabaseExample.html)
    whatwg_db: {
      // size based on DatabaseExample from above (should I increase
      // this?)
      size:   200 * 1024,

      test: function() {
        var name = 'PersistJS Test', 
            desc = 'Persistent database test.';

        // test for openDatabase
        if (!window.openDatabase)
          return false;

        // make sure openDatabase works
        // XXX: will this leak a db handle and/or waste space?
        if (!window.openDatabase(name, C.sql.version, desc, B.whatwg_db.size))
          return false;

        // return true
        return true;
      },

      methods: {
        transaction: function(fn) {
          // lazy create database table;
          // this is done here because there is no way to
          // prevent a race condition if the table is created in init()
          if (!this.db_created) {
            this.db.transaction(function(t) {
              // create table
              t.executeSql(C.sql.create, [], function() {
                this.db_created = true;
              });
            }, empty); // trap exception
          } 

          // execute transaction
          this.db.transaction(fn);
        },

        init: function() {
          // create database handle
          this.db = openDatabase(
            this.name, 
            C.sql.version, 
            this.o.about || ("Persistent storage for " + this.name),
            this.o.size || B.whatwg_db.size 
          );
        },

        get: function(key, fn, scope) {
          var sql = C.sql.get;

          // if callback isn't defined, then return
          if (!fn)
            return;

          // get callback scope
          scope = scope || this;

          // begin transaction
          this.transaction(function (t) {
            t.executeSql(sql, [key], function(t, r) {
              if (r.rows.length > 0)
                fn.call(scope, true, r.rows.item(0)['v']);
              else
                fn.call(scope, false, null);
            });
          });
        },

        set: function(key, val, fn, scope) {
          var rm_sql = C.sql.remove,
              sql    = C.sql.set;

          // begin set transaction
          this.transaction(function(t) {
            // exec remove query
            t.executeSql(rm_sql, [key], function() {
              // exec set query
              t.executeSql(sql, [key, val], function(t, r) {
                // run callback
                if (fn)
                  fn.call(scope || this, true, val);
              });
            });
          });

          return val;
        },

        // begin remove transaction
        remove: function(key, fn, scope) {
          var get_sql = C.sql.get;
              sql = C.sql.remove;

          this.transaction(function(t) {
            // if a callback was defined, then get the old
            // value before removing it
            if (fn) {
              // exec get query
              t.executeSql(get_sql, [key], function(t, r) {
                if (r.rows.length > 0) {
                  // key exists, get value 
                  var val = r.rows.item(0)['v'];

                  // exec remove query
                  t.executeSql(sql, [key], function(t, r) {
                    // exec callback
                    fn.call(scope || this, true, val);
                  });
                } else {
                  // key does not exist, exec callback
                  fn.call(scope || this, false, null);
                }
              });
            } else {
              // no callback was defined, so just remove the
              // data without checking the old value

              // exec remove query
              t.executeSql(sql, [key]);
            }
          });
        } 
      }
    }, 
    
    // globalstorage backend (globalStorage, FF2+, IE8+)
    // (src: http://developer.mozilla.org/en/docs/DOM:Storage#globalStorage)
    // https://developer.mozilla.org/En/DOM/Storage
    //
    // TODO: test to see if IE8 uses object literal semantics or
    // getItem/setItem/removeItem semantics
    globalstorage: {
      // (5 meg limit, src: http://ejohn.org/blog/dom-storage-answers/)
      size: 5 * 1024 * 1024,

      test: function() {
        try {
          if (window.globalStorage && window.globalStorage[this.o.domain]) return true;
        } catch (e) {}
        return false;
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = globalStorage[this.o.domain];
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          if (fn)
            fn.call(scope || this, true, this.store.getItem(key));
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          this.store.setItem(key, val);

          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          // get value
          val = this.store[key];

          // delete value
          this.store.removeItem(key);

          if (fn)
            fn.call(scope || this, (val !== null), val);
        } 
      }
    }, 
    
    // localstorage backend (globalStorage, FF2+, IE8+)
    // (src: http://www.whatwg.org/specs/web-apps/current-work/#the-localstorage)
    // also http://msdn.microsoft.com/en-us/library/cc197062(VS.85).aspx#_global
    localstorage: {
      // (unknown?)
      // ie has the remainingSpace property, see:
      // http://msdn.microsoft.com/en-us/library/cc197016(VS.85).aspx
      size: -1,

      test: function() {
        try {
          return window.localStorage ? true : false;
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = localStorage;
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          if (fn)
            fn.call(scope || this, true, this.store.getItem(key));
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          this.store.setItem(key, val);

          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          // get value
          val = this.store.getItem(key);

          // delete value
          this.store.removeItem(key);

          if (fn)
            fn.call(scope || this, (val !== null), val);
        } 
      }
    }, 

    // chrome packaged app storage
    // http://developer.chrome.com/stable/apps/storage.html
    localChromeStorage: {
      // (unknown?)
      // ie has the remainingSpace property, see:
      // http://msdn.microsoft.com/en-us/library/cc197016(VS.85).aspx
      size: -1,

      test: function() {
        try {
          return window.chrome && window.chrome.storage && window.chrome.storage.local;
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = chrome.storage.local;
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          scope = scope || this;
          this.store.get(key, function(val){
            if (fn) fn.call(scope, true, val[key]);
          });
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          var out = {};
          out[key] = val;
          if (fn) {
            scope = scope || this;  
            this.store.set(out, function(){
              fn.call(scope, true, val);
            });
          } else {
            this.store.set(out);
          }
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          if (fn) {
            // get value first
            scope = scope || this;
            this.store.get(key, function(val){
              this.store.remove(key, function(){
                fn.call(scope, (val[key] !== null), val[key]);
              });
            });
          } else {
            this.store.remove(key);
          }
        } 
      }
    }, 
    
    // DGF Fake local storage
    androidStorage: {
      // (unknown?)
      // ie has the remainingSpace property, see:
      // http://msdn.microsoft.com/en-us/library/cc197016(VS.85).aspx
      size: -1,

      test: function() {
        try {
          return window.androidStorage ? true : false;
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = androidStorage;
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          var val = this.store.getItem(key);
          if (val === undefined) val = null;

          if (fn)
            fn.call(scope || this, true, val);
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          this.store.setItem(key, val);

          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          // get value
          val = this.store.getItem(key);
          if (val === undefined) val = null;

          // delete value
          this.store.removeItem(key);

          if (fn)
            fn.call(scope || this, (val !== null), val);
        } 
      }
    }, 

    // DGF iOS managed storage
    iosStorage: {
      size: -1,

      test: function() {
        try {
          var userAgent = navigator.userAgent;
          return (window.isIosApp || (/CoGnibus/.test(userAgent) && !/Android/.test(userAgent))) ? true : false;
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {

        },

        callIos: function(scheme, path) {
          if (typeof webkit !== "undefined" && webkit.messageHandlers) {
            return webkit.messageHandlers.choicescript.postMessage([scheme, path]);
          }
          path = encodeURIComponent(path).replace(/[!~*')(]/g, function(match) {
            return "%" + match.charCodeAt(0).toString(16);
          });

          var url = scheme + "://" + path;
          setTimeout(function() {
            var iframe = document.createElement("IFRAME");
            iframe.setAttribute("src", url);
            iframe.setAttribute("style", "display:none");
            document.documentElement.appendChild(iframe);
            iframe.parentNode.removeChild(iframe);
            iframe = null;
          }, 0);
        },

        get: function(key, fn, scope) {
          if (!fn) return;
          // expand key
          key = this.key(key);

          var nonce = "storageget" + key + (+new Date);
          var i = 0;
          while (window[nonce]) {
            nonce = "storageget" + key + (+new Date) + String(i++);
          }
          window[nonce] = function(value) {
            delete window[nonce];
            fn.call(scope || this, true, value);
          }
          this.callIos("storageget", key + " " + nonce);
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          var nonce = "storageset" + key + (+new Date);
          var i = 0;
          while (window[nonce]) {
            nonce = "storageget" + key + (+new Date) + String(i++);
          }
          window[nonce] = function() {
            delete window[nonce];
            if (fn) fn.call(scope || this, true, val);
          }
          this.callIos("storageset", key + " " + nonce + " " + encodeURIComponent(val));
        },

        remove: function(key, fn, scope) {
          if (fn) {
            this.get(key, function(val) {
              this._remove(key, fn, scope, val);
            }, this);
          } else {
            this._remove(key, fn, scope);
          }
        },

        _remove: function(key, fn, scope, val) {
          var val;

          // expand key
          key = this.key(key);

          // delete value
          var nonce = "storagerem" + key + (+new Date);
          var i = 0;
          while (window[nonce]) {
            nonce = "storageget" + key + (+new Date) + String(i++);
          }
          window[nonce] = function() {
            delete window[nonce];
            if (fn) fn.call(scope || this, (val !== null), val);
          }
          this.callIos("storagerem", key + " " + nonce);
        } 
      }
    }, 

    // DGF macOS managed storage
    macStorage: {
      size: -1,

      test: function () {
        return !!window.isMacApp;
      },

      methods: {
        key: function (key) {
          return esc(this.name) + esc(key);
        },

        init: function () {

        },

        callMac: function (scheme, path) {
          if (typeof webkit !== "undefined" && webkit.messageHandlers) {
            return webkit.messageHandlers.choicescript.postMessage([scheme, path]);
          }
        },

        get: function (key, fn, scope) {
          if (!fn) return;
          // expand key
          key = this.key(key);

          var nonce = "storageget" + key + (+new Date);
          var i = 0;
          while (window[nonce]) {
            nonce = "storageget" + key + (+new Date) + String(i++);
          }
          window[nonce] = function (value) {
            delete window[nonce];
            fn.call(scope || this, true, value);
          }
          this.callMac("storageget", key + " " + nonce);
        },

        set: function (key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          var nonce = "storageset" + key + (+new Date);
          var i = 0;
          while (window[nonce]) {
            nonce = "storageget" + key + (+new Date) + String(i++);
          }
          window[nonce] = function () {
            delete window[nonce];
            if (fn) fn.call(scope || this, true, val);
          }
          this.callMac("storageset", key + " " + nonce + " " + encodeURIComponent(val));
        },

        remove: function (key, fn, scope) {
          if (fn) {
            this.get(key, function (val) {
              this._remove(key, fn, scope, val);
            }, this);
          } else {
            this._remove(key, fn, scope);
          }
        },

        _remove: function (key, fn, scope, val) {
          var val;

          // expand key
          key = this.key(key);

          // delete value
          var nonce = "storagerem" + key + (+new Date);
          var i = 0;
          while (window[nonce]) {
            nonce = "storageget" + key + (+new Date) + String(i++);
          }
          window[nonce] = function () {
            delete window[nonce];
            if (fn) fn.call(scope || this, (val !== null), val);
          }
          this.callMac("storagerem", key + " " + nonce);
        }
      }
    }, 

    // DGF Old win app managed storage
    winOldStorage: {
      size: -1,

      test: function() {
        try {
          return window.external.IsWinOldApp();
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = window.external;
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          if (fn)
            fn.call(scope || this, true, this.store.GetValue(key));
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          this.store.SetValue(key, val);

          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          // get value
          val = this.store.GetValue(key)

          // delete value
          this.store.DeleteValue(key);

          if (fn)
            fn.call(scope || this, (val !== null), val);
        } 
      }
    }, 

      // DGF WinStore managed storage
    winStoreStorage: {
        size: -1,

        test: function () {
            try {
                return Windows.Storage.ApplicationData.current.roamingFolder;
            } catch (e) {
                return false;
            }
        },

        methods: {
            key: function (key) {
                return esc(this.name) + esc(key);
            },

            init: function () {
                var self = this;
                function doneLoadingWinStore() {
                  self.loaded = true;
                  for (var i = self.loadListeners.length - 1; i >= 0; i--) {
                    setTimeout(self.loadListeners[i], 0);
                  }
                }
                this.loaded = false;
                this.loadListeners = [];

                Windows.Storage.ApplicationData.current.roamingFolder
                  .createFileAsync("data.txt", Windows.Storage.CreationCollisionOption.openIfExists)
                  .then(function (file) {
                    self.file = file;
                    return Windows.Storage.FileIO.readTextAsync(file);
                  }).done(function (data) {
                    self.store = {};
                    if (data && typeof data == "string") {
                      var rows = data.split("\n");
                      for (var i = rows.length - 1; i >= 0; i--) {
                        var row = rows[i].split("\t");
                        self.store[row[0]] = decodeURIComponent(row[1]);
                      }
                    }
                    doneLoadingWinStore();
                  },
                  function(){
                    self.store = {};
                    doneLoadingWinStore();
                  });
            },

            get: function (key, fn, scope) {
                if (!this.loaded) {
                  var self = this;
                  this.loadListeners.push(function() {self.get(key, fn, scope)});
                  return;
                }
                // expand key
                key = this.key(key);

                if (fn)
                    fn.call(scope || this, true, this.store[key]);
            },

            set: function (key, val, fn, scope) {
                if (!this.loaded) {
                  var self = this;
                  this.loadListeners.push(function() {self.set(key, val, fn, scope)});
                  return;
                }
                // expand key
                key = this.key(key);

                // set value
                this.store[key] = val;
                this.writeAsync();

                if (fn)
                    fn.call(scope || this, true, val);
            },

            remove: function (key, fn, scope) {
                if (!this.loaded) {
                  var self = this;
                  this.loadListeners.push(function() {self.remove(key, fn, scope)});
                  return;
                }
                var val;

                // expand key
                key = this.key(key);

                // get value
                val = this.store[key];

                // delete value
                delete this.store[key];
                this.writeAsync();

                if (fn)
                    fn.call(scope || this, (val !== null), val);
            },

            writeAsync: function() {
              var output = [];
              for (var key in this.store) {
                output.push(key, '\t', encodeURIComponent(this.store[key]), '\n');
              }
              Windows.Storage.FileIO.writeTextAsync(this.file, output.join(''));
            }
        }
    },

    // IE backend
    ie: {
      prefix:   '_persist_data-',
      // style:    'display:none; behavior:url(#default#userdata);',

      // 64k limit
      size:     64 * 1024,

      test: function() {
        // make sure we're dealing with IE
        // (src: http://javariet.dk/shared/browser_dom.htm)
        return window.ActiveXObject ? true : false;
      },

      make_userdata: function(id) {
        var el = document.createElement('div');

        // set element properties
        // http://msdn.microsoft.com/en-us/library/ms531424(VS.85).aspx 
        // http://www.webreference.com/js/column24/userdata.html
        el.id = id;
        el.style.display = 'none';
        el.addBehavior('#default#userdata');

        // append element to body
        document.body.appendChild(el);

        // return element
        return el;
      },

      methods: {
        init: function() {
          var id = B.ie.prefix + esc(this.name);

          // save element
          this.el = B.ie.make_userdata(id);

          // load data
          if (this.o.defer)
            this.load();
        },

        get: function(key, fn, scope) {
          var val;

          // expand key
          key = esc(key);

          // load data
          if (!this.o.defer)
            this.load();

          // get value
          val = this.el.getAttribute(key);

          // call fn
          if (fn)
            fn.call(scope || this, val ? true : false, val);
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = esc(key);
          
          // set attribute
          this.el.setAttribute(key, val);

          // save data
          if (!this.o.defer)
            this.save();

          // call fn
          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = esc(key);

          // load data
          if (!this.o.defer)
            this.load();

          // get old value and remove attribute
          val = this.el.getAttribute(key);
          this.el.removeAttribute(key);

          // save data
          if (!this.o.defer)
            this.save();

          // call fn
          if (fn)
            fn.call(scope || this, val ? true : false, val);
        },

        load: function() {
          this.el.load(esc(this.name));
        },

        save: function() {
          this.el.save(esc(this.name));
        }
      }
    },

    // cookie backend
    // uses easycookie: http://pablotron.org/software/easy_cookie/
    cookie: {
      delim: ':',

      // 4k limit (low-ball this limit to handle browser weirdness, and 
      // so we don't hose session cookies)
      size: 4000,

      test: function() {
        // XXX: use easycookie to test if cookies are enabled
        return P.Cookie.enabled ? true : false;
      },

      methods: {
        key: function(key) {
          return this.name + B.cookie.delim + key;
        },

        get: function(key, fn, scope) {
          var val;

          // expand key 
          key = this.key(key);

          // get value
          val = ec.get(key);

          // call fn
          if (fn)
            fn.call(scope || this, val != null, val);
        },

        set: function(key, val, fn, scope) {
          // expand key 
          key = this.key(key);

          // save value
          ec.set(key, val, this.o);

          // call fn
          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, val, fn, scope) {
          var val;

          // expand key 
          key = this.key(key);

          // remove cookie
          val = ec.remove(key)

          // call fn
          if (fn)
            fn.call(scope || this, val != null, val);
        } 
      }
    },

    // flash backend (requires flash 8 or newer)
    // http://kb.adobe.com/selfservice/viewContent.do?externalId=tn_16194&sliceId=1
    // http://livedocs.adobe.com/flash/8/main/wwhelp/wwhimpl/common/html/wwhelp.htm?context=LiveDocs_Parts&file=00002200.html
    flash: {
      test: function() {
        // TODO: better flash detection
        if (!window.deconcept || !window.deconcept.SWFObjectUtil)
          return false;

        // get the major version
        var major = deconcept.SWFObjectUtil.getPlayerVersion().major;

        // check flash version (require 8.0 or newer)
        return (major >= 8) ? true : false;
      },

      methods: {
        init: function() {
          if (!B.flash.el) {
            var o, key, el, cfg = C.flash;

            // create wrapper element
            el = document.createElement('div');
            el.id = cfg.div_id;

            // FIXME: hide flash element
            // el.style.display = 'none';

            // append element to body
            document.body.appendChild(el);

            // create new swf object
            o = new deconcept.SWFObject(this.o.swf_path || cfg.path, cfg.id, cfg.size.w, cfg.size.h, '8');

            // set parameters
            for (key in cfg.args)
              o.addVariable(key, cfg.args[key]);

            // write flash object
            o.write(el);

            // save flash element
            B.flash.el = document.getElementById(cfg.id);
          }

          // use singleton flash element
          this.el = B.flash.el;
        },

        get: function(key, fn, scope) {
          var val;

          // escape key
          key = esc(key);

          // get value
          val = this.el.get(this.name, key);

          // call handler
          if (fn)
            fn.call(scope || this, val !== null, val);
        },

        set: function(key, val, fn, scope) {
          var old_val;

          // escape key
          key = esc(key);

          // set value
          old_val = this.el.set(this.name, key, val);

          // call handler
          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // get key
          key = esc(key);

          // remove old value
          val = this.el.remove(this.name, key);

          // call handler
          if (fn)
            fn.call(scope || this, true, val);
        }
      }
    }
  };

  /**
   * Test for available backends and pick the best one.
   * @private
   */
  var init = function() {
    var i, l, b, key, fns = C.methods, keys = C.search_order;

    // set all functions to the empty function
    for (i = 0, l = fns.length; i < l; i++) 
      P.Store.prototype[fns[i]] = empty;

    // clear type and size
    P.type = null;
    P.size = -1;

    // loop over all backends and test for each one
    for (i = 0, l = keys.length; !P.type && i < l; i++) {
      b = B[keys[i]];

      // test for backend
      try {
        if (b.test()) {
          // found backend, save type and size
          P.type = keys[i];
          P.size = b.size;

          // extend store prototype with backend methods
          for (key in b.methods)
            P.Store.prototype[key] = b.methods[key];
        }
      } catch (e) {}
    }

    // mark library as initialized
    P._init = true;
  };

  // create top-level namespace
  P = {
    // version of persist library
    VERSION: VERSION,

    // backend type and size limit
    type: null,
    size: 0,

    // XXX: expose init function?
    // init: init,

    add: function(o) {
      // add to backend hash
      B[o.id] = o;

      // add backend to front of search order
      C.search_order = [o.id].concat(C.search_order);

      // re-initialize library
      init();
    },

    remove: function(id) {
      var ofs = index_of(C.search_order, id);
      if (ofs < 0)
        return;

      // remove from search order
      C.search_order.splice(ofs, 1);

      // delete from lut
      delete B[id];

      // re-initialize library
      init();
    },

    // expose easycookie API
    Cookie: ec,

    // store API
    Store: function(name, o) {
      // verify name
      if (!C.name_re.exec(name))
        throw new Error("Invalid name");

      // XXX: should we lazy-load type?
      // if (!P._init)
      //   init();

      if (!P.type)
        throw new Error("No suitable storage found");

      o = o || {};
      this.name = name;

      // get domain (XXX: does this localdomain fix work?)
      o.domain = o.domain || location.host || 'localhost';
      
      // strip port from domain (XXX: will this break ipv6?)
      o.domain = o.domain.replace(/:\d+$/, '')

      // append localdomain to domains w/o '."
      // (see https://bugzilla.mozilla.org/show_bug.cgi?id=357323)
      // (file://localhost/ works, see: 
      // https://bugzilla.mozilla.org/show_bug.cgi?id=469192)
/* 
 *       if (!o.domain.match(/\./))
 *         o.domain += '.localdomain';
 */ 

      this.o = o;

      // expires in 2 years
      o.expires = o.expires || 365 * 2;

      // set path to root
      o.path = o.path || '/';

      // call init function
      this.init();
    } 
  };

  // init persist
  init();

  // return top-level namespace
  return P;
})();

;
/**
 * alertify
 * An unobtrusive customizable JavaScript notification system
 *
 * @author Fabien Doiron <fabien.doiron@gmail.com>
 * @copyright Fabien Doiron 2012
 * @license MIT <http://opensource.org/licenses/mit-license.php>
 * @link http://fabien-d.github.com/alertify.js/
 * @module alertify
 * @version 0.3.0
 */
(function(e,t){"use strict";var n=e.document,r;r=function(){var r={},i={},s=!1,o={ENTER:13,ESC:27,SPACE:32},u=[],a,f,l,c,h;return i={buttons:{holder:'<nav class="alertify-buttons">{{buttons}}</nav>',submit:'<button type="submit" class="alertify-button alertify-button-ok" id="alertify-ok" />{{ok}}</button>',ok:'<a href="#" class="alertify-button alertify-button-ok" id="alertify-ok">{{ok}}</a>',cancel:'<a href="#" class="alertify-button alertify-button-cancel" id="alertify-cancel">{{cancel}}</a>'},input:'<div class="alertify-text-wrapper"><input type="text" class="alertify-text" id="alertify-text"></div>',message:'<p class="alertify-message">{{message}}</p>',log:'<article class="alertify-log{{class}}">{{message}}</article>'},a=function(e){return n.getElementById(e)},r={labels:{ok:"OK",cancel:"Cancel"},delay:5e3,addListeners:function(r){var i=a("alertify-resetFocus"),s=a("alertify-ok")||t,u=a("alertify-cancel")||t,f=a("alertify-text")||t,l=a("alertify-form")||t,c=typeof s!="undefined",h=typeof u!="undefined",p=typeof f!="undefined",d="",v=this,m,g,y,b,w;m=function(e){typeof e.preventDefault!="undefined"&&e.preventDefault(),y(e),typeof f!="undefined"&&(d=f.value),typeof r=="function"&&r(!0,d)},g=function(e){typeof e.preventDefault!="undefined"&&e.preventDefault(),y(e),typeof r=="function"&&r(!1)},y=function(e){v.hide(),v.unbind(n.body,"keyup",b),v.unbind(i,"focus",w),p&&v.unbind(l,"submit",m),c&&v.unbind(s,"click",m),h&&v.unbind(u,"click",g)},b=function(e){var t=e.keyCode;t===o.SPACE&&!p&&m(e),t===o.ESC&&h&&g(e)},w=function(e){p?f.focus():h?u.focus():s.focus()},this.bind(i,"focus",w),c&&this.bind(s,"click",m),h&&this.bind(u,"click",g),this.bind(n.body,"keyup",b),p&&this.bind(l,"submit",m),e.setTimeout(function(){f?(f.focus(),f.select()):s.focus()},50)},bind:function(e,t,n){typeof e.addEventListener=="function"?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n)},build:function(e){var t="",n=e.type,r=e.message,s=e.cssClass||"";t+='<div class="alertify-dialog">',n==="prompt"&&(t+='<form id="alertify-form">'),t+='<article class="alertify-inner">',t+=i.message.replace("{{message}}",r),n==="prompt"&&(t+=i.input),t+=i.buttons.holder,t+="</article>",n==="prompt"&&(t+="</form>"),t+='<a id="alertify-resetFocus" class="alertify-resetFocus" href="#">Reset Focus</a>',t+="</div>";switch(n){case"confirm":t=t.replace("{{buttons}}",i.buttons.cancel+i.buttons.ok),t=t.replace("{{ok}}",this.labels.ok).replace("{{cancel}}",this.labels.cancel);break;case"prompt":t=t.replace("{{buttons}}",i.buttons.cancel+i.buttons.submit),t=t.replace("{{ok}}",this.labels.ok).replace("{{cancel}}",this.labels.cancel);break;case"alert":t=t.replace("{{buttons}}",i.buttons.ok),t=t.replace("{{ok}}",this.labels.ok);break;default:}return c.className="alertify alertify-show alertify-"+n+" "+s,l.className="alertify-cover",t},close:function(e,t){var n=t&&!isNaN(t)?+t:this.delay;this.bind(e,"click",function(){h.removeChild(e)}),setTimeout(function(){typeof e!="undefined"&&e.parentNode===h&&h.removeChild(e)},n)},dialog:function(e,t,r,i,o){f=n.activeElement;var a=function(){if(c&&c.scrollTop!==null)return;a()};if(typeof e!="string")throw new Error("message must be a string");if(typeof t!="string")throw new Error("type must be a string");if(typeof r!="undefined"&&typeof r!="function")throw new Error("fn must be a function");return typeof this.init=="function"&&(this.init(),a()),u.push({type:t,message:e,callback:r,placeholder:i,cssClass:o}),s||this.setup(),this},extend:function(e){if(typeof e!="string")throw new Error("extend method must have exactly one paramter");return function(t,n){return this.log(t,e,n),this}},hide:function(){u.splice(0,1),u.length>0?this.setup():(s=!1,c.className="alertify alertify-hide alertify-hidden",l.className="alertify-cover alertify-hidden",f?f.focus():null)},init:function(){n.createElement("nav"),n.createElement("article"),n.createElement("section"),l=n.createElement("div"),l.setAttribute("id","alertify-cover"),l.className="alertify-cover alertify-hidden",n.body.appendChild(l),c=n.createElement("section"),c.setAttribute("id","alertify"),c.className="alertify alertify-hidden",n.body.appendChild(c),h=n.createElement("section"),h.setAttribute("id","alertify-logs"),h.className="alertify-logs",n.body.appendChild(h),n.body.setAttribute("tabindex","0"),delete this.init},log:function(e,t,n){var r=function(){if(h&&h.scrollTop!==null)return;r()};return typeof this.init=="function"&&(this.init(),r()),this.notify(e,t,n),this},notify:function(e,t,r){var i=n.createElement("article");i.className="alertify-log"+(typeof t=="string"&&t!==""?" alertify-log-"+t:""),i.innerHTML=e,h.insertBefore(i,h.firstChild),setTimeout(function(){i.className=i.className+" alertify-log-show"},50),this.close(i,r)},set:function(e){var t;if(typeof e!="object"&&e instanceof Array)throw new Error("args must be an object");for(t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},setup:function(){var e=u[0];s=!0,c.innerHTML=this.build(e),typeof e.placeholder=="string"&&e.placeholder!==""&&(a("alertify-text").value=e.placeholder),this.addListeners(e.callback)},unbind:function(e,t,n){typeof e.removeEventListener=="function"?e.removeEventListener(t,n,!1):e.detachEvent&&e.detachEvent("on"+t,n)}},{alert:function(e,t,n){return r.dialog(e,"alert",t,"",n),this},confirm:function(e,t,n){return r.dialog(e,"confirm",t,"",n),this},extend:r.extend,init:r.init,log:function(e,t,n){return r.log(e,t,n),this},prompt:function(e,t,n,i){return r.dialog(e,"prompt",t,n,i),this},success:function(e,t){return r.log(e,"success",t),this},error:function(e,t){return r.log(e,"error",t),this},set:function(e){r.set(e)},labels:r.labels}},typeof define=="function"?define([],function(){return new r}):typeof e.alertify=="undefined"&&(e.alertify=new r)})(this);
;
/*
 * Copyright 2010 by Dan Fabulich.
 * 
 * Dan Fabulich licenses this file to you under the
 * ChoiceScript License, Version 1.0 (the "License"); you may
 * not use this file except in compliance with the License. 
 * You may obtain a copy of the License at
 * 
 *  http://www.choiceofgames.com/LICENSE-1.0.txt
 * 
 * See the License for the specific language governing
 * permissions and limitations under the License.
 * 
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied.
 */

_global = typeof globalThis !== "undefined" ? globalThis : this;

(function() {
  var userAgent, url, protocol, appMeta;
  if (typeof window !== "undefined") {
    userAgent = navigator.userAgent;
    url = window.location.href;
    protocol = window.location.protocol;
    appMeta = window.document.querySelector("meta[name=apple-itunes-app]");
  }
  _global.isWebOS = /webOS/.test(userAgent);
  _global.isMobile = _global.isWebOS || /Mobile/.test(userAgent);
  _global.isFile = /^file:/.test(url);
  _global.isXul = /^chrome:/.test(url);
  try {
    _global.steamworksApi = require('steamworks.js');
    _global.isSteamworks = true;
  } catch (ignored) {}
  _global.isWinOldApp = false;
  try {
    isWinOldApp = window.external.IsWinOldApp();
  } catch (ignored) {}
  _global.isAndroid = /Android/.test(userAgent);
  _global.isOmnibusApp = /CoGnibus/.test(userAgent);
  _global.isIosApp = _global.isIosApp || (_global.isOmnibusApp && !_global.isAndroid);
  _global.isAndroidApp = _global.isAndroidApp || (_global.isOmnibusApp && _global.isAndroid);
  _global.isAmazonAndroidApp = _global.isAmazonAndroidApp || (_global.isAndroidApp && _global.flavor && _global.flavor.isAmazon());
  _global.isWeb = !_global.isIosApp && !_global.isAndroidApp && !_global.isWinOldApp && /^https?:/.test(url);
  _global.isSecureWeb = /^https:?$/.test(protocol);
  _global.isSafari = /Safari/.test(userAgent);
  _global.isIE = /(MSIE|Trident)/.test(userAgent);
  _global.isIPad = /iPad/.test(userAgent);
  _global.isIPhone = /iPhone/.test(userAgent);
  _global.isKindleFire = /Kindle Fire/.test(userAgent);
  _global.isWinStoreApp = "ms-appx:" == protocol;
  _global.isCef = !!_global.cefQuery;
  _global.isNode = typeof process !== "undefined";
  _global.isHeartsChoice = appMeta && /1487052276/.test(appMeta.getAttribute("content"))
})();

_global.loadTime = new Date().getTime();

function callIos(scheme, path) {
  if (!_global.isIosApp) return;
  if (typeof webkit !== "undefined" && webkit.messageHandlers) {
    return webkit.messageHandlers.choicescript.postMessage([scheme, path]);
  }
  if (path) {
    path = encodeURIComponent(path).replace(/[!~*')(]/g, function(match) {
      return "%" + match.charCodeAt(0).toString(16);
    });
  } else {
    path = "";
  }
  setTimeout(function() {
    var iframe = document.createElement("IFRAME");
    iframe.setAttribute("src", scheme + "://" + path);
    iframe.setAttribute("style", "display:none");
    document.documentElement.appendChild(iframe);
    iframe.parentNode.removeChild(iframe);
    iframe = null;
  }, 0);
}

function callMac(scheme, path) {
  if (typeof webkit !== "undefined" && webkit.messageHandlers) {
    return webkit.messageHandlers.choicescript.postMessage([scheme, path]);
  }
}

function safeCall(obj, fn) {
    if (!fn) return;
    var isHeadless = typeof window == "undefined";
    var debug = false || (!isHeadless && window.debug);
    if (isIE || isHeadless) {
        // just call through; onerror will be called and debugger will handle it
        if (typeof MSApp != "undefined") {
            if (obj) {
                MSApp.execUnsafeLocalFunction(function () { fn.call(obj); });
            } else {
                MSApp.execUnsafeLocalFunction(fn);
            }
        } else if (obj) {
            fn.call(obj);
        } else {
            fn.call();
        }
    } else {
        try {
            if (obj) {
                fn.call(obj);
            } else {
                fn.call();
            }
        } catch (e) {
            if (e.message) {
              window.reportError(e.message, e.fileName, e.lineNumber, e.columnNumber, e);
            } else if (e.stack) {
              window.reportError(e.stack, e.fileName, e.lineNumber, e.columnNumber, e);
            } else {
              window.reportError(toJson(e, '\n'));
            }

            if (window.console) {
              window.console.error(e);
              if (e.message) window.console.error("Message: " + e.message);
              if (e.stack) window.console.error("Stack: " + e.stack);
            }
            // Rethrow here so the debugger can handle it
            // On Firefox this causes a second prompt.  Meh!
            if (debug) throw e;
        }
    }
}

function safeCallback(callback) {
  return function() {
    safeCall(null, callback);
  };
}

function safeTimeout(fn, time) {
  setTimeout(function() {
    safeCall(null, fn);
  }, time);
}

function isDefined(x) {
    return "undefined" !== typeof x;
}

function jsonStringifyAscii(obj) {
  var output = JSON.stringify(obj).replace(/(.)/g, function(x) {
    var code = x.charCodeAt(0);
    if (code > 127 || code < 32) {
     var outCode = code.toString(16);
     switch (outCode.length) {
       case 4:
         return "\\u" + outCode;
       case 3:
         return "\\u0" + outCode;
       case 2:
         return "\\u00" + outCode;
       case 1:
         return "\\u000" + outCode;
       default:
         return x;
     }
    }
    return x;
  });
  return output;
}

function toJson(obj, standardized) {
 if (typeof JSON != "undefined" && JSON.stringify) {
  return jsonStringifyAscii(obj);
 }
 switch (typeof obj) {
  case 'object':
   if (obj) {
    var list = [];
    if (obj instanceof Array) {
     for (var i=0;i < obj.length;i++) {
      list.push(toJson(obj[i], standardized));
     }
     return '[' + list.join(',') + ']';
    } else {
     for (var prop in obj) {
      if (prop == "scene") continue;
      if (!standardized && /^[a-zA-Z][a-zA-Z_0-9]\w+$/.test(prop) && !/\b(abstract|boolean|break|byte|case|catch|char|class|comment|const|continue|debugger|default|delete|do|double|else|enum|export|extends|false|final|finally|float|for|function|goto|if|implements|import|in|instanceof|int|interface|label|long|native|new|null|package|private|protected|public|return|short|static|super|switch|synchronized|this|throws|transient|true|try|typeof|var|void|volatile|while|with)\b/.test(prop)) {
        list.push(prop + ':' + toJson(obj[prop], standardized));
      } else {
        list.push('"' + prop + '":' + toJson(obj[prop], standardized));
      }
     }
     return '{' + list.join(',') + '}';
    }
   } else {
    return 'null';
   }
   break;
  case 'string':
   var encoded = obj.replace(/(.)/g, function(x) {
     if (x == "'" || x == '"' || x == '\\') {
       return "\\" + x;
     }
     var code = x.charCodeAt(0);
     if (code > 127 || code < 32) {
       var outCode = code.toString(16);
       switch (outCode.length) {
         case 4:
           return "\\u" + outCode;
         case 3:
           return "\\u0" + outCode;
         case 2:
           return "\\u00" + outCode;
         case 1:
           return "\\u000" + outCode;
         default:
           return x;
       }
     }
     return x;
   });
   return '"' + encoded + '"';
  case 'number':
  case 'boolean':
   return String(obj);
  case 'function':
   return 'badfunction';
  case 'undefined':
    return 'undefined';
  default:
   throw new Error("invalid type: " + typeof obj);
 }
}

var loginUrlBase = "https://www.choiceofgames.com/api/";
function xhrAuthRequest(method, endpoint, callback) {
  var paramBuilder = new Array(arguments.length*3);
  for (var i = 3; i < arguments.length; i=i+2) {
    if (i > 3) paramBuilder.push("&");
    paramBuilder.push(arguments[i]);
    paramBuilder.push("=");
    paramBuilder.push(arguments[i+1]);
  }
  var params = paramBuilder.join("");
  var xhr = findXhr();
  if (method == "POST") {
    xhr.open(method, loginUrlBase + endpoint + ".php", true);
    xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
  } else {
    xhr.open(method, loginUrlBase + endpoint + ".php?" + params, true);
  }

  var done = false;

  xhr.onreadystatechange = function() {
    if (done) return;
    if (xhr.readyState != 4) return;
    done = true;
    var ok = xhr.status == 200;
    var response = {};
    try {
      if (xhr.responseText) response = JSON.parse(xhr.responseText);
    } catch (e) {
      ok = false;
    }
    if (!ok) {
      if (!response.error) response.error = "unknown error";
      response.status = xhr.status;
    }
    if (callback) safeCall(null, function() {callback(ok, response);});
  };
  xhr.send(params);
}

function login(email, password, register, subscribe, callback) {
  xhrAuthRequest("POST", "login", callback, "email", encodeURIComponent(email), "password", encodeURIComponent(password), "register", register, "subscribe", subscribe);
}

function forgotPassword(email, callback) {
  xhrAuthRequest("POST", "forgot", callback, "email", encodeURIComponent(email));
}

function logout(callback) {
  document.cookie = 'login=0;path=/;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
  xhrAuthRequest("GET", "logout", callback);
  recordLogin(false);
  window.knownPurchases = null;
  window.registered = false;
  if (typeof FB != "undefined" && FB.logout) FB.logout();
  if (typeof gapi != "undefined" && gapi.auth && gapi.auth.signOut) gapi.auth.signOut();
}

function recordLogin(registered, loginId, email, callback) {
  if (initStore()) {
    if (registered) recordEmail(email);
    window.store.set("login", loginId || 0, function() {safeCall(null, callback);});
    window.registered = registered;
  } else {
    safeTimeout(callback, 0);
  }
}

function getRemoteEmail(callback) {
  xhrAuthRequest("GET", "getuser", callback);
}

function saveCookie(callback, slot, stats, temps, lineNum, indent, deleted, undeleted) {
    var value = computeCookie(stats, temps, lineNum, indent, deleted, undeleted);
    return writeCookie(value, slot, callback);
}

function computeCookie(stats, temps, lineNum, indent, deleted, undeleted) {
  var scene = stats.scene;
  delete stats.scene;
  if (scene) stats.sceneName = scene.name;
  var version = "UNKNOWN";
  if (typeof(window) != "undefined" && window && window.version) version = window.version;
  var obj = { version: version, stats: stats, temps: temps, lineNum: lineNum, indent: indent };
  if (deleted) obj.deleted = deleted;
  if (undeleted) obj.undeleted = undeleted;
  var value = toJson(obj);
  stats.scene = scene;
  return value;
}

function writeCookie(value, slot, callback) {
  if (!_global.pseudoSave) _global.pseudoSave = {};
  if (!slot) {
    slot = "";
  }
  _global.pseudoSave[slot] = value;
  if (!initStore()) {
    if (callback) safeTimeout(callback, 0);
    return;
  }
  window.store.set("state"+slot, value, safeCallback(callback));
}

function clearCookie(callback, slot) {
    writeCookie('', slot, safeCallback(callback));
}

function areSaveSlotsSupported() {
  return !!(initStore() && window.Persist.type != "cookie");
}

function recordSave(slot, callback) {
  if (!areSaveSlotsSupported()) {
    safeTimeout(callback, 0);
    return;
  }
  restoreObject(initStore(), "save_list", [], function (saveList) {
    saveList.push(slot);
    window.store.set("save_list", toJson(saveList), safeCallback(callback));
  });
}

function recordDirtySlots(slots, callback) {
  if (!areSaveSlotsSupported()) {
    safeTimeout(callback, 0);
    return;
  }
  restoreObject(initStore(), "dirty_save_list", [], function (saveList) {
    saveSet = {};
    for (var i = 0; i < saveList.length; i++) {
      saveSet[saveList[i]] = 1;
    }
    for (i = 0; i < slots.length; i++) {
      if (!saveSet[slots[i]]) saveList.push(slots[i]);
    }
    window.store.set("dirty_save_list", toJson(saveList), safeCallback(callback));
  });
}

function recordEmail(email, callback) {
  if (initStore()) {
    window.recordedEmail = email;
    window.store.set("email", email, safeCallback(callback));
  } else {
    safeTimeout(callback, 0);
  }
}

function fetchEmail(callback) {
  if (!initStore()) {
    safeTimeout(function(){callback("");}, 0);
    return;
  }
  if (window.recordedEmail) {
    return safeTimeout(function() {
      callback(window.recordedEmail);
    })
  }
  if (window.isWeb) {
    var cookieEmail = getCookieByName("login");
    if (/@/.test(cookieEmail)) {
      return recordEmail(cookieEmail, function() {
        callback(cookieEmail);
      });
    }
  }
  // For some reason, this get seems to not respond sometimes
  // adding a fallback timeout
  window.store.get("email", function(ok, value) {
    safeCall(null, function() {
      if (ok) window.recordedEmail = value;
      if (!callback) return;
      var temp = callback;
      callback = null;
      if (ok && value) {
        temp(value);
      } else {
        temp("");
      }
    });
  });
  safeTimeout(function() {
    if (!callback) return;
    var temp = callback;
    callback = null;
    temp("");
  }, 1000);
}

function restoreObject(store, key, defaultValue, callback) {
  if (!store) {
    safeTimeout(function() {callback(defaultValue);}, 0);
    return;
  }
  store.get(key, function(ok, value) {
    var result = defaultValue;
    if (ok && value) {
      try{
        result = jsonParse(value);
      } catch (e) {}
    }
    safeCall(null, function() {callback(result);});
  });
}

function getDirtySaveList(callback) {
  restoreObject(initStore(), "dirty_save_list", [], function (slotList) {
    callback(slotList);
  });
}

function remoteSaveMerger(i, callback) {
  var remoteStore = new Persist.Store(window.remoteStoreNames[i]);
  restoreObject(remoteStore, "save_list", [], function (remoteSlotList) {
    fetchSavesFromSlotList(remoteStore, remoteSlotList, 0, [], function(remoteSaveList) {
      mergeRemoteSaves(remoteSaveList, 0/*recordDirty*/, function() {
        i++;
        if (i < window.remoteStoreNames.length) {
          remoteSaveMerger(i, callback);
        } else {
          callback.apply(null, arguments);
        }
      });
    });
  });
}

function getSaves(callback) {
  if (window.remoteStoreNames && window.remoteStoreNames.length) {
    remoteSaveMerger(0, callback);
  } else if (window.remoteStoreName && window.storeName != window.remoteStoreName) {
    var remoteStore = new Persist.Store(window.remoteStoreName);
    restoreObject(remoteStore, "save_list", [], function (remoteSlotList) {
      fetchSavesFromSlotList(remoteStore, remoteSlotList, 0, [], function(remoteSaveList) {
        mergeRemoteSaves(remoteSaveList, 0/*recordDirty*/, callback);
      });
    });
  } else {
    restoreObject(initStore(), "save_list", [], function (localSlotList) {
      fetchSavesFromSlotList(initStore(), localSlotList, 0, [], callback);
    });
  }
}

function fetchSavesFromSlotList(store, slotList, i, saveList, callback) {
  if (i >= slotList.length) {
    return safeCall(null, function() {callback(saveList);});
  }
  restoreObject(store, "state"+slotList[i], null, function(saveState) {
    if (saveState) {
      saveState.timestamp = slotList[i].substring(4/*"save".length*/);
      saveList.push(saveState);
    }
    fetchSavesFromSlotList(store, slotList, i+1, saveList, callback);
  });
}

function isWebSavePossible() {
  if (!initStore()) return false;
  if (!_global.isCogPublished) return false;
  if (/^http/.test(window.location.protocol)) {
    return document.domain == window.webSaveDomain || document.domain == "localhost";
  }
  // if it's a file URL with a valid store, either you're a 3rd party developer
  // who knows what you're doing, or you're a mobile app
  return true;
}


webSaveDomain = "www.choiceofgames.com";
webSaveUrl = "https://" + webSaveDomain + "/ajax_proxy.php/websave";

function submitRemoteSave(slot, email, subscribe, callback) {
  if (!isWebSavePossible()) return safeTimeout(function() { callback(false); });
  window.store.get("state"+slot, function(ok, value) {
    if (ok) {
      var timestamp = slot.substring(4/*"save".length*/);
      var xhr = findXhr();
      var gameName = window.remoteStoreName || window.storeName;
      var params = "email="+email+"&game="+gameName+"&realGame="+window.storeName+"&json="+encodeURIComponent(value)+"&timestamp="+ timestamp+"&subscribe="+subscribe;
      xhr.open("POST", webSaveUrl,true);
      xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
      var done = false;

      xhr.onreadystatechange = function() {
        if (done) return;
        if (xhr.readyState != 4) return;
        done = true;
        var ok = xhr.status == 200;
        if (ok) {
          safeCall(null, function() {callback(true);});
        } else {
          recordDirtySlots([slot], function() {
            safeCall(null, function() {callback(false);});
          });
        }
      };
      xhr.send(params);
    } else {
      recordDirtySlots([slot], function() {
        asyncAlert("There was a problem uploading the saved game. This is probably a bug; please contact support@choiceofgames.com with code 17891.", function() {
          safeCall(null, function() {callback(false);});
        });
      });
    }
  });
}

function submitDirtySaves(dirtySaveList, email, callback) {
  function submitDirtySave(i) {
    if (dirtySaveList[i]) {
      submitRemoteSave(dirtySaveList[i], email, false, function(ok) {
        if (ok) {
          submitDirtySave(i+1);
        } else {
          safeCall(null, function() {callback(false);});
        }
      });
    } else {
      window.store.remove("dirty_save_list", function() {
        safeCall(null, function() {callback(true);});
      });
    }
  }
  submitDirtySave(0);
}

function submitAnyDirtySaves(callback) {
  if (!callback) callback = function(ok) {};
  try {
    getDirtySaveList(function(dirtySaveList) {
      if (dirtySaveList && dirtySaveList.length) {
        try {
          fetchEmail(function(email) {
            if (email) {
              submitDirtySaves(dirtySaveList, email, callback);
            } else {
              callback(false);
            }
          });
        } catch (e) {
          callback(false);
        }
      }
    });
  } catch (e) {
    callback(false);
  }
}

function getRemoteSaves(email, callback) {
  if (!isWebSavePossible()) {
    safeTimeout(function() {callback([]);}, 0);
    return;
  }
  var xhr = findXhr();
  var gameName = window.remoteStoreName || window.storeName;
  xhr.open("GET", webSaveUrl + "?email="+email+"&game="+gameName, true);
  var done = false;
  xhr.onreadystatechange = function() {
    if (done) return;
    if (xhr.readyState != 4) return;
    done = true;
    if (xhr.status != 200) {
      if (window.console) console.log("Couldn't load remote saves. " + xhr.status + ": " + xhr.responseText);
      safeCall(null, function() {callback(null);});
    } else {
      var result = xhr.responseText;
      result = jsonParse(result);
      var remoteSaveList = [];
      for (var i = 0; i < result.length; i++) {
        if (!result[i]) continue;
        var save = result[i].json;
        if (!save) continue;
        save.timestamp = result[i].timestamp;
        remoteSaveList.push(save);
      }
      safeCall(null, function() {callback(remoteSaveList);});
    }
  };
  xhr.send();
}

function mergeRemoteSaves(remoteSaveList, recordDirty, callback) {
  if (!isWebSavePossible()) {
    safeTimeout(function() { callback([], 0, []); }, 0);
    return;
  }
  restoreObject(initStore(), "save_list", [], function (localSlotList) {
    fetchSavesFromSlotList(initStore(), localSlotList, 0, [], function(localSaveList) {
      var localSlotMap = {};
      for (var i = 0; i < localSlotList.length; i++) {
        localSlotMap[localSlotList[i]] = i;
      }
      var remoteSlotMap = {};
      for (i = 0; i < remoteSaveList.length; i++) {
        remoteSlotMap["save"+remoteSaveList[i].timestamp] = 1;
      }
      var newRemoteSaves = 0;
      for (i = 0; i < remoteSaveList.length; i++) {
        var remoteSave = remoteSaveList[i];
        var slot = "save"+remoteSave.timestamp;
        saveCookie(null, slot, remoteSave.stats, remoteSave.temps, remoteSave.lineNum, remoteSave.indent, remoteSave.deleted, remoteSave.undeleted);
        if (typeof localSlotMap[slot] !== 'undefined') {
          localSaveList[localSlotMap[slot]] = remoteSave;
        } else {
          localSlotList.push(slot);
          localSaveList.push(remoteSave);
          newRemoteSaves++;
        }
      }

      var dirtySaveList = [];
      for (i = 0; i < localSlotList.length; i++) {
        if (!remoteSlotMap[localSlotList[i]]) {
          dirtySaveList.push(localSlotList[i]);
        }
      }

      if (recordDirty) {
        window.store.set("dirty_save_list", toJson(dirtySaveList), finale);
      } else {
        finale();
      }

      function finale() {
        if (newRemoteSaves) {
          window.store.set("save_list", toJson(localSlotList), function() {
            safeCall(null, function() { callback(localSaveList, newRemoteSaves, dirtySaveList); });
          });
        } else {
          safeCall(null, function() {callback(localSaveList, newRemoteSaves, dirtySaveList);});
        }
      }
    });
  });
}

function getAppId() {
  if (window.isIosApp) {
    var appBanner = document.querySelector("meta[name=apple-itunes-app]");
    return /app-id=(\d+)/.exec(appBanner.getAttribute("content"))[1];
  } else if (window.isAndroidApp) {
    var androidLink = document.getElementById('androidLink');
    return /id=([\.\w]+)/.exec(androidLink.href)[1];
  }
}

function submitReceipts(receipts, callback) {
  console.log("submitReceipts: " + JSON.stringify(receipts));
  if (!callback) callback = function(error) {
    if (window.transferPurchaseCallback) {
      window.transferPurchaseCallback(error || "done");
    }
  };
  var appId = receipts.appId;
  var count = 0;
  var error;
  function submitCallback(product) {
    return function submitCallback(ok, response) {
      if (!ok) {
        console.log("failed: " + product + " " + JSON.stringify(response));
        if (!error) {
          var match = /^receipt transaction already processed: (\d+) current login (\d+)$/.exec(response.error);
          if (match) {
            callback("409-" + match[1] + "-" + match[2]);
          } else {
            callback("" + response.status + "r");
          }
        }
        error = true;
      }
      if (error) return;
      count--;
      if (!count) {
        if (!receipts.avoidOverrides) cacheKnownPurchases(response);
        callback();
      }
    }
  }

  if (window.isAndroidApp) {
    window.store.get("login", function(ok, loginId) {
      loginId = loginId || 0;
      var platform = window.isAmazonAndroidApp ? 'amazon' : 'google';
      if (receipts.prePurchased && platform === 'google') {
        for (var i = 0; i < receipts.prePurchased.length; i++) {
          var product = receipts.prePurchased[i];
          count++;
          xhrAuthRequest("POST", "submit-device-receipt", submitCallback(product),
            'platform', platform,
            'company', receipts.company,
            'game_id', window.storeName,
            'app_package', appId,
            'product_id', product,
            'signature', encodeURIComponent(receipts.signature),
            'receipt', encodeURIComponent(receipts.signedData),
            'login_id', loginId
          );
        }
      }
      if (receipts.iaps) {
        for (var product in receipts.iaps) {
          count++;
          xhrAuthRequest("POST", "submit-device-receipt", submitCallback(product),
            'platform', platform,
            'company', receipts.company,
            'game_id', window.storeName,
            'app_package', appId,
            'product_id', product,
            'receipt', encodeURIComponent(receipts.iaps[product]),
            'login_id', loginId
          );
        }
      }
      if (!count) safeTimeout(function () { callback(); }, 0);
    });
  } else {
    callback("error");
  }
}

function delayBreakStart(callback) {
  var nowInSeconds = Math.floor(new Date().getTime() / 1000);
  if (!initStore()) {
    safeTimeout(function() {callback(nowInSeconds);}, 0);
    return;
  }
  window.store.get("delayBreakStart", function(ok, value) {
    var valueNum = value*1;
    safeCall(null, function() {
      if (ok && value && !isNaN(valueNum)) {
        callback(valueNum);
      } else {
        window.store.set("delayBreakStart", nowInSeconds);
        callback(nowInSeconds);
      }
    });
  });
}

function delayBreakEnd() {
  if (initStore()) window.store.remove("delayBreakStart");
}

function initStore() {
  if (!window.storeName) return false;
  if (window.store) return window.store;
  try {
    window.store = new Persist.Store(window.storeName);
  } catch (e) {
    console.error(e);
  }
  return window.store;
}
function loadAndRestoreGame(slot, forcedScene, forcedStats, forcedTemps) {
  function valueLoaded(ok, value) {
    safeCall(null, function() {
      var state = null;
      if (ok && value && ""+value) {
        //console.log("successfully loaded slot " + slot);
        state = jsonParse(value);
      } else if (slot == "backup") {
        console.log("loadAndRestoreGame couldn't find backup");
        if (typeof alertify !== "undefined") alertify.log("Failed restarting chapter. Restarting the game from scratch.");
        return restartGame();
      }
      restoreGame(state, forcedScene, false, forcedStats, forcedTemps);
    });
  }
  if (!slot) slot = "";
  if (_global.pseudoSave && pseudoSave[slot]) return valueLoaded(true, pseudoSave[slot]);
  if (!initStore()) return restoreGame(null, forcedScene);
  window.store.get("state"+slot, valueLoaded);
}

function isStateValid(state) {
  if (!state) return false;
  if (!state.stats) return false;
  if (!state.stats.sceneName) return false;
  return true;
}

function restartGame(shouldPrompt) {
  if (_global.blockRestart) {
    asyncAlert("Please wait until the timer has run out.");
    return;
  }
  function actuallyRestart(result) {
    if (!result) return;
    delayBreakEnd();
    submitAnyDirtySaves();
    clearCookie(function() {}, 'temp');
    clearCookie(function() {
      _global.nav.resetStats(_global.stats);
      clearScreen(restoreGame);
    }, "");
  }
  if (shouldPrompt) {
    asyncConfirm("Start over from the beginning?", actuallyRestart);
  } else {
    actuallyRestart(true);
  }
}

function restoreGame(state, forcedScene, userRestored, forcedStats, forcedTemps) {
    var scene;
    var secondaryMode = null;
    var saveSlot = "";
    var forcedSceneLabel = null;
    if (/\|/.test(forcedScene)) {
      var parts = forcedScene.split("|");
      forcedScene = parts[0];
      forcedSceneLabel = parts[1];
    }
    if (forcedScene == "choicescript_stats") {
      secondaryMode = "stats";
      saveSlot = "temp";
    } else if (forcedScene == "choicescript_upgrade") {
      secondaryMode = "upgrade";
      saveSlot = "temp";
    }
    if (!isStateValid(state)) {
        var startupScene = forcedScene ? forcedScene : _global.nav.getStartupScene();
        scene = new Scene(startupScene, _global.stats, _global.nav, {debugMode:_global.debug, secondaryMode:secondaryMode, saveSlot:saveSlot});
    } else {
      if (forcedScene) state.stats.sceneName = forcedScene;
      if (forcedStats) {
        for (var stat in forcedStats) {
          state.stats[stat] = forcedStats[stat];
        }
      }
      if (forcedTemps) {
        for (var temp in forcedTemps) {
          state.temps[temp] = forcedTemps[temp];
        }
      }
      _global.stats = state.stats;
      // Someday, inflate the navigator using the state object
      scene = new Scene(state.stats.sceneName, state.stats, _global.nav, {debugMode:state.debug || _global.debug, secondaryMode:secondaryMode, saveSlot:saveSlot});
      if (!forcedScene) {
        scene.temps = state.temps;
        scene.lineNum = state.lineNum;
        scene.indent = state.indent;
      }
      if (userRestored) {
        scene.temps.choice_user_restored = true;
      }
    }
    if (forcedSceneLabel !== null) {
      scene.targetLabel = {label:forcedSceneLabel, origin:"url", originLine:0}
    }
    safeCall(scene, scene.execute);
}

function redirectScene(sceneName, label, originLine) {
  var scene = new Scene(sceneName, window.stats, window.nav, {debugMode:window.debug});
  if (label) scene.targetLabel = {label:label, origin:"choicescript_stats", originLine:originLine};
  scene.redirectingFromStats = true;
  clearScreen(function() {scene.execute();});
}

tempStatWrites = {};

function transferTempStatWrites() {
  if (!_global.isIosApp) return;
  callIos("transferwrites", JSON.stringify(tempStatWrites));
}

function getCookieByName(cookieName, ck) {
    if (!ck) ck = window.document.cookie;
    if (!ck) return null;
    var ckPairs = ck.split(/;/);
    for (var i = 0; i < ckPairs.length; i++) {
        var ckPair = trim(ckPairs[i]);
        var ckNameValue = ckPair.split(/=/);
        var ckName = decodeURIComponent(ckNameValue[0]);
        if (ckName === cookieName) {
            return decodeURIComponent(ckNameValue[1]);
        }
    }
    return null;
}

function parseQueryString(str) {
  if (!str) return null;
  str = String(str).substring(1);
  if (!str) return null;
  var map = {};
  var pairs = str.split("&");
  var i = pairs.length;
  while (i--) {
    var pair = pairs[i];
    var parts = pair.split("=");
    map[parts[0]] = parts[1];
  }
  return map;
}

function trim(str) {
    if (str === null || str === undefined) return null;
    var result = str.replace(/^\s+/g, "");
    // strip leading
    return result.replace(/\s+$/g, "");
    // strip trailing
}


function findOptimalDomain(docDomain) {
    if (!docDomain) docDomain = document.domain;
    // localhost and 127.0.0.1 will cause cookie not to be set; just omit them, it works fine
    if (docDomain == "localhost" || docDomain == "127.0.0.1") return null;
    // ip address
    if (/^\d+\.\d+\.\d+\.\d+$/.test(docDomain)) return null;
    // dotcom
    var result = docDomain.match(/(\w+\.\w{3}$)/);
    if (result) return result[1];
    return null;
}

function num(x, line, sceneName) {
    if (!line) line = "UNKNOWN";
    errorInfo = "line "+line;
    if (sceneName) errorInfo = sceneName + " " + errorInfo;
    var x_num = parseFloat(x);
    if (isNaN(x_num)) throw new Error(errorInfo+": Not a number: " + x);
    if (!isFinite(x_num)) throw new Error(errorInfo+": Not finite " + x);
    return x_num;
}

function bool(x, line, sceneName) {
  if (!line) line = "UNKNOWN";
  if ("boolean" == typeof x) {
    return x;
  } else if ("true" === x) {
    return true;
  } else if ("false" === x) {
    return false;
  }
  errorInfo = "line "+line;
  if (sceneName) errorInfo = sceneName + " " + errorInfo;
  throw new Error(errorInfo+": Neither true nor false: " + x);
}

function findXhr() {
  var ieFile = isIE && isFile;
  if (window.XMLHttpRequest && !ieFile) return new window.XMLHttpRequest();
  var ids = ['Msxml2.XMLHTTP', 'Microsoft.XMLHTTP', 'Msxml2.XMLHTTP.4.0'];
  for (var i = 0; i < 3; i++) {
    try {
      return new ActiveXObject(ids[i]);
    } catch (e) {}
  }
  throw new Error("Couldn't create XHR object");
}

    crcTable = "00000000 77073096 EE0E612C 990951BA 076DC419 706AF48F E963A535 9E6495A3 0EDB8832 79DCB8A4 E0D5E91E 97D2D988 09B64C2B 7EB17CBD E7B82D07 90BF1D91 1DB71064 6AB020F2 F3B97148 84BE41DE 1ADAD47D 6DDDE4EB F4D4B551 83D385C7 136C9856 646BA8C0 FD62F97A 8A65C9EC 14015C4F 63066CD9 FA0F3D63 8D080DF5 3B6E20C8 4C69105E D56041E4 A2677172 3C03E4D1 4B04D447 D20D85FD A50AB56B 35B5A8FA 42B2986C DBBBC9D6 ACBCF940 32D86CE3 45DF5C75 DCD60DCF ABD13D59 26D930AC 51DE003A C8D75180 BFD06116 21B4F4B5 56B3C423 CFBA9599 B8BDA50F 2802B89E 5F058808 C60CD9B2 B10BE924 2F6F7C87 58684C11 C1611DAB B6662D3D 76DC4190 01DB7106 98D220BC EFD5102A 71B18589 06B6B51F 9FBFE4A5 E8B8D433 7807C9A2 0F00F934 9609A88E E10E9818 7F6A0DBB 086D3D2D 91646C97 E6635C01 6B6B51F4 1C6C6162 856530D8 F262004E 6C0695ED 1B01A57B 8208F4C1 F50FC457 65B0D9C6 12B7E950 8BBEB8EA FCB9887C 62DD1DDF 15DA2D49 8CD37CF3 FBD44C65 4DB26158 3AB551CE A3BC0074 D4BB30E2 4ADFA541 3DD895D7 A4D1C46D D3D6F4FB 4369E96A 346ED9FC AD678846 DA60B8D0 44042D73 33031DE5 AA0A4C5F DD0D7CC9 5005713C 270241AA BE0B1010 C90C2086 5768B525 206F85B3 B966D409 CE61E49F 5EDEF90E 29D9C998 B0D09822 C7D7A8B4 59B33D17 2EB40D81 B7BD5C3B C0BA6CAD EDB88320 9ABFB3B6 03B6E20C 74B1D29A EAD54739 9DD277AF 04DB2615 73DC1683 E3630B12 94643B84 0D6D6A3E 7A6A5AA8 E40ECF0B 9309FF9D 0A00AE27 7D079EB1 F00F9344 8708A3D2 1E01F268 6906C2FE F762575D 806567CB 196C3671 6E6B06E7 FED41B76 89D32BE0 10DA7A5A 67DD4ACC F9B9DF6F 8EBEEFF9 17B7BE43 60B08ED5 D6D6A3E8 A1D1937E 38D8C2C4 4FDFF252 D1BB67F1 A6BC5767 3FB506DD 48B2364B D80D2BDA AF0A1B4C 36034AF6 41047A60 DF60EFC3 A867DF55 316E8EEF 4669BE79 CB61B38C BC66831A 256FD2A0 5268E236 CC0C7795 BB0B4703 220216B9 5505262F C5BA3BBE B2BD0B28 2BB45A92 5CB36A04 C2D7FFA7 B5D0CF31 2CD99E8B 5BDEAE1D 9B64C2B0 EC63F226 756AA39C 026D930A 9C0906A9 EB0E363F 72076785 05005713 95BF4A82 E2B87A14 7BB12BAE 0CB61B38 92D28E9B E5D5BE0D 7CDCEFB7 0BDBDF21 86D3D2D4 F1D4E242 68DDB3F8 1FDA836E 81BE16CD F6B9265B 6FB077E1 18B74777 88085AE6 FF0F6A70 66063BCA 11010B5C 8F659EFF F862AE69 616BFFD3 166CCF45 A00AE278 D70DD2EE 4E048354 3903B3C2 A7672661 D06016F7 4969474D 3E6E77DB AED16A4A D9D65ADC 40DF0B66 37D83BF0 A9BCAE53 DEBB9EC5 47B2CF7F 30B5FFE9 BDBDF21C CABAC28A 53B39330 24B4A3A6 BAD03605 CDD70693 54DE5729 23D967BF B3667A2E C4614AB8 5D681B02 2A6F2B94 B40BBE37 C30C8EA1 5A05DF1B 2D02EF8D";

    /* Number */
    function crc32( /* String */ str, /* Number */ crc ) {
        if( !crc ) crc = 0;
        var n = 0; //a number between 0 and 255 
        var x = 0; //an hex number 

        crc = crc ^ (-1);
        for( var i = 0, iTop = str.length; i < iTop; i++ ) {
            n = ( crc ^ str.charCodeAt( i ) ) & 0xFF;
            x = "0x" + crcTable.substr( n * 9, 8 );
            crc = ( crc >>> 8 ) ^ x;
        }
        return crc ^ (-1);
    }

function simpleDateFormat(date) {
  var day = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"][date.getDay()];
  var month = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][date.getMonth()];
  var minutes = date.getMinutes();
  if (minutes < 10) minutes = "0" + ("" + minutes);
  var oneYearInMillis = 1000 * 60 * 60 * 24 * 365;
  var millisAgo = new Date().getTime() - date.getTime();
  var yearString = ""
  if (millisAgo > oneYearInMillis) {
    yearString = ", " + date.getFullYear();
  }
  return day + ", " + month + " " + date.getDate() + yearString;
}

function simpleDateTimeFormat(date) {
  var minutes = date.getMinutes();
  if (minutes < 10) minutes = "0" + ("" + minutes);
  return simpleDateFormat(date) + ", " + date.getHours() + ":" + minutes;
}

function jsonParse(str) {
  if (typeof JSON != "undefined") {
    try {
      return JSON.parse(str);
    } catch (e) {
      // try to handle unquoted keys
      try {
        return eval('('+str+')');
      } catch (e2) {
        // that might have failed because eval is forbidden
        try {
          eval("1");
        } catch (e3) {
          // eval forbidden; let's try a hack to fix unquoted keys
          var str2 = (str+"").replace(/([,\{])\s*(\w+)\s*\:/g, '$1"$2":');
          try {
            return JSON.parse(str2);
          } catch (e4) {}
        }
        // at this point, just report a clear error
        return JSON.parse(str);
      }
    }
  } else {
    return eval('('+str+')');
  }
}

function cefQuerySimple(method) {
  cefQuery({
    request:method,
    onSuccess: function(response) {console.log(method + " success");},
    onFailure: function(error_code, error_message) {console.error(method + " error: " + error_message);}
  });
}

shortMonthStrings = [null, "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/parse
// "Given a date string of "March 7, 2014", parse() assumes a local time zone, but given an
// ISO format such as "2014-03-07" it will assume a time zone of UTC for ES5 or local for
// ECMAScript 2015."
function parseDateStringInCurrentTimezone(YYYY_MM_DD, line) {
  var result = /^(\d{4})-(\d{2})-(\d{2})$/.exec(YYYY_MM_DD);
  if (!result) throw new Error("line "+line+": invalid date string " + YYYY_MM_DD);
  var fullYear = result[1];
  var oneBasedMonthNumber = parseInt(result[2],10);
  var dayOfMonth = parseInt(result[3],10);
  var shortMonthString = shortMonthStrings[oneBasedMonthNumber];
  return new Date(shortMonthString + " " + dayOfMonth + ", " + fullYear);
}

function matchBracket(line, brackets, startIndex) {
  var openBracket = brackets[0];
  var closeBracket = brackets[1];
  var brackets = 0;
  for (var i = startIndex; i < line.length; i++) {
    var c = line.charAt(i);
    if (c === openBracket) {
      brackets++;
    } else if (c === closeBracket) {
      if (brackets) {
        brackets--;
      } else {
        return i;
      }
    }
  }
  return -1;
}

function isStoreSceneCacheRequired() {
  if (!(initStore() &&
    _global.purchases &&
    _global.checkPurchase &&
    _global.hashes &&
    !(_global.isOmnibusApp && _global.isIosApp) &&
    hashes.scenes
  )) return false;
  var empty = true;
  for (var scene in purchases) {
    if (/^fake:/.test(scene)) continue;
    empty = false;
    break;
  }
  return !empty;
}

function updateSinglePaidSceneCache(sceneName, callback) {
  sceneName = sceneName.replace(/ /g, "_");
  var fileName = sceneName + ".txt.json";
  if (initStore() && _global.hashes && hashes.scenes && hashes.scenes[fileName]) {
    function actualRequest(receiptsSent) {
      var xhr = new XMLHttpRequest();
      var canonical = document.querySelector("link[rel=canonical]");
      var canonicalHref = canonical && canonical.getAttribute("href");
      if (window.beta) {
        canonicalHref = canonicalHref.replace('https://www.choiceofgames.com/', 'https://www.choiceofgames.com/beta/');
      }
      var url = canonicalHref + "scenes/" + fileName + "?hash="+hashes.scenes[fileName];
      xhr.open("GET", url);
      xhr.withCredentials = true;
      xhr.onload = function() {
        var error;
        if (xhr.status !== 200) {
          try {
            error = JSON.parse(xhr.responseText).error;
          } catch (e) {}
        }
        if (xhr.status === 404) {
          try {
            if (error === "hash doesn't match") {
              return awaitAppUpdate(function() {
                callback("strange");
              })
            }
          } catch (e) {
            if (window.console) console.error(e, e.stack);
          }
        }
        if (xhr.status == 403 && _global.isOmnibusApp && _global.isAndroidApp) {
          if (!receiptsSent) {
            window.receiptRequestCallback = function(receipts) {
              window.receiptRequestCallback = null;
              submitReceipts(receipts, function(error) {
                if (error) {
                  return callback(error);
                } else {
                  actualRequest("receiptsSent");
                }
              });
            }
            androidBilling.requestReceipts();
            return;
          } else if (error === "not registered" || error == "not purchased") {
            return callback(error);
          }
        } else if (xhr.status !== 200) {
          return callback(xhr.status);
        }
        var result;
        try {
          result = jsonParse(xhr.responseText);
        } catch (e) {
          if (window.console) console.error(e, e.stack);
        }
        var ok = result && result.crc && result.lines && result.labels;
        if (!ok) return callback("network");
        window.store.set("cache_scene_"+sceneName, xhr.responseText, function() {
          window.store.set("cache_scene_hash_"+sceneName, hashes.scenes[fileName], function() {
            callback(null, result);
          });
        });
      };
      xhr.onerror = function() {
        callback("network");
      }
      console.log("updateSinglePaidSceneCache " + url);
      xhr.send();
    }
    actualRequest();
  }
}

function updateAllPaidSceneCaches(receiptsSent) {
  if (!isStoreSceneCacheRequired()) {
    if (window.isOmnibusApp && window.isAndroidApp) {
      window.receiptRequestCallback = submitReceipts;
      androidBilling.requestReceipts();
    }
    return;
  }
  if (_global.isOmnibusApp && _global.isAndroidApp && !receiptsSent) {
    window.receiptRequestCallback = function(receipts) {
      submitReceipts(receipts, function() {updateAllPaidSceneCaches("receiptsSent");});
    };
    androidBilling.requestReceipts();
    return;
  }
  var flipped = {};
  for (var scene in purchases) {
    if (/^fake:/.test(scene)) continue;
    scene = scene.replace(/ /g, "_");
    if (!flipped[purchases[scene]]) flipped[purchases[scene]] = [];
    flipped[purchases[scene]].push(scene);
  }
  var products = [];
  for (var product in flipped) {
    products.push(product);
  }
  if (!products.length) return;
  checkPurchase(products.join(" "), function(ok, result) {
    if (!ok || !result) return;
    var sceneList = [];
    var push = Array.prototype.push;
    for (var product in flipped) {
      if (result[product]) {
        push.apply(sceneList, flipped[product]);
      }
    }
    if (!sceneList.length) return;
    for (var i = 0; i < sceneList.length; i++) {
      (function(i) {
        var scene = sceneList[i];
        var fileName = scene + ".txt.json";
        window.store.get("cache_scene_hash_"+scene, function(ok, result) {
          if (!ok || result !== hashes.scenes[fileName]) {
            updateSinglePaidSceneCache(scene, function() {});
          }
        });
      })(i);
    }
  })
}

function checkForAppUpdates() {
  if (navigator.serviceWorker) {
    navigator.serviceWorker.getRegistration().then(function(reg) {
      if (reg) reg.update();
    });
  }
}

function refreshIfAppUpdateReady() {
  if (navigator.serviceWorker) {
    if (window.controllerchanged) {
      return window.location.reload();
    }
    navigator.serviceWorker.getRegistration().then(function(reg) {
      if (reg.waiting) {
        reg.waiting.postMessage('skipWaiting');
        return window.location.reload();
      }
    });
  }
}

function awaitAppUpdate(callback) {

  var serviceWorkerExists = (navigator.serviceWorker && navigator.serviceWorker.controller);
  if (!serviceWorkerExists) return callback();

  var calledBack = false;
  var maybeCallback = function() {
    if (calledBack) return;
    calledBack = true;
    callback();
  }

  if (window.controllerchanged) return maybeCallback();
  setTimeout(maybeCallback, 10000);
  navigator.serviceWorker.getRegistration().then(function(reg) {
    if (!reg) return maybeCallback();
    if (reg.waiting) {
      reg.waiting.postMessage('skipWaiting');
      return maybeCallback();
    }
    var watchStateChange = function() {
      if (this.state == 'installed') {
        if (reg.waiting) reg.waiting.postMessage('skipWaiting');
        maybeCallback();
      }
    };
    if (reg.installing) reg.installing.addEventListener('statechange', watchStateChange);
    reg.update();
    reg.addEventListener('updatefound', function() {
      reg.installing.addEventListener('statechange', watchStateChange);
    })
  });
}

function remoteConfig(variable, callback) {
  if (!_global.isOmnibusApp) {
    safeTimeout(function() {callback(null);}, 0);
    return;
  }
  if (_global.isIosApp) {
    var nonce = "remoteConfig" + variable + (+new Date);
    window[nonce] = function(value) {
      delete window[nonce];
      callback(value);
    }
    callIos("remoteconfig", variable + " " + nonce);
  } else {
    var result = (_global.androidRemoteConfig && androidRemoteConfig.remoteConfig(variable)) || null;
    return safeTimeout(function() {callback(result);}, 0);
  }
}

;
/*
 * Copyright 2010 by Dan Fabulich.
 *
 * Dan Fabulich licenses this file to you under the
 * ChoiceScript License, Version 1.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *  http://www.choiceofgames.com/LICENSE-1.0.txt
 *
 * See the License for the specific language governing
 * permissions and limitations under the License.
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied.
 */

;(function() {
  var lastTime = 0;
  if (!window.requestAnimationFrame)
    window.requestAnimationFrame = function(callback, element) {
        var currTime = new Date().getTime();
        var timeToCall = Math.max(0, 16 - (currTime - lastTime));
        var id = window.setTimeout(function() { callback(currTime + timeToCall); },
          timeToCall);
        lastTime = currTime + timeToCall;
        return id;
    };
})();

function printx(msg, parent) {
    if (msg === null || msg === undefined || msg === "") return;
    if (!parent) parent = document.getElementById('text');
    if (msg == " ") {
      // IE7 doesn't like innerHTML that's nothing but " "
      parent.appendChild(document.createTextNode(" "));
      return;
    }
    msg = replaceBbCode(msg);
    var frag = document.createDocumentFragment();
    temp = document.createElement('div');
    temp.innerHTML = msg;
    while (temp.firstChild) {
        frag.appendChild(temp.firstChild);
    }
    parent.appendChild(frag);
}

function replaceBbCode(msg) {
  return msg = String(msg).replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/\[url\=(.*?)\]/g, '<a href="$1">')
      .replace(/\[\/url\]/g, '</a>')
      .replace(/\[n\/\]/g, '<br>')
      .replace(/\[c\/\]/g, '')
      .replace(/\[b\]/g, '<b>')
      .replace(/\[\/b\]/g, '</b>')
      .replace(/\[i\]/g, '<i>')
      .replace(/\[\/i\]/g, '</i>')
      .replace(/\u2022([\s\S]*)/, '<ul>$1</ul>')
      .replace(/\u2022([^\u2022]*)/g, '<li>$1</li>')
}

function println(msg, parent) {
    if (!parent) parent = document.getElementById('text');
    printx(msg, parent);
    var br = window.document.createElement("br");
    parent.appendChild(br);
}

function printParagraph(msg, parent) {
  if (msg === null || msg === undefined || msg === "") return;
  if (!parent) parent = document.getElementById('text');
  msg = replaceBbCode(msg);
  p = document.createElement('p');
  p.innerHTML = msg;
  parent.appendChild(p);
  return p;
}

function showStats() {
    if (document.getElementById('loading')) return;
    var button = document.getElementById("statsButton");
    if (button && button.innerHTML == "Return to the Game") {
      return clearScreen(function() {
        setButtonTitles();
        loadAndRestoreGame();
      });
    }
    var currentScene = window.stats.scene;
    var scene = new Scene("choicescript_stats", window.stats, this.nav, {secondaryMode:"stats", saveSlot:"temp"});
    clearScreen(function() {
      setButtonTitles();
      scene.execute();
    })
}

function redirectFromStats(scene, label, originLine, callback) {
  if (window.isIosApp) {
    if (!label) label = "";
    callIos("redirectfromstats", scene + " " +label  + " " + originLine);
  } else if (window.isAndroidApp) {
    statsMode.redirectFromStats(scene, label || "", originLine);
  } else {
    safeTimeout(callback, 0);
  }
}

function returnFromStats() {
  if (window.isIosApp && !window.isIPad) {
    callIos("returntogame");
  } else if (window.isAndroidApp && window.statsMode.get()) {
    statsMode.returnToGame();
  } else {
    clearScreen(loadAndRestoreGame);
  }
}

function restoreCheckpointFromStats(callback) {
  safeTimeout(callback, 0);
}

function showAchievements(hideNextButton) {
  if (document.getElementById('loading')) return;
  var button = document.getElementById("achievementsButton");
  if (!button) return;
  if (button.innerHTML == "Return to the Game") {
    return clearScreen(function() {
      setButtonTitles();
      loadAndRestoreGame();
    });
  }
  clearScreen(function() {
    setButtonTitles();
    var button = document.getElementById("achievementsButton");
    button.innerHTML = "Return to the Game";
    checkAchievements(function() {
      printAchievements(document.getElementById("text"));
      if (!hideNextButton) printButton("Next", main, false, function() {
        clearScreen(function() {
          setButtonTitles();
          loadAndRestoreGame();
        });
      });
      curl();
    });
  });
}

function showMenu() {
  if (document.getElementById('loading')) return;
  var button = document.getElementById("menuButton");
  if (!button) return;
  if (button.innerHTML == "Return to the Game") {
    return clearScreen(function() {
      setButtonTitles();
      loadAndRestoreGame();
    });
  }
  function menu() {
    setButtonTitles();
    var button = document.getElementById("menuButton");
    button.innerHTML = "Return to the Game";
    options = [{name:"Return to the game.", group:"choice", resume:true}];
    if (window.isSteamworks) {
      options.push(
        {name:"Quit the game.", group:"choice", quit:true}
      )
    }
    if (nav.achievementList.length) options.push(
      { name: "View achievements.", group: "choice", achievements: true }
    );
    options.push(
      {name:"Restart the game.", group:"choice", restart:true},
      {name:"Change settings.", group:"choice", settings:true},
      {name:"Play more games like this.", group:"choice", moreGames:true}
    );
    if (isWebSavePossible() && !window.isSteamApp) {
      options.push(
        { name: "Email us at " + getSupportEmail() + ".", group: "choice", contactUs: true },
        { name: "Report a bug.", group: "choice", reportBug: true },
        { name: "Share this game with friends.", group: "choice", share: true },
      )
    }
    options.push(
      {name:"Email me when new games are available.", group:"choice", subscribe:true},
      {name:"Show keyboard shortcuts.", group:"choice", shortcuts:true}
    );
    if (document.getElementById("aboutLink")) {
      options.push({name:"View the credits.", group:"choice", credits:true});
    }
    var logoutLink = document.getElementById("logout");
    if (logoutLink && logoutLink.style.display !== "none") {
      options.push({ name: "Sign out.", group: "choice", logout: true });
    }
    printOptions([""], options, function(option) {
      if (option.resume) {
        return clearScreen(function() {
          setButtonTitles();
          loadAndRestoreGame();
        });
      } else if (option.quit) {
        require('electron').ipcRenderer.invoke('quit');
      } else if (option.achievements) {
        return showAchievements();
      } else if (option.restart) {
        if (_global.blockRestart) {
          asyncAlert("Please wait until the timer has run out.");
          return;
        }
        return clearScreen(function() {
          var text = document.getElementById('text');
          text.innerHTML = "Start over from the beginning?";
          var options = [
            {name: "Restart the game.", group:"choice", restart: true},
            {name: "Cancel.", group: "choice", restart: false },
          ]
          printOptions([""], options, function(option) {
            if (option.restart) {
              clearScreen(function() {
                setButtonTitles();
                restartGame();
              })
            } else {
              clearScreen(function() {
                setButtonTitles();
                loadAndRestoreGame();
              })
            }
          })
          curl();
        });
      } else if (option.settings) {
        textOptionsMenu({ size: 1, color: 1, animation: window.animationProperty, sliding: window.isMobile });
      } else if (option.credits) {
        absolutizeAboutLink();
        aboutClick();
      } else if (option.moreGames) {
        moreGames();
        curl();
      } else if (option.share) {
        clearScreen(function() {
          printShareLinks(document.getElementById("text"), "now");
          menu();
        });
      } else if (option.subscribe) {
        setButtonTitles();
        subscribeLink();
      } else if (option.contactUs) {
        window.location.href="mailto:"+getSupportEmail();
      } else if (option.reportBug) {
        clearScreen(function() {
          reportBug();
          showMenu();
        });
      } else if (option.shortcuts) {
        var dialog = document.getElementById('keyboardShortcuts');
        if (dialog && dialog.showModal) dialog.showModal();
      } else if (option.logout) {
        clearScreen(function() {
          logout();
          loginDiv();
          printParagraph("You have been signed out.");
          menu();
        })
      }
    });
    // show title and author on menu screen
    // this will be hidden on desktop web, but visible elsewhere
    changeTitle(document.title);
    changeAuthor(document.getElementById("author").innerText.substring(3));
    if (window.isSteamApp) {
      printParagraph("Need help? Email us at " + getSupportEmail() + ".");
    }
    curl();
  }
  clearScreen(menu);
}

function setButtonTitles() {
  var button;
  button = document.getElementById("menuButton");
  if (button) {
    button.innerHTML = "Menu";
  }
  button = document.getElementById("statsButton");
  if (button) {
    button.innerHTML = "Show Stats";
  }
  button = document.getElementById("achievementsButton");
  if (button) {
    if (nav.achievementList.length) {
      button.style.display = "";
      button.innerHTML = "Achievements";
    } else {
      button.style.display = "none";
    }
  }
}


function textOptionsMenu(categories) {
  if (!categories) {
    categories = {size:1, color:1, animation:window.animationProperty, sliding: window.isMobile};
  }
  clearScreen(function() {
    var button = document.getElementById("menuButton");
    if (button) button.innerHTML = "Return to the Game";
    var text = document.getElementById("text");
    var oldZoom = getZoomFactor();
    if (categories.settings) {
      text.innerHTML = "<p>Change the game's settings.</p>";
    } else if (categories.size && categories.color) {
      text.innerHTML = "<p>Change the game's appearance.</p>";
    } else if (categories.size) {
      text.innerHTML = "<p>Make the text bigger or smaller.</p>";
    } else if (categories.color) {
      text.innerHTML = "<p>Change the background color.</p>";
    } else if (categories.animation) {
      text.innerHTML = "<p>Change the animation between pages.</p>";
    } else if (categories.sliding) {
      text.innerHTML = "<p>Enable or disable touch slide controls.</p>";
    }
    options = [
      {name:"Return to the game.", group:"choice", resume:true},
    ];
    if (categories.size) {
      options.push(
        {name:"Make the text bigger.", group:"choice", bigger:true},
        {name:"Make the text smaller.", group:"choice", smaller:true}
      );
      if (oldZoom <= 0.5) {
        options[options.length-1].unselectable = true;
      }
      if (oldZoom !== 1) {
        options.push({name:"Reset the text to its original size.", group:"choice", reset:true});
      }
    }
    if (categories.color) options.push(
      {name:"Use a black background.", group:"choice", color:"black"},
      {name:"Use a sepia background.", group:"choice", color:"sepia"},
      {name:"Use a white background.", group:"choice", color:"white"}
    );
    if (categories.animation) {
      if (window.animateEnabled) {
        options.push({ name: "Don't animate between pages.", group: "choice", animation: 2 });
      } else {
        options.push({ name: "Animate between pages.", group: "choice", animation: 1 });
      }
    }
    if (categories.sliding) {
      if (window.slidingEnabled !== false) {
        options.push({ name: "Disable touch slide controls.", group: "choice", sliding: 1 });
      } else {
        options.push({ name: "Enable touch slide controls.", group: "choice", sliding: 2 });
      }
    }
    printOptions([""], options, function(option) {
      if (option.resume) {
        return clearScreen(function() {
          setButtonTitles();
          loadAndRestoreGame();
        });
      } else if (option.color) {
        changeBackgroundColor(option.color);
      } else if (option.reset) {
        setZoomFactor(1);
      } else if (option.animation) {
        window.animateEnabled = option.animation !== 2;
        if (initStore()) store.set("preferredAnimation", parseFloat(option.animation));
      } else if (option.sliding) {
        window.slidingEnabled = option.sliding == 2;
        if (initStore()) store.set("preferredSliding", window.slidingEnabled);
      } else {
        changeFontSize(option.bigger);
      }
      textOptionsMenu(categories);
    })
    curl();
  });
}

function getZoomFactor() {
  if (document.documentElement.style.fontSize === undefined) {
    return window.zoomFactor || 1;
  } else {
    var fontSize = parseFloat(document.documentElement.style.fontSize);
    if (isNaN(fontSize)) fontSize = 100;
    return fontSize / 100;
  }
}

function setZoomFactor(zoomFactor) {
  document.documentElement.style.fontSize = Math.round(100*zoomFactor) + "%";
  window.zoomFactor = zoomFactor;
  if (initStore()) store.set("preferredZoom", String(zoomFactor));
}

function changeFontSize(bigger) {
  var oldZoom = getZoomFactor();
  if (bigger) {
    setZoomFactor(oldZoom + 0.1);
  } else {
    setZoomFactor(oldZoom - 0.1);
  }
}

function changeBackgroundColor(color) {
  if (color === "sepia") {
    document.body.classList.remove("nightmode");
    document.body.classList.remove("whitemode");
  } else if (color === "black") {
    document.body.classList.remove("whitemode");
    document.body.classList.add("nightmode");
  } else if (color === "white") {
    document.body.classList.remove("nightmode");
    document.body.classList.add("whitemode");
  }
  if (initStore()) store.set("preferredBackground", color);
}

function isNightMode() {
  return document.body.classList.contains("nightmode");
}

function spell(num) {
  if (num > 99) return num;
  var smallNumbers = ["zero", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen", "sixteen", "seventeen", "eighteen", "nineteen"];
  var tens = ["zero", "ten", "twenty", "thirty", "forty", "fifty", "sixty", "seventy", "eighty", "ninety"];
  if (num < 20) {
    return smallNumbers[num];
  }
  var onesDigit = num % 10;
  if (onesDigit === 0) {
    return tens[num / 10];
  }
  var tensDigit = (num - onesDigit) / 10;
  return tens[tensDigit]+"-"+smallNumbers[onesDigit];
}

function printAchievements(target) {
  var unlockedBuffer = [];
  var lockedBuffer = [];
  var achievedCount = 0, hiddenCount = 0, score = 0, totalScore = 0;
  var totalAchievements = nav.achievementList.length;
  var buffer;
  for (var i = 0; i < totalAchievements; i++) {
    var name = nav.achievementList[i];
    var achievement = nav.achievements[name];
    var points = achievement.points;
    totalScore += points;

    var description;

    if (nav.achieved[name]) {
      achievedCount++;
      score += points;
      buffer = unlockedBuffer;
      description = achievement.earnedDescription;
    } else {
      if (achievement.visible) {
        buffer = lockedBuffer;
        description = achievement.preEarnedDescription;
      } else {
        hiddenCount++;
        continue;
      }
    }

    if (buffer.length) buffer.push("<br>");
    buffer.push("<b>");
    buffer.push(achievement.title.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'));
    buffer.push(":");
    buffer.push("</b> ");
    buffer.push(description.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;')
      .replace(/\[b\]/g, '<b>')
      .replace(/\[\/b\]/g, '</b>')
      .replace(/\[i\]/g, '<i>')
      .replace(/\[\/i\]/g, '</i>')
    );
    buffer.push(" (");
    buffer.push(points);
    buffer.push(" points)");
  }

  // What if there's exactly one achievement worth exactly one point?
  if (achievedCount === 0) {
    if (hiddenCount === 0) {
      buffer = ["You haven't unlocked any achievements yet. There are "+spell(totalAchievements)+" possible achievements, worth a total of "+totalScore+" points.<p>"];
    } else if (hiddenCount == 1) {
      buffer = ["You haven't unlocked any achievements yet. There are "+spell(totalAchievements)+" possible achievements (including one hidden achievement), worth a total of "+totalScore+" points.<p>"];
    } else if (hiddenCount == totalAchievements) {
      buffer = ["You haven't unlocked any achievements yet. There are "+spell(totalAchievements)+" hidden achievements, worth a total of "+totalScore+" points.<p>"];
    } else {
      buffer = ["You haven't unlocked any achievements yet. There are "+spell(totalAchievements)+" possible achievements (including "+spell(hiddenCount)+" hidden achievements), worth a total of "+totalScore+" points.<p>"];
    }
    if (lockedBuffer.length) {
      buffer.push.apply(buffer, lockedBuffer);
      buffer.push("<p>");
    }
  } else if (score == totalScore) {
    if (totalAchievements == 2) {
      buffer = ["Congratulations! You have unlocked both achievements, earning a total of "+score+" points, a perfect score.<p>"];
    } else {
      buffer = ["Congratulations! You have unlocked all "+spell(totalAchievements)+" achievements, earning a total of "+score+" points, a perfect score.<p>"];
    }
    buffer.push.apply(buffer, unlockedBuffer);
    buffer.push("<p>");
  } else {
    buffer = ["You have unlocked "+spell(achievedCount)+" out of "+spell(totalAchievements)+" possible achievements, earning you a score of "+score+" out of a possible "+totalScore+" points.<p>"];
    buffer.push.apply(buffer, unlockedBuffer);
    var remaining = totalAchievements-achievedCount;
    if (remaining == hiddenCount) {
      if (remaining == 1) {
        buffer.push("<p>There is still one hidden achievement remaining.<p>");
      } else {
        buffer.push("<p>There are still " + spell(remaining) + " hidden achievements remaining.<p>");
      }
    } else if (hiddenCount > 1) {
      buffer.push("<p>There are still "+spell(remaining)+" achievements remaining, including "+spell(hiddenCount)+" hidden achievements.<p>");
    } else if (hiddenCount == 1) {
      buffer.push("<p>There are still "+spell(remaining)+" achievements remaining, including one hidden achievement.<p>");
    } else if (remaining == 1) {
      buffer.push("<p>There is still one achievement remaining.<p>");
    } else {
      buffer.push("<p>There are still "+spell(remaining)+" achievements remaining.<p>");
    }
    if (lockedBuffer.length) {
      buffer.push.apply(buffer, lockedBuffer);
      buffer.push("<p>");
    }
  }

  target.innerHTML = buffer.join("");
}

function asyncAlert(message, callback) {
  if (!callback) callback = function(){};
  if (window.isIosApp) {
    window.alertCallback = callback;
    callIos("alert", message);
  } else if (window.isAndroidApp) {
    setTimeout(function() {
      alert(message);
      if (callback) callback();
    }, 0);
  } else if (window.isWinOldApp) {
    setTimeout(function() {
      window.external.Alert(message);
      if (callback) callback();
    }, 0);
  } else {
    alertify.alert(message, function() {safeCall(null, callback);});
  }
}

function asyncConfirm(message, callback) {
  if (false/*window.isIosApp*/) {
    // TODO asyncConfirm
    window.confirmCallback = callback;
    callIos("confirm", message);
  } else if (window.isAndroidApp) {
    setTimeout(function() {
      var result = confirm(message);
      if (callback) callback(result);
    }, 0);
  } else if (window.isWinOldApp) {
    setTimeout(function() {
      var result = window.external.Confirm(message);
      if (callback) callback(result);
    }, 0);
  } else {
    alertify.confirm(message, function(result) {safeCall(null, callback(result));});
  }
}


function clearScreen(code) {
    var text = document.getElementById("text");
    var container1 = document.getElementById("container1");
    if (!container1) throw new Error("<div id=container1> is missing from index.html");

    if (window.animateEnabled && window.animationProperty && !window.isIosApp && !document.getElementById('container2')) {
      var container2 = document.createElement("div");
      container2.setAttribute("id", "container2");
      container2.classList.add('container');
      document.body.classList.add('frozen');
      container2.style.opacity = 0;


      // get the vertical scroll position as pageYOffset
      // translate up by pageYOffset pixels, then scroll to the top
      // now we're scrolled up, but the viewport *looks* like it has retained its scroll position
      var pageYOffset = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
      var extraScroll = 0;
      if (window.isMobile && window.isWeb && window.isAndroid && !/Chrome/.test(navigator.userAgent)) {
        extraScroll = 1; // try to hide url bar
      }
      pageYOffset -= extraScroll;
      container1.style.transform = "translateY(-"+pageYOffset+ "px)";
      container1.style.webkitTransform = "translateY(-"+pageYOffset+ "px)";
      window.scrollTo(0,extraScroll);

      container2.innerHTML = container1.innerHTML;
      [].forEach.call(container1.querySelectorAll('input,button,a,textarea,label'), function(element) {
        element.setAttribute("tabindex", "-1");
        element.removeAttribute("accesskey");
      });

      document.body.insertBefore(container2, container1);
      main = document.getElementById("main");
      main.innerHTML = "";
      text = document.createElement("div");
      text.setAttribute("id", "text");
      main.appendChild(text);
      if (window.isChromeApp) fixChromeLinks();
    } else {
      main = document.getElementById("main");
      main.innerHTML = "";
      text = document.createElement("div");
      text.setAttribute("id", "text");
      main.appendChild(text);

      window.scrollTo(0,1);
    }


    var useAjax = true;
    if (isWeb && window.noAjax) {
      useAjax = false;
    }

    if (useAjax) {
      doneLoading();
      safeCall(null, code);
    } else {
      if (!initStore()) alert("Your browser has disabled cookies; this game requires cookies to work properly.  Please re-enable cookies and refresh this page to continue.");
      startLoading();
      var form = window.document.createElement("form");
      var axn = window.location.protocol + "//" + window.location.host + window.location.pathname;
      form.setAttribute("action", axn);
      form.setAttribute("method", "POST");
      main.appendChild(form);
      form.submit();
    }
}

// in the iOS app, display a page curl animation
function curl() {
  var focusFirst = function() {
    var text = document.getElementById("text");
    if (text && text.firstElementChild) {
      var focusable = text.firstElementChild;
      if (/^img$/i.test(focusable.tagName) && focusable.complete === false) {
        focusable.addEventListener("load", focusFirst);
        return;
      }
      focusable.setAttribute("tabindex", "-1");
      focusable.classList.add("tempfocus");
      focusable.focus();
      focusable.blur();
      requestAnimationFrame(function() {
        focusable.focus();
        requestAnimationFrame(function() {
          focusable.blur();
          focusable.removeAttribute("tabindex");
          focusable.classList.remove("tempfocus");
        });
      });
    }
  }

  // TODO force a reflow before curling the page
  var container2 = document.getElementById('container2');
  if (!container2) {
    focusFirst();
    return window.animateEnabled ? callIos("curl") : callIos("unfreeze");
  }

  var container1 = document.getElementById('container1');
  var onContainer1Disappeared = function(e) {
    if (container1.parentElement) container1.parentElement.removeChild(container1);
  };
  var onContainer2Appeared = function(e) {
    document.body.classList.remove('frozen');
    focusFirst();
    container2.removeEventListener('transitionend', onContainer2Appeared);
    container2.removeEventListener('webkitTransitionEnd', onContainer2Appeared);
  };

  if (!window.isIosApp && window.animationProperty) {
    var slideoutStyle = document.getElementById('slideoutStyle');
    if (!slideoutStyle) {
      slideoutStyle = document.createElement("style");
      slideoutStyle.setAttribute("id", "slideoutStyle");
      document.head.appendChild(slideoutStyle);
    }

    var shouldSlide = true;

    var timingFunction = "\n.container { transition-timing-function: ease-in; };";
    if (shouldSlide) timingFunction = "";

    slideoutStyle.innerHTML = "@keyframes containerslideout { "+
      "from { transform: "+container1.style.transform+"; } " +
      "to   { transform: "+container1.style.transform+" translateX(-105%); } }\n"+
      "@-webkit-keyframes containerslideout { "+
      "from { -webkit-transform: "+container1.style.webkitTransform+"; } " +
      "to   { -webkit-transform: "+container1.style.webkitTransform+" translateX(-105%); } }"+
      timingFunction;

    // double rAF so we start after container1 is transformed and scrolled to the top
    // minimizes flicker on iOS
    requestAnimationFrame(function() {
      requestAnimationFrame(function() {
        if (shouldSlide) {
          var fastApple = window.isIPad || window.isIPhone || window.isMacApp;
          var slowAndroid = window.isAndroidApp && /Android 4/.test(navigator.userAgent);
          var useCssAnimations = true; // fastApple || slowAndroid;
          if (useCssAnimations) {
            container1.style[window.animationProperty] = 'containerslideout';
            container2.style[window.animationProperty] = 'containerslidein';
          } else {
            var frames = 0;
            var durationInSeconds = 0.5;
            var framesPerSecond = 60;
            var totalSteps = framesPerSecond * durationInSeconds;
            var oldContainer1Transform = container1.style.transform;
            var rafSlide = function(stamp) {
              var fraction = frames / totalSteps;
              // ease approximation https://github.com/mietek/ease-tween/blob/master/src/index.js
              fraction = 1.0042954579734844 * Math.exp(
                -6.4041738958415664 * Math.exp(
                  -7.2908241330981340 * fraction));
              container1.style.transform = container1.style.webkitTransform =
                oldContainer1Transform + " translateX(-" + (105 * fraction) + "%)";
              container2.style.transform = container2.style.webkitTransform =
                "translateX(" + (100 - 100 * fraction) + "%)";
              if (frames < totalSteps) {
                frames++;
                requestAnimationFrame(rafSlide);
              }
            }
            requestAnimationFrame(rafSlide);
          }
        }
        container1.style.opacity = 0;
        container2.style.opacity = 1;
        container1.addEventListener('transitionend', onContainer1Disappeared);
        container2.addEventListener('transitionend', onContainer2Appeared);
        container1.addEventListener('webkitTransitionEnd', onContainer1Disappeared);
        container2.addEventListener('webkitTransitionEnd', onContainer2Appeared);
      })
    })
  } else {
    onContainer2Appeared();
    onContainer1Disappeared();
    window.animateEnabled ? callIos("curl") : callIos("unfreeze");
  }

  container1.removeAttribute("id");
  container2.setAttribute("id", "container1");
}

function safeSubmit(code) {
    return function safelySubmitted() {
        safeCall(code);
        return false;
    };
}

function startLoading() {
    var loading = document.getElementById('loading');
    if (!loading) {
      safeCall(null, function() {
        loading = document.createElement('div');
        loading.setAttribute("id", "loading");
        loading.innerHTML = (/MSIE [67]/.test(navigator.userAgent)?"":"<img src=\"data:image/gif;base64,R0lGODlhgAAPAPEAAPf08WJhYMvJx2JhYCH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAgAAPAAACo5QvoIC33NKKUtF3Z8RbN/55CEiNonMaJGp1bfiaMQvBtXzTpZuradUDZmY+opA3DK6KwaQTCbU9pVHc1LrDUrfarq765Ya9u+VRzLyO12lwG10yy39zY11Jz9t/6jf5/HfXB8hGWKaHt6eYyDgo6BaH6CgJ+QhnmWWoiVnI6ddJmbkZGkgKujhplNpYafr5OooqGst66Uq7OpjbKmvbW/p7UAAAIfkECQoAAAAsAAAAAIAADwAAArCcP6Ag7bLYa3HSZSG2le/Zgd8TkqODHKWzXkrWaq83i7V5s6cr2f2TMsSGO9lPl+PBisSkcekMJphUZ/OopGGfWug2Jr16x92yj3w247bh6teNXseRbyvc0rbr6/x5Ng0op4YSJDb4JxhI58eliEiYYujYmFi5eEh5OZnXhylp+RiaKQpWeDf5qQk6yprawMno2nq6KlsaSauqS5rLu8cI69k7+ytcvGl6XDtsyzxcAAAh+QQJCgAAACwAAAAAgAAPAAACvpw/oIC3IKIUb8pq6cpacWyBk3htGRk1xqMmZviOcemdc4R2kF3DvfyTtFiqnPGm+yCPQdzy2RQMF9Moc+fDArU0rtMK9SYzVUYxrASrxdc0G00+K8ruOu+9tmf1W06ZfsfXJfiFZ0g4ZvEndxjouPfYFzk4mcIICJkpqUnJWYiYs9jQVpm4edqJ+lkqikDqaZoquwr7OtHqAFerqxpL2xt6yQjKO+t7bGuMu1L8a5zsHI2MtOySVwo9fb0bVQAAIfkECQoAAAAsAAAAAIAADwAAAsucP6CAt9zSErSKZyvOd/KdgZaoeaFpRZKiPi1aKlwnfzBF4jcNzDk/e7EiLuLuhzwqayfmaNnjCCGNYhXqw9qcsWjT++TqxIKp2UhOprXf7PoNrpyvQ3p8fAdu82o+O5w3h2A1+Nfl5geHuLgXhEZVWBeZSMnY1oh5qZnyKOhgiGcJKHqYOSrVmWpHGmpauvl6CkvhaUD4qejaOqvH2+doV7tSqdsrexybvMsZrDrJaqwcvSz9i9qM/Vxs7Qs6/S18a+vNjUx9/v1TAAAh+QQJCgAAACwAAAAAgAAPAAAC0Zw/oIC33NKKUomLxct4c718oPV5nJmhGPWwU9TCYTmfdXp3+aXy+wgQuRRDSCN2/PWAoqVTCSVxilQZ0RqkSXFbXdf3ZWqztnA1eUUbEc9wm8yFe+VguniKPbNf6mbU/ubn9ieUZ6hWJAhIOKbo2Pih58C3l1a5OJiJuflYZidpgHSZCOnZGXc6l3oBWrE2aQnLWYpKq2pbV4h4OIq1eldrigt8i7d73Ns3HLjMKGycHC1L+hxsXXydO9wqOu3brPnLXL3C640sK+6cTaxNflEAACH5BAkKAAAALAAAAACAAA8AAALVnD+ggLfc0opS0SeyFnjn7oGbqJHf4mXXFD2r1bKNyaEpjduhPvLaC5nJEK4YTKhI1ZI334m5g/akJacAiDUGiUOHNUd9ApTgcTN81WaRW++Riy6Tv/S4dQ1vG4ps4NwOaBYlOEVYhYbnplexyJf3ZygGOXkWuWSZuNel+aboV0k5GFo4+qN22of6CMoq2kr6apo6m5fJWCoZm+vKu2Hr6KmqiHtJLKebRhuszNlYZ3ncewh9J9z8u3mLHA0rvetrzYjd2Wz8bB6oNO5MLq6FTp2+bVUAACH5BAkKAAAALAAAAACAAA8AAALanD+ggLfc0opS0XeX2Fy8zn2gp40ieHaZFWHt9LKNO5eo3aUhvisj6RutIDUZgnaEFYnJ4M2Z4210UykQ8BtqY0yHstk1UK+/sdk63i7VYLYX2sOa0HR41S5wi7/vcMWP1FdWJ/dUGIWXxqX3xxi4l0g4GEl5yOHIBwmY2cg1aXkHSjZXmbV4uoba5kkqelbaapo6u0rbN/SZG7trKFv7e6savKTby4voaoVpNAysiXscV4w8fSn8fN1pq1kd2j1qDLK8yYy9/ff9mgwrnv2o7QwvGO1ND049UgAAIfkECQoAAAAsAAAAAIAADwAAAticP6CAt9zSilLRd2d8onvBfV0okp/pZdamNRi7ui3yyoo4Ljio42h+w6kgNiJt5kAaasdYE7D78YKlXpX6GWphxqTT210qK1Cf9XT2SKXbYvv5Bg+jaWD5ekdjU9y4+PsXRuZHRrdnZ5inVidAyCTXF+nGlVhpdjil2OE49hjICVh4qZlpibcDKug5KAlHOWqqR8rWCjl564oLFruIucaYGlz7+XoKe2wsIqxLzMxaxIuILIs6/JyLbZsdGF063Uu6vH2tXc79LZ1MLWS96t4JH/rryzhPWgAAIfkECQoAAAAsAAAAAIAADwAAAtWcP6CAt9zSilLRd2fEe4kPCk8IjqTonZnVsQ33arGLwLV8Kyeqnyb5C60gM2LO6MAlaUukwdbcBUspYFXYcla00KfSywRzv1vpldqzprHFoTv7bsOz5jUaUMer5vL+Mf7Hd5RH6HP2AdiUKLa41Tj1Acmjp0bJFuinKKiZyUhnaBd5OLnzSNbluOnZWQZqeVdIYhqWyop6ezoquTs6O0aLC5wrHErqGnvJibms3LzKLIYMe7xnO/yL7TskLVosqa1aCy3u3FrJbSwbHpy9fr1NfR4fUgAAIfkECQoAAAAsAAAAAIAADwAAAsqcP6CAt9zSilLRd2fEW7cnhKIAjmFpZla3fh7CuS38OrUR04p5Ljzp46kgMqLOaJslkbhbhfkc/lAjqmiIZUFzy2zRe5wGTdYQuKs9N5XrrZPbFu94ZYE6ms5/9cd7/T824vdGyIa3h9inJQfA+DNoCHeomIhWGUcXKFIH6RZZ6Bna6Zg5l8JnSamayto2WtoI+4jqSjvZelt7+URKpmlmKykM2vnqa1r1axdMzPz5LLooO326Owxd7Bzam4x8pZ1t3Szu3VMOdF4AACH5BAkKAAAALAAAAACAAA8AAAK/nD+ggLfc0opS0XdnxFs3/i3CSApPSWZWt4YtAsKe/DqzXRsxDqDj6VNBXENakSdMso66WzNX6fmAKCXRasQil9onM+oziYLc8tWcRW/PbGOYWupG5Tsv3TlXe9/jqj7ftpYWaPdXBzbVF2eId+jYCAn1KKlIApfCSKn5NckZ6bnJpxB2t1kKinoqJCrlRwg4GCs4W/jayUqamaqryruES2b72StsqgvsKlurDEvbvOx8mzgazNxJbD18PN1aUgAAIfkECQoAAAAsAAAAAIAADwAAArKcP6CAt9zSilLRd2fEWzf+ecgjlKaQWZ0asqPowAb4urE9yxXUAqeZ4tWEN2IOtwsqV8YkM/grLXvTYbV4PTZpWGYU9QxTxVZyd4wu975ZZ/qsjsPn2jYpatdx62b+2y8HWMTW5xZoSIcouKjYePeTh7TnqFcpabmFSfhHeemZ+RkJOrp5OHmKKapa+Hiyyokaypo6q1CaGDv6akoLu3DLmLuL28v7CdypW6vsK9vsE1UAACH5BAkKAAAALAAAAACAAA8AAAKjnD+ggLfc0opS0XdnxFs3/nkISI2icxokanVt+JoxC8G1fNOlm6tp1QNmZj6ikDcMrorBpBMJtT2lUdzUusNSt9qurvrlhr275VHMvI7XaXAbXTLLf3NjXUnP23/qN/n8d9cHyEZYpoe3p5jIOCjoFofoKAn5CGeZZaiJWcjp10mZuRkaSAq6OGmU2lhp+vk6iioay3rpSrs6mNsqa9tb+ntQAAA7AAAAAAAAAAAA\">");
        document.body.appendChild(loading);
      });
    }
    callIos('startspinner');
}

function doneLoading() {
    var loading = document.getElementById('loading');
    if (loading) loading.parentNode.removeChild(loading);
    // TODO update header?
    callIos('stopspinner');
    if (window.doneLoadingCallback) {
      var callback = doneLoadingCallback;
      delete window.doneLoadingCallback;
      // long delay to ensure the spinner is fully stopped before continuing
      setTimeout(callback, 10);
    }
}

function setClass(element, classString) {
  element.setAttribute("class", classString);
  element.setAttribute("className", classString);
}

function printFooter() {
  // var footer = document.getElementById('footer');
  // We could put anything we want in the footer here, but perhaps we should avoid it.
  var statsButton = document.getElementById("statsButton");
  if (statsButton) {
    if (window.stats && stats.scene && stats.scene.secondaryMode == "stats") {
      statsButton.innerHTML = "Return to the Game";
    } else {
      statsButton.innerHTML = "Show Stats";
      if (window.isAndroidApp && window.statsMode.get()) {
        showStats();
      }
    }
  }
  curl();
}

// retrieve value of HTML form
function getFormValue(name) {
    var field = document.forms[0][name];
    if (!field) return "";
    // may return either one field or an array of fields
    if (field.checked) return field.value;
    for (var i = 0; i < field.length; i++) {
        var element = field[i];
        if (element.checked) return element.value;
    }
    return null;
}

function printCheckboxes(options, submitButtonNameFunction, callback) {
  var form = document.createElement("form");
  main.appendChild(form);
  var self = this;
  form.action = "#";
  form.onclick = function () {
    var count = 0;
    var checkboxes = optionsDiv.querySelectorAll('input[type=checkbox]');
    for (var i = 0; i < options.length; i++) {
      if (checkboxes[i].checked) count++;
    }
    var button = form.querySelector('input[type=submit]');
    button.value = button.name = submitButtonNameFunction(count);
  }
  form.onsubmit = function () {
    var results = [];
    var checkboxes = optionsDiv.querySelectorAll('input[type=checkbox]');
    for (var i = 0; i < options.length; i++) {
      results[i] = checkboxes[i].checked;
    }
    callback(results);
    return false;
  };
  var checked = false;
  var massSelections = document.createElement("div");
  var selectAll = document.createElement("button");
  selectAll.setAttribute("type", "button");
  massSelections.appendChild(selectAll);
  selectAll.innerHTML = "Select All";
  selectAll.addEventListener("click", function() {
    var checkboxes = optionsDiv.querySelectorAll('input[type=checkbox]');
    for (var i = 0; i < checkboxes.length; i++) {
      checkboxes[i].checked = true;
    }
  });
  massSelections.appendChild(document.createTextNode(' '));
  var selectNone = document.createElement("button");
  selectNone.setAttribute("type", "button");
  massSelections.appendChild(selectNone);
  selectNone.innerHTML = "Select None";
  selectNone.addEventListener("click", function () {
    var checkboxes = optionsDiv.querySelectorAll('input[type=checkbox]');
    for (var i = 0; i < checkboxes.length; i++) {
      checkboxes[i].checked = false;
    }
  });
  form.appendChild(massSelections);
  var optionsDiv = document.createElement("div");
  form.appendChild(optionsDiv);
  setClass(optionsDiv, "choice");
  for (var i = 0; i < options.length; i++) {
    var option = options[i];
    var isLast = (i == options.length - 1);
    printOptionButton(optionsDiv, "checkbox", null, option, i, i, isLast, checked);
  }
  printButton(submitButtonNameFunction(checked ? options.length : 0), form, true);
}

function printOptions(groups, options, callback) {
  var form = document.createElement("form");
  main.appendChild(form);
  var self = this;
  form.action="#";
  form.onsubmit = function() {
      safeCall(self, function() {
        var currentOptions = options;
        var option, group;
        for (var i = 0; i < groups.length; i++) {
            if (i > 0) {
                currentOptions = option.suboptions;
            }
            group = groups[i];
            if (!group) group = "choice";
            var value = getFormValue(group);
            if (value === null || value === undefined) {
              if (groups.length == 1) {
                asyncAlert("Please choose one of the available options first.");
              } else {
                var article = "a";
                if (/^[aeiou].*/i.test(group)) article = "an";
                asyncAlert("Please choose " + article + " " + group + " first.");
              }
              return;
            }
            option = currentOptions[value];
        }

        if (groups.length > 1 && option.unselectable) {
          asyncAlert("Sorry, that combination of choices is not allowed. Please select a different " + groups[groups.length-1] + ".");
          return;
        }
        safeCall(null, function() {callback(option);});
      });
      return false;
  };

  if (!options) throw new Error("undefined options");
  if (!options.length) throw new Error("no options");
  // global num will be used to assign accessKeys to the options
  var globalNum = 1;
  var currentOptions = options;
  for (var groupNum = 0; groupNum < groups.length; groupNum++) {
      var group = groups[groupNum];
      if (group) {
          var textBuilder = ["Select "];
          textBuilder.push(/^[aeiou]/i.test(group)?"an ":"a ");
          textBuilder.push(group);
          textBuilder.push(":");

          var p = document.createElement("p");
          p.appendChild(document.createTextNode(textBuilder.join("")));
          form.appendChild(p);
      }
      var div = document.createElement("div");
      form.appendChild(div);
      setClass(div, "choice");
      var checked = null;
      for (var optionNum = 0; optionNum < currentOptions.length; optionNum++) {
          var option = currentOptions[optionNum];
          if (!checked && !option.unselectable) checked = option;
          var isLast = (optionNum == currentOptions.length - 1);
          printOptionButton(div, "radio", group, option, optionNum, globalNum++, isLast, checked == option);
      }
      // for rendering, the first options' suboptions should be as good as any other
      currentOptions = currentOptions[0].suboptions;
  }

  var touchStartHandler = function (e) {
    if (e.touches.length > 1) return;
    var target = e.target;
    var rect = target.getBoundingClientRect();
    var shuttle;
    var shuttleWidth = rect.width * 0.2;
    //console.log(rect);
    var lastMouse = e.touches[0];
    var draw = function () {
      var transformX = rect.width + rect.left - lastMouse.clientX - (shuttleWidth/2);
      if (transformX < 0) transformX = 0;
      var maxX = rect.width - shuttleWidth - 2;
      if (transformX > maxX) transformX = maxX;
      if (target.parentElement) {
        if (transformX >= maxX * 0.8) {
          target.parentElement.classList.add('selected');
        } else {
          target.parentElement.classList.remove('selected');
        }
      }
      if (shuttle) {
        shuttle.style.transform = "translateX(-" + transformX + "px)"
        shuttle.style.webkitTransform = "translateX(-" + transformX + "px)"
      }
    };
    var outsideTimeout = null;
    var moveTracker = function(e) {
      e.preventDefault();
      lastMouse = e.touches[0];
      // on iPad app, touchend doesn't fire outside webview (touchmove does)
      // so, fire a fake touchend 300 ms after touchmove outside webview
      if (window.isIosApp && window.isIPad) {
        if (outsideTimeout) {
          clearTimeout(outsideTimeout);
          outsideTimeout = null;
        }
        if (lastMouse.pageY < 0 || lastMouse.pageX < 0) {
          outsideTimeout = setTimeout(function() {
            document.body.dispatchEvent(new Event('touchend'));
          }, 300);
        }
      }
      window.requestAnimationFrame(draw);
    }
    if ((e.touches[0].clientX - rect.left) > rect.width - shuttleWidth) {
      shuttle = document.createElement("div");
      shuttle.classList.add("shuttle");
      target.appendChild(shuttle);
      shuttle.style.width = shuttleWidth + "px";
      document.body.addEventListener('touchmove', moveTracker, {passive: false});
      var touchEnd = function(e) {
        document.body.removeEventListener('touchmove', moveTracker, {passive: false});
        document.body.removeEventListener('touchend', touchEnd);
        if (target.parentElement && target.parentElement.classList.contains('selected')) {
          if (target.click) {
            target.click();
          } else {
            var event = document.createEvent('Events');
            event.initEvent("click", true, true);
            target.dispatchEvent(event);
          }
          if (window.isIosApp) {
            window.freezeCallback = function() {
              window.freezeCallback = null;
              form.onsubmit();
            };
            callIos("freeze");
          } else {
            safeCall(null, function() {form.onsubmit();});
          }
        } else {
          if (shuttle.style.opacity !== "0") {
            shuttle.style.opacity = 0;
            var removeShuttle = function(e) {
              if (shuttle.parentElement) shuttle.parentElement.removeChild(shuttle);
            };
            shuttle.addEventListener('transitionend', removeShuttle);
            shuttle.addEventListener('webkitTransitionEnd', removeShuttle);
          } else {
            if (shuttle.parentElement) shuttle.parentElement.removeChild(shuttle);
          }
        }
      };
      document.body.addEventListener('touchend', touchEnd);
    }
    //console.log(e);
  };

  var slidingEnabled = true;
  if (window.slidingEnabled === false || groups.length > 1) slidingEnabled = false;

  if (slidingEnabled) [].forEach.call(document.querySelectorAll('.choice > div'), function(label) {
    label.addEventListener('touchstart', touchStartHandler);
    if (window.isMobile) label.addEventListener('click', function(e) {
      var target = e.currentTarget;
      if (document.body.querySelector(".shuttle.discovery")) return;
      var shuttle = document.createElement("div");
      shuttle.classList.add("shuttle");
      shuttle.classList.add("discovery");
      target.appendChild(shuttle);
      var animationEnd = function(e) {
        if (e.animationName === 'shuttlefadeout') {
          if (shuttle.parentElement) shuttle.parentElement.removeChild(shuttle);
        }
      };
      shuttle.addEventListener('animationend', animationEnd);
      shuttle.addEventListener('webkitAnimationEnd', animationEnd);
    })
  });

  var useRealForm = false;
  if (useRealForm) {
    printButton("Next", form, false);
  } else {
    printButton("Next", main, false, function() {
      form.onsubmit();
    });
  }
}

function printOptionButton(div, type, name, option, localChoiceNumber, globalChoiceNumber, isLast, checked) {
    var line = option.name;
    var unselectable = false;
    if (!name) unselectable = option.unselectable;
    var disabledString = unselectable ? " disabled" : "";
    var id = name + localChoiceNumber + "-" + Math.random().toString(36).substring(2);
    if (!name) name = "choice";
    var radio;
    var div2 = document.createElement("div");
    var label = document.createElement("label");
    // IE doesn't allow you to dynamically specify the name of radio buttons
    if (!/^\w+$/.test(name)) throw new Error("invalid choice group name: " + name);
    label.innerHTML = "<input type='"+type+"' name='"+name+
            "' value='"+localChoiceNumber+"' id='"+id+
            "' "+(checked?"checked":"")+disabledString+">";

    label.setAttribute("for", id);
    if (localChoiceNumber === 0) {
      if (isLast) {
        setClass(label, "onlyChild"+disabledString);
      } else {
        setClass(label, "firstChild"+disabledString);
      }
    } else if (isLast) {
      setClass(label, "lastChild"+disabledString);
    } else if (unselectable) {
      setClass(label, "disabled");
    }
    label.setAttribute("accesskey", globalChoiceNumber);
    if (!unselectable) {
      if (type === "radio" && window.Touch) { // Make labels clickable on iPhone
          label.onclick = function labelClick(evt) {
              try {
                var target = evt.target;
                if (!/label/i.test(target.tagName)) return;
                var button = document.getElementById(target.getAttribute("for"));
                button.checked = true;
              } catch (e) {}
          };
      } else if (/MSIE 6/.test(navigator.userAgent)) {
        label.onclick = function labelClick() {
          try {
            var target = window.event.srcElement;
            if (!/label/i.test(target.tagName)) return;
            var button = document.getElementById(target.getAttribute("for"));
            button.checked = true;
          } catch (e) {}
        };
      }
    }
    printx(line, label);
    
    div2.appendChild(label);
    div.appendChild(div2);
}

function printImage(source, alignment, alt, invert) {
  var img = document.createElement("img");
  if (typeof hashes != 'undefined' && hashes[source]) {
    source += "?hash=" + hashes[source];
  }
  img.src = source;
  if (alt !== null && String(alt).length > 0) img.setAttribute("alt", alt);
  var zoomFactor = getZoomFactor();
  if (zoomFactor !== 1) {
    var size = (zoomFactor * 100) + '%';
    img.style.height = size;
    img.style.width = size;
  }
  if (invert) {
    setClass(img, "invert align"+alignment);
  } else {
    setClass(img, "align"+alignment);
  }
  document.getElementById("text").appendChild(img);
}

function playSound(source) {
  for (var existingAudios = document.getElementsByTagName("audio"); existingAudios.length;) {
    existingAudios[0].parentNode.removeChild(existingAudios[0]);
  }
  if (typeof hashes != 'undefined' && hashes[source]) {
    source += "?hash=" + hashes[source];
  }
  var audio = document.createElement("audio");
  if (audio.play) {
    audio.setAttribute("src", source);
    document.body.appendChild(audio);
    audio.play();
  }
}

function printYoutubeFrame(slug) {
  var wrapper = document.createElement("div");
  setClass(wrapper, "videoWrapper");
  var iframe = document.createElement("iframe");
  iframe.width="560";
  iframe.height="315";
  iframe.src="https://www.youtube.com/embed/"+slug;
  iframe.setAttribute("frameborder", 0);
  iframe.setAttribute("allowfullscreen", true);
  wrapper.appendChild(iframe);
  document.getElementById("text").appendChild(wrapper);
}

function moreGames() {
    if (window.isIosApp) {
      window.location.href = "https://choiceofgames.app.link/jBm199qZXL/";
    } else if (window.isAndroidApp) {
      if (window.isNookAndroidApp) {
        asyncAlert("Please search the Nook App Store for \"Choice of Games\" for more games like this!");
        return;
      }
      if (window.isAmazonAndroidApp) {
        window.location.href = "https://www.amazon.com/gp/mas/dl/android?p=com.choiceofgames.omnibus&t=choofgam-20&ref=moreGames";
      } else {
        window.location.href = "https://play.google.com/store/apps/details?id=com.choiceofgames.omnibus&referrer=utm_medium%3Dweb%26utm_source%3Dmoregames";
      }
    } else if (window.isSteamApp) {
      window.location.href = "https://store.steampowered.com/curator/7026798-Choice-of-Games/";
    } else {
      try {
        if (window.isChromeApp) {
          window.open("https://www.choiceofgames.com/category/our-games/");
        } else if (window.isHeartsChoice) {
          window.location.href = "https://www.heartschoice.com/shop/";
        } else {
          window.location.href = "https://www.choiceofgames.com/category/our-games/";
        }
      } catch (e) {
        // in xulrunner, this will be blocked, but it will trigger opening the external browser
      }
    }
}

function printShareLinks(target, now) {
  if (!target) target = document.getElementById('text');
  var msgDiv = document.createElement("div");
  if (window.isIosApp) {
    if (now) {
      callIos("share");
      return;
    }
    var button = document.createElement("button");
    button.appendChild(document.createTextNode("Share This Game"));
    button.onclick = function() {
      callIos("share");
    };
    msgDiv.appendChild(button);
    target.appendChild(msgDiv);
    return;
  }

  var mobileMesg = "";
  if (window.isAndroidApp) {
    var androidLink = document.getElementById('androidLink');
    var androidUrl;
    if (window.isNookAndroidApp) {
      if (window.nookEan && nookEan != "UNKNOWN") {
        mobileMesg = "  <li><a href='choiceofgamesnook://"+window.nookEan+"'>Rate this app</a> in the Nook App Store</li>\n";
      }
    } else if (androidLink) {
      androidUrl = getAndroidReviewLink();
      if (androidUrl) {
        mobileMesg = "  <li><a href='"+androidUrl+"'>Rate this app</a> in the Google Play Store</li>\n";
      }
    }
  } else if (/webOS/.test(navigator.userAgent) && window.isFile) {
    var palmLink = document.getElementById('palmLink');
    var palmUrl;
    if (palmLink) {
      palmUrl = palmLink.href;
      if (palmUrl) {
        mobileMesg = "  <li><a href='"+palmUrl+"'>Rate this app</a> in the Palm App Catalog</li>\n";
      }
    }
  } else if (window.isChromeApp) {
    var chromeLink = document.getElementById('chromeLink');
    var chromeUrl;
    if (chromeLink) {
      chromeUrl = chromeLink.href;
      if (chromeUrl) {
        mobileMesg = "  <li><a href='"+chromeUrl+"/reviews'>Rate this app</a> in the Chrome Web Store</li>\n";
      }
    }
  }

  var url = window.location.href;
  var links = document.getElementsByTagName("link");
  for (var i = links.length - 1; i >= 0; i--) {
    if (links[i].getAttribute("rel") == "canonical") {
      url = links[i].getAttribute("href") || url;
      break;
    }
  }

  if (/^\//.test(url)) {
    if (window.isWeb) {
      url = window.location.protocol + "//" + window.location.hostname + url;
    } else {
      url = "https://www.choiceofgames.com" + url;
    }
  }

  url = encodeURIComponent(url);
  var title = encodeURIComponent(document.title);
  var dataUriSupported = !/MSIE [67]/.test(navigator.userAgent);

  var twitterHandle = window.isHeartsChoice ? "heartschoice" : "choiceofgames";

  var shareLinkText =
        '<li>'+(dataUriSupported?'<img height="16" width="16" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAsklEQVQ4EWNgoBAwgvQnVq75f+vBG5KMUlMQYZjfHsLIBNJFqmZkPSzEWKsqL8zQXebJICLIDVZuEzUTrg3sAjgPBwNZM7oSolyAzWaYQUS5AKYYG43XBUeWpaPogfGRwwCvAW/efwUbAPMCjI9sKl4DArKXgNXCbIbxkQ2gOAwoNgDsBS5ONgYNJTFkl2FlG2nLwMVv3HsFZlPHBTLifAznrj6Bm47OQI42mBwoM1EFAAAnVCliRFKHdQAAAABJRU5ErkJggg==">':"")+
        ' <a href="http://www.facebook.com/sharer.php?u='+url+'&amp;t='+title+'"'+
        'onclick="if (window.isFile || window.isXul) return true; '+
        'window.open(&quot;http://www.facebook.com/sharer.php?u='+url+'&amp;t='+title+
        '&quot;,&quot;sharer&quot;,&quot;toolbar=0,status=0,width=626,height=436&quot;);return false;" class="spacedLink">Facebook</a></li>'+

        '<li>'+(dataUriSupported?'<img height="16" width="16" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB/ElEQVQ4EYVTO24UQRB9/dmZkdfCIK0QBhMACQdwgDgMN4AEiYALcAFy7kNABkYkGzhAWMa2DHg9n+7iVfXMaAmAknp7tuvVq1dV3Q6j9SlJlzLEOXgIPPcmRjf5/7ZHdWQRaVPCOjucDYJlcHi8AFLOErz/J4kRQASXGfjYDmhIeDwAKx9xBzz8jxUCgjqSfE8CPWi5EpeTjOu+F36CVcGxrEBBMVDiaDOB5vqVBQu6WAU+dQmnwZuGwkACstxlRDckqWIhMQLPOtfXvfw0AmfA95thqwBNWGg04PktLbTYrEAlXxJTEciemtd+KdvZf7ESTjipEyaazAgyu/2lTTjP2ZpICZZQYSp7gg8kelh5PFj4Kd56ZvhE2IUSMOMVm/niZoPDOqJl0FSAYlYhoNoabSmBiI5pVNouv39w32G3l05wIwaqKRq00XErWGWYFvXz3uAbA4+51lyf+wy9h0JVRqAgfmehc8vmJt7n/CrKP6J81fzqfIPTVOOAo+S9soko+GkzhxgNocUkDfLmosPrsyvwtpTDP5KRWBz2Of4PB3vYr8o9mNuZncfLvRrPdmveJJVNDn0G8yKUMV/pO+p16MVmAn00yvnu9g7erpZ4xAbUrFtXMy42AE9YwmHNxo42lzAd6AtMQ48NgjVVOz+BVNQ9Zql4UI9P/TehBOJIi+EJIAAAAABJRU5ErkJggg==">':"")+
        ' <a href="https://twitter.com/intent/tweet?related='+twitterHandle+'&amp;text='+title+'&amp;url='+url+'&amp;via='+twitterHandle+'" class="spacedLink">Twitter</a></li>';

  var nowMsg = "";
  if (now) nowMsg = "<p>Please support our work by sharing this game with friends!  The more people play, the more resources we'll have to work on the next game.</p>";
  msgDiv.innerHTML = nowMsg + "<ul id='sharelist'>\n"+
    mobileMesg+
    shareLinkText+
    "</ul>\n";
  target.appendChild(msgDiv);
}

function isShareConfigured() {
  return !!document.getElementById("share");
}

function shareAction(e) {
  clearScreen(function() {
    var target = document.getElementById('text');
    printShareLinks(target, "now");
    printButton("Next", target, false, function () {
      clearScreen(loadAndRestoreGame);
    });
    curl();
  });
}

function isReviewSupported() {
  return !!(window.isIosApp || window.isAndroidApp);
}

function prepareReviewPrompt() {
  if (window.isAndroidApp && window.reviewManagerBridge) {
    window.reviewManagerBridge.requestReviewFlow();
  }
}

function promptForReview() {
  var store;
  target = document.getElementById('text');
  function printMessage(store) {
    println("Great! Please post a review of this game on "+store+". It really helps.[n/]", target);
  }
  var anchorText = "Review This Game";
  var href;
  if (window.isSteamApp) {
    printMessage("Steam");
    printLink(target, "#", anchorText, function(e) {
      preventDefault(e);
      try {
        purchase("adfree", function() {});
      } catch (x) {}
      return false;
    });
    return true;
  } else if (window.isIosApp) {
    println("Great! Please post a review of this version of the game on the App Store. It really helps.[n/]", target);
    printLink(target, "#", anchorText, function(e) {
      preventDefault(e);
      try {
        callIos("reviewapp");
      } catch (x) {}
      return false;
    });
    return true;
  } else if (window.isAndroidApp) {
    if (window.reviewManagerBridge) {
      window.reviewManagerBridge.launchReviewFlow();
      return false;
    }
    href = getAndroidReviewLink();
    if (window.isAmazonAndroidApp) {
      printMessage("Amazon's Appstore");
    } else {
      printMessage("the Google Play Store");
    }
    return true;
  } else if (window.isChromeApp) {
    href = document.getElementById('chromeLink').href;
  }
  
  printLink(target, href, anchorText);
  return true;
}

function getAndroidReviewLink() {
  var href = document.getElementById('androidLink').href;
  var package = /id=([\.\w]+)/.exec(href)[1];
  // TODO legacy hosted
  if (window.isOmnibusApp) {
    var omnibus;
    if (/^org\.hostedgames/.test(package)) {
      omnibus = "org.hostedgames.omnibus";
    } else if (/^com\.heartschoice/.test(package)) {
      omnibus = "com.heartschoice.o";
    } else {
      omnibus = "com.choiceofgames.omnibus";
    }
    if (window.isAmazonAndroidApp) {
      return "http://www.amazon.com/gp/mas/dl/android?p="+omnibus+"&t=choofgam-20&ref=rate"
    } else {
      return "https://play.google.com/store/apps/details?id="+omnibus+"&referrer=utm_medium%3Dweb%26utm_source%3D"+window.storeName+"Game";
    }
  } else if (window.isAmazonAndroidApp) {
    return "http://www.amazon.com/gp/mas/dl/android?p="+package+"&t=choofgam-20&ref=rate";
  } else {
    return href;
  }
}

function isFollowEnabled() {
  return false;
  if (!window.isWeb) return false;
  // iOS add to homescreen seems not to like these iframes
  if (window.navigator.standalone) return false;
  if ("localhost" != window.location.hostname && !/\.?choiceofgames\.com$/.test(window.location.hostname)) return false;
  return true;
}

function printFollowButtons() {
  if (!isFollowEnabled()) return;
  // Just FB Like, for now
  var target = document.getElementById('text');
  var iframe = document.createElement('iframe');
  var width = 300;
  var height = 66;
  iframe.setAttribute("src", "//www.facebook.com/plugins/like.php?href=https%3A%2F%2Fwww.facebook.com%2Fchoiceofgames"+
    "&amp;send=false&amp;layout=standard&amp;width="+width+"&amp;show_faces=true&amp;font&amp;colorscheme=light&amp;"+
    "action=like&amp;height="+height+"&amp;appId=190439350983878");
  iframe.setAttribute("scrolling", "no");
  iframe.setAttribute("frameborder", "0");
  iframe.setAttribute("style", "border:none; overflow:hidden; width:"+width+"px; height:"+height+"px;");
  iframe.setAttribute("allowTransparency", "true");
  target.appendChild(iframe);
}

function subscribeLink(e) {
  clearScreen(function() {
    subscribe(document.getElementById('text'), {now:1}, function() {
      clearScreen(loadAndRestoreGame);
    });
    curl();
  });
}

function subscribeByMail(target, options, callback, code) {
  if (options.now) {
    code();
    if (options.allowContinue) safeTimeout(function() {callback("now");}, 0);
  } else {
    println("Click here to subscribe to our mailing list; " + options.message);
    println("");
    printButton("Subscribe", target, false, function() {
        code();
      });
    if (options.allowContinue) {
      printButton("No, Thanks", target, false, function() {
        safeTimeout(function() {callback();}, 0);
      });
    }
    // why is this timeout necessary?
    safeTimeout(function() {printFooter();}, 0);
  }
}

function subscribe(target, options, callback) {
  if (!options.message) options.message = "we'll notify you when our next game is ready!";
  if (typeof options.allowContinue === "undefined") options.allowContinue = 1;
  if (!target) target = document.getElementById('text');
  if (window.isIosApp) {
    subscribeByMail(target, options, callback, function() {
      callIos("subscribe");
    });
    return;
  }
  var mailToSupported = isMobile && !window.isMacApp;
  if (window.isAndroidApp) mailToSupported = urlSupport.isSupported("mailto:support@choiceofgames.com");
  var domain = window.isHeartsChoice ? "heartschoice.com" : "choiceofgames.com";
  if (mailToSupported) {
    subscribeByMail(target, options, callback, function() {
      window.location.href = "mailto:subscribe-"+window.storeName+"-"+platformCode() + "@"+domain+"?subject=Sign me up&body=Please notify me when the next game is ready.";
    });
    return;
  }
  println("Type your email address below; " + options.message);
  println("");
  fetchEmail(function(defaultEmail) {
    promptEmailAddress(target, defaultEmail, options.allowContinue, function(cancel, email) {
      if (cancel) {
        return safeCall(null, callback);
      }
      var head= document.getElementsByTagName('head')[0];
      var script = document.createElement('script');
      script.type = 'text/javascript';
      var timestamp = new Date().getTime();
      var timeout = setTimeout(function() {
        window["jsonp"+timestamp]({
          result:"error", msg:"Couldn't connect. Please try again later."
        });
      }, 10000);
      window["jsonp"+timestamp] = function(response) {
        clearTimeout(timeout);
        if (response.result == "error") {
          var errElement = document.getElementById("errorMessage");
          if (errElement) errElement.innerHTML = response.msg;
        } else {
          clearScreen(function() {
            target = document.getElementById('text');
            println(response.msg, target);
            println("", target);
            if (options.allowContinue) {
              printButton("Next", target, false, function() {
                safeCall(null, callback);
              });
            }
            curl();
          });
        }
      };
      var listId = window.isHeartsChoice ? "fa4134344b" : "e9cdee1aaa";
      var mailParams = "u=eba910fddc9629b2810db6182&id="+listId+"&SIGNUP="+window.storeName+"-"+platformCode()+"&EMAIL="+encodeURIComponent(email);
      if (window.isChromeApp) {
        chrome.permissions.contains({origins: ["http://choiceofgames.us4.list-manage.com/"]},function(isXhrAllowed) {
          if (isXhrAllowed) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", 'http://choiceofgames.us4.list-manage.com/subscribe/post-json?'+mailParams, true);
            xhr.onreadystatechange = function() {
              if (xhr.readyState != 4) return;
              if (xhr.status == 200) {
                var response = JSON.parse(xhr.responseText);
                window["jsonp"+timestamp](response);
              } else if (xhr.status === 0) {
                window["jsonp"+timestamp]({result:"error", msg:"There was a network error submitting your registration. Please try again later, or email subscribe@choiceofgames.com instead."});
              } else {
                window["jsonp"+timestamp]({result:"error", msg:"Sorry, our mail server had an error. It's our fault. Please try again later, or email subscribe@choiceofgames.com instead."});
              }
            };
            xhr.send();
          } else {
            window.addEventListener('message', function(event) {
              if (window["jsonp"+timestamp]) {
                var jsonpt = window["jsonp"+timestamp];
                window["jsonp"+timestamp] = null;
                if (jsonpt) jsonpt(event.data);
              }
            });
            var iframe = document.createElement("IFRAME");
            iframe.setAttribute("src", "sandbox.html");
            iframe.setAttribute("name", "sandbox");
            iframe.onload = function() {
              iframe.contentWindow.postMessage({email:email, game:window.storeName, platform:platformCode()}, "*");
            };
            document.documentElement.appendChild(iframe);
            return;
          }
        });
      } else {
        if (isWinStoreApp || window.location.protocol == "https:") {
          var xhr = findXhr();
          xhr.open("GET", 'https://www.choiceofgames.com/mailchimp_proxy.php/subscribe/post-json?'+mailParams, true);
          var done = false;
          xhr.onreadystatechange = function() {
            if (done) return;
            if (xhr.readyState != 4) return;
            done = true;
            if (xhr.status == 200) {
              var response = JSON.parse(xhr.responseText);
              window["jsonp"+timestamp](response);
            } else if (xhr.status === 0) {
                window["jsonp"+timestamp]({result:"error", msg:"There was a network error submitting your registration. Please try again later, or email subscribe@choiceofgames.com instead."});
            } else {
              window["jsonp"+timestamp]({result:"error", msg:"Sorry, our mail server had an error. It's our fault. Please try again later, or email subscribe@choiceofgames.com instead."});
            }
          };
          xhr.send();
        } else {
          script.src = 'https://choiceofgames.us4.list-manage.com/subscribe/post-json?'+mailParams+'&c=jsonp' + timestamp;
          head.appendChild(script);
        }
      }
    });
  });
}

function downloadLink(e) {
  if (e && e.preventDefault) e.preventDefault();
  if (isPrerelease()) {
    return asyncAlert("You'll need to wait until after the game is released on " + window.releaseDate);
  }
  clearScreen(function() {
    var text = document.getElementById("text");
    if (window.knownPurchases && window.knownPurchases.adfree) {
      println("You can download the game using the links below.");
      println("");
      var files = {
        Windows: window.downloadName + " Setup " + window.downloadVersion + "-ia32.exe",
        Mac: window.downloadName + "-" + window.downloadVersion + ".dmg",
        Linux: window.downloadPackage + "-" + window.downloadVersion + "-ia32.deb"
      }
      var detectedOs;
      if (/Windows/.test(navigator.userAgent)) {
        detectedOs = "Windows";
      } else if (/Mac OS X/.test(navigator.userAgent)) {
        detectedOs = "Mac";
      } else if (/Linux/.test(navigator.userAgent)) {
        detectedOs = "Linux";
      }
      if (detectedOs) {
        printDownloadLink(detectedOs);
      }
      for (var os in files) {
        if (detectedOs != os) printDownloadLink(os);
      }
      function printDownloadLink(os) {
        var link = document.createElement("a");
        if (detectedOs == os) {
          setClass(link, "next linkButton");
        } else {
          link.style.display = "block";
        }
        link.innerHTML = "Download for " + os;
        link.href = "scenes/"+files[os];
        text.appendChild(link);
      }
      println("");
      printButton("Next", text, false, function() {
        safeCall(null, function() { clearScreen(loadAndRestoreGame); });
      });
    } else {
      println("To download this game for Windows, Mac, or Linux, you'll need to purchase it first.");
      println("");
      printOptions([""], [{name:"Purchase it now.", purchase:1}, {name:"No, thanks.", cancel:1}], function(option) {
        if (option.purchase) {
          purchase("adfree", downloadLink);
        } else {
          safeCall(null, function() { clearScreen(loadAndRestoreGame); });
        }
      });
    }
    curl();
  });
}

function cacheKnownPurchases(knownPurchases) {
  if (!knownPurchases) return;
  var output = {billingSupported:true};
  for (i = 0; i < knownPurchases.length; i++) {
    var parts = knownPurchases[i].split(/\./);
    if (parts[0] != window.storeName) continue;
    output[parts[1]] = true;
  }
  window.knownPurchases = output;
  fetchEmail(function(email) {
    if (email) window.store.set("knownPurchases"+email.replace(/[^A-z0-9]/g, "_"), JSON.stringify(window.knownPurchases));
  })
  if (window.isIosApp) {
    callIos("cachepurchases", knownPurchases);
  } else if (window.isAndroidApp) {
    if (window.isOmnibusApp) {
      androidBilling.cachePurchases(JSON.stringify(knownPurchases));
    }
    androidBilling.updateAdfree(!!output.adfree);
  }
}

// Callback expects a map from product ids to booleans
function checkPurchase(products, callback) {
  function publishPurchaseEvents(purchases) {
    if (purchases && window.purchaseSubscriptions) {
      for (var key in purchaseSubscriptions) {
        if (purchases[key]) purchaseSubscriptions[key].call();
      }
    }
  }

  function checkWebPurchases(callback) {
    isRegistered(function (registered) {
      if (!registered) return callback("ok", {billingSupported: true});
      if (window.knownPurchases) {
        safeTimeout(function() {
          callback("ok", window.knownPurchases);
          publishPurchaseEvents(knownPurchases);
        }, 0);
      } else {
        startLoading();
        xhrAuthRequest("GET", "get-purchases", function(ok, response) {
          doneLoading();
          if (ok) {
            cacheKnownPurchases(response);
            callback(ok, window.knownPurchases);
          } else {
            fetchEmail(function(email) {
              if (!email) return callback(ok, window.knownPurchases);
              window.store.get("knownPurchases"+email.replace(/[^A-z0-9]/g, "_"), function(ok, value) {
                if (ok) {
                  window.knownPurchases = JSON.parse(value);
                }
                callback(ok, window.knownPurchases);
                publishPurchaseEvents(window.knownPurchases);
              })
            });
          }
        });
      }
    });
  }

  function mergeKnownPurchases(purchases) {
    window.checkPurchaseCallback = null;
    checkWebPurchases(function(ok, knownPurchases) {
      if (knownPurchases) {
        var productList = products.split(/ /);
        for (i = 0; i < productList.length; i++) {
          if (knownPurchases[productList[i]]) purchases[productList[i]] = knownPurchases[productList[i]];
        }
      }
      callback("ok", purchases);
      publishPurchaseEvents(purchases);
    });
  }

  var i, oldCallback;
  if (window.isIosApp) {
    oldCallback = window.checkPurchaseCallback;
    window.checkPurchaseCallback = function (purchases) {
      if (oldCallback) oldCallback(purchases);
      mergeKnownPurchases(purchases);
    }
    if (!oldCallback) callIos("checkpurchase", products);
  } else if (window.isAndroidApp && !window.isNookAndroidApp) {
    oldCallback = window.checkPurchaseCallback;
    window.checkPurchaseCallback = function (purchases) {
      if (oldCallback) oldCallback(purchases);
      mergeKnownPurchases(purchases);
    }
    if (!oldCallback) androidBilling.checkPurchase(products);
  } else if (window.isWinOldApp) {
    safeTimeout(function() {
      var purchases = eval(window.external.CheckPurchase(products));
      callback("ok",purchases);
      publishPurchaseEvents(purchases);
    }, 0);
  } else if (window.isMacApp) {
    oldCallback = window.checkPurchaseCallback;
    window.checkPurchaseCallback = function (purchases) {
      if (oldCallback) oldCallback(purchases);
      window.checkPurchaseCallback = null;
      callback("ok",purchases);
      publishPurchaseEvents(purchases);
    }
    if (!oldCallback) callMac("checkpurchase", products);
  } else if (window.isCef) {
    cefQuery({
      request:"CheckPurchases " + products,
      onSuccess: function(response) {
        console.log("cp response " + response);
        var purchases = JSON.parse(response);
        callback("ok",purchases);
        publishPurchaseEvents(purchases);
      },
      onFailure: function(error_code, error_message) {
        console.error("CheckPurchases error: " + error_message);
        callback(!"ok");
      }
    });
  } else if (window.isSteamworks) {
    var steamworksApps = require('../package.json').products;
    var purchases = {};
    var productList = products.split(/ /);
    for (i = 0; i < productList.length; i++) {
      var appId = steamworksApps[productList[i]];
      var purchased = false;
      try {
        purchased = steamworks.apps.isSubscribedApp(appId);
      } catch (e) {
        // we pre-checked adfree on startup
        if (productList[i] === 'adfree') {
          purchased = !window.isTrial;
        } else {
          return safeTimeout(function () { callback(!"ok"); }, 0);
        }
      }
      purchases[productList[i]] = purchased;
    }
    purchases.billingSupported = true;
    publishPurchaseEvents(purchases);
    safeTimeout(function() {callback("ok", purchases);}, 0);
  } else if (window.beta === "beta") {
    var productList = products.split(/ /);
    var purchases = {};
    for (i = 0; i < productList.length; i++) {
      purchases[productList[i]] = true;
    }
    purchases.billingSupported = true;
    publishPurchaseEvents(purchases);
    safeTimeout(function () { callback("ok", purchases); }, 0);
  } else if (isWebPurchaseSupported()) {
    checkWebPurchases(function(ok, knownPurchases) {
      callback(ok, knownPurchases);
      publishPurchaseEvents(window.knownPurchases);
    });
  } else {
    var productList = products.split(/ /);
    var purchases = {};
    for (i = 0; i < productList.length; i++) {
      purchases[productList[i]] = !!window.isChromeApp;
    }
    purchases.billingSupported = false;
    publishPurchaseEvents(purchases);
    safeTimeout(function() {callback("ok", purchases);}, 0);
  }
}

function isWebPurchaseSupported() {
  var enableBilling = (typeof window.enableBilling === 'undefined' || window.enableBilling)
  return enableBilling && isWebSavePossible() && !!window.stripeKey;
}

function isRestorePurchasesSupported() {
  return !!window.isIosApp || !!window.isAndroidApp || isWebPurchaseSupported();
}

function restorePurchases(product, callback) {
  function webRestoreCallback() {
    var purchased = window.knownPurchases && window.knownPurchases[product];
    if (!purchased) {
      if (window.isAndroidApp) {
        return asyncAlert("Restore completed. This product is not yet purchased. "+
          "Sometimes purchases can fail to restore for reasons outside our control. "+
          "If you have already purchased this product, try uninstalling and reinstalling the app. "+
          "If that doesn't work, please email a copy of your receipt to " + getSupportEmail() + " "+
          "and we'll find a way to help you.", function() {
            callback(purchased);
          });
      } else {
        asyncAlert("Restore completed. This product is not yet purchased.");
      }
    } else {
      refreshIfAppUpdateReady();
      updateAllPaidSceneCaches();
    }
    callback(purchased);
  }
  function secondaryRestore(error) {
    window.restoreCallback = null;
    if (product) {
      checkPurchase(product, function(ok, purchases) {
        if (purchases[product]) {
          return callback("purchased");
        }

        if (window.isOmnibusApp && (window.purchaseTransfer || window.omnibusSupportsTransfer)) {
          var appId = getAppId();
          if (window.isAndroidApp || (window.isIosApp && (appId !== "1363309257" && appId !== "1302297731"))) {
            return omnibusRestore(appId);
          }
        }

        clearScreen(function() {
          isRegistered(function (registered) {
            if (registered) {
              startLoading();
              xhrAuthRequest("GET", "get-purchases", function(ok, response) {
                doneLoading();
                if (ok) {
                  cacheKnownPurchases(response);
                  webRestoreCallback();
                } else {
                  if (response.error === "not registered") {
                    logout();
                    secondaryRestore("error");
                  } else {
                    asyncAlert("There was an error restoring purchases. (Your network connection may be down.) Please try again later.");
                    callback();
                  }
                }
              });
            } else {
              var target = document.getElementById('text');
              if (error) {
                target.innerHTML="<p>Restore failed. Please try again later, or sign in to choiceofgames.com to restore purchases.</p>";
              } else {
                target.innerHTML="<p>Restore completed. This product is not yet purchased. You may also sign in to choiceofgames.com to restore purchases.</p>";
              }
              loginForm(document.getElementById('text'), /*optionality*/1, /*err*/null, webRestoreCallback);
              curl();
            }
          })
        });
      });
    } else {
      callback();
    }
  }
  function omnibusRestore(appId) {
    var omnibus = "Choice of Games";
    var canonical = document.querySelector("link[rel=canonical]");
    var canonicalHref = canonical && canonical.getAttribute("href");
    if (/\/user-contributed\//.test(canonicalHref)) {
      omnibus = "Hosted Games";
    }
    var appStore = window.isIosApp ? "App Store"
      : window.isAmazonAndroidApp ? "Amazon Appstore"
      : "Google Play Store";
    var gameTitle = document.getElementById("title").textContent;

    clearScreen(function() {
      printParagraph("Restore completed. "+appStore+" records indicate that "+
        "you have not purchased this product using the \""+omnibus+"\" app, "+
        "but you may have purchased the product in the \""+gameTitle+"\" app, "+
        "or on our website at choiceofgames.com.");

      options = [
        {name:"Restore purchases from choiceofgames.com.", group:"choice", webRestore:true},
        {name:"Restore purchases using the \""+gameTitle+"\" app.", group:"choice", transfer:true},
      ];

      printOptions([""], options, function(option) {
        if (option.webRestore) {
          clearScreen(function() {
            isRegistered(function (registered) {
              if (registered) {
                startLoading();
                xhrAuthRequest("GET", "get-purchases", function(ok, response) {
                  doneLoading();
                  if (ok) {
                    cacheKnownPurchases(response);
                    webRestoreCallback();
                  } else {
                    if (response.error === "not registered") {
                      logout();
                      printParagraph("Sign in to choiceofgames.com to restore purchases.");
                      loginForm(document.getElementById('text'), /*optionality*/1, /*err*/null, webRestoreCallback);
                    } else {
                      asyncAlert("There was an error restoring purchases. (Your network connection may be down.) Please try again later.");
                      callback();
                    }
                  }
                });
              } else {
                printParagraph("Sign in to choiceofgames.com to restore purchases.");
                loginForm(document.getElementById('text'), /*optionality*/1, /*err*/null, webRestoreCallback);
              }
            });
          });
        } else {
          var transferAttempted = false;
          var transferPurchaseCallback = function(result) {
            window.transferPurchaseCallback = null;
            clearScreen(function() {
              var transferPlatform = window.isIosApp ? "ios" : "android";

              if (result === "launch_failed") {
                if (!transferAttempted) {
                  transferAttempted = true;
                  printParagraph(
                    "The \""+gameTitle+"\" app is not installed on your current device. To transfer "+
                    "purchases from another app, you'll need to install the \""+gameTitle+"\" app and "+
                    "this \""+omnibus+"\" app at the same time."
                  );
                } else {
                  printParagraph(
                    "The \""+gameTitle+"\" app is not responding. Try uninstalling and reinstalling "+
                    "the \""+gameTitle+"\" app and trying again.");
                  printParagraph("Sometimes purchases can fail to "+
                    "restore for reasons outside our control. If you have already purchased "+
                    "this product, please email a copy of your receipt to "+
                    "[url=mailto:"+transferPlatform+"-transfer-"+storeName+"-missing@choiceofgames.com]"+transferPlatform+"-transfer-"+storeName+"-missing@choiceofgames.com[/url] and we'll find a way to help "+
                    "you."
                  );
                }

                var appLink = window.isIosApp ? "https://itunes.apple.com/app/id"+appId
                  : window.isAmazonAndroidApp ? "https://www.amazon.com/gp/mas/dl/android?p="+appId
                  : "https://play.google.com/store/apps/details?id="+appId;
                printParagraph("[url="+appLink+"]Download "+gameTitle+" from the "+appStore+"[/url]");

                printOptions([""], [
                  {name:"I've installed the \""+gameTitle+
                    "\" app. Try restoring purchases again.", group:"choice", retry:true},
                  {name:"Cancel.", group:"choice"},
                ], function (option) {
                  if (option.retry) {
                    window.transferPurchaseCallback = transferPurchaseCallback;
                    startLoading();
                    window.isIosApp ? callIos("transferpurchase") : purchaseTransfer.requestTransfer(appId);
                  } else {
                    callback(!"purchased");
                  }
                });
                curl();
              } else if (result === "done") {
                checkPurchase(product, function(ok, purchases) {
                  if (purchases[product]) {
                    callback("purchased");
                  } else {
                    printParagraph("Restore completed. "+appStore+" records indicate that you have not purchased "+
                    "this product in the \""+gameTitle+"\" app.");
                    printParagraph("Sometimes purchases can fail to restore for reasons outside our control. If you "+
                    "have already purchased this product, please email a copy of your receipt "+
                    "to [url=mailto:"+transferPlatform+"-transfer-"+storeName+"-failed@choiceofgames.com]"+transferPlatform+"-transfer-"+storeName+"-failed@choiceofgames.com[/url] and we'll find a "+
                    "way to help you.");
                    var target = document.getElementById('text');
                    printButton("Next", target, false, function() {
                      callback(!"purchased");
                    });
                    curl();
                  }
                });
              } else { // result === "error"
                printParagraph("Restore failed. Please try again later. If this error "+
                  "persists, please contact [url=mailto:"+transferPlatform+"-transfer-"+storeName+"-error@choiceofgames.com]"+transferPlatform+"-transfer-"+storeName+"-error@choiceofgames.com[/url] "+
                  "and we'll find a way to help you.")
                printOptions([""], [
                  {name:"Try again now.", group:"choice", retry:true},
                  {name:"Cancel.", group:"choice"},
                ], function(option) {
                  if (option.retry) {
                    window.transferPurchaseCallback = transferPurchaseCallback;
                    clearScreen(function() {
                      startLoading();
                      window.isIosApp ? callIos("transferpurchase") : purchaseTransfer.requestTransfer(appId);
                    });
                  } else {
                    callback(!"purchased");
                  }
                });
                curl();
              }
            });
          }
          if (window.isIosApp) {
            startLoading();
            window.transferPurchaseCallback = transferPurchaseCallback;
            callIos("transferpurchase");
          } else {
            isRegistered(function(registered) {
              if (registered) {
                window.transferPurchaseCallback = transferPurchaseCallback;
                clearScreen(function() {
                  startLoading();
                  purchaseTransfer.requestTransfer(appId);
                });
              } else {
                clearScreen(function() {
                  printParagraph("To restore purchases in the "+omnibus+" app using the "+gameTitle+" app, you'll first need to sign in using a choiceofgames.com account.");
                  loginForm(document.getElementById('text'), /*optionality*/1, /*err*/null, function(ok) {
                    if (ok) {
                      window.transferPurchaseCallback = transferPurchaseCallback;
                      clearScreen(function() {
                        startLoading();
                        purchaseTransfer.requestTransfer(appId);
                      });
                    } else {
                      webRestoreCallback();
                    }
                  });
                });
              }
            });
          }
        }
      });
      curl();
    });
  }

  if (window.isIosApp) {
    window.restoreCallback = secondaryRestore;
    callIos("restorepurchases");
  } else if (window.isAndroidApp) {
    window.restoreCallback = secondaryRestore;
    androidBilling.forceRestoreTransactions();
  } else if (isWebPurchaseSupported()) {
    isRegistered(function(registered) {
      if (registered) {
        startLoading();
        xhrAuthRequest("GET", "get-purchases", function(ok, response) {
          doneLoading();
          if (ok) {
            cacheKnownPurchases(response);
          } else {
            if (response.error != "not registered") {
              alertify.error("There was an error downloading your purchases from choiceofgames.com. "+
                "Please refresh this page to try again, or contact " + getSupportEmail() + " for assistance.", 15000);
            }
          }
          logout();
          restorePurchases(product, callback);
        });
      } else {
        clearScreen(function() {
          var target = document.getElementById('text');
          target.innerHTML="<p>Please sign in to choiceofgames.com to restore purchases.</p>";
          var steamRestore = false;
          var steamLink = document.getElementById('steamLink');
          if (steamLink && steamLink.href && !/INSERTINSERTINSERT/.test(steamLink.href)) {
            steamRestore = true;
          }
          if (steamRestore) {
            window.steamRestoreCallback = function(response) {
              window.steamRestoreCallback = null;
              if (response) cacheKnownPurchases(response);
              webRestoreCallback();
            }
          }
          loginForm(document.getElementById('text'), /*optional*/1, /*err*/null, webRestoreCallback);
          curl();
        });
      }
    });
  } else {
    safeTimeout(callback, 0);
  }
}
// Callback expects a localized string, or "", or "free", or "guess"
function getPrice(product, callback) {
  if (window.isIosApp) {
    checkForAppUpdates();
    window.priceCallback = callback;
    callIos("price", product);
  } else if (window.isAndroidApp) {
    window.priceCallback = callback;
    androidBilling.getPrice(product);
  } else if (window.isWeb) {
    checkForAppUpdates();
    if (window.productData && window.productData[product] && window.productData[product].amount) {
      safeTimeout(function () {
        callback.call(this, "$"+(productData[product].amount/100));
      }, 0);
    } else {
      safeTimeout(function() {
        if (window.productData && window.productData[product] && window.productData[product].amount) {
          callback.call(this, "$"+(productData[product].amount/100));
        } else {
          callback.call(this, "guess");
        }
      }, 500);
    }
  } else if (window.isSteamworks) {
    if (window.productData && window.productData[product]) {
      safeTimeout(function () {
        callback.call(this, productData[product]);
      }, 0);
    } else {
      window.awaitSteamProductData = function() {
        doneLoading();
        window.awaitSteamProductData = null;
        if (window.productData && window.productData[product]) {
          callback.call(this, productData[product]);
        } else {
          callback.call(this, "hide");
        }
      };
      startLoading();
      safeTimeout(function() {if (window.awaitSteamProductData) awaitSteamProductData();}, 5000);
    }
  } else {
    safeTimeout(function () {
      callback.call(this, "hide");
    }, 0);
  }
}
// Callback expects no args, but should only be called on success
function purchase(product, callback) {
  var purchaseCallback = function() {
    window.purchaseCallback = null;
    refreshIfAppUpdateReady();
    updateAllPaidSceneCaches();
    safeCall(null, callback);
    if (window.purchaseSubscriptions && purchaseSubscriptions[product]) {
      purchaseSubscriptions[product].call();
    }
  };
  if (window.isIosApp) {
    if (!window.purchaseRequiresLogin || window.registered) {
      window.purchaseCallback = purchaseCallback;
      return callIos("purchase", product);
    } else {
      clearScreen(function() {
        var target = document.getElementById('text');
        target.innerHTML="<p>Please sign in to choiceofgames.com to purchase.</p>";
        loginForm(target, /*optional*/1, /*err*/null, function(registered){
          if (registered) {
            if (window.knownPurchases && window.knownPurchases[product]) {
              purchaseCallback();
            } else {
              clearScreen(function() {loadAndRestoreGame("", window.forcedScene);});
              window.doneLoadingCallback = function() {
                window.purchaseCallback = purchaseCallback;
                callIos("purchase", product);
              }
            }
          } else {
            clearScreen(function() {loadAndRestoreGame("", window.forcedScene);});
          }
        });
        curl();
      });
    }
  } else if (window.isAndroidApp) {
    window.purchaseCallback = purchaseCallback;
    var androidStackTrace = androidBilling.purchase(product);
    if (androidStackTrace) throw new Error(androidStackTrace);
  } else if (window.isWinOldApp) {
    window.external.Purchase(product);
  } else if (window.isMacApp) {
    return callMac("purchase", product);
  } else if (window.isSteamworks) {
    var steamworksApps = require('../package.json').products;
    if (window.isSteamDeck) {
      var StoreFlagNone = 0;
      console.log('activating');
      steamworks.overlay.activateToStore(steamworksApps[product], StoreFlagNone);
      console.log('activated');
    } else {
      if (steamworksApps[product]) require("electron").shell.openExternal("steam://advertise/" + steamworksApps[product]);
    }
  } else if (window.isCef) {
    cefQuerySimple("Purchase " + product);
    // no callback; we'll refresh on purchase
  } else if (window.isWeb && !isPrerelease() && product == window.appPurchase) {
    var webStoreFallback = function() {
      window.appPurchase = null;
      purchase(product, callback);
    };
    var clickLink = function(id) {
      var link = document.getElementById(id);
      if (!link) return webStoreFallback();
      var href = link.getAttribute("href");
      if (!href) return webStoreFallback();
      window.location.href = href;
    };
    
    // instead of IAP, send Android users to a store
    if (/Silk/.test(navigator.userAgent)) {
      clickLink("kindleLink");
    } else if (/Android/.test(navigator.userAgent)) {
      clickLink("androidLink");
    } else if (window.steamClobber && document.getElementById("steamLink")) {
      clickLink("steamLink");
    } else {
      webStoreFallback();
    }
  } else if (isWebPurchaseSupported()) {
    if (!window.StripeCheckout) return asyncAlert("Sorry, we weren't able to initiate payment. (Your "+
      "network connection may be down.) Please refresh the page and try again, or contact "+
      "support@choiceofgames.com for assistance.");
    var fullProductName = window.storeName + "." + product;
    function stripe() {
      if (window.productData && window.productData[product]) {
        var data = productData[product];
        return StripeCheckout.open({
          key:         window.stripeKey,
          address:     false,
          amount:      data.amount,
          name:        data.display_name,
          email:       window.recordedEmail,
          panelLabel:  'Buy',
          token:       function(response) {
            clearScreen(function() {
              startLoading();
              xhrAuthRequest("POST", "purchase", function(ok, response) {
                doneLoading();
                if (ok) {
                  cacheKnownPurchases(response);
                  return purchaseCallback();
                } else if (/^card error: /.test(response.error)) {
                  var cardError = response.error.substring("card error: ".length);
                  asyncAlert(cardError);
                  clearScreen(function() {loadAndRestoreGame("", window.forcedScene);});
                } else if ("purchase already in flight" == response.error) {
                  asyncAlert("Sorry, there was an error handling your purchase. Please wait five minutes and try again, or contact support@choiceofgames.com for assistance.");
                  clearScreen(function() {loadAndRestoreGame("", window.forcedScene);});
                } else {
                  asyncAlert("Sorry, there was an error processing your card. (Your "+
                    "network connection may be down.) Please refresh the page and try again, or contact "+
                    "support@choiceofgames.com for assistance.");
                  clearScreen(function() {loadAndRestoreGame("", window.forcedScene);});
                }
                curl();
              }, "stripeToken", response.id, "product", fullProductName, "key", window.stripeKey);
            });
          }
        });
      } else {
        return asyncAlert("Sorry, we weren't able to initiate payment. (Your "+
          "network connection may be down.) Please refresh the page and try again, or contact "+
          "support@choiceofgames.com for assistance.");
      }
    }
    if (window.registered && window.recordedEmail) {
      stripe();
    }
    clearScreen(function() {
      var target = document.getElementById('text');
      target.innerHTML="<p>Please sign in to choiceofgames.com to purchase.</p>";
      loginForm(document.getElementById('text'), /*optional*/1, /*err*/null, function(registered){
        if (registered) {
          if (window.knownPurchases && window.knownPurchases[product]) {
            purchaseCallback();
          } else {
            clearScreen(function() {loadAndRestoreGame("", window.forcedScene);});
            return stripe();
          }
        } else {
          clearScreen(function() {loadAndRestoreGame("", window.forcedScene);});
        }
      });
      curl();
    });
  } else {
    safeTimeout(purchaseCallback, 0);
  }
}

function printDiscount(product, fullYear, oneBasedMonthNumber, dayOfMonth, line, options) {
  if (window.updatedDiscountDates && updatedDiscountDates[product]) {
    var udd = updatedDiscountDates[product];
    fullYear = udd.fullYear;
    oneBasedMonthNumber = udd.oneBasedMonthNumber;
    dayOfMonth = udd.dayOfMonth;
  }
  var shortMonthString = shortMonthStrings[oneBasedMonthNumber];
  var discountTimestamp = new Date(shortMonthString + " " + dayOfMonth + ", " + fullYear).getTime();
  var discountEligible = new Date().getTime() < discountTimestamp;
  var span;
  span = document.createElement("span");
  span.setAttribute("id", "discount_" + product);
  printx(line, span);
  span.innerHTML = span.innerHTML.replace("${choice_discount_ends}", "<span id=discountdate_"+product+">"+shortMonthString + " " + parseInt(dayOfMonth, 10) + "</span>") + " ";

  if (!discountEligible) {
    span.style.display = "none";
  }

  document.getElementById('text').appendChild(span);
}

function rewriteDiscount(product, fullYear, oneBasedMonthNumber, dayOfMonth) {
  if (!window.updatedDiscountDates) window.updatedDiscountDates = {};
  window.updatedDiscountDates[product] = {fullYear:fullYear, oneBasedMonthNumber:oneBasedMonthNumber, dayOfMonth:dayOfMonth};
  var span = document.getElementById("discount_"+product);
  if (!span) return;
  var shortMonthString = shortMonthStrings[oneBasedMonthNumber];
  var discountTimestamp = new Date(shortMonthString + " " + dayOfMonth + ", " + fullYear).getTime();
  var discountEligible = new Date().getTime() < discountTimestamp;
  if (discountEligible) {
    var dateSpan = document.getElementById("discountdate_"+product);
    if (!dateSpan) return;
    span.style.display = "";
    dateSpan.innerHTML = shortMonthString + " " + parseInt(dayOfMonth, 10);
  } else {
    span.style.display = "none";
  }
}

function handleDiscountResponse(ok, response) {
  if (!ok || !response || !window.storeName || !response[storeName]) return;
  if (!window.updatedDiscountDates) window.updatedDiscountDates = {};
  var udds = response[storeName];
  for (var product in udds) {
    if (!udds.hasOwnProperty(product)) continue;
    var udd = udds[product];
    var result = udd.split("-");
    rewriteDiscount(product, result[0], parseInt(result[1],10), parseInt(result[2], 10));
  }
}

function isPrerelease() {
  var steamTrial = window.isSteamApp && window.isTrial;
  if (typeof window != "undefined" && (window.isWeb || steamTrial) && window.releaseDate) {
    if (new Date() > window.releaseDate.getTime()) return false;
    if (/(fullaccess|preview)@choiceofgames.com/.test(getCookieByName("login"))) return false;
    var identity = document.getElementById("identity");
    return !(identity && /(fullaccess|preview)@choiceofgames.com/.test(identity.innerHTML));
  } else {
    return false;
  }
}

function registerNativeAchievement(name) {
  if (window.blockNativeAchievements) return;
  if (window.isIosApp) {
    callIos("achieve", name+"/");
  } else if (window.isMacApp) {
    callMac("achieve", name);
  } else if (window.isWinOldApp) {
    window.external.Achieve(name);
  } else if (window.isCef) {
    cefQuerySimple("Achieve " + name);
  } else if (window.isSteamworks) {
    steamworks.achievement.activate(name);
  }
}

function achieve(name, title, description) {
  if (initStore()) {
    checkAchievements(function() {
      window.store.set("achieved", toJson(nav.achieved));
    })
  }
  registerNativeAchievement(name);
  // Game Center shows a prominent banner; no need to show our own
  if (window.isIosApp && !window.isOmnibusApp) return;
  var escapedTitle = title+"".replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
  var escapedDescription = description+"".replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/\[b\]/g, '<b>')
    .replace(/\[\/b\]/g, '</b>')
    .replace(/\[i\]/g, '<i>')
    .replace(/\[\/i\]/g, '</i>');
  var html = "<b>Achievement: "+escapedTitle+"</b><br>" + escapedDescription;
  alertify.log(html);
}

function checkAchievements(callback) {
  safeTimeout(function() {
    if (!initStore()) return callback();
    window.store.get("achieved", function(ok, value){
      function mergeNativeAchievements(achieved) {
        window.checkAchievementCallback = null;
        var nativeRegistered = {};
        for (var i = 0; i < achieved.length; i++) {
          nav.achieved[achieved[i]] = true;
          nativeRegistered[achieved[i]] = true;
        }
        for (var achievement in nav.achieved) {
          if (nav.achieved[achievement] && !nativeRegistered[achievement]) {
            registerNativeAchievement(achievement);
          }
        }
        callback();
      }
      var alreadyLoadingAchievements = false;
      if (ok && value) {
        var achievementRecord = jsonParse(value);
        for (var achieved in achievementRecord) {
          if (achievementRecord[achieved]) nav.achieved[achieved] = true;
        }
      }
      if (window.isIosApp) {
        alreadyLoadingAchievements = !!window.checkAchievementCallback;
        window.checkAchievementCallback = mergeNativeAchievements;
        if (!alreadyLoadingAchievements) callIos("checkachievements");
      } else if (window.isSteamworks) {
        var nativeAchievements = [];
        for (var i = 0; i < window.achievements; i++) {
          if (steamworks.achievement.isActivated(window.achievements[i].name)) {
            nativeAchievements.push(achievement.name);
          }
        }
        mergeNativeAchievements(nativeAchievements);
      } else if (window.isMacApp) {
        alreadyLoadingAchievements = !!window.checkAchievementCallback;
        window.checkAchievementCallback = mergeNativeAchievements;
        if (!alreadyLoadingAchievements) callMac("checkachievements");
      } else if (window.isWinOldApp) {
        var checkWinAchievements = function () {
          var achieved = eval(window.external.GetAchieved());
          if (achieved) {
            mergeNativeAchievements(achieved);
          } else {
            safeTimeout(checkWinAchievements, 100);
          }
        };
        checkWinAchievements();
      } else if (window.isCef) {
        var checkCefAchievements = function() {
          cefQuery({
            request:"GetAchieved ",
            onSuccess: function(response) {
              //console.log("GetAchieved " + response);
              var achieved = eval(response);
              mergeNativeAchievements(achieved);
            },
            onFailure: function(error_code, error_message) {
              //console.error("GetAchieved error " + error_message);
              if (error_code == 1) {
                safeTimeout(checkCefAchievements, 100);
              } else {
                callback();
              }
            }
          });
        };
        checkCefAchievements();
      } else {
        callback();
      }
    });
  },0);
}

function isAdvertisingSupported() {
  if (typeof window === "undefined") return false;
  return (window.isIosApp || window.isAndroidApp || window.adSupportedDebug);
}

function isFullScreenAdvertisingSupported() {
  return isAdvertisingSupported();
}

function showFullScreenAdvertisement(callback) {
  if (window.isIosApp) {
    callIos("advertisement");
    safeTimeout(callback, 0);
  } else if (window.isAndroidApp && window.adBridge) {
    adBridge.displayFullScreenAdvertisement();
    safeTimeout(callback, 0);
  } else if (window.adSupportedDebug) {
    alert("ad!");
    safeTimeout(callback, 0);
  } else {
    safeTimeout(callback, 0);
  }
}

function showFullScreenAdvertisementButton(buttonName, skipCallback, doneCallback) {
  if (typeof isFullScreenAdvertisingSupported == "undefined" || !isFullScreenAdvertisingSupported()) {
    safeTimeout(skipCallback, 0);
    return;
  }
  startLoading();
  checkPurchase("adfree", function (ok, result) {
    doneLoading();
    if (result.adfree) {
      skipCallback();
    } else {
      printButton(buttonName, main, false, function () {
        showFullScreenAdvertisement(doneCallback);
      })
    }
  });
}

function showTicker(target, endTimeInSeconds, finishedCallback) {
  if (!target) target = document.getElementById('text');
  var div = document.createElement("span");
  div.setAttribute("id", "delayTicker");
  target.appendChild(div);
  var timerDisplay = document.createElement("span");
  div.appendChild(timerDisplay);
  var timer;

  var statsButton = document.getElementById("statsButton");
  if (statsButton) {
    var defaultStatsButtonDisplay = statsButton.style.display;
    statsButton.style.display = "none";
  }

  if (endTimeInSeconds > Math.floor(new Date().getTime() / 1000)) {
    if (window.isAndroidApp) {
      notificationBridge.scheduleNotification(endTimeInSeconds);
    } else if (window.isIosApp) {
      callIos("schedulenotification", endTimeInSeconds);
    }
  }

  function cleanUpTicker() {
    window.blockRestart = false;
    if (window.isAndroidApp) {
      notificationBridge.cancelNotification();
    } else if (window.isIosApp) {
      callIos("cancelnotifications");
    }
    clearInterval(timer);
    if (statsButton) statsButton.style.display = defaultStatsButtonDisplay;
  }

  function formatSecondsRemaining(secondsRemaining, forceMinutes) {
    if (!forceMinutes && secondsRemaining < 60) {
      return ""+secondsRemaining+"s";
    } else {
      var minutesRemaining = Math.floor(secondsRemaining / 60);
      var remainderSeconds;
      if (minutesRemaining < 60) {
        remainderSeconds = secondsRemaining - minutesRemaining * 60;
        return ""+minutesRemaining+"m " + formatSecondsRemaining(remainderSeconds);
      } else if (minutesRemaining < 6000) {
        var hoursRemaining = Math.floor(secondsRemaining / 3600);
        remainderSeconds = secondsRemaining - hoursRemaining * 3600;
        return ""+hoursRemaining+"h " + formatSecondsRemaining(remainderSeconds, true);
      } else {
        var daysRemaining = Math.floor(secondsRemaining / 86400);
        remainderSeconds = secondsRemaining - daysRemaining * 86400;
        return ""+daysRemaining+" days " + formatSecondsRemaining(remainderSeconds, true);
      }
    }
  }

  function tick() {
    var tickerElement = document.getElementById("delayTicker");
    var tickerStillVisible = tickerElement && tickerElement.parentNode && tickerElement.parentNode.parentNode;
    if (!tickerStillVisible) {
      cleanUpTicker();
      return;
    }
    var nowInSeconds = Math.floor(new Date().getTime() / 1000);
    var secondsRemaining = endTimeInSeconds - nowInSeconds;
    if (secondsRemaining >= 0) {
      timerDisplay.innerHTML = "" + formatSecondsRemaining(secondsRemaining) + " seconds remaining";
    } else {
      cleanUpTicker();
      tickerElement.innerHTML = "0s remaining";
      if (finishedCallback) safeCall(null, finishedCallback);
    }
  }

  timer = setInterval(tick, 1000);
  tick();
}

function printButton(name, parent, isSubmit, code) {
  var button;
  if (isSubmit) {
    button = document.createElement("input");
    button.type = "submit";
    button.value = name;
    button.name = name;
  } else {
    button = document.createElement("button");
    button.setAttribute("type", "button");
    printx(name, button);
  }
  setClass(button, "next");
  button.setAttribute("accesskey", "n");
  if (code) button.onclick = function(event) {
    if (window.isIosApp) {
      window.freezeCallback = function() {
        window.freezeCallback = null;
        code(event);
      };
      callIos("freeze");
    } else {
      safeCall(null, function() {code(event);});
    }
  };
  if (!isMobile) try { button.focus(); } catch (e) {}
  parent.appendChild(button);
  return button;
}

function printLink(target, href, anchorText, onclick) {
  if (!target) target = document.getElementById('text');
  var link = document.createElement("a");
  link.setAttribute("href", href);
  link.appendChild(document.createTextNode(anchorText));
  if (onclick) {
    if (link.addEventListener) {
      link.addEventListener("click", onclick, true);
    } else {
      link.onclick = onclick;
    }
  }
  target.appendChild(link);
  target.appendChild(document.createTextNode(" "));
}

function kindleButton(target, query, buttonName) {
  printButton(buttonName, main, false,
    function() {
      try {
        window.location.href="http://www.amazon.com/s?rh=n%3A133140011%2Ck%3A" + encodeURIComponent(query);
      } catch (e) {} // xulrunner will intercept this link and throw an exception, opening it in the external browser
    }
  );
}

function printInput(target, inputOptions, callback, minimum, maximum, step) {
    if (!target) target = document.getElementById('text');
    var form = document.createElement("form");
    target.appendChild(form);
    var self = this;
    form.action="#";


    if (inputOptions.long) {
      var input = document.createElement("textarea");
      input.setAttribute("rows", 4);
    } else {
      var input = document.createElement("input");
      if (inputOptions.numeric) {
        input.setAttribute("type", "number");
        input.setAttribute("min", minimum);
        input.setAttribute("max", maximum);
        step = step || "any";
        input.setAttribute("step", step);
      }
    }

    input.setAttribute("autocomplete", "off");

    input.name="text";
    input.setAttribute("style", "font-size: 25px; width: 90%;");
    form.appendChild(input);

    form.onsubmit = function(e) {
        preventDefault(e);
        if (!input.value && !inputOptions.allow_blank) {
            asyncAlert("Don't just leave it blank!  Type something!");
            return;
        }
        if (window.isIosApp) {
          window.freezeCallback = function() {
            window.freezeCallback = null;
            safeCall(null, function() {callback(input.value);});
          };
          callIos("freeze");
        } else {
          safeCall(null, function() {callback(input.value);});
        }
        return false;
    };

    printButton("Next", form, true);

}

function promptEmailAddress(target, defaultEmail, allowContinue, callback) {
  if (!target) target = document.getElementById('text');
  var form = document.createElement("form");
  var self = this;
  form.action="#";

  var message = document.createElement("div");
  message.style.color = "red";
  message.style.fontWeight = "bold";
  message.setAttribute("id", "errorMessage");
  form.appendChild(message);

  var input = document.createElement("input");
  // This can fail on IE
  try { input.type="email"; } catch (e) {}
  input.name="email";
  input.value=defaultEmail;
  input.setAttribute("style", "font-size: 25px; width: 90%;");
  form.appendChild(input);
  target.appendChild(form);
  println("", form);
  println("", form);
  printButton("Next", form, true);

  if (allowContinue) {
    printButton("No, Thanks", target, false, function() {
      callback(true);
    });
  }

  form.onsubmit = function(e) {
    preventDefault(e);
    safeCall(this, function() {
      var email = trim(input.value);
      if (!/^\S+@\S+\.\S+$/.test(email)) {
        var messageText = document.createTextNode("Sorry, \""+email+"\" is not an email address.  Please type your email address again.");
        message.innerHTML = "";
        message.appendChild(messageText);
      } else {
        recordEmail(email, function() {
          callback(false, email);
        });
      }
    });
  };

  curl();
}

function loginForm(target, optional, errorMessage, callback) {
  if (!isRegisterAllowed() || !initStore()) return safeTimeout(function() {
    callback(!"ok");
  }, 0);
  var optional_start = 1;
  var optional_returning_subscribe = 2;
  var optional_returning_no_subscribe = 3;
  var optional_new_subscribe = 4;
  var optional_new_no_subscribe = 5;
  startLoading();
  fetchEmail(function(defaultEmail) {
    isRegistered(function(registered) {
      if (registered) {
        if (defaultEmail) {
          doneLoading();
          loginDiv(registered, defaultEmail);
          return safeTimeout(callback, 0);
        }
        // Cookie says I'm logged in, but we have no local record of the email address
        return getRemoteEmail(function(ok, response) {
          doneLoading();
          if (ok) {
            if (response.email) {
              loginDiv(registered, response.email);
              return recordEmail(response.email, callback);
            } else {
              // not really logged in after all
              logout();
              loginDiv();
              return loginForm(target, optional, errorMessage, callback);
            }
          } else {
            // missed an opportunity to record email locally. meh.
            return safeCall(null, callback);
          }
        });
      }
      doneLoading();
      var form = document.createElement("form");

    if (!errorMessage) errorMessage = "";

      var escapedEmail = defaultEmail.replace(/'/g, "&apos;");
      var passwordButton;
      if (optional == optional_start) {
        form.innerHTML = "<div id=message style='color:red; font-weight:bold'>"+errorMessage+
          "</div><div class='choice'>"+
          "<div><label for=yes class=firstChild><input type=radio name=choice value=yes id=yes checked> My email address is: "+
          "<input type=email name=email id=email value='"+escapedEmail+"' style='font-size: 25px; width: 11em'></label></div>"+
          ((isWeb && window.facebookAppId) ?"<div><label for=facebook><input type=radio name=choice value=facebook id=facebook > Sign in with Facebook.</label></div>":"")+
          ((isWeb && window.googleAppId) ?"<div><label for=google><input type=radio name=choice value=google id=google > Sign in with Google.</label></div>":"")+
          ((window.steamRestoreCallback) ?"<div><label for=steam><input type=radio name=choice value=steam id=steam > Restore purchases from Steam.</label></div>":"")+
          "<div><label for=no class=lastChild><input type=radio name=choice value=no id=no > No, thanks.</label></div></div>"+
          "<p><label class=noBorder for=subscribe><input type=checkbox name=subscribe id=subscribe checked> "+
          "Email me when new games are available.</label></p>";

        form.email.onclick = function() {
          setTimeout(function() {form.email.focus();}, 0);
        };
        setTimeout(function() {form.email.focus();}, 0);
      } else {
        form.innerHTML = "<div id=message style='color:red; font-weight:bold'>"+errorMessage+
          "</div><span><span>My email address is: </span><input type=email name=email id=email value='"+
          escapedEmail+"' style='font-size: 25px; width: 12em'></span><p><label class=noBorder id=subscribeLabel for=subscribe>"+
          "<input type=checkbox name=subscribe id=subscribe checked> "+
          "Email me when new games are available.</label></p><p>Do you have a choiceofgames.com password?</p>"+
          "<div class='choice'>"+
          "<div><label for=new class=firstChild><input type=radio name=choice value=new id=new checked> No, I'm new.</label></div>"+
          "<div><label for=passwordButton><input type=radio name=choice value=passwordButton id=passwordButton> "+
          "Yes, I have a password: <input id=password type=password name=password disabled class=needsclick style='font-size: 25px; width: 11em'></label></div>"+
          "<div><label for=forgot><input type=radio name=choice value=forgot id=forgot> I forgot my password.</label></div>"+
          ((isWeb && window.facebookAppId)?"<div><label for=facebook><input type=radio name=choice value=facebook id=facebook> Sign in with Facebook.</label></div>":"")+
          ((isWeb && window.googleAppId)?"<div><label for=google><input type=radio name=choice value=google id=google> Sign in with Google.</label></div>":"")+
          (optional ? "<div><label for=no><input type=radio name=choice value=no id=no> Cancel.</label></div>" : "") +
          "</div>";

        var labels = form.getElementsByTagName("label");
        setClass(labels[labels.length-1], "lastChild");

        var password = form.password;
        passwordButton = form.passwordButton;

        passwordButton.parentNode.onclick = function() {
          passwordButton.checked = true;
          passwordButton.onchange();
        };

        var radioButtons = form.choice;
        var onchange = function() {
          var enabled = passwordButton.checked;
          password.disabled = !enabled;
          if (enabled) {
            password.focus();
            setTimeout(function() {password.parentNode.scrollIntoView();}, 0);
          }
        };
        for (var i = radioButtons.length - 1; i >= 0; i--) {
          radioButtons[i].onchange = onchange;
        }
        if (optional) {
          form.subscribe.checked = (optional == optional_returning_subscribe || optional == optional_new_subscribe);
          passwordButton.checked = (optional == optional_returning_subscribe || optional == optional_returning_no_subscribe);
        }
      }

      function showMessage(msg) {
        var message = document.getElementById('message');
        var messageText = document.createTextNode(msg);
        message.innerHTML = "";
        message.appendChild(messageText);
      }

      form.onsubmit = function(event) {
        preventDefault(event);
        var email = trim(form.email.value);
        var subscribe = form.subscribe.checked;
        var choice = getFormValue("choice");
        if ("steam" == choice) {
          window.location.href = "https://www.choiceofgames.com/profile/?steamRestore&gameId=" + window.storeName;
        }
        if ("facebook" == choice) {
          if (!window.FB) return asyncAlert("Sorry, we weren't able to sign you in with Facebook. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
          var loginParams = {scope:'email',return_scopes:true};
          if (window.facebookReRequest) loginParams.auth_type = "rerequest";
          return FB.login(function(response){
            if ("connected" == response.status) {
              var grantedScopes = [];
              try { grantedScopes = response.authResponse.grantedScopes.split(","); } catch (e) {}
              var grantedEmail = false;
              for (var i = 0; i < grantedScopes.length; i++) {
                if ("email" == grantedScopes[i]) {
                  grantedEmail = true;
                  break;
                }
              }
              if (grantedEmail) {
                xhrAuthRequest("POST", "facebook-login", function(ok, response){
                  if (ok) {
                    loginDiv(ok, response.email);
                    recordLogin(ok, response.id, response.email);
                    cacheKnownPurchases(response.purchases);
                    safeCall(null, function() {callback("ok");});
                  } else {
                    asyncAlert("Sorry, we weren't able to sign you in with Facebook. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
                  }
                }, "app_id", facebookAppId);
              } else {
                showMessage("Sorry, we require an email address to sign you in. Please grant access to your email address, or type your email address below.");
                window.facebookReRequest = true;
              }
            }
          },loginParams);
        }
        if ("google" == choice) {
          if (!window.gapi) return asyncAlert("Sorry, we weren't able to sign you in with Google. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
          var done = false;
          return gapi.auth.signIn({callback: function (authResult) {
            if (done) return;
            done = true;
            if (authResult['status']['signed_in']) {
              isRegistered(function(registered) {
                if (!registered) xhrAuthRequest("POST", "google-login", function(ok, response){
                  loginDiv(ok, response.email);
                  recordLogin(ok, response.id, response.email);
                  cacheKnownPurchases(response.purchases);
                  if (ok) {
                    callback("ok");
                  } else {
                    asyncAlert("Sorry, we weren't able to sign you in with Google. Please try again later, or contact support@choiceofgames.com for assistance.");
                  }
                }, "code", authResult['code'], "client_id", googleAppId);
              });
            } else {
              asyncAlert("Sorry, we weren't able to sign you in with Google. Please try again later, or contact support@choiceofgames.com for assistance.");
            }
          }});
        }
        if (!/^\S+@\S+\.\S+$/.test(email) && "no" != choice) {
          showMessage('Sorry, "'+email+'" is not an email address.  Please type your email address again.');
        } else {
          recordEmail(email, function() {
            if ("yes" == choice) {
              clearScreen(function() {
                if (defaultEmail) {
                  optional = subscribe ? optional_returning_subscribe : optional_returning_no_subscribe;
                } else {
                  optional = subscribe ? optional_new_subscribe : optional_new_no_subscribe;
                }
                loginForm(document.getElementById("text"), optional, null, callback);
                curl();
              });
            } else if ("no" == choice) {
              safeCall(null, function() {callback(false);});
            } else if ("new" == choice) {
              target.innerHTML = "";
              window.scrollTo(0,1);
              form = document.createElement("form");
              var escapedEmail = email.replace(/'/g, "&apos;");
              form.innerHTML = "<div id=message style='color:red; font-weight:bold'></div>"+
                "<div>My email address is: </div><div><input type=email name=email id=email value='"+
                escapedEmail+"' style='font-size: 25px; width: 12em'></div>"+
                "<div>Type it again: </div><div><input type=email name=email2 id=email2 autocomplete='off' style='font-size: 25px; width: 12em'></div>"+
                "<div>Enter a new password:&nbsp;</div><div>"+
                "<input type=password name=password id=password style='font-size: 25px; width: 12em'></div>";
              form.onsubmit = function(event) {
                preventDefault(event);
                var email = trim(form.email.value);
                var email2 = trim(form.email2.value);
                if (!/^\S+@\S+\.\S+$/.test(email)) {
                  showMessage('Sorry, "'+email+'" is not an email address.  Please type your email address again.');
                  return;
                } else if (email != email2) {
                  showMessage('Those email addresses don\'t match.  Please type your email address again.');
                  return;
                }
                startLoading();
                form.style.display = "none";
                window.scrollTo(0,1);
                login(email, form.password.value, /*register*/true, subscribe, function(ok, response) {
                  doneLoading();
                  if (ok) {
                    target.innerHTML = "";
                    loginDiv(ok, email);
                    recordLogin(ok, response.id, email);
                    cacheKnownPurchases(response.purchases);
                    // we need another click event so we can launch Stripe in a pop-up
                    if (window.isWeb) {
                      asyncAlert("You have registered successfully.", function() {
                        safeCall(null, function() {callback("ok");});
                      });
                    } else {
                      return safeCall(null, function() {callback("ok");});
                    }
                  } else if ("incorrect password" == response.error) {
                    target.innerHTML = "";
                    loginForm(target, optional, 'Sorry, the email address "'+email+'" is already in use. Please type your password below, or use a different email address.', callback);
                  } else {
                    form.style.display = "";
                    showMessage("Sorry, we weren't able to sign you in. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
                  }
                });
              };
              target.appendChild(form);
              println("", form);
              printButton("Next", form, true);
              if (optional) {
                printButton("Cancel", form, false, function() {
                  safeCall(null, function() {callback(false);});
                });
              }
            } else if ("passwordButton" == choice) {
              startLoading();
              form.style.display = "none";
              window.scrollTo(0,1);
              login(email, form.password.value, /*register*/false, form.subscribe.checked, function(ok, response) {
                doneLoading();
                form.style.display = "";
                if (ok) {
                  target.innerHTML = "";
                  loginDiv(ok, email);
                  recordLogin(ok, response.id, email);
                  cacheKnownPurchases(response.purchases);
                  // we need another click event so we can launch Stripe in a pop-up
                  if (window.isWeb) {
                    asyncAlert("You have registered successfully.", function() {
                      safeCall(null, function() {callback("ok");});
                    });
                  } else {
                    return safeCall(null, function() {callback("ok");});
                  }
                } else if ("unknown email" == response.error) {
                  showMessage('Sorry, we can\'t find a record for the email address "'+email+'". Please try a different email address, or create a new account.');
                } else if ("incorrect password" == response.error) {
                  showMessage('Sorry, that password is incorrect. Please try again, or select "I forgot my password" to reset your password.');
                } else {
                  showMessage("Sorry, we weren't able to sign you in. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
                }
              });
            } else if ("forgot" == choice) {
              startLoading();
              form.style.display = "none";
              window.scrollTo(0,1);
              forgotPassword(email, function(ok, response) {
                doneLoading();
                form.style.display = "";
                if (ok) {
                  showMessage("We've emailed you a link to reset your password. Please check your email and click on the link, then return here to sign in.");
                  document.getElementById('passwordButton').checked = true;
                  document.getElementById('passwordButton').onchange();
                } else if ("unknown email" == response.error) {
                  showMessage('Sorry, we can\'t find a record for the email address "'+email+'". Please try a different email address, or create a new account.');
                } else {
                  showMessage("Sorry, we weren't able to sign you in. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
                }
              });
            }
          });
        }
      };

      target.appendChild(form);
      if (passwordButton && passwordButton.checked) passwordButton.onchange();
      if (optional && optional > 1) document.getElementById("subscribeLabel").style.display = "none";
      printButton("Next", form, true);
      printFooter();
    });
  });
}

function loginDiv(registered, email) {
  var domain = "https://www.choiceofgames.com/";
  var identity = document.getElementById("identity");
  if (!identity) return;
  var emailLink = document.getElementById("email");
  var logoutLink = document.getElementById("logout");
  if (registered) {
    emailLink.setAttribute("href", domain + "profile" + "/");
    emailLink.innerHTML = "";
    emailLink.appendChild(document.createTextNode(email));
    logoutLink.onclick = function(event) {
      preventDefault(event);
      logout();
      loginDiv();
    };
    emailLink.style.display = "block";
    logoutLink.style.display = "block";
  } else {
    emailLink.style.display = "none";
    logoutLink.style.display = "none";
  }
}

function isRegistered(callback) {
  if (window.isWeb) {
    return safeTimeout(function() {
      if (!window.registered) window.registered = !!getCookieByName("login");
      callback(window.registered);
    }, 0);
  } else if (initStore()) {
    return window.store.get("login", function(ok, value) {
      safeTimeout(function() {
        window.registered = ok && value && "false" != value && "0" != value;
        callback(window.registered);
      }, 0);
    });
  } else {
    safeCall(null, function() {
      window.registered = false;
      callback(false);
    });
  }
}

function isRegisterAllowed() {
  return isWebSavePossible();
}

function preventDefault(event) {
  if (!event) event = window.event;
  if (!event) return;
  if (event.preventDefault) {
    event.preventDefault();
  } else {
    event.returnValue = false;
  }
}

function getPassword(target, code) {
  if (!target) target = document.getElementById('text');
  var textArea = document.createElement("textarea");
  textArea.cols = 41;
  textArea.rows = 30;
  setClass(textArea, "savePassword");
  target.appendChild(textArea);
  println("", target);
  printButton("Next", target, false, function() {
    code(false, textArea.value);
  });

  printButton("Cancel", target, false, function() {
    code(true);
  });
}

function showPassword(target, password) {
  if (!target) target = document.getElementById('text');

  var textBuffer = [];
  var colWidth = 40;
  for (var i = 0; i < password.length; i++) {
    textBuffer.push(password.charAt(i));
    if ((i + 1) % colWidth === 0) {
      textBuffer.push('\n');
    }
  }
  password = "----- BEGIN PASSWORD -----\n" + textBuffer.join('') + "\n----- END PASSWORD -----";

  var shouldButton = isMobile;
  if (shouldButton) {
    var button = printButton("Email My Password to Me", target, false,
      function() {
        safeCall(self, function() {
            if (isWeb) {
              // TODO more reliable system
            }
            window.location.href = "mailto:?subject=Save%20this%20password&body=" + encodeURIComponent(password);
        });
      }
    );
    setClass(button, "");
  }

  var shouldTextArea = !isMobile;
  if (shouldTextArea) {
    var textArea = document.createElement("textarea");
    textArea.cols = colWidth + 1;
    textArea.rows = 30;
    setClass(textArea, "savePassword");

    textArea.setAttribute("readonly", true);
    textArea.onclick = function() {textArea.select();};
    textArea.value = (password);
    target.appendChild(textArea);
  }
}

function changeTitle(title) {
  document.title = title;
  var titleTag = document.getElementById("title");
  if (titleTag) {
    titleTag.innerHTML = "";
    titleTag.appendChild(document.createTextNode(title));
  }
  var text = document.getElementById('text');
  if (text) {
    var textTitleTag = document.createElement('h1');
    textTitleTag.classList.add('gameTitle');
    textTitleTag.appendChild(document.createTextNode(title));
    text.appendChild(textTitleTag);
  }
}

function changeAuthor(author) {
  var authorTag = document.getElementById("author");
  if (authorTag) {
    authorTag.innerHTML = "";
    authorTag.appendChild(document.createTextNode("by " + author));
  }
  var text = document.getElementById('text');
  if (text) {
    var textAuthorTag = document.createElement('h2');
    textAuthorTag.classList.add('gameTitle');
    textAuthorTag.appendChild(document.createTextNode("by " + author));
    text.appendChild(textAuthorTag);
  }
}


function reportBug() {
  var prompt = "Please explain the problem. Be sure to describe what you expect, as well as what actually happened.";
  alertify.prompt(prompt, function(ok, body) {
    var statMsg = "(unknown)";
    try {
        var scene = window.stats.scene;
        statMsg = computeCookie(scene.stats, scene.temps, scene.lineNum, scene.indent);
    } catch (ex) {}
    body += "\n\nGame: " + window.storeName;
    if (window.stats && window.stats.scene) {
      body += "\nScene: " + window.stats.scene.name;
      body += "\nLine: " + (window.stats.scene.lineNum+1);
    }
    body += "\nUser Agent: " + navigator.userAgent;
    body += "\nLoad time: " + window.loadTime;
    if (window.Persist) body += "\nPersist: " + window.Persist.type;
    body += "\nversion=" + window.version;
    body += "\n\n" + statMsg;
    if (window.nav && window.nav.bugLog) body += "\n\n" + window.nav.bugLog.join("\n");
    console.log(body);
    if (ok) alertify.prompt("Please type your email address.", function(ok, email) {
      if (ok) xhrAuthRequest("POST", "support-mail", function(ok, response) {
        if (ok) {
          alertify.log("Thank you for reporting a bug!");
        } else {
          alertify.alert("Bug reporting failed. Please email your bug report to support@choiceofgames.com (and be sure to mention that the bug reporter failed!)");
        }
      }, "email", encodeURIComponent(email),
        "subject", encodeURIComponent("bug report " + window.storeName),
        "text", encodeURIComponent(body));
    });
  });
}

window.registered = false;

function getSupportEmail() {
  if (window.storeName) {
    return "support-" + storeName + "-" + platformCode() + "@choiceofgames.com";
  }
  try {
    return document.getElementById("supportEmail").getAttribute("href").substring(7);
  } catch (e) {
    return "support-external@choiceofgames.com";
  }
}

function absolutizeAboutLink() {
  var aboutAnchor = document.getElementById("aboutLink");
  if (aboutLink) {
    var aboutHref = aboutLink.getAttribute("href");
    if (/^https?:/.test(aboutHref)) return;

    var linkTags = document.getElementsByTagName("link");
    var canonical;
    for (var i = 0; i < linkTags.length; i++) {
      if (linkTags[i].getAttribute("rel") == "canonical") {
        canonical = linkTags[i].getAttribute("href");
        break;
      }
    }

    if (!canonical) return;

    var absoluteCanonical;
    if (/^https?:/.test(canonical)) {
      absoluteCanonical = canonical;
    } else if (/^\//.test(canonical)) {
      absoluteCanonical = "https://www.choiceofgames.com" + canonical;
    } else {
      absoluteCanonical = "https://www.choiceofgames.com/" + canonical;
    }
    if (!/\/$/.test(canonical)) {
      absoluteCanonical += "/";
    }

    aboutLink.setAttribute("href", absoluteCanonical + aboutHref);
  }
}

function aboutClick() {
    window.location.href = document.getElementById("aboutLink").href;
}

function loadPreferences() {
  if (initStore()) {
    store.get("preferredZoom", function(ok, preferredZoom) {
      if (ok && !isNaN(parseFloat(preferredZoom))) {
        setZoomFactor(parseFloat(preferredZoom));
      }
    });
    store.get("preferredBackground", function(ok, preferredBackground) {
      if (!/^(sepia|black|white)$/.test(preferredBackground)) {
        preferredBackground = "sepia";
      }
      if (preferredBackground === "black") {
        document.body.classList.add("nightmode");
      } else if (preferredBackground === "white") {
        document.body.classList.add("whitemode");
      }
    });
    store.get("preferredAnimation", function(ok, preferredAnimation) {
      window.animateEnabled = parseFloat(preferredAnimation) !== 2;
    });
    store.get("preferredSliding", function (ok, preferredSliding) {
      window.slidingEnabled = preferredSliding !== false && preferredSliding !== "false";
    });
  } else {
    window.animateEnabled = true;
  }
  if (typeof document.body.style.animationName === "undefined") {
    if (typeof document.body.style.webkitAnimationName === "undefined") {
      window.animateEnabled = false;
    } else {
      window.animationProperty = "webkitAnimationName";
    }
  } else {
    window.animationProperty = "animationName";
  }
  if (window.isCef || document.getElementsByTagName("audio").length) {
    delete window.animationProperty;
  }
}

window.addEventListener("error", function (event) {
    var msg = event.message;
    var file = event.source;
    var line = event.lineno;
    var column = event.colno;
    var error = event.error;
    window.reportError(msg, file, line, column, error);
});

window.reportError = function(msg, file, line, column, error) {
    if (window.console) {
      window.console.error(msg);
      if (file) window.console.error("file: " + file);
      if (line) window.console.error("line: " + line);
      if (column) window.console.error("column: " + column);
      if (error) window.console.error(error);
    }
    if (window.isWeb && error && error.name === "QuotaExceededError" && window.location.host === 'www.choiceofgames.com') {
      window.location.assign('https://www.choiceofgames.com/clear-site-data/?qee=1&path=' + encodeURIComponent(window.location.pathname));
    }
    alert(msg);
    if (!isWebSavePossible()) return;
    var ok = confirm("Sorry, an error occurred.  Click OK to email error data to support.");
    if (ok) {
        var statMsg = "(unknown)";
        try {
          var scene = window.stats.scene;
          statMsg = computeCookie(scene.stats, scene.temps, scene.lineNum, scene.indent);
        } catch (ex) {}
        var body = "What were you doing when the error occurred?\n\nError: " + msg;
        body += "\n\nGame: " + window.storeName;
        if (window.stats && window.stats.scene) {
          body += "\nScene: " + window.stats.scene.name;
          body += "\nLine: " + (window.stats.scene.lineNum + 1);
        }
        if (file) body += "\nJS File: " + file;
        if (line) body += "\nJS Line: " + line;
        if (column) body += "\nJS Column: " + column;
        if (error) body += "\nJS Stack: " + error;
        body += "\nUser Agent: " + navigator.userAgent;
        body += "\nLoad time: " + window.loadTime;
        if (window.Persist) body += "\nPersist: " + window.Persist.type;
        body += "\n\n" + statMsg + "\n\nversion=" + window.version;
        if (window.currentVersion) {
          body += "\ncurrentVersion=" + window.currentVersion;
        }
        if (window.nav && window.nav.bugLog) body += "\n\n" + window.nav.bugLog.join("\n");
        var supportEmailHref = "mailto:support-external@choiceofgames.com";
        try {
          supportEmailHref="mailto:"+getSupportEmail();
          supportEmailHref=supportEmailHref.replace(/\+/g,"%2B");
        } catch (e) {}
        window.location.href=(supportEmailHref + "?subject=Error Report&body=" + encodeURIComponent(body));
    }
}

window.onload=function() {
    if (window.alreadyLoaded) return;
    window.alreadyLoaded = true;
    setTimeout(updateAllPaidSceneCaches, 0);
    window.main = document.getElementById("main");
    var head = document.getElementsByTagName("head")[0];
    window.nav.setStartingStatsClone(window.stats);
    loadPreferences();
    if (window.achievements && window.achievements.length) {
      nav.loadAchievements(window.achievements);
      checkAchievements(function() {});
      setButtonTitles();
    }
    nav.loadProducts(window.knownProducts, window.purchases);
    stats.sceneName = window.nav.getStartupScene();
    var map = parseQueryString(window.location.search);
    if (!map) {
      var hashMap = parseQueryString(window.location.hash);
      var realHash = false;
      for (var key in hashMap) {
        if (/^utm_/.test(key)) continue;
        realHash = true;
        break;
      }
      if (realHash) map = hashMap;
    }

    if (!map) {
      if (window.androidQueryString) {
        map = parseQueryString(window.androidQueryString.get());
      } else if (window.forcedScreenshots) {
        map = {forcedScene:"screenshots"};
      }
    }

    if (map) {
      window.forcedScene = map.forcedScene;
      window.slot = map.slot;
      window.debug = map.debug;
      if (map.restart) {
        restartGame();
      } else if (map.achievements) {
        doneLoading();
        showAchievements("hideNextButton");
      } else if (map.omnibusRestore) {
        restorePurchases('adfree', function(purchased) {
          if (window.isIosApp) {
            callIos('close');
          } else {
            setTimeout(function() {window.closer.close()}, 0);
          }
        });
      } else if (map.forcedScene) {
        safeCall(null, function() {loadAndRestoreGame(window.slot, window.forcedScene);});
      } else if (map.persistence) {
        var persistenceParts = map.persistence.split("|");
        if (persistenceParts.length == 2) {
          window.storeName = persistenceParts[0];
          window.remoteStoreName = persistenceParts[1];
        } else {
          window.storeName = map.persistence;
        }
        var startupScene = new Scene("startup", window.stats, window.nav, {secondaryMode:"startup", saveSlot:"startup"});
        startupScene.startupCallback = function() {
          safeCall(null, loadAndRestoreGame);
        }
        startupScene.execute();
      } else if (map.textOptionsMenu) {
        if (initStore()) {
          store.get("preferredSliding", function (ok, preferredSliding) {
            textOptionsMenu();
          });
        } else {
          textOptionsMenu();
        }
      } else {
        safeCall(null, loadAndRestoreGame);
      }
    } else {
      safeCall(null, loadAndRestoreGame);
    }
    if (window.beta) {
      var reportBugButton = document.getElementById("bugButton");
      if (reportBugButton) reportBugButton.setAttribute("style", "");
    }
    if (window.Touch && window.isWeb) {
      // INSERT ADMOB AD
    }
    isRegistered(function(registered){
      if (registered) {
        fetchEmail(function(email) {
          loginDiv(registered, email);
        });
      } else {
        loginDiv();
      }
    });
    if (window.isWinStoreApp || window.isWinOldApp) {
        var subscribeAnchor = document.getElementById("subscribeLink");
        if (subscribeAnchor) {
            subscribeAnchor.onclick = function() {
              safeCall(null, subscribeLink);
              return false;
            };
        }
    }
    if (window.isWinOldApp) {
        absolutizeAboutLink();
        var h1s = document.getElementsByTagName("h1");
        if (h1s.length) window.external.SetTitle(document.getElementsByTagName("h1")[0].innerText);
    }
    if (isFollowEnabled()) {
      var shareElement = document.getElementById("share");
      if (shareElement) shareElement.innerHTML = '<iframe src="//www.facebook.com/plugins/like.php?href=https%3A%2F%2Fwww.facebook.com%2Fchoiceofgames&amp;send=false'+
      '&amp;layout=button_count&amp;width=90&amp;show_faces=true&amp;font&amp;colorscheme=light&amp;action=like&amp;height=20&amp;appId=190439350983878"'+
      ' scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:90px; height:20px;" allowTransparency="true"></iframe>'+
      '<iframe allowtransparency="true" frameborder="0" scrolling="no" '+
      'src="//platform.twitter.com/widgets/follow_button.html?screen_name=choiceofgames&amp;show_screen_name=false"'+
      ' style="width:160px; height:20px;"></iframe>';
    }
    var supportEmailLink = document.getElementById("supportEmail");
    if (window.storeName && supportEmailLink) {
      supportEmailLink.href = "mailto:" + getSupportEmail();
    }

    submitAnyDirtySaves();

    if (window.purchaseSubscriptions) {
      var productList = "";
      for (var key in purchaseSubscriptions) {
        productList += (productList ? " " : "") + key;
      }
      if (productList) checkPurchase(productList, function() {});
    }
    if (window.isWeb) {
      (function() {
        if (isPrerelease()) {
          var appLinks = document.getElementById('mobileLinks');
          if (appLinks) appLinks.style.display = 'none';
        }
        var productMap = {};
        if (typeof purchases === "object") {
          for (var scene in purchases) {
            productMap[purchases[scene]] = 1;
          }
        }
        if (!window.knownProducts) window.knownProducts = [];
        for (var product in productMap) {
          window.knownProducts.push(product);
        }

        var fullProducts = [];
        for (var i = 0; i < window.knownProducts.length; i++) {
          fullProducts[i] = window.storeName + "." + window.knownProducts[i];
        }
        xhrAuthRequest("GET", "product-data", function(ok, data) {
          if (!window.productData) window.productData = {};
          for (var i = 0; i < window.knownProducts.length; i++) {
            window.productData[window.knownProducts[i]] = data[window.storeName + "." + window.knownProducts[i]];
          }
        }, "products", fullProducts.join(","));
      })();
    }

    document.addEventListener('keydown', function(ev) {
      var inputType;
      if (ev.target && ev.target.tagName === 'INPUT') {
        inputType = ev.target.type;
      }
      if (inputType === 'text' || inputType === 'number' || inputType === 'email' || inputType === 'password') return;
      var dialog = document.getElementById('keyboardShortcuts');
      if (dialog && dialog.open) {
        dialog.close();
        return;
      }
      var key = ev.key;

      function clickRadio(value) {
        var newTarget = document.querySelector('input[type=radio][value="' + value + '"]');
        if (!newTarget) return;
        if (newTarget.disabled) return;
        newTarget.checked = true;
        newTarget.focus();
        newTarget.blur();
      }

      function clickButton(id) {
        var button = document.querySelector('#' + id);
        if (!button) return;
        button.click();
      }

      if (key === 'j') {
        var oldTarget = document.querySelector('input[type=radio]:checked');
        if (!oldTarget) {
          var input = document.querySelector('#main input');
          if (input) {
            setTimeout(function () { input.focus(); }, 0);
          }
          return;
        }
        var value = Number(oldTarget.value);
        var availableValues = [...oldTarget.form.querySelectorAll('input[type=radio]:not(:disabled)')].map(e => Number(e.value));
        var valueIndex = availableValues.indexOf(value);
        if (value === availableValues.at(-1)) {
          value = availableValues[0];
        } else {
          value = availableValues[valueIndex + 1];
        }
        clickRadio(value);
      } else if (key === 'k') {
        var oldTarget = document.querySelector('input[type=radio]:checked');
        if (!oldTarget) return;
        var value = Number(oldTarget.value);
        var availableValues = [...oldTarget.form.querySelectorAll('input[type=radio]:not(:disabled)')].map(e => Number(e.value));
        var valueIndex = availableValues.indexOf(value);
        if (value == availableValues[0]) {
          value = availableValues.at(-1);
        } else {
          value = availableValues[valueIndex - 1];
        }
        clickRadio(value);
      } else if (!isNaN(key)) {
        if (key === "0") {
          key = 10;
        }
        key--;
        clickRadio(key);
      } else if (key === 'q') {
        clickButton('statsButton');
      } else if (key === 'w') {
        clickButton('menuButton');
      } else if (key === 'Enter') {
        if (ev.target && (ev.target.tagName === "BUTTON" || ev.target.tagName === "A")) {
          if (ev.target.getAttribute("accesskey") === "n") {
            ev.preventDefault();
          } else {
            return;
          }
        }
        if (window.activatingNext) return;
        var checked = document.querySelector('input[type=radio]:checked');
        if (checked) {
          var label = document.querySelector('label[for="' + checked.id + '"]').parentElement;
          if (label) {
            label.scrollIntoView({ block: "nearest", behavior: 'smooth' });
            label.classList.add('selectedKeyboard');
          }
          window.activatingNext = Date.now();
        } else {
          var n;
          if (ev.target && (ev.target.tagName === "BUTTON" || ev.target.tagName === "A")) {
            n = ev.target;
          } else {
            n = document.querySelector('*[accesskey="n"]');
          }
          if (n) {
            n.scrollIntoView({block: "nearest", behavior: 'smooth'});
            n.classList.add('selectedKeyboard');
            window.activatingNext = Date.now();
          }
        }
      } else if (key === '?' || key === '/') {
        if (dialog && dialog.showModal) dialog.showModal();
      }
    }, false);

    document.addEventListener('keyup', function (ev) {
      var now = Date.now();
      var activatingNext = window.activatingNext;
      window.activatingNext = null;
      if (ev.key === 'Enter' && activatingNext && (now - activatingNext > 500)) {
        var n = document.querySelector('.selectedKeyboard');
        if (n && (n.tagName === 'BUTTON' || n.tagName === 'A')) {
          n.click();
        } else {
          n = document.querySelector('*[accesskey="n"]');
          if (n) n.click();
        }
      }
      document.querySelectorAll('.selectedKeyboard').forEach(function (selected) {
        selected.classList.remove('selectedKeyboard');
      })
    });

};

if ( document.addEventListener ) {
  document.addEventListener( "DOMContentLoaded", window.onload, false );
}

try {
  var style = document.createElement('style');
  style.type = 'text/css';
  try {style.innerHTML = 'noscript {display: none;}'; } catch (e) {}
  document.getElementsByTagName('head')[0].appendChild(style);
} catch (e) {}

if (window.isWeb) {
  document.getElementById("dynamic").innerHTML = ".webOnly { display: block; }";
  var checkoutScript = document.createElement("script");
  checkoutScript.async = 1;
  checkoutScript.src="https://checkout.stripe.com/v2/checkout.js";
  document.getElementsByTagName("head")[0].appendChild(checkoutScript);

  var metas = document.getElementsByTagName("meta");
  var facebookAppId, googleAppId;
  var googleLoginCallbackCallback;
  for (var i = 0; i < metas.length; i++) {
    var meta = metas[i];
    if ("fb:app_id" == meta.getAttribute("property")) {
      facebookAppId = meta.getAttribute("content");
    } else if ("google-signin-clientid" == meta.getAttribute("name")) {
      googleAppId = meta.getAttribute("content");
    }
  }

  if (facebookAppId) {
    window.fbAsyncInit = function() {
      FB.init({
        appId      : facebookAppId,
        cookie     : true,  // enable cookies to allow the server to access 
                            // the session
        xfbml      : true,  // parse social plugins on this page
        version    : 'v2.0' // use version 2.0
      });
    };

    (function(d, s, id){
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src ="//connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document,'script','facebook-jssdk'));
  }

  if (googleAppId) (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/client:plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
  
} else if (window.isIosApp) {
  document.getElementById("dynamic").innerHTML =
  "#text .gameTitle { display: block; }"+
  ""+
  "#header { display: none; }"+
  ""+
  "body { transition-duration: 0; }"+
  ""+
  "#emailUs { display: none; }"+
  ""+
  "#main { padding-top: 1em; }";
  // Use UIWebView width, not screen width, on iPad
  document.querySelector("meta[name=viewport]").setAttribute("content", "width="+window.innerWidth);
  window.addEventListener("resize", function() {
      document.querySelector("meta[name=viewport]").setAttribute("content", "width="+window.innerWidth);
      // this dummy element seems to be required to get the viewport to stick
      var dummy = document.createElement("p");
      dummy.innerHTML = "&nbsp;";
      document.body.appendChild(dummy);
      window.setTimeout(function() {document.body.removeChild(dummy);}, 10);
    }, false);
  callIos("checkdiscounts");
  // in a timeout because iOS may try to add to the head before mygame.js has run
  (function(){
    var requester = function() {
      if (window.stats) {
        callIos("requestscenes");
      } else {
        safeTimeout(requester, 1);
      }
    }
    if (window.isFile) safeTimeout(requester, 0);
  })();
} else if (window.isAndroidApp) {
  document.getElementById("dynamic").innerHTML =
  "#text .gameTitle { display: block; }" +
  "" +
  "#header { display: none; }"+
  ""+
  "#emailUs { display: none; }"+
  ""+
  "#main { padding-top: 1em; }";
} else if (window.isMacApp || window.isWinOldApp || window.isCef || window.isNode || window.isSteamApp) {
  document.getElementById("dynamic").innerHTML =
    "#header .gameTitle { display: none; }" +
    "" +
    "#text .gameTitle { display: block; }" +
    "" +
    "#headerLinks { display: none; }"+
    ""+
    "#emailUs { display: none; }";
}
// on touch devices, this hover state never goes away
if (!('ontouchstart' in window)) {
  document.getElementById("dynamic").innerHTML += ".choice > div:hover {background-color: #E4DED8;}\n" +
    "body.nightmode .choice > div:hover {background-color: #555;}\n"+
    "body.whitemode .choice > div:hover {background-color: #ddd;}\n";
}
function fixChromeLinks() {
  var aboutLink = document.getElementById("aboutLink");
  aboutLink.addEventListener("click", function() {
    if (chrome.app.window) {
      event.preventDefault();
      chrome.app.window.create("credits.html", {}, function(w) {
        w.contentWindow.addEventListener( "DOMContentLoaded", function() {
          var win = this;
          var back = win.document.getElementById("back");
          back.addEventListener("click", function(event) {
            event.preventDefault();
            win.close();
          }, false);
          var base = win.document.createElement('base');
          base.setAttribute("target", "_blank");
          win.document.head.appendChild(base);
          win.document.documentElement.style.overflowY = "scroll";
        }, false);
      });
    }
  }, false);

  var statsButton = document.getElementById("statsButton");
  if (statsButton) {
    statsButton.onclick = undefined;
    statsButton.addEventListener("click", function() {
      showStats();
    }, false);
  }

  var achievementsButton = document.getElementById("achievementsButton");
  if (achievementsButton) {
    achievementsButton.onclick = undefined;
    achievementsButton.addEventListener("click", function() {
      showAchievements();
    }, false);
  }

  var restartButton = document.getElementById("restartButton");
  restartButton.onclick = undefined;
  restartButton.addEventListener("click", function() {
    restartGame("prompt");
  }, false);

  var subscribeAnchor = document.getElementById("subscribeLink");
  subscribeAnchor.onclick = undefined;
  subscribeAnchor.addEventListener("click", function() {
    subscribeLink();
  }, false);

  var supportAnchor = document.getElementById("supportEmail");
  supportAnchor.addEventListener("click", function(event) {
    event.preventDefault();
  }, false);

  var menuButton = document.getElementById("menuButton");
  menuButton.onclick = undefined;
  menuButton.addEventListener("click", function() {
    textOptionsMenu();
  }, false);
}
if (window.isChromeApp) {
  var base = document.createElement('base');
  base.setAttribute("target", "_blank");
  document.head.appendChild(base);

  document.addEventListener("DOMContentLoaded", fixChromeLinks);
  setInterval(function() {
    document.body.style.height = document.querySelector(".container").offsetHeight + "px";
  }, 100);
}
if (window.isCef) {
  var pollPurchases = function() {
    cefQuery({
      request:"PollPurchases",
      onSuccess:function(response){
        //console.log("PollPurchases: '"+response+"'");
        if (response) {
          clearScreen(loadAndRestoreGame);
        }
        safeTimeout(pollPurchases, 100);
      },
      onFailure:function(error_code, error_message) {
        console.error("PollPurchases error: " + error_message);
      }
    });
  };
  pollPurchases();
} else if (window.isSteamworks) {
	(function() {
		var steamworksApps = require('../package.json').products;
		if (typeof steamworksApps === "undefined") throw new Error("package.json missing products");
		var steamworksAppId = window.isTrial ? steamworksApps.steam_demo : steamworksApps.adfree;
    if (steamworksApi.restartAppIfNecessary(steamworksAppId)) {
      require('electron').ipcRenderer.invoke('quit');
      return;
    }
    try {
      window.steamworks = steamworksApi.init(steamworksAppId);
    } catch (e) {
      alert("There was an error connecting to Steam. Steam must be running" +
        " to play this game. If you launched this game using Steam, try restarting Steam" +
        " or rebooting your computer. If that doesn't work, try completely uninstalling" +
        " Steam and downloading a fresh copy from steampowered.com.\n\nIf none of that works, please contact" +
        " support@choiceofgames.com and we'll try to help. (Mention error code 77779.)")
      require('electron').ipcRenderer.invoke('quit');
      return;
    }
    var adfreePurchased;
    try {
      adfreePurchased = steamworks.apps.isSubscribedApp(steamworksApps.adfree);
    } catch (e) {
      alert("There was an error connecting to Steam. Steam must be running" +
        " to play this game. If you launched this game using Steam, try restarting Steam" +
        " or rebooting your computer. If that doesn't work, try completely uninstalling" +
        " Steam and downloading a fresh copy from steampowered.com.\n\nIf none of that works, please contact" +
        " support@choiceofgames.com and we'll try to help. (Mention error code 77776.)")
      require('electron').ipcRenderer.invoke('quit');
      return;
    }
		if (window.isTrial && adfreePurchased) {
			alert("This is the demo version of the game, " +
				"but you now own the full version. The demo will now exit. Your progress has been saved." +
				" Please launch the full version of the game using Steam.");
			require('electron').ipcRenderer.invoke('quit');
    } else if (!window.isTrial && !adfreePurchased) {
      alert("There was an error connecting to Steam. Steam must be running" +
        " to play this game. If you launched this game using Steam, try restarting Steam" +
        " or rebooting your computer. If that doesn't work, try completely uninstalling" +
        " Steam and downloading a fresh copy from steampowered.com.\n\nIf none of that works, please contact" +
        " support@choiceofgames.com and we'll try to help. (Mention error code 77778.)")
      require('electron').ipcRenderer.invoke('quit');
      return;
    }
    window.isSteamDeck = !!(steamworks.utils.isSteamRunningOnSteamDeck && steamworks.utils.isSteamRunningOnSteamDeck());
		if (window.isSteamDeck) {
      window.addEventListener("DOMContentLoaded", function() {
        window.document.body.addEventListener('click', function (event) {
          if (event.target && event.target.tagName === 'A' && event.target.href !== '#') {
            event.preventDefault();
            var href = event.target.href;
            var intercepts = require('../package.json').intercepts;
            for (var intercept in intercepts) {
              if (href.startsWith(intercept)) {
                var StoreFlagNone = 0;
                console.log('activating to store');
                steamworks.overlay.activateToStore(intercepts[intercept], StoreFlagNone);
                console.log('activated');
                return;
              }
            }
            console.log('activating to web');
            steamworks.overlay.activateToWebPage(href);
            console.log('activated');
          }
        });
      })
    }
    var pollPurchases = function(oldCount) {
			var count = 0;
			for (var product in steamworksApps) {
				if (steamworks.apps.isSubscribedApp(steamworksApps[product])) {
					count++;
				}
			}
			if (count != oldCount && typeof oldCount !== "undefined") clearScreen(loadAndRestoreGame);
			safeTimeout(function() {pollPurchases(count)}, 100);
		};
		pollPurchases();

    var appIds = [];
    for (var product in steamworksApps) {
      appIds.push(steamworksApps[product]);
    }

    xhrAuthRequest("GET", "steam-price", function(ok, data) {
      if (!window.productData) window.productData = {};
      for (var product in steamworksApps) {
        window.productData[product] = data[steamworksApps[product]];
      }
      if (window.awaitSteamProductData) window.awaitSteamProductData();
    }, "user_id", steamworks.localplayer.getSteamId().steamId64, "app_ids", appIds.join(","));
	})();
}

function winStoreShareLinkHandler(e) {
    var request = e.request;
    var canonical = document.querySelector("link[rel=canonical]");
    var canonicalHref = canonical && canonical.getAttribute("href");
    if (!/^https?:/.test(canonicalHref)) {
        canonicalHref = "https://www.choiceofgames.com" + canonicalHref;
    }
    if (!/\/$/.test(canonicalHref)) {
        canonicalHref += "/";
    }
    canonicalHref += "redirect.php?src=winshare";
    request.data.properties.title = document.title;
    request.data.properties.description = document.querySelector("meta[name=description]").getAttribute("content");
    request.data.setUri(new Windows.Foundation.Uri(canonicalHref));
}

if (window.isWinStoreApp) {
    var dataTransferManager = Windows.ApplicationModel.DataTransfer.DataTransferManager.getForCurrentView();
    dataTransferManager.addEventListener("datarequested", winStoreShareLinkHandler);

    baseScript = document.createElement("script");
    baseScript.src = "//Microsoft.WinJS.1.0/js/base.js";
    baseScript.onload = function () {
        WinJS.Application.onsettings = function (e) {
            var privacyCmd = new Windows.UI.ApplicationSettings.SettingsCommand("privacy", "Privacy Policy", function () {
                window.open("https://www.choiceofgames.com/privacy-policy");
            });
            e.detail.e.request.applicationCommands.append(privacyCmd);
        };
        WinJS.Application.start();
    };
    document.head.appendChild(baseScript);

    uiScript = document.createElement("script");
    uiScript.src = "//Microsoft.WinJS.1.0/js/ui.js";
    document.head.appendChild(uiScript);
} else if (window.isWinOldApp) {
    console = {
        log: function (message) { window.external.ConsoleLog(message); },
        error: function (message) { window.external.ConsoleError(message); }
    };
    document.oncontextmenu = function() {return false;};
}

function platformCode() {
  var platform = "unknown";
  if (window.isIosApp) platform = "ios";
  else if (window.isAndroidApp) platform = "android";
  else if (window.isMacApp) platform = "mac";
  else if (window.isWinStoreApp) platform = "windows";
  else if (window.isWinOldApp) platform = "csharp";
  else if (window.isChromeApp) platform = "chrome";
  else if (window.isWebOS) platform = "palm";
  else if (window.isSteamApp) platform = "steam";
  else if (window.isCef) platform = "cef";
  else if (window.isNode) platform = "dl";
  else if (window.isWeb) platform = "web";
  if (window.isOmnibusApp) platform = "omnibus-" + platform;
  return platform;
}

function reinjectNavigator() {
  if (window.stats && window.stats.scene && window.stats.scene.nav) {
    var scene = window.stats.scene;
    scene.nav = window.nav;
    nav.repairStats(scene.stats);
  }
}

;
/*
 * Copyright 2010 by Dan Fabulich.
 *
 * Dan Fabulich licenses this file to you under the
 * ChoiceScript License, Version 1.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *  http://www.choiceofgames.com/LICENSE-1.0.txt
 *
 * See the License for the specific language governing
 * permissions and limitations under the License.
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied.
 */
function Scene(name, stats, nav, options) {
    if (!name) name = "";
    if (!stats) stats = {};
    // the name of the scene
    this.name = name;

    // the permanent statistics and the temporary values
    this.stats = stats;
    // implicit_control_flow controls whether goto is necessary to leave options (true means no)
    // _choiceEnds stores the line numbers to jump to when choice #options end.
    this.temps = {choice_reuse:"allow", choice_user_restored:false, _choiceEnds:{}, _looplimit: 1000};

    // the navigator determines which scene comes next
    this.nav = nav;

    options = options || {};

    // should we print debugging information?
    this.debugMode = options.debugMode || false;

    // used for stats screen, and maybe other secondary views someday
    this.secondaryMode = options.secondaryMode;

    this.saveSlot = options.saveSlot || "";

    // the array of lines in the scene file
    this.lines = [];

    // the current line number (WARNING 0-based!)
    this.lineNum = 0;
    this.rollbackLineCoverage();

    // when this is true, the main printLoop will halt
    this.finished = false;

    // map of label names to line numbers
    this.labels = {};

    // the current amount of indentation
    this.indent = 0;

    // Did the previous line contain text?
    this.prevLine = "empty";

    // Have we ever printed any text?
    this.screenEmpty = true;

    // Have we run any commands (except for create and scene_list) yet?
    this.initialCommands = true;

    this.stats.sceneName = name;

    // for easy reachability from the window
    this.stats.scene = this;

    // where should we print text?
    this.target = null;

    this.accumulatedParagraph = [];
}

Scene.prototype.reexecute = function reexecute() {
  this.lineNum = this.stats.testEntryPoint || 0;
  this.finished = 0;
  this.indent = this.getIndent(this.lines[this.lineNum]);
  this.prevLine = "empty";
  this.screenEmpty = true;
  this.execute();
};

// the main loop of the scene
Scene.prototype.printLoop = function printLoop() {
    var line;
    for (;!this.finished && this.lineNum < this.lines.length; this.lineNum++) {
        line = this.lines[this.lineNum];
        if (!trim(line)) {
            this.paragraph();
            continue;
        }
        var indent = this.getIndent(line);
        if (indent > this.indent) {
            // ignore indentation level of *comments
            if (/\s*\*comment\b/.test(line)) continue;
            throw new Error(this.lineMsg() + "increasing indent not allowed, expected " + this.indent + " was " + indent);
        } else if (indent < this.indent) {
            this.dedent(indent);
        }
        // Ability to end a choice #option without goto is guarded by implicit_control_flow variable
        if (this.temps._choiceEnds[this.lineNum] &&
                (this.getVar("implicit_control_flow") || this.temps._fakeChoiceDepth > 0)) {
            // Skip to the end of the choice if we hit the end of an #option
            this.rollbackLineCoverage();
            this.lineNum = this.temps._choiceEnds[this.lineNum];
            this.rollbackLineCoverage();
            if (this.temps._fakeChoiceDepth > 0) {
                this.temps._fakeChoiceDepth--;
            }
            continue;
        }
        this.indent = indent;
        if (/^\s*#/.test(line)) {
            throw new Error(this.lineMsg() + "It is illegal to fall out of a *choice statement; you must *goto or *finish before the end of the indented block.");
        }
        if (!this.runCommand(line)) {
            this.prevLine = "text";
            this.screenEmpty = false;
            this.initialCommands = false;
            this.printLine(line);
        }
    }
    this.rollbackLineCoverage();
    if (!this.finished) {
        this.autofinish();
    }
    this.save("temp");
    if (this.skipFooter) {
        this.skipFooter = false;
    } else {
        printFooter();
    }
};

Scene.prototype.dedent = function dedent(newDent) {};

Scene.prototype.printLine = function printLine(line) {
    if (!line) return null;
    this.screenEmpty = false;
    line = this.replaceVariables(line.replace(/^\s*/, ""));
    this.accumulatedParagraph.push(line);
    // insert extra space unless the line ends with hyphen or dash
    if (!/([-\u2011-\u2014]|\[c\/\])$/.test(line)) this.accumulatedParagraph.push(' ');
};

Scene.prototype.replaceVariables = function (line) {
  line = String(line);
  var replacer = /([$@](\!?\!?)\{)/;
  var index = 0;
  var output = [];
  for (var result = replacer.exec(line); result; result = replacer.exec(line.substring(index))) {
    output.push(line.substring(index, index + result.index));
    var curlies = 0;
    var closingCurly = -1;
    var exprStart = index + result.index + result[1].length;
    for (var i = exprStart; i < line.length; i++) {
      var c = line.charAt(i);
      if (c === "{") {
        curlies++;
      } else if (c === "}") {
        if (curlies) {
          curlies--;
        } else {
          closingCurly = i;
          break;
        }
      }
    }
    if (closingCurly == -1) {
      throw new Error(this.lineMsg() + "invalid "+result[0]+"} variable substitution at letter " + (index + result.index + 1));
    }
    var body = line.substring(exprStart, closingCurly);
    var stack, value;
    if (result[0].charAt(0) === "$") {
      stack = this.tokenizeExpr(body);
      value = this.evaluateExpr(stack);
    } else {
      var expr;
      var options;
      if (/^\s*\(/.test(body)) {
        var parens = 0;
        var closingParen = -1;
        for (var i = 1; i < body.length; i++) {
          var c = body.charAt(i);
          if (c === "(") {
            parens++;
          } else if (c === ")") {
            if (parens) {
              parens--;
            } else {
              closingParen = i;
              break;
            }
          }
        }
        if (closingParen == -1) {
          throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; missing closing parenthesis )");
        }
        if (body.charAt(closingParen+1) != " ") {
          throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; there should be a space after the closing parenthesis )");
        }
        expr = body.substring(1, closingParen);
        options = body.substring(closingParen+2).split("|");
      } else {
        if (!/^\S+ /.test(body)) {
          throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; there should be a space after the first word");
        }
        var spaceIndex = body.indexOf(' ');
        expr = body.substring(0, spaceIndex);
        options = body.substring(spaceIndex+1).split("|");
      }
      if (options.length < 2) {
        throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; there should be at least one pipe | to separate options");
      }
      stack = this.tokenizeExpr(expr);
      value = this.evaluateExpr(stack);
      if (typeof value === "boolean" || /^(true|false)$/i.test(value)) {
        value = bool(value) ? 1 : 2;
      }
      value = num(value, this.lineNum+1, this.name);
      if ((value | 0) !== value) {
        throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; '"+expr+"' is equal to " + value + " which is not a whole integer number");
      } else if (value < 1) {
        throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; '"+expr+"' is equal to " + value + " which is not a positive number");
      } else if (value > options.length) {
        throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; '"+expr+"' is equal to " + value + " but there are only " + options.length + " options");
      }
      value = options[value-1];
      value = this.replaceVariables(value);
    }
    var capitalize = result[2];
    if (capitalize) value = String(value);
    if (capitalize == "!") {
      value = value.charAt(0).toUpperCase() + value.slice(1);
    } else if (capitalize == "!!") {
      value = value.toUpperCase();
    }
    if (typeof highlightGenderPronouns != "undefined" && highlightGenderPronouns && /\b(he|him|his|she|her|hers)\b/gi.test(value)) {
      // this zero-width space will give us a hint for highlighting
      output.push("\u200b");
    }
    output.push(value);
    index = closingCurly+1;
  }
  if (index === 0) return line;
  output.push(line.substring(index));
  return output.join("");
};

Scene.prototype.paragraph = function paragraph() {
    printParagraph(this.accumulatedParagraph.join(""));
    this.accumulatedParagraph = [];
    this.prevLine = "empty";
};

Scene.prototype.loadSceneFast = function loadSceneFast(url) {
    if (this.loading) return;
    this.loading = true;
    var result;
    var self = this;
    if (typeof cachedResults != "undefined" && cachedResults && cachedResults[this.name]) {
      result = window.cachedResults[this.name];
      return safeTimeout(function() {self.loadLinesFast(result.crc, result.lines, result.labels);}, 0);
    } else if (typeof allScenes != "undefined") {
      result = allScenes[this.name];
      if (!result) throw new Error("Couldn't load scene '" + this.name + "'\nThe file doesn't exist.");
      return safeTimeout(function() {self.loadLinesFast(result.crc, result.lines, result.labels);}, 0);
    } else if (typeof window != "undefined" && window.isIosApp && window.isFile && !window.isOmnibusApp) {
      startLoading();
      var startedWaiting = new Date().getTime();

      function retryScenes(event, command) {
        if (!command) command = "retryscenes";
        clearScreen(function() {
          startLoading();
          if (command == "retryscenes") curl();
          window.downloadState = null;
          callIos(command);
          startedWaiting = new Date().getTime();
          awaitAllScenes();
        });
      }

      function awaitAllScenes() {
        if (typeof allScenes != "undefined") {
          result = allScenes[self.name];
          if (!result) throw new Error("Couldn't load scene '" + self.name + "'\nThe file doesn't exist.");
          self.loadLinesFast(result.crc, result.lines, result.labels);
        } else if (window.downloadState == "failed" || (new Date().getTime() - startedWaiting) > 5000) {
          doneLoading();
          if (window.downloadRequired) {
            self.printLine("We weren't able to download the latest version of the game.");
            self.paragraph();
            printButton("Try Again", main, false, retryScenes);
          } else {
            self.printLine("We weren't able to download the latest version of the game. Please try downloading again. The latest version may contain important fixes.");
            self.paragraph();
            var retry = {name: "Try downloading again."};
            var ignore = {name: "Continue playing without the latest version."}
            printOptions([""], [retry, ignore], function(option) {
              if (option == retry) {
                retryScenes();
              } else {
                retryScenes(null, "requestscenesforce");
              }
            });
          }
        } else {
          setTimeout(awaitAllScenes, 0);
        }
      }
      return awaitAllScenes();
    } else if (window.purchases[self.name] && isStoreSceneCacheRequired()) {
      var sceneName = this.name.replace(/ /g, "_");
      return window.store.get("cache_scene_hash_"+sceneName, function(ok, hash) {
        function keepScene(result) {
          if (!window.cachedResults) window.cachedResults = {};
          cachedResults[self.name] = result;
          self.loadLinesFast(result.crc, result.lines, result.labels);
        }
        function loadPaidScene() {
          startLoading();
          updateSinglePaidSceneCache(self.name, function(err, result) {
            doneLoading();
            if (err) {
              if (err === "not registered") {
                logout();
                loginDiv();
                return clearScreen(function() {
                  loginForm(main, 0/*optional*/,
                    "Please sign in to access this part of the game.", function() {
                      clearScreen(loadAndRestoreGame);
                    });
                });
              } else if (err === "not purchased") {
                window.rerestore = function () {
                  restorePurchases(window.purchases[self.name], function (purchased) {
                    window.location.reload(); 
                  });
                };
                main.innerHTML = "<div id='text'><p>Our apologies; we were unable to access your purchase while loading game data. (Error 403x)" +
                  "  Please restore purchases now; if that doesn't work, please email " + getSupportEmail() + " with details, including the error number 403x.</p>" +
                  " <p><button class='next' onclick='window.rerestore();'>Restore Now</button></p></div>";
                curl();
                return;
              } else if (/^409-/.test(err)) {
                main.innerHTML = "<div id='text'><p>There was a " + err + " error while loading game data." +
                  "  This error occurs when you've logged into this app with a different choiceofgames.com account from the account you originally used to buy the game." +
                  "  You can resolve this error by going to Settings, signing out, and signing in as the account that originally purchased the game." +
                  "  If you need additional assistance, you can email us at " + getSupportEmail() + " and mention error code " + err + ".</p>"
                curl();
                return;
              }
              main.innerHTML = "<div id='text'><p>Our apologies; there was a " + err + " error while loading game data."+
              "  Please refresh now; if that doesn't work, please click the Restart button and email "+getSupportEmail()+" with details, including the error number.</p>"+
              " <p><button class='next' onclick='window.location.reload();'>Refresh Now</button></p></div>";
              curl();
            } else {
              keepScene(result);
            }
          })
        }
        if (ok && hash == hashes.scenes[sceneName + ".txt.json"]) {
          window.store.get("cache_scene_"+sceneName, function(ok, text) {
            if (ok && text) {
              var parsed;
              try {
                parsed = jsonParse(text);
              } catch (e) {
                if (window.console) console.error(e, e.stack);
              }
              if (parsed && parsed.crc && parsed.lines && parsed.labels) return keepScene(parsed);
              loadPaidScene();
            } else {
              loadPaidScene();
            }
          })
        } else {
          loadPaidScene();
        }
      });
    }
    startLoading();
    if (!url) {
        var fileName = this.name.replace(/ /g, "_") + ".txt.json";
        url = Scene.baseUrl + "/" + fileName;
        if (window.location.protocol == "https:" && window.hashes && window.hashes.scenes[fileName]) {
          url += "?hash="+hashes.scenes[fileName];
        }
    }
    var xhr = findXhr();
    xhr.open("GET", url, true);
    var self = this;
    var done = false;
    xhr.onreadystatechange = function() {
        if (done) return;
        if (xhr.readyState != 4) return;
        if (xhr.status == 403) {
          try {
            var err = JSON.parse(xhr.responseText);
            if (err.error == "not registered") {
              return isRegistered(function(registered) {
                if (registered) {
                  logout();
                  loginDiv();
                }
                return clearScreen(function() {
                  loginForm(main, 0/*optional*/,
                    "Please sign in to access this part of the game.", function() {
                      clearScreen(loadAndRestoreGame);
                    });
                });
              });
            }
          } catch (e) {} // JSON parse failure? must not be a login prompt
        }
        done = true;

        var result;
        try {
          result = jsonParse(xhr.responseText);
        } catch (e) {
          if (window.console) console.error(e, e.stack);
        }
        if (window.isWeb && (xhr.status != 200 || !result)) {
          doneLoading();
          var status = xhr.status;
          if (status == 200 || !status) status = "network";
          main.innerHTML = "<div id='text'><p>Our apologies; there was a " + status + " error while loading game data."+
          "  Please refresh your browser now; if that doesn't work, please click the Restart button and email "+getSupportEmail()+" with details.</p>"+
          " <p><button onclick='window.location.reload();'>Refresh Now</button></p></div>";
          curl();
          return;
        } else if (xhr.responseText === "") {
          throw new Error("Couldn't load " + url + "\nThe file is probably missing or empty.");
        }

        if (!window.cachedResults) window.cachedResults = {};
        cachedResults[self.name] = result;
        self.loadLinesFast(result.crc, result.lines, result.labels);
    };
    if (isIE) {
      // IE8 swallows errors in onreadystatechange if xhr.send is in a try block
      xhr.send(null);
    } else {
      try {
        xhr.send(null);
      } catch (e) {
        if (window.location.protocol == "file:" && !window.isMobile) {
          if (/Chrome/.test(navigator.userAgent)) {
            window.reportError("We're sorry, Google Chrome has blocked ChoiceScript from functioning.  (\"file:\" URLs cannot "+
            "load files in Chrome.)  ChoiceScript works just fine in Chrome, but only on a published website like "+
            "choiceofgames.com.  For the time being, please try another browser like Mozilla Firefox.");
            return;
          }
        }
        window.reportError("Couldn't load URL: " + url + "\n" + e);
      }
    }
};

Scene.prototype.loadLinesFast = function loadLinesFast(crc, lines, labels) {
  this.crc = crc;
  this.lines = lines;
  this.labels = labels;
  this.loading = false;
  this.loaded = true;
  var self = this;
  if (this.executing) {
    safeCall(this, function() {
      doneLoading();
      self.execute();
    });
  }
};

// load the scene file from the specified URL (or from default URL by name)
Scene.prototype.loadScene = function loadScene() {
    if (this.loading) return;
    this.loading = true;
    if (window.isFile) return this.loadFile();
    startLoading();
    var url = Scene.baseUrl + "/" + this.name + ".txt";
    var xhr = findXhr();
    xhr.open("GET", url, true);
    var self = this;
    var done = false;
    xhr.onreadystatechange = function() {
        if (done) return;
        if (xhr.readyState != 4) return;
        done = true;
        if (xhr.status == 403) {
          try {
            var err = JSON.parse(xhr.responseText);
            if (err.error == "not registered") {
              return isRegistered(function(registered) {
                if (registered) {
                  logout();
                  loginDiv();
                }
                return clearScreen(function() {
                  loginForm(main, 0/*optional*/,
                    "Please sign in to access this part of the game.", function() {
                      clearScreen(loadAndRestoreGame);
                    });
                });
              });
            }
          } catch (e) {} // JSON parse failure? must not be a login prompt
        }
        if (window.isWeb && xhr.status != 200) {
            var status = xhr.status || "network";
            main.innerHTML = "<p>Our apologies; there was a " + status + " error while loading game data."+
            "  Please refresh your browser now; if that doesn't work, please email "+getSupportEmail()+" with details.</p>"+
            " <p><button onclick='window.location.reload();'>Refresh Now</button></p>";
            return;
        } else if (xhr.responseText === "") {
          if (window.location.protocol == "file:" && !window.isMobile && /Chrome/.test(navigator.userAgent)) {
            window.reportError("We're sorry, Google Chrome has blocked ChoiceScript from functioning.  (\"file:\" URLs cannot "+
            "load files in Chrome.)  ChoiceScript works just fine in Chrome, but only on a published website like "+
            "choiceofgames.com.  For the time being, please try another browser like Mozilla Firefox.");
            return;
          } else {
            window.reportError("Couldn't load " + url + "\nThe file is probably missing or empty.");
            return;
          }
        }
        var result = xhr.responseText;
        scene = result;
        scene = scene.replace(/\r/g, "");
        this.loading = false;
        self.loadLines(scene);
        if (self.executing) {
            safeCall(self, function () {
              doneLoading();
              self.execute();
            });
        }
    };
    if (isIE) {
      // IE8 swallows errors in onreadystatechange if xhr.send is in a try block
      xhr.send(null);
    } else {
      try {
        xhr.send(null);
      } catch (e) {
        if (window.location.protocol == "file:" && !window.isMobile) {
          if (/Chrome/.test(navigator.userAgent)) {
            window.reportError("We're sorry, Google Chrome has blocked ChoiceScript from functioning.  (\"file:\" URLs cannot "+
            "load files in Chrome.)  ChoiceScript works just fine in Chrome, but only on a published website like "+
            "choiceofgames.com.  For the time being, please try another browser like Mozilla Firefox.");
            return;
          } else if (e.code === 1012 /*NS_ERROR_DOM_BAD_URI*/) {
            window.reportError("Couldn't load scene file: " + url + "\nThe file is probably missing.");
            return;
          }
        }
        window.reportError("Couldn't load URL: " + url + "\n" + e);
      }
    }
};

Scene.prototype.loadFile = function loadFile() {
  var _this = this;
  if (typeof uploadedFiles !== "object") {
    clearScreen(function() {
      var header = document.getElementById('header');
      if (header) header.style.display = "none";
      var makeYourOwnGames = document.getElementById('makeyourowngames');
      if (makeYourOwnGames) makeYourOwnGames.style.display = "none";
      _this.printLine("[b]Please \"Upload\" ChoiceScript[/b]");
      _this.paragraph();
      _this.printLine("To begin, you'll need to grant permission to \"upload\" your choicescript folder containing index.html.")
      _this.paragraph();
      _this.printLine("Use the button below to select your choicescript folder.");
      _this.paragraph();
      var text = document.getElementById('text');
      var input = document.createElement('input');
      input.type = 'file';
      input.webkitdirectory = true;
      input.multiple = true;
      input.addEventListener('change', function searchForStartup(e) {
        var numFiles = input.files.length;
        var startupCandidates = [];
        for (var i = 0; i < numFiles; i++) {
          var file = input.files[i];
          if (file.name === "startup.txt") {
            startupCandidates.push(file);
          }
        }
        if (!startupCandidates.length) {
          return clearScreen(function() {
            _this.printLine("We couldn't find startup.txt in the folder you chose. Please try again.")
            _this.paragraph();
            document.getElementById('text').appendChild(input);
            curl();
          });
        }

        if (startupCandidates.length > 1) {
          return clearScreen(function() {
            _this.printLine("There were multiple files called startup.txt in the folder you chose. Please try again.");
            _this.paragraph();
            for (var i = 0; i < startupCandidates.length; i++) {
              _this.printLine("\u2022 " + startupCandidates[i].webkitRelativePath);
            }
            _this.paragraph();
            document.getElementById('text').appendChild(input);
            curl();
          });
        }

        var startup = startupCandidates[0];
        var rootDirTest = new RegExp("^" + startup.webkitRelativePath.replace(/\/startup.txt$/, "/[^/]+$"));
        var sceneFiles = {};
        for (var i = 0; i < numFiles; i++) {
          var file = input.files[i];
          if (rootDirTest.test(file.webkitRelativePath)) {
            sceneFiles[file.name] = file;
          }
        }
        window.uploadedFiles = sceneFiles;
        if (header) header.style.display = "";
        if (makeYourOwnGames) makeYourOwnGames.style.display = "";
        clearScreen(function() {
          _this.loadFile();
        });
      });
      text.appendChild(input);
      _this.paragraph();
      _this.printLine("(We're not actually going to transfer your code over the Internet, " +
        "but this web page needs permission to upload your choicescript folder in order to access " +
        "your code and run it. The power to access your code would also grant us the power to " +
        "transfer your code elsewhere, but we're not going to do that. JavaScript programmers " +
        "can read our JavaScript to verify that this is true.)");
      _this.paragraph();
      curl();
    });
  } else {
    var fileName = this.name + ".txt";
    if (uploadedFiles[fileName]) {
      startLoading();
      new Response(uploadedFiles[fileName]).text().then(function(result) {
        scene = result;
        scene = scene.replace(/\r/g, "");
        _this.loading = false;
        safeCall(_this, function() {
          _this.loadLines(scene);
          doneLoading();
          _this.execute();
        });
      });
    } else {
      for (var otherFileName in uploadedFiles) {
        if (fileName.toLowerCase() === otherFileName.toLowerCase()) {
          main.innerHTML = "<p>Couldn't find "+fileName+" in the uploaded folder, but we did find "+otherFileName+". Scene file names must match exactly, including capitalization.</p>"+
          " <p><button onclick='window.location.reload();'>Refresh Now</button></p>";
          curl();
          return;
        }
      }
      main.innerHTML = "<p>Couldn't find "+fileName+" in the uploaded folder.</p>"+
        " <p><button onclick='window.location.reload();'>Refresh Now</button></p>";
      curl();
    }
  }
}

Scene.prototype.checkSum = function checkSum() {
  if (this.temps.choice_crc) {
    if (!this.randomtest && !this.quicktest && this.temps.choice_crc != this.crc && this.lineNum) {
      // The scene has changed; restart the scene from backup
      if (typeof alertify !== 'undefined') {
        if (!initStore()) {
          alertify.log(this.name + ".txt has updated. Restarting chapter.");
        } else {
          alertify.log("The game has updated. Restarting chapter.");
        }
      }
      var self = this;
      safeTimeout(function () {
        clearScreen(function () {
          loadAndRestoreGame("backup");
        });
      }, 0);
      return false;
    }
  }
  this.temps.choice_crc = this.crc;
  return true;
};

Scene.prototype.loadLines = function loadLines(str) {
    this.crc = crc32(str);
    this.lines = str.split(/\r?\n/);
    this.parseLabels();
    this.loaded = true;
};

// launch the vignette as soon as it's available
Scene.prototype.execute = function execute() {
    if (!this.loaded) {
        this.executing = true;
        if (Scene.generatedFast || (typeof generatedFast != "undefined" && generatedFast) || typeof allScenes != 'undefined') {
          this.loadSceneFast();
        } else {
          this.loadScene();
        }
        return;
    }
    if (!this.checkSum()) {
      return;
    }
    if (this.nav) this.nav.repairStats(stats);
    if (!this.temps._choiceEnds) this.temps._choiceEnds = {};
    doneLoading();
    if (typeof this.targetLabel != "undefined") {
      var label = this.targetLabel.label.toLowerCase();
      if (typeof(this.labels[label]) != "undefined") {
          this.lineNum = this.labels[label];
          this.indent = this.getIndent(this.lines[this.lineNum]);
          delete this.targetLabel;
      } else {
          throw new Error(this.targetLabel.origin + " line " + (this.targetLabel.originLine+1) + ": "+this.name+" doesn't contain label " + label);
      }
    }
    // this backup slot will only be used when the scene crc changes during upgrades
    if (!this.lineNum) {
      var subsceneStack = this.stats.choice_subscene_stack || [];
      if (!subsceneStack.length) this.save("backup");
    }
    if (this.redirectingFromStats) {
      this.save("");
      delete this.redirectingFromStats;
    }
    this.printLoop();
};

// loop through the file looking for *label commands
Scene.prototype.parseLabels = function parseLabels() {
    var lineLength = this.lines.length;
    var oldLineNum = this.lineNum;
    var screenshots = ("choicescript_screenshots" == this.name);
    var seenChoiceWithoutSet = 0;
    for (this.lineNum = 0; this.lineNum < lineLength; this.lineNum++) {
        this.rollbackLineCoverage();
        var line = this.lines[this.lineNum];
        // strip byte order mark
        if (this.lineNum == 0 && line.charCodeAt(0) == 65279) lines[0] = line.substring(1);
        var invalidCharacter = line.match(/^(.*)\ufffd/);
        if (invalidCharacter) throw new Error(this.lineMsg() + "invalid character. (ChoiceScript text should be saved in the UTF-8 encoding.) " + invalidCharacter[0]);
        var result = /^(\s*)\*(\w+)(.*)/.exec(line);
        if (!result) continue;
        var indentation = result[1];
        var indent = indentation.length;
        var command = result[2].toLowerCase();
        var data = trim(result[3]);
        if ("label" == command) {
            data = data.toLowerCase();
            if (/\s/.test(data)) throw new Error(this.lineMsg() + "label '"+data+"' is not allowed to contain spaces");
            if (this.labels.hasOwnProperty(data)) {
              throw new Error(this.lineMsg() + "label '"+data+"' already defined on line " + (this.labels[data]*1+1));
            }
            this.labels[data] = this.lineNum;
        } else if (screenshots) {
          if ("fake_choice" == command) {
            if (seenChoiceWithoutSet) throw new Error(this.lineMsg() +
              "In choicescript_screenshots, you need to *set at least one variable between *fake_choice commands, so the stat screen looks interesting. " +
              "There was no *set since the last *fake_choice on line " + seenChoiceWithoutSet + ".");
            seenChoiceWithoutSet = this.lineNum+1;
          } else if ("set" == command) {
            seenChoiceWithoutSet = 0;
          }
        }
    }
    this.rollbackLineCoverage();
    this.lineNum = oldLineNum;
};

// if this is a command line, run it
Scene.prototype.runCommand = function runCommand(line) {
    var result = /^\s*\*(\w+)(.*)/.exec(line);
    if (!result) {
      if (this.secondaryMode == "startup" && this.startupCallback) {
        this.finished = true;
        this.skipFooter = true;
        this.startupCallback();
        return true;
      }
      return false;
    }
    var command = result[1].toLowerCase();
    var data = trim(result[2]);
    if (Scene.validCommands[command]) {
        if ("comment" == command) return true;
        if (Scene.initialCommands[command]) {
          if ("startup" != String(this.name).toLowerCase() || !this.initialCommands) {
            throw new Error(this.lineMsg() + "Invalid "+command+" instruction, only allowed at the top of startup.txt");
          }
        } else {
          if (this.secondaryMode == "startup" && this.startupCallback) {
            this.finished = true;
            this.skipFooter = true;
            this.startupCallback();
            return true;
          }
          // if we're here, we're running a non-initial command
          // except, *bug choice_beta can appear in the initial commands
          if (command !== 'bug') this.initialCommands = false;
        }
        if (command == "choice" && String(this.name).toLowerCase() == "choicescript_screenshots") {
          throw new Error(this.lineMsg() + "choicescript_screenshots files should only contain *fake_choice commands, not real *choice commands");
        }
        this[command](data);
    } else {
        throw new Error(this.lineMsg() + "Non-existent command '"+command+"'");
    }
    return true;
};

// *choice [group1] [group2] ...
// prompt the user with a multiple choice question.
// nested lines are options to be presented to the user
//
// Examples:
// *choice
//    good
//      Good choice
//      *finish
//    bad
//      Bad choice
//      *finish
//
// *choice toy
//    spaceship
//      Nice spaceship
//      *finish
//    train
//      Nice train
//      *finish
//    doll
//      Nice doll
//      *finish
//
// *choice color toy
//    red
//      spaceship
//        Nice red spaceship
//        *finish
//      train
//        Nice red train
//        *finish
//    blue
//       spaceship
//         Nice blue spaceship
//        *finish
//       train
//         Nice red train
//        *finish

// If a group is specified, generate a prompt message, e.g. "*choice toy" -> "Select a toy:"
// If no group is specified, don't generate a prompt message
// if multiple groups are specified, allow the user to make multiple choices simultaneously
//   all multi-dimensional choices must be valid (otherwise throw a parse error)
Scene.prototype.choice = function choice(data) {
    var startLineNum = this.lineNum;
    var groups = data.split(/ /);
    for (var i = 0; i < groups.length; i++) {
      if (!/^\w*$/.test(groups[i])) {
        throw new Error(this.lineMsg() + "invalid choice group name: " + groups[i]);
      }
    }
    var options = this.parseOptions(this.indent, groups);
    var self = this;
    this.renderOptions(groups, options, function(option) {
      self.standardResolution(option);
    });
    this.finished = true;
    if (this.temps._fakeChoiceDepth > 0 || this.getVar("implicit_control_flow")) {
      if (!this.temps._choiceEnds) {
        this.temps._choiceEnds = {};
      }
      for (i = 0; i < options.length; i++) {
        this.temps._choiceEnds[options[i].line-1] = this.lineNum;
      }
    }
    this.lineNum = startLineNum;
};

Scene.prototype.fake_choice = function fake_choice(data) {
    if (this.temps._fakeChoiceDepth === undefined) {
        this.temps._fakeChoiceDepth = 0;
    }
    this.temps._fakeChoiceDepth++;
    this.choice(data);
};

Scene.prototype.standardResolution = function(option) {
  var self = this;
  self.lineNum = option.line;
  self.indent = self.getIndent(self.nextNonBlankLine(true/*includingThisOne*/));
  if (option.reuse && option.reuse != "allow") self.temps.choice_used[option.line-1] = 1;
  if (this.nav) this.nav.bugLog.push("#"+(option.line+1) + " " + option.name);

  self.finished = false;
  self.resetPage();
};

Scene.prototype.nextNonBlankLine = function nextNonBlankLine(includingThisOne) {
    var line;
    var i = this.lineNum;
    if (!includingThisOne) i++;
    while(isDefined(line = this.lines[i]) && !trim(line)) {
      i++;
    }
    return line;
};

Scene.prototype.previousNonBlankLineNum = function previousNonBlankLineNum() {
  var line;
  var i = this.lineNum - 1;
  while(isDefined(line = this.lines[i]) && !trim(line)) {
    i--;
  }
  return i;
};


Scene.prototype.resetCheckedPurchases = function resetCheckedPurchases() {
  for (var temp in this.temps) {
    if (/^choice_purchased/.test(temp)) {
      delete this.temps[temp];
    }
  }
};

// reset the page and invoke code after clearing the screen
Scene.prototype.resetPage = function resetPage() {
    var self = this;
    this.resetCheckedPurchases();
    clearScreen(function() {
      // save in the background, eventually
      self.save("");
      self.prevLine = "empty";
      self.screenEmpty = true;
      self.execute();
    });
};

/* The function needs some explaining.
We want the game to be "refreshable," e.g. on the web.
So we only make a "real" autosave as you click "Next"
But if we do it that way, when we visit the stat screen, it's out of date
So we make a "temp" autosave slot, right as the page finishes redrawing,
and the stat screen uses the "temp" autosave to display your current data.
When you refresh the page, the "temp" autosave is rewritten.

If you save stats on the stat screen, they're written into tempStatWrites;
when the stat screen saves, we transfer tempStatWrites back to the main
game (if the main game is running in a separate iframe, e.g. iOS).

If the main game is about to write the main "" slot, we merge the temp
stat writes into the main stats (and clear the stat writes) before
saving.

Thus, stat changes on the stat screen will only be permanently saved when
the player clicks "Next" in the main game, ensuring that the game is still
refreshable.
*/
Scene.prototype.save = function save(slot) {
    if (this.saveSlot) {
      transferTempStatWrites();
    } else {
      if (!slot) {
        slot = "";
        for (var key in tempStatWrites) {
          if (tempStatWrites.hasOwnProperty(key)) {
            this.stats[key] = tempStatWrites[key];
          }
        }
        tempStatWrites = {};
      }

      saveCookie(function() {}, slot, this.stats, this.temps, this.lineNum, this.indent);
    }
};

// *goto labelName
// Go to the line labeled with the label command *label labelName
//
// goto by reference
//   *create foo "labelName"
//   *goto {foo}
Scene.prototype["goto"] = function scene_goto(line) {
    var label;
    if (/[\[\{]/.test(line)) {
      label = this.evaluateReference(this.tokenizeExpr(line));
    } else {
      label = String(line).toLowerCase();
    }
    if (typeof(this.labels[label]) != "undefined") {
        this.lineNum = this.labels[label];
        this.indent = this.getIndent(this.lines[this.lineNum]);
    } else {
        throw new Error(this.lineMsg() + "bad label " + label);
    }
    if (!this.localCoverage) this.localCoverage = {};
    if (this.localCoverage[this.lineNum]) {
        this.localCoverage[this.lineNum]++;
        if (this.temps._looplimit && this.localCoverage[this.lineNum] > this.temps._looplimit) {
            throw new Error(this.lineMsg() + "visited this line too many times (" + this.temps._looplimit + ")");
        }
    } else {
        this.localCoverage[this.lineNum] = 1;
    }
};

Scene.prototype.gosub = function scene_gosub(data) {
    var label = /\S+/.exec(data)[0];
    var rest = data.substring(label.length+1);
    var args = [];
    var stack = this.tokenizeExpr(rest);
    while (stack.length) {
      args.push(this.evaluateValueToken(stack.shift(), stack));
    }
    if (!this.temps.choice_substack) {
      this.temps.choice_substack = [];
    }
    this.temps.choice_substack.push({lineNum: this.lineNum, indent: this.indent});
    // Works exactly the same as gosub_scene, putting args in this.temps.param.
    // This means there's no notion of scope - param acts more like "registers" that
    // get clobbered the next time a sub is called.
    // This may be more intuitive to non-programmers than idea of scope?  Especially
    // if temp normally doesn't follow scoping rules.  gosub_scene can serve this function anyway.
    // The params can be retrieved and put in named temps with "params" command.
    this.temps.param = args;
    this["goto"](label);
};

Scene.prototype.gosub_scene = function scene_gosub_scene(data) {
    if (!this.stats.choice_subscene_stack) {
      this.stats.choice_subscene_stack = [];
    }
    this.stats.choice_subscene_stack.push({name:this.name, lineNum: this.lineNum + 1, indent: this.indent, temps: this.temps});
    this.goto_scene(data, true /*isGosubScene*/);
};

Scene.prototype.params = function scene_params(data) {
    // Name the parameters passed by gosub/gosub_scene.
    // Rules should be the same as for "create."
    // All parameters, even those not named, exposed as param_1, param_2 etc.
    var words = /\w+/.exec(data);
    var nextParamNum = 1;
    this.temps.param_count = this.temps.param.length;
    while (words) {
        var varName = words[0].toLowerCase();
        this.validateVariable(varName);
        if (this.temps.param.length < 1) {
            throw new Error(this.lineMsg() + "No parameter passed for " + varName);
        }
        var paramVal = this.temps.param.shift();
        this.temps[varName] = paramVal;
        this.temps["param_" + nextParamNum] = paramVal;
        nextParamNum++;
        data = data.substring(varName.length+1);
        words = /\w+/.exec(data);
    }
    // All remaining params are anonymous, but you still have to say "params"
    // if you want any of them.
    while (this.temps.param.length > 0) {
        var paramVal = this.temps.param.shift();
        this.temps["param_" + nextParamNum] = paramVal;
        nextParamNum++;
    }
};

Scene.prototype["return"] = function scene_return() {
    var stackFrame;
    if (this.temps.choice_substack && this.temps.choice_substack.length) {
      stackFrame = this.temps.choice_substack.pop();
      this.lineNum = stackFrame.lineNum;
      this.indent = stackFrame.indent;
    } else if (this.stats.choice_subscene_stack && this.stats.choice_subscene_stack.length) {
      stackFrame = this.stats.choice_subscene_stack.pop();
      if (stackFrame.name == this.name) {
        this.temps = stackFrame.temps;
        this.lineNum = stackFrame.lineNum-1;
        this.indent = stackFrame.indent;
        return;
      }
      this.finished = true;
      this.skipFooter = true;
      var scene = new Scene(stackFrame.name, this.stats, this.nav, {debugMode:this.debugMode, secondaryMode:this.secondaryMode, saveSlot:this.saveSlot});
      scene.temps = stackFrame.temps;
      scene.screenEmpty = this.screenEmpty;
      scene.prevLine = this.prevLine;
      scene.lineNum = stackFrame.lineNum;
      scene.indent = stackFrame.indent;
      scene.accumulatedParagraph = this.accumulatedParagraph;
      if (this.randomtest) {
        // pop the stack in randomtest to avoid overflow
        clearScreen(function() {scene.execute()});
      } else {
        scene.execute();
      }
    } else if (!this.temps.choice_substack && !this.stats.choice_subscene_stack) {
      throw new Error(this.lineMsg() + "invalid return; gosub has not yet been called");
    } else {
      throw new Error(this.lineMsg() + "invalid return; we've already returned from the last gosub");
    }

};

// *gotoref expression
// Go to the label identified by the expression
//
// *temp foo
// *set foo "bar"
// *gotoref foo
// Skipped!
// *label bar
Scene.prototype["gotoref"] = function scene_gotoref(expression) {
    var stack = this.tokenizeExpr(expression);
    var value = this.evaluateExpr(stack);
    this["goto"](value);
};


// *finish
// halt the scene
Scene.prototype.finish = function finish(buttonName) {
    this.paragraph();
    this.finished = true;
    var self = this;
    if (this.secondaryMode == "stats") {
      if (typeof window == "undefined") return;
      // In iPad app, the stats screen is always visible
      if (window.isIosApp && window.isIPad) return;

      if (this.screenEmpty) {
        returnFromStats();
        return;
      }
      if (!buttonName) buttonName = "Next";
      buttonName = this.replaceVariables(buttonName);
      printButton(buttonName, main, false,
        function() {
          returnFromStats();
        }
      );
      return;
    }
    var nextSceneName = this.nav && nav.nextSceneName(this.name);
    // if there are no more scenes, then just halt
    if (!nextSceneName) {
        if (!this.secondaryMode) this.ending();
        return;
    }
    if (this.screenEmpty) {
      this.goto_scene(nextSceneName);
      return;
    }
    if (!buttonName) buttonName = "Next Chapter";
    buttonName = this.replaceVariables(buttonName);


    printButton(buttonName, main, false,
      function() {
        safeCall(self, function() {
            var scene = new Scene(nextSceneName, self.stats, self.nav, {debugMode:self.debugMode, secondaryMode:self.secondaryMode});
            scene.resetPage();
        });
      }
    );
    if (this.debugMode) println(computeCookie(this.stats, this.temps, this.lineNum, this.indent));
};

Scene.prototype.autofinish = function autofinish(buttonName) {
  this.finish(buttonName);
};

// *reset
// clear all stats
Scene.prototype.reset = function reset() {
    this.nav.resetStats(this.stats);
    this.stats.scene = this;
};

Scene.prototype.parseGotoScene = function parseGotoScene(data) {
  var sceneName, label, param = [], stack;

  if (/[\[\{]/.test(data)) {
    stack = this.tokenizeExpr(data);
    sceneName = this.evaluateReference(stack, {toLowerCase: false});
    // Labels are required for arguments to avoid ambiguity
    if (stack.length) {
      label = this.evaluateReference(stack);
    }
    while (stack.length) {
      // Arguments when treating gosub_scene like a function call
      param.push(this.evaluateValueToken(stack.shift(), stack));
    }
  } else {
    // scenes and labels can contain hyphens and other non-expression punctuation
    // so we'll try to extract the first two words as the scene and label
    var match = /(\S+)\s+(\S+)\s*(.*)/.exec(data);
    if (match) {
      sceneName = match[1];
      label = match[2];
      stack = this.tokenizeExpr(match[3]);
      while (stack.length) {
        // Arguments when treating gosub_scene like a function call
        param.push(this.evaluateValueToken(stack.shift(), stack));
      }
    } else {
      if (data === "") throw new Error(this.lineMsg() + "missing scene name");
      sceneName = data;
    }
  }
  return {sceneName:sceneName, label:label, param:param};
};

// *goto_scene foo
//
Scene.prototype.goto_scene = function gotoScene(data, isGosubScene) {
    if (!isGosubScene && (this.stats.choice_subscene_stack || []).length) {
      var stackFrame = this.stats.choice_subscene_stack.pop();
      this.warning("You should *return before *goto_scene after *gosub_scene from from " + stackFrame.name + " line " + stackFrame.lineNum);
      delete this.stats.choice_subscene_stack;
    }
    var result = this.parseGotoScene(data);

    if (result.sceneName == this.name) {
      if (typeof result.label === "undefined") {
        this.lineNum = -1; // the printLoop will increment the line number to 0
      } else {
        this["goto"](result.label);
      }
      this.temps = {choice_reuse:"allow", choice_user_restored:false, _choiceEnds:{}};
      this.temps.param = result.param;
      this.initialCommands = true;
      return;
    }

    this.finished = true;
    this.skipFooter = true;
    var scene = new Scene(result.sceneName, this.stats, this.nav, {debugMode:this.debugMode, secondaryMode:this.secondaryMode, saveSlot:this.saveSlot});
    scene.screenEmpty = this.screenEmpty;
    scene.prevLine = this.prevLine;
    scene.accumulatedParagraph = this.accumulatedParagraph;
    if (typeof result.label != "undefined") scene.targetLabel = {label:result.label, origin:this.name, originLine:this.lineNum};
    if (typeof result.param != "undefined") scene.temps.param = result.param;
    if (this.redirectingFromStats) scene.redirectingFromStats = true;
    scene.execute();
};

// *redirect_scene foo
Scene.prototype.redirect_scene = function redirectScene(data) {
  if (this.secondaryMode != "stats") throw new Error(this.lineMsg() + "The *redirect_scene command can only be used from the stats screen.");
  var result = this.parseGotoScene(data);
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  redirectFromStats(result.sceneName, result.label, this.lineNum, function() {
    delete self.secondaryMode;
    delete self.saveSlot;
    self.redirectingFromStats = true;
    self.goto_scene(data);
  });
};

Scene.prototype.product = function product(productId) {
  if (!/^[a-z]+$/.test(productId)) throw new Error(this.lineMsg()+"Invalid product id (only lowercase letters, no numbers or punctuation): " +productId);
  if (this.nav) this.nav.products[productId] = {};
}

Scene.prototype.restore_purchases = function scene_restorePurchases(data) {
  var self = this;
  var target = this.target;
  if (!target) target = document.getElementById('text');
  var button = printButton("Restore Purchases", target, false,
    function() {
      safeCall(self, function() {
          restorePurchases(null, function() {
            self["goto"](data);
            self.finished = false;
            self.resetPage();
          });
      });
    }
  );

  setClass(button, "");
  this.prevLine = "block";
};

Scene.prototype.check_purchase = function scene_checkPurchase(data) {
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  var productList = data.split(/ /);
  for (var i = 0; i < productList.length; i++) {
    var product = productList[i];
    if (!this.nav.products[product] && product != "adfree") {
      throw new Error(this.lineMsg() + "The product " + product + " wasn't declared in a *product command");
    }
  }
  checkPurchase(data, function(ok, result) {
    self.finished = false;
    self.skipFooter = false;
    if (!ok) {
      result = {billingSupported:true};
      self.temps.choice_purchase_error = true;
    }
    result = result || {};
    var products = data.split(/ /);
    var everything = true;
    for (var i = 0; i < products.length; i++) {
      var purchasedProduct = result[products[i]] || false;
      self.temps["choice_purchased_"+products[i]] = purchasedProduct;
      if (!purchasedProduct) everything = false;
    }
    self.temps.choice_purchased_everything = everything;
    self.temps.choice_purchase_supported = !!result.billingSupported;
    self.execute();
  });
};

Scene.prototype.parsePurchase = function parsePurchase(data) {
  var result;
  if (/^\{/.test(data)) {
    try {
      result = JSON.parse(data);
    } catch (e) {
      throw new Error(this.lineMsg() + "Couldn't parse purchase JSON: " + e)
    }
    if (!result.product) {
      throw new Error(this.lineMsg() + "JSON missing product");
    }
    if (!result['goto']) {
      throw new Error(this.lineMsg() + "JSON missing goto");
    }
    if (result.priceGuess && result.discount) {
      throw new Error(this.lineMsg() + "JSON has both top-level priceGuess and discount; there should be one or the other");
    }
    if (!(result.priceGuess || result.discount)) {
      throw new Error(this.lineMsg() + "JSON has neither top-level priceGuess nor discount; there should be one or the other");
    }
    if (result.discount) {
      if (!result.discount.end) throw new Error(this.lineMsg() + "JSON discount doesn't include end");
      result.discount.end = parseDateStringInCurrentTimezone(result.discount.end, this.lineNum + 1);
      if (!result.discount.lowPrice) throw new Error(this.lineMsg() + "JSON discount doesn't include lowPrice");
      if (!/^\$/.test(result.discount.lowPrice)) throw new Error(this.lineMsg() + "lowPrice " + fullPriceGuess + "doesn't start with dollar");
      if (!result.discount.fullPrice) throw new Error(this.lineMsg() + "JSON discount doesn't include fullPrice");
      if (!/^\$/.test(result.discount.fullPrice)) throw new Error(this.lineMsg() + "fullPrice " + fullPriceGuess + "doesn't start with dollar");
    }
    if (!result.title) result.title = "It";
  } else {
    var parsed = /^(\w+)\s+(\S+)\s+(.*)/.exec(data);
    if (!parsed) throw new Error(this.lineMsg() + "invalid line; can't parse purchaseable product: " + data);
    result = {product: parsed[1], priceGuess: parsed[2], "goto": parsed[3], title: "It"};
  }
  return result;
}

Scene.prototype.purchase = function purchase(data) {
  var parsed = this.parsePurchase(data);
  if (parsed.discount) {
    this.buyButtonDiscount(parsed.product, parsed.discount.end, parsed.discount.fullPrice, parsed.discount.lowPrice, parsed['goto'], parsed.title);
  } else {
    this.buyButton(parsed.product, parsed.priceGuess, parsed['goto'], parsed.title);
  }
}

Scene.prototype.buyButton = function(product, priceGuess, label, title) {
  if (label && typeof this.temps["choice_purchased_" + product] === "undefined") {
    throw new Error(this.lineMsg() + "Didn't check_purchases on this page");
  }
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  var purchaseFinished = function() {
    if (label) self["goto"](label);
    self.finished = false;
    self.skipFooter = false;
    self.resetPage();
  }
  getPrice(product, function (price) {
    if (!price || "free" == price) {
      purchaseFinished();
    } else {
      if (price == "guess") price = priceGuess + " USD";
      var prerelease = self.getVar('choice_prerelease');
      var buttonText;
      if (prerelease) {
        buttonText = "Pre-Order " + title;
      } else {
        buttonText = "Buy "+title+" Now";
      }
      if (price != "hide") {
        buttonText += " for " + price;
      }
      var target = self.target;
      if (!target) target = document.getElementById('text');
      self.paragraph();
      var button = printButton(buttonText, target, false,
        function() {
          safeCall(self, function() {
              purchase(product, function() {
                safeCall(self, purchaseFinished);
              });
          });
        }
      );
      self.prevLine = "block";
      if (isRestorePurchasesSupported()) {
        self.prevLine = "text";
        printLink(printParagraph("If you've already purchased, click here to "), "#", "restore purchases",
          function(e) {
            preventDefault(e);
            safeCall(self, function() {
                restorePurchases(product, function(purchased) {
                  if (purchased) {
                    purchaseFinished();
                  } else {
                    // refresh, in case we're on web showing a full-screen login. Not necessary on mobile? But, meh.
                    clearScreen(function() {loadAndRestoreGame("", window.forcedScene);});
                  }
                });
            });
          }
        );
      }

      if (label) {
        self.skipFooter = false;
        self.finished = false;
        self.execute();
      }
    }
  });
};

Scene.prototype.purchase_discount = function purchase_discount(line) {
  this.paragraph();
  var args = trim(String(line)).split(" ");
  if (args.length != 5) throw new Error(this.lineMsg() + "expected five arguments, saw "+args.length+": " + line);
  var product = args[0];
  var expectedEndDateString = args[1];
  var expectedEndDate = parseDateStringInCurrentTimezone(expectedEndDateString, this.lineNum+1);
  var fullPriceGuess = this.replaceVariables(args[2]);
  var discountedPriceGuess = this.replaceVariables(args[3]);
  var label = args[4];
  var startsWithDollar = /^\$/;
  if (!startsWithDollar.test(fullPriceGuess)) {
    throw new Error(this.lineMsg() + "full price guess "+fullPriceGuess+"doesn't start with dollar: " + line);
  }
  if (!startsWithDollar.test(discountedPriceGuess)) {
    throw new Error(this.lineMsg() + "discounted price guess "+discountedPriceGuess+"doesn't start with dollar: " + line);
  }
  var title = "It";
  this.buyButtonDiscount(product, expectedEndDate, fullPriceGuess, discountedPriceGuess, label, title);
}

Scene.prototype.buyButtonDiscount = function buyButtonDiscount(product, expectedEndDate, fullPriceGuess, discountedPriceGuess, label, title) {
  var prerelease = this.getVar('choice_prerelease');
  var discountText;
  if (prerelease) {
    discountText = "[b]Buy now before the price increases![/b]";
  } else {
    discountText = "[b]On sale until "+shortMonthStrings[expectedEndDate.getMonth()+1]+" "+expectedEndDate.getDate()+"! Buy now before the price increases![/b]"
  }
  if (typeof printDiscount != "undefined") {
    printDiscount(product, expectedEndDate.getYear()+1900, expectedEndDate.getMonth()+1, expectedEndDate.getDate(), discountText);
  }
  var priceGuess;
  if (new Date().getTime() < expectedEndDate.getTime()) {
    priceGuess = discountedPriceGuess;
  } else {
    priceGuess = fullPriceGuess;
  }
  this.buyButton(product, priceGuess, label, title);
}

Scene.prototype.print_discount = function print_Discount(line) {
  var result = /(\w+) (\d{4})-(\d{2})-(\d{2}) (.*$)/.exec(line);
  if (!result) throw new Error("invalid discount: " + line);
  var product = result[1];
  var fullYear = result[2];
  var oneBasedMonthNumber = parseInt(result[3],10);
  var dayOfMonth = parseInt(result[4],10);
  var discountText = result[5];
  this.temps.choice_discount_ends = "POISONTOKEN";
  discountText = this.replaceVariables(discountText).replace("POISONTOKEN", "${choice_discount_ends}");
  delete this.temps.choice_discount_ends;
  if (typeof printDiscount != "undefined") printDiscount(product, fullYear, oneBasedMonthNumber, dayOfMonth, discountText);
};

// *abort
// halt the scene without showing a button
Scene.prototype.abort = function() {
  this.paragraph();
  this.finished = true;
};

// *create
// create a new permanent stat
Scene.prototype.create = function create(line) {
    var result = /^(\w*)(.*)/.exec(line);
    if (!result) throw new Error(this.lineMsg() + "Invalid create instruction, no variable specified: " + line);
    var variable = result[1];
    this.validateVariable(variable);
    variable = variable.toLowerCase();
    var expr = result[2];
    var stack = this.tokenizeExpr(expr);
    if (stack.length > 1) throw new Error(this.lineMsg() + "Invalid create instruction, too many values: " + line);
    this.createVariable(variable, stack[0], line);
}

Scene.prototype.createVariable = function createVariable(variable, token, line) {
  var self = this;
  if (!token) throw new Error(this.lineMsg() + "Invalid create instruction, no value specified: " + line);
  function complexError() {
    throw new Error(self.lineMsg() + "Invalid create instruction, value must be a number, true/false, or a quoted string: " + line);
  }
  if (!/STRING|NUMBER|VAR/.test(token.name)) complexError();
  if ("VAR" == token.name && !/^true|false$/i.test(token.value)) complexError();
  if ("STRING" == token.name && /(\$|@)!?!?{/.test(token.value)) throw new Error(this.lineMsg() + "Invalid create instruction, value must be a simple string without ${} or @{}: " + line);
  var value = this.evaluateExpr([token]);
  if (!this.created) this.created = {};
  if (this.created[variable]) throw new Error(this.lineMsg() + "Invalid create. " + variable + " was previously created on line " + this.created[variable]);
  this.created[variable] = this.lineNum + 1;
  this.stats[variable] = value;
  if (this.nav) this.nav.startingStats[variable] = value;
}

// *create_array {name} {length} {value(s)}
// create an "array" of permanent stats:
//    myarray_1
//    myarray_2
//    ...
//    myarray_count
Scene.prototype.create_array = function create(line) {
  this.defineArray("create", line);
};

// *temp
// create a temporary stat for the current scene
Scene.prototype.temp = function temp(line) {
    var result = /^(\w*)(.*)/.exec(line);
    if (!result) throw new Error(this.lineMsg()+"Invalid temp instruction, no variable specified: " + line);
    var variable = result[1];
    this.validateVariable(variable);
    var expr = result[2];
    var stack = this.tokenizeExpr(expr);
    if (stack.length === 0) {
      this.temps[variable.toLowerCase()] = null;
      return;
    }
    var value = this.evaluateExpr(stack);
    if (typeof this.stats[variable.toLowerCase()] !== 'undefined') {
      this.warning("This is a temp, but we already ran *create " + variable);
    }
    this.temps[variable.toLowerCase()] = value;
};

// *temp_array
// create an "array" of temporary stats for the current scene
Scene.prototype.temp_array = function temp_array(line) {
  this.defineArray("temp", line);
};

Scene.prototype.defineArray = function defineArray(command, line) {
  var result = /^(\w+)(.*)/.exec(line);
  if (!result) throw new Error(this.lineMsg() + "Invalid " + command + "_array instruction, no array name specified: " + line);
  var variable = result[1];
  this.validateVariable(variable);
  variable = variable.toLowerCase();
  var stack = this.tokenizeExpr(result[2].trim());
  if (!stack.length) {
    throw new Error(this.lineMsg() + "Invalid " + command + "_array instruction, missing length: " + line);
  }
  var length = Number(stack.shift().value);
  if (length !== Math.floor(length) || length < 1) {
    throw new Error(this.lineMsg() + "Invalid " + command + "_array instruction, length should be a whole number greater than 0: " + line);
  }

  var token;
  var value = null;
  var self = this;
  var i;
  function create(suffix) {
    if (command === "create") {
      self.createVariable(variable + "_" + suffix, token, line);
    } else {
      self.temps[variable + "_" + suffix] = value;
    }
  }

  function next() {
    token = stack[0];
    if (!token) throw new Error(self.lineMsg() + "Too few values. Expected 1 default value or " + length + " explicit values, not " + i + ": " + line);
    value = self.evaluateValueToken(stack.shift(), stack);
  }

  if (stack.length) next();
  
  if (!stack.length) {
    // Use first default value for all creations
    for (i = 0; i < length; i++) {
      create(i+1);
    }
  } else {
    create(1);
    for (i = 1; i < length; i++) {
      next();
      create(i+1);
    }
  }

  if (stack.length) {
    throw new Error(this.lineMsg() + "Too many values. Expected 1 default value or " + length + " explicit values: " + line);
  }

  token = { name: "NUMBER", value: length };
  value = length;
  create("count");
}

// retrieve the value of the variable, preferring temp scope
Scene.prototype.getVar = function getVar(variable) {
    var value;
    variable = String(variable).toLowerCase();
    if (variable && !isNaN(1*variable) && String(1*variable) === variable) return 1*variable;
    if (variable == "true") return true;
    if (variable == "false") return false;
    if (variable == "choice_subscribe_allowed") return true;
    if (variable == "choice_register_allowed") return isRegisterAllowed();
    if (variable == "choice_registered") return typeof window != "undefined" && !!window.registered;
    if (variable == "choice_is_web") return typeof window != "undefined" && !!window.isWeb;
    if (variable == "choice_is_steam") return typeof window != "undefined" && !!window.isSteamApp;
    if (variable == "choice_is_steam_deck") return typeof window != "undefined" && !!window.isSteamApp && !!window.isSteamDeck;
    if (variable == "choice_is_ios_app") return typeof window != "undefined" && !!window.isIosApp;
    if (variable == "choice_is_ipad_app") return typeof window != "undefined" && !!window.isIosApp && !!window.isIPad;
    if (variable == "choice_is_android_app") return typeof window != "undefined" && !!window.isAndroidApp;
    if (variable == "choice_is_omnibus_app") return typeof window != "undefined" && !!window.isOmnibusApp;
    if (variable == "choice_is_amazon_app") return typeof window != "undefined" && !!window.isAmazonApp;
    if (variable == "choice_is_advertising_supported") return typeof isAdvertisingSupported != "undefined" && !!isAdvertisingSupported();
    if (variable == "choice_is_trial") return !!(typeof isTrial != "undefined" && isTrial);
    if (variable == "choice_release_date") {
      if (typeof window != "undefined" && window.releaseDate) {
        return simpleDateFormat(window.releaseDate);
      }
      return "release day";
    }
    if (variable == "choice_prerelease") return typeof isPrerelease != "undefined" && !!isPrerelease();
    if (variable == "choice_kindle") return typeof isKindle !== "undefined" && !!isKindle;
    if (variable == "choice_randomtest") return !!this.randomtest;
    if (variable == "choice_quicktest") return false; // quicktest will explore "false" paths
    if (variable == "choice_linenum") return this.lineNum;
    if (variable == "choice_scene") return this.name;
    if (variable == "choice_restore_purchases_allowed") return isRestorePurchasesSupported();
    if (variable == "choice_save_allowed") return areSaveSlotsSupported();
    if (variable == "choice_time_stamp") return Math.floor(new Date()/1000);
    if (variable == "choice_nightmode") return typeof isNightMode != "undefined" && isNightMode();
    if (variable == "choice_title") {
      if (typeof this.stats.choice_title === "undefined") {
        throw new Error(this.lineMsg() + "This game is missing a *title command");
      }
    }
    if (variable.startsWith("choice_saved_checkpoint")) {
      return !!this.stats[variable];
    }
    if ((!this.temps.hasOwnProperty(variable))) {
        if ((!this.stats.hasOwnProperty(variable))) {
            if (variable == "implicit_control_flow") return false;
            throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
        }
        value = this.stats[variable];
        if (value === null || value === undefined) {
            throw new Error(this.lineMsg() + "Variable '"+variable+"' exists but has no value");
        }
        if (this.debugMode) println("stats["+ variable + "]==" + value);
        return value;
    }
    value = this.temps[variable];
    if (value === null || value === undefined) {
        throw new Error(this.lineMsg() + "Variable '"+variable+"' exists but has no value");
    }
    if (this.debugMode) println("temps["+ variable + "]==" + value);
    return value;
};

// set the value of the variable, preferring temp scope
Scene.prototype.setVar = function setVar(variable, value) {
    variable = variable.toLowerCase();
    if (this.debugMode) println(variable +"="+ value);
    if ("undefined" === typeof this.temps[variable]) {
        if ("undefined" === typeof this.stats[variable]) {
            throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
        }
        this.stats[variable] = value;
        if (this.saveSlot == "temp") tempStatWrites[variable] = value;
        // Implicit control flow flag is ideally set just once in startup.
        // Removing these lines makes this not possible with quicktest.
        if (variable == "implicit_control_flow" && this.nav) {
            this.nav.startingStats["implicit_control_flow"] = value;
        }
    } else {
        this.temps[variable] = value;
    }
};

// *delete variable
// deletes the named variable
Scene.prototype["delete"] = function scene_delete(variable) {
    variable = variable.toLowerCase();
    if ("undefined" === typeof this.temps[variable]) {
        if ("undefined" === typeof this.stats[variable]) {
            throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
        }
        delete this.stats[variable];
    } else {
        delete this.temps[variable];
    }
};

Scene.prototype["delete_array"] = function scene_delete_array(arrayName) {
  arrayName = arrayName.toLowerCase();
  if ("undefined" === typeof this.temps[arrayName + "_count"]) {
      if ("undefined" === typeof this.stats[arrayName + "_count"]) {
          throw new Error(this.lineMsg() + "Non-existent array '"+arrayName+"'");
      }
      var length = this.stats[arrayName + "_count"];
      delete this.stats[arrayName + "_count"];
      for (var i = 1; i <= length; i++) {
        delete this.stats[arrayName + ("_" + i)];
      }
  } else {
      var length = this.temps[arrayName + "_count"];
      delete this.temps[arrayName + "_count"];
      for (var i = 1; i <= length; i++) {
        delete this.temps[arrayName + ("_" + i)];
      }
  }
};

// during a choice, recursively parse the options
Scene.prototype.parseOptions = function parseOptions(startIndent, choicesRemaining, expectedSubOptions) {
    // nextIndent: the level of indentation after the current line
    // For example, in the color/toy sample above, we start at 0
    // then the nextIndent is 2 for "red"
    // then the nextIndent is 4 for "spaceship"
    var nextIndent = null;
    var options = [];
    var choiceEnds = [];
    var line;
    var currentChoice = choicesRemaining[0];
    if (!currentChoice) currentChoice = "choice";
    var suboptionsEncountered = false;
    var bodyExpected = false;
    var previousSubOptions;
    var namesEncountered = {};
    var atLeastOneSelectableOption = false;
    var prevOption, ifResult;
    var startingLine = this.lineNum;
    var self = this;
    function removeModifierCommand(stripParethentical) {
      if (stripParethentical) {
        var openParen = line.indexOf("(")+1;
        var closingParen = matchBracket(line, "()", openParen);
        if (closingParen == -1) {
          throw new Error(self.lineMsg() + "missing closing parenthesis");
        }
        line = trim(line.substr(closingParen+1));
      } else {
        line = trim(line.replace(/^\s*\*(\w+)(.*)/, "$2"));
      }
      parsed = /^\s*\*(\w+)(.*)/.exec(line);
      if (parsed) {
        command = parsed[1].toLowerCase();
        data = trim(parsed[2]);
      } else {
        command = "";
      }
    }
    while(isDefined(line = this.lines[++this.lineNum])) {
        if (!trim(line)) {
            this.rollbackLineCoverage();
            continue;
        }
        var indent = this.getIndent(line);
        if (nextIndent === null || nextIndent === undefined) {
            // initialize nextIndent with whatever indentation the line turns out to be
            // ...unless it's not indented at all
            if (indent <= startIndent) {
                throw new Error(this.lineMsg() + "invalid indent, expected at least one '" + currentChoice + "'");
            }
            this.indent = nextIndent = indent;
        }
        if (indent <= startIndent) {
            // it's over!
            break;
        }
        if (indent < this.indent) {
            // TODO drift detection
            if (false) /*(indent != nextIndent)*/ {
                // error: indentation has decreased, but not all the way back
                // Example:
                // *choice
                //     red
                //   blue
                throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
            }

            // we must be falling out of a sub-block
            this.dedent(indent);
            this.indent = indent;
        }
        if (indent > this.indent) {
            // body of the choice
            // ...unless we haven't identified our choices yet
            // TODO is this error test valid?
            if (choicesRemaining.length>1) throw new Error(this.lineMsg() + "invalid indent, there were subchoices remaining: [" + choicesRemaining.join(",") + "]");
            this.rollbackLineCoverage();
            bodyExpected = false;
            continue;
        }

        // here's the end of the previous option
        if (options.length) {
          prevOption = options[options.length-1];
          if (!prevOption.endLine) prevOption.endLine = this.lineNum;
        }

        // Execute *if commands (etc.) during option loop
        // sub-commands may modify this.indent
        var parsed = /^\s*\*(\w+)(.*)/.exec(line);
        var unselectable = false;
        var inlineIf = null;
        var selectableIf = null;
        var self = this;

        var overrideDefaultReuseSetting = false;
        var reuse = this.temps.choice_reuse;
        if (parsed) {
            var command = parsed[1].toLowerCase();
            var data = trim(parsed[2]);
            // TODO whitelist commands
            if ("hide_reuse" == command) {
              reuse = "hide";
              overrideDefaultReuseSetting = true;
              removeModifierCommand();
            }
            if ("disable_reuse" == command) {
              reuse = "disable";
              overrideDefaultReuseSetting = true;
              removeModifierCommand();
            }
            if ("allow_reuse" == command) {
              reuse = "allow";
              overrideDefaultReuseSetting = true;
              removeModifierCommand();
            }
            if ("random_weight" == command) {
              removeModifierCommand(true /*stripParenthetical*/);
            }

            if ("print" == command) {
                line = this.evaluateExpr(this.tokenizeExpr(data));
            } else if ("if" == command) {
              choiceEnds.push(this.lineNum);
              ifResult = this.parseOptionIf(data, command);
              if (ifResult) {
                inlineIf = ifResult.condition;
                if (ifResult.result) {
                  line = ifResult.line;
                } else {
                  continue;
                }
              } else {
                this["if"](data, true /*inChoice*/);
                continue;
              }
            } else if ("else" == command) {
              if (data) throw new Error(this.lineMsg() + "Invalid content after *" + command + "; move the #option to the next line, indented: " + data);
              this[command](data, true /*inChoice*/);
              continue;
            } else if (/^(elseif|elsif)$/.test(command)) {
              ifResult = this.parseOptionIf(data, command);
              if (ifResult) {
                throw new Error(this.lineMsg() + "Invalid content after *" + command + "; move the #option to the next line, indented: " + ifResult.line);
              }
              this[command](data, true /*inChoice*/);
              continue;
            } else if ("selectable_if" == command) {
              ifResult = this.parseOptionIf(data, command);
              if (!ifResult) throw new Error(this.lineMsg() + "Couldn't parse the line after *selectable_if: " + data);
              line = ifResult.line;
              selectableIf = ifResult.condition;
              unselectable = unselectable || !ifResult.result;
            } else if ("comment" == command) {
                continue;
            } else if (!command) {
              // command was rewritten by earlier modifier
            } else {
                if (Scene.validCommands[command]) {
                  throw new Error(this.lineMsg() + "Invalid indent? Expected an #option here, not *"+command);
                }  else {
                    throw new Error(this.lineMsg() + "Non-existent command '"+command+"'");
                }
            }
        }

        if ("allow" != reuse) {
          if (!this.temps.choice_used) this.temps.choice_used = {};
          if (this.temps.choice_used[this.lineNum]) {
            if ("hide" == reuse) continue;
            unselectable = true;
          }
        }

        // this line should be a valid option
        if (!/^\s*\#\s*\S/.test(line)) {
            throw new Error(this.lineMsg() + "Expected option starting with #");
        }
        // replace variables here and discard the result, so error messages display the correct line
        this.replaceVariables(line);
        line = trim(trim(line).substring(1));
        var option = {name:line, group:currentChoice};
        if (reuse != "allow") option.reuse = reuse;
        if (this.displayOptionConditions) {
          option.displayIf = [];
          for (var i = 0; i < this.displayOptionConditions.length; i++) {
            option.displayIf[i] = this.displayOptionConditions[i];
          }
          if (inlineIf) option.displayIf.push(inlineIf);
        } else if (inlineIf) {
          option.displayIf = [inlineIf];
        }
        if (selectableIf) {
          option.selectableIf = selectableIf;
        }
        option.line = this.lineNum + 1;
        if (unselectable) {
          option.unselectable = true;
        }
        if (namesEncountered[line]) {
            this.conflictingOptions(this.lineMsg() + "Invalid option; conflicts with option '"+option.name+"' on line " + namesEncountered[line]);
        } else {
            namesEncountered[line] = option.line;
        }
        options.push(option);
        if (choicesRemaining.length>1) {
            // recursive call will modify this.indent
            option.suboptions = this.parseOptions(this.indent, choicesRemaining.slice(1), previousSubOptions);
            // now restore it
            this.indent = nextIndent;
            if (!previousSubOptions) previousSubOptions = option.suboptions;
            suboptionsEncountered = true;
        } else {
            bodyExpected = true;
        }
        if (!unselectable) atLeastOneSelectableOption = true;
    }

    // TODO is this error test valid?
    if (choicesRemaining.length>1 && !suboptionsEncountered) {
        throw new Error(this.lineMsg() + "invalid indent, there were subchoices remaining: [" + choicesRemaining.join(",") + "]");
    }
    if (bodyExpected &&
            (this.temps._fakeChoiceDepth === undefined || this.temps._fakeChoiceDepth < 1)) {
        throw new Error(this.lineMsg() + "Expected choice body");
    }
    if (!atLeastOneSelectableOption) this.conflictingOptions(this.lineMsg() + "No selectable options");
    if (expectedSubOptions) {
        this.verifyOptionsMatch(expectedSubOptions, options);
    }
    this.rollbackLineCoverage();
    prevOption = options[options.length-1];
    this.lineNum = this.previousNonBlankLineNum();
    if (!prevOption.endLine) prevOption.endLine = this.lineNum+1;
    for (i = 0; i < choiceEnds.length; i++) {
        this.temps._choiceEnds[choiceEnds[i]] = this.lineNum;
    }
    this.rollbackLineCoverage();
    return options;
};

// compute *if statement during options
Scene.prototype.parseOptionIf = function parseOptionIf(data) {
  var parsed = /^\s*\((.*)\)\s+(#.*)/.exec(data);
  if (!parsed) {
    return;
  }
  var condition = parsed[1];
  var stack = this.tokenizeExpr(condition);
  var result = this.evaluateExpr(stack);
  if (this.debugMode) println(condition + " :: " + result);
  result = bool(result, this.lineNum+1);
  // In the autotester, all conditionals are enabled
  result = result || this.testPath;
  return {result:result, line:parsed[2], condition:null};
};

// Add this as a separate method so we can override it elsewhere
// We want this error during randomtest but not during autotest
// Because autotest makes impossible situations happen
Scene.prototype.conflictingOptions = function conflictingOptions(str) {
  throw new Error(str);
};

// verify that the current option set corresponds to the previous option set
// (for multichoices)
Scene.prototype.verifyOptionsMatch = function verifyOptionsMatch(prev, current) {
    // find matching option by name
    function findMatch(name, options) {
        for (var i = 0; i < options.length; i++) {
            var option = options[i];
            if (option && name == option.name) {
                return option;
            }
        }
        return null;
    }

    var prevOpt, curOpt;
    for (var i = 0; i < prev.length; i++) {
        prevOpt = prev[i];
        curOpt = findMatch(prevOpt.name, current);
        if (!curOpt) throw new Error(this.lineMsg()+"Missing expected suboption '"+prevOpt.name+"'; all suboptions must have same option list");
    }

    if (prev.length == current.length) return;

    for (i = 0; i < current.length; i++) {
        curOpt = current[i];
        prevOpt = findMatch(curOpt.name, prev);
        if (!prevOpt) throw new Error(this.lineMsg()+"Added unexpected suboption '"+curOpt.name+"'; all suboptions must have same option list");
    }

    throw new Error(this.lineMsg()+"Bug? previous options and current options mismatch, but no particular missing element");
};

// render the prompt and the radio buttons
Scene.prototype.renderOptions = function renderOptions(groups, options, callback) {
    var self = this;
    function replaceVars(options) {
      for (var i = 0; i < options.length; i++) {
        var option = options[i];
        option.name = self.replaceVariables(option.name);
        if (option.suboptions) replaceVars(option.suboptions);
      }
    }
    replaceVars(options);
    this.paragraph();
    printOptions(groups, options, callback);

    if (this.debugMode) println(computeCookie(this.stats, this.temps, this.lineNum, this.indent));

    if (this.finished) printFooter();
};

// *page_break
// pause and prompt the user to press "Next"
Scene.prototype.page_break = function page_break(buttonName) {
    if (this.screenEmpty) return;
    if (!buttonName) buttonName = "Next";
    buttonName = this.replaceVariables(buttonName);
    this.paragraph();
    this.finished = true;

    var self = this;
    printButton(buttonName, main, false,
      function() {
        delayBreakEnd();
        self.finished = false;
        self.resetPage();
      }
    );
    if (this.debugMode) println(computeCookie(this.stats, this.temps, this.lineNum, this.indent));
};

Scene.prototype.page_break_advertisement = function pageBreakAdvertisement(line) {
  if (line) throw new Error(this.lineMsg() + "*page_break_advertisement doesn't allow you to change the button message. This text will never be shown: " + line);
  var self = this;
  this.finished = true;
  showFullScreenAdvertisementButton("Watch an Ad to Continue", function () {
    self.finished = false;
    if (self.screenEmpty) {
      self.skipFooter = false;
      self.resetPage();
    } else {
      self.page_break("");
    }
  }, function () {
    delayBreakEnd();
    self.finished = false;
    self.skipFooter = false;
    self.resetPage();
  });
};

Scene.prototype.finish_advertisement = function finishAdvertisement(line) {
  if (line) throw new Error(this.lineMsg() + "*finish_advertisement doesn't allow you to change the button message. This text will never be shown: " + line);
  var self = this;
  this.finished = true;
  showFullScreenAdvertisementButton("Watch an Ad for the Next Chapter", function () {
    self.finish("");
  }, function () {
    var nextSceneName = self.nav && nav.nextSceneName(self.name);
    var scene = new Scene(nextSceneName, self.stats, self.nav, { debugMode: self.debugMode, secondaryMode: self.secondaryMode });
    scene.resetPage();
  });
};

// *line_break
// single line break in the middle of a paragraph
Scene.prototype.line_break = function line_break() {
    // We want to prevent a huge <p><br></p> between blocks
    // so if there's existing text we'll just toss in a [n/]
    // and if there's no text yet, we'll directly insert a <br>
    if (this.accumulatedParagraph.length) {
      this.accumulatedParagraph.push('[n/]');
    } else {
      println();
    }
};

// *image
// display named image
Scene.prototype.image = function image(data, invert) {
    this.paragraph();
    data = data || "";
    data = this.replaceVariables(data);
    var match = /(\S+) (\S+)(.*)/.exec(data);
    var source, alignment;
    var alt = null;
    if (match) {
      var source = match[1];
      var alignment = match[2];
      var alt = trim(match[3]);
    } else {
      source = data;
    }
    if (source === "") throw new Error(this.lineMsg()+"*image requires the file name of an image");
    alignment = alignment || "center";
    if (!/(right|left|center|none)/.test(alignment)) throw new Error(this.lineMsg()+"Invalid alignment, expected right, left, center, or none: " + data);
    printImage(source, alignment, alt, invert);
    if (this.verifyImage) this.verifyImage(source);
    if (alignment == "none") this.prevLine = "text";
    this.screenEmpty = false;
};

Scene.prototype.text_image = function textImage(data) {
  this.image(data, "invert");
}

// *sound
// play named sound file
Scene.prototype.sound = function sound(source) {
    if (typeof playSound == "function") playSound(source);
    if (this.verifyImage) this.verifyImage(source);
};

Scene.prototype.kindle_image = function kindle_image() {
  // Do nothing on non-Kindle devices; show only on Kindle
};

Scene.prototype.youtube = function youtube(slug) {
  if (typeof printYoutubeFrame !== "undefined") {
    printYoutubeFrame(slug);
    this.prevLine = "block";
    this.screenEmpty = false;
  }
}

Scene.prototype.kindle_search = Scene.prototype.kindle_product = function kindle_search(data) {
  var result = /^\((.+)\) ([^\)]+)/.exec(data);
  if (!result) throw new Error(this.lineMsg()+"Invalid arguments: " + data);
  var query = result[1];
  var buttonName = result[2];
  if ("undefined" != typeof kindleButton) kindleButton(this.target, query, buttonName);
};

// *link
// Display URL with anchor text
Scene.prototype.link = function link(data) {
    var result = /^(\S+)\s*(.*)/.exec(data);
    if (!result) throw new Error(this.lineMsg() + "invalid line; this line should have an URL: " + data);
    var href = result[1].replace(/\]/g, "%5D");
    var anchorText = trim(result[2]) || href;
    this.printLine("[url="+href+"]"+anchorText+"[/url]");
    this.prevLine = "text";
    this.screenEmpty = false;
};

// *link_button
// Display button that takes you to an URL
Scene.prototype.link_button = function linkButton(data) {
    if (typeof window == "undefined") return;
    var result = /^(\S+)\s*(.*)/.exec(data);
    if (!result) throw new Error(this.lineMsg() + "invalid line; this line should have an URL: " + data);
    var href = result[1];
    var anchorText = trim(result[2]) || href;
    this.paragraph();
    var target = this.target;
    if (!target) target = document.getElementById('text');
    printButton(anchorText, target, false, function() {
      window.location.href = href;
    });
    this.prevLine = "empty";
    this.screenEmpty = false;
};

// how many spaces is this line indented?
Scene.prototype.getIndent = function getIndent(line) {
    if (line === null || line === undefined) return 0;
    var spaces = line.match(/^(\s*)/);
    if (spaces === null || spaces === undefined) return 0;
    if (/[^ \t]/.test(spaces[1])) {
      throw new Error(this.lineMsg() + "The indentation on this line includes whitespace that is neither a space nor a tab. Delete the whitespace and replace it with spaces or tabs.");
    }
    var whitespace = spaces[0];
    var len = whitespace.length;
    if (0 === len) return 0;
    var tab = /\t/.test(whitespace);
    var space = / /.test(whitespace);
    if (tab && space) {
        throw new Error(this.lineMsg()+"Tabs and spaces appear on the same line");
    }
    if (tab) {
        this.firstTab = this.lineNum+1;
        if (this.firstSpace) {
            throw new Error(this.lineMsg()+"Illegal mixing of spaces and tabs; this line has a tab, but there were spaces on line " + this.firstSpace);
        }
    } else {
        this.firstSpace = this.lineNum + 1;
        if (this.firstTab) {
            throw new Error(this.lineMsg()+"Illegal mixing of spaces and tabs; this line has a space, but there were tabs on line " + this.firstTab);
        }
    }
    return len;
};

// *comment ignorable text
Scene.prototype.comment = function comment(line) {
    if (this.debugMode) println("*comment " + line);
};

Scene.prototype.advertisement = function advertisement(durationInSeconds) {
  if (/^\s*\*delay_break/.test(this.lines[this.lineNum - 1])) {
    throw new Error(this.lineMsg() + "*advertisement is not allowed immediately after *delay_break (*delay_break includes its own advertisement)");
  }
  if (this.getVar("choice_prerelease") || this.getVar("choice_is_steam")) return;
  var self = this;
  this.finished = true;
  this.skipFooter = true;
  startLoading();
  checkPurchase("adfree", function(ok, result) {
    doneLoading();
    if (result.adfree) {
      self.finished = false;
      self.skipFooter = false;
      self.execute();
      return;
    }
    self.printLine("Come back later to play the next part of [i]${choice_title}[/i]!");
    self.paragraph();
    self.printLine("Or you can buy the game now to skip the wait.");
    self.paragraph();
    self.buyButton("adfree", "$1.99", null, "It");
    self.delay_break(durationInSeconds || 300);
  });
};

// *looplimit 5
// The number of times a given line is allowed to be accessed
Scene.prototype.looplimit = function looplimit(count) {
  this.temps._looplimit = num(count, this.lineNum, this.name);
};

Scene.prototype.hide_reuse = function hide_reuse() {
  this.temps.choice_reuse = "hide";
};

Scene.prototype.disable_reuse = function disable_reuse() {
  this.temps.choice_reuse = "disable";
};

Scene.prototype.allow_reuse = function allow_reuse() {
  this.temps.choice_reuse = "allow";
};

// *label labelName
// Labels a line for use later in *goto
// Do nothing here; these labels are parsed in this.parseLabel
Scene.prototype.label = function label() {};

// *print expr
// print the value of the specified expression
Scene.prototype.print = function scene_print(expr) {
    var value = this.evaluateExpr(this.tokenizeExpr(expr));
    this.prevLine = "text";
    this.screenEmpty = false;
    this.printLine(value);
};

Scene.prototype.parseInputText = function parseInputText(line) {
  var stack = this.tokenizeExpr(line);
  var variable = this.evaluateReference(stack);
  if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
    throw new Error(this.lineMsg() + "Non-existent variable '" + variable + "'");
  }

  var inputOptions = { long: false, allow_blank: false };
  for (var i = 0; i < stack.length; i++) {
    var token = stack[i];
    if (token.name !== "VAR") {
      throw new Error(this.lineMsg() + "Couldn't understand this input_text line");
    }
    var option = token.value;
    if (typeof inputOptions[option] === "undefined") {
      throw new Error(this.lineMsg() + "Couldn't understand this input_text option: " + option);
    }
    inputOptions[option] = true;
  }
  return {variable:variable, inputOptions:inputOptions};
}

// *input_text var
// record text typed by the user and store it in the specified variable
Scene.prototype.input_text = function input_text(line) {
    var result = this.parseInputText(line);
    var variable = result.variable;

    this.finished = true;
    this.paragraph();
    var self = this;
    printInput(this.target, result.inputOptions, function(value) {
      safeCall(self, function() {
        value = trim(String(value));
        value = value.replace(/\n/g, "[n/]");
        if (self.nav) self.nav.bugLog.push("*input_text " + variable + " " + value);
        self.finished = false;
        self.setVar(variable, value);
        self.resetPage();
      });
    });
    if (this.debugMode) println(computeCookie(this.stats, this.temps, this.lineNum, this.indent));
};

// *input_number var min max
// record number typed by the user and store it in the specified variable
Scene.prototype.input_number = function input_number(data) {
    var stack = this.tokenizeExpr(data);
    if (!stack.length) throw new Error(this.lineMsg() + "Invalid input_number statement, expected three args: varname min max");
    var variable = this.evaluateReference(stack);
    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }

    var simpleConstants;
    if (stack.length == 2 && stack[0].name == "NUMBER" && stack[1].name == "NUMBER") {
      simpleConstants = true;
    } else {
      simpleConstants = false;
    }

    if (!stack.length) throw new Error(this.lineMsg() + "Invalid input_number statement, expected three args: varname min max");
    var minimum = this.evaluateValueToken(stack.shift(), stack);
    if (isNaN(minimum*1)) throw new Error(this.lineMsg() + "Invalid minimum, not numeric: " + minimum);
    if (!stack.length) throw new Error(this.lineMsg() + "Invalid input_number statement, expected three args: varname min max");

    var maximum = this.evaluateValueToken(stack.shift(), stack);
    if (stack.length) throw new Error(this.lineMsg() + "Invalid input_number statement, expected three args: varname min max");
    if (isNaN(maximum*1)) throw new Error(this.lineMsg() + "Invalid maximum, not numeric: " + maximum);

    // in quicktest, min and max can get mixed up as the interpreter "cheats" on if statements
    // so quicktest will ignore min/max errors unless they're simple constants e.g. *input_number x 6 4
    var checkMinMax = !this.quicktest || simpleConstants;
    if (checkMinMax && parseFloat(minimum) > parseFloat(maximum)) {
      throw new Error(this.lineMsg() + "Minimum " + minimum+ " should not be greater than maximum " + maximum);
    }

    function isInt(x) {
       var y=parseInt(x,10);
       if (isNaN(y)) return false;
       return x==y && x.toString()==y.toString();
    }
    var intRequired;
    if (isInt(minimum) && isInt(maximum)) {
      intRequired = 1;
    }
    this.finished = true;
    this.paragraph();
    var self = this;
    printInput(this.target, {numeric: true}, function(value) {
      safeCall(self, function() {
        var numValue = parseFloat(""+value);
        if (isNaN(numValue)) {
          asyncAlert("Please type in a number.");
          return;
        }
        if (intRequired && !isInt(value)) {
          asyncAlert("Please type in an integer number.");
          return;
        }
        if (numValue < minimum * 1) {
          asyncAlert("Please use a number greater than or equal to " + minimum);
          return;
        }
        if (numValue > maximum * 1 && !this.quicktest) {
          asyncAlert("Please use a number less than or equal to " + maximum);
          return;
        }
        if (self.nav) self.nav.bugLog.push("*input_number " + variable + " " + value);
        self.finished = false;
        self.setVar(variable, numValue);
        self.resetPage();
      });
    }, minimum, maximum, intRequired);
    if (this.debugMode) println(computeCookie(this.stats, this.temps, this.lineNum, this.indent));
};

// *script code
// evaluate the specified ECMAScript
Scene.prototype.script = function script(code) {
    var stats = this.stats;
    var temps = this.temps;
    try {
      if (typeof window == "undefined") {
        (function() {
          var window = _global;
          eval(code);
        }).call(this);
      } else {
        eval(code);
      }
    } catch (e) {
      throw new Error(this.lineMsg() + "error executing *script: " + e + (e.stack ? "\n" + e.stack : ""));
    }
};

// is this a valid variable name?
Scene.prototype.validateVariable = function validateVariable(variable) {
    if (!variable || !/^[a-zA-Z]/.test(variable)) {
        throw new Error(this.lineMsg()+"Invalid variable name, must start with a letter: " + variable);
    }
    if (!/^\w+$/.test(variable)) {
        throw new Error(this.lineMsg()+"Invalid variable name: '" + variable + "'");
    }
    if (/^(and|or|true|false|scene|scenename)$/i.test(variable)) throw new Error(this.lineMsg()+"Invalid variable name, '" + variable + "' is a reserved word");
    if (/^choice_/.test(variable)) throw new Error(this.lineMsg()+"Invalid variable name, variables may not start with 'choice_'; this is a reserved prefix");
};

// *rand varname min max
// Set varname to a random number from min to max
//
// Example:
// *rand foo 1 6
//   roll a cube die
// *rand foo 1.0 6.0
//   compute a decimal from [1.0,6.0)
Scene.prototype.rand = function rand(data) {
    var stack = this.tokenizeExpr(data);
    if (!stack.length) throw new Error(this.lineMsg() + "Invalid rand statement, expected three args: varname min max");
    var variable = this.evaluateReference(stack);
    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }

    if (!stack.length) throw new Error(this.lineMsg() + "Invalid rand statement, expected three args: varname min max");
    var minimum = this.evaluateValueToken(stack.shift(), stack);
    if (!stack.length) throw new Error(this.lineMsg() + "Invalid rand statement, expected three args: varname min max");
    var maximum = this.evaluateValueToken(stack.shift(), stack);
    if (stack.length) throw new Error(this.lineMsg() + "Invalid rand statement, expected three args: varname min max");
    var diff;

    diff = maximum - minimum;
    if (isNaN(diff)) {
        throw new Error(this.lineMsg() + "Invalid rand statement, min and max must be numbers");
    }
    if (diff < 0) {
        throw new Error(this.lineMsg() + "Invalid rand statement, min must be less than max: " + minimum + " > " + maximum);
    }
    if (diff === 0) {
      this.setVar(variable, minimum);
      return;
    }
    function isInt(x) {
       var y=parseInt(x,10);
       if (isNaN(y)) return false;
       return x==y && x.toString()==y.toString();
    }
    var result;
    var random = Math.random();
    if (isInt(minimum) && isInt(maximum)) {
        // int random
        result = 1*minimum + Math.floor(random*(diff+1));
    } else {
        result = 1*minimum + random*diff;
    }
    this.setVar(variable, result);
    if (this.randomLog) {
      this.randomLog("*rand " + variable + " " + result);
    }
    if (this.nav) this.nav.bugLog.push("*rand " + variable + " " + result);
};

// *set varname expr
// sets the specified varname to the value of the expr
//
// Examples:
//
// literal
//     literal int: 2
//     literal decimal: 2.3
//     boolean value: true
//     quoted string: "fie"
//         with backslash escaping "she said it was \"ironic\"!"  "c:\\foo"
//     variable name: foo
//
// math
//     +: 2+2
//     -: foo-3
//     *: 2*3
//     /: 8/2
//     if one operand is a string, we'll try to parse it as a number, fail if that doesn't work
//
// fairmath
//     %+: foo%+30
//     %-: foo%-20
//
// concatenate
//     &: "foo"&bar
//
// may omit leading operand
//     *set foo +2
//     *set foo %+30
//     *set foo &"blah blah"
//
// spaces optional
//     *set foo+2
//     *set foo bar + 2
//     *set bar% +30
//
// multiple operators in one line, parentheses mandatory
//     *set foo (foo+2)/4
//     *set foo 2+(foo/2)
//     *set foo (foo/2)+(bar/3)
//     *set foo +(bar/3)
//
// set variable by reference
//
//     *set foo bar
//     *set {foo} 3
//     *comment now bar=3
Scene.prototype.set = function set(line) {
    var stack = this.tokenizeExpr(line);
    var variable = this.evaluateReference(stack);
    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }
    if (stack.length === 0) throw new Error(this.lineMsg()+"Invalid set instruction, no expression specified: " + line);
    // if the first token is an operator, then it's implicitly based on the variable
    if (/OPERATOR|FAIRMATH/.test(stack[0].name)) stack.unshift({name:"VAR", value:variable, pos:"(implicit)"});
    var value = this.evaluateExpr(stack);
    this.setVar(variable, value);
};

// *setref variableExpr expr
// just like *set, but variableExpr is a string expression naming a variable reference
//
// Example:
// *set foo "bar"
// *setref foo 3
// *comment now bar=3
Scene.prototype.setref = function setref(line) {
    var stack = this.tokenizeExpr(line);
    var variable = this.evaluateValueToken(stack.shift(), stack);
    variable = String(variable).toLowerCase();

    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }

    // if the first token is an operator, then it's implicitly based on the variable
    if (/OPERATOR|FAIRMATH/.test(stack[0].name)) stack.unshift({name:"VAR", value:variable, pos:"(implicit)"});
    var value = this.evaluateExpr(stack);
    this.setVar(variable, value);
};

Scene.prototype.share_this_game = function share_links(now) {
  now = !!trim(now);
  this.paragraph();
  printShareLinks(this.target, now);
  this.prevLine = "empty"; // printShareLinks provides its own paragraph break
};

Scene.prototype.more_games = function more_games(now) {
  if (typeof window == "undefined" || typeof moreGames == "undefined") return;
  if (!!trim(now)) {
    moreGames();
    return;
  }
  var self = this;
  this.paragraph();
  var target = this.target;
  if (!target) target = document.getElementById('text');
  var button = printButton("Play More Games Like This", target, false,
    function() {
      safeCall(self, moreGames);
    }
  );

  setClass(button, "");
  this.prevLine = "block";
};

Scene.prototype.ending = function ending() {
    if (typeof window == "undefined") return;
    this.paragraph();
    var groups = [""];
    options = [];
    options.push({name:"Play again.", group:"choice", restart:true});
    if (!window.isOmnibusApp) options.push({name:"Play more games like this.", group:"choice", moreGames:true});
    options.push({name:"Share this game with friends.", group:"choice", share:true});
    options.push({name:"Email me when new games are available.", group:"choice", subscribe:true});

    var self = this;
    function endingMenu() {
      printFollowButtons();
      self.renderOptions([""], options, function(option) {
        if (option.restart) {
          return restartGame();
        } else if (option.moreGames) {
          self.more_games("now");
          if (typeof curl != "undefined") curl();
        } else if (option.share) {
          clearScreen(function() {
            self.share_this_game("now");
            endingMenu();
          });
        } else if (option.subscribe) {
          subscribeLink();
        }
      });
    }
    endingMenu();
    this.finished = true;
};

Scene.prototype.restart = function restart() {
  delayBreakEnd();
  if (this.secondaryMode) {
    if (this.secondaryMode == "stats") {
      this.reset();
      this.redirect_scene(this.nav.getStartupScene());
    } else {
      throw new Error(this.lineMsg() + "Cannot *restart in " + this.secondaryMode + " mode");
    }
  } else {
    restartGame();
  }
  this.finished = true;
};

/* Subscribe options, in JSON format.
"now" on mobile means we should immediately mailto: the subscribe address
otherwise, we should display a Subscribe button which launches the mailto:
On non-mailte: platforms, we ignore "now"

"allowContinue" is the default; setting it to false blocks the "No, Thanks"
button and the "Next" button after successfully subscribing
Only Coming Soon pages use "allowContinue"

"message" is the message we'll show to justify subscribing
the default message is: "we'll notify you when our next game is ready!" */
Scene.prototype.subscribe = function scene_subscribe(data) {
  this.paragraph();
  var options = {};
  if (data) {
    try {
      options = JSON.parse(data);
    } catch (e) {
      throw new Error(this.lineMsg() + "Couldn't parse subscribe arguments: " + data);
    }
  }
  this.prevLine = "block";
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  subscribe(this.target, options, function(now) {
    self.finished = false;
    // if "now" actually worked, then continue the scene
    // otherwise, reset the page before continuing
    if (now) {
      self.skipFooter = false;
      self.execute();
    } else {
      self.resetPage();
    }
  });
};

Scene.prototype.restore_game = function restore_game(data) {
  var cancelLabel;
  if (data) {
    var result = /^cancel=(\S+)$/.exec(data);
    if (!result) throw new Error(this.lineMsg() + "invalid restore_game line: " + data);
    cancelLabel = result[1];
  }
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  var daysToUndelete = 30;
  var unrestorableScenes = this.parseRestoreGame(false/*alreadyFinished*/);
  function renderRestoreMenu(saveList, dirtySaveList) {
    var recentlyDeletedCount = 0;
    self.paragraph();
    var options = [];
    for (var i = 0; i < saveList.length; i++) {
      var save = saveList[i];
      var date = new Date(save.timestamp*1);
      if (!save) continue;
      var name = "";
      if (save.temps && save.temps.choice_restore_name) name = save.temps.choice_restore_name;
      if (save.deleted) {
        if (!save.undeleted || save.undeleted < save.deleted) {
          if ((Date.now() - save.deleted) < daysToUndelete * 1000 * 60 * 60 * 24) {
            recentlyDeletedCount++;
          }
          continue;
        }
      }
      options.push({name:name + " ("+simpleDateTimeFormat(date)+")", group:"choice", state:save});
    }
    var anythingToDelete = options.length > 0;
    if (false) options.push({name:"Restore using a password.", group:"choice", password:true});
    options.push({name:"Retrieve saved games online from choiceofgames.com.", group:"choice", fetch:true});
    if (anythingToDelete) options.push({ name: "Delete saves.", group: "choice", deleting: true });
    if (recentlyDeletedCount) {
      var recentlyDeletedMessage;
      if (recentlyDeletedCount === 1) {
        recentlyDeletedMessage = "1 save recently deleted."
      } else {
        recentlyDeletedMessage = recentlyDeletedCount + " saves recently deleted."
      }
      options.push({ name: "Undelete saves. (" + recentlyDeletedMessage + ")", group: "choice", undeleting: true });
    }
    if (dirtySaveList.length) options.push({name:"Upload saved games to choiceofgames.com.", group:"choice", upload:true});
    options.push({name:"Cancel.", group:"choice", cancel:true});
    var groups = [""];
    self.renderOptions(groups, options, function(option) {
      function synchronizeBeforeEdit(renderMenu) {
        clearScreen(function () {
          fetchEmail(function (defaultEmail) {
            self.printLine("Please type your email address to identify yourself.");
            self.paragraph();
            promptEmailAddress(this.target, defaultEmail, "allowContinue", function (cancel, email) {
              if (cancel) {
                self.finished = false;
                if (typeof cancelLabel !== "undefined") {
                  self["goto"](cancelLabel);
                }
                self.resetPage();
                return;
              }
              clearScreen(function () {
                startLoading();
                getRemoteSaves(email, function (remoteSaveList) {
                  doneLoading();
                  self.prevLine = "text";
                  if (!remoteSaveList) {
                    self.printLine("Error downloading saves. Please try again later.");
                    renderRestoreMenu(saveList, dirtySaveList);
                  } else {
                    mergeRemoteSaves(remoteSaveList, "recordDirty", function (saveList, newRemoteSaves, dirtySaveList) {
                      if (dirtySaveList && dirtySaveList.length) {
                        submitDirtySaves(dirtySaveList, email, function (ok) {
                          if (ok) {
                            renderMenu(email);
                          } else {
                            self.printLine("Error downloading saves. Please try again later.");
                            renderRestoreMenu(saveList, dirtySaveList);
                          }
                        });
                      } else {
                        renderMenu(email);
                      }
                    });
                  }
                });
              });
            });
          });
        });
      }


      if (option.upload) {
        clearScreen(function() {
          fetchEmail(function(defaultEmail){
            self.printLine("Please type your email address to identify yourself.");
            self.paragraph();
            promptEmailAddress(this.target, defaultEmail, "allowContinue", function(cancel, email) {
              if (cancel) {
                self.finished = false;
                if (typeof cancelLabel !== "undefined") {
                  self["goto"](cancelLabel);
                }
                self.resetPage();
                return;
              }
              clearScreen(function() {
                startLoading();
                submitDirtySaves(dirtySaveList, email, function(ok) {
                  doneLoading();
                  self.prevLine = "text"; // Put some space between the message and the option list
                  if (!ok) {
                    self.printLine("Error uploading saves. Please try again later.");
                    renderRestoreMenu(saveList, dirtySaveList);
                  } else {
                    var count = dirtySaveList.length + (dirtySaveList.length == 1 ? " save" : " saves");
                    self.printLine("Uploaded " + count + ".");
                    renderRestoreMenu(saveList, []);
                  }
                });
              });
            });
          });
        });
      } else if (option.fetch) {
        clearScreen(function() {
          fetchEmail(function(defaultEmail){
            self.printLine("Please type your email address to identify yourself.");
            self.paragraph();
            promptEmailAddress(this.target, defaultEmail, "allowContinue", function(cancel, email) {
              if (cancel) {
                self.finished = false;
                if (typeof cancelLabel !== "undefined") {
                  self["goto"](cancelLabel);
                }
                self.resetPage();
                return;
              }
              clearScreen(function() {
                startLoading();
                getRemoteSaves(email, function (remoteSaveList) {
                  doneLoading();
                  self.prevLine = "text";
                  if (!remoteSaveList) {
                    self.printLine("Error downloading saves. Please try again later.");
                    renderRestoreMenu(saveList, dirtySaveList);
                  } else {
                    mergeRemoteSaves(remoteSaveList, "recordDirty", function(saveList, newRemoteSaves, dirtySaveList) {
                      if (!remoteSaveList.length) {
                        self.printLine("No saves downloaded for email address \""+email+"\". (Is that the correct email address?) If you're having trouble, please contact support at "+getSupportEmail()+".");
                        renderRestoreMenu(saveList, dirtySaveList);
                      } else {
                        var downloadCount = remoteSaveList.length + " saved " + (remoteSaveList.length == 1 ? "game" : "games");
                        var newCount = newRemoteSaves + " new saved " + (newRemoteSaves == 1 ? "game" : "games");
                        self.printLine("Synchronized " + downloadCount + ". Downloaded " + newCount + ".");
                        renderRestoreMenu(saveList, dirtySaveList);
                      }
                    });
                  }
                });
              });
            });
          });
        });
      } else if (option.deleting) {
        synchronizeBeforeEdit(function renderDeleteMenu(email) {
          var options = [];
          for (var i = 0; i < saveList.length; i++) {
            var save = saveList[i];
            var date = new Date(save.timestamp * 1);
            if (!save) continue;
            if (save.deleted) {
              if (!save.undeleted || save.undeleted < save.deleted) {
                continue;
              }
            }
            var name = "";
            if (save.temps && save.temps.choice_restore_name) name = save.temps.choice_restore_name;
            options.push({ name: name + " (" + simpleDateTimeFormat(date) + ")", group: "choice", state: save });
          }
          if (!options.length) {
            self.printLine("There are no saves to delete.");
            renderRestoreMenu(saveList, dirtySaveList);
            return;
          }
          function submitButtonNameFunction(count) {
            if (count == 1) {
              return "Delete 1 Save";
            } else {
              return "Delete " + count + " Saves";
            }
          }
          printCheckboxes(options, submitButtonNameFunction, function (results) {
            startLoading();
            var deletionDate = Date.now();
            clearScreen(function () {
              Promise.all(results.map(function (result, i) {
                if (result) {
                  return new Promise(function (resolve, reject) {
                    var save = options[i].state;
                    var slot = "save" + save.timestamp;
                    var oldDeleted = save.deleted;
                    save.deleted = deletionDate;
                    var value = computeCookie(save.stats, save.temps, save.lineNum, save.indent, save.deleted, save.undeleted);
                    writeCookie(value, slot, function(ok) {
                      submitRemoteSave(slot, email, !"subscribe", function (ok) {
                        if (ok) {
                          resolve();
                        } else {
                          save.deleted = oldDeleted;
                          var value = computeCookie(save.stats, save.temps, save.lineNum, save.indent, save.deleted, save.undeleted);
                          writeCookie(value, slot, function () {});
                          reject(new Error("Failed submitting " + slot));
                        }
                      })
                    })
                  });
                }
              })).then(function () {
                doneLoading();
                renderRestoreMenu(saveList, dirtySaveList);
              }).catch(function(err) {
                self.printLine("There was an error deleting saves. Please try again later.");
                renderRestoreMenu(saveList, dirtySaveList);
              });
            });
          });
          printFooter();
        });
      } else if (option.undeleting) {
        synchronizeBeforeEdit(function renderUndeleteMenu(email) {
          var options = [];
          for (var i = 0; i < saveList.length; i++) {
            var save = saveList[i];
            var date = new Date(save.timestamp * 1);
            if (!save) continue;
            if (!save.deleted || save.deleted < save.undeleted) {
              continue;
            }
            var name = "";
            if (save.temps && save.temps.choice_restore_name) name = save.temps.choice_restore_name;
            options.push({ name: name + " (" + simpleDateTimeFormat(date) + ")", group: "choice", state: save });
          }
          if (!options.length) {
            self.printLine("There are no recently deleted saves to undelete.");
            renderRestoreMenu(saveList, dirtySaveList);
            return;
          }
          function submitButtonNameFunction(count) {
            if (count == 1) {
              return "Undelete 1 Save";
            } else {
              return "Undelete " + count + " Saves";
            }
          }
          printCheckboxes(options, submitButtonNameFunction, function (results) {
            startLoading();
            var undeletionDate = Date.now();
            clearScreen(function () {
              Promise.all(results.map(function (result, i) {
                if (result) {
                  return new Promise(function (resolve) {
                    var save = options[i].state;
                    var slot = "save" + save.timestamp;
                    var oldUndeleted = save.undeleted;
                    save.undeleted = undeletionDate;
                    var value = computeCookie(save.stats, save.temps, save.lineNum, save.indent, save.deleted, save.undeleted);
                    writeCookie(value, slot, function (ok) {
                      submitRemoteSave(slot, email, !"subscribe", function (ok) {
                        if (ok) {
                          resolve();
                        } else {
                          save.undeleted = oldUndeleted;
                          var value = computeCookie(save.stats, save.temps, save.lineNum, save.indent, save.deleted, save.undeleted);
                          writeCookie(value, slot, function () { });
                          reject(new Error("Failed submitting " + slot));
                        }
                      })
                    })
                  });
                }
              })).then(function () {
                doneLoading();
                renderRestoreMenu(saveList, dirtySaveList);
              }).catch(function (err) {
                self.printLine("There was an error undeleting saves. Please try again later.");
                renderRestoreMenu(saveList, dirtySaveList);
              });
            });
          });
          printFooter();
        });
      } else if (option.password) {
        clearScreen(function() {
          self.restore_password();
        });
      } else {
        if (option.cancel) {
          self.finished = false;
          if (typeof cancelLabel !== "undefined") {
            self["goto"](cancelLabel);
          }
          self.resetPage();
        } else {
          var state = option.state;
          var sceneName = null;
          if (state.stats && state.stats.sceneName) sceneName = (""+state.stats.sceneName).toLowerCase();
          var unrestorable = unrestorableScenes[sceneName];

          if (unrestorable) {
            asyncAlert(unrestorable);
            self.finished = false;
            self.resetPage();
            return;
          }

          saveCookie(function() {
            clearScreen(function() {
              restoreGame(state, null, /*userRestored*/true);
            });
          }, "", state.stats, state.temps, state.lineNum, state.indent);
        }
      }
    });
  }
  getDirtySaveList(function(dirtySaveList) {
    getSaves(function(saveList) {
      renderRestoreMenu(saveList, dirtySaveList);
    });
  });
};

Scene.prototype.restore_password = function restore_password() {
  var alreadyFinished = this.finished;
  this.finished = true;
  this.paragraph();
  this.printLine('Please paste your password here, then press "Next" below to continue.');
  this.prevLine = "text";
  this.paragraph();
  var self = this;
  var unrestorableScenes = this.parseRestoreGame(alreadyFinished);
  getPassword(this.target, function (cancel, password) {
    if (cancel) {
      self.finished = false;
      self.resetPage();
      return;
    }
    password = password.replace(/\s/g, "");
    password = password.replace(/^.*BEGINPASSWORD-----/, "");
    var token = self.deobfuscatePassword(password);
    token = token.replace(/^[^\{]*/, "");
    token = token.replace(/[^\}]*$/, "");
    var state;
    try {
      state = jsonParse(token);
    } catch (e) {
      asyncAlert("Sorry, that password was invalid. Please contact " + getSupportEmail() + " for assistance. Be sure to include your password in the email.");
      return;
    }

    var sceneName = null;
    if (state.stats && state.stats.sceneName) sceneName = (""+state.stats.sceneName).toLowerCase();

    var unrestorable = unrestorableScenes[sceneName];
    if (unrestorable) {
      asyncAlert(unrestorable);
      self.finished = false;
      self.resetPage();
      return;
    }

    saveCookie(function() {
      clearScreen(function() {
        // we're going to pretend not to be user restored, so we get reprompted to save
        restoreGame(state, null, /*userRestored*/false);
      });
    }, "", state.stats, state.temps, state.lineNum, state.indent);
  });
  if (alreadyFinished) printFooter();
};

Scene.prototype.parseRestoreGame = function parseRestoreGame(alreadyFinished) {
    if (alreadyFinished) {
      // if we're already finished, the printLoop bumped us an extra line ahead
      this.lineNum--;
      this.rollbackLineCoverage();
    }
    // nextIndent: the level of indentation after the current line
    var nextIndent = null;
    var unrestorableScenes = {};
    var line;
    var startIndent = this.indent;
    while(isDefined(line = this.lines[++this.lineNum])) {
        if (!trim(line)) {
            this.rollbackLineCoverage();
            continue;
        }
        var indent = this.getIndent(line);
        if (nextIndent === null || nextIndent === undefined) {
            // initialize nextIndent with whatever indentation the line turns out to be
            // ...unless it's not indented at all
            if (indent > startIndent) {
                this.indent = nextIndent = indent;
            }
        }
        if (indent <= startIndent) {
            // it's over!
            if (!alreadyFinished) {
              this.lineNum--;
              this.rollbackLineCoverage();
            }
            return unrestorableScenes;
        }
        if (indent != this.indent) {
            // all chart rows are supposed to be at the same indentation level
            // anything at the wrong indentation level might be a mis-indented title/definition
            // or just a typo
            throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
        }

        //
        // *restore_game
        //   ending You can't restore to the ending.

        line = trim(line);
        var result = /^(\w+)\s+(.*)/.exec(line);
        if (!result) throw new Error(this.lineMsg() + "invalid line; this line should have a scene name followed by an error message: " + line);
        var sceneName = result[1].toLowerCase();
        var error = trim(result[2]);
        unrestorableScenes[sceneName] = error;
    }
    if (!alreadyFinished) {
      this.lineNum--;
      this.rollbackLineCoverage();
    }
    return unrestorableScenes;
};

Scene.prototype.check_registration = function scene_checkRegistration() {
  if (typeof window == "undefined" || typeof isRegistered == "undefined") return;
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  isRegistered(function() {
    self.finished = false;
    self.skipFooter = false;
    self.execute();
  });
};

Scene.prototype.login = function scene_login(optional) {
  if (typeof window == "undefined" || typeof loginForm == "undefined") return;
  optional = trim(optional);
  if (optional) {
    if (optional != "optional") throw new Error(this.lineMsg() + "invalid *login option: " + optional);
    optional = 1;
  }
  var self = this;
  this.finished = true;
  this.skipFooter = true;
  this.paragraph();
  var target = this.target;
  if (!target) target = document.getElementById('text');
  loginForm(target, optional, null, function() {
    clearScreen(function() {
      self.finished = false;
      self.prevLine = "empty";
      self.screenEmpty = true;
      self.execute();
    });
  });
};

Scene.prototype.save_game = function save_game(destinationSceneName) {
  if (!destinationSceneName) throw new Error(this.lineMsg()+"*save_game requires a destination file name, e.g. *save_game Episode2");
  if (this.temps.choice_user_restored) return;
  var self = this;
  this.finished = true;
  this.skipFooter = true;
  fetchEmail(function(defaultEmail){
    self.paragraph();
    var form = document.createElement("form");
    setClass(form, "saveGame");

    form.action="#";

    var message = document.createElement("div");
    message.style.color = "red";
    message.style.fontWeight = "bold";
    form.appendChild(message);

    var saveName = document.createElement("input");
    saveName.type="text";
    saveName.name="saveName";
    saveName.setAttribute("placeholder", "Type a name for your saved game");
    saveName.setAttribute("style", "display:block; font-size: 25px; width: 90%; margin: 1rem 0");
    form.appendChild(saveName);

    var hideEmailForm = false;
    // hideEmailForm = _global.automaticCloudStorage;
    if (!hideEmailForm) {
      println("Please login to the choiceofgames.com save system with your email address below.", form);

      var emailInput = document.createElement("input");
      // This can fail on IE
      try { emailInput.type="email"; } catch (e) {}
      emailInput.name="email";
      emailInput.value=defaultEmail;
      emailInput.setAttribute("placeholder", "you@example.com");
      emailInput.setAttribute("style", "display:block; font-size: 25px; width: 90%; margin: 1rem 0");
      form.appendChild(emailInput);

      var subscribeLabel = document.createElement("label");
      subscribeLabel.setAttribute("for", "subscribeBox");
      var subscribeBox = document.createElement("input");
      subscribeBox.type = "checkbox";
      subscribeBox.name = "subscribe";
      subscribeBox.setAttribute("id", "subscribeBox");
      subscribeBox.setAttribute("checked", true);
      subscribeLabel.appendChild(subscribeBox);
      subscribeLabel.appendChild(document.createTextNode("Email me when new games are available."));
      form.appendChild(subscribeLabel);
    }

    var target = this.target;
    if (!target) target = document.getElementById('text');
    target.appendChild(form);
    printButton("Next", form, true);

    printButton("Cancel", target, false, function() {
      clearScreen(function() {
        self.finished = false;
        self.prevLine = "empty";
        self.screenEmpty = true;
        self.execute();
      });
    });

    form.onsubmit = function(e) {
      preventDefault(e);
      safeCall(this, function() {
        var messageText;
        if (!trim(saveName.value)) {
          messageText = document.createTextNode("Please type a name for your saved game.");
          message.innerHTML = "";
          message.appendChild(messageText);
          return;
        }

        var slot = "save" + new Date().getTime();
        // create a clone stats object whose scene name is the destination scene
        var saveStats = {};
        for (var stat in self.stats) {
          if ("scene" == stat) continue;
          saveStats[stat] = self.stats[stat];
        }
        saveStats.scene = {name:destinationSceneName};

        if (hideEmailForm) {
          clearScreen(function() {
            saveCookie(function() {
              recordSave(slot, function() {
                self.finished = false;
                self.prevLine = "empty";
                self.screenEmpty = true;
                self.execute();
              });
            }, slot, saveStats, {choice_reuse:"allow", choice_user_restored:true, choice_restore_name:saveName.value}, 0, 0);
          });
          return;
        }

        var shouldSubscribe = subscribeBox.checked;
        var subscribe = shouldSubscribe && (window.isHeartsChoice ? "hc" : "cog");
        var email = trim(emailInput.value);
        if (!/^\S+@\S+\.\S+$/.test(email)) {
          messageText = document.createTextNode("Sorry, \""+email+"\" is not an email address.  Please type your email address again.");
          message.innerHTML = "";
          message.appendChild(messageText);
          return;
        }

        recordEmail(email, function() {
          clearScreen(function() {
            saveCookie(function() {
              recordSave(slot, function() {
                startLoading();
                submitRemoteSave(slot, email, subscribe, function(ok) {
                  doneLoading();
                  if (!ok) {
                    asyncAlert("Couldn't upload your saved game to choiceofgames.com. You can try again later from the Restore menu.", function() {
                      self.finished = false;
                      self.prevLine = "empty";
                      self.screenEmpty = true;
                      self.execute();
                    });
                  } else {
                    self.finished = false;
                    self.prevLine = "empty";
                    self.screenEmpty = true;
                    self.execute();
                  }
                });
              });
            }, slot, saveStats, {choice_reuse:"allow", choice_user_restored:true, choice_restore_name:saveName.value}, 0, 0);
          });
        });
      });
    };

    printFooter();
  });
};

Scene.prototype.show_password = function show_password() {
  if (this.temps.choice_user_restored) return;
  this.paragraph();
  if (typeof(window) != "undefined" && !window.isMobile) {
    this.printLine('Please copy and paste the password in a safe place, then press "Next" below to continue.');
    println("", this.target);
    println("", this.target);
  }
  var password = computeCookie(this.stats, this.temps, this.lineNum, this.indent);
  password = this.obfuscate(password);
  showPassword(this.target, password);
  this.prevLine = "block";
};

Scene.prototype.obfuscate = function obfuscate(password) {
  var self = this;
  return password.replace(/./g,
    function(x) {
      var y = self.obfuscator[x];
      return y;
    }
  );
};

// The obfuscator must take US-ASCII and obfuscate it
// for use in a password.  This password will be sent via
// HTML email and its whitespace handling will be unpredictable,
// So we can't output any of these characters: [ <>&]
// Since we're losing four characters of output, we JSON-escape
// four characters of input [^`|~].
Scene.prototype.obfuscator = {
  " ": "k",
  "!": "E",
  "\"": "`",
  "#": "\\",
  "$": "r",
  "%": "J",
  "&": "o",
  "'": "0",
  "(": "Z",
  ")": "M",
  "*": "G",
  "+": "t",
  ",": "Y",
  "-": "f",
  ".": "2",
  "/": "!",
  "0": "i",
  "1": "*",
  "2": "1",
  "3": "3",
  "4": "[",
  "5": "6",
  "6": "v",
  "7": "\"",
  "8": "F",
  "9": "9",
  ":": "{",
  ";": "Q",
  "<": "?",
  "=": "5",
  ">": "#",
  "?": "K",
  "@": "/",
  "A": "=",
  "B": "N",
  "C": "z",
  "D": "$",
  "E": "W",
  "F": "(",
  "G": ")",
  "H": "q",
  "I": "C",
  "J": "+",
  "K": "U",
  "L": ".",
  "M": "H",
  "N": "B",
  "O": "S",
  "P": "X",
  "Q": "I",
  "R": "-",
  "S": "m",
  "T": "D",
  "U": "^",
  "V": "A",
  "W": "a",
  "X": "y",
  "Y": ",",
  "Z": "d",
  "[": "O",
  "\\": "s",
  "]": "8",
  "^": "sVii6h",
  "_": "]",
  "`": "sViivi",
  "a": "4",
  "b": "g",
  "c": "%",
  "d": "w",
  "e": "h",
  "f": "n",
  "g": "b",
  "h": "7",
  "i": "x",
  "j": "~",
  "k": "_",
  "l": "l",
  "m": ":",
  "n": "c",
  "o": "L",
  "p": "j",
  "q": "u",
  "r": "R",
  "s": "}",
  "t": "p",
  "u": "V",
  "v": "P",
  "w": "'",
  "x": "T",
  "y": "|",
  "z": "@",
  "{": "e",
  "|": "sVii\"%",
  "}": ";",
  "~": "sVii\"h"
};
Scene.prototype.deobfuscator = {
  "k": " ",
  "E": "!",
  "`": "\"",
  "\\": "#",
  "r": "$",
  "J": "%",
  "o": "&",
  "0": "'",
  "Z": "(",
  "M": ")",
  "G": "*",
  "t": "+",
  "Y": ",",
  "f": "-",
  "2": ".",
  "!": "/",
  "i": "0",
  "*": "1",
  "1": "2",
  "3": "3",
  "[": "4",
  "6": "5",
  "v": "6",
  "\"": "7",
  "F": "8",
  "9": "9",
  "{": ":",
  "Q": ";",
  "?": "<",
  "5": "=",
  "#": ">",
  "K": "?",
  "/": "@",
  "=": "A",
  "N": "B",
  "z": "C",
  "$": "D",
  "W": "E",
  "(": "F",
  ")": "G",
  "q": "H",
  "C": "I",
  "+": "J",
  "U": "K",
  ".": "L",
  "H": "M",
  "B": "N",
  "S": "O",
  "X": "P",
  "I": "Q",
  "-": "R",
  "m": "S",
  "D": "T",
  "^": "U",
  "A": "V",
  "a": "W",
  "y": "X",
  ",": "Y",
  "d": "Z",
  "O": "[",
  "s": "\\",
  "8": "]",
  "]": "_",
  "4": "a",
  "g": "b",
  "%": "c",
  "w": "d",
  "h": "e",
  "n": "f",
  "b": "g",
  "7": "h",
  "x": "i",
  "~": "j",
  "_": "k",
  "l": "l",
  ":": "m",
  "c": "n",
  "L": "o",
  "j": "p",
  "u": "q",
  "R": "r",
  "}": "s",
  "p": "t",
  "V": "u",
  "P": "v",
  "'": "w",
  "T": "x",
  "|": "y",
  "@": "z",
  "e": "{",
  ";": "}"
};

Scene.prototype.deobfuscatePassword = function deobfuscatePassword(password) {
  var self = this;
  password = password.replace(/./g,
    function(x) {
      var y = self.deobfuscator[x];
      return y;
    }
  );
  return password;
};

Scene.prototype.stat_chart = function stat_chart() {
  this.paragraph();
  var rows = this.parseStatChart();
  var target = this.target;
  if (!target) target = document.getElementById('text');

  var barWidth = 0;
  var standardFontSize = 0;

  function fixFontSize(span1, span2) {
    if (!standardFontSize) {
      if (window.getComputedStyle) {
        standardFontSize = parseInt(getComputedStyle(document.body).fontSize, 10);
      } else if (document.body.currentStyle) {
        standardFontSize = parseInt(document.body.currentStyle.fontSize, 10);
      } else {
        standardFontSize = 16;
      }
    }
    if (!barWidth) barWidth = span1.parentNode.offsetWidth;
    var spanMaxWidth, biggestSpanWidth;
    if (span2) {
      spanMaxWidth = barWidth / 2 - 1; /* minus one as a fudge factor; why is this needed? */
      biggestSpanWidth = Math.max(span1.offsetWidth, span2.offsetWidth);
    } else {
      spanMaxWidth = barWidth;
      biggestSpanWidth = span1.offsetWidth;
    }

    if (biggestSpanWidth > spanMaxWidth) {
      var newSize = Math.floor(standardFontSize * spanMaxWidth / biggestSpanWidth);
      span1.parentNode.style.fontSize = newSize + "px";
      if (window.getComputedStyle) {
        // on Android, if the user is using non-standand styles, browser may try to ignore our font setting
        var actual = parseInt(getComputedStyle(span1).fontSize, 10);
        if (actual > newSize) {
          newSize *= newSize / actual;
          span1.parentNode.style.fontSize = newSize + "px";
        }
      }
    }

  }

  for (i = 0; i < rows.length; i++) {
    var row = rows[i];
    var type = row.type;
    var variable = row.variable;
    var value = this.evaluateExpr(this.tokenizeExpr(variable));
    var label = this.replaceVariables(row.label);
    var definition = this.replaceVariables(row.definition || "");

    var statWidth, div, span, statValue;
    if (type == "text") {
      div = document.createElement("div");
      setClass(div, "statText");
      span = document.createElement("span");
      if (trim(label) || trim(value)) {
        printx(label + ": " + value, span);
      } else {
        // unofficial line_break
        printx(" ", span);
      }
      div.appendChild(span);
      target.appendChild(div);
    } else if (type == "percent") {
      div = document.createElement("div");
      setClass(div, "statBar statLine");
      span = document.createElement("span");
      printx("\u00a0\u00a0"+label+": "+value+"%", span);
      div.appendChild(span);
      statValue = document.createElement("div");
      setClass(statValue, "statValue");
      statValue.style.width = value+"%";
      statValue.innerHTML = "&nbsp;";
      div.appendChild(statValue);
      target.appendChild(div);
      fixFontSize(span);
    } else if (type == "opposed_pair") {
      div = document.createElement("div");
      setClass(div, "statBar statLine opposed");
      span0 = document.createElement("span");
      printx("\u00a0\u00a0"+label+": "+value+"% ", span0);
      div.appendChild(span0);
      span = document.createElement("span");
      span.setAttribute("style", "float: right");
      printx(this.replaceVariables(row.opposed_label)+": "+(100-value)+"%\u00a0\u00a0", span);
      div.appendChild(span);
      statValue = document.createElement("div");
      setClass(statValue, "statValue");
      statValue.style.width = value+"%";
      statValue.innerHTML = "&nbsp;";
      div.appendChild(statValue);
      target.appendChild(div);
      fixFontSize(span0, span);
    } else {
      throw new Error("Bug! Parser accepted an unknown row type: " + type);
    }
  }
  this.prevLine = "block";
  this.screenEmpty = false;
};

Scene.prototype.save_checkpoint = function saveCheckpoint(slot) {
  var stat;
  if (slot) {
    if (!/^[a-zA-Z0-9_]+$/.test(slot)) throw new Error(this.lineMsg() + "Invalid *save_checkpoint slot, must be only letters, numbers, and _ underscores: " + slot);
    slot = slot.toLowerCase();
    stat = "choice_saved_checkpoint_" + slot;
  } else {
    slot = "checkpoint";
    stat = "choice_saved_checkpoint";
  }
  if (this.secondaryMode) throw new Error(this.lineMsg() + "Cannot *save_checkpoint in " + this.secondaryMode + " mode");
  this.stats[stat] = true;
  this.temps.choice_just_restored_checkpoint = false;
  saveCookie(function () {}, slot, this.stats, this.temps, this.lineNum + 1, this.indent, this.debugMode, this.nav);
}

Scene.prototype.restore_checkpoint = function restoreCheckpoint(slot) {
  var stat;
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  if (!this.testPath && this.secondaryMode) {
    if (this.secondaryMode === 'stats') {
      restoreCheckpointFromStats(function () {
        delete self.secondaryMode;
        delete self.saveSlot;
        self.restore_checkpoint(slot);
      })
      return;
    } else {
      throw new Error(this.lineMsg() + "Cannot *restore_checkpoint in " + this.secondaryMode + " mode");
    }
  }

  if (slot) {
    if (!/^[a-zA-Z0-9_]+$/.test(slot)) throw new Error(this.lineMsg() + "Invalid *restore_checkpoint slot, must be only letters, numbers, and _ underscores: " + slot);
    slot = slot.toLowerCase();
    stat = "choice_saved_checkpoint_" + slot;
  } else {
    slot = "checkpoint";
    stat = "choice_saved_checkpoint";
  }
  if (!this.stats[stat]) {
    var certainty = this.testPath ? " could fail; we might not have" : " failed; we haven't";
    if (slot === "checkpoint") {
      throw new Error(this.lineMsg() + "*restore_checkpoint" + certainty + " saved a checkpoint. Use *if " + stat);
    } else {
      throw new Error(this.lineMsg() + "*restore_checkpoint for slot " + slot + certainty + " reached *save_checkpoint " + slot + ". Use *if " + stat);
    }
  }

  if (this.testPath) return;

  var forcedStats = null;
  var forcedTemps = {choice_just_restored_checkpoint: true};
  if (this.stats.checkpoint_exclusions || this.temps.checkpoint_exclusions) {
    var exclusions = trim(this.getVar('checkpoint_exclusions').toLowerCase()).split(' ');
    for (var i = 0; i < exclusions.length; i++) {
      var exclusion = exclusions[i];
      if (exclusion in this.stats) {
        if (!forcedStats) forcedStats = {};
        forcedStats[exclusion] = this.stats[exclusion];
      }
      if (exclusion in this.temps) {
        if (!forcedTemps) forcedTemps = {};
        forcedTemps[exclusion] = this.temps[exclusion];
      }
    }
  }

  loadAndRestoreGame(slot, null, forcedStats, forcedTemps);
}

Scene.prototype.parseStatChart = function parseStatChart() {
    // nextIndent: the level of indentation after the current line
    var nextIndent = null;
    var rows = [];
    var line, line1, line2, line2indent;
    var startIndent = this.indent;
    while(isDefined(line = this.lines[++this.lineNum])) {
        if (!trim(line)) {
            this.rollbackLineCoverage();
            continue;
        }
        var indent = this.getIndent(line);
        if (nextIndent === null || nextIndent === undefined) {
            // initialize nextIndent with whatever indentation the line turns out to be
            // ...unless it's not indented at all
            if (indent <= startIndent) {
                throw new Error(this.lineMsg() + "invalid indent, expected at least one row");
            }
            this.indent = nextIndent = indent;
        }
        if (indent <= startIndent) {
            // it's over!
            this.rollbackLineCoverage();
            this.lineNum = this.previousNonBlankLineNum();
            this.rollbackLineCoverage();
            return rows;
        }
        if (indent != this.indent) {
            // all chart rows are supposed to be at the same indentation level
            // anything at the wrong indentation level might be a mis-indented title/definition
            // or just a typo
            throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
        }

        //
        // *stat_chart
        //   text wounds Wounds
        //     Definition
        //   percent Infamy Infamy
        //     Definition
        //   opposed_pair brutality
        //     Brutality
        //       Strength and cruelty
        //     Finesse
        //       Precision and aerial maneuverability
        //

        // TODO opposed_pair
        // TODO definitions
        // TODO variable substitutions
        // TODO *if/*else
        // TODO *line_break
        line = trim(line);
        var result = /^(text|percent|opposed_pair)\s+(.*)/.exec(line);
        if (!result) throw new Error(this.lineMsg() + "invalid line; this line should start with 'percent', 'text', or 'opposed_pair'");
        var type = result[1].toLowerCase();
        var data = trim(result[2]);
        if ("opposed_pair" == type) {
          this.getVar(data);
          line1 = this.lines[++this.lineNum];
          this.replaceVariables(line1);
          line1indent = this.getIndent(line1);
          if (line1indent <= this.indent) throw new Error(this.lineMsg() + "invalid indent; expected at least one indented line to indicate opposed pair name. indent: " + line1indent + ", expected greater than " + this.indent);
          line2 = this.lines[this.lineNum + 1];
          line2indent = this.getIndent(line2);
          if (line2indent <= this.indent) {
            // line1 was the only line
            rows.push({type: type, variable: data, label: data, opposed_label: trim(line1)});
          } else {
            this.lineNum++;
            this.replaceVariables(line2);
            if (line2indent == line1indent) {
              // two lines: first label, second label
              rows.push({type: type, variable: data, label: trim(line1), opposed_label: trim(line2)});
            } else if (line2indent > line1indent) {
              // line 2 is a definition; therefore the opposed_label and its definition must be on lines 3 and 4
              var line1definition = line2;
              var line3 = this.lines[++this.lineNum];
              this.replaceVariables(line3);
              var line3indent = this.getIndent(line3);
              if (line3indent != line1indent) throw new Error(this.lineMsg() + "invalid indent; this line should be the opposing label name. expected " + line1indent + " was " + line3indent);
              var line4 = this.lines[++this.lineNum];
              this.replaceVariables(line4);
              var line4indent = this.getIndent(line4);
              if (line4indent != line2indent) throw new Error(this.lineMsg() + "invalid indent; this line should be the opposing label definition. expected " + line2indent + " was " + line4indent);
              rows.push({type: type, variable: data, label: trim(line1), definition:trim(line2), opposed_label: trim(line3), opposed_definition: trim(line4)});
            } else {
              throw new Error(this.lineMsg() + "invalid indent; expected a second line with indent " + line1indent + " to match line " + this.lineNum + ", or else no more opposed_pair lines");
            }
          }
        } else {
          var variable, label;
          if (!/ /.test(data)) {
            variable = data;
            label = data;
          } else if (/^\(/.test(data)) {
            var parens = 0;
            var closingParen = -1;
            for (var i = 1; i < data.length; i++) {
              var c = data.charAt(i);
              if (c === "(") {
                parens++;
              } else if (c === ")") {
                if (parens) {
                  parens--;
                } else {
                  closingParen = i;
                  break;
                }
              }
            }
            if (closingParen == -1) {
              throw new Error(this.lineMsg() + "missing closing parenthesis");
            }
            variable = data.substring(1, closingParen);
            label = trim(data.substring(closingParen+1))
            if (label === "") {
              label = variable;
            }
          } else {
            result = /^(\S+) (.*)/.exec(data);
            if (!result) throw new Error(this.lineMsg() + "Bug! can't find a space when a space was found");
            variable = result[1];
            label = result[2];
          }
          this.evaluateExpr(this.tokenizeExpr(variable));
          this.replaceVariables(label);
          line2 = this.lines[this.lineNum + 1];
          line2indent = this.getIndent(line2);
          if (line2indent <= this.indent) {
            // No definition line
            rows.push({type: type, variable: variable, label: label});
          } else {
            this.lineNum++;
            this.replaceVariables(line2);
            rows.push({type: type, variable: variable, label: label, definition: trim(line2)});
          }
        }
    }
    return rows;
};

// *timer Dec 25, 2016 9:30:00 PDT
Scene.prototype.timer = function(dateString) {
  var end;
  if (dateString == "release") {
    if (typeof window === "undefined" || !window.releaseDate) return;
    end = window.releaseDate/1000;
  } else {
    end = Date.parse(dateString)/1000;
  }
  var now = new Date()/1000;
  if (now < end) {
    var target = this.target;
    if (!target) {
      target = document.createElement("p");
      document.getElementById('text').appendChild(target);
    }
    var self = this;
    showTicker(target, end, function() {
      clearScreen(loadAndRestoreGame());
    });
  }
}

// *delay_break 1200
Scene.prototype.delay_break = function(durationInSeconds) {
  if (isNaN(durationInSeconds * 1)) throw new Error(this.lineMsg() + "invalid duration");
  this.finished = true;
  this.skipFooter = true;
  var target = this.target;
  if (!target) {
    target = document.createElement("p");
    document.getElementById('text').appendChild(target);
  }
  this.paragraph();
  var self = this;
  delayBreakStart(function(delayStart) {
    window.blockRestart = true;
    var endTimeInSeconds = durationInSeconds * 1 + delayStart * 1;
    showTicker(target, endTimeInSeconds, function() {
      self.page_break_advertisement();
    });
    printFooter();
  });
};

// *delay_ending 1200 $2.99 $0.99
Scene.prototype.delay_ending = function(data) {
  // Steam doesn't do delay breaks and especially not skiponce
  if (typeof window != "undefined" && !!window.isSteamApp) {
    return this.ending();
  }
  var args = data.split(/ /);
  var durationInSeconds = args[0];
  var fullPriceGuess = args[1];
  var singleUsePriceGuess = args[2];
  if (isNaN(durationInSeconds * 1)) throw new Error(this.lineMsg() + "invalid duration");
  if (!/^\$/.test(fullPriceGuess)) throw new Error(this.lineMsg() + "invalid fullPriceGuess: \""+fullPriceGuess+"\"");
  if (singleUsePriceGuess && !/^\$/.test(singleUsePriceGuess)) throw new Error(this.lineMsg() + "invalid singleUsePriceGuess: \""+singleUsePriceGuess+"\"");
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  checkPurchase("adfree", function(ok, result) {
    if (result.adfree || !result.billingSupported) {
      self.ending();
      return;
    }
    getPrice("adfree", function (fullPrice) {
      if (fullPrice == "guess") fullPrice = fullPriceGuess;
      getPrice("skiponce", function (singleUsePrice) {
        if (singleUsePrice == "guess") singleUsePrice = singleUsePriceGuess;

        options = [];
        var finishedWaiting = {name: "Play again after a short wait. ", unselectable: true};
        options.push(finishedWaiting);
        var upgradeSkip = {name: "Upgrade to the unlimited version for " + fullPrice + " to skip the wait forever."};
        options.push(upgradeSkip);
        var skipOnce = {name: "Skip the wait one time for " + singleUsePrice + "."};
        if (singleUsePriceGuess) options.push(skipOnce);
        var restorePurchasesOption = {name: "Restore purchases from another device."};
        if (isRestorePurchasesSupported()) options.push(restorePurchasesOption);
        var playMoreGames = {name: "Play more games like this."};
        options.push(playMoreGames);
        var emailMe = {name: "Email me when new games are available."};
        options.push(emailMe);

        function restartNow() {
          window.blockRestart = false;
          restartGame();
        }

        self.paragraph();
        printOptions([""], options, function(option) {
          if (option == playMoreGames) {
            self.more_games("now");
            if (typeof curl != "undefined") curl();
          } else if (option == emailMe) {
            subscribeLink();
          } else if (option == upgradeSkip) {
            purchase("adfree", restartNow);
          } else if (option == skipOnce) {
            purchase("skiponce", restartNow);
          } else if (option == restorePurchasesOption) {
            restorePurchases("adfree", function() {
              clearScreen(loadAndRestoreGame);
            });
          } else {
            return restartGame();
          }
        });

        var target = document.querySelector(".choice label");

        delayBreakStart(function(delayStart) {
          window.blockRestart = true;
          var endTimeInSeconds = durationInSeconds * 1 + delayStart * 1;
          showTicker(target, endTimeInSeconds, function() {
            clearScreen(function() {
              self.ending();
            });
          });
          printFooter();
        });
      });
    });
  });

};

// *if booleanExpr
// execute different code depending on whether the booleanExpr is true or false
//
// Examples:
// *if bool-expression
//     blah
//     blah
// *elseif bool-expression
//     blah
//     blah
// *else
//     blah
//     blah
// bool-expression
//     by reference
//         *set foo true
//         *if foo ...
//     equality
//         foo=2
//         foo="blah"
//         2="2"
//             true
//     inequality
//         foo>2
//         foo<2
//         foo<=2
//         foo>=2
//     and/or logic, parentheses mandatory
//         (foo=2) or (foo=3)
//         ((foo>4) and (foo<8)) or (bar=0)
//
// NOTE: *if commands may be used inside *choices, to make some choices conditionally available
Scene.prototype["if"] = function scene_if(line) {
    var stack = this.tokenizeExpr(line);
    var result = this.evaluateExpr(stack);
    if (this.debugMode) println(line + " :: " + result);
    result = bool(result, this.lineNum+1);
    if (result) {
        // "true" branch, just go on to the next line
        this.indent = this.getIndent(this.nextNonBlankLine());
    } else {
        // "false" branch; skip over the true branch
        this.skipTrueBranch(false);
    }
};

// TODO Rename this function to just skipBranch
Scene.prototype.skipTrueBranch = function skipTrueBranch(inElse) {
  var startIndent = this.indent;
  var nextIndent = null;
  var line;
  while (isDefined(line = this.lines[++this.lineNum])) {
      this.rollbackLineCoverage();
      if (!trim(line)) continue;
      var indent = this.getIndent(line);
      if (nextIndent === null || nextIndent === undefined) {
          if (indent <= startIndent) throw new Error(this.lineMsg() + "invalid indent, expected at least one line in 'if' true block");
          nextIndent = indent;
      }
      if (indent <= startIndent) {
          // true block is over
          var parsed = null;
          // check to see if this is an *else or *elseif
          if (indent == startIndent) parsed = /^\s*\*(\w+)(.*)/.exec(line);
          if (!parsed || inElse) {
              this.lineNum = this.previousNonBlankLineNum();
              this.rollbackLineCoverage();
              this.indent = indent;
              return;
          }
          var command = parsed[1].toLowerCase();
          var data = trim(parsed[2]);
          if ("else" == command) {
              if (data) {
                if (/^if\b/.test(data)) {
                  throw new Error(this.lineMsg() + "'else if' is invalid, use 'elseif'");
                }
                throw new Error(this.lineMsg() + "nothing should appear on a line after 'else': " + data);
              }
              this.lineNum = this.lineNum; // code coverage
              // go on to the next line
              this.indent = this.getIndent(this.nextNonBlankLine());
          } else if (/^else?if$/.test(command)) {
              this.lineNum = this.lineNum; // code coverage
              this["if"](data);
          } else if ("comment" == command) {
              continue;
          } else {
              this.lineNum = this.previousNonBlankLineNum();
              this.rollbackLineCoverage();
              this.indent = this.getIndent(this.nextNonBlankLine());
          }
          return;
      }
      if (indent < nextIndent) {
          // *if foo
          //      foo
          //    bar
          throw new Error(this.lineMsg() + "invalid indent, expected "+nextIndent+", was " + indent);
      }
  }
};

Scene.prototype["else"] = Scene.prototype.elsif = Scene.prototype.elseif = function scene_else(data, inChoice) {
    // Authors can avoid using goto to get out of an if branch with:  *create implicit_control_flow true
    // This avoids the error message at the end of the function.
    if (inChoice || this.getVar("implicit_control_flow")) {
      this.skipTrueBranch(true);
      return;
    }
    throw new Error(this.lineMsg() + "It is illegal to fall in to an *else statement; you must *goto or *finish before the end of the indented block.");
};

// break the string up into a stack of tokens, defined in Scene.tokens below
Scene.prototype.tokenizeExpr = function tokenizeExpr(str) {
    var stack = [];
    var tokenTypes = Scene.tokens;
    var tokenTypesLength = tokenTypes.length;
    var pos = 0;
    while (str) {
        var matched = false;
        for (var i = 0; i < tokenTypesLength; i++) {
            var tokenType = tokenTypes[i];
            var token = tokenType.test(str, this.lineNum+1, this);
            if (token) {
                matched = true;
                str = str.substr(token.length);
                pos += token.length;
                var item = {name:tokenType.name, value:token, pos:pos};
                if (this.testPath && tokenType.name === "VAR" && /^choice_saved_checkpoint/i.test(token)) {
                  // handle choice_saved_checkpoint in quicktest
                  this.stats[token.toLowerCase()] = true;
                }
                if ("WHITESPACE" == tokenType.name) {
                    break;
                } else if ("CURLY_QUOTE" == tokenType.name) {
                  throw new Error(this.lineMsg()+"Invalid use of curly smart quote: " + token + "\nUse straight quotes \" instead")
                } else if ("FUNCTION" == tokenType.name) {
                  item.func = /^\w+/.exec(token)[0];
                }
                stack.push(item);
                break;
            }
        }
        if (!matched) throw new Error(this.lineMsg()+"Invalid expression, couldn't extract another token: " + str);
    }
    return stack;
};

// evaluate the stack of tokens
// parenthetical == true if we're evaluating a parenthetical expression
// all expressions consist of either a "singleton" value (2) or two values and one operator (2+2)
Scene.prototype.evaluateExpr = function evaluateExpr(stack, parenthetical) {
    if (!stack.length) {
        throw new Error(this.lineMsg() + "no expression specified");
    }
    var self = this;
    function getToken() {
        var token = stack.shift();
        if (!token) throw new Error(self.lineMsg() + "null token");
        return token;
    }

    var token, value1, value2, operator, result;

    value1 = this.evaluateValueToken(getToken(), stack);

    if (!stack.length) {
        if (parenthetical) {
            throw new Error(this.lineMsg() + "Invalid expression, expected " + parenthetical);
        }
        return value1;
    }

    token = getToken();

    if (parenthetical && parenthetical == token.name) {
        return value1;
    }

    // Since this isn't a singleton, it must be an operator
    operator = Scene.operators[token.value];
    if (!operator) {
      throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected OPERATOR"+
        (parenthetical?" or " + parenthetical : "")+
        ", was: " + token.name + " [" + token.value + "]");
    }

    if (token.value === '%') {
      this.warning("this is a bare % sign, which should be replaced with %+, %-, or modulo if you're really advanced.");
      this.warning("For more details on modulo, see: https://forum.choiceofgames.com/t/21176");
    }

    if (!stack[0]) {
      throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected something after a "+token.value);
    }

    if (stack[0].func == "auto") {
      value2 = this.autobalance(stack, token, value1);
    } else {
      value2 = this.evaluateValueToken(getToken(), stack);
    }

    // and do the operator
    result = operator(value1, value2, this.lineNum+1, this);

    if (parenthetical) {
        // expect close parenthesis
        if (stack.length) {
            token = getToken();
            if (parenthetical == token.name) {
                return result;
            } else {
                throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected "+parenthetical+", was: " + token.name + " [" + token.value + "]");
            }
        } else {
            throw new Error(this.lineMsg() + "Invalid expression, expected " + parenthetical);
        }
    } else {
        // if not parenthetical, expect no more tokens
        if (stack.length) {
            token = getToken();
            throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected no more tokens, found: " + token.name + " [" + token.value + "]");
        } else {
            return result;
        }
    }
    throw new Error(this.lineMsg() + "bug, how did I get here?");
};

// turn a number, string, or var token into its value
// or, if this is an open parenthesis, evaluate the parenthetical expression
Scene.prototype.evaluateValueToken = function evaluateValueToken(token, stack) {
    var name = token.name;
    var value;
    if ("OPEN_PARENTHESIS" == name) {
        return this.evaluateExpr(stack, "CLOSE_PARENTHESIS");
    } else if ("OPEN_CURLY" == name) {
        value = this.evaluateExpr(stack, "CLOSE_CURLY");
        return this.getVar(value);
    } else if ("FUNCTION" == name) {
        if (!this.functions[token.func]) throw new Error(this.lineMsg + "Unknown function " + token.func);
        value = this.evaluateExpr(stack, "CLOSE_PARENTHESIS");
        return this.functions[token.func].call(this, value);
    } else if ("NUMBER" == name) {
        return token.value;
    } else if ("STRING" == name) {
        // strip off the quotes and unescape backslashes
        return this.replaceVariables(token.value.slice(1,-1).replace(/\\(.)/g, "$1"));
    } else if ("VAR" == name) {
        var variable = String(token.value);
        while (stack.length && stack[0].name == "OPEN_SQUARE") {
          stack.shift();
          variable += "_" + this.evaluateExpr(stack, "CLOSE_SQUARE");
        }
        return this.getVar(variable);
    } else {
        throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected NUMBER, STRING, VAR or PARENTHETICAL, was: " + name + " [" + token.value + "]");
    }
};

// turn a var token into its name, remove it from the stack
// or if it's a curly parenthesis, evaluate that
// or if it's an array expression, convert it into its raw underscore name
Scene.prototype.evaluateReference = function evaluateReference(stack, options) {
  var toLowerCase = true;
  if (options && options.hasOwnProperty("toLowerCase")) toLowerCase = !!options.toLowerCase;
  function findClosingBracket(stack, type, offset) {
    if (!offset) offset = 0;
    var opens = 0;
    var openType = "OPEN_"+type;
    var closeType = "CLOSE_"+type;
    for (var i = offset; i < stack.length; i++) {
      if (stack[i].name == openType) {
        opens++;
      } else if (stack[i].name == closeType) {
        if (opens) {
          opens--;
        } else {
          return i;
        }
      }
    }
    return -1;
  }
  function normalizeCase(name) {
    if (toLowerCase) {
      return String(name).toLowerCase();
    } else {
      return name;
    }
  }
  if (!stack.length) throw new Error(this.lineMsg()+"Invalid expression, expected a name");
  var name;
  if (stack[0].name === "OPEN_CURLY") {
    stack.shift();
    var closingCurly = findClosingBracket(stack, "CURLY");
    if (closingCurly == -1) throw new Error(this.lineMsg()+"Invalid expression, no closing curly bracket: " + data);
    name = this.evaluateExpr(stack.slice(0, closingCurly));
    stack.splice(0, closingCurly+1);
    return normalizeCase(name);
  } else if (stack[0].name === "NUMBER") {
    // you could have a label that's just a number
    name = stack[0].value;
    stack.shift();
    return name;
  } else {
    if (stack[0].name !== "VAR") throw new Error(this.lineMsg() + "Invalid expression; expected name, found " + stack[0].name + " at char " + stack[0].pos);
    name = String(stack[0].value);
    stack.shift();
    while(stack.length && stack[0].name == "OPEN_SQUARE") {
      var closingBracket = findClosingBracket(stack, "SQUARE", 1);
      if (closingBracket == -1) throw new Error(this.lineMsg()+"Invalid expression, no closing array bracket at char " + stack[1].pos);
      var index = this.evaluateExpr(stack.slice(1, closingBracket));
      name += "_" + index;
      stack.splice(0, closingBracket+1);
    }
    return normalizeCase(name);
  }
};

Scene.prototype.functions = {
  not: function(value) {
    return !bool(value, this.lineNum+1);
  },
  round: function(value) {
    if (isNaN(value*1)) throw new Error(this.lineMsg()+"round() value is not a number: " + value);
    return Math.round(value);
  },
  timestamp: function(value) {
    return Date.parse(value)/1000;
  },
  log: function(value) {
    if (isNaN(value*1)) throw new Error(this.lineMsg()+"log() value is not a number: " + value);
    return Math.log(value)/Math.log(10);
  },
  length: function(value) {
    return String(value).length;
  },
  auto: function() {
    throw new Error(this.lineMsg()+"Invalid expression, auto() must come after a < or > symbol");
  }
};

Scene.prototype.autobalance = function autobalance(stack, operatorToken, value) {
  if (operatorToken.name !== "INEQUALITY") {
    throw new Error(this.lineMsg()+"Invalid expression, auto() must come after a < or > symbol");
  }
  stack.shift(); // remove auto function

  if (stack.length < 4 ||
    stack[0].name !== "NUMBER" ||
    stack[1].name !== "COMMA" ||
    !(stack[2].name == "VAR" || stack[2].name == "NUMBER") ||
    stack[3].name !== "CLOSE_PARENTHESIS"
  ) {
    throw new Error(this.lineMsg()+"Invalid expression, auto() requires (percentage, id)");
  }
  var rateString = stack.shift().value;
  var rate = parseFloat(rateString);
  if (isNaN(rate) || rate < 1 || rate > 99) {
    throw new Error(this.lineMsg()+"the first auto() parameter should be a number between 1 and 99: " + rateString);
  }
  stack.shift(); // comma
  var id = stack.shift().value;
  stack.shift(); // close parenthesis
  var result = this.stats['auto' + '_' + this.name + '_' + id];
  if (typeof result != "undefined") {
    return result;
  } else if (this.recordBalance) {
    return this.recordBalance(value, operatorToken.value, rate, id);
  }
  return 50;
}

Scene.prototype.evaluateValueExpr = function evaluateValueExpr(expr) {
    var stack = this.tokenizeExpr(expr);
    var token = stack.shift();
    if (!token) throw new Error(this.lineMsg() + "null token");
    var value = this.evaluateValueToken(token, stack);
    if (stack.length) {
        token = stack.shift();
        if (!token) throw new Error(this.lineMsg() + "null token");
        throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected no more tokens, found: " + token.name + " [" + token.value + "]");
    }
    return value;
};

Scene.prototype.goto_random_scene = function gotoRandomScene(data) {
  var parsed = this.parseGotoRandomScene(data);
  var allowReuseGlobally = /\ballow_reuse\b/.test(data);
  var allowNoSelection = /\ballow_no_selection\b/.test(data);
  var option = this.computeRandomSelection(Math.random(), parsed, allowReuseGlobally);

  if (option) {
    this.goto_scene(option.name);
  } else {
    if (allowNoSelection) {
      return;
    } else {
      throw new Error(this.lineMsg() + "No selectable scenes");
    }
  }

};

Scene.prototype.parseGotoRandomScene = function parseGotoRandomScene(data) {
    data = data || "";
    var directives = data.split(" ");
    var allowReuseGlobally = false;
    var allowNoSelection = false;
    for (var i = 0; i < directives; i++) {
      var directive = trim(directives[i]);
      if (!directive) continue;
      if (directive == "allow_reuse") {
        allowReuseGlobally = true;
      } else if (directive == "allow_no_selection") {
        allowNoSelection = true;
      } else {
        throw new Error(this.lineMsg() + "invalid command: '" + directive + "'");
      }
    }

    // nextIndent: the level of indentation after the current line
    var nextIndent = null;
    var options = [];
    var line;
    var startIndent = this.indent;
    while(isDefined(line = this.lines[++this.lineNum])) {
        if (!trim(line)) {
            this.rollbackLineCoverage();
            continue;
        }
        var indent = this.getIndent(line);
        if (nextIndent === null || nextIndent === undefined) {
            // initialize nextIndent with whatever indentation the line turns out to be
            // ...unless it's not indented at all
            if (indent <= startIndent) {
                throw new Error(this.lineMsg() + "invalid indent, expected at least one line in *goto_random_scene");
            }
            this.indent = nextIndent = indent;
        }
        if (indent <= startIndent) {
            // it's over!
            this.rollbackLineCoverage();
            this.lineNum--;
            this.rollbackLineCoverage();
            break;
        }
        if (indent != this.indent) {
            // all chart rows are supposed to be at the same indentation level
            // anything at the wrong indentation level might be a mis-indented title/definition
            // or just a typo
            throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
        }
        line = trim(line);

        var option = {allowReuse:allowReuseGlobally};
        var command;
        while(!!(command = /^\*(\S+)/.exec(line))) {
          command = command[1];
          if ("allow_reuse" == command) {
            option.allowReuse = true;
            line = trim(line.substring("*allow_reuse".length));
            command = /^\*(\S+)/.exec(line);
            continue;
          } else if ("if" == command) {
            var conditional = /^\*if\s+\((.+)\)\s+([^\)]+)/.exec(line);
            if (!conditional) throw new Error(this.lineMsg() + " invalid *if, expected () followed by scene name: " + line);
            line = conditional[2];
            var stack = this.tokenizeExpr(conditional[1]);
            this.evaluateExpr(stack);
            option.conditional = conditional[1];
          } else {
            throw new Error(this.lineMsg() + " invalid command: " + line);
          }
        }
        // TODO weights
        option.name = trim(line);
        options.push(option);
    }
    return options;
};

Scene.prototype.computeRandomSelection = function computeRandomSelection(randomFloat, options, allowReuseGlobally) {
  var filtered = [];
  var finished = {};
  if (!allowReuseGlobally) {
    if (!this.stats.choice_grs) this.stats.choice_grs = [];
  }
  var grs = this.stats.choice_grs;
  for (var i = 0; i < grs.length; i++) {
    finished[grs[i]] = 1;
  }
  var option;
  for (i = 0; i < options.length; i++) {
    option = options[i];
    if (!option.allowReuse) {
      if (finished[option.name]) continue;
    }
    if (option.conditional) {
      var stack = this.tokenizeExpr(option.conditional);
      var pass = this.evaluateExpr(stack);
      if (!pass) continue;
    }
    filtered.push(option);
  }
  if (!filtered.length) return null;
  // TODO weights
  var randomSelection = Math.floor(randomFloat*filtered.length);
  option = filtered[randomSelection];
  if (!option.allowReuse) {
    this.stats.choice_grs.push(option.name);
  }
  return option;
};

Scene.prototype.end_trial = function endTrial() {
  this.paragraph();
  printLink(this.target, "#", "Start Over from the Beginning", function(e) {
    preventDefault(e);
    return restartGame("prompt");
  });
  this.prevLine = "block";
  this.screenEmpty = false;
  this.finished = true;
};

Scene.prototype.achieve = function scene_achieve(name) {
  name = name.toLowerCase();
  if (!this.nav.achievements.hasOwnProperty(name)) {
    throw new Error(this.lineMsg() + "the achievement name "+name+" was not declared as an *achievement in startup");
  }
  var achievement = this.nav.achievements[name];
  this.nav.achieved[name] = true;
  if (typeof achieve != "undefined") {
    achieve(name, achievement.title, achievement.earnedDescription);
  }
};

Scene.prototype.check_achievements = function scene_checkAchievements() {
  var self = this;
  function callback(immediately) {
    for (var achievement in nav.achievements) {

      self.temps["choice_achieved_"+achievement] = nav.achieved.hasOwnProperty(achievement);
    }
    if (!immediately) {
      self.finished = false;
      self.skipFooter = false;
      self.execute();
    }
  }
  if (typeof checkAchievements == "undefined") {
    callback("immediately");
  } else {
    this.finished = true;
    this.skipFooter = true;
    checkAchievements(callback);
  }
};

Scene.prototype.scene_list = function scene_list() {
  var scenes = this.parseSceneList();
  this.nav.setSceneList(scenes);
};

Scene.prototype.parseSceneList = function parseSceneList() {
  var nextIndent = null;
  var scenes = [];
  var line;
  var startIndent = this.indent;
  while(isDefined(line = this.lines[++this.lineNum])) {
      if (!trim(line)) {
          this.rollbackLineCoverage();
          continue;
      }
      var indent = this.getIndent(line);
      if (nextIndent === null || nextIndent === undefined) {
          // initialize nextIndent with whatever indentation the line turns out to be
          // ...unless it's not indented at all
          if (indent <= startIndent) {
              throw new Error(this.lineMsg() + "invalid indent, expected at least one row");
          }
          this.indent = nextIndent = indent;
      }
      if (indent <= startIndent) {
          // it's over!
          this.rollbackLineCoverage();
          this.lineNum--;
          this.rollbackLineCoverage();
          return scenes;
      }
      if (indent != this.indent) {
          // all scenes are supposed to be at the same indentation level
          throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
      }

      line = trim(line);
      var purchaseMatch = /^\$(\w*)\s+(.*)/.exec(line);
      if (purchaseMatch) {
        line = purchaseMatch[2];
      }
      if (!scenes.length && "startup" != String(line).toLowerCase()) scenes.push("startup");
      scenes.push(line);
  }
  return scenes;
};

Scene.prototype.title = function scene_title(title) {
  this.stats.choice_title = trim(title);
  if (this.nav) this.nav.startingStats.choice_title = trim(title);
  if (typeof changeTitle != "undefined") {
    changeTitle(title);
  }
};

Scene.prototype.author = function scene_author(author) {
  if (typeof changeAuthor != "undefined") {
    changeAuthor(author);
  }
};

// *achievement name hidden|visible 100 Achievement Title
//     Earned description
//     Pre-earned description
Scene.prototype.achievement = function scene_achievement(data) {
  var parsed = /(\S+)\s+(\S+)\s+(\S+)\s+(.*)/.exec(data);
  if (!parsed) throw new Error(this.lineMsg() + "Invalid *achievement, requires short name, visibility, points, and display title: " + data);
  var achievementName = parsed[1];
  if (!/^[a-z][a-z0-9_]+$/.test(achievementName)) throw new Error(this.lineMsg()+"Invalid achievement name: " +achievementName);

  if (!this.parsedAnAchievment && Object.keys(this.nav.achievements).length > 0) {
    // blow away pre-existing mygame.js achievements
    this.nav.achievements = {};
    this.nav.achievementList = [];
    this.achievementTotal = 0;
    this.seenAchievementTitles = {};
  }

  this.parsedAnAchievment = true;

  if (this.nav.achievements.hasOwnProperty(achievementName)) {
    var preExisting = this.nav.achievements[achievementName];
    throw new Error(this.lineMsg()+"Achievement "+achievementName+" already defined on line " + this.nav.achievements[achievementName].lineNumber);
  }

  var lineNumber = this.lineNum+1;
  var visibility = parsed[2];
  if (visibility != "hidden" && visibility != "visible") {
    throw new Error(this.lineMsg()+"Invalid *achievement, the second word should be either 'hidden' or 'visible': " +visibility);
  }
  var visible = (visibility != "hidden");
  var pointString = parsed[3];
  if (!/[1-9][0-9]*/.test(pointString)) {
    throw new Error(this.lineMsg()+"Invalid *achievement, the third word should be an integer number of points: " + pointString);
  }
  var points = parseInt(pointString, 10);
  if (points > 100) throw new Error(this.lineMsg()+"Invalid *achievement, no achievement may be worth more than 100 points: " + points);
  if (points < 1) throw new Error(this.lineMsg()+"Invalid *achievement, no achievement may be worth less than 1 point: " + points);
  if (!this.achievementTotal) this.achievementTotal = 0;
  this.achievementTotal += points;
  if (this.achievementTotal > 1000) {
    throw new Error(this.lineMsg()+"Invalid achievements. Adding " + points + " would add up to more than 1,000 points: " + this.achievementTotal);
  }
  var title = parsed[4];
  if (/(\$\{)/.test(title)) throw new Error(this.lineMsg()+"Invalid *achievement. ${} not permitted in achievement title: " + title);
  if (/(\@\{)/.test(title)) throw new Error(this.lineMsg()+"Invalid *achievement. @{} not permitted in achievement title: " + title);
  if (/(\[)/.test(title)) throw new Error(this.lineMsg()+"Invalid *achievement. [] not permitted in achievement title: " + title);
  if (title.length > 50) throw new Error(this.lineMsg()+"Invalid *achievement. Title must be 50 characters or fewer: " + title);

  // Get the description from the next indented line
  var line = this.lines[++this.lineNum];
  var indent = this.getIndent(line);
  if (!indent) {
    throw new Error(this.lineMsg()+"Invalid *achievement. An indented description is required.");
  }
  var preEarnedDescription = trim(line);
  if (/(\$\{)/.test(preEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. ${} not permitted in achievement description: " + preEarnedDescription);
  if (/(\@\{)/.test(preEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. @{} not permitted in achievement description: " + preEarnedDescription);
  if (/(\[)/.test(preEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. [] not permitted in achievement description: " + preEarnedDescription);
  if (preEarnedDescription.length > 200) throw new Error(this.lineMsg()+"Invalid *achievement. Pre-earned description must be 200 characters or fewer: " + preEarnedDescription);

  if (!visible) {
    if (preEarnedDescription.toLowerCase() != "hidden") throw new Error(this.lineMsg()+"Invalid *achievement. Hidden achievements must set their pre-earned description to 'hidden'.");
  }

  // Optionally get a post-earned description from the next line
  var postEarnedDescription = null;
  while(isDefined(line = this.lines[++this.lineNum])) {
    if (trim(line)) break;
    this.rollbackLineCoverage();
  }
  indent = this.getIndent(line);
  if (indent) {
    postEarnedDescription = trim(line);
    if (/(\$\{)/.test(postEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. ${} not permitted in achievement description: " + postEarnedDescription);
    if (/(\@\{)/.test(postEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. @{} not permitted in achievement description: " + postEarnedDescription);
    if (/(\[)/.test(postEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. [] not permitted in achievement description: " + postEarnedDescription);
    if (postEarnedDescription.length > 200) throw new Error(this.lineMsg()+"Invalid *achievement. Post-earned description must be 200 characters or fewer: " + postEarnedDescription);
  } else {
    // No indent means the next line is not a post-earned description
    this.rollbackLineCoverage();
    this.lineNum--;
    this.rollbackLineCoverage();
  }

  if (!postEarnedDescription) {
    if (!visible) throw new Error(this.lineMsg()+"Invalid *achievement. Hidden achievements must set a post-earned description.");
    postEarnedDescription = preEarnedDescription;
  }

  if (!this.nav.achievements.hasOwnProperty(achievementName)) {
    this.nav.achievementList.push(achievementName);
    if (this.nav.achievementList.length > 100) {
      throw new Error(this.lineMsg()+"Too many *achievements. Each game can have up to 100 achievements.");
    }
  }

  if (!this.seenAchievementTitles) this.seenAchievementTitles = {};

  if (this.seenAchievementTitles[title]) {
    throw new Error(this.lineMsg()+"An achievement with display title \"" + title + "\" was already defined at line " + this.seenAchievementTitles[title]);
  }

  this.seenAchievementTitles[title] = this.lineNum+1;

  this.nav.achievements[achievementName] = {
    visible: visible,
    points: points,
    title: title,
    earnedDescription: postEarnedDescription,
    preEarnedDescription: preEarnedDescription,
    lineNumber: lineNumber
  };

  if (typeof setButtonTitles != "undefined") setButtonTitles();
};


Scene.prototype.bug = function scene_bug(message) {
  if (message) {
    message = "Bug: " + this.replaceVariables(message);
  } else {
    message = "Bug";
  }
  if (message === "Bug: choice_beta" && _global.beta) return;
  throw new Error(this.lineMsg() + message);
};

Scene.prototype.warning = function scene_warning(message) {
  // quicktest implements this
}

Scene.prototype.feedback = function scene_feedback() {
  this.stats.choice_feedback_requested = true;
  if (typeof window == "undefined" || this.randomtest) return;
  this.paragraph();
  this.printLine("On a scale from 1 to 10, how likely are you to recommend this game to a friend?");
  this.paragraph();
  var options = [{name:"10 (Most likely)"}];
  for (var i = 9; i > 1; i--) {
    options.push({name:i});
  }
  options.push({name:"1 (Least likely)"});
  options.push({name:"No response."});
  var self = this;
  if (window.prepareReviewPrompt) window.prepareReviewPrompt();
  this.renderOptions([""], options, function(option) {
    var value = "null";
    var numberMatch = /^(\d+)/.exec(option.name);
    if (numberMatch) value = numberMatch[1]*1;
    if (!isWebSavePossible()) {
      self.finished = false;
      self.resetPage();
      return;
    }

    var postFeedback = function() {
      xhrAuthRequest("POST", "feedback", function(ok, response) {
        if (window.console) console.log("ok", ok, response);
      }, "game", window.storeName, "platform", platformCode(), "rating", value);
      if (/^(9|10)/.test(option.name)) {
        if (isReviewSupported()) {
          return clearScreen(function() {
            if (promptForReview()) {
              self.screenEmpty = false;
              self.prevLine = "text";
              self.page_break();
              printFooter();
            } else {
              self.finished = false;
              self.resetPage();
            }
          });
        }
      }
      self.finished = false;
      self.resetPage();
    }

    if (value == "null") {
      self.finished = false;
      self.resetPage();
      return;
    }

    isRegistered(function(registered) {
      if (registered) {
        postFeedback();
      } else {
        clearScreen(function() {
          loginForm(main, 1/*optional*/, "Please sign in to have your vote counted!", postFeedback);
        });
      }
    });
  });
  this.finished = true;
};

Scene.prototype.parseTrackEvent = function(data) {
  var event = {};
  var stack = this.tokenizeExpr(data);
  if (!stack.length) throw new Error(this.lineMsg() + "Invalid track_event statement, expected at least two args: category and action");
  event.category = this.evaluateValueToken(stack.shift(), stack);
  if (!stack.length) throw new Error(this.lineMsg() + "Invalid track_event statement, expected at least two args: category and action");
  event.action = this.evaluateValueToken(stack.shift(), stack);
  if (stack.length) {
    event.label = this.evaluateValueToken(stack.shift(), stack);
    if (stack.length) {
      event.value = this.evaluateValueToken(stack.shift(), stack);
      if (stack.length) {
        throw new Error(this.lineMsg() + "Invalid track_event statement, expected at most four args: category, action, label, value");
      }
      var intValue = parseInt(event.value, 10);
      if (isNaN(intValue) || event.value != intValue || event.value.toString() != intValue.toString()) {
        throw new Error(this.lineMsg() + "Invalid track_event statement, value must be an integer: " + event.value);
      }
    }
  }
  return event;
}

Scene.prototype.track_event = function track_event(data) {
  var event = this.parseTrackEvent(data);
  if (typeof ga !== "undefined") {
    ga('send', 'event', event.category, event.action, event.label, event.value);
  }
}

Scene.prototype.ai = function ai(data) {}

Scene.prototype.config = function config(data) {
    var stack = this.tokenizeExpr(data);
    var variable = this.evaluateReference(stack);
    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }
    if (stack.length === 0) throw new Error(this.lineMsg()+"Invalid set instruction, no expression specified: " + line);
    var value = this.evaluateExpr(stack);
    this.setVar(variable, value);
    if ("undefined" !== typeof remoteConfig && !this.randomtest && !this.quicktest) {
      this.finished = true;
      this.skipFooter = true;
      var self = this;
      remoteConfig(variable, function(result) {
        if (result !== null) self.setVar(variable, result);
        self.finished = false;
        self.skipFooter = false;
        self.execute();
      })
    }
};

Scene.prototype.ifid = function ifid(id) {
  if (!/^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/.test(id)) {
    var example = "a0a0a0a0-a0a0-a0a0-a0a0-a0a0a0a0a0a0";
    try {
      example = crypto.randomUUID();
    } catch (e) {}
    throw new Error(this.lineMsg() + "Invalid IFID. It should have five parts, like \""+example+"\": " + id);
  }
  if (!/^[A-F0-9\-]{36}$/i.test(id)) {
    throw new Error(this.lineMsg() + "Invalid IFID. It should contain only numbers, letters A-F, and dashes: " + id);
  }
}

Scene.prototype.lineMsg = function lineMsg() {
    return this.name + " line " + (this.lineNum+1) + ": ";
};

Scene.prototype.rollbackLineCoverage = function() {};

Scene.baseUrl = "scenes";
Scene.regexpMatch = function regexpMatch(str, re) {
    var result = re.exec(str);
    if (!result) return null;
    return result[0];
};
// Each token has a name and a test, which returns the matching string
Scene.tokens = [
    {name:"OPEN_PARENTHESIS", test:function(str){ return Scene.regexpMatch(str,/^\(/); } },
    {name:"CLOSE_PARENTHESIS", test:function(str){ return Scene.regexpMatch(str,/^\)/); } },
    {name:"OPEN_CURLY", test:function(str){ return Scene.regexpMatch(str,/^\{/); } },
    {name:"CLOSE_CURLY", test:function(str){ return Scene.regexpMatch(str,/^\}/); } },
    {name:"OPEN_SQUARE", test:function(str){ return Scene.regexpMatch(str,/^\[/); } },
    {name:"CLOSE_SQUARE", test:function(str){ return Scene.regexpMatch(str,/^\]/); } },
    {name:"FUNCTION", test:function(str){ return Scene.regexpMatch(str,/^(not|round|timestamp|log|length|auto)\s*\(/); } },
    {name:"NUMBER", test:function(str){ return Scene.regexpMatch(str,/^\d+(\.\d+)?\b/); } },
    {name:"STRING", test:function(str, line, sceneObj) {
            var i;
            if (!/^\"/.test(str)) return null;
            for (i = 1; i < str.length; i++) {
                var x = str.charAt(i);
                if ("\\" == x) {
                    i++;
                } else if ('"' == x) {
                    return str.substring(0,i+1);
                }
            }
            var errMessage = "line " + line + ": ";
            if (sceneObj) {
              errMessage = sceneObj.lineMsg();
            }
            throw new Error(errMessage+"Invalid string, open quote with no close quote: " + str);
        }
    },
    {name:"CURLY_QUOTE", test:function(str){ return Scene.regexpMatch(str,/^[\u201c\u201d]/); } },
    {name:"WHITESPACE", test:function(str){ return Scene.regexpMatch(str,/^\s+/); } },
    {name:"NAMED_OPERATOR", test:function(str){ return Scene.regexpMatch(str,/^(and|or|modulo)\b/); } },
    {name:"VAR", test:function(str){ return Scene.regexpMatch(str,/^\w*/); } },
    {name:"FAIRMATH", test:function(str){ return Scene.regexpMatch(str,/^%[\+\-]/); } },
    {name:"OPERATOR", test:function(str){ return Scene.regexpMatch(str,/^[\+\-\*\/\&\%\^\#]/); } },
    {name:"INEQUALITY", test:function(str){ return Scene.regexpMatch(str,/^[\!<>]\=?/); } },
    {name:"EQUALITY", test:function(str){ return Scene.regexpMatch(str,/^=/); } },
    {name:"COMMA", test:function(str){ return Scene.regexpMatch(str,/^,/); } }
    //
];
Scene.operators = {
    "+": function add(v1,v2,line,sceneObj) { var name = null; if (sceneObj) name = sceneObj.name; return num(v1,line,name) + num(v2,line,name); },
    "-": function subtract(v1,v2,line,sceneObj) { var name = null; if (sceneObj) name = sceneObj.name; return num(v1,line,name) - num(v2,line,name); },
    "*": function multiply(v1,v2,line,sceneObj) { var name = null; if (sceneObj) name = sceneObj.name; return num(v1,line,name) * num(v2,line,name); },
    "/": function divide(v1,v2,line,sceneObj) {
      var name = null; if (sceneObj) name = sceneObj.name; 
      v2 = num(v2, line, name);
      if (v2 === 0) throw new Error(name+" line "+line+": can't divide by zero");
      return num(v1,line,name) / num(v2,line,name);
    },
    "^": function exponent(v1,v2,line,sceneObj) { var name = null; if (sceneObj) name = sceneObj.name; return Math.pow(num(v1,line,name), num(v2,line,name)); },
    "&": function concatenate(v1,v2) { return [v1,v2].join(""); },
    "#": function charAt(v1,v2,line,sceneObj) {
      var name = null;
      var errMessage = "line " + line + ": ";
      if (sceneObj) {
        name = sceneObj.name;
        errMessage = sceneObj.lineMsg();
      }
      var i = num(v2,line,name);
      if (i < 1) {
        throw new Error(errMessage+"There is no character at position " + i + "; the position must be greater than or equal to 1.");
      }
      if (i > String(v1).length) {
        throw new Error(errMessage+"There is no character at position " + i + ". \""+v1+"\" is only " + String(v1).length + " characters long.");
      }
      return String(v1).charAt(i-1);
    },
    "%+": function fairAdd(v1, v2, line, sceneObj) {
        var name = null;
        var errMessage = "line " + line + ": ";
        if (sceneObj) {
          name = sceneObj.name;
          errMessage = sceneObj.lineMsg();
        }
        v1 = num(v1,line,name);
        v2 = num(v2,line,name);
        var validValue = (v1 >= 0 && v1 <= 100);
        if (!validValue) {
            throw new Error(errMessage+"Can't fairAdd to non-percentile value: " + v1);
        }
        if (v2 > 0) {
          var multiplier = (100 - v1) / 100;
          var actualModifier = v2 * multiplier;
          var value = 1 * v1 + actualModifier;
          value = Math.floor(value);
          if (value > 99) value = 99;
          return value;
        } else {
          var multiplier = v1 / 100;
          var actualModifier = (0-v2) * multiplier;
          var value = v1 - actualModifier;
          value = Math.ceil(value);
          if (value < 1) value = 1;
          return value;
        }
    },
    "%-": function fairSubtract(v1, v2, line, sceneObj) {
        var name = null; if (sceneObj) name = sceneObj.name; 
        v2 = num(v2,line,name);
        return Scene.operators["%+"](v1,0-v2,line,sceneObj);
    },
    "=": function equals(v1,v2) { return v1 == v2 || String(v1) == String(v2); },
    "<": function lessThan(v1,v2,line,sceneObj) {
        var name = null; if (sceneObj) name = sceneObj.name; 
        return num(v1,line,name) < num(v2,line,name); },
    ">": function greaterThan(v1,v2,line,sceneObj) { var name = null; if (sceneObj) name = sceneObj.name; return num(v1,line,name) > num(v2,line,name); },
    "<=": function lessThanOrEquals(v1,v2,line,sceneObj) { var name = null; if (sceneObj) name = sceneObj.name; return num(v1,line,name) <= num(v2,line,name); },
    ">=": function greaterThanOrEquals(v1,v2,line,sceneObj) { var name = null; if (sceneObj) name = sceneObj.name; return num(v1,line,name) >= num(v2,line,name); },
    "!=": function notEquals(v1,v2) { return v1 != v2; },
    "and": function and(v1, v2, line, sceneObj) {
        var name = null; if (sceneObj) name = sceneObj.name; 
        return bool(v1,line,name) && bool(v2,line,name);
    },
    "or": function or(v1, v2, line, sceneObj) {
        var name = null; if (sceneObj) name = sceneObj.name; 
        return bool(v1,line,name) || bool(v2,line,name);
    },
    "modulo": function modulo(v1,v2,line,sceneObj) { var name = null; if (sceneObj) name = sceneObj.name; return num(v1,line,name) % num(v2,line,name); },
};

Scene.initialCommands = {"create":1,"create_array":1,"scene_list":1,"title":1,"author":1,"comment":1,"achievement":1,"product":1,"ifid":1};

Scene.validCommands = {"comment":1, "goto":1, "gotoref":1, "label":1, "looplimit":1, "finish":1, "abort":1,
    "choice":1, "create":1, "create_array": 1, "temp":1, "temp_array": 1, "delete":1, "delete_array":1, "set":1, "setref":1, "print":1, "if":1, "rand":1,
    "page_break":1, "line_break":1, "script":1, "else":1, "elseif":1, "elsif":1, "reset":1,
    "goto_scene":1, "fake_choice":1, "input_text":1, "ending":1, "share_this_game":1, "stat_chart":1,
    "subscribe":1, "show_password":1, "gosub":1, "return":1, "hide_reuse":1, "disable_reuse":1, "allow_reuse":1,
    "check_purchase":1,"restore_purchases":1,"purchase":1,"restore_game":1,"advertisement":1,
    "kindle_search":1,"kindle_product":1,"feedback":1,
    "save_game":1,"delay_break":1,"image":1,"kindle_image":1,"link":1,"input_number":1,"goto_random_scene":1,
    "restart":1,"more_games":1,"delay_ending":1,"end_trial":1,"login":1,"achieve":1,"scene_list":1,"title":1,
    "bug":1,"link_button":1,"check_registration":1,"sound":1,"author":1,"gosub_scene":1,"achievement":1,
    "check_achievements":1,"redirect_scene":1,"print_discount":1,"purchase_discount":1,"track_event":1,
    "timer":1,"youtube":1,"product":1,"text_image":1,"ai":1,"params":1,"config":1,"ifid":1,
    "page_break_advertisement":1, "finish_advertisement":1, "save_checkpoint": 1, "restore_checkpoint": 1
    };

;
/*
 * Copyright 2010 by Dan Fabulich.
 * 
 * Dan Fabulich licenses this file to you under the
 * ChoiceScript License, Version 1.0 (the "License"); you may
 * not use this file except in compliance with the License. 
 * You may obtain a copy of the License at
 * 
 *  http://www.choiceofgames.com/LICENSE-1.0.txt
 * 
 * See the License for the specific language governing
 * permissions and limitations under the License.
 * 
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied.
 */
function SceneNavigator(sceneList) {
    this.setSceneList(sceneList);
    this.startingStats = {};
}

SceneNavigator.prototype.setSceneList = function setSceneList(sceneList) {
    this._sceneList = sceneList;
    this._sceneMap = {};
    for (var i = 0; i < sceneList.length-1; i++) {
        var scene1 = sceneList[i];
        var scene2 = sceneList[i+1];
        this._sceneMap[scene1] = scene2;
    }
    this._startupScene = sceneList[0];
};

SceneNavigator.prototype.nextSceneName = function nextSceneName(currentSceneName) {
    var nextScene = this._sceneMap[currentSceneName];
    //if (!nextScene) throw new Error("No scene follows " + currentSceneName);
    return nextScene;
};

SceneNavigator.prototype.getStartupScene = function getStartupScene() {
    return this._startupScene;
};

SceneNavigator.prototype.setStartingStatsClone = function setStartingStatsClone(stats) {
  this.startingStats = {};
  for (var i in stats) {
    this.startingStats[i] = stats[i];
  }
};

SceneNavigator.prototype.resetStats = function resetStats(stats) {
  for (var i in stats) {
    delete stats[i];
  }
  for (i in this.startingStats) {
    stats[i] = this.startingStats[i];
  }
  this.bugLog = [];
};

SceneNavigator.prototype.repairStats = function repairStats(stats) {
  for (var i in this.startingStats) {
    var startingStat = this.startingStats[i];
    if (startingStat === null || startingStat === undefined) continue;
    if (typeof(stats[i]) === "undefined" || stats[i] === null) {
      stats[i] = this.startingStats[i];
    }
  }
};

SceneNavigator.prototype.bugLog = [];
SceneNavigator.prototype.achievements = {};
SceneNavigator.prototype.achievementList = [];
SceneNavigator.prototype.achieved = {};
SceneNavigator.prototype.products = {};

SceneNavigator.prototype.loadAchievements = function(achievementArray) {
  if (!achievementArray) return;
  this.achievements = {};
  this.achievementList = [];
  for (var i = 0; i < achievementArray.length; i++) {
    var achievement = achievementArray[i];
    var achievementName = achievement[0];
    var visible = achievement[1];
    var points = achievement[2];
    var title = achievement[3];
    var earnedDescription = achievement[4];
    var preEarnedDescription = achievement[5];
    this.achievements[achievementName] = {
      visible: visible,
      points: points,
      title: title,
      earnedDescription: earnedDescription,
      preEarnedDescription: preEarnedDescription
    };
    this.achievementList.push(achievementName);
  }
};
SceneNavigator.prototype.loadProducts = function(productArray, purchaseMap) {
  if (!productArray && !purchaseMap) return;
  this.products = {};
  for (var i = 0; i < productArray; i++) {
    this.products[productArray[i]] = {};
  }
  for (var scene in purchaseMap) {
    var product = purchaseMap[scene];
    this.products[product] = {};
  }
}

;
Scene.prototype.sm_save=function(line){var stack=this.tokenizeExpr(line);if(stack.length>2)throw new Error("sm_save: Invalid number of arguments, expected 0, 1 (save name) or 2 (id).");ChoiceScriptSavePlugin._save((new Date).getTime(),stack.length==1?this.evaluateExpr(stack):null)};Scene.prototype.sm_load=function(line){var stack=this.tokenizeExpr(line);var variable=this.evaluateExpr(stack);this.finished=true;this.skipFooter=true;this.screenEmpty=true;ChoiceScriptSavePlugin._load(variable)};Scene.prototype.sm_delete=function(line){var stack=this.tokenizeExpr(line);if(stack.length!=1)throw new Error("sm_delete: Invalid number of arguments, expected 1.");ChoiceScriptSavePlugin._delete(this.evaluateExpr(stack))};Scene.prototype.sm_update=function(){if(typeof this.stats._sm_save_count==="undefined")this.stats._sm_save_count=0;ChoiceScriptSavePlugin._getSaveList(function(saveList){if(!saveList)return;ChoiceScriptSavePlugin._syncHelperVariables(saveList,function(){})})};Scene.prototype.sm_menu=function(data){data=data||"";data=data.toLowerCase();var selectEle=document.getElementById("quickSaveMenu");if(!selectEle)return;var active=false;if(data==="false"){active=false}else if(data==="true"){active=true}else if(!data){active=selectEle.style.display=="none"}else{throw new Error("*sm_menu: expected true, false (or nothing) as an argument!")}selectEle.style.display=active?"inline":"none";var btns=document.getElementsByClassName("savePluginBtn");for(var i=0;i<btns.length;i++){btns[i].style.display=active?"inline":"none"}};Scene.validCommands["sm_save"]=1;Scene.validCommands["sm_load"]=1;Scene.validCommands["sm_delete"]=1;Scene.validCommands["sm_update"]=1;Scene.validCommands["sm_menu"]=1;var ChoiceScriptSavePlugin={};ChoiceScriptSavePlugin._CSS="#quickSaveMenu {        margin: 5px;        width: 100px;    }";ChoiceScriptSavePlugin._save=function(saveId,saveName){restoreObject(initStore(),"state",null,function(baseSave){if(baseSave){baseSave.stats["_smSaveName"]=saveName||"";baseSave.stats["_smSaveDateId"]=saveId;ChoiceScriptSavePlugin._addToSaveList(saveId,function(success){if(!success)return;saveCookie(function(){},ChoiceScriptSavePlugin._formatSlotName(saveId),baseSave.stats,baseSave.temps,baseSave.lineNum,baseSave.indent,this.debugMode,this.nav);setTimeout(function(){var selectEle=document.getElementById("quickSaveMenu");if(selectEle){selectEle.innerHTML="";ChoiceScriptSavePlugin._populateSaveMenu(selectEle)}},3e3)})}else{}})};ChoiceScriptSavePlugin._formatSlotName=function(saveId){return window.storeName+"_SAVE_"+saveId};ChoiceScriptSavePlugin._load=function(saveId){clearScreen(loadAndRestoreGame.bind(stats.scene,ChoiceScriptSavePlugin._formatSlotName(saveId)))};ChoiceScriptSavePlugin._delete=function(saveId){ChoiceScriptSavePlugin._removeFromSaveList(saveId,function(success){if(!success)return;var select=document.getElementById("quickSaveMenu");if(select){var deletedOption=select.options[select.selectedIndex];if(deletedOption)deletedOption.parentElement.removeChild(deletedOption)}initStore().remove("state"+ChoiceScriptSavePlugin._formatSlotName(saveId),function(success,val){})})};ChoiceScriptSavePlugin._createQuickSaveMenu=function(){var p=document.getElementById("menuButton");if(!p){alert("Error: unable to attach quick save menu");return}p=p.parentElement;var head=document.getElementsByTagName("head")[0];var style=document.createElement("style");style.innerHTML=ChoiceScriptSavePlugin._CSS;head.appendChild(style);var selectEle=document.createElement("select");selectEle.setAttribute("id","quickSaveMenu");p.appendChild(selectEle);var buttonArr=[{innerHTML:"New Save",clickFunc:"ChoiceScriptSavePlugin.save();"},{innerHTML:"Load",clickFunc:"ChoiceScriptSavePlugin.load();"},{innerHTML:"Delete",clickFunc:"ChoiceScriptSavePlugin.delete();"}];for(var i=0;i<buttonArr.length;i++){var btn=document.createElement("button");btn.innerHTML=buttonArr[i].innerHTML;btn.setAttribute("class","spacedLink savePluginBtn");btn.setAttribute("onclick",buttonArr[i].clickFunc);p.appendChild(btn)}return selectEle};ChoiceScriptSavePlugin._populateSaveMenu=function(selectEle){ChoiceScriptSavePlugin._getSaveList(function(saveList){if(!saveList)return;saveList.forEach(function(saveId){ChoiceScriptSavePlugin._getSaveData(saveId,function(saveData){if(!saveData){return}var option=document.createElement("option");option.setAttribute("value",saveData.stats._smSaveDateId);if(!saveData){option.innerHTML="Failed to load save."}else{var slotDesc=saveData.stats.sceneName+".txt ("+simpleDateTimeFormat(new Date(parseInt(saveData.stats._smSaveDateId)))+")";if(saveData.stats._smSaveName){slotDesc=saveData.stats._smSaveName+" &mdash; "+slotDesc}option.innerHTML=slotDesc}selectEle.appendChild(option)})})})};ChoiceScriptSavePlugin._getSaveData=function(saveId,callback){restoreObject(initStore(),"state"+ChoiceScriptSavePlugin._formatSlotName(saveId),null,function(saveData){if(saveData){callback(saveData)}else{callback(null)}})};ChoiceScriptSavePlugin._removeFromSaveList=function(saveId,callback){ChoiceScriptSavePlugin._getSaveList(function(saveList){if(!saveList)return;var index=saveList.indexOf(saveId.toString());if(index>-1)saveList.splice(index,1);initStore().set("save_list",saveList.join(" "),function(success,val){ChoiceScriptSavePlugin._syncHelperVariables(saveList,function(){callback(success)})})})};ChoiceScriptSavePlugin._addToSaveList=function(saveId,callback){ChoiceScriptSavePlugin._getSaveList(function(saveList){if(!saveList)return;saveList.push(saveId.toString());initStore().set("save_list",saveList.join(" "),function(success,val){ChoiceScriptSavePlugin._syncHelperVariables(saveList,function(){callback(success)})})})};ChoiceScriptSavePlugin._syncHelperVariables=function(saveList,callback){self.stats._sm_save_count=saveList.length;saveList.forEach(function(save,index){ChoiceScriptSavePlugin._getSaveData(save,function(saveData){if(saveData){self.stats["_sm_save_id_"+index]=save;self.stats["_sm_save_name_"+index]=saveData.stats._smSaveName||"";self.stats["_sm_save_date_"+index]=simpleDateTimeFormat(new Date(parseInt(save)))}})});callback()};ChoiceScriptSavePlugin._getSaveList=function(callback){initStore().get("save_list",function(success,val){if(!success)callback(null);if(!val)callback([]);else callback(saveList=val.split(" ").sort(function(a,b){return b-a}))})};ChoiceScriptSavePlugin._init=function(){if("file:"===window.location.protocol&&(typeof window.uploadedFiles==="undefined"&&typeof allScenes==="undefined")){setTimeout(ChoiceScriptSavePlugin._init,3e3);return}if(!window.storeName){Scene.validCommands["sm_save"]=0;Scene.validCommands["sm_load"]=0;Scene.validCommands["sm_delete"]=0;Scene.validCommands["sm_menu"]=0;Scene.validCommands["sm_menu"]=0;return alertify.error("Disabling ChoiceScript Save Plugin as there is no storeName detected. Please check your index.html.")}ChoiceScriptSavePlugin._populateSaveMenu(ChoiceScriptSavePlugin._createQuickSaveMenu())};ChoiceScriptSavePlugin.save=function(){if(stats.sceneName=="choicescript_stats"){alert("Error: Unable to save at this point.");return}var date=new Date;var message="What would you like to call this save?<br>Leaving this blank will result in a scene and date identifier.";alertify.prompt(message,function(e,saveName){if(e){ChoiceScriptSavePlugin._save(date.getTime(),saveName)}else{}},"Quick Save")};ChoiceScriptSavePlugin.delete=function(){var select=document.getElementById("quickSaveMenu");if(select.value<=0)return;var message="Delete save '"+select.options[select.selectedIndex].text+"'?<br>This cannot be undone!";alertify.confirm(message,function(result){if(!result){return}else{ChoiceScriptSavePlugin._delete(parseInt(select.value))}})};ChoiceScriptSavePlugin.load=function(){var select=document.getElementById("quickSaveMenu");if(select.value<=0)return;alertify.confirm("Are you sure you wish to load this save?<br>Current progress will be lost!",function(result){if(!result){return}else{ChoiceScriptSavePlugin._load(select.value)}})};setTimeout(ChoiceScriptSavePlugin._init,3e3);
;
nav = new SceneNavigator([
 "startup",
 "chapter0",
 "chapter1",
 "chapter2",
 "chapter3",
 "chapter4",
 "chapter5",
 "ending",
 "eric_fight",
 "eric_subplot",
 "katie_fight",
 "katie_subplot",
 "danny_fight",
 "danny_subplot",
 "chloe_fight",
 "chloe_subplot",
 "afterhours",
 "training_montages",
 "upgrades",
 "utils"
]);
stats = {
 "implicit_control_flow": "true",
 "choice_title": "Below the Skyline",
 "show_stats_increase": "false",
 "current_month": "April",
 "current_year": "2024",
 "current_season": "spring",
 "gender": "None",
 "gender_num": "1",
 "first_name": "Boxing",
 "last_name": "Enthusiast",
 "he": "he",
 "him": "him",
 "stat_power": "10",
 "stat_technique": "10",
 "stat_toughness": "10",
 "stat_mental": "10",
 "stat_energy": "100",
 "adj_power": "10",
 "adj_technique": "10",
 "adj_toughness": "10",
 "adj_mental": "10",
 "boxing_insights_unspent": "0",
 "boxing_insights_spent": "0",
 "trait_analysis": "0",
 "trait_composure": "0",
 "trait_empathy": "0",
 "highest_trait": "analysis",
 "highest_trait_num": "0",
 "jab": "[i]Fast Jab[/i]",
 "jab_level": "0",
 "flurry": "[i]Desperate Rush[/i]",
 "flurry_level": "0",
 "combo": "[i]Beginner's Luck[/i]",
 "combo_level": "0",
 "block": "[i]Panicked Block[/i]",
 "block_level": "0",
 "dodge": "[i]No Dodge Training[/i]",
 "dodge_level": "0",
 "counter": "[i]Untrained Counter[/i]",
 "counter_level": "0",
 "police_crackdown_active": "false",
 "eric_fought": "false",
 "katie_fought": "false",
 "danny_fought": "false",
 "chloe_fought": "false",
 "camille_fought": "false",
 "highest_friendship": "none",
 "highest_friendship_num": "0",
 "eric_subplot_scene": "1",
 "eric_subplot_status": "locked",
 "eric_friendship": "0",
 "eric_romance": "0",
 "eric_harmony": "50",
 "katie_subplot_scene": "1",
 "katie_subplot_status": "locked",
 "katie_friendship": "0",
 "katie_romance": "0",
 "danny_subplot_scene": "1",
 "danny_subplot_status": "locked",
 "danny_friendship": "0",
 "danny_investigation_success": "false",
 "chloe_subplot_scene": "1",
 "chloe_subplot_status": "locked",
 "chloe_friendship": "0",
 "chloe_romance": "0",
 "chloe_trauma": "0",
 "eric_plot_timer": "0",
 "katie_plot_timer": "0",
 "danny_plot_timer": "0",
 "chloe_plot_timer": "0",
 "eric_unvisited_timer": "0",
 "katie_unvisited_timer": "0",
 "danny_unvisited_timer": "0",
 "chloe_unvisited_timer": "0",
 "eric_almost_lapsed": "false",
 "katie_almost_lapsed": "false",
 "danny_almost_lapsed": "false",
 "chloe_almost_lapsed": "false",
 "fighting_power": "0",
 "trait_bonus_amount": "0",
 "trait_bonus_applied": "0",
 "upgrade_multiplier": "0",
 "upgrade_bonus": "0",
 "fight_momentum": "3",
 "fight_opponent_name": "Opponent",
 "record_wins": "1",
 "record_losses": "0",
 "record_draws": "0",
 "unlocked_eric_training": "false",
 "unlocked_katie_training": "false",
 "unlocked_danny_training": "false",
 "unlocked_chloe_training": "false",
 "can_spend_insight": "false",
 "jab_upgradeable": "false",
 "flurry_upgradeable": "false",
 "combo_upgradeable": "false",
 "block_upgradeable": "false",
 "dodge_upgradeable": "false",
 "counter_upgradeable": "false",
 "training_power_scene": "0",
 "training_technique_scene": "0",
 "training_toughness_scene": "0",
 "training_mental_scene": "0",
 "training_eric_available_scene": "0",
 "training_eric_unavailable_scene": "0",
 "training_katie_available_scene": "0",
 "training_katie_unavailable_scene": "0",
 "training_danny_available_scene": "0",
 "training_danny_unavailable_scene": "0",
 "training_chloe_available_scene": "0",
 "training_chloe_unavailable_scene": "0",
 "training_rest_scene": "0"
};
purchases = {};
achievements = [];
nav.setStartingStatsClone(stats);if (achievements.length) {
  nav.loadAchievements(achievements);
}
if (nav.loadProducts) nav.loadProducts([], purchases);
</script><style>html {
  font: -apple-system-body; /* we'll override the font, but keep the size from iOS dynamic text sizing */
}

body {
  position: relative;
  max-width: 80ch;
  min-height: 100vh; /* keep iOS address bar from popping in and out */
  font-size: 100%;  /* reset for CWS */
  font-family: Georgia,"Times New Roman",serif;
  background-color: #F7F4F1;
  color: rgba(0, 0, 0, 0.85);
  margin: 1ch auto;
  padding: 0;
  -webkit-user-select: text; /* selectable text for Chrome app support */
  transition-property: background-color, color;
  transition-duration: 2s;
  -webkit-transition-property: background-color, color;
  -webkit-transition-duration: 2s;
}

a {
  /* colored underlined links for XULRunner support */
  color: blue;
  text-decoration: underline;
  cursor: pointer;
}

#main {
	line-height: 1.5;
}

.container {
  position: absolute; /* so containers can overlap */
  left: 0;
  right: 0;
  margin: 0 1ch;
  animation-duration: 0.5s;
  -webkit-animation-duration: 0.5s;
  transition-property: opacity;
  transition-duration: 0.5s;
  transition-timing-function: ease-in;
  -webkit-transition-property: opacity;
  -webkit-transition-duration: 0.5s;
  -webkit-transition-timing-function: ease-in;
}

@keyframes containerslidein {
  from {
    transform: translateX(100%);
  }

  to {
    transform: none;
  }
}

@-webkit-keyframes containerslidein {
  from {
    -webkit-transform: translateX(100%);
  }

  to {
    -webkit-transform: none;
  }
}

.tempfocus:focus {
  outline: none;
}

#loading {
  position: fixed;
  bottom: 0;
  right: 0;
}

.frozen {
  overflow-x: hidden;
  pointer-events: none;
}

#text img {
  max-width: 100%;
}

/*credits*/
#main.container img {
  max-width: 100%;
}

.statBar {
  background-color: #949291;
  height: 2rem;
  line-height: 2rem;
  margin: 0.5ch 0;
  width: 20rem;
  max-width: 100%;
  color: #f7f4f1;
  position: relative; /* to allow absolute positioned value */
  z-index: 0;
}
.opposed {
  background-color: #6D6DFC;
}

table {
  margin-bottom: 1.5em;
}

.statText {
  margin-left: 2ex;
  text-indent: -1ex;
}

.statBar > span, .statLine > span {
  position: relative;
  z-index: 1; /* visible over stat value */
  white-space: nowrap; /* remain on single line so we can resize font based on width */
}
.statValue {
  background-color: #ff5955;
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  z-index: -1;
  /* width will be determined at runtime, 0-100% */
}

.choice {
  margin: 1rem 0;
}

.choice > div {
  position: relative; /* so the .shuttle can be positioned absolutely within it */
  min-height: 1.25cm;
  display: flex;
  flex-direction: column;
  justify-content: center;
  border-color:#a9acaf;
  border-style:solid;
  border-width: 1px 1px 0px 1px;
}

.choice label{
    transition-property: background-color, color;
    transition-duration: 0.1s;
    -webkit-transition-property: background-color, color;
    -webkit-transition-duration: 0.1s;
    -webkit-tap-highlight-color: transparent;
    padding: 0.5em 1ch;
    display:block;
}

.shuttle {
  position: absolute;
  right: 0px;
  top: 0px;
  width: 20%;
  height: 100%;
  background-color: #626160; /* match next */
  opacity: 0.25;
  transition-property: opacity;
  transition-duration: 0.3s;
  -webkit-transition-property: opacity;
  -webkit-transition-duration: 0.3s;
}

.shuttle.discovery {
  width: 20%;
  animation-name: shuttlefadein, shuttleslide, shuttlefadeout;
  animation-duration: 0.75s, 1s, 1s;
  animation-delay: 0s, 0.75s, 1.75s;
  -webkit-animation-name: shuttlefadein, shuttleslide, shuttlefadeout;
  -webkit-animation-duration: 0.75s, 1s, 1s;
  -webkit-animation-delay: 0s, 0.75s, 1.75s;
}

@keyframes shuttlefadein {
  from {opacity: 0;}
  to {opacity: 0.25;}
}

@keyframes shuttlefadeout {
  from {opacity: 0.25; transform: translateX(-401%);} /* borders, maybe? */
  to {opacity: 0; transform: translateX(-401%);}
}

@keyframes shuttleslide {
  from { opacity: 0.25; transform: translateX(0);}
  to { opacity: 0.25; transform: translateX(-401%); }
}

@-webkit-keyframes shuttlefadein {
  from {opacity: 0;}
  to {opacity: 0.25;}
}

@-webkit-keyframes shuttlefadeout {
  from {opacity: 0.25; -webkit-transform: translateX(-401%);} /* borders, maybe? */
  to {opacity: 0; -webkit-transform: translateX(-401%);}
}

@-webkit-keyframes shuttleslide {
  from { opacity: 0.25; -webkit-transform: translateX(0);}
  to { opacity: 0.25; -webkit-transform: translateX(-401%); }
}

.selected {
  color: rgba(255,255,255,0.85);
  background-color: #007AFF;
}

.selectedKeyboard, .choice>div.selectedKeyboard:hover, .next.selectedKeyboard {
  color: rgba(255, 255, 255, 0.85);
  background-color: #007AFF;
  transition-property: background-color, color;
  transition-duration: 0.5s;
  transition-timing-function: linear;
  -webkit-transition-property: background-color, color;
  -webkit-transition-duration: 0.5s;
  -webkit-transition-timing-function: linear;
}

.choice>div:first-child{
    border-top-width:1px;
    -webkit-border-top-right-radius:1ch;
    -webkit-border-top-left-radius:1ch;
    border-top-right-radius:1ch;
    border-top-left-radius:1ch;
}
/* IE doesn't support label:last-child */
.choice>div:last-child{
    border-bottom-width:1px;
    -webkit-border-bottom-right-radius:1ch;
    -webkit-border-bottom-left-radius:1ch;
    border-bottom-right-radius:1ch;
    border-bottom-left-radius:1ch;
}

.choice .noBorder {
  border-width: 0;
}

input[type="radio"], input[type="checkbox"] {
  margin-right: 1ch;
}

.saveGame>label {
  display:block;
}

.choice .disabled {
  color: gray;
}

input[type=password]:disabled {
  background-color: lightgray;
}

/* Reset for Firefox vs. Chrome */
input[type=email],input[type=password] {
  padding: 1px;
  margin: 2px 0;
}

button {
  font-size: 100%;
}

.next {
    clear: both;
    display:block;
    width:100%;
    font-size:1.5em;
    font-weight:bolder;
    font-family: -apple-system, sans-serif; /* reset, for Android */
    margin: 1rem 0; /* reset button margin */
    -webkit-appearance: none; /* Safari, don't override my CSS styles */
    color: #f7f4f1; /* Match background color */ 
    background-color: #626160;
    border: none;
    -webkit-border-radius: 0.5em;
    -moz-border-radius: 0.5em;
    border-radius: 0.5em;
    padding: 6px;
}

.linkButton {
  text-align: center;
  text-decoration: none;
}

.next:hover {
  color: #E4DED8;
}

h1 {
  font-size: 1.5em;
  font-weight: normal;
}

h2 {
  font-size: 1.125em;
  font-weight: normal;
}

#identity {
  float: right;
}

#identity > a {
  display: block;
  text-align: end;
}

#footer {
  margin:10px 0px 75px 0px;
}

#mobileLinks a img {
  border: 0;
}

.mobileBadges {
  margin: 0;
}

.spacedLink {
  margin-right:0.5em;
}

.spacedLink:last-child {
  margin-right:0;
}

#sharelist {
  margin: 0; /* Eliminate leading space before share links */
}

#sharelist li {
  line-height: 1cm; /* Don't let the links bunch up */
}

.alertify-cover {
  background-color: black;
  filter:alpha(opacity=50);
  opacity: 0.5;
}

#greybackground {
    position: fixed;
    width:100%;
    height:100%;
    background-color: black;
    filter:alpha(opacity=50);
    opacity: 0.5;
    top:0;
    left:0;
}

.savePassword {
  font-family: monospace;
  display: block;
}

.webOnly { /* We'll override this in JavaScript */
  display: none;
}

.alignleft {
  display: inline;
  float: left;
  margin-right: 1.625em;
  margin-bottom: 1.5em;
}
.alignright {
  display: inline;
  float: right;
  margin-left: 1.625em;
  margin-bottom: 1.5em;
}
.aligncenter {
  clear: both;
  display: block;
  margin-left: auto;
  margin-right: auto;
  margin-bottom: 1.5em;
}

#main form {
  clear: both;
}

.paidOnly {
  display: none;
}

.videoWrapper {
  position: relative;
  padding-bottom: 56.25%; /* 16:9 */
  height: 0;
}

.videoWrapper iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

body.nightmode {
  background-color: #242424;
  color: rgba(255,255,255,0.85);
}

body.nightmode a {
  color: #7bc8fa;
}

body.nightmode .next {
  color: #242424; /* Match background color */
  background-color: #D9D9D9;
}

body.nightmode .shuttle {
  background-color: #D9D9D9;
}

body.nightmode .next:hover {
  color: #555;
}

body.nightmode .alertify {
  color: black;
}

body.nightmode a.alertify-button {
  color: white;
}

body.nightmode img.invert {
  -webkit-filter: invert(100%);
  filter: invert(100%);
}

body.whitemode {
  background-color: white;
}

body.whitemode .next {
  color: white; /* Match background color */
}

body.whitemode .next:hover {
  color: #ddd;
}

/* hide <dialog> on old browsers */
dialog:not([open]) {
  display: none;
}

#keyboardShortcuts {
  font-family: system-ui;
}

#keyboardShortcuts::backdrop {
  background: rgba(0, 0, 0, 0.4);
}

#keyboardShortcuts header {
  display: flex;
  justify-content: space-between;
}

#keyboardShortcuts header span {
  font-weight: bold;
}

#keyboardShortcuts .table {
  display: grid;
  grid-template-columns: 1fr 1fr;
}

#keyboardShortcuts .table div {
  padding: 0.5em;
}

#keyboardShortcuts .key {
  background-color: ghostwhite;
  border: thin solid lightgrey;
  border-radius: 5px;
  padding: 0.3em;
  font-family: monospace;
}

#text .gameTitle {
  display: none;
}

@media (max-width: 480px) or (max-height: 640px) {
  .definition{
    display: none;
  }
  
  #headerLinks {
    display: none;
  }

  #title {
    font-size: 1.125em;
  }

  #author {
    display: none;
  }

  #text .gameTitle {
    display: block;
  }

  #advertisement {
    margin: -8px;
  }
  
  .mobileBadges {
    float: none;
  }
  
  #header {
    margin-top: 30px;
  }

  /** Floating images should leave enough room for text */
  #text .alignleft, #text .alignright {
    max-width: 45%;
  }
  
  #identity {
    display: none;
  }
}

@media (max-width: 375px) {
  #achievementsButton {
    display: none;
  }
}.alertify-show,
.alertify-log {
	-webkit-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1); /* older webkit */
	-webkit-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275);
	   -moz-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275);
	    -ms-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275);
	     -o-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275);
	        transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275); /* easeOutBack */
}
.alertify-hide {
	-webkit-transition: all 250ms cubic-bezier(0.600, 0, 0.735, 0.045); /* older webkit */
	-webkit-transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045);
	   -moz-transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045);
	    -ms-transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045);
	     -o-transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045);
	        transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045); /* easeInBack */
}
.alertify-cover {
	position: fixed; z-index: 99999;
	top: 0; right: 0; bottom: 0; left: 0;
}
.alertify {
	position: fixed; z-index: 99999;
	top: 50px; left: 50%;
	width: 550px;
	margin-left: -275px;
}
	.alertify-hidden {
		top: -50px;
		visibility: hidden;
	}
.alertify-logs {
	position: fixed;
	z-index: 5000;
	bottom: 10px;
	right: 10px;
	width: 300px;
}
	.alertify-log {
		display: block;
		margin-top: 10px;
		position: relative;
		right: -300px;
	}
	.alertify-log-show {
		right: 0;
	}
	.alertify-dialog {
		padding: 25px;
	}
		.alertify-resetFocus {
			border: 0;
			clip: rect(0 0 0 0);
			height: 1px;
			margin: -1px;
			overflow: hidden;
			padding: 0;
			position: absolute;
			width: 1px;
		}
		.alertify-inner {
			text-align: center;
		}
		.alertify-text {
			margin-bottom: 15px;
			width: 100%;
			-webkit-box-sizing: border-box;
			   -moz-box-sizing: border-box;
			        box-sizing: border-box;
			font-size: 100%;
		}
		.alertify-buttons {
		}
			.alertify-button {
				/* line-height and font-size for input button */
				line-height: 1.5;
				font-size: 100%;
				display: inline-block;
				cursor: pointer;
				margin-left: 5px;
			}

@media only screen and (max-width: 680px) {
	.alertify,
	.alertify-logs {
		width: 90%;
		-webkit-box-sizing: border-box;
		   -moz-box-sizing: border-box;
		        box-sizing: border-box;
	}
	.alertify {
		left: 5%;
		margin: 0;
	}
}
/**
 * Default Look and Feel
 */
.alertify,
.alertify-log {
	font-family: sans-serif;
}
.alertify {
	background: #FFF;
	border: 10px solid #333; /* browsers that don't support rgba */
	border: 10px solid rgba(0,0,0,.7);
	border-radius: 8px;
	box-shadow: 0 3px 3px rgba(0,0,0,.3);
	-webkit-background-clip: padding;     /* Safari 4? Chrome 6? */
	   -moz-background-clip: padding;     /* Firefox 3.6 */
	        background-clip: padding-box; /* Firefox 4, Safari 5, Opera 10, IE 9 */
}
	.alertify-text {
		border: 1px solid #CCC;
		padding: 10px;
		border-radius: 4px;
	}
	.alertify-button {
		border-radius: 4px;
		color: #FFF;
		font-weight: bold;
		padding: 6px 15px;
		text-decoration: none;
		text-shadow: 1px 1px 0 rgba(0,0,0,.5);
		box-shadow: inset 0 1px 0 0 rgba(255,255,255,.5);
		background-image: -webkit-linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
		background-image:    -moz-linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
		background-image:     -ms-linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
		background-image:      -o-linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
		background-image:         linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
	}
	.alertify-button:hover,
	.alertify-button:focus {
		outline: none;
		box-shadow: 0 0 15px #2B72D5;
		background-image: -webkit-linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
		background-image:    -moz-linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
		background-image:     -ms-linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
		background-image:      -o-linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
		background-image:         linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
	}
	.alertify-button:active {
		position: relative;
		top: 1px;
	}
		.alertify-button-cancel {
			background-color: #FE1A00;
			border: 1px solid #D83526;
		}
		.alertify-button-ok {
			background-color: #5CB811;
			border: 1px solid #3B7808;
		}
		
.alertify-log {
	background: #1F1F1F;
	background: rgba(0,0,0,.9);
	padding: 15px;
	border-radius: 4px;
	color: #FFF;
	text-shadow: -1px -1px 0 rgba(0,0,0,.5);
}
	.alertify-log-error {
		background: #FE1A00;
		background: rgba(254,26,0,.9);
	}
	.alertify-log-success {
		background: #5CB811;
		background: rgba(92,184,17,.9);
	}</style></head>
<body><div class="container" id="container1">
<div id="advertisement">
</div>
<div id="header">
  <div id="identity"><a href="#" id="email" style="display: none">you@example.com</a>
  <a href="#" onclick="logout(); loginDiv(); return false;" id="logout" style="display: none">Sign Out</a>
  </div>

  <h1 class='gameTitle'>Below the Skyline</h1>
<h2 id="author" class="gameTitle">by dozendietcokesaday</h2>

  <p id="headerLinks">
      <!-- <a href="credits.html" id="aboutLink" class="spacedLink">About</a> -->
    </p>
  <p id="buttons">
    <button id="statsButton" class="spacedLink" onclick="showStats()">Show Stats</button>
    <button id="achievementsButton" onclick="showAchievements()" class="spacedLink" style="display: none">Achievements</button>
    <button id="bugButton" onclick="reportBug()" class="spacedLink" style="display: none">Report Bug</button>
    <button id="menuButton" onclick="showMenu()" class="spacedLink">Menu</button>
  </p>
</div>
<div id="main">
<div id="text">
</div>
<script>
startLoading();
</script>
</div>
<div id="mobileLinks" class="webOnly">
</div>
<noscript>
<p>This game requires JavaScript; please enable JavaScript and refresh this page.</p>
</noscript>
<p><a id="makeyourowngames" href="https://www.choiceofgames.com/make-your-own-games/choicescript-intro/">Make your own games with ChoiceScript</a></p>
<div id="tools"></div>
<script type="module">
if (window.location.hostname === 'localhost') {
  const links = ['quicktest', 'randomtest', 'compile'];
  await Promise.all(Object.values(links).map(async file => {
    const link = `../../${file}.html`;
    const response = await fetch(link);
    if (!response.ok) throw new Error(`invalid link ${link}: ${response.status} ${response.statusText} ${await response.text()}`);
  }));
  window.tools.innerHTML = `
    <p>Tests: <a href="../../quicktest.html">Quicktest</a> <a href="../../randomtest.html">Randomtest</a></p>
    <p><a href="../../compile.html">Export to HTML</a></p>
  `
}
</script>
<dialog id="keyboardShortcuts" onclick="event.target === this && this.close()">
<header><span>Keyboard Shortcuts</span> <form method=dialog><button>X</button></form></header>
<div class="table">
  <div>Scroll Down</div>
  <div><span class="key">Space</span></div>
  <div>Scroll Up</div>
  <div><span class="key">Shift</span> + <span class="key">Space</span></div>
  <div>Next Option</div>
  <div><span class="key">J</span></div>
  <div>Previous Option</div>
  <div><span class="key">K</span></div>
  <div>Next (Press and Hold)</div>
  <div><span class="key">Enter</span></div>
  <div>Jump to Option</div>
  <div><span class="key">1</span> - <span class="key">9</span></div>
  <div>Show Stats</div>
  <div><span class="key">Q</span></div>
  <div>Menu</div>
  <div><span class="key">W</span></div>
  <div>Show Shortcuts</div>
  <div><span class="key">?</span></div>
</div>
</dialog>
</body>
</html>
