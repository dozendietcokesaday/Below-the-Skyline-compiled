<!DOCTYPE html>
<html>
<!--
Copyright 2010 by Dan Fabulich.

Dan Fabulich licenses this file to you under the
ChoiceScript License, Version 1.0 (the "License"); you may
not use this file except in compliance with the License. 
You may obtain a copy of the License at

 http://www.choiceofgames.com/LICENSE-1.0.txt

See the License for the specific language governing
permissions and limitations under the License.

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
either express or implied.
-->
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name = "viewport" content = "width = device-width, initial-scale = 1.0, maximum-scale = 1.0">
<!-- INSERT correct meta values -->
<!-- <title>Below the Skyline</title> -->

<script>window.version="UNKNOWN"</script>





<style id="dynamic"></style>






<!--[if IE 6]><style>.alertify-logs { position: absolute; }</style><![endif]-->
<meta name="apple-mobile-web-app-capable" content="yes" />
<script>
// INSERT store name; disabled by default because it's confusing for newbie authors
window.storeName = "Below the Skyline";
//Scene.generatedFast = true;
var rootDir = "../";
</script><meta property="ifiction:ifid" content="8537D9F5-10FA-45BB-916E-73403C5C79EA" prefix="ifiction: http://babel.ifarchive.org/protocol/iFiction/"><script>allScenes = {"startup": {"crc":-702246385, "lines":["*create implicit_control_flow true","*title Below the Skyline","*author dozendietcokesaday","*ifid 8537d9f5-10fa-45bb-916e-73403c5c79ea","*scene_list","    chapter0","    chapter1","    chapter2","    chapter3","    chapter4","    ending","    eric_fight","    eric_subplot","    katie_fight","    katie_subplot","    danny_fight","    danny_subplot","    chloe_fight","    chloe_subplot","    training_montages","    upgrades","    utils","","*comment Gender choice","*create gender \"None\"","*create gender_num 1","*create first_name \"Boxing\"","*create last_name \"Enthusiast\"","*create he \"he\"","","*comment core stats","*create stat_power 10","*create stat_technique 10","*create stat_toughness 10","*create stat_mental 10","*create stat_energy 100","*create adj_power 0","*create adj_technique 0","*create adj_toughness 0","*create adj_mental 0","*create boxing_insights 0","","*comment Analysis: Calculation, Framing, Observation.","*comment Composure: Discipline, Restraint, Equanimity.","*comment Empathy: Sensitivity, Resonance, Recognition","*create trait_analysis 0","*create trait_composure 0","*create trait_empathy 0","*create highest_trait \"analysis\"","*create highest_trait_num 0","","*comment starting boxing moves","*create jab \"[i]Fast Jab[/i]\"","*create jab_level 0","*create flurry \"[i]Desperate Rush[/i]\"","*create flurry_level 0","*create combo \"[i]Beginner's Luck[/i]\"","*create combo_level 0","*create ultimate \"[i]Last Resort[/i]\"","*create ultimate_level 0","*create block \"[i]Panicked Block[/i]\"","*create block_level 0","*create parry \"[i]Reflex Flinch[/i]\"","*create parry_level 0","*create dodge \"[i]No Dodge Training[/i]\"","*create dodge_level 0","*create counter \"[i]Untrained Counter[/i]\"","*create counter_level 0","","*comment story flags","*create food_expo_companion \"None\"","*create police_crackdown_active False","*create eric_fought False","*create katie_fought False","*create danny_fought False","*create chloe_fought False","*create camille_fought False","","*comment characters","*comment char_subplot_status enum is \"locked\", \"available\", \"rejected\", \"finished\"","*create eric_subplot_scene 1","*create eric_subplot_status \"locked\"","*create eric_friendship 0","","*create katie_subplot_scene 1","*create katie_subplot_status \"locked\"","*create katie_friendship 0","","*create danny_subplot_scene 1","*create danny_subplot_status \"locked\"","*create danny_friendship 0","*create danny_investigation_success False","","*create chloe_subplot_scene 1","*create chloe_subplot_status \"locked\"","*create chloe_friendship 0","","*comment character cooldowns","*create eric_plot_timer 0","*create katie_plot_timer 0","*create danny_plot_timer 0","*create chloe_plot_timer 0","","*comment internal calculations for fighting power","*create fighting_power 0","*create trait_bonus_amount 0","*create trait_bonus_applied 0","*create upgrade_multiplier 0","*create upgrade_bonus 0","","*comment fight momentum ranges from 0 to 10. 0 means PC almost lost, 10 means PC almost won","*create fight_momentum 3","*create fight_opponent_name \"Opponent\"","","*comment stats screen display info","*create record_wins 1","*create record_losses 0","*create record_draws 0","","*comment training options unlocks","*create unlocked_eric_training False","*create unlocked_katie_training False","*create unlocked_danny_training False","*create unlocked_chloe_training False","","*create dieroll 0","","*comment Boxing insight mechanics","*create can_spend_insight False","*create jab_upgradeable False","*create flurry_upgradeable False","*create combo_upgradeable False","*create ultimate_upgradeable False","*create block_upgradeable False","*create parry_upgradeable False","*create dodge_upgradeable False","*create counter_upgradeable False","*create dodge_learnable False","*create counter_learnable False","","*finish",""], "labels":{}},
"choicescript_stats": {"crc":-1426133235, "lines":["[b]${first_name} ${last_name}, a boxing enthusiast[/b]","*line_break","\"I just want to improve my boxing.\"","","[b]Stats[/b]","*stat_chart","    percent stat_power Power","    percent stat_technique Technique","    percent stat_toughness Toughness","    percent stat_mental Mental","    percent stat_energy Energy","","[i]Power[/i] \u2014 Raw striking force. Used for heavy punches, breaking guards, and finishing moves.","","[i]Technique[/i] \u2014 Precision, control, and footwork. Used for dodging, timing, and clean hits.","","[i]Toughness[/i] \u2014 Endurance, stability, and pain tolerance. Used for absorbing hits, maintaining defense, and lasting through long exchanges.","","[i]Mental[/i] \u2014 Awareness, composure, and strategic focus. Used for reading opponents and adapting under pressure.","","Most combat choices test 1\u20132 of these stats. Higher scores mean better outcomes.","","[b]Traits[/b]","*line_break","*if highest_trait_num >= 2","    *if highest_trait = \"analysis\"","        [i]Your current dominant trait is: Analysis[/i]","","        You examine situations from a distance. You prioritise structure, patterns, and hidden logic. Your decisions often come from observation and inference, not from impulse or emotion.","    *elseif highest_trait = \"composure\"","        [i]Your current dominant trait is: Composure[/i]","","        You keep a steady centre. You resist panic, stay grounded under pressure, and choose discipline. When things unravel, you don't.","    *elseif highest_trait = \"empathy\"","        [i]Your current dominant trait is: Empathy[/i]","","        You tend to notice emotions others overlook. You respond to vulnerability, track unspoken cues, and make decisions shaped by resonance more than logic or discipline.","    *else","        *bug Invalid highest_trait","*else","    [i]You don't have a dominant trait yet.[/i]","","    So far, your decisions have been balanced across different approaches. No single pattern stands out. That may change as the story unfolds.","","[b]Boxing Skills[/b]","","*if jab_level = 0","    [i]Quick Jab[/i] \u2014 A light, fast strike that interrupts momentum or checks distance. Lacks power.","*elseif jab_level = 1","    [i]Sharp Jab[/i] \u2014 A clean, tight strike. Fast enough to interrupt, accurate enough to probe.","*elseif jab_level = 2","    [i]Tuned Jab[/i] \u2014 Weight, timing, and placement all align. A jab you can throw without thinking. Lands where it needs to, when it needs to.","*else","    *bug Jab only upgradeable to level 2","","*if flurry_level = 0","    [i]Desperate Rush[/i] \u2014 Charges forward with a flurry of arm punches, exhausting yourself quickly.","*elseif flurry_level = 1","    [i]Fast Combination[/i] \u2014 A rapid sequence of strikes. Still reckless, but lands more cleanly before losing steam.","*elseif flurry_level = 2","    [i]Timed Flurry[/i] \u2014 A measured burst thrown in rhythm. Aggressive without over-committing.","*else","    *bug Flurry only upgradeable to level 2","","*if combo_level = 0","    [i]Beginner's Luck[/i] \u2014 A jab-cross-hook combo that sometimes lands cleanly, more by instinct than intention.","*elseif combo_level = 1","    [i]Standard Combo[/i] \u2014 A reliable one-two-hook delivered with solid mechanics. Effective when the opening's there.","*elseif combo_level = 2","    [i]Adaptive Chain[/i] \u2014 A flexible sequence thrown in response to openings. Adjusts rhythm and angle mid-flow to maintain pressure.","*elseif combo_level = 3","    [i]Layered Sequence[/i] \u2014 A multi-phase combination designed to bait reactions and exploit them. Less about speed, more about control and intent.","*else","    *bug Combo only upgradeable to level 3","","*if ultimate_level = 0","    [i]Last Resort[/i] \u2014 Pours everything into one massive punch, ignoring defence completely.","*elseif ultimate_level = 1","    [i]Set Piece Strike[/i] \u2014 A committed finisher built off a clean setup. Risky, but not desperate.","*elseif ultimate_level = 2","    [i]Fight-Ender[/i] \u2014 A signature move that reads rhythm, exploits patterns, and ends the match.","*else","    *bug Ultimate only upgradeable to level 2","","*if block_level = 0","    [i]Panicked Block[/i] \u2014 Covers up under pressure, often leaving the body exposed.","*elseif block_level = 1","    [i]Basic Guard[/i] \u2014 A stable shell defence that absorbs hits on the arms and gloves. Reduces damage but limits visibility.","*elseif block_level = 2","    [i]Read-and-Shell[/i] \u2014 A reactive, compact guard that absorbs pressure while tracking incoming attacks. Focuses on timing, not just survival.","*else","    *bug Block only upgradeable to level 2","","*if parry_level = 0","    [i]Flinch Parry[/i] \u2014 Instinctive swats that sometimes redirect attacks, sometimes make things worse.","*elseif parry_level = 1","    [i]Guided Parry[/i] \u2014 Redirects force cleanly with the right timing. Still unreliable under pressure.","*elseif parry_level = 2","    [i]Displacement Touch[/i] \u2014 Subtly disrupts balance rather than blocking. Breaks momentum, not contact.","*elseif parry_level = 3","    [i]Flow Intercept[/i] \u2014 Reads intent through pressure and placement. Disrupts attacks before they fully form.","*else","    *bug Parry only upgradeable to level 3","","*if dodge_level = 0","    *comment empty","*elseif dodge_level = 1","    [i]Basic Slip[/i] \u2014 Avoids predictable strikes with small, timed shifts. Most effective when the rhythm is obvious.","*elseif dodge_level = 2","    [i]Ghost Step[/i] \u2014 Disappears from centreline just long enough to avoid impact. Resets before the opponent can follow.","*elseif dodge_level = 3","    [i]Untouchable Rhythm[/i] \u2014 Movement never lands where expected. Dodges preemptively, leaving attacks stranded in empty space.","*else","    *bug Dodge only upgradeable to level 3","","*if counter_level = 0","    *comment empty","*elseif counter_level = 1","    [i]Basic Counter[/i] \u2014 Slips a predictable strike and returns a clean, single hit. Requires the right moment.","*elseif counter_level = 2","    [i]Snapping Return[/i] \u2014 Keeps distance tight enough to bait contact, then punishes overreach precisely.","*elseif counter_level = 3","    [i]Interrupt Window[/i] \u2014 Exploits hesitation or bad rhythm instantly. A counter that feels pre-loaded, waiting to fire.","*else","    *bug Counter only upgradeable to level 3","","[b]Fight record[/b]","*line_break","${record_wins}","*if record_wins = 1","    win,","*else","    wins,","${record_losses}","*if record_losses = 1","    loss,","*else","    losses,","${record_draws}","*if record_draws = 1","    draw","*else","    draws","","Boxing Insights: ${boxing_insights}"], "labels":{}},
"choicescript_upgrade": {"crc":0, "lines":[""], "labels":{}},
"chapter0": {"crc":-1158948210, "lines":["*image header.png","","Three months ago, you took up boxing as a New Year's resolution. Now you're slipping out of work early to fight strangers in basements and ferry terminals. It wasn't a plan. It just happened.","","Last week, you fought inside the half-abandoned Kwun Tong ferry pier. The crowd cheered for fighters they didn't know the names of. One guy in a cat mask bet on everyone. You won a lukewarm Vita lemon tea and a glutinous rice dumpling in a thin plastic bag.","","Hong Kong's underground fighting circuit isn't what the forums promised. No rankings, no brackets, no officials. Just stories traded in locker rooms. Fighters who do things that shouldn't be possible. A man who threw a fireball, the air distorting before it hit. The spectators barely blinked.","","There's no final boss. Just warehouses, abandoned nightclubs, and a city disappearing at the edges.","","You're not here to save the world. Just here to see what happens when you stop sitting it out.","","*page_break","The buzz of the crowd, the sweat in the air, the snap of a clean jab. It's a world away from your desk job. But even here, bureaucracy finds you. A bored-looking volunteer at a fold-out table gestures with a pen. \"Nobody cares who you are, just how you fight. But you still need to fill this in. How do you identify?\"","","*choice","    #She/Her. I'll use the default name of Claire Lau.","        *set gender \"Female\"","        *set first_name \"Claire\"","        *set last_name \"Lau\"","    #She/Her. I'd like to specify my own name.","        *set gender \"Female\"","        *gosub choose_name","    #He/Him. I'll use the default name of Steve Parker.","        *set gender \"Male\"","        *set first_name \"Steve\"","        *set last_name \"Parker\"","    #He/Him. I'd like to specify my own name.","        *set gender \"Male\"","        *gosub choose_name","    #They/Them. I'll use the default name of Leslie Cheung.","        *set first_name \"Leslie\"","        *set last_name \"Cheung\"","        *set gender \"Nonbinary\"","    #They/Them. I'd like to specify my own name.","        *set gender \"Nonbinary\"","        *gosub choose_name","*gosub set_pronouns","*finish","","","*label choose_name","What name will you declare to this underground world?","","My first name is:","*input_text first_name","","My surname is:","*input_text last_name","*return","","*label set_pronouns","*if gender = \"Female\"","    *set gender_num 1","    *set he \"she\"","*elseif gender = \"Male\"","    *set gender_num 2","    *set he \"he\"","*elseif gender = \"Nonbinary\"","    *set gender_num 3","    *set he \"they\"","*else","    *bug Invalid gender","*return"], "labels":{"choose_name":41,"set_pronouns":51}},
"chapter1": {"crc":1028327841, "lines":["*set fight_opponent_name \"Eric\"","Chapter 1: Eric \"Blazefist\" Jiang ","","Cold air, office chair that hates you, cramp in your toe. One hour until the meeting.","","You stare at the message on your phone. \"Opponent confirmed: Eric 'Blazefist' Jiang. 29th April.\"","","You exhale. Across the room, a colleague mutters in Cantonese, something about a client who sent six versions of the same Excel file and named them all \"final\".","","Blazefist. Last month, he knocked someone out with a flaming uppercut. A low quality video, catching the moment when the punch lands, fire trailing in its wake. The fight before that, he overshot a flying kick and took out two folding chairs.","","Eric's been fighting in the circuit for less than a year, and he's making waves. His fights have been a mixed bag of explosive wins and clumsy losses. Some nights he's on fire. Other times he throws haymakers at empty air while his opponent shuts him down.","","You? Three months of boxing, a jab that sort of works, and wrist pain opening jars.","","Boxing started as a way to stop doomscrolling and lose a few pounds. But something changed. You slammed a proper hit against the heavy bag. It felt like freedom. You kept going.","","Now you're skipping after-work drinks, telling your team leader you have yet another cousin's wedding to attend. She's starting to ask questions. How many cousins named \"Winnie\" can one person have?","","And your next fight is one month from today, against someone whose nickname sounds like a rejected video game boss.","","A fragrant waft of printer toner drifts past. The spreadsheet remains open, cursor blinking polite as ever. You close the tab. The fluorescent lights buzz louder than your thoughts.","","You check the time. 6:05 PM. Still early enough to get to the gym.","","[b]Do you want an explanation of the monthly cycle?[/b] Recommended for first-time players.","","*temp tutorial_mode False","*choice","    #Yes please.","        *set tutorial_mode True","        Monday, 1 April 2024","","        Your coach points at the calendar on the wall and explains how things work around here.","","        Each month splits into two fortnights where you make key decisions that shape your progress.","","        You'll choose how you train. Heavy bag work, roadwork, mental preparation \u2014 they affect your stats in different ways. As you build connections in the fighting scene, you'll learn new and unusual training methods.","","        You can also visit one character per fortnight. A visit might unlock a new training option, improve your skills, or grant [b]Boxing Insights[/b] \u2014 rare flashes of clarity from fights, revelations, or painful lessons.","","        At the end of the month, you can crystallise any [i]Boxing Insights[/i] into a stronger version of a boxing move. Each upgrade boosts your fighting power and may unlock new options in fights.","","        And then? You fight.        ","","        *page_break","    #No thanks.","        Monday, 1 April 2024","","        Outside, the city air sticks to your throat \u2014 pavement heat, engine fumes, curry fishballs. Five minutes from now, it'll be sweat and leather and ointment.","","        Mong Kok's alleys are pasted with decaying flyers calling patrons to questionable saunas and bygone concerts. Near the entrance to [i]MK Fight Gym[/i], a crumbling poster shows a child in uniform saluting. \"Embrace National Identity, Love Hong Kong.\" The corner peels a little more every week. Nobody touches it.","","        It all hits at once. The sweat, the damp leather, the smack of fists and feet on heavy bags. You automatically breathe deeper, like your body knows what to do here. [i]MK[/i] isn't polished. The ceiling fans rattle. The ring smells of Tiger Balm. But it's [i]your[/i] gym. None of those fancy personal trainers you get at corporate places. Just motion, impact, and people who remember your name.","","How will you use the first fortnight?","*gosub_scene utils fortnight_choice","Monday, 15 April 2024","*gosub_scene utils show_stats","","Mid-April. Your fight against Eric Jiang is too close.","","Your fingers twitch, already yearning to hit some pads. The gym's five minutes from your flat in Mong Kok, and it's feeling like a second home.","","Your flimsy calendar hangs on the wall, a promotional freebie salvaged from the office bin. [i]29th April[/i] is circled with thick black ink. Barely enough time to learn the basics, let alone fight someone whose punches literally caught fire last month.","","The early weeks felt almost playful. Now it's different \u2014 tighter guard, stricter drills, no space to coast. This is your last window to sharpen what little you've got before stepping into the ring.","","At [i]MK Fight Gym[/i], the mood has shifted. The cramped third-storey space on Tung Choi Street, usually full of trash talk and the slap of jump ropes, is quieter now. More focused. Coach Lam watches from the corner, arms folded across his faded Muay Thai T-shirt. The regulars know your fight's close.","","*gosub_scene utils fortnight_choice","Monday, 29 April 2024","*gosub_scene utils show_stats","","*if (tutorial_mode)","    Before you step into your first real fight, here's what matters:","","    The outcome of every fight depends on your decisions. When you choose an action, the game checks one or two of your core stats \u2014 [b]Power[/b], [b]Technique[/b], [b]Toughness[/b], or [b]Mental[/b].","","    Each action has a fixed difficulty. If your relevant stat(s) meet or exceed the requirement, you succeed. The outcome depends entirely on your build and decisions. Occasionally, small bonuses apply based on your temperament or boxing skills.","","    [b]Energy[/b] affects all of your stats. If it's below 100%, your stats will be penalised. Try to keep energy above 60%.","","    [b]Fight Momentum[/b] shows who has the advantage at any moment in time. It starts with both fighters evenly matched. As the fight progresses, the Fight Momentum will fluctuate. The final outcome is determined by the Fight Momentum at the conclusion of the match.","","    This is what Fight Momentum looks like:","","    *gosub_scene utils show_fight_momentum","","    The number of filled dots is 3 out of 10, so ${first_name} would currently be at a disadvantage.","","    Lastly, [b]you don't have to win every fight[/b]! You will not miss out on content if you lose fights.","    *page_break","","You pack your gym bag at 6:00 PM on the dot. No explanations. Just brief nods to your colleagues, who nod back, suspecting nothing.","","You board the MTR and squeeze into a packed carriage. The train rumbles past Yau Ma Tei and Jordan. Your stomach tightens. Close now.","","Tsim Sha Tsui. You ride the escalators up to gleaming skyscrapers and tourists flooding the streets. Mong Kok smoulders. But Tsim Sha Tsui shines \u2014 too polished, too clean.","","At the waterfront, you pause. Laser lights sweep across the skyline, while tourists snap selfies everywhere along the promenade. You keep moving, gym bag over your shoulder. Just another office worker. For now.","","You bounce on your toes, remembering Coach Lam's advice. Combinations. Footwork. Breath. This isn't a sanctioned fight. It's the circuit.","","Salt air fills your lungs. You glance at the harbour. Time to move.","","*page_break","*gosub_scene eric_fight fight","*set eric_subplot_status \"available\"","*set eric_fought True","*finish"], "labels":{}},
"chapter2": {"crc":2085775589, "lines":["*set fight_opponent_name \"Katie\"","Chapter 2: Katie \"Pressure Point\" Reynolds","","Tuesday, 30 April 2024","","You find yourself tracking your team leader's hand movements. Tells. A flick before a slip. You shake your head. The fight's over, but your mind hasn't caught up. You're reading marketing reports like they'll explode if handled wrong.","","By the time you reach your flat, exhaustion hits. You fumble with your key before you finally push through the door, and collapse onto your mattress, still in your street clothes. The fan ticks overhead, useless against the humid April heat. ","","It's barely a room \u2014 fold-up bed, desk, pull-up bar, all packed into one overheated box. No separation between work, sleep, training. Just zones for different kinds of tired.","","Outside, traffic glows and snarls ten floors below, with a noodle stall and 7-Eleven lighting the pavement. The rent eats half your salary. The rest goes to wraps, gloves, coaching. But the gym's five minutes away. The MTR's even closer. That's enough.","","Your jaw aches when you chew. The adrenaline's long gone, but your heart still jumps at loud noises. You still see it: Eric's [i]Energy Wave[/i], violent, sudden, real. The exchange of blows, where your boxing skills shone. Your first clean hit in a real match. You keep replaying it.","*if record_losses = 0","    The crowd cheered like it shouldn't have happened. Like they couldn't believe it. Part of you still doesn't.","*elseif record_losses = 1","    You lost. No surprise in the crowd. No shame in the ring.","*else","    *bug Invalid fight record","","*page_break","Wednesday, 1 May 2024","","It's bright. You squint. The aches arrive one by one: bruised ribs, sore arms, raw knuckles, a tender jaw. Your phone shows a message from Coach Lam.","","\"Heard about last night. Come see me.\"","","You grab buttered bread and congee from the stall downstairs, then head to the gym. It's quiet \u2014 public holiday. Coach Lam doesn't ask how you feel. He can see it. He just watches you move.","","\"You're doing this,\" he says finally. Not a question. \"Then we get serious.\"","","He slides a paper across: Katie Reynolds. \"Pressure Point.\"","","His expression flattens. \"She fights for different reasons. Not all of them involve winning.\"","","*page_break","Thursday, 2 May 2024","*gosub_scene utils show_stats","","You search for information about your next opponent. Most underground fighters have at least a few clips circulating. Katie is oddly absent. Forum comments, though, abound:","*line_break","\"Scariest fight of my life.\"","*line_break","\"Sheer terror.\"","*line_break","\"She was smiling the whole time.\"","","You stumble across an older thread where a user complains about \"new faces asking too many questions\" at recent fights. The next reply warns, \"wrong kind of interest,\" followed by complete silence, the conversation abruptly ceasing.","","At last, you find a video. Grainy, badly lit. A tall brunette woman in colourful workout gear (Jazzercise?) faces off against a larger man. The fight starts normally. Then she darts in and presses two fingers into his arm. He screams. Drops to the floor, cradling the limb. She beams, says something cheerful. The mic doesn't catch it.","","You snap the laptop shut, and your heel taps the floor, restless. Your fight with Eric involved energy waves and flaming fists. This is different. Colder.","","You stare at the blinking cursor on your marketing campaign spreadsheet, but all you can see is Katie's smile. And the scream.","","Four weeks. The spreadsheet can wait. You tape a fresh workout schedule to the wall.","","*gosub_scene utils fortnight_choice","","Between training sessions, you have time to check in with one person. Eric's offer to train at Eastside still stands, and there's value in learning from someone who's already seen the circuit from the inside. Later on, your options will widen, and the trade-offs will get sharper. But for now, this one's simple.","","*gosub_scene utils character_visit_choice","Thursday, 16 May 2024","*gosub_scene utils show_stats","","You've found three more photos of Katie online. Same bright smile in each. Same cheerful workout gear. Nothing that explains why grown men scream when she touches them.","","You print the clearest one and tape it next to your workout schedule. Her fingers look normal. Slender. Manicured. The kind that might teach yoga.","","But you've seen what they can do.","","Your training plan stares back, half-finished. Two weeks to prepare for something you don't understand.","","*gosub_scene utils fortnight_choice","*gosub_scene utils character_visit_options","*gosub_scene utils character_visit_choice","Thursday, 30 May 2024","*gosub_scene utils show_stats","","*if boxing_insights > 0","    *gosub_scene upgrades spend_insight_choices","","You leave at 6PM sharp, saying you have a family dinner to attend. The marketing reports can wait.","","Your gym bag feels different as you slip through the crowd. The adrenaline is already starting to fill your body in anticipation of tonight's fight with Katie \"Pressure Point\" Reynolds.","","The fight is in Mong Kok, within walking distance of your flat. A drab high-rise towers over the narrow street below. It appears abandoned from the outside, with peeling paint and blacked-out windows, as if it were slated for redevelopment and the developers were waiting for the last holdouts to give in. A mustachioed man at the side entrance nods you through when you give your name.","","Inside, the former nightclub has become a makeshift fighting area. You adjust your mouthguard, wrap your hands, finish your calisthenics and slip on the red 10oz gloves.","","The bookmaker from your match with Eric is here, near the ropes, hunched over a tablet. He glances at you for half a second, nods quickly, then looks back down, already updating something.","","As you get ready for the fight, you catch fragments of conversation from two fighters nearby. They aren't discussing your match, but something else that makes them glance around first. \"... too many new faces lately,\" one says. \"Not just fighters.\" They see you looking and clam up, moving away.","","Something's happening, you can feel it. But you banish the thought from your mind. Tonight, it's Katie you're facing. Whatever strange techniques she brings, you'll meet them the only way you know: with boxing punches.","","*page_break","*gosub_scene katie_fight fight","*set katie_subplot_status \"available\"","*set katie_fought True","*finish"], "labels":{}},
"chapter3": {"crc":-1297072384, "lines":["*set fight_opponent_name \"Danny\"","Chapter 3: Danny \"The Dragon\" Chan","","Friday, 31 May 2024","","You wake the next morning from uneasy dreams to find yourself confronted by an enormous mosquito. You grab the electric racket where it leans against the wall. The crackling [i]bzzt[/i] is too satisfying.","*if highest_trait = \"analysis\"","    You're already fully awake. Heart beating fast. ","*elseif highest_trait = \"composure\"","    Muscles ready. Still on edge after yesterday's fight.","*elseif highest_trait = \"empathy\"","    You feel everything. Even the fried mosquito smells of electricity.","*else","    *bug Invalid highest_trait","","The heat is a furnace without respite. It clings to you through the day like plastic wrap. You move slowly whenever you're in the open, drink more water. You even feel thankful when you're at the office, for the cool air conditioning. It makes the spreadsheets feel more meaningful.","","*page_break","","The next morning, your phone buzzes with a message from your promoter. \"Danny Chan. 30th June.\"","","You look it up. Danny \"The Dragon\" Chan, always clad in a distinctive yellow tracksuit with black stripes, has a large online presence. You find lots of forum posts and fan websites, enthusiastically analysing his technique. You find many high-resolution videos portraying a lean, middle-aged man who performs Bruce Lee's moves passionately, yet slowly. Surprisingly, you don't see any evidence that he's won a single match.","","The next day at [i]MK[/i], you ask Coach Lam if he knows anything more about Danny Chan. His expression changes. Respect?","","\"Danny Chan,\" he begins slowly. \"Self-taught Jeet Kune Do. Not the most talented fighter I've seen, but possibly the most dedicated.\" He guides your elbows lower. \"Don't let his record fool you. It might look like an easy win, but no one leaves a fight with Danny feeling like they've won.\"","","You nod. A guy who loses every match but still draws a crowd. Someone who gets tribute posts and dragon emojis and forum threads to celebrate his endless losses. Something makes people stay. You don't know why. But you keep watching.","","*choice","    #There's something admirable about that. The conviction. The devotion.","        *gosub_scene utils increase_composure","        It's not pride. Not stubbornness. Something else. You don't fully grasp it. A promise, or a vow. It feels close to something you've been feeling ever since you started fighting.","","        You can't yet imagine what it must mean to have this kind of faith. But you respect it.","","    #You're trying to feel if this is noble or just deluded.","        *gosub_scene utils increase_empathy","        He keeps getting knocked down. Keeps getting back up. You don't know if this is courage or folly.","","        But you know what happens when people stop. When they give up, when they back down.","","        Maybe this is what it looks like when someone refuses to disappear.","","    #His popularity makes sense. He doesn't need to win; he just needs to tell a compelling story.","        *gosub_scene utils increase_analysis","        Danny is a fighter, but he's also a mirror. His fans all see the losses. But each of them learns something different from that.","        ","        You keep reading. Detailed technical breakdowns. Match analyses. Even fan fiction. What you never find: excuses for his match record. The legend endures.","","*page_break","Saturday, 1 June 2024","*gosub_scene utils show_stats","","You find yourself rewatching Danny's fights in the evening. In one clip, he takes a brutal liver shot that should end the fight instantly. The camera zooms in on his prone form. He rises slowly, standing at the count of seven, then adjusts his black wristband and continues. In another video, completely outclassed, he absorbs heavy punishment but is unable to lay a finger on the opponent. Between rounds, he sits peacefully in his corner with the calm of a monk.","","A kind of legend, built on refusal alone.","","Your flat feels especially cramped tonight.  You close your laptop and press your face against the window. Hong Kong's night skyline compresses into a light show, thousands of lit and unlit windows reduced to pixels. A silent film playing out on a distant screen. You wonder if you're missing something, or if this is all there is.","","You push away from the window.","*if highest_trait = \"analysis\"","    Somewhere in that grid of light, Danny is training. The same inputs leading to the same outputs.","*elseif highest_trait = \"composure\"","    Somewhere out there, Danny trains \u2014 same as yesterday, same as tomorrow.","*elseif highest_trait = \"empathy\"","    Somewhere out there, Danny trains \u2014 alone, unnoticed. And he's fine with that.","*else","    *bug Invalid trait","","*gosub_scene utils fortnight_choice","*gosub_scene utils character_visit_options","*gosub_scene utils character_visit_choice","Saturday, 15 June 2024","*gosub_scene utils show_stats","","The second half of June. The heat outside blooms early and lingers late. Inside, though, it's the opposite. The office is a refrigerator. The MTR is cold enough that even the tight press of bodies doesn't provide enough warmth. You shiver through meetings, sweat on the brief walk to lunch, then shiver again back at your desk.","","At [i]MK Fight Gym[/i], the fans rattle and squeak, completely failing to dispel the heat. You sweat through it and walk home with your shirt stuck to your body. Your mind drifts to Danny again. You find yourself mouthing phrases he might say. [i]\"Adaptation, not imitation.\" \"Be like water.\"[/i] The words sound wise, until you picture him saying them while getting punched in the face.","","You give a short, involuntary laugh. But it doesn't feel funny.","*if highest_trait = \"analysis\"","    Maybe you need to approach things differently. You've been training for a physical fight. But he's fighting on a different level.","*elseif highest_trait = \"composure\"","    Whether he's a fighter, a symbol, or a myth, nothing changes. You train. You fight.","*elseif highest_trait = \"empathy\"","    Maybe you're missing something here. Danny doesn't seem to be trying to win. But he keeps showing up.","*else","    *bug Invalid trait","","You still have no idea how this fight will play out. Regardless, you'll be there.","","*gosub_scene utils fortnight_choice","*gosub_scene utils character_visit_options","*gosub_scene utils character_visit_choice","Sunday, 30 June 2024","*gosub_scene utils show_stats","","*if boxing_insights > 0","    *gosub_scene upgrades spend_insight_choices","","You tell your team leader that you have a family obligation and need to leave early. The underground circuit is increasingly interfering with your office life. And with several matches under your belt, you're no longer a total unknown.","","You push through the evening crowds, gym bag pressed against your shoulder. Your gear has improved since your first match; a properly fitted mouthguard, quality hand wraps, and sturdy leather gloves.","","Tonight you're fighting at an abandoned warehouse in Kwun Tong. The taxi driver shoots you a knowing look when you give him the address, but says nothing.","","The corrugated metal walls of the warehouse throw long shadows as the sun sets. Some kind of drum and bass track pulses through your feet before you even reach the entrance. Across the street, a small surveillance camera on a utility pole blinks red.","*if highest_trait = \"analysis\"","    Government, not private.","","The warehouse is dense and hot, hitting you with a cocktail of sweat, metal, and tropical fruits. The crowd strikes you the most. It must be almost a thousand strong, the warehouse packed nearly to capacity. Almost everyone sports yellow T-shirts with a black dragon silhouette.","","As you pass through the crowd, you spot Danny seated in a corner. He's staring at his shoes. A fan tries to snap a selfie with him. Danny doesn't notice.","","The bookmaker from your previous fights is seated near the front, tablet in hand, wearing a yellow dragon T-shirt like the rest of the audience. \"No odds tonight,\" he says. \"Betting would be disrespectful.\"","","He gestures at the crowd with his arm. \"People are here to witness.\"","","A thousand pilgrims, united in purpose. A sea of yellow. You don't know what role you play in this story. Disciple? Heretic? Your stomach tightens.","","*if highest_trait = \"analysis\"","    This feels familiar. Uniforms, symbols, chants. You recognise the pattern \u2014 it's the same energy that fuels mass movements. But there's no message, no demand. Just a collective promise to keep showing up.","*elseif highest_trait = \"composure\"","    You've been in crowds like this before, for causes you believed in. The most important principle is to keep showing up. For yourself, and for everyone else.","*elseif highest_trait = \"empathy\"","    This is a vigil. A vigil for an idea, one that might already be gone. The crowd isn't expecting Danny to win. They're just here to witness.","*else","    *bug Invalid trait","","*page_break","*gosub_scene danny_fight fight","*set danny_subplot_status \"available\"","*set danny_fought True","*finish"], "labels":{}},
"chapter4": {"crc":-1063654069, "lines":["*set fight_opponent_name \"Chloe\"","Chapter 4: Chloe \"Wildcard\" Lee","","[b]Content Advisory:[/b] This chapter's fight contains a scene of restricted breathing. Players sensitive to this theme should proceed with awareness.","","*page_break","Monday, 1 July 2024","","Your flat feels small this morning. You stay in your bed, letting the weight of yesterday's fight press down.","","*if (highest_trait = \"analysis\")","    It was technically a victory, but there's still one variable you couldn't calculate. Danny's serenity wasn't fear, showmanship, or discipline. An outlier that doesn't fit any pattern.","*elseif (highest_trait = \"composure\")","    It was technically a victory, but you're still off balance. Danny was calm, too calm. It wasn't defensive. It had nothing to do with victory or defeat. Just a quiet presence. You can't reduce it to a single aspect, like Eric's fire or Katie's precision.","*elseif (highest_trait = \"empathy\")","    It was technically a victory, but it didn't feel like one. One moment stands out: how Danny welcomed it. He wasn't stoic, wasn't proud. He was just there, his presence unchanged by victory or defeat.","*else","    *bug Invalid trait","","Danny hits the canvas from your combination. He rises. Again and again he rises, undisturbed despite the punishment. The scene keeps replaying throughout the day, pushing aside memories of Eric's blazing techniques and Katie's pressure point manipulation.","","Your office team barbecue is happening today \u2014 someone's cousin booked a pit at Tai Mei Tuk to take advantage of the public holiday, and now twenty colleagues are sweating under a metal shelter, half-heartedly waving paper fans as they crouch over glowing charcoal. The weather is oppressively humid, but the charcoal pit radiates dry heat. It's like enduring a dry sauna and a steam bath simultaneously. You find yourself thinking about training in this kind of heat.","","The food is chaotic. Fishballs sweat on bamboo skewers, their salty steam mixing with the sooty clouds of charcoal smoke. Foil-wrapped corn cobs hiss over the flame. Canned pineapple slices char at the edges. Hot dogs sag in plain Garden brand buns, buried in cloying chilli sauce. Smoke and sugar billow into the air. Someone hands you a skewer of honey-drizzled white bread, the edges charred black. \"You have to try this,\" they say, like it's standard barbecue fare. The scent is sticky and layered \u2014 charcoal, burnt sugar, vaporised meat juice. Every breath is a buffet.","","\"Whoa, ${first_name},\" someone says, eyes darting to your arms. \"Still keeping up the boxing?\"","","\"Looking strong,\" another adds, with a half-laugh that trails off. You smile, say something about early mornings and discipline, and they nod. Impressed, maybe, or just not sure what to say. It's not unfriendly. Just a small gap that didn't used to be there. Someone calls you over to help toast more bread, and the moment passes.","","*page_break","","Tuesday, 2 July 2024","*gosub_scene utils show_stats","","The next day, your phone buzzes with a text message. \"July card scheduled. Chloe 'Wildcard' Lee at The Cauldron. 27th, 9PM.\"","","Your coach frowns when you mention the name. \"Chloe Lee? She's a complicated one. Rich kid playing at being a fighter, but dangerous in her own way.\"","","\"How so?\" you ask.","","Your coach pauses, considering his words carefully. \"She fights like she has something to prove. And she particularly enjoys fighting at The Cauldron. Just be prepared for anything.\" He gazes out the window.","","You search for information online, finding few details about Chloe. The few clips available capture a young woman wearing what looks like designer athletic wear that's scuffed and dirtied. There's a delay between her setup and her strike \u2014 half a beat too long, then somehow it lands anyway. You don't know if she's improvising or baiting reactions. Forum posts describe her as the \"forgotten child of some property tycoon\" who fights with reckless abandon. Her style is described as \"erratic but effective,\" a chaotic performance hiding solid Muay Thai fundamentals.","","Danny fought like someone who had long since stopped expecting to win: each strike, each pause, each movement performed with quiet certainty no matter how many times it yielded nothing. Chloe doesn't offer that.","*if highest_trait = \"analysis\"","    Her timing is consistently misaligned. Strikes thrown too early, or too late to capitalise. It's a deliberate tactic to disrupt rhythm and scramble predictions. Victory by miscalibration.","*elseif highest_trait = \"composure\"","    She's not trying to outmatch. Just to provoke a flinch, a hesitation, a pattern break. Whatever this is \u2014 chaos or bait \u2014 you'll have to treat it like a storm. Hold centre. Let it pass through.","*elseif highest_trait = \"empathy\"","    She fights like someone who wants you off-balance, physically and emotionally. The rhythm, the feints, the smirks between strikes \u2014 none of it is random. It's curated unease.","*else","    *bug Invalid trait","","*gosub_scene utils fortnight_choice","*gosub_scene utils character_visit_options","*gosub_scene utils character_visit_choice","Tuesday, 14 July 2024","*gosub_scene utils show_stats","","Two weeks left. A clear picture of Chloe Lee remains frustratingly hard to piece together. You unearth another short clip, not a fight, but someone's candid phone footage from a gym. She shadowboxes for someone off-camera, winding up an over-the-top haymaker, fist rearing back and telegraphing wildly. Her expression momentarily hardens as she commits to the blow. In a blink, it transforms into a brutal elbow. Chloe pulls back just before it lands, dissolving into laughter. \"She's all performance until she isn't,\" a comment beneath it reads. \"And you don't know which is which until you're on the mat.\"","","This echoes what little else you've found: whispers of psychological games, of someone who derives as much satisfaction from unsettling her opponent as from landing a blow. One forum post is short, almost a throwaway line: \"Chloe Lee? Yeah, watch out. If she gets you down, she'll stay on you.\"","","It's hard to reconcile the image of a spoiled rich kid with the few clips showing legitimate Muay Thai skill. In the first half of a round, she throws crisp teeps and clean roundhouse kicks before dissolving into exaggerated stumbles and wild swings. Part performance artist, part trained fighter, with no clear boundary between the two. Maybe that's the test. Not what she'll do \u2014 but how long you'll believe it's a joke.","","You picture her, movement loose, unrepeatable, always half a second off-script. Nothing clean to counter. No patterns, no rhythm, no tells. Just pulse and noise and something underneath, laughing. And the Cauldron itself remains a question mark. \"Fights at The Cauldron always feel like they're one step away from chaos,\" one forum post notes.","","You finish your drills, but the gym feels different today. An oppressive quiet has replaced the usual rhythmic thudding, leaving only the wheeze of the overhead fan and the slap of your shoes on damp mats. Even your own breathing sounds too loud, echoing off the concrete walls like a trapped thing.","","As you pack up, Coach Lam lingers by the equipment rack, adjusting hand wraps that don't need adjusting, the familiar scratch of velcro and canvas unusually sharp in the hushed gym. \"Names dropping off the fight sheets,\" he mutters, fingers working a loop of hand wrap. \"Across a few spots. No one talking. Feels off.\"","","He doesn't elaborate. Just keeps straightening things that were already straight.","","*gosub_scene utils fortnight_choice","*gosub_scene utils character_visit_options","*gosub_scene utils character_visit_choice","Saturday, 27 July 2024","*gosub_scene utils show_stats","","*if boxing_insights > 0","    *gosub_scene upgrades spend_insight_choices","","Saturday night card. Four fights deep: enough for internet speculation, not enough for fans. Tonight: Chloe \"Wildcard\" Lee. Erratic pace, playful cruelty, impossible to read. Heiress, maybe. And The Cauldron, famed for its wild reputation. All of it unsettles you.","","You've drilled your fundamentals and rehearsed scenarios that probably won't happen. But nothing sticks. The rhythm fractures the moment you picture it. Every imagined exchange slips away sideways.","","The ride to Sheung Wan passes quickly, the carriage less crowded on weekend nights. The escalators stretch longer than they should, like a prank some architect got away with. Then street level: humidity hits like a wall, thick air that tastes of salt and dried squid from the seafood shops. Heat radiates up from concrete that's been baking all day. Your shoes stick slightly to the pavement with each step, leaving faint impressions on the softened asphalt. You find yourself checking reflections. Windows, passing metal \u2014 a scan for posture, tension, readiness.","","You follow the directions on your phone, down a side street, then into an even smaller alleyway. No signs, just a grey door painted over so many times the surface feels thick and uneven under your knuckles. A muffled thrum of bass vibrates through the metal and up through your bones, while the scent of stale cigarettes leaks from the gap beneath the door. Your hand rests lightly on the handle, the metal still warm.","","Some part of you knows this fight won't go to plan.","*if highest_trait = \"analysis\"","    Too many unstable variables: Chloe's unpredictability, The Cauldron's irregular conditions, Coach Lam's phrasing.","*elseif highest_trait = \"composure\"","    The test is how well you can absorb the chaos and stay standing.","*elseif highest_trait = \"empathy\"","    Something feels off. Not just danger, but dissonance, like the fight is a pretext for something else.","*else","    *bug Invalid trait","You step through anyway.","","*page_break","*gosub_scene chloe_fight fight","*set chloe_subplot_status \"available\"","*set chloe_fought True","*finish"], "labels":{}},
"ending": {"crc":-1037531127, "lines":["You've reached the end of the current content. Be sure to \"like\" and \"subscribe\" if you enjoyed it.","","*ending"], "labels":{}},
"eric_fight": {"crc":313191591, "lines":["*label fight","*temp dc_easy 10","*temp dc_medium 14","*temp dc_hard 18","*set fight_momentum 5","*set trait_bonus_amount 2","*gosub_scene utils calc_adj_stats","*comment If the player trains two separate stats, they'll be at effective stats 14/14/8/8. If they train one stat twice, 18/8/8/8","On the Kowloon side of Victoria Harbour, the usual tourist throng snapping skyline selfies is pushed back by temporary barricades. Beyond them, a rope circle marks the arena, floodlights cutting through the twilight and reflecting off the harbour's choppy surface. The scent of diesel from a passing Star Ferry mingles with the faint aroma of egg waffles from a distant food stall. A hum emanates from the crowd seated on the bleachers, punctuated by the rustle of banknotes at the bookmaker's tent.","","You're in the second match of the night, facing Eric \"Blazefist\" Jiang, his red gi catching the light as he warms up in his corner. A bookmaker with a digital tablet moves along the edge of the promenade, broadcasting odds and taking bets with the bored efficiency of someone who's seen too many fights.","","A single floodlight tower squats at each corner of the makeshift ring, throwing harsh shadows across a six-metre rope circle. Beyond the ropes, a one-metre safety strip of taped asphalt separates fighters from the first row of bleachers and the steel barricades that hold back the crowd. Victoria Harbour itself bumps right against the edge of the rope circle, a concrete railing at chest height the only protection against a tumble into the water.","","Stretching in your corner, you adjust your headgear. The padding feels slightly loose, and you can't get a comfortable fit. Three suited spectators, out of place amongst the T-shirts and casual wear, watch with unreadable expressions. One whispers something to another and taps at a phone. You shake your head slightly, turning your attention back to wrapping your hands.","","You pull on your red 10oz gloves, the insides stiff with dried sweat, and stand. The referee gestures you towards the rope circle. The fight is live.","","*choice","    #You regulate your breathing and control the tempo.","        *gosub_scene utils increase_composure","        You let your arms hang loose, shoulders soft, and take a slow breath. In through the nose. Out through the mouth. Nothing dramatic. The floodlights, the crowd noise, Eric's warm-up \u2014 you notice them, but they don't affect you. You're not here to react. You're new, but you're not rattled. You're centred. Grounded.","    #You tune into the energy in the air \u2014 yours and his.","        *gosub_scene utils increase_empathy","        You feel it before you move. A tightness in the chest. Your rhythm resonating with Eric's. He hasn't looked your way, but his breathing's suddenly regular. Slower. He's centring. You match it instinctively. The crowd fades. What matters is already happening \u2014 silent and invisible \u2014 between two fighters not yet in motion.","    #You break the fight down before it begins.","        *gosub_scene utils increase_analysis","        You break it down piece by piece. Ring dimensions: six metres across. Ropes: low enough to step over, tight enough to cut off lateral movement. Lighting: harsh, angled \u2014 hides high kicks, highlights feints, blinds you if you look up. Eric's stance: relaxed, but the bounce in his rear foot suggests aggression out of the gate. You tune out the crowd. This isn't an exhibition. It's a problem to solve.","","You touch gloves, a firm tap of leather on handwraps. The referee nods, steps back, and chops his hand downward. \"Fight!\"","","You start cautiously, guard up, advancing with measured steps. Eric sinks into a low stance. Both hands draw back near his right hip, elbows tight, palms cupped like they're holding water. A flicker of heat pulses between them. Then he pivots on his rear foot and drives forward with a full-body thrust. His palms snap open.","","The air distorts. A pulse of condensed heat roars out \u2014 chest-height, no wider than your torso. His [i]Energy Wave[/i] tears forward like a fastball, humming with static.","","*gosub_scene utils show_fight_momentum","","*choice","    #Use a ${block} to weather the impact.","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *if (adj_toughness + trait_bonus_applied) >= dc_easy","            You set your guard firmly as the energy projectile crashes against your defence with a sound like a wet basketball bouncing, the force jarring your arms. Eric rolls his shoulders back as you recover. \"Still standing, huh? Most people tense up too much and eat it.\"","        *else","            You raise your defence too late, the energy projectile crashing against the top of your guard. The force drives your own gloves into your face with a blunt smack. You stumble, nearly falling. Eric drives forward, head low, steps sharp and direct.","            *set fight_momentum -1","    #Touching that energy projectile can't be good. Attempt a sidestep.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *if (adj_technique + trait_bonus_applied) >= dc_hard","            Your legs move by instinct, your torso barely avoiding the projectile. Your trailing leg brushes the outer rope, the scrape of the coarse hemp a reminder of how little breathing room there is. Spectators gasp as the energy wave hisses past and splashes against the harbour railing. You retain enough awareness to see that Eric is still recovering from throwing the energy wave, and you close the distance with a ${jab} that cleanly connects with Eric's shoulder. He steps back, resetting the match, but his confidence flickers, his stance no longer casually relaxed.","            *set fight_momentum +1","        *elseif (adj_technique + trait_bonus_applied) >= dc_medium","            You manage to dodge most of the energy projectile, suffering only a glancing blow to your ribs that still sends a sting through your side. As you reset your stance, Eric finishes his recovery from the energy wave, and any advantage you might have had dissipates. \"Clever footwork. Most people freeze,\" he says, adjusting his stance.","        *else","            You try to evade the energy projectile, but you're caught off guard, the projectile striking you in the chest before you finish your dodge. The impact steals your breath and shoves you two steps towards the edge. Your foot hits the boundary rope, which halts your momentum with a jolt as Eric presses his advantage.","            *set fight_momentum -1","","    #Throw a quick ${jab} to disperse the Energy Wave.","        You try to dissipate the energy projectile by jabbing it. It drives your gloved fist forcefully back, making you punch yourself in the face. Eric pauses, eyebrows furrowed in puzzlement. \"First time facing energy techniques?\" he asks, as he prepares to close the distance again.","        *set fight_momentum -1","","*if fight_momentum <= 4","    No time to dwell. You circle. You duck. You fire off jabs. The crowd blurs. Just fists, feet, and the electric crackle of Eric's aura. Eric dictates the pace, his movements economical, although you manage to give as good as you get.","","    When you manage to land a clean cross through his defence, the crowd rouses from its disinterest and begins paying closer attention. Eric's eyes refocus, his footwork becoming cleaner. \"So you're not just here to take hits,\" Eric says, as energy flares around his body with a soft crackle. ","*elseif fight_momentum = 5","    No time to dwell. You circle. You duck. You fire off jabs. The crowd blurs. Just fists, feet, and the electric crackle of Eric's aura.","","    A murmur of appreciation ripples through the crowd as you manage to land a clean cross through Eric's defence. He adjusts his stance, jaw setting as he focuses intensely. \"You hit like you mean it,\" he remarks, as heat ripples across his fists.","*else","    No time to dwell. You circle. You duck. You fire off jabs. The crowd blurs. Just fists, feet, and the electric crackle of Eric's aura. ","    ","    You land a clean cross, catching Eric off guard with your natural timing and power. The crowd is on its feet now, scarcely believing that a newcomer is getting the better of Eric \"Blazefist\" Jiang. For a second, a part of you wonders: [i]Am I really holding my own?[/i]","","    Fire curls from his fists before he speaks. \"Alright. You're real.\"","","He shifts his weight with a feint left, then pushes off hard from his rear leg, twisting in mid-air. One leg tucks in tight, the other whips outwards \u2014 horizontal, fast, spinning. The [i]Tornado Kick[/i] turns his whole body into a blade, his extended leg slicing straight towards your head.","","*gosub_scene utils show_fight_momentum","","*choice","    #Use a ${block}, angled towards his striking leg.","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *if (adj_toughness + trait_bonus_applied) >= dc_medium","            You raise your guard and angle it into the strike. His spinning kick smashes into your forearms \u2014 once, twice, three times \u2014 each impact clean, controlled, absorbed. You shift subtly with each hit, bleeding off force without losing balance.","","            When he lands, his momentum stalls for a beat. He resets, eyes sharp, already scanning for the next gap.","","            You settle back into your stance, breath steady. You're reading him now.","        *else","            You bring your guard up, bracing for impact. The first hit slams into your forearms \u2014 jarring, heavy. The second jars your elbows. The third knocks you off balance, feet slipping across the floor until your heel catches the edge of the rope.","","            He lands smoothly, already pivoting to follow up. \"Took that better than most,\" he says, without pause.","","            You shake out your arms, testing range. Guard lifted again, just in time.","            *set fight_momentum -1","    #Backstep until he runs out of momentum.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *if (adj_technique + trait_bonus_applied) >= dc_medium","            You move the instant he launches. His kicks carve the air in wide arcs, but each one misses by centimetres. You stay just ahead, reading the spin, watching the speed bleed off. On the third rotation, his momentum falters. You pivot outside his range.","","            His guard flickers open for a heartbeat \u2014 but you hold position. No time. He resets, tilting his chin slightly. \"Could've taken the opening,\" he says, adjusting stance. Respect, maybe. Or caution.","","            You settle back into your stance, breath steady. You're reading him now.","        *else","            You backpedal as Eric launches, trying to stay clear. But he carries forward through the spin, momentum driving him farther than expected. The second kick clips your shoulder. Blunt, numbing. You stagger. Your heel grazes the rope. No more room.","","            The third strike crashes into your guard. It holds, barely. By the time you reset, he's already circling to follow up.","","            You shake out your arms, testing range. Guard lifted again, just in time.","            *set fight_momentum -1","    #Attempt to duck under the whirling kicks.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *if (((adj_technique * 0.5) + (adj_toughness * 0.5)) + trait_bonus_applied) >= ((dc_medium * 0.75) + (dc_hard * 0.25))","            You drop the moment he launches. Not a full sprawl \u2014 just enough. His kick slices the air just overhead, wind rushing past your ears. He spins past, landing with his back to you.","","            Standard procedure when confronting a human tornado.","","            You dash forward and drive a heavy cross into his ribs as he turns. A deep [i]thwump[/i] knocks the air from his lungs. He staggers, then recovers, fists flaring with sparks. \"Didn't think you'd make it this far.\"","","            You settle back into your stance, breath steady. You're reading him now.","            *set fight_momentum +1","        *elseif (((adj_technique * 0.5) + (adj_toughness * 0.5)) + trait_bonus_applied)  >= dc_medium","            You duck low as Eric spins past \u2014 too low. His kick misses, but now you're stuck, hands on the floor, off-balance. You scramble upright just as he lands and resets.","","            No hit. No counter. The moment's gone. He's already watching your stance, calculating the next move.","","            You shake out your arms, testing range. Guard lifted again, just in time.","        *else","            You drop too late \u2014 and not low enough. His spinning kick clips your head, your raised arm barely softening the blow. The follow-ups slam into your guard, driving you down.","","            You hit the ground hard. The ref starts the count. You rise by seven, blinking. Legs shaky. Balance still loose.","            *set fight_momentum -2","Breath ragged, but steady, each inhale painfully welcome. Eric shifts again, stepping back. Then he sinks low into Horse Stance: wide base, locked hips. His fists begin to glow, amber and steady.","","He doesn't move. Just braces. Waiting.","","*gosub_scene utils show_fight_momentum","","*choice","    #Throw a quick ${jab} to test his defence, then create distance.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *if (adj_technique + trait_bonus_applied) >= dc_hard","            You tense instinctively upon seeing Eric's stance. Instead of committing to a big attack, you throw out a probing ${jab}, putting minimal force into the punches. Eric absorbs your attack, but you're already in full guard, and the deliberate weakness of your punch makes his counterattack arrive erratically and bounce off your guard with a harmless thump. You seize the chance and pepper him with a one-two combo, claiming a momentary advantage before he can refocus his energy.","            *set fight_momentum +1","        *else","            You attempt to test Eric's defence with a quick jab, planning to retreat immediately afterwards. However, your timing is slightly off, and Eric's [i]Focus Counter[/i] absorbs more power from your jab than you intended. His counterattack arrives quickly and catches you as you attempt to backstep, and he advances, pressing his advantage.","            *set fight_momentum -1","    #Keep your distance, refusing to attack into his obvious trap.","        You stay disciplined and maintain distance rather than triggering Eric's obvious trap. Seeing that you're waiting him out, Eric releases his stored energy and approaches again, neither of you having gained any advantage.","","The air tightens as Eric's fists ignite, flames licking up to his forearms. Feet planted, shoulders dipped. Then his knees bend, compact and loaded.","","He's coming up fast.","","*temp match_result 0","*gosub_scene utils show_fight_momentum","*temp uppercut_response \"none\"","*choice","    #Stand your ground and brace for it.","        *set uppercut_response \"guard\"","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *if (adj_toughness + trait_bonus_applied) >= dc_medium","            *set fight_momentum +1","        You lower your centre of gravity and lock your guard into place. If he's coming up, you'll be there to meet him.","","    #Try to sidestep at the last second.","        *set uppercut_response \"sidestep\"","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *if (adj_technique + trait_bonus_applied) >= dc_hard","            *set fight_momentum +1","        You angle your stance, preparing to slip just outside the arc of his attack. It's a gamble, but so is staying still.","","*if fight_momentum < 3","    *if uppercut_response = \"guard\"","        Eric launches his [i]Rising Uppercut[/i], driving upwards in a tight leap, fire spiralling from his fist. The trailing flame lashes behind him like a whip. You try to raise your arms, but they're too slow, too heavy. His punch crashes through your guard, driving your own gloves into your face before slamming into your chin.","","        Your jaw snaps back. Vision whites out. You hit the mat like dead weight. The ref starts the count, but even sitting up feels like dragging your body through water. You're done.","    *elseif uppercut_response = \"sidestep\"","        Eric launches his [i]Rising Uppercut[/i], driving upwards in a tight leap, fire spiralling from his fist. The trailing flame lashes behind him like a whip. You shift to the side \u2014 a half-step too slow. His fist catches you clean under the jaw, snapping your head back with brutal efficiency.","","        The ring tilts. Your legs give out. You crash to the mat in a blur of lights and noise. The ref starts the count, but even sitting up feels like dragging your body through water. You're done.","    *else","        *bug invalid choice","    *set match_result 1","","*elseif fight_momentum < 5","    *if uppercut_response = \"guard\"","        Eric launches his [i]Rising Uppercut[/i], driving upwards in a tight leap, fire spiralling from his fist. The trailing flame lashes behind him like a whip. You brace, and your guard holds. The impact rattles through your bones, but you stay up.","","        He hangs in the air just long enough for you to counter. You throw your ${combo}, but the hits land weak, arms still numb from the block.","    *elseif uppercut_response = \"sidestep\"","        Eric launches his [i]Rising Uppercut[/i], driving upwards in a tight leap, fire spiralling from his fist. The trailing flame lashes behind him like a whip. You slip outside the arc, close enough to feel the heat streak past your jaw.","","        You counter with your ${combo}, clean, but it barely fazes him. Not enough power left.","    *else","        *bug invalid choice","","    He doesn't hesitate. The [i]Energy Wave[/i] comes fast, catching you clean. It knocks you off balance, and before you can recover, he closes the distance. A quick combination drops you.","","    The ref waves him off. You lie there, dazed, staring peacefully at the bright floodlights.","","    *set match_result 2","*else","    *if uppercut_response = \"guard\"","        Eric launches his [i]Rising Uppercut[/i], driving upwards in a tight leap, fire spiralling from his fist. The trailing flame lashes behind him like a whip. You absorb the shock on your forearms. The force rattles through you, but you hold. He's open.","    *elseif uppercut_response = \"sidestep\"    ","        Eric launches his [i]Rising Uppercut[/i], driving upwards in a tight leap, fire spiralling from his fist. The trailing flame lashes behind him like a whip. You slip past it with perfect timing. He's exposed.","    *else","        *bug invalid choice","","    As he lands, you strike with your ${combo}, each hit driving him back. His guard breaks.","","    You step forward and launch your ${ultimate}, catching his jaw full-on. His head snaps back, and he drops.","","    A hush falls over the crowd. The ref counts to ten. Eric finally stirs, well after the count.","","    Breathing hurts. The strength leaves your arms. It takes a moment to register: you won.","    *set match_result 3","","*page_break","*if match_result = 1","    \"Match over!\" the referee announces, raising Eric's hand as the winner.  You sit on the ground, catching your breath, then push yourself up to meet his gaze.","","    Eric approaches you, offering a hand to help you up. \"Good effort. You've got solid fundamentals for someone just starting out,\" he says. \"You've got good power in your punches, you just need more experience.\"","","    You accept his hand, standing up with a wince. \"Thanks. I've been training for four months, but I just wanted to test myself against real fighters. I learnt a lot today,\" you reply.","","    Eric strokes his chin and nods. \"Keep at it, you've got decent instincts.\" He pauses, then adds, \"I train at Eastside Combat Club most weekdays if you ever want some pointers.\" With a formal bow, Eric turns to leave. You watch him walk away as your own pulse slows.","","    This wasn't your day. The next one might be just as tough. But you showed up. You fought. And that's enough.","","    [i]Winning's not the point.[/i]","    ","    [i]Showing up is.[/i]","    *set record_losses +1","*elseif match_result = 2","    \"Match over!\" the referee announces, raising Eric's hand as the winner. But instead of immediately walking away, Eric extends his other hand to you, helping you up.","","    \"You did well. You've got solid fundamentals and good combat sense. How long have you been training for?\"","","    \"Thanks. I've been training for four months, at a local gym in Mong Kok. [i]MK Fight Gym[/i].\"","","    Eric's eyes widen. \"Four months? And this was your first fight? That's an incredible showing, you've clearly got talent. Look, I train at Eastside Combat Club most weekdays. You should drop by sometime. I'd definitely like to train with you.\"","","    With a formal bow, Eric turns to leave. You watch him walk away as your own pulse slows. You didn't win \u2014 but you stood your ground against someone far stronger. And you're still standing.","","    Maybe next time you'll win. Maybe next time you'll fall faster. But you showed up. You fought. And that's enough.","","    [i]Winning's not the point.[/i]","    ","    [i]Showing up is.[/i]","    *set record_losses +1","*elseif match_result = 3","    \"Match over!\" the referee announces, raising your hand as the winner. Eric pushes himself up slowly, eyebrows drawn together in a tight crease. Confusion? Doubt? His eyes are wide, but he meets your gaze anyway. Finally, he bows deeply to you, and bows to the crowd, now on their feet and shouting both your names.","","    \"Still raw. But you see the angles. How long you been doing this?\"","","    \"Thanks. I've been training for four months, at a local gym in Mong Kok. [i]MK Fight Gym[/i].\"","","    Eric's jaw drops. \"Four months? Damn. I was still falling over my own feet at that point.\" He watches you, like he's checking if you're serious \u2014 then nods.","","    \"You've got something. I'm at Eastside most weekdays. If you want to sharpen it, swing by.\"","","    With a formal bow, Eric turns to leave. You exhale slowly, guard lowered now. Maybe he's right. Maybe there's something in you worth sharpening.","","    And if he's not \u2014 if next time you fold in the first round \u2014 it doesn't change this. You showed up. You held your ground. That counts.","","    [i]Winning's not the point.[/i]","    ","    [i]Showing up is.[/i]","    *set record_wins +1","*else","    *bug Unknown match result","","*return"], "labels":{"fight":0}},
"eric_subplot": {"crc":886370747, "lines":["*label scene_introduction","*if eric_subplot_scene = 1","    After your fight with Eric, he invited you to train with him at Eastside Combat Club. You remember his disciplined footwork, his energy bursts, the flames wreathing his fists. You've never seen anything like that at [i]MK[/i]. Less clear is what you could offer him.","*elseif eric_subplot_scene = 2","    Last time you saw Eric's disciplined training. He struggled with his energy techniques, finding it too volatile to integrate with his traditional martial arts. Now he's invited you to train with him again. You don't know why he finds it helpful to train with you, but he keeps asking you back.","*elseif eric_subplot_scene = 3","    *if eric_plot_timer = 0","        Eric's been pausing longer between drills. Now it's less about technique, more about intent. At the end of your last session, he said, \"I want to show you something next time.\" No context. No explanation. It didn't sound like a training invite.","    *else","        Eric's last message was curt: \"Need time. Hit an energy blockage.\" No emojis. Whatever doubts Chloe stirred up, they've left him closed off. From the looks of it, he won't be reaching out this week.","*elseif eric_subplot_scene = 4","    *if eric_plot_timer = 0","        The Pearl River Cup is almost here. Eric's rhythm has changed again \u2014 tighter form, relentless repetitions, longer silences that settle slowly. After another few days of radio silence, he messaged you. \"I've been thinking about why I fight.\" That was it. You don't know what he wants: talk about it, unpack it through fighting, or just let it hang in the air.","    *else","        The Pearl River Cup is nearing, and Eric's messages have become terse. He's training privately, spending long hours at the Hong Kong Sports Institute, perfecting something he calls the \"Volcanic Dragon Ascent.\" No more sessions at Eastside. No offer to join him. If he's not ready to show you, you'll just have to wait.","*elseif eric_subplot_scene = 5","    *if eric_plot_timer = 0","        Since the Pearl River Cup concluded, there's been an evolution in Eric's bearing \u2014 his posture, his timing, even his silences. The volatility's still there, but it's no longer boiling over \u2014 now more of a soft simmer, like he's harnessing it. A different Eric from the one you've known. This time, just a short message. A time and a place. Whatever this is about, he wants you nearby.","    *else","        You haven't seen Eric since the Pearl River Cup. His last message simply said, \"Got something to work out. Visiting Master Wong.\" Even the regulars at Eastside Combat Club haven't heard from him. Whatever revelations he discovered, he's not ready to talk about it.","*elseif eric_subplot_scene = 6","    *if eric_plot_timer = 0","        Eric's latest message wasn't a text, but a voice message, quiet and deliberate. He says he's been staying at Master Wong's new training centre. \"I've found it,\" the message says. \"I want to show you.\"","    *else","        Eric's last communication: a disorganised jumble of messages and voice memos, consisting of fragmented thoughts about cultivation, harmony, intention, performance. Then nothing for days, your response left unread. The gathering at Master Wong's training centre must have opened something up. Whatever he's doing, it's consuming all of his focus.","*else","    *bug Eric subplot scene not found","*return","","*label scene_choice","*if eric_subplot_scene = 1","    *comment earliest: chapter 2, first fortnight","    *comment eric_friendship from this chapter: 1-4 for accept, 0-3 for reject","    *comment cumulative eric_friendship after this chapter: 1-4","    *gosub event_1","    *set stat_technique %+2","*elseif eric_subplot_scene = 2","    *comment earliest: chapter 2, second fortnight","    *comment eric_friendship from this chapter: 0-2","    *comment cumulative eric_friendship after this chapter: 1-6","    *gosub event_2","    *set boxing_insights +1","    *set eric_plot_timer 2","*elseif eric_subplot_scene = 3","    *comment earliest: chapter 3, second fortnight","    *comment eric_friendship from this chapter: 2-4","    *comment cumulative eric_friendship after this chapter: 3-10","    *gosub event_3","    *set stat_technique %+4","    *set unlocked_eric_training True","    *set eric_plot_timer 2","*elseif eric_subplot_scene = 4","    *comment earliest: chapter 4, second fortnight","    *comment eric_friendship from this chapter: 0-5","    *comment cumulative eric_friendship after this chapter: 3-15","    *gosub event_4","    *set boxing_insights +1","    *set eric_plot_timer 3","*elseif eric_subplot_scene = 5","    *comment earliest: chapter 6, first fortnight","    *gosub event_5","    *set eric_plot_timer 3","*elseif eric_subplot_scene = 6","    *comment earliest: chapter 7, second fortnight","    *gosub event_6","    *set eric_subplot_status \"finished\"","*else","    *bug Eric subplot scene not found","*return","","*label event_1","Quarry Bay doesn't try to impress: a business district defined by efficiency, not charm, with office towers pressed against aging apartment blocks. A bakery vents steam into the street, its windows fogged with condensation. A construction site, silent, wrapped in green netting.","","Grey concrete, brushed steel doorframe, no signage. The building Eric directed you to appears as if it should house a private cram school or property management company. But the keypad buzzes when you enter the code he sent. A narrow stairwell leads downwards, and with each step the air becomes cooler, denser. Then you hear it \u2014 the controlled rhythm of breath, the soft squeak of feet on polished mats, the distant [i]crack[/i] of a clean strike landing.","","You spot Eric \"Blazefist\" Jiang before he notices you. His red gi, embroidered with flames, shines in the restrained atmosphere of Eastside Combat Club. As you step through the doorway, the low hum of conversation diminishes slightly, and the familiar tang of sweat and worn leather hangs in the cool, conditioned air. Fighters glide with deliberate steps across clean mats. Your arrival elicits evaluating glances before eyes return to their training.","","Eric instructs a younger fighter in the corner. \"Elbow higher,\" he says, his voice calm as he adjusts the student's arm with a light touch. \"Now rotate from your centre.\" The student repeats the movement. Eric offers a single nod.","","You recall the fight \u2014 its explosive energy, his confident aggression behind each strike. Now, Eric's voice is low, his movements measured.","","When he finally looks up and spots you hovering near the entrance, the corner of his mouth twitches slightly. He acknowledges you with a slight tilt of his head, then mutters something to his student before approaching.","","\"${first_name} ${last_name},\" he says. \"Didn't think you'd actually show up.\"","","*choice","    #\"I figured I had nothing to lose.\"","        \"I figured I had nothing to lose,\" you reply, taking in the gleaming equipment and the disciplined atmosphere. \"This is quite a place.\"","    #\"Your fighting style was intense.\"","        *gosub_scene utils increase_empathy","        *set eric_friendship +1","        \"Your fighting style was intense,\" you reply, watching the students around you. \"I'm interested in learning about different approaches.\"","    #\"I realised how much I still have to learn.\"","        *gosub_scene utils increase_analysis","        *set eric_friendship +2","        \"After our match, I realised how much I still have to learn,\" you admit, taking in the professional atmosphere. \"MK's more... duct tape and yelling. Good people, but not this sort of setup.\"","","\"Been training here for about a year now,\" Eric says, his gaze sweeping the room. \"They run a tight ship, but they give me space to develop my specialised techniques.\"","","\"Come on,\" he gestures, leading you towards a quieter corner. \"Let me see what you're working with.\"","","For the next hour, Eric guides you through basic drills, his eyes narrowed in concentration as you execute each movement. \"Your guard is dropping.\" The focus mitt lands with a light but firm [i]thump[/i] against your exposed ribs. When your combination hits clean, the sharp [i]crack[/i] of glove on mitt is met with a quick, approving glance before he moves on.","","\"Faster this time. Don't telegraph.\"","","He adjusts the mitts, then pauses, noting the rhythm of your breath, the way you reset your stance without prompting.","","\"I used to think power solved everything,\" he says, half-smiling. \"Turns out it solves... a very specific kind of problem.\"","","He gives your stance one more look. \"Watching someone build from scratch helps me see the parts I skipped.\"","","He taps the mitts together. \"Again. Sharper.\"","","*page_break","*if (fight_opponent_name = \"Katie\")","    \"Your fundamentals are decent for a few months,\" he says during a water break, handing you a pristine white towel. \"But your guard still drops when you throw anything beyond a jab. Anyone with experience will punish that immediately. Who are you fighting next?\"","","    \"Katie Reynolds. Ring name 'Pressure Point'. Haven't been able to find out much about her.\"","","    \"Ugh. Reynolds? She's... she's not even fighting. It's like lab work with screaming. You're going to have a bad time if you go into the fight with your current form.\"","*else","    \"Your fundamentals are decent for a few months,\" he says during a water break, handing you a pristine white towel. \"But your guard still drops when you throw anything beyond a jab. Anyone with experience will punish that immediately.\"","","You wipe stinging sweat from your forehead, breathing heavily, your muscles starting to burn with the exertion. \"Didn't take you long to find the gaps in my guard.\"","","A small chuckle. \"Yeah, well, I had the same issue. My first trainer used to whack me with a focus mitt every time I dropped my right hand. Learnt quick.\"","","His gaze drifts to the window, eyes unfocusing for a moment. The silence stretches. Not awkward, just... different.","","\"Can I ask you something?\" he says, his tone shifting. \"Why fight? You started late compared to most people here. What made you step into the ring?\"","","His sudden seriousness, the direct question, prompts you to pause.","","*choice","    #Tell him about your need for a new challenge in life.","        *gosub_scene utils increase_composure","        *set eric_friendship +1","        You explain the feeling of stagnation in your office job, how fighting offered a raw, tangible challenge that corporate life lacked.","    #Focus on your fascination with testing your limits.","        *gosub_scene utils increase_analysis","        You describe the pull to discover your true capabilities, how fighting strips away pretence and reveals potential.","    #Admit it started as just a hobby that unexpectedly became something more.","        *gosub_scene utils increase_empathy","        *set eric_friendship +1","        \"I just wanted to improve my boxing,\" you explain. \"It grew from there.\"","","Eric nods thoughtfully, studying your face. \"I see something in you that reminds me of when I started. Before all this.\" He flexes his fingers, and a subtle glow pulses beneath his skin for a heartbeat. \"Raw potential, maybe. But what matters more is determination. Spirit. You're not just here to show off.\"","","He pauses, his jaw tightening briefly before he speaks again. \"I've been trying to balance standard drills with my energy techniques. It's not easy. Most people just want one or the other.\"","","He says it calmly, but his towel's still soaked through, and there's a faint burn mark on the edge of his sleeve. The effort's bleeding out. Not in words, but in sweat, in heat, in damage he pretends not to notice.","","Another fighter calls Eric's name from across the gym, a respectful enquiry about equipment.","","\"I have to go, but I'd like to continue this,\" Eric says, standing. \"If you're interested, I train here Tuesday and Thursday evenings, plus Sunday mornings. You're welcome to join. I think we could learn from each other.\"","","\"Learn from me?\" It slips out before you can stop it. \"I'm barely keeping up.\"","","Eric's expression doesn't change. He just offers his hand.","","\"Training partners?\"","","*choice","    #\"Training partners.\"","        *set eric_friendship +1","        \"Training partners.\"","","        As you shake his hand, there's a surprising stillness in the grip. A faint warmth lingers in your palm, like the handshake didn't fully end.","","        \"Good.\" A smile dances across Eric's lips. \"Thursday, six o'clock. Don't be late, and be ready to work. I don't go easy on training partners.\"","","        He makes to leave, then turns back. His gaze flicks critically to your hands. \"Oh, and bring proper hand wraps next time. The ones you're using look flimsy. Your form isn't terrible, but your wrist alignment needs serious help.\"","","        Eric kneels beside a student, tapping a heel gently into place with two fingers. No flames, no roar \u2014 just small, precise corrections and a quiet word you don't catch. You observe from a distance, your ribs still sore from earlier.","","    #Decline his offer.","        *set eric_subplot_status \"rejected\"","        \"I think I'll pass,\" you say after a moment. \"It was a good session, but I'm not sure this path is for me.\"","","        Eric holds your gaze, then nods once, slowly. \"All right. Not everyone wants to go all in. Just... don't stop moving forward, wherever you end up.\"","","        He offers a brief handshake, then turns and walks away, calling out instructions to a new student. You watch for a second, but he doesn't look back.","","*return","","*label event_2","Around you, the gym pulses with activity: the grunt of exertion, the rhythmic clink of weights, the insistent buzz of timers. The heavy bag shudders under your fist, the rhythmic thud echoing slightly in the busy gym. You focus on your stance, the connection to the floor, trying to replicate the form Eric demands.","","\"Pivot more on that cross,\" Eric calls out, his voice cutting through the background noise. He stands nearby, observing, then demonstrates the movement himself \u2014 a seamless rotation, power flowing visibly from his planted foot through his core to his extended fist. \"Power comes from the ground up, not just your arm.\"","","You adjust your stance, concentrating on the hip turn, and throw the cross again. The heavy bag swings further this time, the impact resonating deeper through your arm, a jarring vibration all the way to your shoulder.","","\"Better,\" Eric nods, a brief flicker of approval in his eyes. \"Now string them together, yeah? Jab, cross, hook. Remember, speed without proper form is just wasted energy, ${first_name}.\"","","You keep your eyes locked on the heavy bag, letting the surrounding chaos fade as you drill the combination.","","\"Most fighters want to start at the sizzle reel. Big hits, flashy wins. They forget the part where you actually learn to cook. The [i]mise en place[/i] of combat.\"","","You're about to respond when the gym's front door swings open with a force that momentarily silences the room. The air seems to still. Backs straighten. Gloves hang mid-punch. Timers blink, forgotten. Conversations break off mid-sentence as every head turns towards the entrance.","","*page_break","\"Well, well! Fancy finding actual fighters in this neighbourhood!\"","","A young woman strides through the gym entrance, shoulders relaxed, steps measured. Her hair, jet black and precise at the jawline, doesn't shift even as a fighter brushes past her. She doesn't flinch, doesn't slow, doesn't acknowledge him.","","Her arms are bare, skin drawn tight over defined muscle. Her stomach barely rises with each breath. Still. Economical. One hand holds her phone loosely, the other curled around a loop of shopping bag handles. Her white trainers squeak on the mat as she crosses the room, not bothering to step around a footwork drill. One of the fighters has to sidestep to avoid her.","","Then she sees Eric, and a slow smile tugs at the corner of her mouth. \"[i]Blazefist[/i] himself! Just the man I was hoping to see.\"","","The corner of his jaw twitches once. A small vein near his temple pulses faintly. \"Chloe,\" he says, voice neutral.","","*choice","    #Keep a straight face. She's not here for you, and you'd rather stay out of it.","        *gosub_scene utils increase_composure","        You glance at Eric. His jaw's tight, one glove still hanging loose from the laces.","","        Chloe says his name with just a bit too much space around it, like she's testing the sound of it. Her footsteps pause, then squeak once more, half a beat later than expected.","","        You look down, finish the wrap on your left hand, and start on the right. This isn't your scene. Not yet.","","    #Size her up. There's something off about the way she moves.","        *set eric_friendship +1","        *gosub_scene utils increase_analysis","        You watch her move like she owns the place \u2014 unhurried, deliberate. One arm hooked with crisp shopping bags, the sort that come with embossed logos and tissue paper folded by hand. Her nails are glassy, her hair pinned just so, like she walked out of a shoot, not into a gym.","","        Her steps are soft but deliberate. She scans the room \u2014 mirrors, exits, distances, lines of sight. When she stops, there's no sway in her stance. No shift in balance. She just waits, still and ready.","","    #Let your guard down a little. She's annoying, but rather fascinating.","        *set chloe_friendship +1","        *gosub_scene utils increase_empathy","        You watch as she shifts her weight slightly \u2014 just enough to keep her footing clear while her arms stay relaxed. One shopping bag swings lazily from her wrist; the soles of her shoes are spotless.","","        When she smiles at Eric, it doesn't reach her eyes, but her posture doesn't change. No lean, no tilt. Like she's been practising standing still for hours.","","        You don't say anything, but you don't look away, either.","","    #Say nothing, but make sure she sees you watching.","        *gosub_scene utils increase_composure","        You meet her gaze and hold it \u2014 not long, just enough to register.","        ","        As you shift your stance, your shoulders settle back and your weight evens out, steady beneath you. Chloe's eyes flick over you once, unreadable, before her attention returns to Eric.","        ","\"Just finished some retail therapy nearby,\" she announces, lifting her shopping bags with a flourish. \"Thought I'd stop by and see what all the fuss is about.\" Her gaze shifts to you, eyes flicking dismissively from your sweat-stained shirt to your worn gloves. \"He always did have a soft spot for fixer-uppers,\" she adds, voice light, like she's complimenting your haircut.","","You tighten your grip inside your glove, inhale slowly, and throw another jab at the heavy bag, refusing to look her way.","","Chloe saunters closer, her ambered perfume cutting sharply through the gym's familiar scent of sweat and leather. Too pleasant. Too warm for a gym. She eyes your drills; her lips purse in disapproval. \"Seriously, Eric? This is what you're wasting your time on? Jab, cross, hook?\" She mimics the combination with exaggeratedly limp wrists, a mocking twist tugging at her mouth. \"Where's the fire? Where's the dragon stuff that actually makes you worth watching?\"","","\"We're working on fundamentals,\" Eric replies, his tone flat. \"Foundation work.\"","","Chloe rolls her eyes dramatically, affecting a show of sighing. \"Boring! You know what people pay to see.\" She gestures pointedly towards his hands. \"The light show. The energy. The stuff that makes you [i]special[/i]. Pearl River Cup is coming up next month. Nobody's buying tickets to watch basic combinations.\"","","\"My training approach isn't really your concern, Chloe.\" The words come out slower now.","","\"Just looking out for a fellow fighter,\" she shrugs, all wide eyes and halo. \"Playing it safe with textbook form...\" she gestures dismissively towards you, \"might work for beginners with nothing special to offer, but you? You're wasting your potential.\"","","Red sparks sputter between Eric's knuckles with a faint crackle. His eyes dart down to his hands. A flicker crosses his face before he takes a slow, deliberate breath.","","*fake_choice","    #Watch Eric's hands, noting the struggle for control.","        *gosub_scene utils increase_empathy","    #Feel a surge of irritation at Chloe's condescending attitude.","    #Glance around, seeing how the other fighters pretend not to watch.","        *gosub_scene utils increase_analysis","","\"The energy techniques aren't party tricks,\" he says, his voice firm now, controlled. \"They require discipline. Control. Without proper fundamentals, they're just flashy ways to get yourself hurt.\"","","Chloe steps closer, invading his personal space. \"Discipline? Control? That sounds suspiciously like [i]fear[/i] talking. People are starting to wonder if you're stale bread, Blazefist. If maybe you're afraid to really cut loose because you can't control it any more.\"","","Eric's chin lifts fractionally. His feet shift almost imperceptibly, settling into a balanced, ready stance. His breathing deepens, adopting the steady, powerful rhythm you recognise from the moments before his finishing move in your fight.","","For a moment, tension crackles in the air between them. Then Eric's shoulders relax marginally, though his eyes remain sharp.","","\"My training methods aren't a public spectacle, Chloe,\" he says, voice low but firm. \"I don't need to justify them to you or anyone else.\"","","*fake_choice","    #Stay silent, letting him stand his ground.","        *gosub_scene utils increase_composure","        Eric doesn't need backup \u2014 not right now. You just hold your position, steady and present.","    #Glance at Chloe, trying to read her next move.","        *gosub_scene utils increase_analysis","        That smile looks rehearsed. You can't tell if she's improvising or executing a plan.","    #Watch Eric carefully \u2014 there's more under the surface than he's letting on.","        *gosub_scene utils increase_empathy","        His voice is calm, but his stance says he's bracing for something.","","Chloe steps closer, her smile becoming predatory. \"Oh, but you [i]do[/i] need to, Eric. The Pearl River Cup committee was specifically asking about you yesterday. Wondering if the 'Blazefist' they're promoting in all their marketing materials will actually show up this year. Or if they should start featuring someone more... committed to giving the audience what they want.\"","","His posture tightens for half a second before settling again. \"The committee knows what I'm capable of.\"","","\"Of course they do. But they also know what sells tickets.\" Chloe glances pointedly at you before continuing. \"Listen, there's a demonstration event next week at Central Plaza. All the major sponsors will be there.\" Her voice softens, almost sympathetic. \"Just come and show them you've still got it. One impressive display, that's all. Before rumours start spreading that you've lost your edge.\"","","\"I haven't lost anything.\"","","\"Prove it, then. Or don't. Just smile for the posters while someone else steals your spot.\"","","Chloe shoulders her shopping bags. \"Unless Master Wong has you completely convinced that flashy techniques are beneath you now.\" She turns without urgency, as if she'd just ticked something off her to-do list, and glides towards the door. For a moment, her stride falters \u2014 half a beat off \u2014 then resumes, smooth as ever.","","The heavy door swings shut behind her, leaving a momentary silence in the gym before conversations gradually resume. Eric doesn't move. His neck muscles stiffen, lips blanched pale.","","*choice","    #Wonder if she's actually trying to help him.","        *gosub_scene utils increase_empathy","        There was bite in her words, sure. But the offer itself was real. Public, loud, no room to hide. If she wanted to push him, she picked her moment well. That wasn't an insult. It was a challenge.","","    #Note how carefully she framed the offer. This wasn't just about drama.","        *gosub_scene utils increase_analysis","        She dropped the committee, the sponsors, the time and place \u2014 all packaged like an afterthought. But it wasn't. She knew her audience. The dig was personal, but the plan was strategic.","","    #Stay focused on Eric. Whatever her motives, he's the one carrying the weight now.","        *gosub_scene utils increase_composure","        Chloe's gone, her perfume still clinging faintly to the air, but Eric hasn't moved. Shoulders squared. Jaw tight. Like he's still in the ring, waiting for the bell.","","\"Sorry about that,\" he says finally, turning back to you. \"Chloe has a gift for complicating things.\"","","\"Master Wong,\" you say, adjusting your stance. \"Someone you train with?\"","","Eric nods, absently adjusting the wraps on his hands. \"Been training with him since I first discovered these abilities.\" A faint amber glow briefly illuminates his knuckles. \"He believes energy projection should be about harmony, not spectacle.\" He shakes his head slightly. \"But harmony doesn't win championships.\"","","\"So what will you do about the demonstration?\" you ask.","","He doesn't answer right away. Just watches the bag sway from your last hit. \"Master Wong says I rely too much on the energy techniques. That I need to remember my foundation.\" His voice carries the flat weight of old arguments.","","As you towel off, Eric approaches again. Starts to speak, then stops. One hand rises to adjust the wrap on his wrist, but it's already tight.","","\"There's something I've been working on with Master Wong,\" he says finally, voice quieter now. \"A different approach to energy techniques. Not just about control, but about... intent. Purpose.\"","","His eyes flick towards you, then away again.","","\"He doesn't usually take visitors,\" Eric adds, almost like he's talking himself out of it. \"But I think it might help. If you wanted to see it. What I've been trying to learn.\"","","*choice","    #\"I'd like that.\"","        *set eric_friendship +1","        You consider the offer. It doesn't sound casual. \"I'd like that.\"","","        Eric nods, seeming pleased \u2014 but there's a flicker of nerves in the way he glances away.","    #\"That sounds... intense. Can I think about it?\"","        \"That sounds... intense. Can I think about it?\"","","        \"Of course.\" Eric nods, maybe a beat too quickly. \"I'll text you the details anyway. Just in case.\"","","        He doesn't say more. Just glances back at the bag.","","As you gather your things to leave, Eric stays by the heavy bag, launching a series of crisp, deliberate combinations. No energy flares, just clean, textbook execution. Midway through a hook, he stops. Eyes lowered. One breath. A faint golden glow blooms across his knuckles. It flickers once, then fades.","","[i]A new Boxing Insight sparks, sharp and half-formed. Born from tension, not yet understood.[/i]","*return","","*label event_3","The red minibus rattles along the winding road, leaving Hong Kong's dense urban sprawl fading in the rear-view mirror. Skyscrapers surrender to low-rise buildings, then to a patchwork of storage depots and half-forgotten villages. Eric stares out at the passing landscape, body hunched. His lips part, then close.","","\"We're almost there,\" he says finally, as the bus turns onto a narrower, bumpier road flanked by overgrown greenery. \"Master Wong doesn't get many visitors these days.\"","","The minibus lurches to a halt on a small, quiet Yuen Long village road. You press two hefty five-dollar coins into the driver's leather-gloved hand as you step off. The air feels different \u2014 cleaner, cooler against your skin, scented with woodsmoke and damp earth, a stark change from the city's acrid diesel fumes. Old stone houses with faded tile roofs line narrow, paved streets where chickens peck nonchalantly near open doorways, their soft clucking and the occasional flap of wings punctuating the quiet atmosphere. A few elderly villagers converse quietly in shaded spots, their voices a low whisper.","","Eric leads the way without speaking, turning onto a dirt trail that winds upwards between dense bamboo groves. Your footsteps crunch on fallen leaves and loose pebbles. The air grows cooler in the shade, carrying the distinctive fragrance of wild lemongrass and camphor.","","After about fifteen minutes of steady hiking, the trail widens into a clearing. There stands a modest Hakka dwelling with blue-grey brick walls and red clay roof tiles, small metal-barred windows, and a squat stone chimney. Surrounding it is a small, neatly tended garden of vegetables and herbs.","","\"This is it,\" Eric says, his voice softer than usual. He pauses for a moment before the weathered wooden door.","","*choice","    #You let the quiet settle into you. No urgency here.","        *gosub_scene utils increase_composure","        Eric doesn't knock. Just stands there a moment longer. You match his stillness. The wind moves through bamboo. Nothing else presses.","    #You sense Eric's shift. This place holds deep significance for him.","        *gosub_scene utils increase_empathy","        His foot shifts back half a step. Shoulders drawn in. You've seen him tense before a match. This is different. Like he's entering a memory.","    #You catalogue the setting. Remote location, traditional architecture, defensive positioning.","        *gosub_scene utils increase_analysis","        Elevated sight lines. Single access path. Bamboo cover along the slope \u2014 natural concealment. Not hidden, just... intentional. The garden: orderly rows, evenly spaced. A mind that organises everything with purpose.","","The door silently swings open and a short elderly man emerges, dressed in a plain brown shirt and trousers. He carries himself easily, each step precise yet fluid, his compact frame exuding quiet strength that seems to disturb the air around him. His eyes, sharp and piercing. They settle on you immediately, their gaze cool against your skin.","","\"Eric,\" the old man says, his voice quietly resonant. \"You're late.\"","","\"The minibus driver waited for all the seats to fill before leaving,\" Eric responds, bowing his head slightly in a gesture of respect. \"Master Wong, this is ${first_name} ${last_name}, the training partner I mentioned.\"","","After a silence that stretches for several long seconds, Master Wong nods and turns back towards the house. \"Come inside. The tea is getting cold.\"","","*page_break","The main room appears spartan but immaculate. It carries the faint scents of aged cedarwood, dried chrysanthemum, and oolong tea. Training staffs lean neatly against one wall beneath yellowed scrolls of elegant Chinese calligraphy. Opposite them, several gleaming, well-maintained blades hang in simple racks, their polished steel surfaces reflecting the amber window light. Your socked feet whisper across hardwood floors burnished to a soft glow.","","Master Wong gestures wordlessly for you both to sit at a low wooden table where three steaming cups of pale green tea are already waiting, their delicate, grassy aroma filling the quiet space.","","\"So this is your new student,\" Master Wong says, his gaze settling on Eric after you are all seated on floor cushions.","","\"Training partner,\" Eric corrects gently. \"We've been working together for about a month now.\"","","Master Wong makes a noncommittal sound as he lifts his cup, his eyes still observing you over the rim. The silence stretches again, punctuated only by quiet sips of tea. You shift slightly on the cushion, suddenly aware of the dust motes dancing in the shaft of light from the window. Then he speaks, gaze steady.","","\"Fighting requires sacrifice, ${first_name} ${last_name}. What makes it worth the cost?\"","","*choice","    #\"To find something real beyond my office job.\"","        *gosub_scene utils increase_composure","        You explain how the corporate world felt hollow \u2014 spreadsheets and meetings that seemed to exist in their own bubble. \"There's an honesty to fighting that I couldn't find elsewhere. When I land a punch or take a hit, that's something tangible, something that can't be hidden behind jargon or corporate buzzwords.\"","    #\"To discover my limits and then push past them.\"","        *gosub_scene utils increase_analysis","        \"Every time I step into the ring, I learn something new about myself,\" you tell him. \"What I can endure. How I respond under pressure. Where my weaknesses are. It's not about winning or losing. It's about finding out who I can become.\"","    #\"I'm still figuring that out, but I know I need this in my life.\"","        *gosub_scene utils increase_empathy","        \"I'm not sure I have a clear answer yet,\" you admit, meeting Master Wong's eyes. \"The feeling when I land a solid hit, when I adapt mid-fight, when I push through exhaustion... it fills something I didn't know was empty. Boxing started as exercise, but fighting feels like... waking up. I'm still learning why, but I know I can't go back to just existing.\"","","Master Wong listens without interruption, his expression unreadable. When you finish, he nods slowly, remarking, \"At least you do not lie to yourself. That is a beginning.\"","","He turns his attention back to Eric. \"And you? Have you found answers to your questions?\"","","\"I'm working on balancing the traditional training with the energy techniques, like you suggested, Master. Focusing on precision and control rather than just raw power.\"","","\"Hmm.\" Master Wong sets down his tea cup with a soft tap. \"Show me.\"","","Eric rises immediately, moving smoothly to an open area of the floor. He begins a sequence of movements, flowing from one stance to another. Energy gathers as soft, cohesive flows of amber light that trace the path of his limbs.","","Master Wong watches Eric's form and the energy flow. When Eric finishes, returning to a ready stance, the old master remains silent for several seconds.","","\"Better,\" he finally pronounces. \"You no longer fight your own power or try to suppress it. But you still think of it as something separate from yourself, something to be controlled rather than expressed.\"","","Eric's forehead creases. \"I thought control was the goal.\"","","\"Control implies struggle,\" Master Wong replies gently. \"When you struggle against yourself, how can you reach your fullest capability?\" He rises from the table with a fluid grace that belies his age. \"Come. Both of you.\"","","He leads you outside to a small, packed-earth clearing behind the house where three weathered wooden posts stand embedded in the ground in a rough triangle formation. Master Wong positions himself in the centre.","","\"Watch,\" he instructs simply.","","*page_break","What ensues is unlike any martial arts display you've seen before. Master Wong begins to move. His motions seem deceptively simple \u2014 a turn that sends a faint rustle through his cotton garments, a shift of weight that never fully settles, an extended hand with fingers slightly trembling \u2014 yet each possesses an undeniable rightness, flowing without apparent effort.","","Energy emanates from him as a subtle, warm glow that seems to extend his presence. The air around him thickens, carrying a faint metallic taste that tingles on your tongue. As he moves, the space between him and the posts seems to compress, waves of heat distorting your vision slightly.","","After less than a minute, Master Wong returns to a neutral stance, the gentle energy dissipating gradually, like ripples fading on calm water.","","\"The energy is not a weapon to be fired,\" he says quietly. \"It is an extension of yourself, as natural as your breath, as inherent as your balance.\"","","Eric exhales through his nose, fists briefly clenched. \"In tournaments...\" he starts, then shakes his head. \"It's not about balance out there. It's about power. Spectacle.\"","","\"Ah, tournaments,\" Master Wong sighs. \"Glory. Spectacle. You learn these skills for what purpose, Eric? To impress crowds? To win trophies?\"","","\"To test myself,\" Eric responds, his chin lifting slightly. \"To measure my progress against others.\"","","\"And how do you measure your progress?\" Master Wong says, his gaze intense. \"Can judges score it?\"","","Silence settles into the space between them. Eric holds his master's gaze, the corner of his mouth twitching slightly.","","*choice","    #Observe Eric's reaction.","        *gosub_scene utils increase_empathy","        You observe the subtle tension in Eric's posture \u2014 the slight clench in his jaw, the way his fingers flex then still. It's not about pride. It's something older than that. A need to be understood without having to explain.","    #Recall Eric's frustration at the gym when Chloe challenged his approach.","        *gosub_scene utils increase_analysis","        The tension in Eric's face now mirrors what you saw when Chloe questioned his commitment to flash and performance. You catalogue it automatically: same jawline tension, same narrowed focus. Like he's re-running that argument in his head, checking for flaws in his defence.","    #Focus on your breathing, the way Master Wong taught earlier.","        *gosub_scene utils increase_composure","        You hold your breath steady. This isn't the kind of moment that needs fixing. Time will move it forward. Your job is just not to rush it.","","Master Wong turns to you abruptly. \"You. Come here.\"","","You hesitate, then step forward.","","\"Attack Eric,\" he instructs, his voice calm but firm.","","For the next hour, Master Wong guides you both through various exercises, some familiar, some completely new. He has Eric repeat simple blocks and parries, focusing not on force but on attuning to his energy flows.","","Then he turns to you. \"Close your eyes,\" he instructs quietly. \"Feel the air around you. Not with your skin, but deeper. Sense the presence of others.\" Following his quiet instructions, you try to tune into the subtle shifts in the atmosphere.","","*choice","    #Try to sense Master Wong's energy.","        *gosub_scene utils increase_analysis","        At first, there's nothing but the sound of your own heartbeat in your ears and the soft in-and-out of your breath. Gradually, your other senses heighten \u2014 the brush of cloth against your skin, the coolness of the air entering your nostrils, the pressure of the ground beneath your feet.","","        You focus on Master Wong's presence, attempting to detect any subtle aura emanating from him. There's nothing but darkness behind your closed eyelids, no hint of hidden power or energy.","","        After many minutes, you sense something. It doesn't register on your skin, but arrives somewhere deeper. A steady but almost imperceptible warmth radiates from where Master Wong stands. It's dense, subdued, just a quiet pressure in the air.","","        \"Mmm,\" you hear Master Wong say softly, as if from a great distance. \"Most cannot sense this sort of restrained energy.\"","","    #Try to sense Eric's energy.","        *gosub_scene utils increase_empathy","        At first, there's nothing but the sound of your own heartbeat in your ears and the soft in-and-out of your breath. Gradually, your other senses heighten \u2014 the brush of cloth against your skin, the coolness of the air entering your nostrils, the pressure of the ground beneath your feet.","","        You direct your attention towards Eric, picturing where he stands. For several breaths, there's nothing unusual. Then you become aware of something distinct \u2014 a pulsing warmth that seems almost electric. Eric's energy surges and recedes like waves breaking on a shore. Bright points of intensity gather around what must be his hands and core.","","        \"Yes,\" Master Wong says softly. \"You sense his vigour, the cadence.\"","","    #Try to sense the threshold between your energy and the surroundings.","        *gosub_scene utils increase_composure","        At first, there's nothing but the sound of your own heartbeat in your ears and the soft in-and-out of your breath. Gradually, your other senses heighten \u2014 the brush of cloth against your skin, the coolness of the air entering your nostrils, the pressure of the ground beneath your feet.","","        Rather than reaching outwards, you turn your awareness inwards, trying to locate where \"you\" ends and the rest of the world begins. The distinction seems obvious at first \u2014 your skin, your breath. But as you focus, the boundary becomes less clear. Your exhale mingles with the air around you; warmth radiates beyond your fingertips. You sense a subtle field extending inches from your body, pulsing with your heartbeat but also responding to the energies nearby.","","        \"Now you begin to understand,\" Master Wong says, satisfaction evident in his voice. \"This is the foundation of all that we do.\"","","As the afternoon light begins to slant through the bamboo, Master Wong calls an end to the session. Inside again, over a simple meal of fragrant white rice, crisp steamed Chinese broccoli, and tangy pickled mustard greens, the conversation inevitably shifts back to Eric's upcoming competitions. Wooden chopsticks click gently against the bowls, the sound mingling with the occasional hiss of the dented iron kettle warming on a small burner in the corner.","","\"These commercial events,\" Master Wong says, shaking his head slowly as he picks up a piece of broccoli with his chopsticks. \"They encourage the wrong things. Flash over substance. Power over harmony. Spectacle over skill.\"","","\"They also pay the bills, Master,\" Eric counters respectfully. \"And they give me a platform. A chance to demonstrate what real skill can look like.\"","","\"And when will you demonstrate that?\" Master Wong asks, setting down his chopsticks. \"Power with purpose? Responsibility?\"","","Silence reigns, broken only by the soft clink of chopsticks. You focus intently on the grains of rice in your own bowl, suddenly feeling like an intruder privy to a long-standing family disagreement.","","Master Wong sighs, a long, slow exhalation, and his stern expression softens almost imperceptibly. \"You have progressed, Eric, that much is clear. Your control is better, your understanding deeper. But technical mastery... technical mastery was never the true challenge for you.\"","","He turns to you unexpectedly, his sharp eyes meeting yours. \"And you, ${first_name} ${last_name}? What do you think of my stubborn former student?\"","","*choice","    #Express admiration for Eric's dedication to his craft.","        *gosub_scene utils increase_empathy","        You tell Master Wong you've been impressed by Eric's commitment, his relentless drive to perfect his techniques, and his willingness to teach others.","","        Master Wong listens to your response without blinking, his head tilted slightly. Then he nods. \"He has always worked harder than anyone expected. That effort shows.\"","    #Acknowledge the conflict you've observed in him.","        *gosub_scene utils increase_analysis","        *set eric_friendship +1","        You carefully note that Eric seems pulled between competitive ambition and something deeper, still searching for the right path forward.","","        Master Wong considers this for a long moment, eyes distant. Then he speaks. \"That kind of conflict doesn't stay hidden. It shows up in the ring, whether you want it to or not.\"","    #Suggest that Eric respects Master Wong more than he admits.","        *gosub_scene utils increase_composure","        *set eric_friendship +2","        You mention that despite their disagreements, Eric speaks of his former master with evident respect and often refers back to his teachings.","","        Master Wong's expression doesn't change, but a faint breath escapes him \u2014 not quite a sigh. \"Respect isn't always loud. The ones who argue often remember the most.\"","","He says nothing more. The food cools in its bowls.","","As the simple meal concludes, Master Wong rises and moves to a carved wooden chest in the corner. He returns with a small, tightly tied cloth bag, which he hands to Eric.","","\"The herbs for your training salve,\" he explains. \"Use them sparingly. And I've included something for your friend's wrist.\" He glances briefly at you. \"I noticed ${he} @{gender_num favours|favours|favour} it slightly during rotational punches.\"","","Your hand instinctively touches your wrist, where neither you nor Eric had noticed anything amiss.","","\"Thank you, Master,\" Eric says, accepting the bag with both hands and bowing respectfully.","","*page_break","As you prepare to leave, Master Wong escorts you both to the edge of the clearing. \"Eric.\" Master Wong rests a weathered hand on Eric's shoulder. \"Energy flows where attention goes. The world will always attempt to steer your attention. What you turn from shapes you as much as what you pursue.\"","","Eric bows his head low, both hands accepting the herb pouch like a fragile offering. \"I've been trying,\" he says finally. \"Even when it feels like I'm missing the point.\"","","Master Wong turns to you. \"It was interesting to meet you, ${first_name}. Perhaps you will help my headstrong former student find his balance.\" A fleeting hint of amusement dances at the corners of his eyes. \"He has always been better at teaching than listening.\"","","*choice","    #You register your new position in this dynamic.","        *gosub_scene utils increase_composure","        You note the repositioning. Quietly slotted into their dynamic \u2014 not as student, not as intruder, but as something in between. A relay point, maybe. A slight weight settles onto your shoulders. Not heavy, just present. Like the humidity before rain.","    #You catch something shifting in Master Wong's expression when he looks at Eric.","        *gosub_scene utils increase_empathy","        The amusement flickers and fades. What remains is harder to name. Maybe weariness. The kind that settles in after years of wanting someone to get it, and knowing they might not.","    #You note how Master Wong pairs criticism with praise. Every word placed carefully.","        *gosub_scene utils increase_analysis","        He balances criticism with praise. Not flattery, not reprimand. Just enough to keep Eric listening. A rhythm, if not a plan. You recognise the cadence.","","The walk back to the village proceeds mostly in silence, the crunch of your shoes on the dirt path the only sound besides the insistent, rhythmic chirping of evening insects emerging with the cooling air. Both you and Eric seem absorbed by the afternoon's events. As you wait by the dusty road, Eric finally breaks the silence.","","\"So... that's Master Wong,\" he says, a small, wry smile playing on his lips. \"The man who taught me everything about energy projection... and then spent the next seven years telling me not to use it for competition.\"","","Eric gazes out across the darkening fields. \"When I first discovered I could project energy... it was an accident, during a junior tournament. Master Wong found me afterwards. Said he'd recognised the signs, the energy signature. That he'd been watching for someone like me.\"","","The headlights of the approaching minibus appear in the distance, cutting through the growing dusk.","","\"He taught me to control it, to understand it. But he also had... expectations. About how I would use these skills.\"","","Eric exhales softly. He hasn't said much since leaving the clearing.","","You board together, slipping your coins to the driver. The minibus lurches forward, engine growling as the village shrinks behind you.","","Eric stares out the window, one hand resting on the cloth bag in his lap. The trail to Master Wong's house vanishes behind trees and distance.","","\"He's not wrong,\" he says quietly. \"But it's not enough. Not for me.\"","","The reflection in the glass shows a flicker of tension in his jaw, gone before it settles.","","[i]Master Wong didn't name it. But you now have a way to practise what he taught \u2014 quietly, alone.[/i]","*set eric_friendship +2","*return","","*label event_4","The vast secondary training hall at the Hong Kong Sports Institute echoes with the sharp snap of Eric's gi and his focused, controlled breathing, sounds magnified in the otherwise silent space. The Pearl River Cup looms. Etched onto his face is the evidence of his intense preparation \u2014 dark circles smudged beneath his eyes, faint yellowing bruises mottling his forearms. The air conditioning hums overhead, carrying a faint scent of floor polish.","","Eric had invited you to this private after-hours session. The cavernous hall, usually bustling, stands empty except for the two of you, the rows of unused equipment standing like silent witnesses under the bright fluorescent lights.","","\"Right,\" Eric says, sweat already darkening the back of his gi despite the hall's cool, air-conditioned temperature. He tosses you a pair of reinforced focus mitts that feel dense and surprisingly heavy in your hands. \"I need to work on the transition. Physical to energy, making it seamless.\"","","For the next thirty minutes, you hold the mitts as he works through increasingly complex striking sequences. A faint amber glow begins to emerge, trailing each punch, flickering along his arms in rhythm with the motion. It's not fully stable. Not yet. But it's starting to weave in, settling as an undercurrent.","","He moves through another sequence, tighter this time, more fluid. Three strikes land clean. But on the last one, the glow flares sharp and late \u2014 a spike of heat that throws off his balance. He exhales sharply, adjusting his stance.","","\"Still too much at the end,\" he mutters. \"Needs to flow the whole way through.\"","","He wipes his face with the towel, breath still quick. The mats beneath him are already slick with sweat.","","*fake_choice","    #Compliment his progress with the energy integration.","        *gosub_scene utils increase_empathy","        \"You're getting better at blending your energy with your physical movements,\" you say. \"It looks more natural now, less forced.\"","        ","        Eric nods, a flicker of satisfaction crossing his face. \"That's exactly what I'm working on. Master Wong keeps saying the energy should feel like an extension, not an addition.\"","    #Share an insight connecting his training to Master Wong's teachings.","        *gosub_scene utils increase_analysis","        *set eric_friendship +1","        \"This reminds me of what Master Wong showed us,\" you observe. \"The energy flowing naturally rather than being forced. You're finding that middle path he talked about.\"","","        Eric's eyes widen slightly, something clicking into place. \"You know, you're right. I've been so focused on making the technique work that I almost missed the actual lesson.\"","    #Focus on the practical applications for the upcoming tournament.","        *gosub_scene utils increase_composure","        \"This approach should give you more endurance in the later rounds,\" you observe. \"Less energy wasted on flashy bursts.\"","","        \"Exactly,\" Eric agrees, rolling his shoulders. \"The Pearl River Cup goes five rounds minimum. Can't afford to burn out early like last year.\"","","Eric nods slowly, absorbing your words. A pause. \"There's still one technique I need to refine for the Pearl River Cup.\" His jaw tightens almost imperceptibly. \"The [i]Volcanic Dragon Ascent[/i].\"","","He instructs you to circle him, throwing occasional light, probing attacks. After tracking your movements for a minute, letting his senses attune, he meets your eye and flicks his chin towards the edge. You back away.","","He launches into a rising uppercut where raw, volatile energy explodes around his striking arm, throwing off waves of heat and filling the air with sharp ozone. It coalesces into a roaring, dragon-shaped flame that engulfs his upper body. But midway through the final strike, a jagged flicker sparks across his knuckles \u2014 unstable, too long.","","He lands hard, off-balance. Breath ragged. Shakes out his wrist.","","\"Damn it,\" he mutters. \"Still unstable. Still wrong.\"","    ","He sits down briefly, rubbing at his wrist. \"Sometimes I wonder what life would've been like if I'd never figured out the energy thing.\"","","\"When did Master Wong figure out his powers anyway?\" you ask.","","\"He says it happened during a dance break. Back when he was in a boy band. Claims he accidentally zapped a backup dancer.\"","","He takes an easy breath and adjusts the wrist wrap on his right hand.","","For the next hour, Eric repeats the demanding technique relentlessly \u2014 dozens of times. Around the twentieth repetition, the veins in his forearms begin to protrude. Sweat pours down his face, dripping onto the polished floor with audible [i]taps[/i] in the quiet hall, while his breathing turns ragged, each inhale sounding harsh and strained, punctuated by sharp exhales at the peak of each attempt. A faint pallor emerges on his skin. His hands tremble slightly.","","After the thirtieth attempt, the pauses between repetitions stretch longer. He leans forward, hands on his knees, head down.","","*choice","    #Suggest he take a break and analyse what's happening.","        *gosub_scene utils increase_analysis","        *set eric_friendship +1","        \"Let's pause for a minute,\" you suggest. \"Sometimes you can see more clearly when you step back.\"","","        Eric hesitates, then nods reluctantly. \"Maybe you're right.\" He straightens slowly, wincing. \"I keep feeling like I'm missing something fundamental in the energy flow. Just one last try and then we'll take a break.\"","    #Offer encouragement to push through.","        *gosub_scene utils increase_composure","        \"You're almost there,\" you say. \"I can see the pattern improving with each attempt.\"","","        Eric gives you a grateful nod and takes a deep breath. \"One more time, then.\" He sets his jaw, determination overriding the fatigue evident in his posture.","    #Ask why the move keeps breaking down.","        *gosub_scene utils increase_analysis","        \"What exactly makes this technique so difficult?\" you ask. \"The energy consumption or the execution?\"","","        \"Both,\" Eric says, straightening up with visible effort. \"The dragon requires precise energy control and the uppercuts need precise physical control. Let's try this one more time.\"","","He launches into it again. This time, as he completes the final strike, the fiery energy doesn't fade cleanly. It clings to his arm like thick, burning honey, pulsing erratically with a low, angry [i]sizzle[/i] and a faint smell of ozone and something vaguely burnt. Eric lands unsteadily. He staggers sideways, his right arm hanging limp at his side. Then his legs give out and he drops heavily to one knee, gasping for air, a tremor running through his entire body.","","You rush forward instinctively. He waves you off weakly with his left hand. \"I'm... fine,\" he manages between breaths. \"Just... pushed it too far.\" His complexion now has a distinct grey-green tinge under the harsh lights, and both his hands are shaking visibly.","","\"What happened?\" you ask, offering him his water bottle.","","\"Energy burnout,\" he explains, gulping down water between ragged breaths. \"The pathways... get overloaded. Like sugar charring if you look away for a second.\"","","He sits heavily on a nearby bench, letting the bottle rest in his lap. \"Master Wong warned me about this,\" he admits, his voice low. \"He says forcing these high-output energy techniques without proper harmonisation... it's like trying to direct a river through a garden hose. Eventually, something gives.\"","","*choice","    #Ask about other fighters who use similar techniques.","        *gosub_scene utils increase_analysis","        \"Do other fighters at the Pearl River Cup use techniques like this?\" you ask. \"Or is this something unique to your style?\"","","        \"A few others have energy projection abilities,\" Eric explains, wincing as he rotates his shoulder. \"But most use simple bursts or enhancements. This level of manipulation is rare. That's why I need to perfect it.\"","","        He looks down at his trembling right hand. \"The Pearl River Cup is too important. The Volcanic Dragon Ascent... it's my signature move.\" He swallows hard before meeting your eyes. \"It's the one thing that separates me from the other fighters.\"","    #Suggest a modified version that requires less energy.","        *gosub_scene utils increase_composure","        \"What if you developed a less intense version?\" you suggest. \"Something that achieves similar results without the burnout risk.\"","","        Eric frowns slightly. \"A watered-down version won't have the same impact. The judges and audience expect something spectacular.\"","","        He pauses, gaze drifting to the floor. \"But you might have a point about sustainability.\" He says the word like it doesn't belong here \u2014 like it's something you plan for after a loss, not before a fight.","","        Then he looks up, jaw tight. \"The Pearl River Cup is too important. The Volcanic Dragon Ascent... it's my signature move.\" The words come fast, like he needs them to be true. \"It's the one thing that separates me from the other fighters.\"","    #Express concern and suggest a more balanced approach.","        *gosub_scene utils increase_empathy","        *set eric_friendship +1","        \"Your body is telling you something important,\" you say quietly. \"What if instead of forcing the technique, you try harmonising it with your natural movement? Like that energy flow we practised earlier.\"","","        Eric looks up, considering your words. His expression shifts from frustration to thoughtful recognition. \"That... actually makes sense. Master Wong always said energy should follow intention, not force.\" He flexes his hand experimentally. \"Maybe I've been approaching this all wrong.\"","","        But even as he says it, doubt creeps in. His gaze returns to his trembling right hand and shakes his head stubbornly. \"But the Pearl River Cup is too important. The Volcanic Dragon Ascent... it's my signature move.\" He looks up at you, a flicker of desperation in his eyes. \"It's the one thing that separates me from the other fighters.\"","","\"Is that separation worth hurting yourself over?\"","","\"You sound like Master Wong, ${first_name},\" Eric mutters, flexing his hand. His tone stays flat, but his eyes flick away. \"Harmony over power \u2014 that's his whole thing.\" He rubs his arm, slower now. \"But he's never fought in front of cameras. Never had to make it look like a show.\"","","\"I've seen you fight both ways,\" you point out quietly. \"You won that traditional tournament without using any energy abilities at all.\"","","\"That was different. Local competition, lower stakes,\" Eric counters. \"The Pearl River Cup... it has international fighters, media coverage, scouts watching every move. It's a different world.\"","","Reaching into his bag, he pulls out the small container of Master Wong's herbal salve. Opening it releases a sharp, medicinal scent \u2014 camphor, mint, and something earthy. He starts to massage the pungent green ointment into his arm with slow, careful movements, the coolness of the salve contrasting with the lingering heat of the energy burnout. The tremors in his hand diminish as the salve takes effect.","","*page_break","\"One more attempt,\" Eric says, pushing himself to his feet, his movements still stiff. He takes a breath, steadies his stance. \"But different. A modified version... less raw power, more integration. Focusing on the flow, the way Master Wong would approach it.\"","","This time, his preparation appears more measured, his breathing slower. He gathers himself inwardly before beginning. The energy emerges differently too \u2014 not as an explosion, but as a subtle golden glow that gradually intensifies, weaving around his arm. The dragon manifests as a luminous extension of his movements. Each strike flows naturally into the next.","","When Eric lands this time, his balance is perfect, his breathing controlled. The golden energy disperses softly, quietly. A pleasant warmth lingers in the space, along with the faint scent of fresh earth after rain. He turns to you, his eyebrows raised slightly in surprise at his own success.","","\"That... felt different,\" he says, examining his now steady hand with a thoughtful expression. \"Less raw output, maybe, but... smoother. More effective, somehow.\"","","*fake_choice","    #Acknowledge how the technique seemed more powerful despite using less raw energy.","        *gosub_scene utils increase_analysis","        \"That wasn't just more controlled \u2014 it looked more powerful,\" you observe. \"Like the energy was working with your movements instead of being forced through them.\"","","        Eric considers this, hand on his chin. \"You might be right. When I stopped fighting against the energy flow and let it integrate naturally... it felt like I was channelling more effectively with less strain.\"","    #Point out how this approach aligns with Master Wong's teachings.","        *gosub_scene utils increase_empathy","        *set eric_friendship +1","        \"That's exactly what Master Wong was trying to show us,\" you say quietly. \"The harmony of energy and technique creating something greater than either alone.\"","","        Eric nods slowly, his eyes widening. \"All this time, I thought he wanted me to hold back... but he was actually showing me how to access something deeper.\"","    #Focus on the practical advantages for competition.","        *gosub_scene utils increase_composure","        \"You'll last longer in the later rounds with this approach,\" you point out. \"More sustainable energy management means you can maintain your edge when others are fading.\"","","        \"Tactical advantage,\" Eric agrees, flexing his hand thoughtfully. \"I've lost matches before when I burnt out too early. This could change everything.\"","","\"It looked more controlled,\" you confirm. \"More precise. More like what Master Wong demonstrated back at his place.\"","","Eric nods slowly, a contemplative look on his face. \"Maybe the old man has a point after all.\" He begins gathering his scattered equipment. \"Right. I think that's enough for today.\"","","As you are packing your own bag, about to leave the silent hall, Eric turns to you. His eyes meet yours briefly before falling away to the floor. \"Hey... would you be interested in coming to the Pearl River Cup? Not just as a spectator... but in my corner.\"","","A hesitation. \"I could use someone there who... understands what I'm trying to work towards. The balance.\"","","*fake_choice","    #\"You don't have to ask twice.\"","        *set eric_friendship +1","        You consider the unexpected offer for a moment, then nod. \"Yeah. I'd like that.\"","    #\"I'll need to see what's happening that week... but I want to be there.\"","        You pause, weighing the commitment. \"I'll need to check my schedule, but... yeah, I think I could make that work.\"","","He flexes his fingers, watching the movement carefully. \"Power with control,\" he says, half to himself. \"Technique with purpose.\"","","A pause. \"Maybe it's not just about trophies anymore.\"","","The fluorescent lights shut off. The hum of the air conditioning fades. Eric glances back at the empty hall.","","\"Thanks,\" he says quietly. \"For pushing back when I needed it.\"","","You both step outside into the cool evening air. At the bus stop, Eric offers a small, thoughtful nod before turning towards home.","","[i]A new Boxing Insight settles. Not explosive, but quietly anchored. Energy no longer flaring, just flowing.[/i]","*return","","*label event_5","Heavy and damp, the early morning mist clings to the mountainside as your taxi cautiously navigates the steep, winding road up toward the peak of Tai Mo Shan. When you arrive at the designated trailhead, Eric is already waiting, leaning against a weathered wooden sign. Dressed in practical hiking clothes rather than his usual training gear, a simple backpack slung over one shoulder, his eyes meet yours briefly\u2014a flicker of something unreadable in their depths\u2014before flicking away again. His jaw looks tight, his shoulders held stiffly.","","\"Thanks for coming,\" he says, his voice quiet, almost subdued. \"There's a place up here... a place I want to show you.\"","","You begin ascending the narrow, rocky trail together, the crunch of your boots on loose scree and your synchronized breathing the only sounds breaking the misty quiet. Neither of you mentions the Pearl River Cup, the unspoken subject hanging heavy in the cool, damp air between you. A faint purple-yellow bruise peeks out from beneath the collar of Eric's jacket, and you notice his right hand occasionally flexes and unflexes, as if working through some lingering stiffness or ache. He sets a brisk, steady pace, pushing upward, the trail narrowing as the sprawling panorama of Hong Kong gradually disappears beneath a sea of clouds below.","","\"I used to come up here to train sometimes... with Master Wong,\" Eric finally says, breaking the silence as you pause for water near a small waterfall tumbling over moss-covered rocks, its fine spray cool against your face. \"He said the mountain air... clarified the mind. Helped with focus.\"","","Halfway up, Eric stops abruptly at a switchback where the trail doubles back on itself. His breathing has grown ragged\u2014not from exertion, but something else. He braces one hand against the rock face, fingers splayed wide.","","\"I shouldn't have brought you here,\" he says suddenly, not looking at you. \"This was a mistake.\"","","*choice","    #\"We can go back if you need to.\"","        *gosub_scene utils increase_empathy","        *set eric_friendship +1","        \"We can go back if you need to,\" you offer quietly. \"No judgment.\"","","        Eric's hand tightens against the rock. For a moment, you think he might take the out. Then he pushes off from the wall, jaw set.","","        \"No. I've been running from this conversation for weeks.\" He resumes climbing, but his pace is less punishing now. \"Master Wong says I compartmentalize too much. Keep things separate that should be connected.\"","","    #\"What are you afraid I'll see?\"","        *gosub_scene utils increase_analysis","        *set eric_friendship +1","        \"What are you afraid I'll see?\" you ask directly.","","        Eric flinches slightly, then lets out a short, bitter laugh. \"That's the problem. I don't know.\" He resumes climbing, but slower now. \"Maybe that I'm not who I've been pretending to be. Maybe that Master Wong was right all along.\"","","        \"About what?\"","","        \"About everything,\" he mutters, pushing forward up the trail.","","    #Say nothing and wait.","        *gosub_scene utils increase_composure","        You don't push. Just adjust your pack and wait, giving him space to work through whatever's churning inside.","","        After a long moment, Eric's shoulders drop slightly. \"Sorry. I'm being...\" He trails off, then starts walking again. \"Let's just get to the top.\"","","        The tension doesn't leave his frame, but he stops trying to outrun it.","","After another thirty minutes of steady climbing, the trail levels out onto a small, grassy plateau where a steady wind sighs through the sparse grass, carrying the scent of damp earth and high-altitude vegetation. Here grows a single, ancient-looking tree, its trunk twisted at an impossible angle against the wind. Beyond it, the mountainside drops away sharply, offering a breathtaking, cloud-interrupted view of the New Territories stretching out below.","","\"This is the spot,\" Eric says quietly, his fingers trailing over the rough, weathered bark of the old tree with an unexpected tenderness. \"Right here. This is where it happened. Where I first... discovered I could project energy. Seven years ago.\"","","He moves away from the tree and sits down near the edge of the plateau, legs dangling over the drop. \"I was seventeen,\" he continues, his voice low, introspective. \"Obsessed with winning tournaments, proving myself.\" The corner of his mouth pulls back in what might be a wince of remembered embarrassment. \"I lost a match I should have won. Came up here afterward, furious. I threw a punch, just hitting the air in frustration... and suddenly there was this... energy. Pouring from my hand like uncontrolled electricity, hot and terrifying, making the air crackle. Scared the hell out of me.\"","","He holds up his right hand, studying it. \"Set the grass on fire. Could have burned down half the mountain if it hadn't started raining.\" A pause. \"Master Wong found me the next day. Said he'd felt the energy disruption all the way down in the village.\"","","*page_break","Eric stands up abruptly, moving to the very edge of the plateau, staring out into the swirling mist. \"He taught me to control it, eventually. But we always disagreed about what these abilities were for. I saw opportunity, recognition, a way to stand out. He saw... purpose. Responsibility.\" His shoulders hunch slightly under the weight of the memory. ","","Turning back to you, he asks, \"Did you know there are others? Like me? People with... gifts. Abilities that go beyond normal human capability.\"","","\"I've started to suspect as much,\" you reply, thinking of the impossible things you've witnessed in the underground circuit, the fighters whose styles defy conventional explanation.","","\"The Pearl River Cup... it changed something for me,\" Eric continues, leading you a few steps away from the edge, toward a small patch of bare earth near the tree's roots. \"Final round. I had the perfect opening for the Dragon Ascent, the crowd was roaring... but Master Wong's voice was suddenly right there in my head: 'Power without purpose becomes merely spectacle.' Clear as day.\" He shakes his head again. \"I hesitated. Just for a second. Long enough to lose the opening, lose the match.\"","","He glances sideways at you, then back towards the mist.","","\"You were there. You saw it. The whole crowd wanted fire, and I gave them nothing.\"","","His fists clench. \"And the worst part? Part of me was relieved. Relieved I didn't have to make the choice.\"","","He kneels down at the edge of the bare patch, placing both palms flat on the cool, damp soil. \"Afterward... after the tournament... I came back up here. Tried to figure things out. And I discovered something. Or it discovered me. I'm still not sure which.\"","","A soft, golden glow emanates from his hands, spreading gently into the earth beneath them. Unlike the crackling, intense energy of his combat techniques, this feels different. Gentler, warmer, more diffuse\u2014you can feel a subtle warmth radiating from his palms even from a few feet away. ","","For a moment, nothing happens. Then tiny green shoots begin to emerge from the dark, damp soil where his hands rest. They grow visibly, unfurling delicate leaves\u2014","","Then they wither. Blacken. Crumble to ash.","","Eric jerks his hands back as if burned. \"Damn it!\" The frustration in his voice is raw. \"Every time. I can feel it wanting to grow, but then\u2014\" He gestures helplessly at the small circle of dead earth.","","*choice","    #\"Maybe you're trying too hard to control it.\"","        *gosub_scene utils increase_empathy","        *set eric_friendship +1","        \"Maybe you're trying too hard to control it,\" you suggest carefully. \"The same way you tried to control the combat energy at first.\"","","        Eric looks up at you, something vulnerable in his expression. \"But if I don't control it, people get hurt. Things get destroyed.\" His voice drops. \"I get destroyed.\"","","        \"Or maybe,\" you say, sitting down beside him, \"control isn't the same as force. Master Wong keeps trying to tell you that, doesn't he?\"","","        Eric's hands hover over the scorched earth. \"It's easier with fighting. There's a target. An opponent. This...\" He trails off. \"What if I can only destroy?\"","","    #\"What's different when it works?\"","        *gosub_scene utils increase_analysis","        *set eric_friendship +1","        \"What's different when it works?\" you ask. \"You said you've done it successfully before.\"","","        Eric frowns, thinking. \"The first time was an accident. I was... I wasn't trying to do anything. Just touching the earth, thinking about the match, about Master Wong, about what it all meant. And then I looked down and there were flowers.\"","","        \"So when you're not focused on the outcome\u2014\"","","        \"It just happens,\" Eric finishes. His expression shifts. \"Like the energy knows what to do if I stop telling it how to work.\"","","    #\"Show me again. Don't think about it.\"","        *gosub_scene utils increase_composure","        \"Show me again,\" you say simply. \"Don't think about it. Just put your hands down and tell me more about that first time it worked.\"","","        Eric hesitates, then places his palms back on the earth. \"I was exhausted,\" he begins, his voice distant. \"Not just physically. Everything I thought I knew about myself was...\" ","","*page_break","As Eric speaks, lost in the memory, the golden glow returns to his hands. Softer this time. Less intentional. He doesn't notice the first green shoot emerging, or the second. His eyes are closed now, his breathing steady.","","\"I kept hearing Master Wong's words. About purpose. About connection. I hated him for being right. Hated myself for not seeing it sooner. And I just... sat here. Feeling everything.\"","","A small cluster of vibrant purple mountain flowers blooms where his hands rest, releasing a faint, sweet fragrance into the misty air. Eric's eyes snap open. He stares at the flowers, then at his hands, then back at the flowers.","","\"How\u2014\" He stops himself, understanding dawning. \"I wasn't trying to create. I was just... being.\"","","He slowly withdraws his hands, leaving the small, improbable cluster of flowers swaying gently in the mountain breeze. But his expression remains troubled.","","\"Master Wong always said the energy comes from life itself,\" he reflects quietly. \"That it can nurture as well as destroy. I thought he was being poetic.\" A bitter laugh. \"Turns out he was being literal, and I was too focused on winning to listen.\"","","*choice","    #\"Both abilities have value. It's about knowing when to use which.\"","        *gosub_scene utils increase_analysis","        \"Both abilities have value,\" you point out. \"Destruction and creation. Fighting and nurturing. It's about knowing when to use which.\"","","        \"That's very... balanced of you,\" Eric says with a slight smile. \"Master Wong would approve.\" The smile fades. \"But I've spent seven years perfecting destruction. This\u2014\" he gestures at the flowers, \"\u2014this is like learning to walk again.\"","","    #\"What if fighting was never the real purpose of your gift?\"","        *gosub_scene utils increase_empathy","        *set eric_friendship +1","        \"What if fighting was never the real purpose of your gift?\" you ask gently.","","        Eric's whole body tenses. \"Don't.\" His voice is sharp. Then, quieter: \"Not yet. I'm not ready to... I've built everything around being a fighter. My identity, my future, my\u2014\" He stops. \"What else would I even do?\"","","    #\"You don't have to choose one or the other.\"","        *gosub_scene utils increase_composure","        *set eric_friendship +1","        \"You don't have to choose one or the other,\" you say. \"Maybe the point is integration. Like your combat training\u2014physical and energy together.\"","","        Eric considers this, absently touching one of the flower petals. \"Master Wong did say something like that once. That separation is an illusion we create to make things simpler.\" He looks at you. \"When did you get so wise?\"","","He stands up, brushing the dirt from his knees. \"So what does this mean? For your fighting career?\" you ask.","","Eric looks from the flowers back out toward the mist-shrouded view. \"I don't know yet,\" he admits honestly. \"I'm not ready to walk away from competition entirely. But maybe... maybe fighting isn't the only way to use these abilities. Maybe it's not even the most important way.\"","","His phone buzzes. He glances at it and his expression darkens. \"Chloe. She's organizing an 'exhibition match' next week. Unsanctioned. Big money. She wants me to be the main event.\" He shows you the message: [i]Time to show them what Blazefist is really about.[/i]","","\"What timing \u2014\" He cuts himself off. \"Doesn't matter. This is what I mean. Every time I try to explore something different, something real, the circuit pulls me back.\"","","*choice","    #\"You could use the exhibition to show something different.\"","        *gosub_scene utils increase_analysis","        *set eric_friendship +1","        \"You could use the exhibition to show something different,\" you suggest. \"If they want Blazefist, give them something they don't expect.\"","","        Eric's eyes light up slightly. \"Turn their spectacle into a demonstration. Show them power can be more than destruction.\" He nods slowly. \"It's risky. They might hate it.\"","","        \"Since when has that stopped you?\"","","    #\"You don't owe them anything.\"","        *gosub_scene utils increase_empathy","        \"You don't owe them anything,\" you say firmly. \"Not Chloe, not the crowd, not the circuit.\"","","        \"Maybe not,\" Eric agrees. \"But I owe myself some answers. And hiding up here growing flowers isn't going to give me those.\" He looks at the message again. \"Maybe facing what I've been running from will.\"","","    #\"What do you want to do?\"","        *gosub_scene utils increase_composure","        *set eric_friendship +1","        \"What do you want to do?\" you ask simply.","","        Eric is quiet for a long moment. \"I want to matter,\" he says finally. \"Not just as a fighter. Not just as someone who can make pretty lights. I want to use this gift for something that... lasts.\"","","        He pockets his phone. \"But first, I need to stop being afraid of my own power.\"","","As you begin the descent back down the mountain, Eric's steps seem lighter, but more deliberate. The stiffness in his shoulders has been replaced by a different kind of tension\u2014anticipation rather than dread.","","\"Master Wong is organizing a small gathering next month,\" Eric says as the trail begins to widen near the base. \"People with abilities, similar to mine maybe, but who use them differently. He mentioned healers, protectors... people focused on community.\" He glances at you, a hesitant look in his eyes. \"He suggested I bring someone along. Someone who helps keep me grounded. Someone who understands the journey.\"","","He pauses, then adds: \"But first, I need to deal with this exhibition. Face what I've been avoiding. Will you\u2014\" He stops, starts again. \"Would you be there? Not in my corner this time. Just... there.\"","","The small cluster of impossible mountain flowers remains on the plateau far above, a quiet testament to potential not yet fully explored. But also, perhaps, to the harder truth: that growth sometimes requires returning to scorched earth before new things can bloom.","*return","","*label event_6","*return"], "labels":{"scene_introduction":0,"scene_choice":29,"event_1":70,"event_2":185,"event_3":349,"event_4":579,"event_5":753,"event_6":933}},
"katie_fight": {"crc":-1328688185, "lines":["*label fight","*temp dc_easy 10","*temp dc_medium 14","*temp dc_hard 19","*set fight_momentum 5","*set trait_bonus_amount 2","*set upgrade_multiplier 4","*gosub_scene utils calc_adj_stats","*comment If the player trains three times and rests once, and visits Eric both times, they'll be at effective stats of 9 for untrained stats, 14 for trained-once, 20 for trained-twice","*comment 1 = loss, 2 = win","*temp match_result 0","\"Hi! Are you ${first_name}?\" A cheerful voice, too bright for the mood, makes you jump.","","You turn to see a tall woman in neon pink Jazzercise leggings, teal headband, leg warmers and a \"Pressure Point Basics\" T-shirt. Her long brunette ponytail is bound with a purple scrunchie, and she cradles an anatomy textbook under her left arm. She adjusts her fingerless gloves, the black leather accentuating her long fingers.","","\"Yeah, that's me...?\" you reply, taking in her unusual appearance.","","\"I'm Katie! They call me 'Pressure Point' in the ring.\" She smiles and extends her hand, ponytail swishing. \"We're up next. I've been looking forward to fighting a boxer. Boxers have such interesting upper body nerve points!\"","","You hesitate slightly before shaking her hand. Her grip is firm, her fingers strong as they press into the back of your hand.","","\"I'm a pressure point fighter. I try to win by finding nerve points and inflicting debilitating pain,\" she says, like you're discussing the weather. \"But don't worry! Everything's temporary. There's no actual damage at all!\"","","She gives you a reassuring pat on your shoulder. \"I'm investigating pain responses for my kinesiology research. Your feedback after the match would be super helpful.\"","","You try your best to respond. But before you can gather your words, the announcer calls your names. Katie waves cheerfully and bounds towards the ring. You follow her slowly, brain still trying to process what she said.","","The crowd energy is different tonight. No cheering, no chanting. Just a hush, like everyone's holding their breath.","","*choice","    #You wonder why she's so interested in causing pain.","        *gosub_scene utils increase_empathy","        She's extremely upbeat, that's for sure. And something compels her to inflict pain. You're not yet sure what that is.","    #You think about nerve point attacks and what adjustment you should make.","        *gosub_scene utils increase_analysis","        If she's telling the truth, one strategy suggests itself immediately: don't let her get close to you. You need to keep her at range, somehow.","    #Her willingness to tell you her fighting style is reassuring.","        *gosub_scene utils increase_composure","        Her methods may be brutal, but you don't sense any malice. She seems to think it's just another fighting style.","","You ease into your boxing stance, finding your footing on the firm canvas, as you wait for the referee to start the match. Katie stretches her fingers and enters what appears to be a Jazzercise pose that also incorporates three or four clashing martial arts styles.","","\"Remember, your joints aren't actually going to be damaged, even if it feels like it!\" she calls across to you.","","You swallow hard.","","The ref studiously examines a scuff mark on the canvas as he recites the standard instructions, words tumbling out as if he's trying to rush through a pre-flight safety announcement. His hand chop for \"Begin!\" is more of a twitch, and he steps back a little too quickly.","","*page_break","You advance with careful steps, eyes fixed on her long fingers, and test her with a few tentative jabs. Katie bobs and weaves past all of them, anticipating your punches before they're fully extended.","","\"Good punching form,\" she says, slipping yet another of your punches. \"You're using your muscle chains well!\"","","You advance more aggressively, landing a solid jab to Katie's right shoulder with a hefty thud. She absorbs the hit, not showing any reaction, the relaxed smile still on her face. But as you move in for another combination, Katie's posture tightens up. She slips inside your guard, her fingers pressing a point on your elbow as she applies leverage to your wrist with her other hand.","","A thunderbolt of silver, immobilising pain crashes through your arm. It radiates from the elbow, first down to the fingertips, then surging upward to the shoulder. You can't move, can't flex, can't do anything but experience the pulsing white-hot agony.","","\"AARGH!!!\" you scream. Agony rips through your elbow, the pain so intense that black spots appear on the edges of your vision.","*set fight_momentum -1","","*gosub_scene utils show_fight_momentum","","*choice","    #You fight to stay functional.","        *gosub_scene utils increase_composure","        No time for diagnosis. You brace and adapt. The fight continues until the ref stops it.","    #You assess the pain like a checklist.","        *gosub_scene utils increase_analysis","        Pain floods the joint, but the elbow still moves. No crack, no slackness. Not confirmation, but a clue.","    #You glance at Katie, searching for malice.","        *gosub_scene utils increase_empathy","        She's watching. Not triumphant. Just... interested. Like she's logging the results.","","\"Totally normal,\" Katie says, still pressing. \"Just your nerves sending the wrong signals to your brain. It only [i]feels[/i] like your elbow's bending backwards. It's not.\"","","She lets go. Like flipping a switch, the pain vanishes. The joint bends easily. Full mobility, like nothing happened.","","\"Back to normal! Neat, right?\"","","You flex your elbow, prod it with your other gloved hand. The crowd cheers \u2014 most of them have seen Katie in action before.","","*choice","    #You steady your breath and reset.","        *gosub_scene utils increase_composure","        You don't look at your arm. Don't ask questions. Just breathe, reset, and raise your guard. The pain is gone. That's enough for now. You tighten your positioning and keep close track of where her hands are moving.","    #You watch her, not your arm.","        *gosub_scene utils increase_empathy","        She's still watching you. Not like a fighter. Like a scientist, waiting to see if the result matches the hypothesis. You flex your elbow. It's fine. Whatever that was, it meant something to her.","","    #You ask her how it works.","        *gosub_scene utils increase_analysis","        *set katie_friendship +1","        \"What did you just do?\" you ask.","","        Delight sparkles in Katie's eyes at your interest. \"Nerve manipulation,\" she enthuses. \"I'm stimulating specific pathways that transmit pain signals to your brain. It all happens without any physical damage. I'm writing my dissertation on it!\"","","        The referee clears his throat pointedly, and you both snap back and focus on the fight again.","","A brief lull follows. You maintain distance with quick jabs, buying space while your brain finishes processing. The crowd grumbles, impatient. Katie waits, loose and curious.","","*gosub_scene utils show_fight_momentum","","*choice","    #Try your ${flurry} to overwhelm her defences.","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *set upgrade_bonus (upgrade_multiplier * flurry_level)","        *if (((adj_technique * 0.7) + (adj_power * 0.3)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.85) + (dc_hard * 0.15))","            You suddenly dash forward with your ${flurry}, a fast flurry of punches that catches Katie with her arms lowered. Several punches land with sharp impacts before she can react, not dealing serious damage but knocking her off-balance. Katie focuses on careful defence as she retreats, clearly surprised by your aggression so soon after experiencing her pressure point technique.","","            \"Excellent tactics,\" Katie beams, even as she's on the defensive. \"Most fighters hesitate after experiencing a pressure point technique, but you demonstrated unusual confidence.\"","            *set fight_momentum +2","        *else","            You suddenly dash forward with your ${flurry}, a fast flurry of punches that you hope will overwhelm Katie's defences. Unfortunately, your attack is too slow, and she easily sidesteps. As you overextend and lose your positioning, her fingers find a nerve junction at your rib cage, applying a tender pressure that causes debilitating pain to radiate through your torso.","","            \"That's your intercostal nerve cluster,\" Katie explains as you struggle to catch a breath.","            *set fight_momentum -1","    #Maintain distance and probe with cautious jabs.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *set upgrade_bonus (upgrade_multiplier * jab_level)","        *if (((adj_technique * 0.3) + (adj_mental * 0.7)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.9) + (dc_easy * 0.1))","            You theorise that Katie needs to be at close range to use her pressure point techniques. Therefore, why not keep her outside of that range? You maintain distance with well-timed jabs that control space and shut down most of her approach angles, which forces Katie to overcommit to an attack. When she lunges forward, you tag her with a clean ${jab} that sends her retreating with a subdued \"Oof.\"","","            \"Very good distance management,\" Katie commends you. \"Your spacing shows fairly developed fight awareness!\"","","            The crowd leans in to see how Katie will adjust her approach.","            *set fight_momentum +1","        *else","            You theorise that Katie needs to be at close range to use her pressure point techniques. Therefore, why not keep her outside of that range? You try to maintain distance with jabs to control space and shut down Katie's approach angles. However, Katie comes in close, sidesteps twice, and then ducks forward to slip past your misdirected guard. Before you can recover, her fingers find a nerve cluster at your shoulder as her other hand presses on your bicep. You scream in pain as your shoulder feels like it's been hyper-extended.","","            \"This is just referred pain from your shoulder nerves,\" Katie explains as your eyes involuntarily shut from the pain. \"Your brain thinks your joint is moving wrong, but it's actually in a perfectly normal position!\"","            *set fight_momentum -1","    *selectable_if (counter_level > 0) #Wait for her approach and attempt a counter.","        *gosub_scene utils calculate_trait_bonus \"empathy\"","        *set upgrade_bonus (upgrade_multiplier * counter_level)","        *if (((adj_technique * 0.7) + (adj_mental * 0.3)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.9) + (dc_hard * 0.1))","            You patiently await Katie's advance, searching for the tells that signal her approach attempts. When she finally commits to an attack, your legs have already begun to move. You sidestep her approach and deliver a ${counter} that completely stops her forward momentum with a resonant thwack. The punch lands cleanly, while her fingers are nowhere near any pressure points.","","            \"Exceptional pattern recognition,\" Katie exclaims. \"Your timing suggests innate talent in noticing movement cues!\"","","            Light applause rises from the crowd as they see you getting the better of the exchange.","            *set fight_momentum +2","        *else","            You patiently await Katie's advance, looking for the tells that signal her approach attempts. She approaches casually, her hands moving in varied patterns. While you were focused on reading her hand patterns, she circles to your left, closing the distance while you're still frozen in place. Katie's fingers find pressure points on your forearm while applying precise leverage to your wrist.","","            \"Fascinating response patterns,\" she notes as you flinch from the searing pain in your wrist. ","            *set fight_momentum -1","","*if fight_momentum <= 4","    You try to adapt to Katie's unusual fighting style, but she continues finding vulnerable pressure points with clinical precision. You manage to land the occasional punch, but your body reflexively flinches when you are near her, and your attacks don't land at full power. Katie remains talkative, a bright smile on her face as she encourages you.","","    \"Your nervous system shows remarkable resilience for a beginner,\" she observes, delighted. \"Most people are completely overwhelmed by now!\"","*elseif fight_momentum = 5","    You hold your own in the match, delivering brief but effective combinations even as Katie's finger strikes continue to land. The crowd watches with interest, some spectators standing up.","","    \"Fascinating adaptations,\" she comments after you successfully evade one of her techniques. \"Your neural pathways show high natural resistance!\"","*else","    You've managed to take the initiative in this unusual match, your jabs and basic combinations impeding Katie's attempts to achieve full pressure point contact. You're beginning to sense which areas she's targeting, a subtle warning sensation that aids your blocks. The crowd rumbles softly as you push Katie onto the defensive.","    ","    \"Extraordinary natural defences,\" Katie exclaims, her tone still friendly and buoyant. \"Your proprioception is remarkable!\"","","Katie takes a step back and flexes her fingers, the joints popping softly. Then she darts forward, aiming for pressure points at your left shoulder and neck, hands slicing in like she's tracing lines only she can see.","","*gosub_scene utils show_fight_momentum","","*choice","    #Prioritise protecting your neck, focusing on safety.","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *set upgrade_bonus (upgrade_multiplier * block_level)","        *if (((adj_toughness * 0.5) + (adj_mental * 0.5)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.7) + (dc_easy * 0.3))    ","            You hunch up, raising your guard fully and denying Katie access to exposed nerve areas. She advances with both hands striking, uncaring about defence, fingers outstretched. You feel the rush of air as she misses the nerve junction on your upper shoulder she was aiming for. Her fingers still find a pressure point on the outside of your shoulder, sending a jolt through your arm, but your guard holds, and she finds no further purchase.","            ","            \"Excellent protective instinct,\" Katie chirps.","            ","            You create some space, the pain already faded. Although you didn't land any blows, you neutralised her attack and prevented her from gaining any advantage. Katie nods and smiles brightly, though you're not sure what she's pleased about.","            *set fight_momentum +1","        *else","            You hunch up, raising your guard fully and denying Katie access to exposed nerve areas. She comes in with both hands striking, uncaring about defence, and her fingers slip easily past your gloves. One hand goes for a point on your upper shoulder that you deflect, but her other hand finds your ribcage.","","            Her warm fingers press firmly at the soft point at the bottom of your left ribcage, and it feels like your ribcage has been forcibly torn from your sternum. You scream silently, unable to breathe as your diaphragm spasms, arms immediately dropping to shield your vital organs. Her other hand holds you under your right armpit, immobilising your arms as your shoulders seize up. ","            ","            \"The intercostal nerve bundles are so fascinating,\" Katie remarks as you struggle with basic bodily functions. \"When I press here, your brain thinks your ribcage is collapsing, even though it's just a bit of pressure!\"","            ","            You manage to take a laboured breath through the pain and finally swat away her fingers with your other hand.","            *set fight_momentum -1","    #Sidestep and weave, attempting to create favourable angles.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *set upgrade_bonus (upgrade_multiplier * dodge_level)","        *if (((adj_toughness * 0.35) + (adj_technique * 0.65)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.9) + (dc_easy * 0.1))  ","            Biceps tensed, you read Katie's approach and slide to your right as she reaches for your shoulder. Her hands miss completely as you connect with a one-two combination \u2014 not at full power, as your centre of gravity is behind, but enough to cause Katie to exhale sharply with an audible \"boof!\"","","            Katie's still facing the side and you capitalise by advancing with your ${flurry}, landing several solid blows before she rolls away. \"Excellent manoeuvring,\" Katie exclaims, her voice higher-pitched than normal.","","            You smile and nod, as you're gradually finding effective strategies against her unusual techniques.","            *set fight_momentum +2","        *else","            You attempt to slide to your right as Katie reaches for your shoulder. Her right hand misses completely, finding only air. But her left hand is already changing trajectory, arriving in a wide arc to land on the nerve bundle at the top of your left shoulder.","","            Her fingers press down with force like a concert pianist. Electric pain explodes throughout your left arm, shoulder, neck, and the left side of your head, accompanied by a high-pitched ringing in your left ear. You involuntarily shut your left eye as your mouth distorts into a pained grimace, your body seizing up around your shoulder as if it was lanced by a red-hot needle.","            ","            \"It feels like your entire upper body is being torn apart because there are multiple nerve pathways,\" Katie explains. ","            ","            The pain lasts for a brief moment as Katie doesn't have the leverage to maintain the hold. When she releases the pressure point, the pain vanishes completely, and suddenly the position is reset, neither of you having the advantage.","            *set fight_momentum -1","    #Intercept her with a punch as she moves in.","        *gosub_scene utils calculate_trait_bonus \"empathy\"","        *set upgrade_bonus (upgrade_multiplier * counter_level)","        *if (((adj_power * 0.8) + (adj_technique * 0.2)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.8) + (dc_hard * 0.2))","            You cock your left arm and watch Katie's approach intently, waiting for the split second before she explodes forward. The crowd is silent, no one daring to move.","","            As Katie lunges forward, fingers extended towards your neck and shoulder, your left fist pistons forward, striking her chest like a sunlit hammer. The blow hurls her back, any thought of reaching pressure points forgotten, her mouth wide open as all the air whooshes from her lungs.","            ","            Katie wobbles, temporarily unable to breathe, hands limp by her sides. You land a cross to her face, sending her to the floor. She manages to rise by the count of 5, fighting stance regained, although her eyes track you more slowly now.","","            \"S... superb risk taking and technical execution,\" she gasps. \"Courage and judgement too!\"","","            The crowd applauds politely, several of them complimenting the brilliant tactical exchange.","            *set fight_momentum +3","        *elseif (((adj_power * 0.8) + (adj_technique * 0.2)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.8) + (dc_easy * 0.1))","            You cock your left arm and watch Katie's approach intently, waiting for the split second before she explodes forward. The crowd is silent, adding to the tension.","","            As Katie lunges forward, fingers extended towards your neck and shoulder, your left fist pistons forward, aiming to hammer her backwards. Unfortunately, accurately hitting a fast-moving target with full power is beyond your current skill. Your punch grazes her shoulder, slightly rotating her body, and you feel a fleeting pressure as her fingers briefly press the veins on your neck before they slip.","","            A brief wave of icy pain courses from your neck to your skull, but the dizziness lasts for no more than a moment before it disappears. You immediately find your bearings, but Katie has also recovered. She takes three steps back, rolling her shoulder and finding it uninjured.","        *else","            You cock your left arm and watch Katie's approach intently, waiting for the split second before she explodes forward. The crowd is silent, adding to the tension.","","            As Katie lunges forward, fingers extended towards your neck and shoulder, your left fist pistons forward, aiming to hammer her backwards. Unfortunately, accurately hitting a fast-moving target with full power is beyond your current skill. Your punch is way too slow, not even halfway there before you feel the touch of her fingers on your neck and upper shoulder.","","            Your throat feels like it's being crushed in a vice. Your collarbone seems to detach. \"AAAAAAAAH!\" you scream, tears streaming down your face as your body refuses to move.","            ","            \"Receiving pain signals from different areas overwhelms your brain,\" Katie explains with a smile, \"and it gets registered as catastrophic damage!\"","            ","            She maintains the hold for several more seconds, until your scream fades into a wordless exhale.","","            \"The human body is so amazing. Let's try another pressure point!\"","","            Katie's fingers stab into your diaphragm. Spots appear in your vision, your face red, lungs refusing to cooperate. Your knees buckle. The referee runs in to start the count, but your body recovers quickly once you get your breath back, and you stand up steadily.","            *set fight_momentum -3","","*page_break","*if fight_momentum <= 0","    *goto fight_momentum_zero","","The fight continues, a whirlwind of punches, holds, and Katie's cheerful commentary. Each exchange is a three-dimensional puzzle. Time blurs into a series of sharp pains and tactical adjustments.","","Between rounds, Katie stretches her fingers like a pianist. You sit, towel draped over your shoulders, watching her bounce in place, never fully still.","","Your muscles begin to throb with a shallow burn. Sweat soaks your T-shirt while a faint metallic taste lingers on your tongue. Katie's movements, once bewildering, now seem more familiar. When she commits to an attack, there's always a tell \u2014 a brief twist of her hips, the weight shift too quick to fake. Despite the exertion, Katie's pace never slackens, her compliments and observations freely spilling from her lips.","","*if fight_momentum > 6","    Your breath remains steady and your guard solid. Each time Katie attempts to find a pressure point, you prevent her from reaching it. Twisting your body. Angling your guard. Stepping out of the way. When she over-commits, you're ready with a quick ${jab} or short combination. Katie smile reaches her eyes as she compliments your strategy.","","    \"Your instincts are remarkable, showing a natural aptitude for spatial manipulation!\" she exclaims after you counter another failed attack with a fast hook. An opening materialises, her left hand positioned lower than usual. You step forward, your leading foot lightly stomping the ground.","*elseif fight_momentum > 4","    Your defensive awareness prevents Katie from landing significant attacks. Yet no matter what you try \u2014 one-two combinations, jabs, hooks \u2014 she evades or parries everything. Occasional shouts of encouragement ring out amidst the general background hum. \"Your instincts are impressive, showing a natural aptitude for spatial judgement!\" she exclaims after you avoid yet another attack.","","    Katie shows no signs of tiring, boundless energy apparent in her energetic footwork. As she re-positions for another attempt, you break the rhythm with a sudden attack.","*else","    Katie circles relentlessly. Her serpentine fingers pepper your guard, each touch sending a jolt that makes your gloves feel sluggish. You try to reset, but every movement opens a new nerve to be pressed. She keeps you reacting, never attacking. \"Ooh, very good!\" she calls. \"Most people leave their brachial plexus wide open.\"","","    With a brief exhale, Katie drops her arms by her sides, relaxed and unguarded. This might be your only chance. You throw yourself forward.","","*gosub_scene utils show_fight_momentum","","*choice","    #Launch a ${flurry} to overwhelm her defences.","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *set upgrade_bonus (upgrade_multiplier * flurry_level)","        *if (((adj_power * 0.5) + (adj_technique * 0.5)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.8) + (dc_hard * 0.2))","            You spring forward, unleashing your ${flurry} \u2014 a rapid flurry of distance-closing punches. You focus on punch quantity, directing them vaguely at Katie's upper body, trusting that quality will take care of itself.","","            Katie ducks under your first punch, then sidesteps the second. She jerks her head away from your hook. She opens her mouth to speak but only an exhale escapes as she twists away from another jab. Her hands fly up, but only to shield her face. Her feet shuffle backwards. With each punch, her smile tightens.","","            A clean hit to her ribcage is immediately followed by glancing blows to her head and chest. She retreats in shambles. The crowd erupts in applause, although you tire quickly and can't fully convert your advantage.","            *set fight_momentum +3","        *else","            You spring forward, unleashing your ${flurry} \u2014 a rapid flurry of distance-closing punches. You focus on punch quantity, directing them vaguely at Katie's upper body, trusting that quality will take care of itself.","","            Katie's eyes widen at your tactic. She's unable to find any pressure points through your constant movement and barrage of punches. Even her running commentary falters as she struggles to mount an effective response.","","            But you quickly begin to tire. Your punches become slower, weaker. Katie immediately closes the distance, footwork still as agile as ever, and her fingers find the nerve cluster under your right armpit. Pain shoots down your right side as she presses firmly, temporarily paralysing your right arm.","            *set fight_momentum -1","    #Attempt your ${combo} \u2014 the jab-cross-hook combination you've been drilling.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *set upgrade_bonus (upgrade_multiplier * combo_level)","        *if (((adj_mental * 0.4) + (adj_technique * 0.6)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.9) + (dc_easy * 0.1))","            You recall your coach's advice: stick to what you've practised. You launch into your ${combo}. The jab sticks Katie in place. The cross forces her to block. The hook connects with the side of her head, the pressure on your fist muffled.","","            Katie staggers from the impact of the hook, her eyes unfocused. The crowd erupts in applause, some now clapping with inflatable plastic tubes. Katie has instinctively retreated and crouched low, complicating your efforts to capitalise.","            *set fight_momentum +2","        *else","            You recall your coach's advice: stick to what you've practised. You launch into your ${combo}. The jab sticks Katie in place. The cross forces her to block. The hook hits her hasty guard, the pressure on your fist muffled.","","            Katie converts the forward momentum from your punches into an unnaturally fast crouch. She absorbs the energy into her legs and immediately stabs for a nerve cluster at your inner thigh. A jolt of frozen pain radiates from your thigh and your leg buckles involuntarily.","","            \"Boxing relies on footwork to generate power,\" Katie exclaims. \"Disrupting the nerve signals means that your foundation can't support any offence!\"","            *set fight_momentum -1","","    #Risk everything with your ${ultimate}, throwing a massive uppercut.","        *gosub_scene utils calculate_trait_bonus \"empathy\"","        *set upgrade_bonus (upgrade_multiplier * ultimate_level)","        *if (((adj_power * 0.9) + (adj_technique * 0.1)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.2) + (dc_hard * 0.8))    ","            You crouch slightly, preparing for your ${ultimate}. Katie sees your crouch and misreads it as a defensive adaptation, moving forward with elbows cocked for a fast strike. As she comes close, you rocket your entire body up in a massive uppercut.","","            The uppercut catches Katie cleanly under her chin. Her head snaps back. Her body briefly leaves the ground, a long curved line like a hunted rabbit. The crowd roars, Katie's feet wobbling before collapsing completely, out cold for the ten count.","","            Ringside medics immediately rush to Katie, checking her vitals. She regains consciousness and takes a few moments to sit, dazed but content.","            *set match_result 2","            *goto match_conclusion","        *if (((adj_power * 0.9) + (adj_technique * 0.1)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.8) + (dc_hard * 0.2))    ","            You crouch slightly, preparing for your ${ultimate}. Katie sees your crouch and moves forward with elbows by her side, ready for a counterstrike. As she nears, you rocket up in a massive uppercut.","","            Katie sees your body tense just in time to partially turn her head. Your uppercut grazes the side of her face instead of catching her cleanly on the chin. It's enough to stun her. You have enough time to reset your positioning, and keep her counter attempt away with a quick ${jab}.","        *else","            You crouch slightly and lock your knees, preparing for your ${ultimate}. Katie sees your crouch and moves forward with elbows by her side, ready for a counterstrike. As she nears, you rocket up in a massive uppercut.","","            Katie sidesteps the uppercut casually. She presses a node of nerves near your exposed armpit. Your arm feels as if it's dislocated at the shoulder.","            *set fight_momentum -2","*if fight_momentum <= 0","    *goto fight_momentum_zero","","*page_break","You recover your footing. Katie doesn't advance. Instead, she steps back slowly, blinking hard. Around you, the crowd sits up straight, like they're bracing for a storm.","","Katie's pupils dilate. She begins a bizarre wave-like [i]kata[/i], arms flapping in wide jumping-jack arcs, knees pumping high in Jazzercise bursts.","","\"Okay, pulling out the [i]big[/i] one now! [i]Total Sensory Override[/i]. Brace yourself!\" she announces.","","The crowd falls silent.","","Katie keeps shifting side to side, wrists rotating, fingers flexing. Her breath deepens into a slow, meditative rhythm. Then she suddenly starts hyperventilating. All the time, her face is plastered with a cheerful grin. Droplets of sweat appear on her forehead.","","\"Let's go!\" she smiles, charging forward, hands raised like forked lightning.","","Around you, everything vanishes into a blur. Your ears ring. There's no referee, no crowd, no warehouse. Just her hands, and whatever storm she's about to bring down.","","A final check: hips low, guard high, weight even. Every muscle ready. You didn't choose this. Your body did.","","*gosub_scene utils show_fight_momentum","","*choice","    #Defend and weather the storm.","        You plant your feet firmly, raising your guard to protect your vital areas. Katie lurches towards you like an assassin that's had one too many drinks. The crowd's collective intake of breath tells you all you need to know about what's coming.","","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *set upgrade_bonus (upgrade_multiplier * block_level)","        *if (((adj_mental * 0.5) + (adj_toughness * 0.5)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.8) + (dc_easy * 0.2))","            Katie's fingers dart towards you at oblique angles, but your complete focus on defence pays dividends. You tuck your chin fully. Your arms tighten in a very compact guard. You hunch your back to reduce your profile. Katie can't find any exposed nerves, her fingers hovering and darting ineffectually, bees unable to sting through a bear's thick skin.","","            \"Excellent decision!\" she says brightly. \"Most fighters don't prioritise nerve shielding. Too much ego.\"","","            You feel her fingers brush against you repeatedly, each near-miss raising the hairs on your skin. Her probes abruptly stop as she lets out a long breath, her pupils contracting to their normal size. The crowd exhales, the [i]Total Sensory Override[/i] defused, the oppressive tension lifted from the room.","        *else","            You tuck your chin fully. Your arms tighten in a very compact guard. You hunch your back to reduce your profile. But it's not enough. Katie is too fast, striking like lightning from all directions, your turtle defence allowing her to focus entirely on offence.","","            *goto total_sensory_override","    #Time a desperate counter-attack.","        Your attention locks onto Katie's movement patterns. You wait for the split-second commitment: your one chance. Suddenly, you notice subtle tells in Katie's posture \u2014 the slight tension in her shoulders, the minute adjustment of her fingers, the shift in her breathing pattern. ","","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *set upgrade_bonus (upgrade_multiplier * ultimate_level)","        *if (((adj_mental * 0.6) + (adj_technique * 0.4)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.4) + (dc_hard * 0.6))","            Katie shifts her weight, a tell in her right heel. There. The base of your neck. Her hands lunge for the nerve cluster.","","            You launch forward, colliding with her like a desperate battering ram. Your ${ultimate} connects with Katie's chin with a thud that vibrates through your arm. Her head snaps back, eyes unfocused, as she crumples to the floor, out cold.","            ","            The crowd erupts as the referee reaches ten. Katie comes to, blinking rapidly, her hands patting the canvas. She tilts her head, gazing at a spot on the floor, her mouth slowly opening and closing twice. After a few seconds, she brightens and stands up slowly.","","            \"Wow! That was an AMAZING uppercut! I didn't see it coming at all!\"","","            Looks like Katie's fine.","","            *set match_result 2","            *page_break","            *goto match_conclusion","","        *elseif (((adj_mental * 0.6) + (adj_technique * 0.4)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.9) + (dc_hard * 0.1))","            You inhale sharply, your weight shifting to your back foot as Katie charges. You spring forward, fist cutting through the air. But her body twists impossibly fast. Your punch grazes her shoulder, disrupting her technique but not stopping it completely. Her fingers find your extended forearm, sparking a pulse of disorienting pain.","            ","            \"Excellent counter-timing,\" Katie notes.","            ","            You weave to the side. Katie's breathing is normal now, her movements calmer. You've weathered the worst of it.","            *set fight_momentum -1","        *else","            You commit to a desperate counter-attack, launching forward just as Katie begins her approach. It's a critical miscalculation \u2014 she was anticipating exactly this response, her stance already adjusted to exploit your momentum. As you extend for your strike, Katie pivots to your side.","","            *goto total_sensory_override","    #Dodge and create distance.","        Rather than engaging directly, you commit to evasion. Your legs tense as Katie approaches. Every instinct screams at you to avoid direct contact at all costs. The crowd goes silent. Even the crunch of snacks stops mid-chew. Nothing remains but the soft squeak of your shoes against the canvas.","        ","        *gosub_scene utils calculate_trait_bonus \"empathy\"","        *set upgrade_bonus (upgrade_multiplier * dodge_level)","        *if (((adj_mental * 0.5) + (adj_toughness * 0.5)) + (trait_bonus_applied + upgrade_bonus)) >= (dc_medium)","            You spring backwards. Your body responds with the muscle memory of countless drills. Katie's fingers miss their targets completely. Katie's momentum carries her forward into empty space, her carefully prepared technique finding no purchase. You circle rapidly, staying just beyond her reach, until her movements slow.","            ","            Katie's breathing returns to normal, the intensity of her failed technique ebbing away. Her stance has calcified, creating an opening you immediately recognise. You press the advantage with a ${flurry}, each punch landing with a satisfying thud as you finally score cleanly.","            *set fight_momentum +2","        *else","            You attempt to create distance, but Katie seems to have anticipated this response perfectly. As you step backwards, she adjusts her angle with fluid grace, her path intercepting yours.","            ","            *goto total_sensory_override","*page_break","","*if fight_momentum >= 5","    The referee's whistle cuts through the air, sharp and final. Three rounds, supposedly. It felt like one long blur. You lower your guard cautiously. Katie straightens her posture, rolling her shoulders with a satisfied smile.","","    \"So fun!\" Katie exclaims. \"You compensated for nerve interference while maintaining strategic control. That's [i]really[/i] rare!\"","","    The judges tally their scores quickly. You and Katie step to the centre as the referee raises his hand.","","    \"Winner by unanimous decision: ${first_name} ${last_name}!\"","    *set match_result 2","*else","    The referee's whistle cuts through the air, sharp and final. Three rounds, supposedly. It felt like one long blur. You lower your guard cautiously. Katie straightens her posture, letting out a contented sigh.","","    \"So fun!\" Katie exclaims. \"You compensated for nerve interference while maintaining strategic control. That's [i]really[/i] rare!\"","","    The judges tally their scores quickly. You and Katie step to the centre as the referee raises his hand.","","    \"Winner by unanimous decision: Katie Reynolds!\"","    *set match_result 1","*page_break","*goto match_conclusion","*return","","*label total_sensory_override","Katie methodically strikes points all over your body. Blood pounds your ears. Your jaw seizes open. Your ribs separate. Your joints surrender one by one, torn apart by invisible hands.  Every nerve ignites. Your muscles lock up. You can't tell where one agony ends and another begins. Your eyes stay open, but all you see is crimson.","","\"The Total Sensory Override creates a complete neural hijacking!\" You think Katie says something like that. It's hard to tell over the screams coming from somewhere nearby.","","You try to raise your guard. Your arms refuse. Your knees buckle. You collapse, palms smacking the canvas.","","\"Your brain is receiving signals from every major nerve centre simultaneously! The central nervous system doesn't know what to do, so it just tries anything at all,\" Katie continues. She stands over your twitching body, eyes bright, jotting down notes on the scratchpad she's conjured from somewhere.","","Through the symphony of pain, the referee's count hits you like a tiny headache. \"...seven...eight...\"","","Your arms scream as your force yourself to your knees. Katie leans forward, head tilted slightly like a parrot, as she observes you and scribbles something in her scratchpad. Her eyes stay fixed on you, taking in every micro-reaction like a scientist running a revolutionary experiment.","","\"...nine...ten!\" The referee waves his arms. \"Winner by knockout \u2014 Katie Reynolds!\"","","You straighten slowly as the pain recedes. You rotate your wrist, bend your elbow, roll your shoulder. All functioning normally again.","","*page_break","*set match_result 1","*goto match_conclusion","*return","","*label fight_momentum_zero","The constant cascade of pain wears on you, and your guard can't stay up. Just for a second, but it's long enough.","","Katie darts inside your guard. Fingers press in on the nerve along your right arm. More fire shoots from elbow to wrist; your arm gives up, drops completely, weighs a hundred pounds.","","Katie cradles the back of your neck with her left hand, then presses on a point near the vertebra. No pain this time. But your balance breaks. Your knees buckle. You lurch sideways. The world's low and diagonal, now.","","\"Wait, hang on!\" Katie calls, staying away rather than pressing the attack. \"You just need a second to re-sync. Just breathe!\"","","You're breathing's fine. You just don't feel like you control anything in your body.","","\"Five... six... seven...\"","","Left is right. Up is sideways. You try to get up, but your feet just flail in the air. The canvas is cool against your drenched skin.","","\"Nine... ten!\"","*page_break","*set match_result 1","*goto match_conclusion","*return","","*label match_conclusion","*if match_result = 1","    Your face is wet from tears you don't remember shedding. The noise of the crowd returns, now comprising excited chatter and scattered applause. You continue checking: feet, knees, hips, shoulders, neck. Eyesight. Hearing. All normal, except for the blood seeping from a small tear in your mouth. You stand up without ceremony.","","    Katie's eyes dart from your legs to your hands to your face, then away.","","    \"That... might have been too much,\" she stammers. \"I was too \u2014\" She exhales sharply. \"No, I shouldn't make excuses. I got carried away.\"","","    She shoves her scratchpad back into her waistband. \"Forget the data. Are you okay?\"","","    She stares at the floor, presses a foil packet into your glove.","","    \"Chew, don't swallow,\" she adds, managing a half-smile. \"It'll help flush the residual spikes. Works best if you hydrate soon, too.\"","","    She lingers, biting her lip, eyes staring at you slightly too long before she looks away.","","    \"You know...\" she starts, then trails off. She brushes her ponytail, wipes a hand over her headband. \"I can show you how to build resistance. How to process pain. The university lab's quiet on weekends.\" Slips you a name card.","","    She's walking towards the officials, but she glances back one last time.","","    \"Text me if your visions goes blurry or your limbs spasm,\" she calls out. \"Although that usually fades in, like, twelve hours tops.\"","","    Then she's gone, all ponytail and kinetic energy.","    *set record_losses +1","*elseif match_result = 2","    Katie straightens unsteadily. She's grinning from ear to ear. A bruise is forming along her jaw, but she sways happily, like a sunflower.","","    \"Wow!\" she exclaims, eyes wide. \"You're an amazing fighter! You instinctively knew what to do. And that proprioceptive awareness! Do you know how rare this is?\"","","    She bounds over to her gym bag and pulls out a crumpled flyer. \"Okay, listen. This might sound weird, but I [i]need[/i] you to come to my lab. I'm running a research study on high-resilience fighters and your pain adaptation is [i]off the charts[/i].\" She pauses for breath, then rushes out more words. \"I made some notes during our fight but if you came in \u2014 look, just trust me, you'll love it.\"","","    Katie presses the flyer into your hand, vibrating with excitement. \"PAIN: IT'S ALL IN THE MIND\" in Comic Sans, anatomical sketches, tiny footnotes, and a glittering unicorn sticker in the corner.","","    \"No obligation.\" More words tumble out. \"Except, you know, you would really benefit too, because I can help you increase your pain thresholds. My academic thesis is on this stuff!\"","","    Her monologue skids to a halt. Her eyes fall to the floor. \"You're still here, listening to me.\"","","    Her eyes meet yours, bright but uncertain. \"Thanks for taking me seriously.\"","","    She smiles, small at first, then changes to a broad grin. \"Anyway! See you soon! Bring snacks if you can. The lab vending machine only has vaguely threatening energy drinks.\"","","    Then she's gone, all ponytail and kinetic energy.","    *set record_wins +1","*else","    *bug Unknown match result","*return"], "labels":{"fight":0,"total_sensory_override":425,"fight_momentum_zero":447,"match_conclusion":468}},
"katie_subplot": {"crc":-1317801237, "lines":["*label scene_introduction","*if katie_subplot_scene = 1","    Katie didn't fight with raw power or speed; she applied precise techniques to create debilitating pain. She's invited you to her lab with the promise of helping you control your subjective experience of pain. Her systematic understanding of the nervous system could be useful during fights, although you're unsure what form her instruction will take. You palm your elbow, remembering the control she demonstrated.","*elseif katie_subplot_scene = 2","    Katie mentioned she would teach you a set of exercises designed to stop your nervous system from \"overreacting.\" This time she's bringing tools that she crafted herself. She didn't elaborate. Nobody else is doing what she's doing, she said, which doesn't surprise you. More surprising is the way your body seems eager to continue.","*elseif katie_subplot_scene = 3","    \"I want to practise being around normal people. Can you help me?\" she writes. Katie's message \u2014 unfiltered, almost plaintive \u2014 matches what you've seen during your sessions together. It might be an unstructured chat, or a meticulously planned interaction. She didn't offer to teach you anything. That means something.","*elseif katie_subplot_scene = 4","    *if katie_plot_timer = 0","        Katie's last message: the university is pushing back on her research. She's facing yet another review, and she's worried they will keep her in limbo indefinitely. The pressure has built to a point where the cracks are showing. You're not sure how it resolves.","    *else","        Katie hasn't replied to your messages. The last one she sent was a voice message at 2:56 AM. Lab noise, rustling, a stack of books toppling. Then her whisper: \"Some issues with my research. University committee... questions about ethics. Will explain later. Don't come by.\"","        *if highest_trait = \"analysis\"","            You check the audio metadata. Sent from her campus lab Wi-Fi, 0.2MB compressed, no edits. She didn't rehearse this one.","        *elseif highest_trait = \"empathy\"","            You replay the memo. A tension, even panic, is creeping in at the edges. She's clinging to her systems, even as they fail.","        *elseif highest_trait = \"composure\"","            You don't follow up again. If she needs help, she'll ask.","        *else","            *bug Invalid highest_trait","*elseif katie_subplot_scene = 5","    [TODO]","*elseif katie_subplot_scene = 6","    [TODO]","*else","    *bug Katie subplot scene not found","*return","","*comment katie_friendship from katie_fight: 0-1","*label scene_choice","*if katie_subplot_scene = 1","    *comment earliest: chapter 3, first fortnight","    *comment katie_friendship from this chapter: 2-3 for accept, 0-1 for reject","    *comment cumulative katie_friendship after this chapter: 3-4","    *gosub event_1","    *set stat_mental %+2","    *set unlocked_katie_training True","*elseif katie_subplot_scene = 2","    *comment earliest: chapter 3, second fortnight","    *comment katie_friendship from this chapter: 1-2","    *comment cumulative katie_friendship after this chapter: 4-6","    *gosub event_2","    *set boxing_insights +1","*elseif katie_subplot_scene = 3","    *comment earliest: chapter 4, first fortnight","    *comment katie_friendship from this chapter: 1-4","    *comment cumulative katie_friendship after this chapter: 5-10","    *gosub event_3","    *set stat_mental %+4","    *set stat_energy +5","    *set katie_plot_timer 2","*elseif katie_subplot_scene = 4","    *comment earliest: chapter 5, first fortnight","    *gosub event_4","    *set stat_mental %+5","    *set katie_plot_timer 2","*elseif katie_subplot_scene = 5","    *comment earliest: chapter 6, first fortnight","    *gosub event_5","*elseif katie_subplot_scene = 6","    *gosub event_7","    *set katie_subplot_status \"finished\"","*else","    *bug Katie subplot scene not found","*return","","*label event_1","The kinesiology wing is mostly dark. There's a sharp wedge of light spilling from the gap under the door at the corridor's end. You proceed with deliberate quiet, not wanting to cleave the silence. A brushed metal nameplate next to the door announces in Times New Roman:","","LAB 3B-19","*line_break","\u61c9\u7528\u808c\u52d5\u5b78","*line_break","Applied Kinesiology","","You flex your elbow. No pain. You try your wrists, shoulders, waist, knees, ankles, cataloguing the responses. All fine. No memory in the joints; just in the nerves.","","You knock.","","From inside, the sound of a falling stack of paper, then a voice. \"You're early! Or on time! Hold on!\"","","The door swings inward, a little too fast. A small vacuum tugs at your shirt, pulling you into bright light. ","","*page_break","Anatomy charts. Plastic joint models. Nerve diagrams. A skeleton in the corner wearing a party hat and a laminated name tag: SKELETOR - TEACHING ASSISTANT. A desk piled high with papers and folders.","","Skeletor grins at you. So does Katie.","","She's wearing bright teal leggings \u2014 no leg warmers today \u2014 and a T-shirt that says \"PAIN: IT'S ALL IN THE MIND.\" Near the hem, a tiny print-on-demand logo. She heaves a duffel bag onto the lab table. It lands with a thud and several quiet clacks. Doesn't sound like any gym gear you know of.","","\"Hi! You came!\" she beams. \"That's rare. Usually people never show up.\"","","*choice","    #You nod. Better to see the full picture before deciding how to handle this.","        *gosub_scene utils increase_composure","        She greeted you too lightly, like someone afraid to be real. You nod, steady and brief. See how things develop before committing to a position.","    #That didn't sound like someone trying to be funny.","        *gosub_scene utils increase_empathy","        She says it like a joke, but there's no lightness in her voice, no twinkle in her eyes. Just something to fill the silence.","","        You nod, just the smallest movement. More is unnecessary.","    #Consider the subtext in the words.","        *gosub_scene utils increase_analysis","        She says it too fast, like a rehearsed line. Bright voice, nothing in her eyes. Mismatch. Too casual to be an offhand remark.","","        You nod. More data needed.","","Katie registers your slight nod. Swallows. One hand tugs at her ponytail, fingers circling the elastic again and again.","","\"Okay. You're steady. That's good.\" She claps once, the smack unnaturally loud in the heavy air of the lab. \"Let's get to it then.\"","","She points to a padded exam table at waist height in the centre of the room. The pleather upholstery is cracked in places, mended with a patchwork of clear, duck, and metallic tape. \"Lie down here,\" she says. Katie rummages through her duffel bag and extracts a short wooden rod that looks like a dowel or pestle.","","\"We'll establish your baseline response to stimulus before we start the real work,\" she says, then adds with bright formality, \"${first_name} ${last_name}.\"","","\"Most people think all nerves respond the same way. But that's too simplified.\" Her smile returns. \"Your body already knows this. Your brain just hasn't had the conversation yet.\" She gestures you towards the exam table.","","*if highest_trait = \"analysis\"","    \"So the response isn't standardised. It's individualised mapping.\"","","    \"Exactly. Every signal is a conversation. But the script? Always unique.\" She smiles at you, like you're both sharing a secret. \"And I get to listen in.\"","","*elseif highest_trait = \"composure\"","    \"All right. Just tell me where you want the arm.\"","","    \"You make a good subject,\" she says, quieter now. \"Steady and controlled. That helps more than most people realise.\"","","*elseif highest_trait = \"empathy\"","    \"That line sounds practised.\"","","    Her expression falters. Then she shrugs, casual again. \"Yeah. Most people don't notice.\" A pause. \"Or they pretend not to.\"","","    She doesn't elaborate. You don't push. But the tone lingers, the way these things do.","","*else","    *bug Invalid trait","","You ease onto the table, leather crinkling beneath your weight. Katie holds the wooden dowel in her hand like a conductor's baton. It appears hand-carved, with dark notches and chipped edges, and one end is suspiciously pointed. She smiles at you, her intensity softening into something almost tender.","","\"Okay,\" she says gently, almost like she's reassuring herself. \"Just above the elbow, first.\"","","You don't feel it right away. Then the nerve fires. A clean, precise pain. Some part of you watches your hand twitch. It doesn't feel connected.","","*choice","    #You stay still. Let it pass.","        *gosub_scene utils increase_composure","        The pain crests, then vanishes. No lingering, no echo. You don't even need to breathe deep. Nothing needs adjusting.","    #You focus on her technique instead of the pain.","        *gosub_scene utils increase_analysis","        She didn't just jab your elbow randomly. Her eyes tracked the joint line, first your wrist, then your elbow. The notches on the rod are for calibration. This isn't for her amusement. It's a study. You're the data point.","    #You track her face instead of the pain.","        *gosub_scene utils increase_empathy","        The pain cuts clean and then fades. You don't flinch. Because you're watching her.","","        Her smile holds, but something flickers behind it. You don't say anything. You're not the one who needs the check-in.","","Your hand relaxes again. Nothing's broken. Katie doesn't stop; she rotates your wrist gently, presses a spot below the elbow, and nods to herself.","","\"Okay, here is where it gets interesting,\" she says. \"You can change how you receive pain signals. Right now, when they activate, your nerves send a flood of pain signals to your brain, and their arrival overrides everything else. That's why you freeze up and scream.\" ","","She talks faster. \"This time when I press, don't think about the pain. Look into my eyes. It creates an alternative focus for your brain, providing a large amount of neural distraction. Most of the time.\"","","Katie takes a deep breath, sucking in air through her teeth. \"Okay, okay. Eye contact, then pressure. Keep the gaze.\" Then she makes eye contact with you, pupils dilated. When she has your gaze, she presses the dowel into the spot below your elbow again.","","A dull throb, still present, but not insistent.","","The wooden rod withdraws. The pain fades. Katie looks away, scanning your elbow, the veins on your neck, your autonomic responses.","","*if highest_trait = \"analysis\"","    You process her words. Pain as a signal, not as a fact. It makes sense, even though it's counter-intuitive. To do later: apply this to other assumptions.","*elseif highest_trait = \"composure\"","    You replay the two nerve patterns. Identical. But only one felt like a threat.","*elseif highest_trait = \"empathy\"","    You felt her intense concentration, how she steadied herself before proceeding. She [i]needs[/i] to do this right.","*else","    *bug Invalid trait","","\"Good attenuation.\" She hands you the rod, pointing at her own elbow. \"With practice, you can redirect a lot of your attention. Here, press like I did and watch my reaction.\" She looks at you for a second, then closes her eyes.","","*choice","    #You match her technique exactly. Watch for response patterns.","        *gosub_scene utils increase_analysis","        You press at the crook of her elbow, mirroring her earlier grip and angle. Her skin is warm. The resistance is subtle, the nerves seeming to yield and compress before the rod's pressure point.","","        Her body shifts slightly. No tension. Just a soft exhale through her nose. The tiniest dilation of her pupils. Then her relaxed smile returns.","","        You mentally log her responses. No vocalisation. No reflexive withdrawal. Only barely detectable autonomic hints that she felt anything at all.","    #You study her face as much as her response.","        *gosub_scene utils increase_empathy","        You press gently into the crook of her elbow, mindful of pressure and pace. Her skin warms beneath your grip, but you're not tracking muscle or nerve.","","        You're watching how she carries the sensation. The stillness she builds around it.","","        When she exhales, it's quiet, measured. It's not control. Trust, maybe. Or habit.","","        You ease off just before she gestures.","    #You follow her instructions with care.","        *gosub_scene utils increase_composure","        You press at the crook of her elbow, just like she showed you. No sudden motion. Just clean, steady pressure.","","        Katie exhales through her nose. No tension. Her pupils dilate slightly, like she's forgetting something she just saw. Her shoulders stay level. A modest smile reappears.","","        \"Good pacing,\" she says softly. \"Most people rush.\"","","        You nod. You see it now. Pain received, not resisted.","","After a few more exercises, Katie's animated chatter returns. \"Okay, that's a good baseline! Your proprioceptive feedback is surprisingly consistent. I think that's all for today, let me just make sure I didn't forget anything.\"","","She scoots over to the desk and rifles through the untidy stack of papers. As she's shuffling papers like a jittery mail sorter, you notice a manuscript float to the top, thicker than the others. \"REJECTED\" is stamped on the front, obscuring the title. Katie sees it too, and snatches it, sliding it to the bottom of the paper pile. She glances back, notices you watching, and her shoulders sag. But she doesn't say anything.","","*choice","    #You step back so she doesn't have to explain.","        *gosub_scene utils increase_empathy","        *set katie_friendship +1","        The rejection must mean a lot to her. But she's not ready to open up. You tidy up the wooden dowels, arranging them into a loose xylophone shape.","    #You stay quiet. Not the right moment to press.","        *gosub_scene utils increase_composure","        *set katie_friendship +1","        You want to say something, but you hold your tongue. Pushing now would drive her away. So you let her recover at her own pace.","    #You think about what it means.","        *gosub_scene utils increase_analysis","        She shoved the paper into the pile like it was an unwanted flashback. Not upset or angry, primarily. Embarrassment?","","        You make a mental note. No intervention needed at the moment.","","Suddenly, Katie's smile reappears, too fast and too wide. \"Okay! First session complete!\" she chirps, wrenching the cap on a jar of green ointment tight. \"I'll email you some exercises you can do in the meantime.\"","","She hands you a squeeze ball with metal studs embedded in its surface like tiny teeth. \"For homework. Press it until it stings. Try not to flinch.\" Her smile is back, wide and bright, but her hand keeps squeezing the handle of her duffel bag, tightening, loosening, tightening again. The plastic handle creaks faintly. ","","You nod and pocket the ball. ","","\"Thanks for showing up, by the way. Most people...\" She trails off. Like a lab rat that's given up on the maze. \"Anyway. Same time next week?\"","","*choice","    #\"Same time next week.\"","        *set katie_friendship +2","        \"Same time next week,\" you say.","","        Katie blinks once, surprised. Her hand eases off the duffel handle. \"Okay. Cool. Yes. That works.\"","","        She glances at the squeeze ball in your hand. \"Make a note of your reactions if you can. Words, sensations, anything weird. Doesn't have to be formal.\"","","        As she opens the door, her voice drops, quieter than you've ever heard it. \"Glad you came. I mean that.\"","","    #\"I don't think I'll come back.\"","        *set katie_subplot_status \"rejected\"","        You give a small shake of your head. \"Probably not. But thanks for today.\"","","        The smile stays, but the rest of her face doesn't bother pretending. \"Ah. Got it. Yeah, no problem.\"","","        \"Still,\" she says, trying for brightness. \"Got some good data. Thanks for that.\"","","        She opens the lab door, then steps back. Doesn't follow you out.","","        As you leave, you glance back. She's still by the door, watching the hallway like she missed her cue and won't get another.","","*return","","*label event_2","","The fluorescent tubes on the ceiling flicker behind their yellow plastic coverings. The air conditioner hums steadily overhead, circulating recycled air that's neither cool nor warm. Katie's already in the space \u2014 a function room in the podium clubhouse of a private housing estate \u2014 kneeling by a row of tape measures on the carpet. Sensor cables snake out from her duffel bag. She works quickly, arranging the tape measures in geometrical patterns. Doesn't look up when you enter.","","When she does, the smile arrives too fast, like she had rehearsed it in front of a mirror.","","\"You came, ${first_name}! That's cool. I wasn't sure if I confirmed the time properly. I always forget that step. Anyway, you're here!\"","","She bombards you with a breathless explanation \u2014 how she's not a resident here, but their website uses an old reservation portal, so she logged in as admin, she doesn't remember how, clicked the wrong thing and got in, now it technically isn't listed, which means no one should be here, and then she talked to the maintenance guy about muscle fatigue recovery until he surrendered the door key.","","It keeps going. Then she cuts off mid-sentence.","","\"Sorry. That was a lot. I'm trying to talk more... normally. But it's fine, right? You don't mind the space?\"","","*choice","    #You note the skipped beats, the script-like cadence.","        *gosub_scene utils increase_analysis","        You catalogue her behavioural patterns \u2014 disjointed speech rhythms, excessive technical detail, minimal eye contact. It's like watching a computer programme that runs through its entire algorithm regardless of user response. This isn't social anxiety; it's a fundamental gap in implicit learning.","    #You've seen this before. People who get told they're too much, too often.","        *gosub_scene utils increase_empathy","        You sense what's beneath: someone who's been told they're \"too much\" too many times. The way she cuts herself off mid-explanation, the practised smile that doesn't reach her eyes. She's flinching before the blow lands, a reflex from too many conversations cut short.","    #You keep still. No need to steer the conversation.","        *gosub_scene utils increase_composure","        You nod once, keeping your expression neutral. Some conversations benefit from stillness more than engagement. Let her find her own rhythm without the pressure of dealing with a response.","","Katie hands you a folded white towel, then a metallic object sealed in clear plastic. The device gleams through the wrapping, like an aggressively hostile TV remote control, all angles and protrusions.","","\"So the compression joints adapt to your nerve signals,\" she begins, words tumbling over each other in her excitement. \"The micro-dampeners automatically adjust to how your muscles normally behave, and the torque system filters out random movements so we only measure real responses.\"","","Her hands gesture animatedly as she continues. Circuitry specifications, material composition, electrical pathways. The technical terms flow uninterrupted, and she's three sentences into electrode sensitivity thresholds before she notices your expression.","","\"Oh.\" Her monologue skids to a halt. \"I was being too technical again. I do that.\" Her shoulders drop slightly. \"I just assume people...\" The sentence dies as she evaporates it with a flutter of her fingers. \"Never mind.\"","","Only afterwards do you realise the sentence wasn't meant for you. It was reflex. Deployed, then withdrawn, like muscle memory.","","She peels the backing off a sensor patch, the adhesive producing a reluctant tearing sound. She holds the patch delicately in her hand and looks up at you.","","\"You can ask stuff, by the way. Some people like to know what the equipment's doing.\" A tentative pause. \"Some people don't.\"","","*choice","    #You wonder how many times she's had to recalibrate like this.","        *gosub_scene utils increase_analysis","        You hear the performance in her words. Cadence too exact, tone too careful. This isn't spontaneous; it's a script she's rehearsed. The way she recalibrates mid-explanation is the algorithm working: detect confusion, apologise, offer clarification, restart the script. You wonder how many times she's run this sequence, how many blank stares or impatient sighs it took to create this defensive routine.","    #You make it clear she hasn't lost you.","        *gosub_scene utils increase_empathy","        \"I'm following,\" you say, keeping your voice even. \"The compression joints sound interesting.\" It's a small lifeline, just enough to show her you haven't checked out or been overwhelmed by her enthusiasm.","","        She blinks twice, rapid and surprised, before her gaze meets yours without darting away. \"Really?\" A half-smile forms, not the practised one from before, but something uncertain.","    #You hold steady and wait.","        *gosub_scene utils increase_composure","        The silence settles between you like a teetering stack of wooden blocks. Katie's hand is still wrapped around the sensor patch, her eyes trying to read your non-reaction. The quiet stretches just long enough for the hum of the air conditioner to become noticeable again. You let the moment rest without rushing to fill it, allowing her to find her footing without the pressure of an immediate response.","","Katie starts explaining again, but this time she watches your face between sentences. Like she's adjusting in real time, not just replaying a stored script.","","Three exercises with the wooden rods from last time, each one targeting different nerve groups. Gentle pressure to familiarise the nerves with discomfort without triggering a panic response. Then reinforcement and conditioning. She explains the exercises are based on judo principles. \"Not published. Yet.\" The pride in her voice is unmistakable.","","Each time you complete an exercise set, she scans the sensors and makes small adjustments to how you hold the wooden dowels, her eyes moving between your reactions and the digital readout on her tablet.","","*choice","    #You watch how she tracks the feedback and modifies the pressure points in real time.","        *gosub_scene utils increase_analysis","        You track her process like it's a system to decode. She catalogues your micro-expressions. Cross-references them with the sensor data. Precise corrections. Her eyes dart from tablet to pressure point to your face in a consistent sequence, following the cause and effect.","","        You see now that the erratic nature of her social behaviour disappears during this technical work. Her movements are efficient, her decision-making rapid and confident.","    #You notice how she studies your face after each tweak, looking for signs of discomfort.","        *gosub_scene utils increase_empathy","        Her gaze lingers after each tweak, scanning for discomfort \u2014 the tightening around your eyes, a small clench in your jaw when you swallow, cheeks tensing slightly. It's not purely data collection. There's a gentleness in how she eases pressure even before you react.","","        It's strange. She seems so disconnected from others usually, but now she's hyper-aware of your smallest reactions. \"This one might sting,\" she says, but her voice is soft. You realise she's mirroring your careful attention.","    #You hold still through the exercises, steady enough for her to calibrate by feel.","        *gosub_scene utils increase_composure","        You stay perfectly still, your breathing steady, even when the pressure hits your nerve clusters. You've learned from Katie that flinching and movement only amplify the nerve sensations. She pauses mid-adjustment. \"Most people twitch. You've learned to control your response in a really short time.\"","","        \"Makes the readings much cleaner, too.\" The air conditioner cycles off, leaving the room in silence broken only by the soft tap of her fingertips on the tablet screen.","","Katie retrieves what looks like a tuning fork from her duffel bag. It's wrapped in layers of electrical tape, and a small plastic handle adorns the base. A copper wire extends from the stem, leading to a battery pack.","","\"This prototype is different from the other tools. It doesn't suppress pain, it modulates it. No one has ever made something like this before.\"","","She flicks a tiny switch. You feel a vibration like standing too close to a subwoofer. It's not sound, but your skin registers the pulse, and your muscles flinch like they're bracing for impact.","","\"This delivers targeted micro-vibrations at specific frequencies. That can scramble or dampen nerve signals, rather like jamming a radio channel,\" she continues, staring with barely contained excitement at the prongs. \"The fork's not electrical. That's what makes it safer. It's closer to a haptic illusion. Like what they use in neural rehab for phantom limb pain, just tuned more aggressively. If the brain gets a corrupted signal from a nerve, it either downplays it or reroutes it. This fork introduces just enough distortion to confuse the interpretation.\"","","Katie kneels beside you, bringing the device closer to your forearm. Her knuckles are white against the plastic handle. \"I ran calibration last night,\" she says too quickly. \"So it should be fine.\" Her eyes don't leave your arm. Her movements are precise and deliberate, but her fingers hover for a few moments above your skin. She takes a breath to steady herself.","","She touches the fork to your forearm.","","*page_break","There's no pain. Not yet.","","Just a hum that vibrates in your bones. Not sound. Not even pressure. Something stranger.","","Your muscles flinch involuntarily, like reacting to a sound that never arrived. Then the dislocation hits. Your arm is still there, but it's no longer yours.","","Katie leans in, looking up at your eyes. Her breathing has quickened, shallow and irregular. She watches your face like it might tell her if this was a mistake.","","\"Did that feel okay?\" Her voice cracks on the last syllable.","","This isn't the tone she used with sensor readouts. It's not a diagnostic check. A trust test, disguised as care.","","Then, words tumbling: \"It's a lot to take in at once. Like, your arm doesn't feel like it belongs to you any more, and it's not pain, but... Sorry. It's not... I'm not trying to monologue at you.\"","","She rises and steps back half a step, gaze downcast, the fork detaching from your arm. She swallows, then looks up at your face. \"I can make more. Custom ones. If you want. Only if you want.\"","","The tone's shifted. Her voice isn't tracking the data any more. Just your face. Her eyes slide away, then return. Like someone approaching a dog that might bite them.","","\"You're... patient. You don't just... shut down when I talk.\" She braces.","","\"Would it be weird if I asked you for help, ${first_name}? Help with just... being normal?\"","","*choice","    #You recognise the courage it took for her to ask.","        *gosub_scene utils increase_empathy","        *set katie_friendship +2","        The shift is subtle but clear \u2014 the science drops out, and something raw takes its place. Her eyes flick away, then back, like she's already regretting the ask.","","        You speak quietly. \"That took guts to ask. And no, it's not weird.\"","","        She's been judged before. You've seen the pattern. Too much, too fast, and people smile, then vanish.","","        \"I'm not great at this either,\" you admit. \"But if you want... we can figure it out together.\"","    #You keep your expression neutral, your voice even.","        *gosub_scene utils increase_composure","        *set katie_friendship +1","        This could spiral if mishandled. Her posture's already defensive, preparing for rejection.  You maintain steady eye contact, neither leaning in nor away, keeping your voice even.","","        \"There's nothing weird about wanting help with social interactions. But I'm not an expert. Just someone who stays grounded.\" You don't accept. Not immediately. \"Let me think about how I might be helpful.\"","    #You catalogue this as a pivot point in your interactions with Katie.","        *gosub_scene utils increase_analysis","        *set katie_friendship +2","        Her request isn't surprising; you've been tracking the pattern. In technical domains, her fluency is high. In social ones, it drops. Now she's applying systems logic to human behaviour: isolate a skill, locate a model, extract replicable patterns. You understand her approach.","","        \"I could provide structured feedback,\" you say. \"But first I'd need to define what 'normal' means in your context. What's normal varies according to the situation.\"","","Katie nods once.  A smile tries to break through \u2014 hopeful, but it collapses under its own weight. She settles for a slight crease at the corner of her eyes. Her hands move easily now, like she's playing [i]Bishi Bashi Champ[/i], clearing cables, snapping lids shut, collecting sensors with rapid-fire precision. Neither of you rushes to fill the quiet. Somewhere nearby, water glugs through old pipes, slow and indifferent.","","\"Thanks for showing up today,\" she says, not looking at you as she crams the gear into her duffel bag. The zip catches halfway and stays there.","","Your forearm still hums from the fork. Not pain, just a lingering echo, like your nerves haven't agreed on what version of events to report. Movement feels different, like the controls were only just handed back to you. Something remains. A residue. A signal waiting for a system to absorb it.","","Katie opens the door and lets you out first. The hallway's fluorescent lights buzz, steady as ever. \"I'll send you a link,\" she says as you leave, \"for scheduling. And notes.\"","","You nod. The door closes behind you. ","","The hum in your forearm follows you home.","","[i]Insight settles in your arm. Not pain, not memory. Just possibility.[/i]","*return","","*label event_3","The HKU canteen is a long, brightly lit hall, all polished laminate, fake plants, and the low ambient clatter of trays and chopsticks under ceiling lights that never quite shut up. Pillar-mounted flatscreens quietly loop campus announcements while students sit scattered in ones and twos on hard corporate plastic chairs at rectangular wooden tables. The lunch rush has subsided, leaving a few half-finished trays and the lingering scent of baked tomato pork chop rice and lukewarm soup. You spot Katie near the far end, seated beneath one of the big, grid-patterned windows, where natural light pools faintly but can't quite warm the institutional atmosphere. Visible but protected, like someone who wants to participate without committing. Calculated.","","Neat ponytail, navy windbreaker unzipped over a white T-shirt with \"Bonjour Tristesse\" emblazoned on the front, dark bootcut jeans, spotless canvas trainers, and black crossbody bag placed carefully beside her. Each item reads as ordinary. But together, they register as... deliberate. Too much signal, not enough noise.","","Her posture betrays more. Spine rigidly erect, perpendicular to the seat, shoulders squared like she's presenting to an academic panel. Both hands rest on the table, fingers interlaced, a laminated card half-visible beneath them.","","Her tray remains untouched. Steamed rice flanked by two thick slabs of chicken thigh, pan-fried to the edge of dryness and lacquered in a glossy, rust-coloured gravy with a faint chemical tomato smell. A few scraps of steamed broccoli and pale cabbage cling to the plate's edge, still weeping water. Beside it, a square bowl of underseasoned, overcooked choy sum, drained of colour and structure. The milk tea rests in a chipped white mug. A thin skin has formed on the surface, unbroken.","","She's watching the entrance without trying to look like she's watching. When she spots you, her face rearranges itself into a smile. The sequence becomes visible: recognition, preparation, execution.","","*choice","    #You dissect the performance. She's running a script.","        *gosub_scene utils increase_analysis","        The smile arrives in stages. Eyes first, then mouth, then a slight head tilt, like she's following a checklist bullet point for \"greeting a friend.\" Her shoulders drop exactly two inches.","","        You've seen this before in her lab. The same systematic approach, just applied to social interaction instead of nerve mapping.","    #You note the setup without dwelling on it.","        *gosub_scene utils increase_composure","        She's constructed a scene. Chosen her position, her appearance, her expression. All deliberate. You file it away without judgement and approach the table.","    #You sense the effort beneath the gesture. This is courage, her version.","        *gosub_scene utils increase_empathy","        The smile wavers at the edges, from concentration. She's working so hard at appearing natural that the strain bleeds through.","        ","        This \u2014 sitting here in public, outfit assembled with care, waiting for someone who might not show \u2014 this embodies what bravery looks like for her.","","\"Hi!\" Her voice starts slightly too high, then modulates down. \"Thanks for coming. I got here early to get a good table. This one has the best lighting. Natural light.\" She flings her right arm at the window, then freezes abruptly. \"Sorry. That's probably too much information about table selection.\"","","Her hands return to their folded position. The laminated card shifts \u2014 you glimpse bullet points in neat handwriting before she slides it into her bag.","","Your order number flashes on the overhead screen, so you get your seafood ramen. When you return, Katie's loosened her posture fractionally, and she's torn the paper wrapper from her chopsticks into small, geometric pieces.","","\"So.\" She pauses, rearranging the paper scraps into a tiny pyramid. \"I asked you here because... I need practice. With this.\" A vague sweep of her hand encompasses the canteen, the untouched food, the space between you.","","Her voice softens, losing its rehearsed enthusiasm. \"Not research. Just... talking. Like people do. I know I'm intense. I infodump. I miss cues.\" She exhales, almost amused. \"Sometimes I see it happen. The shift. Their eyes flick past me, then snap back too fast, already halfway out of the conversation. Their smile turns stiff. Pretending to listen while searching for the exit.\"","","The milk tea skin remains unbroken in her mug. She stares at it like it might help her. After a pause to steady herself, she speaks to her folded hands.","","\"I read all these guides about succeeding socially. I practise expressions in mirrors. But it feels like... like I know the words, but they never land in the right order.\" She looks up at you, a hint of moisture in her eyes. \"Does that make sense?\"","","Her hands remain flat and unmoving on the table. No fidgeting, all that restless energy compressed inwards.","","\"I'm not trying to become someone else,\" she adds quietly. \"I just... I want to stop feeling like I'm broadcasting on a frequency no one else can hear.\"","","*choice","    #\"What you're doing takes more effort than most people ever have to think about.\"","        *gosub_scene utils increase_empathy","        *set katie_friendship +1","        Katie's eyes widen, her pyramid of paper scraps forgotten. \"But they make it look so automatic. Like breathing.\"","","        \"You're doing something most people never even attempt \u2014 rebuilding trust in connection. That takes courage.\"","","    #\"We can start simple. Tell me about something you enjoyed this week.\"","        *gosub_scene utils increase_composure","        Katie releases a slow breath. \"Something I enjoyed this week...\" she trails off, searching her mental files.","        ","        \"Yes,\" you say, taking a sip of your red bean milk. \"No analysis or goals. Just conversation.\"","","        She considers this, then nods slowly. \"Okay. I can try that.\"","","    #\"The frequency thing \u2014 I get that. Sometimes connection is just about finding someone on a compatible wavelength.\"","        *gosub_scene utils increase_analysis","        *set katie_friendship +1","        \"Compatible wavelength,\" Katie repeats softly. \"Not the exact same frequency. Just... in sync, sometimes.\"","","        She considers this, then nods slowly. \"That's a better strategy than trying to tune myself to frequencies that aren't mine.\"","","She draws a breath, recalibrating. She's still sitting upright, but less controlled. She picks up her milk tea and sips, distracted. The skin breaks and swirls away, forgotten.","","\"You know what's weird?\" she remarks, glancing out the window. \"I spent ten minutes this morning rehearsing how to ask if you wanted to sit here. But I never actually asked. You just... sat down.\" A quiet laugh, not part of the script. \"Maybe I've been focussing on the wrong things.\"","","A tray clatters behind you as someone clears their table. \"So. What do you... do? Outside of fighting, I mean.\" The words come out measured, like she's reciting from a memorised list.","","\"Work, mostly. Marketing reports that no one reads.\" You pick out the lone prawn floating in your ramen. \"You?\"","","\"Research. Classes. Lab work.\" She pauses. \"I've been trying to learn Cantonese recently. Not just the medical terms.\" She mimes holding something invisible between her palms. \"I know how to say sciatic nerve but not pineapple bun.\"","","\"Useful.\"","","\"Not really. One time, I apparently pronounced black coffee like Buddhist vegetarian mock chicken. The waitress said, 'We don't serve that here,' and gave me hot water.\"","","She laughs \u2014 full and spontaneous, like she forgot to brace for it, the sound trailing off on its own rather than being clipped short. You catch a flicker of surprise in her expression, like the laugh escaped before she could vet it.","","\"Actually...\" Her voice is still loose, still catching momentum from the laugh. \"There's this theory in neurotrauma, about how language rewires itself around pain perception. Like, post-stroke patients relearning nouns and body mapping at the same time.\"","","Then she hears herself.","","Her eyes drop to her tray, where the chicken still glistens untouched. One hand hovers, uncertain, then returns to her lap.","","*choice","    #\"You light up when you talk about this. That's not a bad thing.\"","        *gosub_scene utils increase_empathy","        *set katie_friendship +1","        She blinks like she never considered this angle. \"Right. Makes sense.\" Her fingers quickly brush her neck. \"Still working on the off-switch.\"","","        She exhales audibly, deeper this time, less controlled. \"That's not something I hear much. Most people just glaze over. It's nice when my enthusiasm doesn't drive someone to look for the exit.\"","","        She bites into her chicken, her gaze drifting past your shoulder as she chews, deep in processing. \"Maybe the problem isn't caring too much,\" she begins \u2014 then stops. A small shake of her head, like she's catching herself mid-thought.","","        \"Wait, no, that's not it.\" She exhales through her nose, not looking at you. \"I keep thinking I need to tone it down. But maybe it's not about volume, it's more like...\" A small shrug. \"Finding the right wavelength? Whatever that means.\"","","    #\"Want to steer it back? Ask me something simple.\"","        *gosub_scene utils increase_composure","        \"Oh. Right. Questions are good.\" She straightens a little. \"What's your favourite food?\" The words arrive stiff, rehearsed, but she's trying.","","        You answer, then watch as she processes the interaction. Her head tilts slightly, like a bird hearing an unfamiliar sound, as she absorbs the gap between this and her previous monologue. \"That felt different. Less like presenting a research paper, more like... conversation?\"","","        A small smile appears with less calculation behind it. \"I think I've been treating social interaction like a lecture or a competition. I need to see it as a dialogue.\"","","    #\"We can take turns. I'll monologue about spreadsheets.\"","        *gosub_scene utils increase_analysis","        *set katie_friendship +1","        \"Let me explain the difference between VLOOKUP and INDEX MATCH.\" You launch into a detailed, methodical explanation. Her eyebrows rise. Then, a quiet smile.","","        \"Oh,\" she says. \"This is what I sound like to other people.\"","","        \"More or less.\"","","        She doesn't look embarrassed. She looks thoughtful.","","A trio of students ambles past your table, laughing. Katie watches them go, her eyes tracking posture and tone. You watch her watching them. Head tilt. Mirroring. Pattern recognition. She's learning.","","\"Am I making you uncomfortable, ${first_name}?\" she asks suddenly. Her hand fishes out a rubber band from her pocket, stretching it between index and thumb. \"I'm being weird, right? I'm trying not to be. Does it work, even a little?\"","","She's not asking if you're uncomfortable. She's asking if she belongs.","","*if highest_trait = \"analysis\"","    You note the rubber band's tension, her fidgeting patterns, the way she studies other people. \"The rubber band suggests you're managing anxiety. That's self-regulation, and it's not weird. People handle nervousness in different ways.\" Katie blinks twice, rapid and surprised, the rubber band falling limp between her fingers.","*elseif highest_trait = \"composure\"","    You take another slow sip of your red bean milk. \"If I felt uncomfortable, I wouldn't be here.\" The statement lands with steady conviction. Katie's rapid blinking slows, her grip on the rubber band loosening.","*elseif highest_trait = \"empathy\"","    You lean forward slightly, voice soft. \"You're not making me uncomfortable. And trying means you care. Most people don't care that much about connecting.\" Katie stops fidgeting entirely, the rubber band forgotten, eyes brightening even as she bites her lower lip, her free hand starting to rise defensively before dropping back to the table. She looks down, a small smile ghosting across her face.","*else","    *bug Invalid highest_trait","","The conversation settles into an easier rhythm. Katie asks about your training schedule, how your coach guides you, whether you prefer morning or evening sessions, how you juggle work with training. She stops monitoring her own facial expressions, the rehearsed quality evaporating into something more natural. She starts to ask follow-up questions instead of reciting from invisible cue cards.","","\"Do you ever train alone? I mean, without your coach watching?\" She tears another corner from the napkin. \"Sometimes I practise on myself. Trying out different pressure points. Building a map.\"","","You're explaining pre-dawn Star Ferry sprints and endless climbs in your building's stairwell when her face blanks out, like a phone screen losing charge. Her hands go still on the table. The plastic chair squeaks as you shift, but you don't move away. ","","\"You don't have to stay if this feels too weird.\" The words come out flat, hollow. \"I know this isn't what people talk about over lunch.\"","","\"I feel like I'm pretending all the time, but the seams are showing.\" Almost a whisper now. \"Like I'm in costume, but it never fits right.\"","","The canteen noise continues around you: distant chatter, the electronic ping of a completed order, the rattle of a dropped pair of chopsticks. But the space between you seems to compress, everything else becoming peripheral.","","\"I know I overthink this. But I can tell when someone looks at me and decides it's not worth the effort. Their eyes just... drift past me.\"","","She becomes still. Blinks once, as if hearing herself from outside. A chair scrapes across the floor. Trays clatter somewhere behind. The air smells faintly of overcooked greens.","","\"Sorry, I \u2014\"","","She swallows, voice dropping to barely audible. \"Sometimes I can't even tell. That's worse.\"","","Her hand covers her mouth briefly, too late to take it back.","","Her shoulders curl in, folding her into the plastic chair. The edge digs into her spine through the windbreaker, rigid and insistent. Her forearms remain flat on the table, sleeves bunched, fabric too thin to insulate. Palms flat, fingers braced, like she's anchoring against recoil. You wait. Some moments just need presence.","","This isn't the Katie you first met, all bright athletic wear and weaponised enthusiasm. This isn't the Katie from the lab, so passionate about her research that you forgot how strange her methods seemed. She's waiting for the moment you look away. But she hasn't looked away herself.","","*choice","    #You recognise the spiral. The way doubt feeds on itself.","        *gosub_scene utils increase_analysis","        *set katie_friendship +2","        \"You're scanning for rejection patterns,\" you say. \"Looking for micro-expressions that confirm what you already fear. But faces aren't that consistent. Sometimes people look away because they're thinking, not rejecting.\"","        ","        Katie's hand relaxes slowly. \"So I'm... creating data that doesn't exist?\"","        ","        \"Or interpreting neutral data as negative. It's a common cognitive bias when you expect rejection.\"","        ","        She considers this, her analytical mind engaging with the concept. \"That's... actually helpful. I can work with that framework.\"","","        Her posture straightens \u2014 not defensively, but like someone filing a thought into the right category. A tool she can use.","    ","    #You lean forward slightly, closing the distance without crowding.","        *gosub_scene utils increase_empathy","        *set katie_friendship +2","        \"I'm still here,\" you say simply. \"I choose to be.\"","        ","        Katie's eyes flick up to meet yours, searching for the tell that you're performing kindness. Whatever she finds makes her exhale slowly.","        ","        \"You mean that.\" It's not a question. More like she's testing how the words feel when spoken aloud.","        ","        \"The costume thing? Everyone feels that sometimes. But not now. This is my genuine self.\"","","        Katie's grip on the table loosens. She blinks once, slow and deliberate. The rigid set of her shoulders gives way to something softer.","    ","    #You stay steady, letting the moment breathe.","        *gosub_scene utils increase_composure","        *set katie_friendship +1","        You don't rush to fill the silence. Don't offer reassurances or explanations. Just maintain your position across from her, solid and present.","        ","        \"Still here,\" you say after a moment. Not a question or a promise. Just a fact.","        ","        Katie's shoulders drop a fraction. The defensive curl loosens. She takes a breath that seems to come from somewhere deeper than before.","        ","        \"You don't have to perform for me. This is enough.\"","","        \"Okay,\" she says. And this time, it sounds like she might believe it.","","*page_break","Katie picks up her milk tea and takes a long sip. \"I should probably eat this before it gets completely cold.\" She nudges the gravy with the tines of her fork, then spears a piece of chicken. She chews slowly, like she's remembering how this works.","","You both eat in relative quiet \u2014 the soft scrape of chopsticks against ceramic, the distant hiss of the drink machine cycling, Katie's careful chewing of the now-lukewarm chicken. No jaw tension now. No scan for social cues. Just food. She gathers the paper pieces into one hand. Moves without pause.","","The room reasserts itself gradually: chair legs scraping, a drink machine hissing, someone laughing too loudly at the next table.","","When you're done, Katie packs her bag. Unhurried. Just someone gathering her things. Outside, the afternoon sun cuts sharp angles across the courtyard. Katie pauses at the door, one hand on the handle.","","\"Next time, maybe somewhere with better ramen.\" She doesn't quite look at you when she says it.","","A half-smile flickers across her face.","","\"If you're free,\" she adds. This time she meets your eyes.","","You don't answer. The door shuts softly behind her.","","Ramen next time. Different place. Not a breakthrough. Just a shift in rhythm.","","*return","","*label event_4","*return","","*label event_5","*return","","*label event_6","*return","","*label event_7","*return"], "labels":{"scene_introduction":0,"scene_choice":29,"event_1":66,"event_2":258,"event_3":407,"event_4":629,"event_5":632,"event_6":635,"event_7":638}},
"danny_fight": {"crc":1248940643, "lines":["","*label fight","*temp dc_easy 9","*temp dc_medium 12","*temp dc_hard 15","*set fight_momentum 5","*set trait_bonus_amount 2","*set upgrade_multiplier 4","","Yellow banners ripple like the flag of a microstate. Some are hand-drawn with markers, others are screen-printed, all bearing the same silhouette of a black dragon. No slogans. No sponsors. Just a symbol everyone knows.","","A chant starts, near the front, low and slow. \"Dragon... dragon... dragon...\" It spreads steadily through the crowd, pilgrims finding their voice. No exuberance, no excitement. A chorus of controlled conviction. ","","You're at the edge of the prep area, glimpsing the crowd through a gap in the thin cloth curtains. Other fighters are wrapping their hands, stretching, shadowboxing. Danny sits alone, just inside the threshold.","","His yellow tracksuit is worn at the elbows and knees. But it's pristine, spotless. He draws a thin black wristband from the outer pocket of his gym bag, the one ornament he's added to the outfit. Ties it with the same care a Taoist priest would use for a sacrament.","","Danny closes his eyes, withdrawing into his inner world. A slow exhale. Then he stands, meets your eyes. A nod that seems like the smallest bow. There's no announcement, but the gravity of the crowd's chant deepens. A few spectators press closer to the barricades.","","*choice","    #You consider the entire scene. The chanting, the choreography, the collective rhythm.","        *gosub_scene utils increase_analysis","        It's not spontaneous. But it's not planned either. It's structured \u2014 the crowd has participated often enough that they understand the rhythm. He occupies the centre of a devotional act, though whether as saint or sacrifice isn't certain.","    #You watch how the crowd leans towards him, like they're hoping he'll carry something for them.","        *gosub_scene utils increase_empathy","        They're not cheering a fighter. They're holding space for an idea. And Danny lets them. He carries that for them, victory irrelevant.","    #You focus on your breath. Let the noise pass through you.","        *gosub_scene utils increase_composure","        The crowd's heat, the warehouse noise, even Danny's stillness \u2014 you take it in without letting it settle. You're not here to interpret. Just to stay standing.","","Danny steps out.","","The chant gathers weight, resonating even deeper. \"Dragon... dragon...\" It's the kind of chant that makes its way into your bones.","","You follow.","","The ring is just a square of canvas, bordered by the omnipresent steel barricades and mats. But the moment you step onto the canvas, the space changes. The banners seem to close in. The air's warmer. Even the floodlights seem like they've turned to watch you.","","Danny bows once to each side of the crowd. He offers you the traditional salute, fist pressed to open palm. Then he drops into his stance: side on, lead hand extended, rear foot angled back, like he's been transported here from a Shaw Brothers film. It looks like something practised for thousands of times. The stance has inhabited him, like a uniform conforming to a body over long years.","","The bell rings. The crowd hushes. You circle cautiously. Danny doesn't advance; he beckons with his hand.","","*page_break","Your first ${jab} lands cleanly, a light but solid hit. His counter whooshes past your cheek, a full extension that slices air and nothing else. His face betrays no surprise, no emotion. He resets his stance, weight shifting to his back leg.","","Another jab. Another light hit. You can see it now: he's reacting much too slow, a beat behind. Perfect form, no rhythm. But there's no frustration in his expression, no tension. He exhales smoothly, resetting again, like he's done this a thousand times.","","Barely half a minute has passed, but sweat has already started to gather on his jaw. A kind of electric charge clings to him, intensity and calm blended at the wrong frequency.","","You keep distance. One-two. Nothing reckless. Danny responds with crisp interceptions, graceful footwork, arms moving in smooth circles. But there's no weight behind his movements. No threat. You could be shadowboxing.","","*if highest_trait = \"analysis\"","    Every movement is executed with textbook precision. But it doesn't react to your actions. You're not sparring a fighter. You're appraising a museum piece.","*elseif highest_trait = \"composure\"","    There's no urgency in him, despite losing every exchange. Perfect form, preserved since who knows when. Detailed, precise. Immune to external input.","*elseif highest_trait = \"empathy\"","    His strikes lack hunger. No killer instinct. Each one is a ghost, already vanishing. He's not here to win. Just to honour something.","*else","    *bug Invalid trait","","*set fight_momentum +1","*gosub_scene utils show_fight_momentum","","*choice","    #Probe his defences with a ${jab}.","        *gosub_scene utils increase_analysis","        *set upgrade_bonus (upgrade_multiplier * jab_level)","        *if (((adj_mental * 0.5) + (adj_technique * 0.5)) + upgrade_bonus) >= ((dc_medium * 0.5) + (dc_easy * 0.5))","            *set fight_momentum +1","            You work the jab \u2014 light, precise, persistent. His stance, consistent. His movements, precise. But you see it: the rigidity, the lack of improvisation.","","            There's discipline, but no adaptation. No spark.","        *else","            You work the jab \u2014 light, precise, persistent. Danny's stance holds. He doesn't flinch. Your jabs bounce off a wall of discipline, although he fails to go on the offence.","","            It's like testing a door you think is unlocked, only to find it's not even a door. Just paint on an unmoving wall.","    #Exploit his poor timing with an aggressive ${combo}.","        *set upgrade_bonus (upgrade_multiplier * combo_level)","        *if (((adj_power * 0.5) + (adj_technique * 0.5)) + upgrade_bonus) >= ((dc_medium * 0.8) + (dc_easy * 0.2))","            *set fight_momentum +1","            You throw jab-cross-hook combinations, gradually increasing the pressure. Danny reacts late each time, his blocks too slow, trailing behind your strikes.","","            A clean hook thuds into his cheek, snapping his head to the side. He recovers gracefully, focus steady, but the crowd's chant falters.","        *else","            You throw jab-cross-hook combinations, gradually increasing the pressure. Danny retreats, letting you have the space.","","            Your strikes only land as glancing blows. Gloved thuds on forearms, shoulders. Danny intercepts your hook, then continues smoothly with a punch that lands on your guard. Like you're taking turns to demonstrate techniques.","    #Test his limits with a ${flurry}.","        *set upgrade_bonus (upgrade_multiplier * flurry_level)","        *if (((adj_toughness * 0.5) + (adj_technique * 0.5)) + upgrade_bonus) >= (dc_medium)","            *set fight_momentum +2","            You press forward, fists snapping out in a quick barrage. Danny's movements are precise but lifeless. Like someone following a script two pages behind.","","            Glove meets fist. Glove meets guard. Glove meets ribs.","","            You've read his pattern. Your punches land clean. He doesn't adapt, his movements becoming predictable. ","        *else","            You press forward, fists snapping out in a quick barrage. Danny bends with your assault like bamboo in the wind. Your punches are deflected and intercepted, and his defence holds steady. But there's no aggression coming from him. No attempt to counterattack.","","            The storm ends. He remains.","    #Fight at his pace. See what he's trying to express.","        *gosub_scene utils increase_empathy","        *set danny_friendship +1","        You match his rhythm instead of breaking it. Let his slow counters arrive at his speed. You want to see what he's trying to achieve. He returns each strike with purpose, like he's honouring a memory.","","        The moment stretches. The crowd chants. You both stand taller.","","The first round continues with your probing attacks against Danny's formal, unwavering defence. The crowd's chant continues, the choir accompanying the combatants.","","You advance, and Danny launches an [i]Intercepting Fist[/i], a textbook Jeet Kune Do move designed to meet your attack. As you step in with your hook, his fist is still travelling to your previous position, completely whiffing. Your fist connects fully, rocking his head; his own strike hits empty air.","","For the first time, the crowd's chant dies.","","Danny staggers from the impact, but he doesn't collapse. He [i]folds[/i], welcoming gravity with dignity, hitting the canvas with a soft thud. He lies there, as if in prayer, dust clinging to his tracksuit where he fell.","","He stands up. The chant restarts.","","No flourish. No drama. Steady inhale, calm exhale. His stance returns to perfect alignment, as if he never fell. It's not defiance; it's discipline.","","You land another combination. Jab, body shot, cross. Danny drops again. He gets back up, well before the count.","","The chant grows, until \u2014","","The rhythm vanishes. Your mind is no longer in the fight. It's somewhere else entirely, waiting for your body to catch up.","","*gosub_scene utils show_fight_momentum","*page_break Out of sync.","You no longer hear the crowd.","","They've stopped. Danny's stopped too, mid-breath, mid-blink, mid-step. One heel lifted, just slightly, ready to bounce. Frozen.","","So is the referee. So is the light. So is the dust in the air.","","And so are you.","","Your eyes sweep over the panorama. A young fan in a yellow T-shirt, barely old enough to be here alone, sitting forward in his seat in rapt attention, paper carton drink in one hand. The bookmaker, expression suspended between enlightenment and despair. The ceiling fan, blades paused mid-rotation.","","Your gloves stay up, guard steady. You're not hurt. You're not tired. You just don't have any [i]intention[/i]. You don't want to strike or weave or step.","","You could move if you wanted to. You're in control. Your body still responds \u2014 balance intact, breath controlled. But you don't want to. You're just... uninterested in continuing.","","*if highest_trait = \"analysis\"","    You note the lack of desire like a status report: all systems ready, no commands issued. No goal, no failure state, just a process waiting for input.","*elseif highest_trait = \"composure\"","    There's no threat to manage. You simply [i]are[/i]. Ready, unhurried, unbothered by decision.","*elseif highest_trait = \"empathy\"","    The urgency fades, and with it, the shape of the fight. There's nothing left to do. Only this \u2014 a quiet space, untouched and unbroken.","*else","    *bug Invalid trait","","You register this absence of intention like discovering a room in your house you'd never noticed before. Empty, but not hollow. Quiet, but not dead.","","Movement would mean something. But there's no need for meaning yet. So you stay where you are.","","*choice","    #You stay in place a moment longer.","        *gosub_scene utils increase_composure","        The urge to act returns gradually. You don't hurry it. You breathe, and the stillness remains.","","        Then you decide: you're ready.","    #You watch Danny's stance again.","        *gosub_scene utils increase_analysis","        He still hasn't moved. But you see it now. His feet are slightly too wide. His shoulders hunch up. His stance telegraphs his next move.","","        He never considered hiding his moves. That was never the point. It's a memorised pattern, meant to be looped through again and again.","    #You look at Danny without interrupting.","        *gosub_scene utils increase_empathy","        Whatever this is, it's Danny's, and he's offered to share it with you.","","        You remain with him. Not as someone taking part. Just as someone sharing a moment.","","*page_break The world exhales.","Sound returns \u2014 slow at first, then all at once. The lights buzz. A banner shifts in the air.","","You haven't moved.","","Your guard is still up. Feet planted. Head steady.","","The crowd is watching. The warehouse holds its breath. A cough, faint and distant. ","","Danny hasn't moved. He gazes at you, patiently. Quietly.","","They all saw it. You were gone, somewhere.","","And they're still here. Waiting for your return.","","*set fight_momentum 5","*gosub_scene utils show_fight_momentum","","*choice","    #Recognise that Danny shared something with you.","        *gosub_scene utils increase_empathy","        *set danny_friendship +1","        His gaze tells you everything. He's been here before, in the strange space you just left. And he waited for you to find your way back.","    #Accept it without needing to explain it.","        *gosub_scene utils increase_composure","        *set danny_friendship +1","        You accept what happened without trying to explain it. Some things resist analysis. You breathe, let the moment settle. Whatever happened, it's part of you now.","    #Try to understand what just happened.","        *gosub_scene utils increase_analysis","        You analyse what just happened. Your body remained functional. But something about the situation \u2014 Danny's choreography, the crowd's reverent chant, the place itself \u2014 found you. Your intention evaporated.","","The chant doesn't resume. Not time for that yet. But the audience stays with you, silent and heavy.","","Fist pressed to palm, a nod. Then Danny moves. His [i]Side Kick[/i] arrives, flawless and beautiful. No power behind it.","","You absorb the kick on your guard. It's almost soft in its impact, but it fits the moment. You don't counterattack.","","The fight continues, in a new rhythm. Exchanging techniques. Comparing craftsmanship.","","You exchange a few more blows. Light contact. Heavy intention. Each strike lands as it should, neither too loud nor too quiet.","","*set fight_momentum +1","","*if highest_trait = \"analysis\"","    You've adjusted your responses. Efficiency, not effort. No need to dominate. Just understand.","*elseif highest_trait = \"composure\"","    You hold your ground. Your stance breathes now, no longer scaffolding but something alive. Every block, every counter, every blow, arriving at the right time.","*elseif highest_trait = \"empathy\"","    You read his breathing more than his movements. When he makes contact, it's not to harm. It's to connect.","*else","    *bug Invalid trait","","*page_break","The crowd doesn't cheer. But everyone is standing.","","The bell is close now. One last exchange.","","You've already seen what you needed to see.","","*gosub_scene utils show_fight_momentum","","*choice","    #Fight seriously. This is still a competition.","        *gosub_scene utils increase_analysis","        *if ((adj_mental * 0.5) + (adj_technique * 0.5)) >= ((dc_medium * 0.5) + (dc_easy * 0.5))","            *set fight_momentum +1","            You step forwards to meet Danny. There's no urgency in your movements, only quiet clarity. You've retrieved your intention. Your feet move with precision, each step answering Danny's. He's taught you his Jeet Kune Do. Now you share your boxing with him.","","            Your ${jab} lands where his flowing guard vacates. Your cross follows, his counter whiffing again, as you both knew would happen. Technical boxing. Clean. Inevitable.","","            Danny absorbs each controlled punch without emotion. His movements remain formal, rehearsed, perfect. Weightless. A completion of the circle.","","            In the closing seconds, you deliver a final one-two. Boxing, stripped to its core. It lands not as victory, but as finality. The satisfaction of solving a puzzle. Danny nods. An acknowledgement.","        *else","            You step forwards to meet Danny. There's no urgency in your movements, only quiet clarity. You've retrieved your intention. Your feet move with precision, each step answering Danny's. He's taught you his Jeet Kune Do. Now you share your boxing with him.","","            His flowing guard absorbs your ${jab}. Your cross follows, meeting his disciplined parry. Technical boxing. Clean. Inevitable.","","            Each strike meets Danny's guard or slides past into air. His movements remain formal, rehearsed, perfect. Weightless.","","            In the closing seconds, you deliver a final one-two. Boxing, stripped to its core. It lands smoothly on his guard, redirected like water. Danny nods. An acknowledgement.","    #Respect the moment. Focus on your form.","        *gosub_scene utils increase_composure","        *set danny_friendship +1","        You could pressure him. But instead, you match his tempo \u2014 respectful exchanges that honour the moment he shared with you. Your jab meets his block. His counter meets your guard. Each one arriving at the right time, in the right way.","","        There's no need to prove anything. Now you simply continue the conversation. Jeet Kune Do. Boxing. Two ways to arrive at the same destination.","","        Danny's slow backfist travels towards you. You slip it cleanly, then settle into a basic guard. Not out of caution, but to match his intention. Your next cross finds empty air, as you wanted \u2014 he moved exactly as he should have. The dance continues until the final bell, neither of you wanting to disrupt what you've built together.","","        Your eyes meet. Danny nods. A quiet acknowledgement.","    #Try to knock him down with your ${ultimate}.","","        *if ((adj_toughness * 0.3) + (adj_power * 0.7)) >= ((dc_medium * 0.5) + (dc_hard * 0.5))","            *set fight_momentum +2","            You build tension within yourself, gathering intention like drawing a bowstring. One massive strike to shatter whatever this is.","","            Danny advances with a flurry of straight punches, his guard dropping as if welcoming your blow. Your ${ultimate} launches forwards. It connects cleanly, fully, with Danny's chin. His head snaps back. He falls backwards and lands sitting. ","","            The crowd collectively inhales, caught between awe and reverence. Danny sits there in absolute calm, motionless as a statue. His eyes remain fully open, present, staring straight ahead. ","","            He rises at the count of seven, unhurried. The crowd rises to their feet, a thousand people in silent ovation.","","            He meets your eyes. There's no resentment there, but it's hard to tell what it is. Gratitude, maybe. Or relief.","        *else","            You build tension within yourself, gathering intention like drawing a bowstring. One massive strike to shatter whatever this is. ","","            Danny's hands move in slow circles as he readies for your assault. Your ${ultimate} launches forwards. It flies through space, completely missing, like a letter addressed to someone who has long since moved away. You stumble forwards, off-balance, as Danny continues his slow retreat.","","            You reset your stance, breathing hard from the effort. You knew Danny wouldn't counterattack. The wrong time for that.","","            His expression hasn't changed. No acknowledgement of your attempt. Just the same practised movements.","","The final bell signals the end of the third round, the metallic clang absorbed by the thick, reverent silence.","","*page_break","*gosub_scene utils show_fight_momentum","","You're not sure what you expected. Applause? Relief? Serenity?","","Instead, silence. Dense and gravitational. The referee raises your hand. The crowd doesn't respond.","","Danny stands beside you, unbowed. Shoulders square, eyes looking straight ahead, standing straight.","","Something gathers, something low and primal. Not a cheer. Not a chant.","","A thousand people on their feet, not in applause, but in acknowledgement. A tribute to one who gave so much, and keeps returning, again and again.","","It doesn't matter that he lost. The crowd is here to witness.","","Danny gave them something worth witnessing.","","*page_break","*if (danny_friendship <= 0)","    Danny doesn't look your way. Not out of disregard \u2014 his attention is pulled elsewhere. Still, as he steps past you, there's a change in his posture. The way his shoulders settle. Like he knows you're still watching. Like he doesn't mind being seen.","","    His ritual isn't for you. But you weren't invisible either.","*elseif (danny_friendship >= 1)","    As the noise rises, Danny turns slightly. Not a full glance \u2014 just enough to mark your presence. His bow includes you this time. Not personal, but respectful. A silent nod to what passed between you.","","    Then he turns again, facing the crowd. One hand to his heart, bowing to each side in turn. Still ritual. But now you know what it costs.","*else","    Before he steps away, Danny stops. One hand rises \u2014 not for the crowd, but for you. His fingers touch the black wristband, then his heart, then they extend, palm open. A gesture not of victory, but of welcome. Of continuity.","","    It lingers in the space between you. An offering. A thank-you. A quiet yes.","","You look down. Your gloves are still on. Your arms still tense. Your breathing is shallow. The fight is over. But something remains.","","*choice","    #Let it settle in your body. No analysis, no judgement.","        *gosub_scene utils increase_composure","        You don't try to name it. You just let it pass through. The smell of sweat clings to your gloves. Your joints hum with residual tension. Whatever this was, your body holds it now. No need to explain.","    #Turn it over in your mind. Try to understand it.","        *gosub_scene utils increase_analysis","        The rhythm, the ritual, the absence of escalation. Danny wasn't fighting for victory. He was fighting to transmit. The whole match was a conduit. A structured failure with coded meaning.","    #Wonder what he gave up to become this.","        *gosub_scene utils increase_empathy","        You picture the repetition. The missed connections. The complete absence of victory. How long does it take before the dream and the person blur? You hope he's still in there.","","As Danny exits the ring, supporters reach out, not with high-fives or camera flashes, but with open hands. They don't reach to celebrate. Just to touch. As if he's a vessel, carrying something precious from the ring back into the world. Like he carries it for all of them.","","A fan tries to hand him a phone for a photo. He politely declines. \"Just here to train,\" he mumbles. He exits, calmly. ","","You step out of the ring. The night air doesn't feel like escape.","","*if highest_trait = \"analysis\"","    It was a recitation. You saw the cracks between his movements, the fixed loops of a man trying to embody an ideal. And somewhere in that repetition, your own rhythm sharpened.","","    [i]A Boxing Insight emerges \u2014 subtle, but precise.[/i]","*elseif highest_trait = \"composure\"","    You don't carry the fight in your muscles. You carry it in your alignment. Something in Danny's absolute conviction settled into you.","","    [i]A Boxing Insight takes root. Not impact, not strategy. Just clarity in structure.[/i]","*elseif highest_trait = \"empathy\"","    You didn't beat him. You moved with him. And somewhere in that rhythm: a lesson learned.","","    [i]A Boxing Insight remains. Not learnt \u2014 absorbed.[/i]","*else","    *bug Invalid highest trait","*set boxing_insights +1","*set record_wins +1","","*return"], "labels":{"fight":1}},
"danny_subplot": {"crc":1046519556, "lines":["*label scene_introduction","*if danny_subplot_scene = 1","    You've unearthed dozens of forum threads analysing Danny's philosophy, tribute videos with millions of views, and comment sections full of dragon emojis. But no gym affiliation, no contact information, no way to reach the man behind the legend. If there's any way to reach Danny \"The Dragon\" Chan, it starts with whispers from the underground circuit.","*elseif danny_subplot_scene = 2","    *if danny_plot_timer = 0","        Your coach slipped you a scrap of paper yesterday: \"Kowloon Park, [martial arts area]. Morning.\" He didn't say who it came from. Just glanced at you and remarked, \"Could be Danny. Could be someone's uncle who does tai chi in a yellow tracksuit. Your call.\" It came through someone who knows someone \u2014 same circles you've been asking around in. The paper lay folded, edges sharp. No smudges. No signature.","    *else","        *if (danny_investigation_success)","            Your morning at the Pak Tin complex paid off: booking records showing \"Chan - Private,\" vendors who recognise the yellow tracksuit, tai chi practitioners who've spotted him training. The evidence points clearly to Danny's routine. But the man himself remains just out of reach, his schedule too irregular to predict. Returning repeatedly would cross the line from curiosity into stalking.","        *else","            Your dawn patrol through Sham Shui Po netted contradictory scraps: a morning regular believes she's spotted someone in yellow tracksuit bottoms. A clerk located booking records for \"Chan\" but couldn't specify which Chan. Each lead dissolves when you press for details. Asking again would only mark you as the person who won't take a hint.","            *if danny_plot_timer = 2","                You step back. It's not something you can rush.","            *else","                You've played your part. What happens next isn't up to you.","*elseif danny_subplot_scene = 3","    *if danny_plot_timer = 0","        TODO","    *else","        TODO","*elseif danny_subplot_scene = 4","    *if danny_plot_timer = 0","        TODO","    *else","        TODO","*elseif danny_subplot_scene = 5","    *if danny_plot_timer = 0","        TODO","    *else","        TODO","*elseif danny_subplot_scene = 6","    *if danny_plot_timer = 0","        TODO","    *else","        TODO","*else","    *bug Danny subplot scene not found","*return","","*comment danny_friendship from danny_fight: 0-3","*label scene_choice","*if danny_subplot_scene = 1","    *comment earliest: chapter 4, first fortnight","    *comment danny_friendship from this chapter: 0 for accept, 0 for reject","    *comment cumulative danny_friendship after this chapter: 0-3","    *gosub event_1","    *comment danny_plot_timer is set to either 2 or 3 based on the investigation result","*elseif danny_subplot_scene = 2","    *comment earliest: chapter 5, first fortnight","    *gosub event_2","    *set boxing_insights +1","    *set danny_plot_timer 2","*elseif danny_subplot_scene = 3","    *comment earliest: chapter 6, first fortnight","    *gosub event_3","    *set unlocked_danny_training True","*elseif danny_subplot_scene = 4","    *gosub event_4","*elseif danny_subplot_scene = 5","    *gosub event_5","    *set danny_subplot_status \"finished\"","*else","    *bug Danny subplot scene not found","*return","","*label event_1","*temp minutes_passed 0","*temp info_gathered 0","[i]MK Fight Gym[/i] buzzes with energy as you finish your evening session with Coach Lam. The scent of sweat, leather, and Tiger Balm lingers in the air as your ears register the sound of gloves and shins on heavy bags. You spot one of the regulars cooling down, a large, muscular guy who always brings a small pile of Japanese rice balls with him. You wait for him to finish his stretches and approach.","","\"Danny Chan?\" He stands up straight and loosens his shoulders. \"The Bruce Lee guy? I've heard about him, but he's never trained here.\"","","He leans in slightly. \"Heard he trains somewhere in Sham Shui Po.\" His eyes scan for familiar faces in the gym. \"Hey, Eunice! Where does that yellow tracksuit guy train now?\"","","A tall woman, now wearing thick glasses after removing her contact lenses, wipes her mouth with the back of her hand. \"Some community centre in Sham Shui Po, I think? Or maybe it was a sports ground. No, it was renovated just last year. Wait, actually, I think I've gotten that backwards. Pretty sure it's a community centre now.\"","","\"Early mornings. Tuesdays. Or Thursdays. Tuesdays and Thursdays just blend in together, you know?\" She shrugs and reaches for her water bottle. \"Or maybe it alternates?\"","","You don't interrupt. You just remember the information, chaotic as it is.","","The muscular guy nods. \"Kelvin said the same. But he thought it was an outdoors park, not a community centre.\"","","Eunice frowns. \"No, Auntie Ng insisted it was a community centre. True, she's not the most reliable one. Her tofu pudding is great though.\"","","Sham Shui Po. A community centre, maybe Tuesdays. Or Thursdays.","","*choice","    #Head to Sham Shui Po early on Tuesday to investigate.","        Have to start somewhere. You set your alarm for 5 AM. Should provide enough time to scout the community centres and maybe catch the breakfast crowd. Someone practising Jeet Kune Do in a yellow tracksuit at dawn should be fairly conspicuous.","","        You thank them for the lead and return to your stretches. Ankles still tight. Hamstrings need work too.","","    #Let it go. This is too vague to chase.","        *set danny_subplot_status \"rejected\"","        Unreliable gossip about someone who might be training somewhere in Sham Shui Po isn't worth losing sleep over. If Danny wanted to be found, he would have contacted you.","","        You thank them for the information and return to your stretches. Not every thread needs to be pulled.","        *return","*page_break","You breathe in the smell of coconut milk and diesel exhaust. There's no rush in Sham Shui Po, unlike in the downtown areas. Here, only the leisurely rhythm of people preparing for another long day. You pass by a dessert shop window, misty with condensation. Trays of red bean soup and mango pudding peek out from behind the glass, resting in their large metal trays.","","The Pak Tin community complex rises ahead, harsh green and white metal panels reflecting the morning light, flanked by aging public housing blocks that are adorned with laundry strung out of the windows.","","Inside, past the entrance doors, the main hall opens into a vast, empty space, with high ceilings, scratched wooden floors, and lime green plastic chairs stacked along the walls. Overhead lights bathe the space in a white fluorescent brightness. At the far end of the hall, there's a raised stage framed by heavy velvet curtains. Even with all of these features, the room still feels vacant.","","No one in a yellow tracksuit. No one practising Jeet Kune Do or tai chi. No one here at all, in fact.","","You're alone in a space meant for crowds. So far, you haven't found any traces of Danny. The lack of evidence doesn't disprove the rumours. But even though you're here, the legend feels more distant now.","","*choice","    #Study the hall for evidence of Danny.","        *gosub_scene utils increase_analysis","        Your eyes sweep over the room. The polished floor is well-maintained, with no marks or scratches to suggest martial arts training. But the green plastic chairs against the wall suggest differently. The chairs in one section are pulled out more than the others, handles darkened by repeated use, the wax on the floor worn away. That indicates regular group exercises, though their nature is unclear. If Danny trains here, there's no sign of him.","    ","    #Feel the harshness of the main hall.","        *gosub_scene utils increase_empathy","        The fluorescent lighting is too aggressive for early morning. But the harshness has its appeal. This sterile hall demands nothing. No judgement, no expectations. The lime green plastic chairs, the dull wooden floor \u2014 they would fit in anywhere in Hong Kong, in community centres, in elderly care homes, in school assembly halls. Danny would come here precisely because it's so unremarkable. Hiding in plain sight.","","    #Absorb the silence. Expect nothing.","        *gosub_scene utils increase_composure","        The fluorescent lighting throws the court lines on the floor into sharp relief. Badminton in blue, basketball in red, some sport you don't recognise in green. You stand at the centre, where all the lines meet. You inhale the filtered air. Nothing comes to mind. Danny trains here, or he doesn't. ","","Now to color in the rest of the map. Here in this building or in the streets nearby, you might find more clues. The residue of daily routines, the small details only apparent to those who've spent years in the neighbourhood. Several angles seem promising: the building staff who might know the regulars, or the shopkeepers and early morning exercisers. You could gather your thoughts, see if you missed anything in this sterile building. An hour to ask the right questions \u2014 if you know what they are.","","*label search_carousel","*if minutes_passed >= 60","    *goto carousel_finished","*elseif minutes_passed <= 9","    It's 7:0${minutes_passed} AM. ","*else","    It's 7:${minutes_passed} AM.","You'll need to leave at 8:00 AM to reach work on time.","","*choice","    *hide_reuse #Ask building staff about anyone practising martial arts.","        You find the reception desk staffed by a disinterested middle-aged man in a rumpled uniform, yawning and dismissing your questions. \"No, nothing, sorry, bye bye.\" He stares blankly at the wall behind you.","","        A janitor in a Baguio vest overhears you and pauses her mopping. \"A tai chi group's here every morning at seven. Elderly folks.\" She gestures at the lift. \"A younger man wearing yellow clothes? Maybe. There's a very polite man who books the hall early sometimes. Good man, cleans up after himself.\"","","        You approach the booking counter where a different clerk accesses the computer system. \"Here we go \u2014 private booking, Chan. Last Thursday, 7 AM.\" He shrugs.","","        The janitor taps her mop handle lightly against her shoe. \"He used to stay longer,\" she comments. \"Now it's just the hour. In and out. No lingering.\"","","        She doesn't elaborate. Just returns to the wet patch she'd already cleaned.","","        *if highest_trait = \"analysis\"","            Chan. Common name. By itself, not very useful. But paired with the slot, the outfit, the behavioural shift... something's coalescing.","","            Duration down. Routine intact. A change in ritual suggests intention \u2014 maybe caution. Maybe something's ending.","        *elseif highest_trait = \"empathy\"","            Chan. Common name. By itself, not useful. But not every trail starts loud.","","            The habit changed. That's enough. You don't need to know why. Not yet.","        *elseif highest_trait = \"composure\"","            Chan. Common name. By itself, not much. But the way she delivered it \u2014 not judgemental. Just sad. Like watching someone start to fade while still in the room.","        *else","            *bug Invalid highest trait","","        *set info_gathered +2","        *set minutes_passed +15","        *goto search_carousel","    *hide_reuse #Examine bulletin boards and booking schedules.","        *gosub_scene utils increase_analysis","        You peruse the community centre's bulletin board. Flyers for senior yoga, tai chi, badminton, private tutoring. But near the top corner, half-covered by a cooking class flyer, is a weekly printout for hall bookings. One entry stands out: \"Private booking \u2013 7:00 AM to 8:00 AM \u2013 no course listed.\" Repeats every Tuesday and Thursday.","","        *if highest_trait = \"analysis\"","            That's not proof. But it fits the profile. You add it to your mosaic.","            *set info_gathered +2","        *else","            That's not proof. But it doesn't rule anything out, at least.","            *set info_gathered +1","","        *set minutes_passed +15","        *goto search_carousel","    *hide_reuse #Ask around the park \u2014 tai chi practitioners, seniors, walkers.","        *gosub_scene utils increase_empathy","        Outside, a cluster of seniors move through a slow tai chi exercise on the basketball court. An elderly instructor leads the group, calling out poetic instructions: cloud hands, single whip. Their movements create soft whispers against the morning air. You wait for them to finish before approaching.","","        \"Yellow tracksuit?\" A woman in a plain cotton T-shirt considers your description. \"Sometimes I see someone like that. He wears yellow tracksuit bottoms, anyway.\" She turns to the man beside her, who's adjusting his wire-rimmed glasses. \"You remember? The serious young man?\"","","        He nods slowly. \"A polite one. He enters the community centre by himself, early. Back straight. Never looks at his phone, not even once.\"","","        *if highest_trait = \"empathy\"","            \"There's something slow about him,\" the woman says. \"Not his movement. Just... like nothing touches him.\"","","        They smile at you and pick up their tai chi swords. You bow slightly as they return to their practice.","","        *if highest_trait = \"empathy\"","            *set info_gathered +3","        *else","            *set info_gathered +2","        *set minutes_passed +25","        *goto search_carousel","    *hide_reuse *if (minutes_passed >= 10) #Trade small talk with the fruit and congee vendors.","        *gosub_scene utils increase_empathy","        The congee stall owner barely looks up from her massive pot, steam wafting over her impassive face. \"Yellow tracksuit? Maybe. Hard to remember everyone. Do you want some congee or not?\" She adds some raw beef slices to one bowl, then ladles the thick porridge over them, the heat cooking the meat instantly.","","        But the fruit vendor next door perks up. \"Oh, the Jeet Kune Do guy? Comes by sometimes. Always the same thing \u2014 one apple, one orange. Exact change.\" He mimics a quick side-step, hands loose at his hips. \"Very polite but doesn't chat.\"","","        \"When does he arrive?\" you ask.","","        \"Always early morning, but there's no pattern to it. Sometimes twice a week, sometimes doesn't show up for a month.\" He offers you a mango.","","        You decline politely and buy an apple and an orange instead. Exact change.","","        *if highest_trait = \"empathy\"","            As you hand him the cash, he leans over, voice low. \"Something about him though. Like he's always ready for bad news. Always prepared for the worst. You know that look?\" He taps the corner of his eye.","","            \"One time,\" he adds, almost to himself, \"I saw him take a call. Just one word \u2014 'okay' \u2014 and he stood there for a while. Didn't move. Like the world had ended quiet.\"","","            He glances sideways, then straightens. The moment closes. His hands return to the fruit crates, adjusting a bunch of bananas that didn't need adjusting.","        *else","            As you hand him the cash, he adds quietly, \"Always scans the sky before he leaves. Like he's checking for weather. Or something else.\"","","        The morning commerce continues around you. You consider the pattern. Always early. Always alone. Exact change. No small talk. You don't know what it means yet. But you'll know if it changes.","","        You pocket the fruits and step back into the morning crowd. The vendor returns to arranging his wares, already forgetting your questions.","","        *if highest_trait = \"empathy\"","            *set info_gathered +3","        *else","            *set info_gathered +2","        *set minutes_passed +25","        *goto search_carousel","    *hide_reuse *if (minutes_passed >= 30) #Wait by the doors. See who fits, who slips past unnoticed.","        You settle into one of the lime green plastic chairs near the entrance with a clear view of the main doors. The morning traffic picks up: women with yoga mats, a janitor wheeling cleaning supplies, children in school uniforms passing by outside.","","        No yellow tracksuit. A few people in athletic gear, but they take the stairs to the badminton courts. You note how people move here. They don't look rushed. Just filing papers, checking boxes, standing in queues. Defeated by the building itself.","","        Ten minutes pass. No tracksuit. You begin to recognise the rhythm \u2014 yoga mats, school uniforms, the same janitor looping back with a freshly filled bucket. The patterns emerge fast. Easier than expected.","","        Only afterwards do you realise you were cataloguing gait patterns. The same way you do in fights.","","        *set minutes_passed +10","        *if (minutes_passed >= 50)","            You check your phone. Time to leave soon, whether Danny appears or not. ","        *else","            You check your phone. Time to try something else, whether Danny appears or not. ","","        *goto search_carousel","    *hide_reuse *if (minutes_passed >= 30) #Sit quietly. Consider what draws someone like Danny to this place.","        *gosub_scene utils increase_composure","        You find a chair near the wall and sit. The community centre's morning rhythm plays out around you \u2014 early risers shuffling to tai chi, maintenance staff wheeling equipment, the PA system broadcasting announcements about activity cancellations.","","        Your thoughts circle, gradually slowing until they settle. Why would Danny choose this place? The answer arrives naturally: because it asks nothing of him. A place to be Danny Chan, without being \"The Dragon.\"","","        Any community centre would serve the same function. But this one sits in the heart of working-class Sham Shui Po, unpretentious, honest about what it offers. Discipline, not display. No audience needed.","","        *if highest_trait = \"composure\"","            You understand the appeal. Ordinary spaces can hold extraordinary purpose without the expectation of greatness. When no one else is watching, practice becomes pure, as clean and essential as breathing.","            *set info_gathered +2","        *else","            *set info_gathered +1","","        *set minutes_passed +15","        *goto search_carousel","","*label carousel_finished","*page_break","The chairs stay stacked. The booking screen returns to its idle loop. Outside, the morning rush starts, commuters queuing for double-decker buses and MTR trains with weary efficiency. It's 8:00 AM.","","*if info_gathered <= 6","    *set danny_plot_timer 3","    *set danny_investigation_success False","    What you have isn't proof. Just the usual: a handful of partial memories, a lone \"Chan\" on the booking sheet, the shape of a routine glimpsed through repetition. Weak signals. But they're painted with the same strokes.","*else","    *set danny_plot_timer 2","    *set danny_investigation_success True","    It never crystallises. But the pattern repeats: early bookings, quiet manners, yellow sleeves in peripheral vision. Scattered sightings and unclaimed memories, stitched loosely into a presence. Danny's \u2014 probably. Or someone who wants to be read that way.","","You sit for a while longer. No path emerges. Only a portrait. Not of Danny, but of the reasons he's hard to find.","*if highest_trait = \"analysis\"","    The inconsistencies aren't noise \u2014 they're the pattern. A presence built out of indirect observations, secondhand sightings, behaviours without timestamps. Not hiding, exactly. Just declining to leave a clean trace.","","*elseif highest_trait = \"composure\"","    Some people seek out visibility. Danny lets it pass through him. You came looking for schedule, routine, a place to intersect. But he's designed it so that contact happens only when it's chosen. Never when it's forced.","","*elseif highest_trait = \"empathy\"","    They remember him, but no one claims to [i]know[/i] him. Exact change, careful bows. Always gone before conversation could begin.","","Eventually, you stand. The air outside churns with diesel fumes, the press of bodies, steam from breakfast stalls. As you reach the MTR escalator, your reflection surfaces in the plexiglass panel. For a moment, the tilt of your shoulders is unfamiliar. Something quieter, more deliberate. You hold the shape without thinking.","","The train arrives. You step on.","","*return","","*label event_2","- Go to Kowloon park early. 1-2 paragraphs describing the journey and the scenery","- See elderly practising martial arts. See Danny, seated on a long stone bench by himself.","- Greet Danny. He greets you back. You sit down.","- You both silently watch the people doing martial arts for a few minutes.","- PC internality beat, depending on highest_trait","- Choice: say something, wait for Danny to speak.","- Finish watching.","- Danny says that he's wary of people who seek him out. Those kinds of people want \"The Dragon\" persona. Wasn't sure if you were like that.","- He prefers his anonymity. Doesn't mind the fame within the fighting scene, but doesn't want it in his personal life.","- Dynamic shift (e.g. Danny briefly reacts to one of the martial arts people, who is too aggressive. Something involving Kowloon Park. They get up, walk around.)","- Danny declines to train you.","- Choice: internality, processing of Danny's refusal.","- Reasons shown indirectly:","- Reason: He sees martial arts as a path of self-discipline. He's doing it for himself, not to entertain others.","- Reason: He's not a teacher. He knows he has nothing to teach, that his abilities are limited.","- He doesn't reject the PC's presence.","- More time to observe the PC's character.","- Choice: ask for training, because ??? (Danny refuses, stops contact with PC, ends the subplot), or accept it.","- 1 paragraph, PC leaving Kowloon park, an internality, PC growth.","*return","","*label event_3","Meets Danny, they have a meal together. Wait 2 hours for claypot rice","E.g.","You watch the vendor layer the ingredients in silence: a glug of oil, then raw rice, already soaking in broth. The pot hits the flame. A hiss starts low and builds slowly \u2014 steam condensing around the lip.","","Danny doesn't shift. His gaze stays fixed on the pot, not impatient but tracking something invisible. You follow it too, now \u2014 the gradual tightening of scent, the curl of sliced sausage at the edges.","","Ten minutes later, the vendor cracks the lid, stirs once, and reseals it. A rustle of crust at the base. The smell changes \u2014 deeper now, almost bitter.","","Ninety minutes in, the vendor opens the claypot again \u2014 this time for real. He stirs gently, lets the edges catch a little longer, then seals the lid for the last few minutes. Danny hasn't moved. He watches the process like it's a form being executed.","","\"They cook the rice from raw,\" he says. First words all night.","","He doesn't elaborate. Doesn't need to.","","Have the PC glance at their phone earlier \u2014 show their discomfort with the wait, in contrast to Danny.","","Let the vendor glance at Danny knowingly \u2014 suggesting he's a regular or simply one of the few who waits without complaint.","","A small beat after eating, like:","","Danny chews slowly, eyes half-lidded. No commentary. No approval. Just the kind of silence that means the thing met expectation.","*return","","*label event_4","*return","","*label event_5","*return"], "labels":{"scene_introduction":0,"scene_choice":40,"event_1":65,"search_carousel":124,"carousel_finished":257,"event_2":286,"event_3":308,"event_4":332,"event_5":335}},
"chloe_fight": {"crc":38819593, "lines":["*label fight","*temp dc_easy 13","*temp dc_medium 18","*temp dc_hard 24","*temp struggle_physical 0","*temp struggle_emotional 0","*temp struggle_insight 0","*temp struggle_total 0","*temp struggle_time 0","*temp struggle_trait_bonus 0","*temp braced False","*temp difficulty_check 0","*temp no_quarter_state \"unaffected\"","*temp match_result \"unknown\"","*set fight_momentum 5","*set trait_bonus_amount 2","*set upgrade_multiplier 4","","The door clicks shut behind you. Once a yoga studio, The Cauldron now carries the scuff marks of fighters who don't come here to find peace. Floor-to-ceiling mirrors line one wall, cracked or obscured by fight posters. The venue's air conditioning wheezes, already losing to the packed bodies and July heat. Tower fans churn at the corners. Battered speakers flank them, pushing vibrations through your ribs instead of your ears. A line of thin metal barricades separates the ring from the crowd, the kind the city stockpiled and never quite put away. ","","A proper Muay Thai ring, around seven metres square, dominates the centre. There's a raised platform with worn canvas, four rows of ropes in faded red and blue, corner posts wrapped in padding that shows its age.","","About a hundred people pack the converted studio; most spurn the metal folding chairs entirely. They press against the barricades, hands clutching energy drinks and crumpled betting slips. Two large speakers squat at the corners near the tower fans, bass thrumming through their mesh covers. Cantonese fills the air, expletives exchanged with casual ease.","","The referee checks his phone at the folding table set against the far wall. He's finishing the last bite of a [i]char siu bao[/i]. His official shirt hangs untucked over food-stained jeans.","","*choice","    #Read the crowd's energy. Find out what they're looking for tonight.","        *gosub_scene utils increase_empathy","        A different anticipation charges the crowd tonight. Not the usual pre-fight buzz. Something sharper. Eyes flick around, like they're waiting for another form of entertainment. They've seen this show before. Whatever \"this\" is.","","    #Shut out the noise. Nothing outside the ropes matters.","        *gosub_scene utils increase_composure","        You settle into your stance and let the noise pass through you. Cracked mirrors, folding chairs, the referee's casual indifference \u2014 none of it changes your objective. You distribute your weight evenly. You find your breath. The ring stands solid under your feet. Whatever strange quirks this place holds, you'll face it head on and adapt.","","    #Catalogue the space: sight lines, acoustics, crowd positioning.","        *gosub_scene utils increase_analysis","        Seven-metre rings offer adequate room for manoeuvre. The crowd presses against barricades, but elevated ring creates separation. The referee's table sits far from ringside. Speakers positioned to amplify sound towards the audience, not the fighters.","","        You note the referee's casual posture, his crumpled shirt, the way he keeps checking his phone. The elevated ring creates separation \u2014 but for whose benefit?","","The noise from the crowd ripples. Heads turn towards the entrance.","","Chloe \"Wildcard\" Lee bounces through the narrow gap, her footsteps cracking sharply against the hardwood. Abrupt pivots and restless motion. She stands around 5'4\", early twenties, lean but solid. Off-white sports bra. Four-ounce MMA gloves. Muay Thai trunks with gold trim, frayed at the hem. Expensive, or pretending to be. Hair in a blunt bob, sections clipped back with black snaps, the rest stiff with gel that catches the harsh fluorescent strips.","","She spots you. Her stance loosens, bounce returning to her step. That grin isn't polite. It's greedy.","","\"Finally! Someone new!\" Her Cantonese sounds local but not quite, like she learnt it from TV. She switches to English. \"This is gonna be fun.\"","","She shadowboxes as she walks, hips swaying wildly, loose limbs, sudden steps. The crowd cheers. Someone yells her name in either encouragement or concern. She blows them a kiss without looking.","","You slip through the ropes. Chloe vaults over them in a way that looks rehearsed, then lands with a thud that's anything but.","","The referee, whose face seems permanently set to \"mildly inconvenienced\", stands at ringside and sighs audibly. He taps his cheap hand-held microphone, and the speakers squeal painfully. \"Okay, okay. Lee versus ${last_name}. You know the drill. Try not to break anything. Or, you know, each other. Too much.\"","","He waves a hand with the enthusiasm of a Citybus driver. \"Fight.\"","","*page_break","*if (eric_subplot_scene >= 2)","    Chloe bounces on her toes, hands loose at her sides. \"Wait, wait, wait.\" She squints at you, then her face lights up with recognition. \"You're [i]that[/i] one. Eric's energy-chakra prodigy.\" She throws a wild haymaker that whistles past your ear. You don't react to the swing. The move is a feint, not a real attack.","","    \"Did he teach you the energy meditation nonsense yet?\" She feints a knee, then pulls back, grinning. \"Harmony this, harmony that \u2014 like, please.\"","*else","    Chloe bounces on her toes, hands loose at her sides. \"You're that office drone who beat Danny Chan? Wow, standards have really dropped.\" She throws a wild haymaker that whistles past your ear. You don't react to the swing. It's a feint, not a real attack.","","    \"Let me guess \u2014 you meditate now? Found your inner peace?\"","","You circle carefully, guard up. Her stance shifts constantly, orthodox to southpaw and back, weight distribution all wrong. Like she's imitating YouTube videos \u2014 but each step lands like it knows exactly where it wants to be.","","*gosub_scene utils show_fight_momentum","","*choice","    #Meet her aggression with your ${jab}, establishing distance.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *set upgrade_bonus (upgrade_multiplier * jab_level)","        *if (((adj_technique * 0.6) + (adj_mental * 0.4)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.7) + (dc_easy * 0.3))","            *set fight_momentum +1","            *temp boring_text \"Jab. So interesting. Show me the one-two next!\"","            *if eric_subplot_scene >=2","                *set boring_text \"Textbook jab. Eric would be so proud.\"","            Your ${jab} snaps out, catching her mid-sentence. Her head rocks back, but she already rolls with it, using the momentum to spin into a tight elbow that grazes your cheek.","","            \"Ooh, someone's been practising!\" She wipes her mouth with the back of her glove, grinning. \"${boring_text}\"","","            Your jab landed clean, but she rolls with it like it's warm-up. Still bouncing, still talking.","        *else","            *set fight_momentum -1","            Your punch extends, but she's not where she should be. Her sloppy footwork fluidly carries her inside your jab. A knee drives up, executed with speed and precision. You lean back, but it still catches your ribs with a dull thud.","            ","            \"Whoops!\" she laughs, already dancing back. \"Guess I got lucky.\"","            ","            Lucky. Right. The entry looked chaotic. But the way she grounded her standing leg, attacking foot locked tight \u2014 disciplined.","","    #Pressure her with your ${flurry}, overwhelming her loose defence.","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *set upgrade_bonus (upgrade_multiplier * flurry_level)","        *if (((adj_power * 0.5) + (adj_technique * 0.5)) + (trait_bonus_applied + upgrade_bonus)) >= ((dc_medium * 0.8) + (dc_hard * 0.2))","            *set fight_momentum +2","            You surge forward with rapid combinations. She backpedals, guard suddenly tight and technical. Your shots land on her forearms, her shoulders, one punch thudding into her ribs. She's on the defensive. No longer talking.","            ","            Then she stumbles, foot snagging on nothing. You commit to the opening \u2014","            ","            And her \"fall\" becomes a perfectly timed clinch entry. Arms wrap around your neck, knee already rising. You break free just in time, but the transition flowed seamlessly.","            ","            \"Almost had you,\" she pants, still playing breathless. But her eyes remain sharp. Calculating. And the grin on her face suggests that she learnt exactly what she needed.","        *else","            You surge forward with rapid combinations, but she proves impossible to pin down. She slips one way, dodges another, bobs and weaves. All while throwing wild counters that somehow find gaps in your guard.","            ","            \"Is this your A-game?\" She catches you with a looping overhand that shouldn't have worked. \"Because I'm literally just vibing here.\"","            ","            A teep from nowhere catches you in the stomach, pushing you back and forcing a breath from you. She flashes you a wink that feels more like a dare than a joke.","            *set fight_momentum -1","    #Study her patterns, looking for the skill beneath the chaos.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *if (adj_mental + trait_bonus_applied) >= dc_medium","            *set fight_momentum +1","            You hang back, watching. There. When she throws those wild swings, her rear foot pivots perfectly. When she \"stumbles\", her weight stays centred.","            ","            She feints another haymaker. This time you're ready. You slip inside and land a clean hook to her body. ","            ","            \"Oof!\" She looks surprised. Then delighted. \"Oh, you're paying attention!\"","            ","            Her next attack arrives straighter, faster.","        *else","            You hang back, watching. You can't spot any pattern. Roundhouse kicks, low kicks, spinning elbows, clinch attempts \u2014 just constant pressure washing over you. Her chatter keeps disrupting your focus. That, at least, is predictable.","            ","            \"Overthinking it!\" she laughs, tagging you with a quick one-two. \"Just fight!\"","            ","            You're so focused on finding patterns that you miss the teep. It catches you in the stomach, pushing you back and forcing a breath from you.","            *set fight_momentum -1","","*page_break","Chloe's flailing swings seem to always find their mark. Your counters meet empty air as she flows into empty pockets and closes the distance. Low kicks force you to square your stance, undermining your natural footwork. Roundhouses slam into your guard, offering frustratingly few openings.","","\"You're fun,\" she says during a brief separation, not even breathing hard. \"Most people can't keep up. I end up doing all the work.\"","","*gosub_scene utils show_fight_momentum","","*choice","    #Call her out. \"You're not as untrained as you pretend.\"","        *gosub_scene utils increase_empathy","        She pauses mid-bounce. You see a flash in her eyes. ","        ","        \"Pretend?\" The word resonates.","","        Then her grin returns, even wider than before. \"I have no idea what you mean. I'm just naturally gifted.\"","        ","        She comes at you again, but the rhythm has changed. Clean. Sharp. Real combinations.","","        Each exchange is tighter than the last. The casual chatter of the crowd ebbs to an attentive hush. You slip her elbow and land a clean shot to her ribs. It costs you a moment of balance. She pulls you into the clinch, her knees landing like something from a Bangkok stadium.","","        When you finally create distance, she's bouncing on her toes, eyes bright with something between annoyance and approval.","","    #Stay silent and adapt to her actual skill level.","        *gosub_scene utils increase_composure","        *set chloe_friendship +1","        You adjust: tighter guard, careful distance management, controlled pressure. She notices right away.","        ","        \"Switching gears?\" It sounds like approval. \"Good. I was getting bored.\"","        ","        Her next combination is pure Muay Thai \u2014 sharp jab, roundhouse for spacing, teep to create distance. But she keeps the grunts and wild movements.","","        Chloe sets the pace with a frustrating rhythm that you can't quite follow. She delivers a sloppy hook that becomes a slicing elbow. You slip it, attempt a body blow. She almost floors you with a sweep, forcing you to abandon your attack.","","        You're both locked in now.","    ","    #Use her showmanship against her.","        *gosub_scene utils increase_analysis","        *set fight_momentum +1","        You start baiting her. She drops her guard for drama, you punish it. She winds up for a big swing, you step in a moment early with a cross.","        ","        \"Hey!\" She sounds offended after eating the punch. \"That's not fair \u2014\"","        ","        She cuts herself off. This isn't in the script.","","        She resets her stance, now sporting a thin-lipped smile. The crowd laughs uncertainly. You've rewritten the story.","","        Every exaggerated movement now carries risk. Every flailing wind-up becomes an opening. The rhythm falters. She disengages, buying time with retreats and distancing kicks. The theatre is gone, like she's too busy trying to figure out the new rules.","","","*page_break","The bell rings. You exhale out of habit. Your arms relax by your sides.","","Then you notice Chloe hasn't moved.","","Slow, quiet steps in your direction.","","The referee's busy untangling a pair of over-ear headphones. He slips them on and bops to an invisible beat. From his trouser pocket, he pulls out a laminated \"Do Not Disturb\" sign and slips it over his microphone like it's a hotel doorknob.","","You don't register the sweep until you're already down.","","Your back hits the mat with a soft thud. The canvas smells of sweat and disinfectant. Then she steps up. [i]Onto[/i] you.","","*page_break","","Her heels press hard into your soft stomach. The balls of her feet land just below your ribs.","*if (highest_trait = \"composure\")","    *set struggle_trait_bonus 2","*else","    *set struggle_trait_bonus 0","*if ((adj_toughness * 0.8) + ((adj_mental * 0.2) + struggle_trait_bonus)) >= ((dc_medium * 0.6) + (dc_hard * 0.4))","    *set struggle_physical +1","    *set struggle_emotional +1","    You partially tense your core, just enough to steal one breath before her weight settles fully. She leans forward, pressing your diaphragm. The breath rushes out.","*else","    She rocks back and forth. Your breath is forced out in shallow gasps, a soft wheeze escaping with each exhale.","","You're pinned to the thin canvas. Your internal organs are exposed. She could cause serious damage. Lasting harm.","","The crowd doesn't cheer. Silence. The only sound is the rattle of the air conditioning and your own desperate breathing.","","You don't know what's going on. Is it punishment? Performance? ","","Hard to say, with the air squeezed out of you.","","*set fight_momentum -1","*gosub_scene utils show_fight_momentum","","*label struggle","*set struggle_time +10","*if (struggle_physical >= 2)","    *set braced True","*if (struggle_time <= 10)","    *page_break Can't breathe.","    Chloe's weight presses down like a column of gold bars into you. ","","    You don't control your breath any more.  Each time she shifts her weight \u2014 slightly forward, slightly higher \u2014 the pressure moves from your stomach to just beneath your chest. You feel it press down all across your solar plexus. Not a sharp pain. Just suffocating force.","","    You try to brace, but there's no air to brace with. Your core remains slack, unable to draw air to tense. You can't [i]do[/i] anything. Even the act of breathing is now a negotiation.","","    Somewhere above you, Chloe watches. You can't see her face. Just feel the subtle movements of her feet, the weight redistributing, like she's tuning an instrument. Her pressure avoids your liver, stays below your ribs. She knows exactly where to press. It's a constricting force designed to control your very breath.","","    A rising swell of panic starts to flood your awareness. The kind of animal emotion you haven't felt in a long time. An unraveling.","","    *gosub_scene utils show_fight_momentum","","*elseif (struggle_time <= 20)","    *page_break Continue.","    You really start to feel the lack of breath now. A fuzziness clouding your awareness, a thick fog you can't dispel.","","    Chloe looks down at you. A small, satisfied smile forms on her lips. Not cruel. More like a child who's finally beaten a difficult level.","","    She rocks back on her heels. Air rushes into your lungs, a sharp relief. You inhale too deeply out of reflex.","","    Then she shifts forward again.","","    The weight returns like a hammer. You don't get to use the air. It's all forced out by her systematic assault. Giving you hope, then crushing it.","","    Chloe tilts her head slightly, listening to your desperate breath like it's her favourite song. Your diaphragm responds erratically, slow and unresponsive. She focuses intensely, studying every flutter of your breathing, every strained inhale.","","    Breathing should be automatic. Now it runs on her schedule.","","    You need her off you. You need to breathe.","","    You need her [b]off[/b] you.","","    *gosub_scene utils show_fight_momentum","","*elseif (struggle_time <= 30)","    *page_break Endure.","    *if (braced)","        You've adjusted. You tensed your core just enough to resist Chloe's weight. You can breathe again. Chloe gives you a look of pure annoyance. She digs her heels in harder. Merely a minor adjustment for her, but a full-body ordeal for you.","","        *if (struggle_insight >= 1)","            You can see it now. She's carefully observing your responses. Her adjustments are calculated. She's not trying to harm you; she's moving in sync with your reactions. This isn't personal. It's an exercise of control. A slow-motion experiment.","        *elseif (struggle_emotional >= 1)","            She looks intent and focussed. Not cruel. You understand now: she wants something that makes her feel real. Friction. Resistance. Submission. You happen to be the one providing it this time.","    *else","        Your body doesn't want to try anything now. Lungs struggling. Shallow panting. Not enough oxygen to think. The priority is just getting air. While you fight for every gasp of air, she maintains a slow, steady breath you can almost feel through her feet on your body.","","        You imagine the crowd watching this play out, this humiliation, doing nothing to stop it. No one lifting a finger to help. You can't take much more of this. You need it to stop. Stop. Stop. Just stop.","","        *if (struggle_insight >= 2)","            Some part of you notices that she's carefully observing you. Her adjustments are calculated. She's not trying to harm you; she's moving in sync with your reactions. This isn't personal. It's an exercise of control. A slow-motion experiment.","        *elseif (struggle_emotional >= 2)","            Through the haze, you catch a glimpse of her face. Her eyes are steady. Her smile is almost grateful. She's feeling all of this. Your slow unravelling \u2014 it's a gift to her. You don't matter. She does.","        *else","            Despite trying everything, you can't dislodge her. Each second stretches longer. You're slowly unravelling.","","    Out of the corner of your awareness, you see the referee fumbling with his headphones, like he's trying to remember why he's here.","","    *gosub_scene utils show_fight_momentum","","*elseif (struggle_time <= 40)","    *page_break Time passes.","    The referee has finally removed his headphones. He's staring blankly at the \"Do Not Disturb\" sign in his hand like he's trying to remember what it's for.","","    *if (not(braced))","        Your body has stopped fighting the weight. Your chest rises and falls, but not on your terms. Like your lungs belong to someone else now. The pressure isn't constant. A slight increase that steals your breath. Then the smallest relief that offers a sliver of air, before another compression empties your lungs again.","","    You understand now. This isn't about winning. It's about response. She needs to impose her will on someone who resists. Real, undeniable physical proof. Proof that another person is completely under her control.","","    You feel it in the way her weight adjusts \u2014 not to crush, not to damage, but to stay. To keep you here, suspended. Each shift calibrated to your breath, each pause stretched just long enough. She's trying to feel you. Pressure. Feel that you're still here, still underneath her.","","    Chloe leans in one last time. A subtle shift, like she's imprinting a result onto your body. She's almost found what she's wants. Maybe one more adjustment.","","    You don't know what you're feeling now. Like your awareness isn't inside your body, and you're observing all this from far away.","","    *gosub_scene utils show_fight_momentum","","*else","","    *gosub_scene utils show_fight_momentum","","    *page_break Move on.","    *goto round_2","","*choice","    *hide_reuse #Shout at the referee. Make it stop.","        *set struggle_emotional -1","        *set fight_momentum -1","        \"Hey! This isn't \u2014\" The words rasp out of you, hoarse and weak. You need someone to see what's going on. To stop this.","","        Chloe presses down harder, a smirk playing on her lips. \"What's wrong?\" Her voice lifts, delighted. \"Looks like someone forgot to read the house rules!\" She leans in, watching your face redden.","","        There's no more air for words. Just silent gasping. The desperate struggle for oxygen, not voice.","        *goto struggle","","    *hide_reuse #Breathe. Focus. She's trying to humiliate you.","        *if (braced)","            *set difficulty_check (dc_easy)","        *else","            *set difficulty_check ((dc_easy * 0.5) + (dc_medium * 0.5))","        *if (highest_trait = \"empathy\")","            *set struggle_trait_bonus 2","        *else","            *set struggle_trait_bonus 0","        *if (adj_mental + struggle_trait_bonus) >= difficulty_check","            *set struggle_emotional +2","            You clamp down on the panic. You breathe, even with the weight on your diaphragm. Chloe becomes a challenge to manage, not an overwhelming threat. Containable.","","            You acknowledge her intent to humiliate you. A tactic, just like any other. The humiliation doesn't stick.","","            She notices. Her eyes narrow, a flicker of frustration crossing her face.","","            \"Most people panic when they realise how helpless they are. They break down. You're just... watching me.\" She says it softly.","        *else","            *set fight_momentum -1","            You try to breathe steadily, but your body's already decided to panic. Shallow air, stuck at the top of your lungs. Each attempt at focus crumbles under her weight pressing into you.","            ","            Pinned. Breath stolen. Helpless. Violated.","","            A part of your brain insists that this is just a tactic. Yet the humiliation floods your mind, overriding logic. It overwhelms you.","        *goto struggle","","    *hide_reuse *if (struggle_time >= 20) #Read her face. What's she getting out of this?","        *if (highest_trait = \"analysis\")","            *set struggle_trait_bonus 2","        *elseif (highest_trait = \"empathy\")","            *set struggle_trait_bonus 1","        *else","            *set struggle_trait_bonus 0","        *if (adj_mental + struggle_trait_bonus) >= ((dc_easy * 0.4) + (dc_medium * 0.6))","            *set struggle_insight +2","            Her expression isn't cruel. Not malicious. It's intensely focused, the look of an artisan at their craft. She's tracking your micro-responses \u2014 your shallow breaths, the flush in your face \u2014 with clinical precision.","","            The pattern becomes clear: she's done this before. This is a well-honed process. She knows exactly what she's looking for.","","            Control. She craves control. For whatever reason, her absolute command of your basic bodily functions fulfils some profound need within her.","        *else","            *set struggle_insight +1","            Her expression isn't cruel, but the focus in her eyes is notable. It's a detached gaze that seems to look [i]through[/i] you. She's barely smiling; she's intensely concentrating. What does she want? You can't be sure. ","","            You sense a primal need driving her, a hunger to feel... something. Domination? Validation?","        *goto struggle","","    *hide_reuse *if (struggle_time >= 30) #Let her get comfortable. Then disrupt her balance.","        *if (braced)","            *set difficulty_check ((dc_medium * 0.5) + (dc_easy * 0.5))","        *else","            *set difficulty_check ((dc_medium * 0.5) + (dc_hard * 0.5))","        *if (highest_trait = \"composure\")","            *set struggle_trait_bonus 2","        *else","            *set struggle_trait_bonus 0","        *if ((adj_toughness * 0.6) + ((adj_power * 0.4) + struggle_trait_bonus)) >= difficulty_check","            *set struggle_insight +1","            *set struggle_physical +1","            You become unresponsive, feigning surrender. Her weight shifts forward, asking for a response from you. That's when you move. Hips thrust up and sideways, angled to disrupt her balance.","","            She wobbles. Her arms fly out straight, knees bending to absorb the movement. Your diaphragm expands fully for the first time as she fights for balance. Air floods back into your lungs. ","","            \"Oh!\" A cry of surprise escapes her. She recovers quickly, settling back into position. But see recognition in her eyes now. Respect. You're not just enduring her torment. You're fighting back.","","            She drops her centre of gravity, knees slightly bent. The weight feels more distributed, easier to absorb. But it's also somehow more permanent, like she's glued to your body.","        *else","            *set fight_momentum -1","            You become unresponsive, feigning surrender. Her weight shifts forward, asking for a response from you. That's when you move. Hips thrust up and sideways, angled to disrupt her balance.","            ","            No effect. The moment you begin to move, she counterbalances \u2014 a slight lean forward that maintains her centre of gravity. She was ready for your attempt.","            ","            \"Did you think I wasn't paying attention?\" She sounds delighted rather than angry. Her weight settles deeper into your diaphragm.","        *goto struggle","","    *hide_reuse #Try to push her off with your hands.","        *set fight_momentum -1","        Your hands move before your brain catches up. Gloves pressing against her shins, shoulders straining, trying to shove her off through sheer desperation. Nothing moves.","        ","        She shifts her weight slightly. Not to maintain balance, just to press down harder. A reminder that your effort didn't even need a response.","        ","        \"Cute,\" she says, watching your arms tremble with exertion.","        ","        Your strength fades. She didn't need to make any effort at all. And now you're more tired than before.","        *goto struggle","","    *hide_reuse #Explode upward. Try to buck her off.","        *if (braced)","            *set difficulty_check ((dc_medium * 0.8) + (dc_hard * 0.2))","        *else","            *set difficulty_check ((dc_medium * 0.2) + (dc_hard * 0.8))","        *if (highest_trait = \"composure\")","            *set struggle_trait_bonus 2","        *else","            *set struggle_trait_bonus 0","        *if ((adj_mental * 0.2) + ((adj_power * 0.8) + struggle_trait_bonus)) >= difficulty_check","            *set struggle_physical +2","            *set struggle_emotional +1","            You plant your feet against the canvas, then explode your hip upwards. @{braced Having braced your core,|Even though you haven't fully braced your core, with a Herculean effort} you generate enough power to lift her off the ground by several centimetres. The push empties your lungs like air being sucked from a storage bag.","","            She instantly drops to a crouch, hands on the floor to stabilise and maintain her position on top of your torso. For an instant, the pressure's gone. @{braced You take another full breath.|Air floods back.} She rises smoothly into a standing position again.","","            \"Feisty,\" she says, but there's approval in it. She plants her feet wider, knees bent lower. Harder to disrupt now. But you're not just a platform. You're an active participant now.","        *else","            *set struggle_physical +1","            *set struggle_emotional -1","            *set fight_momentum -1","            You plant your feet against the canvas, then explode your hip upwards. @{braced Even though you've braced your core|Since you haven't braced your core}, it feels like pushing against a grand piano.","","            She rides it out like she's standing on a boat deck, knees flexing to absorb the motion. Her balance never wavers.","            ","            \"Adorable,\" she says, her weight never shifting, never yielding. You body reflects the futile exertion of the failed resistance. Legs heavy. Breath short.","            ","            She shifts her weight forward. A reminder of who holds control.","        *goto struggle","","    *hide_reuse *selectable_if (not(braced)) #Let yourself go limp. Maybe she'll lose interest.","        *if (highest_trait = \"empathy\")","            *set struggle_trait_bonus 2","        *elseif (highest_trait = \"analysis\")","            *set struggle_trait_bonus 1","        *else","            *set struggle_trait_bonus 0","        *if (adj_mental + struggle_trait_bonus) >= ((dc_easy * 0.4) + (dc_medium * 0.6))","            *set struggle_emotional +1","            *set struggle_insight +1","            You force your body to slacken. Let her think she's broken you. Your eyelids droop, your breathing slows, your limbs grow heavy. ","","            Chloe notices immediately. Her weight shifts slightly, testing if you'll respond. You don't react. Through half-closed eyes, you watch her. Satisfaction flickers across her face, but her smile is subdued. Another emotion surfaces, one you can't place. Disappointment?","","            \"Finally,\" she whispers, but there's no satisfaction in her voice. She eases back onto her heels, allowing some air into your lungs. You see how there's no celebration, no enjoyment in her movements. It's as if surrender isn't what she wanted.","","            You file that away. She wants resistance. Push-back. Surrender is uninteresting.","            *goto struggle","        *else","            *set struggle_emotional +1","            *set fight_momentum -1","            You force your body to slacken. Let her think she's broken you. Your eyelids droop, your breathing slows, your limbs grow heavy. ","","            But your body thinks it's real, not an act. The will to fight drains away. Your muscles feel heavy. Your mind retreats inwards, seeking refuge in complete surrender.","","            Your breathing turns shallow, not because of Chloe, but from the relief of no longer needing to struggle. You enter a strange, empty space. The ring, the crowd, Chloe on top of you, it's not here any more, not really.","","            Chloe shifts above you, easing back onto her heels as she recognises the change. Some air seeps back into your lungs. \"There we go,\" she says softly, almost gently. But she doesn't sound satisfied. It's as if surrender isn't what she wanted.","","    *hide_reuse #Thrash blindly. Just get her off you.","        *set struggle_emotional -1","        *set fight_momentum -1","        Everything fires at once. Arms flailing, legs kicking, core twisting. Pure panic. Your body burns through oxygen it doesn't have, muscles screaming for air that won't come. The canvas burns against your shoulders as you writhe.","        ","        Above you, Chloe barely shifts. A slight forward lean to compensate, knees adjusting by millimetres. That's all your explosion of effort earns \u2014 a minor postural correction.","","        \"Stop,\" she says, almost disappointed. Her eyes lose focus, like she's sitting through an unskippable mobile game ad. \"This isn't... useful.\"","        ","        She doesn't even press harder. Just stays there.","","        *goto struggle","","*label round_2","The referee blinks like he's just remembered where he is. He rises from his seat and shuffles over to the ring.","","Chloe doesn't step down gently. She hops off you. A deliberate hop that drives both feet into your diaphragm, forcing your air out one last time.","","\"Looking good,\" she says, winking at you. She takes a small bow, then strolls back to her corner.","","You don't move yet. Need to assess the damage. Arms: responsive. Legs: normal. Core: tender and aching, but functional. Lungs: working, now.","","The referee ambles over, still untangling his headphone cord. \"Cannot lie down. House rules ah.\" He gives a weary sigh and makes a vague upwards gesture at you with his free hand. Then he turns back to the referee table, not waiting for your acknowledgement.","","You push yourself up and sit. A brief dizziness that fades in seconds. Your muscles burn. Must have been tensed the entire time. Someone in the crowd coughs. You wonder if they care about what just happened at all.","","*if (no_quarter_state = \"rattled\")","    Your body still remembers her weight. Each breath comes shallow, cautious, like you're bracing for the next assault. You stand, but part of you remains pinned to that canvas. You try to forget the violation, but it lingers, settling in your body.","*elseif (no_quarter_state = \"holding\")","    Standing, you test your body one more time. Everything's working. But something's still a bit wrong, like you're more fatigued than Chloe's pressure alone should have caused.","*else","    You climb to your feet. What just happened was wrong. You know that. But you don't let it derail you. That's what she wants. You know the story she needs to tell \u2014 the manufactured chaos, the craving for control, the hunger for connection. Time to turn the tables.","","*page_break","*comment Unaffected: strong individual + decent total OR excellent total","*comment Holding: strong individual + poor total OR decent total without standouts  ","*comment Rattled: everything else","*set struggle_total (struggle_physical + (struggle_emotional + struggle_insight))","*if ((struggle_physical >= 2) and (struggle_total >= 2))","    *set no_quarter_state \"unaffected\"","*elseif ((struggle_emotional >= 2) and (struggle_total >= 2))","    *set no_quarter_state \"unaffected\"","*elseif ((struggle_insight >= 2) and (struggle_total >= 2))","    *set no_quarter_state \"unaffected\"","*elseif (struggle_physical >= 2)","    *set no_quarter_state \"holding\"","*elseif (struggle_emotional >= 2)","    *set no_quarter_state \"holding\"","*elseif (struggle_insight >= 2)","    *set no_quarter_state \"holding\"","*elseif (struggle_total >= 3)","    *set no_quarter_state \"holding\"","*else","    *set no_quarter_state \"rattled\"","The bell rings. Round two.","","Chloe bounces on her toes, each impact absorbed by the canvas. The show is back on. Her eyes stay sharp, tracking your movement. She's already studying how you handle the aftermath.","","*if (no_quarter_state = \"rattled\")","    Your legs feel heavier than they should. Each breath arrives uncertain, like a privilege she might revoke. She sees it. Her grin widens.","","    \"Still with me?\" she calls out, already stalking forward. \"Did anything break?\"","*elseif (no_quarter_state = \"holding\")","    You shift your weight, testing your one-two. She notices the careful way you're moving.","","    \"Not bad,\" she says, circling left. \"Most people can't even stand without looking seasick.\"","*else","    You roll your shoulders and settle into your stance. She watches you closely, noting the lack of hesitation.","","    \"Interesting,\" she whispers. The bouncing slows. Her stance tightens. \"You're actually here to fight.\" She tucks her chin slightly. The grin vanishes.","","She feints a wild haymaker \u2014 the same opening as round one. But this time her weight distribution is perfect.","","*gosub_scene utils show_fight_momentum","","*choice","    #Launch into your ${combo} before she finishes her read.","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *set upgrade_bonus (upgrade_multiplier * combo_level)","        *if (no_quarter_state = \"rattled\")","            *set difficulty_check ((dc_medium * 0.8) + (dc_hard * 0.2))","        *elseif (no_quarter_state = \"holding\")","            *set difficulty_check (dc_medium)","        *else","            *set difficulty_check ((dc_medium * 0.7) + (dc_easy * 0.3))","        *if (((adj_technique * 0.6) + (adj_mental * 0.4)) + (trait_bonus_applied + upgrade_bonus)) >= difficulty_check","            *set fight_momentum +2","            You strike before she can settle into her rhythm. Your ${combo} flows clean \u2014 jab to set distance, cross to the body, hook catching her as she tries to slip. She absorbs the shots but can't counter, forced into pure defence. Another. Jab, body jab, cross.","            ","            \"Fast,\" she admits, backing away, her footwork economical. Her theatrical movements have vanished. Now, textbook Muay Thai.","        *else","            *set fight_momentum -1","            You rush your combination trying to strike before she's ready. But she reads it perfectly, slipping your jab and sending a knee towards your ribs. You twist away at the last second, but she continues with an elbow to your face, grazing your temple.","","            \"You've got a favourite combo. That's cute,\" she says, as she drops into a lower stance. Her exaggerated movements have vanished. Now, textbook Muay Thai.","    #Pressure her with a ${flurry} \u2014 take the initiative and make her react to you.","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *set upgrade_bonus (upgrade_multiplier * flurry_level)","        *if (no_quarter_state = \"rattled\")","            *set difficulty_check ((dc_medium * 0.8) + (dc_hard * 0.2))","        *elseif (no_quarter_state = \"holding\")","            *set difficulty_check ((dc_medium * 0.6) + (dc_easy * 0.4))","        *else","            *set difficulty_check ((dc_medium * 0.4) + (dc_easy * 0.6))","        *if (((adj_power * 0.4) + (adj_technique * 0.6)) + (trait_bonus_applied + upgrade_bonus)) >= difficulty_check","            *set fight_momentum +1","            You unleash your ${flurry}. Then again. Again. She can't find space, forced to retreat and shell up. Each punch forces her to defend \u2014 block, slip, weave \u2014 preventing her from countering.","            ","            \"Okay, okay!\" She circles away, breathing harder now. \"You still have the energy to pressure me. Didn't expect that.\"","        *else","            You press forward with a ${flurry}, but","            *if (no_quarter_state = \"rattled\")","                your timing's off, movements sluggish.","            *else","                she flows around your aggression like water.","            She uses your momentum against you, going into the clinch once you flag. Her knees punish your ribs.","            ","            \"Thought that would work?\" she says mid-knee. A final knee pushes you away and resets the distance.","    *if (counter_level > 0) #Read her stance and prepare to ${counter} her attack.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *set upgrade_bonus (upgrade_multiplier * counter_level)","        *if (no_quarter_state = \"rattled\")","            *set difficulty_check (dc_hard)","        *elseif (no_quarter_state = \"holding\")","            *set difficulty_check ((dc_medium * 0.7) + (dc_hard * 0.3))","        *else","            *set difficulty_check ((dc_medium * 0.8) + (dc_easy * 0.2))","        *if (((adj_mental * 0.7) + (adj_technique * 0.3)) + (trait_bonus_applied + upgrade_bonus)) >= difficulty_check","            *set fight_momentum +2","            You wait, watching her weight distribution. There \u2014 her rear foot plants as she commits to a roundhouse. Your ${counter} meets her kick halfway, her momentum crashing against your gloved fist.","            ","            She staggers, falling back a few steps in a disorderly retreat. \"You read that?\" She's impressed.","            ","            Her stance shifts completely. No more theatre. Now, textbook Muay Thai.","        *else","            You try to read her movements, but","            *if (no_quarter_state = \"rattled\")","                your focus wavers.","            *else","                her erratic patterns are too hard to decode.","            You wait for an opening that never comes. Meanwhile, her wobbly haymaker becomes an elbow that grazes your jaw.","            ","            \"You're thinking too much,\" she says, already feinting and probing your defences.","    *selectable_if (no_quarter_state = \"unaffected\") #Call her out: \"That felt practised. How many times have you done that?\"","        *gosub_scene utils increase_empathy","        *set chloe_friendship +1","        She pauses mid-bounce, eyes narrowing. Appraising. \"Most people are too rattled to think that clearly.\"","","        She resumes circling, but her stance tightens. The wild swings become more controlled, even as the erratic rhythm remains.","","        \"But noticing and surviving are different things.\" Her next combination's sharp and disciplined.","","*page_break","Chloe pauses, her bounce halted for the moment.","","*if (no_quarter_state = \"rattled\")","    She sees the caution in your breath. The way you shrink from her approach. She grins, feeding on your hesitation.","    ","    \"Still feeling it?\" She rushes you with a barrage of punches and knees. Your guard's shaky, barely holding against each strike. Your brain's still replaying the scene \u2014 her weight pressing down and crushing you.","","    \"Look at you. Trying to pretend you're fine.\" A roundhouse almost slams into your ribs, your dropped arm shuddering with the impact instead. Your mind hasn't caught up to your body.","    ","    \"Come on,\" she taunts. \"That's it? You're done?\" Another low kick to your thigh, scrambling your footwork.","","*elseif (no_quarter_state = \"holding\")","    She sees how you're trying to cope without letting it show. She changes to methodical probing. Testing you. Seeing whether you have it together, or whether you'll unravel in the end.","    ","    \"Interesting.\" She throws a jab and transitions into a side elbow when you try to counter. \"Let's see how you hold up.\"","    ","    She feints, feints again, then a push kick to your chest. A low kick to test your base. A clinch attempt to see if you'll flinch. She doesn't seem to care whether her hits land or not.","","    You're still able to read her. How she probes for weaknesses, but always leaves an escape route for herself.  It looks aggressive, but she's being careful.","    ","    \"You're coping,\" she says. \"But that's all.\"","","*else","    She sees your rapid recovery, how you've absorbed her violation and moved on. Her erratic rhythm vanishes.","    ","    \"Well.\" It's quiet, almost appreciative. \"That's unexpected.\"","    ","    She backs away, watching how you advance. You glimpse the method in the madness. No wasted energy. A snap jab. You block, quickly resetting and bobbing to avoid the cross that follows.","    ","    A probing low kick. Not punishing. Just enough to interrupt your advance. As if she's the one needing to keep distance.","","    Nothing's changed. You're still reading her moves. Still here in the fight.","","Out of the corner of your eye, you catch the referee trudging over to ringside, glaring at his phone with increasing irritation. The spectators at the front lean over the barricades to catch the final exchange.","","*gosub_scene utils show_fight_momentum","","*choice","    #Shut her down with disciplined defence and counters.","        *gosub_scene utils calculate_trait_bonus \"composure\"","        *if (no_quarter_state = \"rattled\")","            *set difficulty_check ((dc_medium * 0.5) + (dc_hard * 0.5))","        *elseif (no_quarter_state = \"holding\")","            *set difficulty_check (dc_medium)","        *else","            *set difficulty_check ((dc_medium * 0.8) + (dc_easy * 0.2))","        *set upgrade_bonus (upgrade_multiplier * (((block_level + parry_level) + (dodge_level + counter_level)) * 0.5))","        *if (((adj_toughness * 0.7) + (adj_mental * 0.3)) + (trait_bonus_applied + upgrade_bonus)) >= difficulty_check","            *set fight_momentum +1","            *if (no_quarter_state = \"rattled\")","                Her violation lingers, a tightness in your chest that won't leave. But you remain focussed. Each time she attacks, you're ready with a solid guard. When she overextends, you make her pay with short, sharp jabs. Nothing flashy. Just consistent punishment.","                ","                \"Good. Still fighting,\" she mutters, forced to respect your defence.","            *elseif (no_quarter_state = \"holding\")","                You hunker down into a patient defence. Your timing's still off, but you adjust accordingly. You dodge the telegraphed moves, block the faster ones. No openings for her to exploit. You counter at unexpected moments, disrupting her rhythm and punishing her when she overextends.","                ","                She backs off slightly. \"Okay, you still got it.\"","            *else","                Your defence quickly shuts down her attempts. All systems firing, reflexes sharp. Block and counter. Interrupt her with quick jabs. Your shots land clean, while none of hers find their mark.","                ","                \"Okay,\" she breathes, stepping back. \"I can respect that.\" No frustration, just recognition.","            She peppers you with teeps and leg strikes to last out the round.","        *else","            *set fight_momentum -1","            You try to weather the storm, but","            *if (no_quarter_state = \"rattled\")","                your body won't cooperate, a fog of disorientation clouding your reactions. Blocks covering the wrong angles. Counters mistimed. She easily exploits your openings with punishing strikes.","                ","                \"This is what happens,\" she says, landing a knee to your ribs, \"when your mental game is weak.\"","            *elseif (no_quarter_state = \"holding\")","                your timing's still slightly off. You can read the attacks, but your reactions lag. Your counters get slipped. Her attacks rain down, your defence withering under the relentless pressure.","                ","                \"Nice try,\" she says, slipping past your guard with a knee to your ribs. \"But you don't have it together.\"","            *else","                even though you're in the zone, so is she. And the breath she stole earlier makes the difference. For every hit you land, she lands two. The pressure never lets up.","                ","                \"Good fundamentals,\" she says, another low kick hitting your front leg. \"But this isn't a training session.\"","            She keeps the pressure on as the round winds down.","    #Turn her aggression against her with movement and angles.","        *gosub_scene utils calculate_trait_bonus \"analysis\"","        *if (no_quarter_state = \"rattled\")","            *set difficulty_check (dc_hard)","        *elseif (no_quarter_state = \"holding\")","            *set difficulty_check ((dc_medium * 0.6) + (dc_hard * 0.4))","        *else","            *set difficulty_check (dc_medium)","        *set upgrade_bonus (upgrade_multiplier * ((dodge_level + counter_level) * 0.5))","        *if (((adj_technique * 0.6) + (adj_toughness * 0.4)) + (trait_bonus_applied + upgrade_bonus)) >= difficulty_check","            *set fight_momentum +2","            *if (no_quarter_state = \"rattled\")","                You force your body to move despite your shallow breath. Sidesteps, pivots, dodges. As much unpredictability as you can muster, making her work for every hit. Her attacks start finding empty air.","                ","                She's breathing hard as she misses yet another elbow. Her discipline starts to break down, while your composure remains intact. Kicks become sloppy, not from carelessness, but from frustration. Punches overextend.","                ","                An opportunity. Your cross lands clean on her cheek as she rebalances from a roundhouse, the impact vibrating up your arm.","            *elseif (no_quarter_state = \"holding\")","                You slip her probes and create angles she doesn't expect. Your shoulders brush the ropes as you pivot out. Each time she thinks she has your timing, you've already shifted. You move efficiently, making her work for every attack.","                ","                \"Slippery,\" she spits. Both of you are breathing hard now. Her discipline starts to break down, while your composure remains intact. She hesitates, no longer confident in her reads.","                ","                You catch her with a hook as she tries to cut off your movement, glove landing with a thud on the soft spot below her ribs. She stumbles back, legs unsteady as she fights for balance.","            *else","                You slip her jabs smoothly, flowing into her blind spots. She's lagging your movements, too slow to land any blows. You follow up dodges with fast combinations, interrupting her rhythm and placing her out of position.","                ","                \"Slippery,\" she spits. Your counter almost tags her on the jaw. She exhales sharply and tries again. ","","                You intercept her movement with a ${jab}, tagging her before she even starts her attack, following it with a hook to the ribs. A body blow sinks deep, driving a gasp of air from her lungs. \"Oof,\" she coughs, back-pedalling before you can capitalise.","        *else","            *set fight_momentum -1","            You try to create angles,","            *if (no_quarter_state = \"rattled\")","                but your legs betray you. The timing is all wrong, your weight not shifting with your footwork. You step where you should pivot. You pivot where you meant to duck. Chloe doesn't even pursue. She just waits for you to stumble into range.","                ","                \"Where are you going?\" she laughs, steering you into the corner with basic teeps.","                ","                With nowhere to run, you're pulled into the clinch. Your ribs take a barrage of knees that drives the air from your lungs. Each impact echoes the pressure you felt under her feet.","            *else","                but she matches you step for step. Her footwork is just as good, and she's fresher. You see where you should go, but she's already there, cutting off the angle.","                ","                \"Nice try,\" she says, cutting off another attempted sidestep. \"But you're easy to read.\"","                ","                Another roundhouse thuds into your thigh. She steers you into the corner, where her close-range elbows and knees punish your guard.","","*if fight_momentum >= 7","    Chloe's guard stays high, but her feet shuffle rather than bounce. She's breathing hard, arms shaking slightly with fatigue. Sweat soaks through her sports bra. She's sticking to simple combinations. Jab, cross, step out. You circle her steadily, cutting off angles and snapping out sharp jabs. Everything under control.","*elseif fight_momentum >= 5","    Chloe's movements are less exaggerated now. She circles with her chin tucked, rather than playing to the crowd. Her teeps are for pushing you away rather than dealing damage. No more flailing and feinting. Her footwork is steady, shuffling rather than bouncing. You maintain distance with your jab, conserving strength and breath. No need to force things.","*elseif fight_momentum >= 3","    Chloe's shoulders loosen again, her stance widening as she finds space to work. Her punches start connecting \u2014 crisp boxing combinations that bypass your guard. Her bounce is back, her rhythm returns. \"There we go,\" she says, slipping your counter. \"Found your timing.\" She breaks into a triumphant smile and then pressures you with rapid-fire kicks. You're holding on, but your reserves are empty.","*else","    Chloe's gloves drop to her waist as she circles, chin exposed, practically inviting punches that never come. She fires machine-gun teeps, pushing you around the ring from corner to corner. You try to reset your stance, but your legs won't cooperate. \"You bounce well!\" she jokes, drawing scattered laughs from the crowd in response. Each breath requires effort. Your guard drifts lower and your footwork falters, arms and legs failing you. The round can't end soon enough.","","The referee cups his phone closer to his ear, yelling to make himself heard. \"Tung Loi Lane, right side. You know the one with the... What do you mean which building? The one next to the 7-Eleven! No, the [i]other[/i] 7-Eleven near the roast goose! Forget it, I'm coming down.\"","","The bell clangs. Then again.","","*page_break","The referee finally looks up at the fight, crumbs of [i]char siu bao[/i] still on his shirt. He ambles to centre-ring, taps the mic once, decides it isn't worth fixing, and just talks over the house PA hiss.","","\"Okay la, enough fighting. [i]Aiya[/i], better than last time. Call it a day.\"","","He squints at both of you, flips over a crumpled sheet of paper.","","*if fight_momentum >= 6","    *set match_result \"win\"","*else","    *set match_result \"loss\"","*if match_result = \"win\"","    \"Winner is... ${last_name}.\" He reaches for your hand, but then decides it's too much effort. \"If you want a photo, hurry up. Air-con expensive.\"","*elseif match_result = \"loss\"","    \"Winner is... Lee.\" He reaches for her hand, but then decides it's too much effort. \"If you want a photo, hurry up. Air-con expensive.\"","*else","    *bug Invalid match result","","He nods to himself, then walks off, engrossed in his food delivery logistics. Chloe is already in her corner, wiping her face with a towel like nothing happened.","","You stay standing in the middle of the ring. The canvas feels solid under your feet again. No longer a platform for someone else's performance.","","A smattering of applause. A guy near the front yells \"rematch!\" but sounds reluctant.","","You assumed there'd be another round. But apparently two was enough.","","*choice","    #Accept the violation happened, then work on recovery.","        *gosub_scene utils increase_composure","        What happened was unfair. The referee's negligence, Chloe's violation, the crowd's passivity \u2014 all of it. But you banish the feeling. No point dwelling on it. The damage is superficial: bruised stomach, sore muscles. No internal damage, no problem breathing.","","        You run through some basic combinations, just to get your bearings. Everything's normal.","","        You file the experience under \"environmental hazards\" and move on. In the future, opponents will try to exploit every available angle. But that's for another day. Now: recovery, training, improvement. This match becomes merely another experience. Nothing more.","    #Wonder why she so desperately needs that kind of control over another person.","        *gosub_scene utils increase_empathy","        The physical sensations have faded, but the question lingers: why does she so desperately need this kind of control? You remember Chloe's expression even through the haze of oxygen deprivation. Her intense concentration. How she tracked every shallow breath, welcomed every struggle.","","        But it wasn't sadism. There was no pleasure there, the way she carefully shifted her weight to keep you at the edge of breathlessness. The way she applied different weight distributions, like turning a pressure valve. She moved with your breath. When you tried to tense up, she adjusted instantly. Always keeping you right at the breaking point, but never past it.","","        You don't understand why she needs this. But you recognise that the necessity is there. No, more than that; desperation. Whatever need she's trying to satisfy, this is when she feeds it.","    #Analyse what happened here. The fight, the referee, the venue.","        *gosub_scene utils increase_analysis","        The warning signs were there from the start. They were obvious with hindsight: the referee's casual indifference, checking his phone before the fight. The perfunctory introductions. The crowd reaction to Chloe's entrance, the nervous laughter. They knew. All of this should have triggered more caution. ","","        Your coach's words from before: \"particularly enjoys fighting at The Cauldron.\" His slight pause before \"enjoys\", the way his eyes drifted to the window. You add this to your checklist: the venue matters. Some places hold unwritten rules that only become visible when you're underneath them.","","        Next time, you'll evaluate the referee, read the crowd. The next fight won't have the same conditions, but it will still offer valuable clues about what to expect.","","The crowd begins to leave, metal chairs scraping the floor as people collect betting slips and pick up empty drink cans and food wrappers. The air conditioning continues its disappointed grumble, pushing around sweat-infused air. Chloe approaches you, but the chaos is gone. Now she looks like a security guard shuffling blankly through an inspection round.","","*if match_result = \"win\"","    *set record_wins +1","    She doesn't glare at you. No resentment that you won. Her shoulders are low, relaxed. She wipes her mouth with the back of her glove, studying you carefully, as if you were suddenly worthy of consideration.","","    \"You didn't panic down there,\" she says. \"Most people can't keep it together.\"","*elseif match_result = \"loss\"","    *set record_losses +1","    She doesn't taunt you. Doesn't even look triumphant. Her shoulders are low, relaxed. She wipes her mouth with the back of her glove, studying you carefully, as if you were suddenly worthy of consideration.","","    \"I felt you stop fighting the weight,\" she says. \"Smart. Most people just thrash around.\"","*else","    *bug Invalid match result","She sees something in your expression. \"I didn't break the rules. You knew where you were fighting.\"","","She steps closer, close enough that you can see her neck vein pulsing, still rapid.","","*choice","    #\"That crossed a line. It wasn't fighting any more.\"","        You keep your voice level. \"That crossed a line. It wasn't fighting any more.\"","","        Her face tightens, but she meets your eyes. \"Most people break down. Or they try to pretend nothing happened. You're just... telling me what you think.\" She brushes her hair absently.","","        No apology, but no excuses either. Like she's saying, yes, this is me.","    #\"That could have seriously injured me.\"","        You keep your voice level. \"That could have seriously injured me.\"","","        Her face tightens, uncertain whether you're accusing her or just telling her how you see it. \"But it didn't,\" she says carefully. ","","        She watches your face for a moment, then adds, \"I know when it's too much.\" She brushes some imaginary sweat off her forearm.","","        She doesn't want to focus on what you went through. Only on how she experiences it.","    #\"I'm not judging what happened.\"","        *gosub_scene utils increase_composure","        *set chloe_friendship +1","        You meet her gaze. \"Everyone has their methods. This was yours.\"","    ","        She studies you for a long time. \"Most people need someone to blame,\" she says. \"You're just absorbing it.\"","    *selectable_if (struggle_insight >= 3) #\"You needed to see how I'd react under pressure.\"","        *gosub_scene utils increase_analysis","        *set chloe_friendship +1","        \"You were measuring my response. Shifting your weight according to how I was coping. You were running an experiment.\"","        ","        Her eyes widen slightly before she can catch herself. \"Most people are only trying to survive. You were tracking my adjustments. Even under that pressure.\" A long pause. \"That's... rare.\"","    *selectable_if (struggle_emotional >= 3) #\"You weren't doing it to win. You were looking for something else.\"","        *gosub_scene utils increase_empathy","        *set chloe_friendship +1","        \"You needed to feel something. Pushing someone to their limits. To prove that something real was happening.\"","        ","        Her face goes slack with surprise. Even her breathing stops. Her hands hang at her sides, unmoving.","        ","        \"I \u2014\" She starts, stops. She opens her mouth, but no sound comes out. Her gaze drops to her feet. One hand touches her stomach, lingers there.","        ","        \"You don't know what you're talking about.\" But it's hollow. \"Most people just... they don't...\"","    #Say nothing. Let the moment hang.","        *gosub_scene utils increase_composure","        You don't reply. The silence stretches. You give it space to breathe, space for what happened to just exist without needing explanation. You don't need to process it right now.","    ","        She nods slightly, as if she understands.","","For ten seconds, maybe fifteen, she just watches you. She takes in your stance, your breathing, your hands, like she's reading something she didn't expect to find here.","","Her fingers fumble with the strap on her right glove. Pull. Press. Pull again. She glances at her phone tucked in her waistband, touches it, then lets go. A strand of hair has escaped the gel. She smooths it back, then again when it won't stay. Her weight shifts to her back foot. Forward again. She looks past you towards the exit, where the last stragglers are escaping. For a moment, it looks like she'll walk away.","","Then she looks back at you. She begins tentatively: \"There's this place. Sky Lounge. The Upper House. Different from here.\" She gestures at the cracked mirrors.","","\"Better for conversation. I thought maybe \u2014\" She stops. \"You're new to all this. I could fill in a few gaps.\"","","She pulls a name card from her waistband, slips it to you. \"6PM. Text me the day before. Don't overthink it.\"","","She turns and walks towards the exit quickly, not looking back to see your reaction.","*return"], "labels":{"fight":0,"struggle":218,"round_2":477}},
"chloe_subplot": {"crc":1407149634, "lines":["*label scene_introduction","*if chloe_subplot_scene = 1","    Chloe invited you to the Upper House.","*elseif chloe_subplot_scene = 2","    TODO","*else","    TODO","*return","","*label scene_choice","*if chloe_subplot_scene = 1","    *comment earliest: chapter 5, first fortnight","    *comment chloe_friendship from other events: 0-1 from eric_subplot, event_2","    *comment chloe_friendship from this chapter: 3-4 for accept, 0-2 for reject","    *comment cumulative chloe_friendship after this chapter: 0-5","    *gosub event_1","    *set stat_mental %+6","*elseif chloe_subplot_scene = 2","    *comment earliest: chapter 5, second fortnight","    *comment chloe_friendship from this chapter: []","    *comment cumulative chloe_friendship after this chapter: []","    *gosub event_2","    *comment *set stat/insight etc","*else","    *bug Chloe subplot scene not found","*return","","*label event_1","@{gender_num White dress shirt, grey blazer and chinos, scuffed leather shoes.|Black midi dress, beige cardigan, black patent flats.|Collarless shirt, slim black trousers, leather ankle boots.} The outfit you usually only pull out for the company annual dinner or cousin Winnie's weddings. It fits uncomfortably on you as you ride the MTR to Admiralty.","","Admiralty is a fancy commercial and hotel district, the internationalist face that Hong Kong likes to present to the world. Gleaming skyscrapers, polished glass and steel, stacked and layered on top of each other like a Jenga puzzle gone wrong. A network of elevated walkways infests the shopping complexes and office towers. You could roam the entire area and never touch the ground.","","You stride out of the MTR exit onto the polished marble of the Pacific Place mall, rows and rows of luxury boutiques always empty of shoppers yet always profitable. It's too high-class for even a food court to exist. Several long escalators bring you out for a brief breath of traffic-choked air, then it's up an even fancier set of escalators \u2014 custom handholds, curved tunnel \u2014 to the Upper House hotel.","","This was the place Chloe indicated. Perched above the mere 5-star JW Marriott, the Upper House boasts floor-to-ceiling windows displaying panoramic views of the Hong Kong skyline. You wait in the lift to the lounge level, jasmine scent cloying, as your shoes sink into the thick carpet.","","The lift doors glide open silently, revealing an expansive atrium wrapped in warm almond wood panelling. Mushroom-coloured banquettes dot the marble floor. Weighty art and architecture books anchor the low wooden coffee tables alongside algae-green armchairs with towering backrests. An enormous fireplace, showcasing genuine gas-powered wood logs, is at the far end of the lounge, recessed into a white marble monolith.  The usual crowd of bankers engage in muted conversation, most of them with the hollow stares of expatriates and jet-setters. None of them give you a second glance.","","*page_break","You approach the concierge stand hesitantly, finding there a severe-looking young woman in a power suit. \"Winky\" proclaims the nameplate pinned too high, almost at her collarbone.","","\"Good evening. Do you have a reservation with us tonight?\" she asks, almost succeeding at hiding her distaste for your attire.","","\"Yes.\"","","She looks at you, a tight-lipped smile the only change in her expression.","","\"Oh, right. Sorry. I'm here to see Chloe Lee.\"","","The hint of a raised eyebrow. A pause, a second too long. \"Certainly, please come this way.\" She escorts you through the atrium, staying close like an incident manager. At the threshold to the rooftop lounge, she gestures you through. She's back at reception before you can thank her.","","The Lawn is an elaborate bubble above the city. All around, manicured hedges frame the twilight skyline. Enormous white candles shed their unneeded vanilla fragrance. You walk across flawless, unfeeling stone tiles towards a central seating area, crossing a strip of zen pebbles. A large artificial lawn hosts a concrete fire bowl flanked by hardy C-shaped outdoor sofas. Tuxedoed waiters with silver trays of smoked salmon on blinis drift through the terrace.","","You don't spot Chloe immediately. Instead, you see a young Chinese woman seated on a sofa, leaning comfortably into the cushions. Black hair neatly tucked behind both ears, a small skull earring on one side. A black silk slip dress that hangs easily on her, high neckline, the fabric moving like knives. Legs crossed casually at the ankles, minimalist black leather slides. A small handbag with no logo you can recognise rests on the sofa, while she idly scrolls her well-worn phone.","","You realise this must be the same woman you fought at The Cauldron, even as part of your brain insists it can't be.","","*choice","    #Wonder what it takes to present yourself so differently.","        *gosub_scene utils increase_empathy","        Which one is the real Chloe? Will she transgress boundaries here?","    #Centre yourself. It's still the same Chloe.","        *gosub_scene utils increase_composure","        Unfamiliar environment to you. Familiar environment to her. No matter. Breathe. Relax.","    #Evaluate the difference in her appearance, and what it suggests.","        *gosub_scene utils increase_analysis","        She's comfortable playing different roles. But even here, she's slightly off-kilter. Deliberately or not, you don't know.","","You've stood there unmoving for too long when she looks up. Her smile is a tasting menu of delight, gratitude, and calculation. She sits up straight, commanding the central seat of the C-shaped sofa, and waves you towards the short arm. A low ottoman rests in the curve of the sofa.","","\"All dressed up! I half expected you to show up in boxing gloves.\" The words are sharp, but the edge isn't there. She raises a finger, and a waiter immediately scurries over, sporting a strained smile. Chloe turns to you. \"Would my honoured guest like a drink?\"","","\"Oh. Water please, thank you.\"","*if highest_trait = \"analysis\"","    You notice the waiter came over immediately, like he was assigned to her.","*elseif highest_trait = \"composure\"","    No need to disrupt things just now.","*elseif highest_trait = \"empathy\"   ","    You can feel the tension. Better to make things simple here.","*else","    *bug Invalid highest_trait","She gives an offhand instruction, and the waiter nods quickly and hurries away. You sit carefully on the sofa arm, back straight, palms on your knees.","","\"Actually didn't know if you'd come.\" You look at her to see what she means, but her face has suddenly become unreadable.","","*choice","    #Ask why she invited you here.","        *gosub_scene utils increase_analysis","        Chloe clearly knows how to navigate this social space. But one detail has been occupying your thoughts since you first arrived at this elaborate venue.","","        \"Why did you invite me?\" The question spills out.","","    #Say she's a different person today.","        *gosub_scene utils increase_empathy","        Chloe is at home in this environment, a world away from The Cauldron. You remember the tension in the waiter's eyes. You imagine how much she must need to perform, to be able to navigate such different worlds.","","        \"Why do you want me here?\" Simple and direct.","","    #Remain silent. Wait for her to make the next move.","        *gosub_scene utils increase_composure","        *set chloe_friendship +1","        You maintain your bearing, revealing nothing. You feel the artificial lawn rustle under your shoes, grounding you. This might be her territory, but she asked you here. She's the one who should make the next move.","","        She studies you. Then a small twitch plays on the edges of her lips.","","\"I asked you here because I enjoy your company, of course,\" Chloe says with a smile that could mean anything. \"All this...\" she waves a careless hand at the curated elegance around you, \"it gets tiresome, you know?\"","","\"Must be hard to frequent rooftop lounges all the time.\"","","A clipped laugh from her, more like a cough. Her eyes move past the clump of bankers at an adjacent sofa, gazing at the distant evening skyline. \"You'd be surprised, ${first_name}. I've seen this city from enough rooftops and bars that it all looks the same now.\"","","You're not a part of this world. She is. But the luxury here just seems to bounce off her.","","\"${first_name}, you see that stupid building across the harbour? The one that looks like a giant dildo? My family built that. Those two rectangular towers that look like they're stuck together? Those too.\" Her gaze remains fixed on the skyline, not meeting your eyes.","","*choice","    #Consider what this reveals about her intent.","        *gosub_scene utils increase_analysis","        She's disclosing her wealthy background, but she sounds disdainful, even disgusted by it. It means nothing, and she wants you to know that.","    #Take her perspective to see why she's sharing this.","        *gosub_scene utils increase_empathy","        She's unimpressed by her wealth, or even resentful of it. You sense a profound alienation.","    #Absorb what she's said, but don't rush to respond.","        *gosub_scene utils increase_composure","        The wealth doesn't interest her. It's deep, the disconnection. You don't respond. She'll tell you her reasons soon enough.","","\"Living the dream, right?\" The beginnings of a bitter laugh, which she quickly cuts short. \"Luxury yachts, private jets, exotic holidays.\"","","She sits forward. \"All these people around us, that's what they dream of. But it's more like a cage. I can enjoy helicopter rides to tasting dinners in Macau, but I can't even fight someone who fights back. My Muay Thai coaches are afraid to push me. Wouldn't want the delicate princess to strain a muscle or something. I'm only allowed to have glorified aerobics classes.\"","","The waiter brings you a crystal highball glass of water nestled in a small paper napkin, then retreats.","","Chloe shivers. Might be the wind, but maybe not. Her gaze lingers on your glass, then she takes a short breath and looks right at you. You see steel there.","","\"You're not afraid of me. I want you to train me.\"","","She continues. \"And I could teach you a few things. How people get into your head, how to prevent that. You've got grit, but you don't have the experience.\"","","*choice","    #\"That's a bold ask, considering what you did at the Cauldron. Why should I trust you?\"","        *set chloe_friendship +1","        \"That's a bold ask, considering what you did at the Cauldron. Why should I trust you?\"","","        Chloe doesn't answer immediately, instead directing her gaze to the ottoman between you. Then she speaks without looking at you.","","        \"It's underground fighting. Things happen that wouldn't happen elsewhere. I'm exploiting the rules. I'm not saying I'm an angel. But finding advantages is a legitimate part of fighting. I'm playing to win.\"","","        She meets your eyes, but seeing your expression, she glances away.","","        \"I know how this sounds, but I needed it. It felt like a moment when everything was real, when things mattered.\"","","        She continues. \"You probably had a totally different experience. This crazy bitch is crushing me as part of some twisted game. You're totally justified in feeling that.\"","","        She waits. Not forcing a response, but leaving room for one.","","        *if highest_trait = \"analysis\"","            What she said wasn't an apology. It was a justification. She's explaining why she did it: to see how you'd respond, whether you measured up.","        *elseif highest_trait = \"composure\"","            It was difficult for her to say this. But she said it nevertheless. You acknowledge her effort. Stay silent, give it space.","        *elseif highest_trait = \"empathy\"","            You sense the need, the hunger that drives her. It doesn't excuse her actions. But you understand what she needs: someone who can make her feel real.","        *else","            *bug Invalid highest_trait","    ","        \"You, ${first_name}... you're tough. You didn't crumble. You got up and went for round two.\"","","        She observes you for a moment, lips pursed. \"Why should you trust me after what I did? Good question. Well... I don't fuck people over?\"","","        A pause, like she's realised the irony of her words. \"I guess that sounds like bullshit right now.\"","","        You make a noncommittal [i]hmm[/i], which she takes as a signal to continue. \"I take care of my people though. Mostly.\"","","        \"And most people who can read people like I can, they're dangerous. I'm not, you know, the bad kind of dangerous. I just want... to know I matter?\"","","        *choice","                #\"Okay, I'm willing to give it a try. But if you cross any lines, I'm done.\"","                    *set chloe_friendship +2","                    Chloe leans back, arms crossed. Then she freezes. She processes your words. She breaks into a broad grin, crinkles appearing at the corners of her eyes.","","                    \"Wow, ${first_name}, I was half-expecting... this is great. Thanks. Thanks for accepting. I mean, it's not something you get offered every day. Um.\"","","                    *if highest_trait = \"analysis\"","                        She genuinely didn't expect you to accept her offer. An unexpected development.","                    *elseif highest_trait = \"composure\"","                        A slip of the mask. She wasn't expecting you to accept. You're the calm one now, despite being on her turf.","                    *elseif highest_trait = \"empathy\"","                        She wants to feel something. But she doesn't even know what she wants to feel.","                    *else","                        *bug Invalid highest_trait","                    Now that her hands are unclenched, you realise how tense she was. There are faint red marks where her fingernails dug in. She made the offer even though she was expecting rejection. Maybe she took the risk because she's reckless. No, that can't be right \u2014 everything she did at The Cauldron was calculated. Risking rejection for the slim chance of a 'yes' means she almost never gets chances like this.","","                    Chloe shifts slightly on the sofa, her foot tapping rapidly on the floor. \"It felt scary asking you. I don't usually do stuff like this. Uh... well, let's celebrate! To the future!\"","","                    She summons the waiter again, and you overhear her order some kind of caviar service. Then she looks at you, smile faltering, and fidgets with her earring. \"It's all on my father's tab anyway. Not like he cares about anything.\"","","                    Chloe then takes in a deep breath and stands up abruptly. \"I... need to go. Thanks. I'll be in touch.\" She leaves quickly, stumbling slightly as she crosses the strip of zen pebbles.","","                    You wait a while more, sitting by yourself on the spacious sofa, surrounded by the elite of Hong Kong high society, just letting things settle.","","                    The waiter returns with a silver platter the size of a steering wheel, upon which rests a crystal bowl filled with gleaming black caviar pearls, two tiny silver spoons, and a stack of fluffy blinis. Another waitress arrives with a fold-out service table and carefully arranges the caviar service.","","                    No reason to waste food. You pinch a spoon with your thumb and index finger, scoop a big pile of caviar onto a blini, and pop it into your mouth. It tastes good. You fit in now, with your big caviar.","","            #\"No thanks. I'm not comfortable with this.\"","                *goto event_1_reject","","    #\"No thanks. I'm not getting drawn into your games.\"","        *label event_1_reject","        *set chloe_subplot_status \"rejected\"","","            Chloe's gaze falls to the ground. You see an almost imperceptible pinkness briefly appear on her cheeks, but it fades almost immediately. After just a few seconds, she looks at you again, but her shoulders sag.","","            \"No big deal. My methods can be off-putting. You're being sensible, playing it safe. Expected something like this to happen. Was a long shot anyway.\"","","            She tries to smile, though it comes out as more of a grimace. A slow exhale. Then she crosses her arms, sits up straighter, and slowly looks around the rooftop like she's reminding herself where she is.","","            \"You'll do fine without me. Good luck ${first_name}. Anyway. This is all on my father's tab, order whatever you want. I... I should go. Later.\"","","            She stands, strides to the exit. The nearest group of bankers pause their conversation and intently study the floor, only resuming their talk when she's completely out of sight.","*return","","*label event_2","    ### Event 2: Training Session & Psychological Lesson","    #### Part 1: Physical Training","    - **Location**: Private training studio in a high-rise tower. Empty, clean, expensive. Cold lighting. No spectators, no mirrors.","    - **Genuine sparring**: PC provides real resistance she craves","        PC gets to choose intensity level: cautious / match pace / challenge her.","        Outcome reflects mutual respect: she praises technique or resilience or read.","        Chloe notices how hard the PC went.","    #### Part 2: Psychological Training","    - \u201cThat\u2019s the body. Now I want to see what your mind does under pressure.\u201d","        She explains her theory of control: \u201cEveryone flinches. Everyone gives something away. I want to show you where it happens.\u201d","        Proposes the stomach-standing exercise. Not coercive, but deliberately strange. Framed as psychological calibration, not strength.","            - Chloe\u2019s tone isn\u2019t seductive or threatening \u2014 it's clinical or exploratory.","            - She says that she won't be controlling your breath.","            - Strange on purpose: The act is intentionally unconventional, even unsettling \u2014 that\u2019s part of its function. She wants the player to register that it\u2019s not normal. That\u2019s what makes it interesting.","            - Justified as calibration: She frames it like she\u2019s tuning an instrument. She wants to observe how the PC\u2019s body and mind respond to pressure.","        - **Key choice point**: PC can accept or decline","            - **Accept**: Opens romance path, maintains power dynamic","            - **Decline**: Friendship path, she respects boundary and adjusts method","            - (Optional third: Substitute \u2192 offer to spar blindfolded / timed breath drills instead \u2014 a way to reassert control)","","    #### Part 3: Interiority and commentary","    - Chloe begins \u201creading\u201d people aloud \u2014 Eric, Katie, Danny \u2014 while gauging PC\u2019s breath/reactions. It's part analysis, part performance.","        PC can interject, challenge her, or internalise.","        Depending on trait, PC interprets her motive differently (detached observation, hunger for validation, or experimental curiosity).","","    #### Part 4: Closing beat","    - She steps off. Says something like:","        \u201cNext time, I\u2019ll let you stand on me. Deal?\u201d","        - PC can respond seriously, sarcastically, or say nothing.","    - On exit, Chloe hesitates \u2014 shows a flash of vulnerability.","        - \u201cThat meant something to me. Don\u2019t tell anyone.\u201d","","*return"], "labels":{"scene_introduction":0,"scene_choice":9,"event_1":27,"event_1_reject":207,"event_2":221}},
"training_montages": {"crc":399702103, "lines":["*label power","*rand dieroll 0 2","*if dieroll = 0","    He holds pads and doesn't speak. Doesn't flinch. Just watches.","","    You start light. Testing range, rhythm, breath. No reaction.","","    You hit harder. Sharpen the hook. Snap the cross. Breathing quicker. He still doesn't move.","","    No feedback. Just the pads, held perfectly still, as if mocking the idea of progress.","","    Stance tighter, hips loaded, angles cleaner. Again. And again. Until your lungs rasp and your arms go heavy.","","    Then one lands. A left hook, full weight behind it. Something loose and ugly in the torque.","","    The pad shifts. Just a little.","","    He nods, once.","","*elseif dieroll = 1","    The afternoon light cuts golden rectangles across the gym floor as Coach Lam points to your lead hand. \"Show me your hook.\" You rotate your hips and throw the hook, gloved fist thumping against his focus mitt from the side.","","    \"Again.\"","","    You continue throwing hooks. Two seconds. Two seconds. He just absorbs the impact. \"Again,\" he repeats. ","","    You throw another, feeling your weight shift through your hips, your fist travelling the same arc it has for the past ten minutes. Your muscles burn \u2014 slow, grinding fire with every hook.","","    Your form collapses. Elbow drops. Wrist bends. Hip rotation falters. Your coach taps your elbow with the mitt. Next hook is better. Knuckles vertical, elbow at ninety degrees, arm horizontal, hip rotating, lead foot pivoting. A nice [i]smack[/i] against the pad. Then another. Another.","","    The rectangles of light have dimmed, and your hook has evolved into pure muscle memory, bypassing thought entirely. Your coach steps back, nodding. \"Tomorrow we do your other hand,\" he says, peeling off the mitt like it's just another day.","","*elseif dieroll = 2","    Sweat stings your eyes. You blink hard, smear your forearm across your face. Half an hour of cardio. Three rounds of mitts. Two sparring sessions. A desperate, satisfying pull from your water bottle, blessed relief glugging down your parched throat.","","    You're mid-stretch, leaning into a deep lunge, when Coach Lam points to the heavy bag in the corner. Doesn't speak. Just walks away.","","    The leather is torn in places, shredded fabric spilling from a long tear. You start to punch. One-two. One-two-one-two.","","    Your fists feel like soaked meat, and the bag doesn't care. You keep punching. Your shoulders go. Then your legs. Your hands too. No, wait. They're still moving.","","    You're just knocking politely now.","","    Then: \"Good.\" That's the only word you hear all day.","*else","    *bug invalid dieroll","*return","","*label technique","*rand dieroll 0 2","*if dieroll = 0","    You draw chalk circles on the gym mat. Two feet wide. One for each foot. \"Stay inside,\" Coach Lam says. \"No wasted motion.\"","","    You shadowbox. Jab cross hook. Slip left. Duck, roll right. The circles are too small. Your feet feel shackled. Your rear foot smudges the chalk.","","    He shakes his head.","","    You reset. Ankles ache. Your hips can't rotate. You're too upright. The angles are all wrong. You're punching like your joints are gears.","","    Your foot slips again.","","    \"Nope.\"","","    Eventually, you stop looking at the lines. You feel them instead, each time you pivot. Your weight flows. The jab extends gently, clean and direct.","","    Your coach says nothing. Just nods, barely.","","*elseif dieroll = 1","    The gym is quiet except for the metronome. Click. Jab. Click. Cross. Your breath syncs to the beat, sharp and fast. You're shadowboxing. Like a torturous version of that arcade game where you stomp coloured arrows in time \u2014 except the lights are off, and the only feedback is sweat.","","    The tempo quickens. Click jab click cross. Coach motions for footwork now. You start switching your feet in place \u2014 front foot back, back foot forward \u2014 over and over. The Ali shuffle. Click shuffle shuffle. Pointless in a fight. Perfect for tempo.","","    You're in the groove. The tempo slows, but you stay locked in. You don't have to think any more. Your hips twist without waiting for permission. Your jab slips out like an Octopus tap, smooth and automatic. You glance at your coach. He's already turning the dial.","*elseif dieroll = 2","    You're told to mirror another fighter's form exactly. Not spar, just mimic. Same combos, same timing, same angles.","","    At first, it's like copying brushstrokes in a script you can't read. The rhythms are wrong. The distances don't work.","","    But something changes. Your hips twist before your mind catches up. You breathe in. They breathe out.","","    You're not sure where your movements end, where theirs begin. You match their guard, their pivots, their steps. Even when resting, your posture starts to resemble theirs.","","    When the drill ends, you're still holding the stance. Still waiting for their next move.","*else","    *bug invalid dieroll","*return","","*label toughness","*rand dieroll 0 2","*if dieroll = 0","    You sprint the length of the empty Star Ferry terminal. The metal shutters are still down. Ferry horns echo distantly across the harbour like a forgotten alarm clock. At the far end, you slap the concrete pillar. Glimpse your reflection in the plexiglass \u2014 mouth half-open, eyes somewhere else. Fifteen seconds. Then sprint again.","","    No timekeeper. No coach. Just your worn running shoes on the slick floor, the tang of sea brine and diesel exhaust. You run past an elderly man laying out meditation leaflets beneath a printed banner, past the ticket machines, past the chained turnstiles. Fifteen seconds. One more lap.","","    At some point you forget the count. You stop touching the pillar. Your reflection is still there, but you don't look any more. You just run.","","*elseif dieroll = 1","    You run at night, when the humidity clings like syrup and the air barely moves. Past shuttered jade shops, a gaudy ceremonial archway, and electronics stores with dusty display cases and bored shopkeepers eyeing empty streets.","","    A group of old men huddle over a Chinese chess game on plastic stools and a folding table. One glances up, then nudges his friend. \"Boxer again,\" you hear.","","    The roads narrow in places. You weave between signposts and wayward plastic buckets, a nighttime slalom course. You nearly run into a newsstand stacked high with newspapers and bottled drinks. You wave to the gap-toothed newspaper vendor and keep going.","","    At the fruit market, the crates are being hosed down. Oranges today. Always oranges. Tonight, the citrus scent is in a futile battle against the durian's unstoppable assault.","","    You run faster, not to escape it, but to keep it from settling into your skin.","","*elseif dieroll = 2","    The stairwell smells like damp concrete and mildewed bookshelves. The air doesn't move.","","    You run loops between floors six and fourteen. Down eight flights. Up eight flights. Again.","","    Your footsteps bounce, first from your shoes, then from the walls. The air sticks in your throat. Every slap of sole on a stair sounds like your own echo hunting you.","","    You lose count, but not pace. You register the turns without looking. Your breathing is heavy in the silence. Thighs start to burn, knees begin to click. But the rhythm holds.","","    A door creaks open. Someone stares. You don't stop.","","*else","    *bug invalid dieroll","*return","","*label mental","*rand dieroll 0 2","*if dieroll = 0","    You dissect the same fight ten times in a row, logging every feint, slip, and failed setup.","","    You start seeing things before they unfold. Movements look wrong now, even when they land.","","    That night, you dream in slow motion and miss your stop on the train.","*elseif dieroll = 1","    The gym is a mess of noise today. Cantopop from three decades ago blares from a tinny speaker. Someone nearby performs calisthenics while yelling \"Yah!\" at full volume. Coach Lam doesn't seem to notice.","","    He fires instructions over the noise: \"One two! Slip left! Hook! No no, jab-jab-hook! Roll! Step out!\"","","    You try to follow; already a new set of orders. \"One two one two! Uppercut! Angle out! Jab jab! Why are you square?!\"","","    Three minutes later, your brain's fried. Your gloves don't know where they're going.","","    But somehow, your feet stayed moving. The rhythm got through. Nothing else did.","*elseif dieroll = 2","    The gym lights hum like flies. Coach Lam has you shadowbox while five kids run around screaming nonsense. One recites items from the [i]cha chaan teng[/i] menu. Another is definitely making up words.","","    It's stupid. It's chaotic. And yet your footwork smooths out. The noise stops mattering. You start hearing only your breath and the floor.","","    When the bell rings, you don't stop right away. You didn't hear it.","*else","    *bug invalid dieroll","*return","","*label eric","*if ((eric_plot_timer = 0) and (eric_subplot_status = \"available\"))","    *rand dieroll 0 3","*else","    *rand dieroll 0 1","*if dieroll = 0","    Your water bottle drips with condensation, forming a ring of water where it meets the table. You move the bottle aside and stare at the circle for too long, visualising the energy diagram Eric once sketched in quick, confident strokes. Circular, flowing, imperfect. You run a fingertip along the water, smudging it into a flat loop.","    ","    The air conditioning drops to an idling hum. You trace the circle again, slower. Trying to feel what Eric meant.","","    There's no sudden flash of insight. You wait.","","    A faint pulse travels through your shoulder. Maybe muscle memory. It doesn't feel like understanding, but your hand traces the same path again. ","","*elseif dieroll = 1","    You sit cross-legged on the wooden floorboards, the waxed boards smooth under your thighs. Hands on knees, palms up. Eyes closed. Eric said when you breathed this way, you could feel the energy flowing.","","    A minute of stillness. The edge of something, hairs rising on your forearms. Then a [i]krrk-krrk-screee[/i] from above, plastic chair scraping the floor. A voice, harsh and irritable.","","    You let it pass over you and through you. A breath. Another.","","    Warmth accumulates in your chest. Your breathing slows. The warmth spreads outwards, through your arms, through your legs. Not something to control, just something to notice.","","    You stay.","","    Your head feels heavy as you lift it. Eyes open. Half an hour gone, somehow. You remember Eric saying that beginners lose track of time. You don't agree.","","*elseif dieroll = 2","    Evening at Eastside Combat Club. The air conditioning rumbles quietly, while fluorescent lights cast long shadows across the mats. A small MMA group in the corner finishes their padwork. It smells of clean sweat tonight. Even the perspiration is disciplined.","","    Eric has you spar an energetic teenage boxer. Gloves on gloves. He watches from the edge of the ring, arms crossed. Doesn't say anything between rounds, doesn't offer any advice.","","    After the second round, you glance over at him. \"Thoughts?\" you ask.","","    He takes a step closer. \"You're punching like you want to impress. Not like you believe.\"","","    You nod.","","    Next round, your punches aren't stronger. They're quieter. You remember something Eric said: don't punch with your hand, punch with your heart. Still doesn't make sense.","","    The teenager dominates the entire round. But you don't mind.","    ","*elseif dieroll = 3","    Evening at Eastside Combat Club. The air conditioning hums steadily, mixing the scents of clean leather and fresh tape wraps. A few stragglers are finishing their stretches and packing their gym bags.","","    Eric stands in the middle of the mats, one fist held out straight. Occasional flames rise from his fist, the air shimmering like torchfire. The flames start to lessen, then fade.","","    You wait. He doesn't acknowledge you. Deep in concentration. The insistent beeping of the timer drifts from the far side of the gym.","","    He turns slightly and nods at you. You stand beside him and raise your fist, matching his posture. The flames reappear around his fist, rhythmic and even. Nothing happens with yours.","","    You continue to hold the pose. After a few seconds, your wrist warms. Not heat. More like pressure. Like your hand is meeting the air, becoming part of it.","","    Eric glances at you. \"Don't push,\" he says. \"Just notice it.\"","","    You note the warmth for a few more seconds before it departs. Just a fist now. But you feel a faint tingling at the outer edge of your hand.","","    You stay still for a few seconds longer. Whatever it was, it didn't last.","","*else","    *bug invalid dieroll","*return","","*label katie","*if ((katie_plot_timer = 0) and (katie_subplot_status = \"available\"))","    *rand dieroll 0 3","*else","    *rand dieroll 0 1","*if dieroll = 0","    You sit cross-legged on the wooden floor, spine resting against the edge of your bed. One hand cradles the dense rubber ball Katie provided you, its surface studded with short metal prongs that bite faintly into your palm.","","    Outside, rain taps gently against the window, a muffled rhythm that barely registers. Above, a chair scrapes across the floor \u2014 [i]krrk... chk... scree[/i] \u2014 then falls quiet again.","","    You press the ball to your forearm, the metal studs sharp and unyielding against skin. At first, nothing. Then a flare of electric needles that make your teeth clench involuntarily.","","    You note the signal. The sensation is real, but it doesn't require a response.","","    You roll the ball along your forearm, pressing muscle into bone, a patient, deliberate line from wrist to elbow and back again. Your arm begins to feel strange. Not numb, exactly, but off, like something's disconnected and waiting for input.","","    The ball falls into your lap. You rest your arms, tracking the phantom signals still echoing from your nerves.","","    You flex your fingers once. Normal function restored.","","*elseif dieroll = 1","    Late evening. The office is silent, long since emptied. The fluorescent light casts a low, exhausted glow over the rows of abandoned desks.","","    You adjust your chair, cranking it too high. Your monitor wakes with a soft whir. You rest one hand on the mouse, wrist hovering unsupported. The other rests on the keyboard, drawn by muscle memory.","","    Your spine curves forward gradually. The chair's cheap foam compresses beneath you, offering no support. You don't correct it.","","    You type and click: not words, just gibberish. Nonsense on a blank document. The familiar aches return: stiffness locking your fingers, pressure building in your wrist, the pinch between the shoulders. Your jaw clenches without needing an invitation.","","    It's a slow accumulation. Discomfort layered upon discomfort. Not enough to drown, just enough to soak through everything.","","    You name each signal quietly: the tension in your lower back, the dull throb behind your eyes, numbness creeping into your left foot. And when the discomfort peaks, when your body wants to escape \u2014 you stay.","","    One breath. Slow.","","    Then you close the document. Power down the computer.","","    No stretch. Just stand. Walk away.","","*elseif dieroll = 2","    Dimmed lab room, after hours. Curtains drawn, overhead lights dim. The table supports a tray lined with tuning forks, dowels, heat packs.","","    Katie points to the chair without looking up. Presses the first dowel to your forearm.","","    \"Three.\"","","    She nods once, writes it down.","","    She moves methodically through the tools \u2014 dull pressure that sinks deep but doesn't cut, sudden heat that makes you flinch, low vibrations that travel through bone. Each time, you state a number. She adjusts. She writes it down.","","    Halfway through, she pauses. \"This one might spike,\" she says. \"Breathe through it.\" Katie's hand steadies your wrist. Contact. A sharp edge. You keep still, exhale.","","    You call it \"five.\"","","    She glances at you. \"Really?\"","","    Her face reveals nothing. No accusation. But she doesn't write it down. Repositions the dowel, slower this time. Not doubting your answer, just tracking the gap between your words and your reaction.","","    She doesn't believe your \"five.\" Not enough to challenge it. Just enough to check again.","","    When it's over, she starts packing the tray. You both stay silent as she seals the equipment bag.","","*elseif dieroll = 3","    HKU rooftop, dusk. The skyline glows amber and violet, concrete towers melting into shadow. A gentle wind drifts across the concrete. Katie arrives without a word, sets down her duffel bag, and kneels to tape a sensor to your palm. Her fingers steady your wrist as she smooths the tape. Brief touch. No eye contact.","","    \"Arms up. Hold.\"","","    You raise both arms to shoulder height. Katie stays kneeling, gaze fixed on the biometric scanner. The skyline deepens to rose, then steel-grey. The wind picks up, stirring dust across the concrete.","","    A slight burn spreads through your shoulders.","","    Barely audible: \"Most people give up before ten minutes. Not from pain. Just from the doubt, the idea that they're doing it wrong.\"","","    When your arms start to drop, she stands behind you and adjusts your posture with one hand on your upper back. The contact is light. Her hand stays a moment too long. No adjustment, no pretext.","","    The scanner beeps. Fifteen minutes.","","    She peels the tape from your skin, then sits beside the gear. \"I'll send you the results,\" she says.","","    You don't leave right away. Neither does she. The skyline dims.","*else","    *bug invalid dieroll","*return","","*label danny","*rand dieroll 0 0","*if dieroll = 0","    TODO","*elseif dieroll = 1","    TODO","*else","    *bug invalid dieroll","*return","","*label chloe","*rand dieroll 0 0","*if dieroll = 0","    TODO","*elseif dieroll = 1","    TODO","*else","    *bug invalid dieroll","*return","","*label rest","*rand dieroll 0 8","*if dieroll = 0","    You board the ferry to Cheung Chau with no gear, no plan. The benches are slick with sea spray and the air smells like diesel, algae, and fishballs. You pace along the weathered railing and watch the water churn as the wind rustles your face. Inside, a baby cries. A quiet hiss as someone opens a can of drink.","","    You wait for the press of bodies to thin before you step onto the pier. Tourists file dutifully into seafood restaurants, while couples rent bicycles and share tofu pudding. You drift past, ignoring the stalls and the ice cream freezers with their condensation-slicked glass tops, heading inland through narrow alleys where laundry flaps on metal wires and the stonework breaks, fades. ","","    You pause at a tiny shop where the rusted fan rattles above a scratched glass counter, air stirring reluctantly like pedestrians at a crowded crossing. The only indication that it's open is the shopkeeper, squatting lazily, who doesn't look up from his racing newspaper, only motioning his head towards the fridge when you ask. You hand over a ten-dollar coin and take a bottle of Dahongpao oolong tea, barely cold enough. Outside, you twist the cap and sip. It tastes like every school trip you barely remember.","","    A breeze slips through the alleys now and then. Outside a 7-Eleven, a boy shadowboxes at your reflection in the window. One-two, awkward uppercut. You nod, not sure if you're smiling or not.","","    You find a mossy stone bench with a view of the village. You practise your breathing drills without thinking. Air in, air out, slow and even. It feels right.","","*elseif dieroll = 1","    You sleep late. No alarm. Dreamless sleep. A small wet patch of drool on your pillow, like a tiny rebellion. You finally open your eyes, seeing how the room is too quiet. Outside, the sharp squeal from a lorry's compression brakes cuts through the midday stillness. A metal gate slams, two floors down.","","    Eventually, you shuffle to the kitchen, chalky toothpaste still coating the inside of your cheeks. The thin plastic crinkles as you rescue the bundle of vermicelli from the wrapper. Boiled for a minute less than it says to. You don't bother to look for the seasoning packet. Just soy sauce, a dull orange bowl, wooden chopsticks flame-blackened at the tips. It's chewy, but still hard at the centre.","","    You sit against the wall, phone propped on your gym bag, old cartoons streaming. The speakers buzz valiantly. You sneeze, a quick thing. \"Bless you,\" the priest in the cartoon says, you think.","","    Your knuckles throb like they're proud of themselves. Your hamstrings sigh in relief. You let them have the moment.","","    The cartoon loops. You don't notice at first. Then you do.","*elseif dieroll = 2","    You drift through Ladies' Market, registering the packed stalls with their corrugated iron roofs claiming the roadway. Bare bulbs overhead, bright and unnatural. The air's heavy, crowded by the colourful pyjamas, basketball jerseys, \"I \u2764 HK\" T-shirts, and incorrect designer bags. A tourist haggles over plastic keychains but doesn't buy. Shopkeeper shrugs. ","","    There's only room for two abreast. You stop at a table stacked with cheap punching pads. Red vinyl, shiny and flaking. Thin foam. You press your thumb into one. It doesn't resist. You imagine hitting it with a full power cross, your coach's hand collapsing before he flings it into the rubbish. You nod at the shopkeeper and move on.","","    Fluorescent light blasts your vision. A young woman, ring light haloing her head, moves backwards, livestreaming. Too much subtle makeup. She has a ballet shoe in one hand, pressed to her face like a vintage telephone. \"Only 88 yuan for this genuine quality shoe! Only 50 yuan more \u2014 to make it a pair.\" ","","    The sweet scent of egg-waffle batter passes by, once, but you can't see the [i]gai daan jai[/i] cart anywhere. Somewhere ahead of you, someone yells \"Buy one get one!\" in three languages at once. You keep walking.","*elseif dieroll = 3","    You board the double-decker tram in Sheung Wan, just to sit still. It's one of those new ones with the air conditioning and the friendly driver. Empty tram, so you get the front row seat on the upper deck. Plastic windscreen in front of you, wide and clean. The seat's hard plastic is sun-warmed but still a bit cold on your thighs.","","    The tram starts with a jerk and the distinctive bell. Ding ding... ding. Every brass note feels like it's marking the end of a round. You don't count them, but your body does.","","    The tram meanders east, barely faster than a brisk jog. You crack open a window. Humid air, but at least it's moving. You read somewhere that air-con is bad for you. Can't be worse than the Wan Chai exhaust. ","","    Half a dozen kids in green-and-orange school uniforms climb up and scatter a few rows behind you. Their bulging schoolbags thump onto the floor. They argue about whether something evolves at level 20 or 40 \u2014 you don't catch the name, just the urgency. You're not close enough to hear, and that feels right.","","    The streets roll by: kudzu drink, a former pawn shop turned tourist trap, Mega Monster Burger. Fortress Hill: polished leather designer sofas in showroom windows, mocking the rabbit hutches packed high above.","","    You ride the line all the way to the end. Quarry Bay again. The tram empties. No one tells you to leave, but you do. Eastside? Not today. You walk west, in silence. Not for a reason. Just for the illusion of one.","*elseif dieroll = 4","    The MTR sways gently as it pulls away from Sham Shui Po. You're seated, arms crossed, drifting in and out of awareness as the train rocks rhythmically. The man next to you has a wrinkled brown takeaway bag at his feet, greased half-translucent at the bottom. You think you saw it fall. Maybe. He's engrossed in his phone, stabbing the glass with quick, practised jabs.","","    When the train pulls in at Mei Foo, he rises and adjusts his belt. Just before the doors open, you grab the wrapper and extend it to him. \"You dropped this,\" you say. His eyes flick to it, then to you. His face tightens. His ears twitch. \"Thanks,\" he mutters, pinching it lightly before disappearing into the crowd.","","    The doors hiss shut. You shift back into your seat. A woman says, \"That wrapper was there before he got on.\" She doesn't look at anyone in particular. You don't say anything.","","    The overhead lights flicker for a moment. Your reflection reappears in the glass pane turned mirror: a tidy silhouette, holding nothing, sitting a little too upright.","","*elseif dieroll = 5","    You stroll through the wet market starting from the Wan Chai end. Bowrington Road in late afternoon. Water runs constantly. Hoses flushing guts and meat bits into the gutter, fish splashing water out of their polystyrene crates, block ice and crushed ice melting beneath the geoduck clams, mist spraying over fruit displays.","","    You avoid the biggest puddles, even though your shoes are already damp. You register the coriander. Sharp. Raw pork hangs dense in the air, its damp smell cut by the metallic tang of fish blood. You remember, long ago, a friend who acted tough. Got halfway through and his face turned pale green, had to pinch his nostrils closed and breathe through his mouth. Doesn't churn your stomach now. Just another stimulus to tune out.","","    A woman claps mechanically. Says her pomelos can outlast the others. A lean man in a red plastic apron slits a chicken's throat with a single clean cut. No, that can't be, they banned live chickens after the avian flu. You look again. He's only chopping headless birds along joint lines. Must have misread the movement.","","    You don't need to think. Your legs keep moving. Plastic tubs of oyster meat, bundles of razor clams tied with plastic twine. You're tempted by the Shine Muscat grapes. Chinese, not Japanese. Still sweet enough to pretend they're the real ones.","","    Ahead, Times Square looms \u2014 glass, stone, a giant TV above the plaza tuned to a cable news channel. You cross when the light changes. A woman hands you a yoga flyer. You take it without looking. You don't stop walking.","*elseif dieroll = 6","    The garden path in Victoria Park loops gently, the low shrubs and small clearings creating pockets of quiet within the retail frenzy of Causeway Bay. There's a pleasant scent of roasted chicken and sambal from the semicircle of Indonesian maids on their day off. Couples sit on wooden benches, enjoying advanced bubble tea concoctions. A toddler trips. Quick swivel of her head. Parents see her. She wails.","","    You take the long way, past the pond with the drowsy turtles stacked three high. A koi swims in the tea-coloured water. Wind rustles through the manicured trees.","","    The garden opens onto an ordered grid of sports fields. Dozens of football pitches, asphalt and mostly empty. A group of lanky schoolboys are on one, kicking a tired football with more enthusiasm than skill. The thump and clang of 3-on-3 basketball comes from behind the concrete divider. You notice your weight shifting. Right foot to left. You're moving with the dribbling without meaning to. It takes a few steps before you even register it.","","    You pass through the park's gate with the Queen Victoria statue. You cross the road to the library, wrong shape for a fight. No clean approach angles. No stance worth taking.","","    Greek pillars collide against modernist steel and plate glass, interrupted by windows shaped like pop-up ads. Huge. Imposing. Somehow flimsy.","","    You stand under the oversized logo-window, feet shoulder width apart. A long breath \u2014 slow in, slower out, body resetting to neutral. The kind you take before a round starts. You don't go in. You keep walking.","","*elseif dieroll = 7","    You sit in a [i]cha chaan teng[/i] near the end of a tram line. Not a nice one. The kind with hard plastic benches, sugar in dented metal cans, table still damp from a half-hearted swipe with a grey rag.","","    You don't look at the menu. You just say \"B1\", like it's the only thing that makes sense. The waitress nods without writing anything down.","","    Someone's transistor radio crackles with race results from Sha Tin. A grunt of disappointment from the corner booth. Your tea arrives first, Hong Kong style, much too strong. You stir in a teaspoon of sugar. Sweet and astringent. You take another sip.","","    Then the set: macaroni in broth, pan-fried spam slice, two pieces of folded ham. A fried egg resting on top. On another plate, a thick slice of toasted white bread charring on the faces, and a thin coat of melted butter. Filling. Honest.","","    No one talks. Behind the glass, cars ease past, indifferent to pedestrians. You chew slowly, half-watching, half somewhere else. The egg yolk breaks onto the spam, turning it glossy. You finish it all.","","    When the waitress brings the bill, she calls you \"boss\" like she might've known you once. You nod, leave exact change on the scratched glass counter, and leave quietly.","*elseif dieroll = 8","    You get off the bus at the Cross Harbour Tunnel. The engine noise fades behind you as it pulls away, leaving diesel fumes hanging in the humid air. You cross the footbridge towards Poly University. No students around on the weekend.","","    You walk without purpose. Past the plaza where students hand out flyers, now littered with only a few leaflets from a kendo club recruitment drive. Five young women in pink T-shirts practice K-pop routines, phone on a tripod recording everything.","","    The campus feels like a stage waiting for the actors to come back. Chairs in neat rows. Umbrellas furled. Everything ready, but the performers have abandoned the show.","","    You take the overpass out towards the main road. The metal grating wasn't always there. You thrum your fingers along the edge as you pass. It's welded tight. One more thing added after things got heated.","","    Pedestrians drift past in both directions, earbuds in, eyes on phones. You hear your own footsteps too clearly. The sound of people alone, together.","","    You keep walking. Past the places where things used to happen.","*else","    *bug invalid dieroll","*return"], "labels":{"power":0,"technique":48,"toughness":87,"mental":122,"eric":150,"katie":213,"danny":297,"chloe":307,"rest":317}},
"upgrades": {"crc":1080673679, "lines":["*label spend_insight_choices","*gosub check_whether_can_spend_insight","*if (can_spend_insight)","    Something shifted this month. Not just endurance or reflex. A pattern noticed. A mistake corrected. A moment that clicked.","","    You've gained insight into the rhythm of fights \u2014 the tells, the pauses, the space between motion and intent.","","    Some techniques feel more accessible now. Like they've been waiting for you to notice.","","    *gosub choose_where_to_spend_insight","    *if boxing_insights > 0","        You pause. Another adjustment presents itself \u2014 less obvious, but ready.","        *gosub choose_where_to_spend_insight","","    *if boxing_insights > 0","        You trace the arc of another fight in your head. One more refinement reveals itself.","        *gosub choose_where_to_spend_insight","*else","    You carry ${boxing_insights} unspent [i]Boxing Insights[/i].","    ","    But none of your techniques are ready to absorb it. It lingers, unresolved. A lesson waiting for a form.","*page_break","*return","","*label check_whether_can_spend_insight","*set can_spend_insight False","","*if (jab_level = 0)","    *if (stat_technique >= 20)","        *set jab_upgradeable True","        *set can_spend_insight True","*elseif (jab_level = 1)","    *if (stat_technique >= 40)","        *set jab_upgradeable True","        *set can_spend_insight True","","*if (flurry_level = 0)","    *if ((stat_technique >= 15) and (stat_toughness >= 15))","        *set flurry_upgradeable True","        *set can_spend_insight True","*elseif (flurry_level = 1)","    *if ((stat_technique >= 30) and (stat_toughness >= 30))","        *set flurry_upgradeable True","        *set can_spend_insight True","","*if (combo_level = 0)","    *if ((stat_technique >= 15) and (stat_mental >= 15))","        *set combo_upgradeable True","        *set can_spend_insight True","*elseif (combo_level = 1)","    *if ((stat_technique >= 30) and (stat_mental >= 30))","        *set combo_upgradeable True","        *set can_spend_insight True","*elseif (combo_level = 2)","    *if ((stat_technique >= 45) and (stat_mental >= 45))","        *set combo_upgradeable True","        *set can_spend_insight True","","*if (ultimate_level = 0)","    *if ((stat_power >= 15) and (stat_mental >= 15))","        *set ultimate_upgradeable True","        *set can_spend_insight True","*elseif (ultimate_level = 1)","    *if ((stat_power >= 30) and (stat_mental >= 30))","        *set ultimate_upgradeable True","        *set can_spend_insight True","","*if (block_level = 0)","    *if (stat_toughness >= 20)","        *set block_upgradeable True","        *set can_spend_insight True","*elseif (block_level = 1)","    *if (stat_toughness >= 40)","        *set block_upgradeable True","        *set can_spend_insight True","","*if (parry_level = 0)","    *if ((stat_technique >= 15) and (stat_mental >= 15))","        *set parry_upgradeable True","        *set can_spend_insight True","*elseif (parry_level = 1)","    *if ((stat_technique >= 30) and (stat_mental >= 30))","        *set parry_upgradeable True","        *set can_spend_insight True","*elseif (parry_level = 2)","    *if ((stat_technique >= 45) and (stat_mental >= 45))","        *set parry_upgradeable True","        *set can_spend_insight True","","*if (dodge_level = 0)","    *if ((stat_mental >= 15) and (stat_toughness >= 15))","        *set dodge_learnable True","        *set can_spend_insight True","*elseif (dodge_level = 1)","    *if ((stat_mental >= 30) and (stat_toughness >= 30))","        *set dodge_upgradeable True","        *set can_spend_insight True","*elseif (dodge_level = 2)","    *if ((stat_mental >= 45) and (stat_toughness >= 45))","        *set dodge_upgradeable True","        *set can_spend_insight True","","*if (counter_level = 0)","    *if (stat_mental >= 20)","        *set counter_learnable True","        *set can_spend_insight True","*elseif (counter_level = 1)","    *if (stat_mental >= 40)","        *set counter_upgradeable True","        *set can_spend_insight True","*elseif (counter_level = 2)","    *if (stat_mental >= 60)","        *set counter_upgradeable True","        *set can_spend_insight True","*return","","*label choose_where_to_spend_insight","*choice","    *if (jab_upgradeable) #Sharpen your jab.","        You revisit the jab \u2014 not as a placeholder, but as a lead. The timing's tighter. The contact lands clean.","        *gosub upgrade_jab","","    *if (flurry_upgradeable) #Refine your flurry.","        You tweak the cadence. It's no longer just speed \u2014 it's layered pressure, staggered beats.","        *gosub upgrade_flurry","","    *if (combo_upgradeable) #Adapt your combinations.","        You see new links between moves. One flows into the next. Less guessing, more reading.","        *gosub upgrade_combo","","    *if (ultimate_upgradeable) #Tune your ultimate.","        The big finish sharpens. Less brute force. More inevitability.","        *gosub upgrade_ultimate","","    *if (block_upgradeable) #Reinforce your guard.","        Blocking becomes active, not reactive. You meet impact with structure, not flinch.","        *gosub upgrade_block","","    *if (parry_upgradeable) #Fine-tune your parry.","        You stop waiting to react. You meet the incoming with intent, not hope.","        *gosub upgrade_parry","","    *if (dodge_learnable) #Learn to slip.","        Your body starts answering without asking. Space opens where there was none.","        *gosub upgrade_dodge","","    *if (dodge_upgradeable) #Deepen your evasions.","        Your dodges thread through attacks, not away from them. A step ahead, not behind.","        *gosub upgrade_dodge","","    *if (counter_learnable) #Learn to counter.","        You start to see the gaps before they happen. An opening is no longer luck.","        *gosub upgrade_counter","","    *if (counter_upgradeable) #Sharpen your timing.","        The return strike doesn't wait. It arrives before they realise they missed.","        *gosub upgrade_counter","","*return","","*label upgrade_jab","*set boxing_insights -1","*if (jab_level = 0)","    *set jab_level 1","    *set jab \"[i]Sharp Jab[/i]\"","*elseif (jab_level = 1)","    *set jab_level 2","    *set jab \"[i]Tuned Jab[/i]\"","*return","","*label upgrade_flurry","*set boxing_insights -1","*if (flurry_level = 0)","    *set flurry_level 1","    *set flurry \"[i]Fast Combination[/i]\"","*elseif (flurry_level = 1)","    *set flurry_level 2","    *set flurry \"[i]Timed Flurry[/i]\"","*return","","*label upgrade_combo","*set boxing_insights -1","*if (combo_level = 0)","    *set combo_level 1","    *set combo \"[i]Standard Combo[/i]\"","*elseif (combo_level = 1)","    *set combo_level 2","    *set combo \"[i]Adaptive Chain[/i]\"","*elseif (combo_level = 2)","    *set combo_level 3","    *set combo \"[i]Layered Sequence[/i]\"","*return","","*label upgrade_ultimate","*set boxing_insights -1","*if (ultimate_level = 0)","    *set ultimate_level 1","    *set ultimate \"[i]Set Piece Strike[/i]\"","*elseif (ultimate_level = 1)","    *set ultimate_level 2","    *set ultimate \"[i]Fight-Ender[/i]\"","*return","","*label upgrade_block","*set boxing_insights -1","*if (block_level = 0)","    *set block_level 1","    *set block \"[i]Basic Guard[/i]\"","*elseif (block_level = 1)","    *set block_level 2","    *set block \"[i]Read-and-Shell[/i]\"","*return","","*label upgrade_parry","*set boxing_insights -1","*if (parry_level = 0)","    *set parry_level 1","    *set parry \"[i]Guided Parry[/i]\"","*elseif (parry_level = 1)","    *set parry_level 2","    *set parry \"[i]Displacement Touch[/i]\"","*elseif (parry_level = 2)","    *set parry_level 3","    *set parry \"[i]Flow Intercept[/i]\"","*return","","*label upgrade_dodge","*set boxing_insights -1","*if (dodge_level = 0)","    *set dodge_level 1","    *set dodge \"[i]Basic Slip[/i]\"","*elseif (dodge_level = 1)","    *set dodge_level 2","    *set dodge \"[i]Ghost Step[/i]\"","*elseif (dodge_level = 2)","    *set dodge_level 3","    *set dodge \"[i]Untouchable Rhythm[/i]\"","*return","","*label upgrade_counter","*set boxing_insights -1","*if (counter_level = 0)","    *set counter_level 1","    *set counter \"[i]Basic Counter[/i]\"","*elseif (counter_level = 1)","    *set counter_level 2","    *set counter \"[i]Snapping Return[/i]\"","*elseif (counter_level = 2)","    *set counter_level 3","    *set counter \"[i]Interrupt Window[/i]\"","*return"], "labels":{"spend_insight_choices":0,"check_whether_can_spend_insight":24,"choose_where_to_spend_insight":116,"upgrade_jab":160,"upgrade_flurry":170,"upgrade_combo":180,"upgrade_ultimate":193,"upgrade_block":203,"upgrade_parry":213,"upgrade_dodge":226,"upgrade_counter":239}},
"utils": {"crc":704258740, "lines":["*comment This displays a 1-liner stat bar","*label show_stats","*gosub calc_adj_stats","","Power: [b]${adj_power}[/b] (${stat_power}) | Technique: [b]${adj_technique}[/b] (${stat_technique}) | Toughness: [b]${adj_toughness}[/b] (${stat_toughness}) | Mental: [b]${adj_mental}[/b] (${stat_mental}) | Energy: [b]${stat_energy}%[/b]","*return","","*comment calculate the stats after adjustment for less than 100% energy","*label calc_adj_stats","*gosub clamp_energy","*temp energy_adjustment (1 - ((100 - stat_energy) * 0.005))","*set adj_power round(stat_power * energy_adjustment)","*set adj_technique round(stat_technique * energy_adjustment)","*set adj_toughness round(stat_toughness * energy_adjustment)","*set adj_mental round(stat_mental * energy_adjustment)","*return","","*comment clamp energy values at 0-100","*label clamp_energy","*if (stat_energy > 100)","   *set stat_energy 100","*if (stat_energy < 0)","   *set stat_energy 0","*return","","*label increase_analysis","*set trait_analysis +1","*gosub update_highest_trait","*return","","*label increase_composure","*set trait_composure +1","*gosub update_highest_trait","*return","","*label increase_empathy","*set trait_empathy +1","*gosub update_highest_trait","*return","","*label update_highest_trait","*temp highest_value 0","*if (trait_analysis > highest_value)","    *set highest_value trait_analysis","*if (trait_composure > highest_value)","    *set highest_value trait_composure","*if (trait_empathy > highest_value)","    *set highest_value trait_empathy","","*if (trait_analysis = highest_value)","    *set highest_trait \"analysis\"","*elseif (trait_composure = highest_value)","    *set highest_trait \"composure\"","*else","    *set highest_trait \"empathy\"","*set highest_trait_num highest_value","*return","","*comment sets trait_bonus_applied if the highest trait is the same as the param","*label calculate_trait_bonus","*params trait_type","*if (trait_type = \"analysis\")","    *if (highest_trait = \"analysis\")","        *set trait_bonus_applied trait_bonus_amount","    *else","        *set trait_bonus_applied 0","*elseif (trait_type = \"composure\")","    *if (highest_trait = \"composure\")","        *set trait_bonus_applied trait_bonus_amount","    *else","        *set trait_bonus_applied 0","*elseif (trait_type = \"empathy\")","    *if (highest_trait = \"empathy\")","        *set trait_bonus_applied trait_bonus_amount","    *else","        *set trait_bonus_applied 0","*else","    *bug Incorrect trait parameter passed","*return","","*label tick_character_cooldowns","*set eric_plot_timer -1","*if (eric_plot_timer < 0)","    *set eric_plot_timer 0","*set katie_plot_timer -1","*if (katie_plot_timer < 0)","    *set katie_plot_timer 0","*set danny_plot_timer -1","*if (danny_plot_timer < 0)","    *set danny_plot_timer 0","*set chloe_plot_timer -1","*if (chloe_plot_timer < 0)","    *set chloe_plot_timer 0","*return","","*label fortnight_choice","*choice","    #Train power with heavy bag work.","        *gosub_scene training_montages power","        *set stat_power %+8","        *set stat_energy -20","        *gosub_scene utils clamp_energy","    #Refine boxing technique with precision drills.","        *gosub_scene training_montages technique","        *set stat_technique %+8","        *set stat_energy -20","        *gosub_scene utils clamp_energy","    #Build stamina with running and conditioning.","        *gosub_scene training_montages toughness","        *set stat_toughness %+8","        *set stat_energy -20","        *gosub_scene utils clamp_energy","    #Practise visualisation and fight strategy.","        *gosub_scene training_montages mental","        *set stat_mental %+8","        *set stat_energy -20","        *gosub_scene utils clamp_energy","    *if (unlocked_eric_training) #Practise energy awareness meditation.","        *gosub_scene training_montages eric","        *set stat_mental %+3","        *set stat_technique %+3","        *set stat_energy -10","        *gosub_scene utils clamp_energy","    *if (unlocked_katie_training) #Train pressure point resistance.","        *gosub_scene training_montages katie","        *set stat_toughness %+3","        *set stat_mental %+3","        *set stat_energy -10","        *gosub_scene utils clamp_energy","    *if (unlocked_danny_training) #Danny option.","        *gosub_scene training_montages danny","        *set stat_power %+3","        *set stat_mental %+3","        *set stat_energy -10","        *gosub_scene utils clamp_energy","    *if (unlocked_chloe_training) #Chloe Option.","        *gosub_scene training_montages chloe","        *set stat_mental %+6","        *set stat_technique %+2","        *set stat_energy -20","        *gosub_scene utils clamp_energy        ","    #Rest and recover","        *gosub_scene training_montages rest","        *set stat_energy +30    ","        *gosub_scene utils clamp_energy","*page_break","*return","","*label character_visit_options","*comment reduce the character cooldowns first. This is the first subroutine visited by the chapters","*gosub_scene utils tick_character_cooldowns","","*if (eric_subplot_status = \"available\")","    *gosub_scene eric_subplot scene_introduction","","*if (katie_subplot_status = \"available\")","    *gosub_scene katie_subplot scene_introduction","","*if (danny_subplot_status = \"available\")","    *gosub_scene danny_subplot scene_introduction","","*if (chloe_subplot_status = \"available\")","    TODO","    *comment *gosub_scene chloe_subplot scene_introduction","*return","","*label character_visit_choice","*choice","    *if ((eric_subplot_status = \"available\") and (eric_plot_timer = 0)) #Visit Eric","        *gosub_scene eric_subplot scene_choice","        *set eric_subplot_scene + 1","","    *if ((katie_subplot_status = \"available\") and (katie_plot_timer = 0)) #Visit Katie","        *gosub_scene katie_subplot scene_choice","        *set katie_subplot_scene + 1","","    *if ((danny_subplot_status = \"available\") and ((danny_plot_timer = 0) and (danny_subplot_scene = 1))) #Search for Danny","        *gosub_scene danny_subplot scene_choice","        *set danny_subplot_scene +1","","    *if ((danny_subplot_status = \"available\") and ((danny_plot_timer = 0) and not(danny_subplot_scene = 1))) #Visit Danny","        *gosub_scene danny_subplot scene_choice","        *set danny_subplot_scene +1","","    *if ((chloe_subplot_status = \"available\") and (chloe_plot_timer = 0)) #Visit Chloe","        TODO","        *comment *gosub_scene chloe_subplot scene_choice","        *set chloe_subplot_scene + 1","","    #Don't visit anyone (+Energy)","        *set stat_energy +10","        *gosub_scene utils clamp_energy","        You decide to keep to yourself this month. While this gives you more free time, you miss the opportunity to expand your network in the fighting scene. You'll have to rely solely on what you learn from your regular training.","*page_break","*return","","*label show_fight_momentum","*if (fight_momentum <= 0)","    ${first_name} \u25cb\u25cb\u25cb\u25cb\u25cb\u25cb\u25cb\u25cb\u25cb\u25cb ${fight_opponent_name}","*elseif (fight_momentum = 1)","    ${first_name} \u25cf\u25cb\u25cb\u25cb\u25cb\u25cb\u25cb\u25cb\u25cb\u25cb ${fight_opponent_name}","*elseif (fight_momentum = 2)","    ${first_name} \u25cf\u25cf\u25cb\u25cb\u25cb\u25cb\u25cb\u25cb\u25cb\u25cb ${fight_opponent_name}","*elseif (fight_momentum = 3)","    ${first_name} \u25cf\u25cf\u25cf\u25cb\u25cb\u25cb\u25cb\u25cb\u25cb\u25cb ${fight_opponent_name}","*elseif (fight_momentum = 4)","    ${first_name} \u25cf\u25cf\u25cf\u25cf\u25cb\u25cb\u25cb\u25cb\u25cb\u25cb ${fight_opponent_name}","*elseif (fight_momentum = 5)","    ${first_name} \u25cf\u25cf\u25cf\u25cf\u25cf\u25cb\u25cb\u25cb\u25cb\u25cb ${fight_opponent_name}","*elseif (fight_momentum = 6)","    ${first_name} \u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cb\u25cb\u25cb\u25cb ${fight_opponent_name}","*elseif (fight_momentum = 7)","    ${first_name} \u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cb\u25cb\u25cb ${fight_opponent_name}","*elseif (fight_momentum = 8)","    ${first_name} \u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cb\u25cb ${fight_opponent_name}","*elseif (fight_momentum = 9)","    ${first_name} \u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cb ${fight_opponent_name}","*elseif (fight_momentum >= 10)","    ${first_name} \u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf ${fight_opponent_name}","*else","    *bug Invalid fight_momentum","*return"], "labels":{"show_stats":1,"calc_adj_stats":8,"clamp_energy":18,"increase_analysis":25,"increase_composure":30,"increase_empathy":35,"update_highest_trait":40,"calculate_trait_bonus":59,"tick_character_cooldowns":80,"fortnight_choice":95,"character_visit_options":148,"character_visit_choice":166,"show_fight_momentum":196}}}</script><script>
;

;
//
// Copyright (c) 2008, 2009 Paul Duncan (paul@pablotron.org)
// 
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
// 
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
//


/* 
 * The contents of gears_init.js; we need this because Chrome supports
 * Gears out of the box, but still requires this constructor.  Note that
 * if you include gears_init.js then this function does nothing.
 */
(function() {
  // We are already defined. Hooray!
  if (window.google && google.gears)
    return;

  // factory 
  var F = null;

  // Firefox
  if (typeof GearsFactory != 'undefined') {
    F = new GearsFactory();
  } else {
    // IE
    try {
      F = new ActiveXObject('Gears.Factory');
      // privateSetGlobalObject is only required and supported on WinCE.
      if (F.getBuildInfo().indexOf('ie_mobile') != -1)
        F.privateSetGlobalObject(this);
    } catch (e) {
      // Safari
      if ((typeof navigator.mimeTypes != 'undefined')
           && navigator.mimeTypes["application/x-googlegears"]) {
        F = document.createElement("object");
        F.style.display = "none";
        F.width = 0;
        F.height = 0;
        F.type = "application/x-googlegears";
        document.documentElement.appendChild(F);
      }
    }
  }

  // *Do not* define any objects if Gears is not installed. This mimics the
  // behavior of Gears defining the objects in the future.
  if (!F)
    return;

  // Now set up the objects, being careful not to overwrite anything.
  //
  // Note: In Internet Explorer for Windows Mobile, you can't add properties to
  // the window object. However, global objects are automatically added as
  // properties of the window object in all browsers.
  if (!window.google)
    google = {};

  if (!google.gears)
    google.gears = {factory: F};
})();

/**
 * Persist - top-level namespace for Persist library.
 * @namespace
 */
Persist = (function() {
  var VERSION = '0.2.0', P, B, esc, init, empty, ec;

  // easycookie 0.2.1 (pre-minified)
  // (see http://pablotron.org/software/easy_cookie/)
  ec = (function(){var EPOCH='Thu, 01-Jan-1970 00:00:01 GMT',RATIO=1000*60*60*24,KEYS=['expires','path','domain'],esc=escape,un=unescape,doc=document,me;var get_now=function(){var r=new Date();r.setTime(r.getTime());return r;}
var cookify=function(c_key,c_val){var i,key,val,r=[],opt=(arguments.length>2)?arguments[2]:{};r.push(esc(c_key)+'='+esc(c_val));for(i=0;i<KEYS.length;i++){key=KEYS[i];if(val=opt[key])
r.push(key+'='+val);}
if(opt.secure)
r.push('secure');return r.join('; ');}
var alive=function(){var k='__EC_TEST__',v=new Date();v=v.toGMTString();this.set(k,v);this.enabled=(this.remove(k)==v);return this.enabled;}
me={set:function(key,val){var opt=(arguments.length>2)?arguments[2]:{},now=get_now(),expire_at,cfg={};if(opt.expires){cfg.expires=new Date(now.getTime()+opt.expires*RATIO);cfg.expires=cfg.expires.toGMTString();}
var keys=['path','domain','secure'];for(i=0;i<keys.length;i++)
if(opt[keys[i]])
cfg[keys[i]]=opt[keys[i]];var r=cookify(key,val,cfg);doc.cookie=r;return val;},has:function(key){key=esc(key);var c=doc.cookie,ofs=c.indexOf(key+'='),len=ofs+key.length+1,sub=c.substring(0,key.length);return((!ofs&&key!=sub)||ofs<0)?false:true;},get:function(key){key=esc(key);var c=doc.cookie,ofs=c.indexOf(key+'='),len=ofs+key.length+1,sub=c.substring(0,key.length),end;if((!ofs&&key!=sub)||ofs<0)
return null;end=c.indexOf(';',len);if(end<0)
end=c.length;return un(c.substring(len,end));},remove:function(k){var r=me.get(k),opt={expires:EPOCH};doc.cookie=cookify(k,'',opt);return r;},keys:function(){var c=doc.cookie,ps=c.split('; '),i,p,r=[];for(i=0;i<ps.length;i++){p=ps[i].split('=');r.push(un(p[0]));}
return r;},all:function(){var c=doc.cookie,ps=c.split('; '),i,p,r=[];for(i=0;i<ps.length;i++){p=ps[i].split('=');r.push([un(p[0]),un(p[1])]);}
return r;},version:'0.2.1',enabled:false};me.enabled=alive.call(me);return me;}());

  // wrapper for Array.prototype.indexOf, since IE doesn't have it
  var index_of = (function() {
    if (Array.prototype.indexOf)
      return function(ary, val) { 
        return Array.prototype.indexOf.call(ary, val);
      };
    else
      return function(ary, val) {
        var i, l;

        for (i = 0, l = ary.length; i < l; i++)
          if (ary[i] == val)
            return i;

        return -1;
      };
  })();


  // empty function
  empty = function() { };

  /**
   * Escape spaces and underscores in name.  Used to generate a "safe"
   * key from a name.
   *
   * @private
   */
  esc = function(str) {
    return 'PS' + str.replace(/_/g, '__').replace(/ /g, '_s');
  };

  C = {
    /* 
     * Backend search order.
     * 
     * Note that the search order is significant; the backends are
     * listed in order of capacity, and many browsers
     * support multiple backends, so changing the search order could
     * result in a browser choosing a less capable backend.
     */ 
    search_order: [
      // TODO: air
      'steamworksStorage',
      'cefStorage',
      'winOldStorage',
      'winStoreStorage',
      'macStorage',
      'iosStorage',
      'localChromeStorage',
      'androidStorage',
      'indexed_db',
      'whatwg_db', 
      'localstorage',
      'globalstorage', 
      'cookie',
      'gears',
      'ie', 
      'flash'
    ],

    // valid name regular expression
    name_re: /^[a-z][a-z0-9_ -]+$/i,

    // list of backend methods
    methods: [
      'init', 
      'get', 
      'set', 
      'remove', 
      'load', 
      'save'
      // TODO: clear method?
    ],

    // sql for db backends (gears and db)
    sql: {
      version:  '1', // db schema version

      // XXX: the "IF NOT EXISTS" is a sqlite-ism; fortunately all the 
      // known DB implementations (safari and gears) use sqlite
      create:   "CREATE TABLE IF NOT EXISTS persist_data (k TEXT UNIQUE NOT NULL PRIMARY KEY, v TEXT NOT NULL)",
      get:      "SELECT v FROM persist_data WHERE k = ?",
      set:      "INSERT INTO persist_data(k, v) VALUES (?, ?)",
      remove:   "DELETE FROM persist_data WHERE k = ?" 
    },

    // default flash configuration
    flash: {
      // ID of wrapper element
      div_id:   '_persist_flash_wrap',

      // id of flash object/embed
      id:       '_persist_flash',

      // default path to flash object
      path: 'persist.swf',
      size: { w:1, h:1 },

      // arguments passed to flash object
      args: {
        autostart: true
      }
    } 
  };

  // built-in backends
  B = {
    // gears db backend
    // (src: http://code.google.com/apis/gears/api_database.html)
    gears: {
      // no known limit
      size:   -1,

      test: function() {
        // test for gears
        return (window.google && window.google.gears) ? true : false;
      },

      methods: {
        transaction: function(fn) {
          var db = this.db;

          // begin transaction
          db.execute('BEGIN').close();

          // call callback fn
          fn.call(this, db);

          // commit changes
          db.execute('COMMIT').close();
        },

        init: function() {
          var db;

          // create database handle (TODO: add schema version?)
          db = this.db = google.gears.factory.create('beta.database');

          // open database
          // from gears ref:
          //
          // Currently the name, if supplied and of length greater than
          // zero, must consist only of visible ASCII characters
          // excluding the following characters:
          //
          //   / \ : * ? " < > | ; ,
          //
          // (this constraint is enforced in the Store constructor)
          db.open(esc(this.name));

          // create table
          db.execute(C.sql.create).close();
        },

        get: function(key, fn, scope) {
          var r, sql = C.sql.get;

          // if callback isn't defined, then return
          if (!fn)
            return;

          // begin transaction
          this.transaction(function (t) {
            var is_valid, val;
            // exec query
            r = t.execute(sql, [key]);

            // check result and get value
            is_valid = r.isValidRow();
            val = is_valid ? r.field(0) : null;

            // close result set
            r.close();

            // call callback
            fn.call(scope || this, is_valid, val);
          });
        },

        set: function(key, val, fn, scope) {
          var rm_sql = C.sql.remove,
              sql    = C.sql.set, r;

          // begin set transaction
          this.transaction(function(t) {
            // exec remove query
            t.execute(rm_sql, [key]).close();

            // exec set query
            t.execute(sql, [key, val]).close();
            
            // run callback (TODO: get old value)
            if (fn)
              fn.call(scope || this, true, val);
          });
        },

        remove: function(key, fn, scope) {
          var get_sql = C.sql.get;
              sql = C.sql.remove,
              r, val = null, is_valid = false;

          // begin remove transaction
          this.transaction(function(t) {
            // if a callback was defined, then get the old
            // value before removing it
            if (fn) {
              // exec get query
              r = t.execute(get_sql, [key]);

              // check validity and get value
              is_valid = r.isValidRow();
              val = is_valid ? r.field(0) : null;

              // close result set
              r.close();
            }

            // exec remove query if no callback was defined, or if a
            // callback was defined and there was an existing value
            if (!fn || is_valid) {
              // exec remove query
              t.execute(sql, [key]).close();
            }

            // exec callback
            if (fn)
              fn.call(scope || this, is_valid, val);
          });
        } 
      }
    }, 

    steamworksStorage: {
      size:   -1,

      test: function() {
        try {
          return (typeof require !== "undefined" && require('steamworks.js'));
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {

        },

        get: function(key, fn, scope) {
          key = this.key(key);

          // if callback isn't defined, then return
          if (!fn)
            return;

          // get callback scope
          scope = scope || this;

          try {
            results = steamworks.cloud.readFile("store" + key);
            // steamworks.js fails with "" when the file doesn't exist
            if (results === "") return fn.call(scope, !"ok");
            var fixedResults = results.replace(/^.*\n/, "");
            if (!fixedResults.length) return fn.call(scope, !"ok");
            fn.call(scope, "ok", results.replace(/^.*\n/, ""));
          } catch (e) {
            fn.call(scope, !"ok");
          }
        },

        set: function(key, val, fn, scope) {
          key = this.key(key);
          scope = scope || this;
          var ok = steamworks.cloud.writeFile("store" + key, key+"\n"+val);
          if (fn) fn.call(scope, ok);
          return val;
        },

        // begin remove transaction
        remove: function(key, fn, scope) {
          key = this.key(key);
          scope = scope || this;
          var ok = steamworks.cloud.deleteFile("store" + key);
          if (fn) fn.call(scope, ok);
        }
      }
    },

    cefStorage: {
      size:   -1,

      test: function() {
        return !!window.cefQuery;
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {

        },

        query: function(method, paramString, callback) {
          cefQuery({request:method+" "+paramString,
            onSuccess: function(response) {
              callback(true, response);
            },
            onFailure: function(error_code, error_message) {
              console.error(method + " error: " + error_message);
              callback(false);
            }
          });
        },

        get: function(key, fn, scope) {
          key = this.key(key);

          // if callback isn't defined, then return
          if (!fn)
            return;

          // get callback scope
          scope = scope || this;

          this.query("StorageGet", key, function(ok, results) {
            fn.call(scope, ok, results);
          });
        },

        set: function(key, val, fn, scope) {
          key = this.key(key);
          scope = scope || this;
          this.query("StorageSet", key + " " + val, function(ok){
            if (fn) fn.call(scope, ok, val);
          });
          return val;
        },

        // begin remove transaction
        remove: function(key, fn, scope) {
          key = this.key(key);
          scope = scope || this;
          this.query("StorageRemove", key, function(ok) {
            // return original value? meh
            if (fn) fn.call(scope, ok);
          });
        }
      }
    },

    indexed_db: {
      size: -1,
      test: function() {
        return window.indexedDB;
      },
      methods: {
        promisifyRequest: function (request) {
          return new Promise(function(resolve, reject) {
            request.oncomplete = request.onsuccess = function() { resolve(request.result) };
            request.onabort = request.onerror = function() { reject(request.error) };
          });
        },

        init: function() {
          var request = indexedDB.open(this.name);
          request.onupgradeneeded = function () { return request.result.createObjectStore('PersistJS'); };
          var dbp = this.promisifyRequest(request);
          this.getStore = function (txMode, callback) {
            return dbp.then(function (db) {
              return callback(db.transaction('PersistJS', txMode).objectStore('PersistJS'));
            });
          };
        },

        get: function (key, fn, scope) {
          scope = scope || this;
          var self = this;
          this.getStore('readonly', function(store) {
            self.promisifyRequest(store.get(key)).then(function (val) {
              fn.call(scope, true, val);
            })
          }).catch(function(error) {
            console.error(error);
            fn.call(scope, false);
          })
        },

        set: function (key, val, fn, scope) {
          scope = scope || this;
          var self = this;
          this.getStore('readwrite', function (store) {
            store.put(val, key);
            self.promisifyRequest(store.transaction).then(function () {
              if (fn) fn.call(scope, true, val);
            })
          }).catch(function (error) {
            console.error(error);
            if (fn) fn.call(scope, false);
          })
        },

        remove: function (key, val, fn, scope) {
          scope = scope || this;
          var self = this;
          this.getStore('readwrite', function (store) {
            store.delete(key);
            self.promisifyRequest(store.transaction).then(function () {
              if (fn) fn.call(scope, true);
            })
          }).catch(function (error) {
            console.error(error);
            if (fn) fn.call(scope, false);
          })
        },

      },
    },

    // whatwg db backend (webkit, Safari 3.1+)
    // (src: whatwg and http://webkit.org/misc/DatabaseExample.html)
    whatwg_db: {
      // size based on DatabaseExample from above (should I increase
      // this?)
      size:   200 * 1024,

      test: function() {
        var name = 'PersistJS Test', 
            desc = 'Persistent database test.';

        // test for openDatabase
        if (!window.openDatabase)
          return false;

        // make sure openDatabase works
        // XXX: will this leak a db handle and/or waste space?
        if (!window.openDatabase(name, C.sql.version, desc, B.whatwg_db.size))
          return false;

        // return true
        return true;
      },

      methods: {
        transaction: function(fn) {
          // lazy create database table;
          // this is done here because there is no way to
          // prevent a race condition if the table is created in init()
          if (!this.db_created) {
            this.db.transaction(function(t) {
              // create table
              t.executeSql(C.sql.create, [], function() {
                this.db_created = true;
              });
            }, empty); // trap exception
          } 

          // execute transaction
          this.db.transaction(fn);
        },

        init: function() {
          // create database handle
          this.db = openDatabase(
            this.name, 
            C.sql.version, 
            this.o.about || ("Persistent storage for " + this.name),
            this.o.size || B.whatwg_db.size 
          );
        },

        get: function(key, fn, scope) {
          var sql = C.sql.get;

          // if callback isn't defined, then return
          if (!fn)
            return;

          // get callback scope
          scope = scope || this;

          // begin transaction
          this.transaction(function (t) {
            t.executeSql(sql, [key], function(t, r) {
              if (r.rows.length > 0)
                fn.call(scope, true, r.rows.item(0)['v']);
              else
                fn.call(scope, false, null);
            });
          });
        },

        set: function(key, val, fn, scope) {
          var rm_sql = C.sql.remove,
              sql    = C.sql.set;

          // begin set transaction
          this.transaction(function(t) {
            // exec remove query
            t.executeSql(rm_sql, [key], function() {
              // exec set query
              t.executeSql(sql, [key, val], function(t, r) {
                // run callback
                if (fn)
                  fn.call(scope || this, true, val);
              });
            });
          });

          return val;
        },

        // begin remove transaction
        remove: function(key, fn, scope) {
          var get_sql = C.sql.get;
              sql = C.sql.remove;

          this.transaction(function(t) {
            // if a callback was defined, then get the old
            // value before removing it
            if (fn) {
              // exec get query
              t.executeSql(get_sql, [key], function(t, r) {
                if (r.rows.length > 0) {
                  // key exists, get value 
                  var val = r.rows.item(0)['v'];

                  // exec remove query
                  t.executeSql(sql, [key], function(t, r) {
                    // exec callback
                    fn.call(scope || this, true, val);
                  });
                } else {
                  // key does not exist, exec callback
                  fn.call(scope || this, false, null);
                }
              });
            } else {
              // no callback was defined, so just remove the
              // data without checking the old value

              // exec remove query
              t.executeSql(sql, [key]);
            }
          });
        } 
      }
    }, 
    
    // globalstorage backend (globalStorage, FF2+, IE8+)
    // (src: http://developer.mozilla.org/en/docs/DOM:Storage#globalStorage)
    // https://developer.mozilla.org/En/DOM/Storage
    //
    // TODO: test to see if IE8 uses object literal semantics or
    // getItem/setItem/removeItem semantics
    globalstorage: {
      // (5 meg limit, src: http://ejohn.org/blog/dom-storage-answers/)
      size: 5 * 1024 * 1024,

      test: function() {
        try {
          if (window.globalStorage && window.globalStorage[this.o.domain]) return true;
        } catch (e) {}
        return false;
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = globalStorage[this.o.domain];
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          if (fn)
            fn.call(scope || this, true, this.store.getItem(key));
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          this.store.setItem(key, val);

          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          // get value
          val = this.store[key];

          // delete value
          this.store.removeItem(key);

          if (fn)
            fn.call(scope || this, (val !== null), val);
        } 
      }
    }, 
    
    // localstorage backend (globalStorage, FF2+, IE8+)
    // (src: http://www.whatwg.org/specs/web-apps/current-work/#the-localstorage)
    // also http://msdn.microsoft.com/en-us/library/cc197062(VS.85).aspx#_global
    localstorage: {
      // (unknown?)
      // ie has the remainingSpace property, see:
      // http://msdn.microsoft.com/en-us/library/cc197016(VS.85).aspx
      size: -1,

      test: function() {
        try {
          return window.localStorage ? true : false;
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = localStorage;
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          if (fn)
            fn.call(scope || this, true, this.store.getItem(key));
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          this.store.setItem(key, val);

          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          // get value
          val = this.store.getItem(key);

          // delete value
          this.store.removeItem(key);

          if (fn)
            fn.call(scope || this, (val !== null), val);
        } 
      }
    }, 

    // chrome packaged app storage
    // http://developer.chrome.com/stable/apps/storage.html
    localChromeStorage: {
      // (unknown?)
      // ie has the remainingSpace property, see:
      // http://msdn.microsoft.com/en-us/library/cc197016(VS.85).aspx
      size: -1,

      test: function() {
        try {
          return window.chrome && window.chrome.storage && window.chrome.storage.local;
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = chrome.storage.local;
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          scope = scope || this;
          this.store.get(key, function(val){
            if (fn) fn.call(scope, true, val[key]);
          });
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          var out = {};
          out[key] = val;
          if (fn) {
            scope = scope || this;  
            this.store.set(out, function(){
              fn.call(scope, true, val);
            });
          } else {
            this.store.set(out);
          }
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          if (fn) {
            // get value first
            scope = scope || this;
            this.store.get(key, function(val){
              this.store.remove(key, function(){
                fn.call(scope, (val[key] !== null), val[key]);
              });
            });
          } else {
            this.store.remove(key);
          }
        } 
      }
    }, 
    
    // DGF Fake local storage
    androidStorage: {
      // (unknown?)
      // ie has the remainingSpace property, see:
      // http://msdn.microsoft.com/en-us/library/cc197016(VS.85).aspx
      size: -1,

      test: function() {
        try {
          return window.androidStorage ? true : false;
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = androidStorage;
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          var val = this.store.getItem(key);
          if (val === undefined) val = null;

          if (fn)
            fn.call(scope || this, true, val);
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          this.store.setItem(key, val);

          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          // get value
          val = this.store.getItem(key);
          if (val === undefined) val = null;

          // delete value
          this.store.removeItem(key);

          if (fn)
            fn.call(scope || this, (val !== null), val);
        } 
      }
    }, 

    // DGF iOS managed storage
    iosStorage: {
      size: -1,

      test: function() {
        try {
          var userAgent = navigator.userAgent;
          return (window.isIosApp || (/CoGnibus/.test(userAgent) && !/Android/.test(userAgent))) ? true : false;
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {

        },

        callIos: function(scheme, path) {
          if (typeof webkit !== "undefined" && webkit.messageHandlers) {
            return webkit.messageHandlers.choicescript.postMessage([scheme, path]);
          }
          path = encodeURIComponent(path).replace(/[!~*')(]/g, function(match) {
            return "%" + match.charCodeAt(0).toString(16);
          });

          var url = scheme + "://" + path;
          setTimeout(function() {
            var iframe = document.createElement("IFRAME");
            iframe.setAttribute("src", url);
            iframe.setAttribute("style", "display:none");
            document.documentElement.appendChild(iframe);
            iframe.parentNode.removeChild(iframe);
            iframe = null;
          }, 0);
        },

        get: function(key, fn, scope) {
          if (!fn) return;
          // expand key
          key = this.key(key);

          var nonce = "storageget" + key + (+new Date);
          var i = 0;
          while (window[nonce]) {
            nonce = "storageget" + key + (+new Date) + String(i++);
          }
          window[nonce] = function(value) {
            delete window[nonce];
            fn.call(scope || this, true, value);
          }
          this.callIos("storageget", key + " " + nonce);
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          var nonce = "storageset" + key + (+new Date);
          var i = 0;
          while (window[nonce]) {
            nonce = "storageget" + key + (+new Date) + String(i++);
          }
          window[nonce] = function() {
            delete window[nonce];
            if (fn) fn.call(scope || this, true, val);
          }
          this.callIos("storageset", key + " " + nonce + " " + encodeURIComponent(val));
        },

        remove: function(key, fn, scope) {
          if (fn) {
            this.get(key, function(val) {
              this._remove(key, fn, scope, val);
            }, this);
          } else {
            this._remove(key, fn, scope);
          }
        },

        _remove: function(key, fn, scope, val) {
          var val;

          // expand key
          key = this.key(key);

          // delete value
          var nonce = "storagerem" + key + (+new Date);
          var i = 0;
          while (window[nonce]) {
            nonce = "storageget" + key + (+new Date) + String(i++);
          }
          window[nonce] = function() {
            delete window[nonce];
            if (fn) fn.call(scope || this, (val !== null), val);
          }
          this.callIos("storagerem", key + " " + nonce);
        } 
      }
    }, 

    // DGF macOS managed storage
    macStorage: {
      size: -1,

      test: function () {
        return !!window.isMacApp;
      },

      methods: {
        key: function (key) {
          return esc(this.name) + esc(key);
        },

        init: function () {

        },

        callMac: function (scheme, path) {
          if (typeof webkit !== "undefined" && webkit.messageHandlers) {
            return webkit.messageHandlers.choicescript.postMessage([scheme, path]);
          }
        },

        get: function (key, fn, scope) {
          if (!fn) return;
          // expand key
          key = this.key(key);

          var nonce = "storageget" + key + (+new Date);
          var i = 0;
          while (window[nonce]) {
            nonce = "storageget" + key + (+new Date) + String(i++);
          }
          window[nonce] = function (value) {
            delete window[nonce];
            fn.call(scope || this, true, value);
          }
          this.callMac("storageget", key + " " + nonce);
        },

        set: function (key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          var nonce = "storageset" + key + (+new Date);
          var i = 0;
          while (window[nonce]) {
            nonce = "storageget" + key + (+new Date) + String(i++);
          }
          window[nonce] = function () {
            delete window[nonce];
            if (fn) fn.call(scope || this, true, val);
          }
          this.callMac("storageset", key + " " + nonce + " " + encodeURIComponent(val));
        },

        remove: function (key, fn, scope) {
          if (fn) {
            this.get(key, function (val) {
              this._remove(key, fn, scope, val);
            }, this);
          } else {
            this._remove(key, fn, scope);
          }
        },

        _remove: function (key, fn, scope, val) {
          var val;

          // expand key
          key = this.key(key);

          // delete value
          var nonce = "storagerem" + key + (+new Date);
          var i = 0;
          while (window[nonce]) {
            nonce = "storageget" + key + (+new Date) + String(i++);
          }
          window[nonce] = function () {
            delete window[nonce];
            if (fn) fn.call(scope || this, (val !== null), val);
          }
          this.callMac("storagerem", key + " " + nonce);
        }
      }
    }, 

    // DGF Old win app managed storage
    winOldStorage: {
      size: -1,

      test: function() {
        try {
          return window.external.IsWinOldApp();
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = window.external;
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          if (fn)
            fn.call(scope || this, true, this.store.GetValue(key));
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          this.store.SetValue(key, val);

          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          // get value
          val = this.store.GetValue(key)

          // delete value
          this.store.DeleteValue(key);

          if (fn)
            fn.call(scope || this, (val !== null), val);
        } 
      }
    }, 

      // DGF WinStore managed storage
    winStoreStorage: {
        size: -1,

        test: function () {
            try {
                return Windows.Storage.ApplicationData.current.roamingFolder;
            } catch (e) {
                return false;
            }
        },

        methods: {
            key: function (key) {
                return esc(this.name) + esc(key);
            },

            init: function () {
                var self = this;
                function doneLoadingWinStore() {
                  self.loaded = true;
                  for (var i = self.loadListeners.length - 1; i >= 0; i--) {
                    setTimeout(self.loadListeners[i], 0);
                  }
                }
                this.loaded = false;
                this.loadListeners = [];

                Windows.Storage.ApplicationData.current.roamingFolder
                  .createFileAsync("data.txt", Windows.Storage.CreationCollisionOption.openIfExists)
                  .then(function (file) {
                    self.file = file;
                    return Windows.Storage.FileIO.readTextAsync(file);
                  }).done(function (data) {
                    self.store = {};
                    if (data && typeof data == "string") {
                      var rows = data.split("\n");
                      for (var i = rows.length - 1; i >= 0; i--) {
                        var row = rows[i].split("\t");
                        self.store[row[0]] = decodeURIComponent(row[1]);
                      }
                    }
                    doneLoadingWinStore();
                  },
                  function(){
                    self.store = {};
                    doneLoadingWinStore();
                  });
            },

            get: function (key, fn, scope) {
                if (!this.loaded) {
                  var self = this;
                  this.loadListeners.push(function() {self.get(key, fn, scope)});
                  return;
                }
                // expand key
                key = this.key(key);

                if (fn)
                    fn.call(scope || this, true, this.store[key]);
            },

            set: function (key, val, fn, scope) {
                if (!this.loaded) {
                  var self = this;
                  this.loadListeners.push(function() {self.set(key, val, fn, scope)});
                  return;
                }
                // expand key
                key = this.key(key);

                // set value
                this.store[key] = val;
                this.writeAsync();

                if (fn)
                    fn.call(scope || this, true, val);
            },

            remove: function (key, fn, scope) {
                if (!this.loaded) {
                  var self = this;
                  this.loadListeners.push(function() {self.remove(key, fn, scope)});
                  return;
                }
                var val;

                // expand key
                key = this.key(key);

                // get value
                val = this.store[key];

                // delete value
                delete this.store[key];
                this.writeAsync();

                if (fn)
                    fn.call(scope || this, (val !== null), val);
            },

            writeAsync: function() {
              var output = [];
              for (var key in this.store) {
                output.push(key, '\t', encodeURIComponent(this.store[key]), '\n');
              }
              Windows.Storage.FileIO.writeTextAsync(this.file, output.join(''));
            }
        }
    },

    // IE backend
    ie: {
      prefix:   '_persist_data-',
      // style:    'display:none; behavior:url(#default#userdata);',

      // 64k limit
      size:     64 * 1024,

      test: function() {
        // make sure we're dealing with IE
        // (src: http://javariet.dk/shared/browser_dom.htm)
        return window.ActiveXObject ? true : false;
      },

      make_userdata: function(id) {
        var el = document.createElement('div');

        // set element properties
        // http://msdn.microsoft.com/en-us/library/ms531424(VS.85).aspx 
        // http://www.webreference.com/js/column24/userdata.html
        el.id = id;
        el.style.display = 'none';
        el.addBehavior('#default#userdata');

        // append element to body
        document.body.appendChild(el);

        // return element
        return el;
      },

      methods: {
        init: function() {
          var id = B.ie.prefix + esc(this.name);

          // save element
          this.el = B.ie.make_userdata(id);

          // load data
          if (this.o.defer)
            this.load();
        },

        get: function(key, fn, scope) {
          var val;

          // expand key
          key = esc(key);

          // load data
          if (!this.o.defer)
            this.load();

          // get value
          val = this.el.getAttribute(key);

          // call fn
          if (fn)
            fn.call(scope || this, val ? true : false, val);
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = esc(key);
          
          // set attribute
          this.el.setAttribute(key, val);

          // save data
          if (!this.o.defer)
            this.save();

          // call fn
          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = esc(key);

          // load data
          if (!this.o.defer)
            this.load();

          // get old value and remove attribute
          val = this.el.getAttribute(key);
          this.el.removeAttribute(key);

          // save data
          if (!this.o.defer)
            this.save();

          // call fn
          if (fn)
            fn.call(scope || this, val ? true : false, val);
        },

        load: function() {
          this.el.load(esc(this.name));
        },

        save: function() {
          this.el.save(esc(this.name));
        }
      }
    },

    // cookie backend
    // uses easycookie: http://pablotron.org/software/easy_cookie/
    cookie: {
      delim: ':',

      // 4k limit (low-ball this limit to handle browser weirdness, and 
      // so we don't hose session cookies)
      size: 4000,

      test: function() {
        // XXX: use easycookie to test if cookies are enabled
        return P.Cookie.enabled ? true : false;
      },

      methods: {
        key: function(key) {
          return this.name + B.cookie.delim + key;
        },

        get: function(key, fn, scope) {
          var val;

          // expand key 
          key = this.key(key);

          // get value
          val = ec.get(key);

          // call fn
          if (fn)
            fn.call(scope || this, val != null, val);
        },

        set: function(key, val, fn, scope) {
          // expand key 
          key = this.key(key);

          // save value
          ec.set(key, val, this.o);

          // call fn
          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, val, fn, scope) {
          var val;

          // expand key 
          key = this.key(key);

          // remove cookie
          val = ec.remove(key)

          // call fn
          if (fn)
            fn.call(scope || this, val != null, val);
        } 
      }
    },

    // flash backend (requires flash 8 or newer)
    // http://kb.adobe.com/selfservice/viewContent.do?externalId=tn_16194&sliceId=1
    // http://livedocs.adobe.com/flash/8/main/wwhelp/wwhimpl/common/html/wwhelp.htm?context=LiveDocs_Parts&file=00002200.html
    flash: {
      test: function() {
        // TODO: better flash detection
        if (!window.deconcept || !window.deconcept.SWFObjectUtil)
          return false;

        // get the major version
        var major = deconcept.SWFObjectUtil.getPlayerVersion().major;

        // check flash version (require 8.0 or newer)
        return (major >= 8) ? true : false;
      },

      methods: {
        init: function() {
          if (!B.flash.el) {
            var o, key, el, cfg = C.flash;

            // create wrapper element
            el = document.createElement('div');
            el.id = cfg.div_id;

            // FIXME: hide flash element
            // el.style.display = 'none';

            // append element to body
            document.body.appendChild(el);

            // create new swf object
            o = new deconcept.SWFObject(this.o.swf_path || cfg.path, cfg.id, cfg.size.w, cfg.size.h, '8');

            // set parameters
            for (key in cfg.args)
              o.addVariable(key, cfg.args[key]);

            // write flash object
            o.write(el);

            // save flash element
            B.flash.el = document.getElementById(cfg.id);
          }

          // use singleton flash element
          this.el = B.flash.el;
        },

        get: function(key, fn, scope) {
          var val;

          // escape key
          key = esc(key);

          // get value
          val = this.el.get(this.name, key);

          // call handler
          if (fn)
            fn.call(scope || this, val !== null, val);
        },

        set: function(key, val, fn, scope) {
          var old_val;

          // escape key
          key = esc(key);

          // set value
          old_val = this.el.set(this.name, key, val);

          // call handler
          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // get key
          key = esc(key);

          // remove old value
          val = this.el.remove(this.name, key);

          // call handler
          if (fn)
            fn.call(scope || this, true, val);
        }
      }
    }
  };

  /**
   * Test for available backends and pick the best one.
   * @private
   */
  var init = function() {
    var i, l, b, key, fns = C.methods, keys = C.search_order;

    // set all functions to the empty function
    for (i = 0, l = fns.length; i < l; i++) 
      P.Store.prototype[fns[i]] = empty;

    // clear type and size
    P.type = null;
    P.size = -1;

    // loop over all backends and test for each one
    for (i = 0, l = keys.length; !P.type && i < l; i++) {
      b = B[keys[i]];

      // test for backend
      try {
        if (b.test()) {
          // found backend, save type and size
          P.type = keys[i];
          P.size = b.size;

          // extend store prototype with backend methods
          for (key in b.methods)
            P.Store.prototype[key] = b.methods[key];
        }
      } catch (e) {}
    }

    // mark library as initialized
    P._init = true;
  };

  // create top-level namespace
  P = {
    // version of persist library
    VERSION: VERSION,

    // backend type and size limit
    type: null,
    size: 0,

    // XXX: expose init function?
    // init: init,

    add: function(o) {
      // add to backend hash
      B[o.id] = o;

      // add backend to front of search order
      C.search_order = [o.id].concat(C.search_order);

      // re-initialize library
      init();
    },

    remove: function(id) {
      var ofs = index_of(C.search_order, id);
      if (ofs < 0)
        return;

      // remove from search order
      C.search_order.splice(ofs, 1);

      // delete from lut
      delete B[id];

      // re-initialize library
      init();
    },

    // expose easycookie API
    Cookie: ec,

    // store API
    Store: function(name, o) {
      // verify name
      if (!C.name_re.exec(name))
        throw new Error("Invalid name");

      // XXX: should we lazy-load type?
      // if (!P._init)
      //   init();

      if (!P.type)
        throw new Error("No suitable storage found");

      o = o || {};
      this.name = name;

      // get domain (XXX: does this localdomain fix work?)
      o.domain = o.domain || location.host || 'localhost';
      
      // strip port from domain (XXX: will this break ipv6?)
      o.domain = o.domain.replace(/:\d+$/, '')

      // append localdomain to domains w/o '."
      // (see https://bugzilla.mozilla.org/show_bug.cgi?id=357323)
      // (file://localhost/ works, see: 
      // https://bugzilla.mozilla.org/show_bug.cgi?id=469192)
/* 
 *       if (!o.domain.match(/\./))
 *         o.domain += '.localdomain';
 */ 

      this.o = o;

      // expires in 2 years
      o.expires = o.expires || 365 * 2;

      // set path to root
      o.path = o.path || '/';

      // call init function
      this.init();
    } 
  };

  // init persist
  init();

  // return top-level namespace
  return P;
})();

;
/**
 * alertify
 * An unobtrusive customizable JavaScript notification system
 *
 * @author Fabien Doiron <fabien.doiron@gmail.com>
 * @copyright Fabien Doiron 2012
 * @license MIT <http://opensource.org/licenses/mit-license.php>
 * @link http://fabien-d.github.com/alertify.js/
 * @module alertify
 * @version 0.3.0
 */
(function(e,t){"use strict";var n=e.document,r;r=function(){var r={},i={},s=!1,o={ENTER:13,ESC:27,SPACE:32},u=[],a,f,l,c,h;return i={buttons:{holder:'<nav class="alertify-buttons">{{buttons}}</nav>',submit:'<button type="submit" class="alertify-button alertify-button-ok" id="alertify-ok" />{{ok}}</button>',ok:'<a href="#" class="alertify-button alertify-button-ok" id="alertify-ok">{{ok}}</a>',cancel:'<a href="#" class="alertify-button alertify-button-cancel" id="alertify-cancel">{{cancel}}</a>'},input:'<div class="alertify-text-wrapper"><input type="text" class="alertify-text" id="alertify-text"></div>',message:'<p class="alertify-message">{{message}}</p>',log:'<article class="alertify-log{{class}}">{{message}}</article>'},a=function(e){return n.getElementById(e)},r={labels:{ok:"OK",cancel:"Cancel"},delay:5e3,addListeners:function(r){var i=a("alertify-resetFocus"),s=a("alertify-ok")||t,u=a("alertify-cancel")||t,f=a("alertify-text")||t,l=a("alertify-form")||t,c=typeof s!="undefined",h=typeof u!="undefined",p=typeof f!="undefined",d="",v=this,m,g,y,b,w;m=function(e){typeof e.preventDefault!="undefined"&&e.preventDefault(),y(e),typeof f!="undefined"&&(d=f.value),typeof r=="function"&&r(!0,d)},g=function(e){typeof e.preventDefault!="undefined"&&e.preventDefault(),y(e),typeof r=="function"&&r(!1)},y=function(e){v.hide(),v.unbind(n.body,"keyup",b),v.unbind(i,"focus",w),p&&v.unbind(l,"submit",m),c&&v.unbind(s,"click",m),h&&v.unbind(u,"click",g)},b=function(e){var t=e.keyCode;t===o.SPACE&&!p&&m(e),t===o.ESC&&h&&g(e)},w=function(e){p?f.focus():h?u.focus():s.focus()},this.bind(i,"focus",w),c&&this.bind(s,"click",m),h&&this.bind(u,"click",g),this.bind(n.body,"keyup",b),p&&this.bind(l,"submit",m),e.setTimeout(function(){f?(f.focus(),f.select()):s.focus()},50)},bind:function(e,t,n){typeof e.addEventListener=="function"?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n)},build:function(e){var t="",n=e.type,r=e.message,s=e.cssClass||"";t+='<div class="alertify-dialog">',n==="prompt"&&(t+='<form id="alertify-form">'),t+='<article class="alertify-inner">',t+=i.message.replace("{{message}}",r),n==="prompt"&&(t+=i.input),t+=i.buttons.holder,t+="</article>",n==="prompt"&&(t+="</form>"),t+='<a id="alertify-resetFocus" class="alertify-resetFocus" href="#">Reset Focus</a>',t+="</div>";switch(n){case"confirm":t=t.replace("{{buttons}}",i.buttons.cancel+i.buttons.ok),t=t.replace("{{ok}}",this.labels.ok).replace("{{cancel}}",this.labels.cancel);break;case"prompt":t=t.replace("{{buttons}}",i.buttons.cancel+i.buttons.submit),t=t.replace("{{ok}}",this.labels.ok).replace("{{cancel}}",this.labels.cancel);break;case"alert":t=t.replace("{{buttons}}",i.buttons.ok),t=t.replace("{{ok}}",this.labels.ok);break;default:}return c.className="alertify alertify-show alertify-"+n+" "+s,l.className="alertify-cover",t},close:function(e,t){var n=t&&!isNaN(t)?+t:this.delay;this.bind(e,"click",function(){h.removeChild(e)}),setTimeout(function(){typeof e!="undefined"&&e.parentNode===h&&h.removeChild(e)},n)},dialog:function(e,t,r,i,o){f=n.activeElement;var a=function(){if(c&&c.scrollTop!==null)return;a()};if(typeof e!="string")throw new Error("message must be a string");if(typeof t!="string")throw new Error("type must be a string");if(typeof r!="undefined"&&typeof r!="function")throw new Error("fn must be a function");return typeof this.init=="function"&&(this.init(),a()),u.push({type:t,message:e,callback:r,placeholder:i,cssClass:o}),s||this.setup(),this},extend:function(e){if(typeof e!="string")throw new Error("extend method must have exactly one paramter");return function(t,n){return this.log(t,e,n),this}},hide:function(){u.splice(0,1),u.length>0?this.setup():(s=!1,c.className="alertify alertify-hide alertify-hidden",l.className="alertify-cover alertify-hidden",f?f.focus():null)},init:function(){n.createElement("nav"),n.createElement("article"),n.createElement("section"),l=n.createElement("div"),l.setAttribute("id","alertify-cover"),l.className="alertify-cover alertify-hidden",n.body.appendChild(l),c=n.createElement("section"),c.setAttribute("id","alertify"),c.className="alertify alertify-hidden",n.body.appendChild(c),h=n.createElement("section"),h.setAttribute("id","alertify-logs"),h.className="alertify-logs",n.body.appendChild(h),n.body.setAttribute("tabindex","0"),delete this.init},log:function(e,t,n){var r=function(){if(h&&h.scrollTop!==null)return;r()};return typeof this.init=="function"&&(this.init(),r()),this.notify(e,t,n),this},notify:function(e,t,r){var i=n.createElement("article");i.className="alertify-log"+(typeof t=="string"&&t!==""?" alertify-log-"+t:""),i.innerHTML=e,h.insertBefore(i,h.firstChild),setTimeout(function(){i.className=i.className+" alertify-log-show"},50),this.close(i,r)},set:function(e){var t;if(typeof e!="object"&&e instanceof Array)throw new Error("args must be an object");for(t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},setup:function(){var e=u[0];s=!0,c.innerHTML=this.build(e),typeof e.placeholder=="string"&&e.placeholder!==""&&(a("alertify-text").value=e.placeholder),this.addListeners(e.callback)},unbind:function(e,t,n){typeof e.removeEventListener=="function"?e.removeEventListener(t,n,!1):e.detachEvent&&e.detachEvent("on"+t,n)}},{alert:function(e,t,n){return r.dialog(e,"alert",t,"",n),this},confirm:function(e,t,n){return r.dialog(e,"confirm",t,"",n),this},extend:r.extend,init:r.init,log:function(e,t,n){return r.log(e,t,n),this},prompt:function(e,t,n,i){return r.dialog(e,"prompt",t,n,i),this},success:function(e,t){return r.log(e,"success",t),this},error:function(e,t){return r.log(e,"error",t),this},set:function(e){r.set(e)},labels:r.labels}},typeof define=="function"?define([],function(){return new r}):typeof e.alertify=="undefined"&&(e.alertify=new r)})(this);
;
/*
 * Copyright 2010 by Dan Fabulich.
 * 
 * Dan Fabulich licenses this file to you under the
 * ChoiceScript License, Version 1.0 (the "License"); you may
 * not use this file except in compliance with the License. 
 * You may obtain a copy of the License at
 * 
 *  http://www.choiceofgames.com/LICENSE-1.0.txt
 * 
 * See the License for the specific language governing
 * permissions and limitations under the License.
 * 
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied.
 */

_global = typeof globalThis !== "undefined" ? globalThis : this;

(function() {
  var userAgent, url, protocol, appMeta;
  if (typeof window !== "undefined") {
    userAgent = navigator.userAgent;
    url = window.location.href;
    protocol = window.location.protocol;
    appMeta = window.document.querySelector("meta[name=apple-itunes-app]");
  }
  _global.isWebOS = /webOS/.test(userAgent);
  _global.isMobile = _global.isWebOS || /Mobile/.test(userAgent);
  _global.isFile = /^file:/.test(url);
  _global.isXul = /^chrome:/.test(url);
  try {
    _global.steamworksApi = require('steamworks.js');
    _global.isSteamworks = true;
  } catch (ignored) {}
  _global.isWinOldApp = false;
  try {
    isWinOldApp = window.external.IsWinOldApp();
  } catch (ignored) {}
  _global.isAndroid = /Android/.test(userAgent);
  _global.isOmnibusApp = /CoGnibus/.test(userAgent);
  _global.isIosApp = _global.isIosApp || (_global.isOmnibusApp && !_global.isAndroid);
  _global.isAndroidApp = _global.isAndroidApp || (_global.isOmnibusApp && _global.isAndroid);
  _global.isAmazonAndroidApp = _global.isAmazonAndroidApp || (_global.isAndroidApp && _global.flavor && _global.flavor.isAmazon());
  _global.isWeb = !_global.isIosApp && !_global.isAndroidApp && !_global.isWinOldApp && /^https?:/.test(url);
  _global.isSecureWeb = /^https:?$/.test(protocol);
  _global.isSafari = /Safari/.test(userAgent);
  _global.isIE = /(MSIE|Trident)/.test(userAgent);
  _global.isIPad = /iPad/.test(userAgent);
  _global.isIPhone = /iPhone/.test(userAgent);
  _global.isKindleFire = /Kindle Fire/.test(userAgent);
  _global.isWinStoreApp = "ms-appx:" == protocol;
  _global.isCef = !!_global.cefQuery;
  _global.isNode = typeof process !== "undefined";
  _global.isHeartsChoice = appMeta && /1487052276/.test(appMeta.getAttribute("content"))
})();

_global.loadTime = new Date().getTime();

function callIos(scheme, path) {
  if (!_global.isIosApp) return;
  if (typeof webkit !== "undefined" && webkit.messageHandlers) {
    return webkit.messageHandlers.choicescript.postMessage([scheme, path]);
  }
  if (path) {
    path = encodeURIComponent(path).replace(/[!~*')(]/g, function(match) {
      return "%" + match.charCodeAt(0).toString(16);
    });
  } else {
    path = "";
  }
  setTimeout(function() {
    var iframe = document.createElement("IFRAME");
    iframe.setAttribute("src", scheme + "://" + path);
    iframe.setAttribute("style", "display:none");
    document.documentElement.appendChild(iframe);
    iframe.parentNode.removeChild(iframe);
    iframe = null;
  }, 0);
}

function callMac(scheme, path) {
  if (typeof webkit !== "undefined" && webkit.messageHandlers) {
    return webkit.messageHandlers.choicescript.postMessage([scheme, path]);
  }
}

function safeCall(obj, fn) {
    if (!fn) return;
    var isHeadless = typeof window == "undefined";
    var debug = false || (!isHeadless && window.debug);
    if (isIE || isHeadless) {
        // just call through; onerror will be called and debugger will handle it
        if (typeof MSApp != "undefined") {
            if (obj) {
                MSApp.execUnsafeLocalFunction(function () { fn.call(obj); });
            } else {
                MSApp.execUnsafeLocalFunction(fn);
            }
        } else if (obj) {
            fn.call(obj);
        } else {
            fn.call();
        }
    } else {
        try {
            if (obj) {
                fn.call(obj);
            } else {
                fn.call();
            }
        } catch (e) {
            if (e.message) {
              window.reportError(e.message, e.fileName, e.lineNumber, e.columnNumber, e);
            } else if (e.stack) {
              window.reportError(e.stack, e.fileName, e.lineNumber, e.columnNumber, e);
            } else {
              window.reportError(toJson(e, '\n'));
            }

            if (window.console) {
              window.console.error(e);
              if (e.message) window.console.error("Message: " + e.message);
              if (e.stack) window.console.error("Stack: " + e.stack);
            }
            // Rethrow here so the debugger can handle it
            // On Firefox this causes a second prompt.  Meh!
            if (debug) throw e;
        }
    }
}

function safeCallback(callback) {
  return function() {
    safeCall(null, callback);
  };
}

function safeTimeout(fn, time) {
  setTimeout(function() {
    safeCall(null, fn);
  }, time);
}

function isDefined(x) {
    return "undefined" !== typeof x;
}

function jsonStringifyAscii(obj) {
  var output = JSON.stringify(obj).replace(/(.)/g, function(x) {
    var code = x.charCodeAt(0);
    if (code > 127 || code < 32) {
     var outCode = code.toString(16);
     switch (outCode.length) {
       case 4:
         return "\\u" + outCode;
       case 3:
         return "\\u0" + outCode;
       case 2:
         return "\\u00" + outCode;
       case 1:
         return "\\u000" + outCode;
       default:
         return x;
     }
    }
    return x;
  });
  return output;
}

function toJson(obj, standardized) {
 if (typeof JSON != "undefined" && JSON.stringify) {
  return jsonStringifyAscii(obj);
 }
 switch (typeof obj) {
  case 'object':
   if (obj) {
    var list = [];
    if (obj instanceof Array) {
     for (var i=0;i < obj.length;i++) {
      list.push(toJson(obj[i], standardized));
     }
     return '[' + list.join(',') + ']';
    } else {
     for (var prop in obj) {
      if (prop == "scene") continue;
      if (!standardized && /^[a-zA-Z][a-zA-Z_0-9]\w+$/.test(prop) && !/\b(abstract|boolean|break|byte|case|catch|char|class|comment|const|continue|debugger|default|delete|do|double|else|enum|export|extends|false|final|finally|float|for|function|goto|if|implements|import|in|instanceof|int|interface|label|long|native|new|null|package|private|protected|public|return|short|static|super|switch|synchronized|this|throws|transient|true|try|typeof|var|void|volatile|while|with)\b/.test(prop)) {
        list.push(prop + ':' + toJson(obj[prop], standardized));
      } else {
        list.push('"' + prop + '":' + toJson(obj[prop], standardized));
      }
     }
     return '{' + list.join(',') + '}';
    }
   } else {
    return 'null';
   }
   break;
  case 'string':
   var encoded = obj.replace(/(.)/g, function(x) {
     if (x == "'" || x == '"' || x == '\\') {
       return "\\" + x;
     }
     var code = x.charCodeAt(0);
     if (code > 127 || code < 32) {
       var outCode = code.toString(16);
       switch (outCode.length) {
         case 4:
           return "\\u" + outCode;
         case 3:
           return "\\u0" + outCode;
         case 2:
           return "\\u00" + outCode;
         case 1:
           return "\\u000" + outCode;
         default:
           return x;
       }
     }
     return x;
   });
   return '"' + encoded + '"';
  case 'number':
  case 'boolean':
   return String(obj);
  case 'function':
   return 'badfunction';
  case 'undefined':
    return 'undefined';
  default:
   throw new Error("invalid type: " + typeof obj);
 }
}

var loginUrlBase = "https://www.choiceofgames.com/api/";
function xhrAuthRequest(method, endpoint, callback) {
  var paramBuilder = new Array(arguments.length*3);
  for (var i = 3; i < arguments.length; i=i+2) {
    if (i > 3) paramBuilder.push("&");
    paramBuilder.push(arguments[i]);
    paramBuilder.push("=");
    paramBuilder.push(arguments[i+1]);
  }
  var params = paramBuilder.join("");
  var xhr = findXhr();
  if (method == "POST") {
    xhr.open(method, loginUrlBase + endpoint + ".php", true);
    xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
  } else {
    xhr.open(method, loginUrlBase + endpoint + ".php?" + params, true);
  }

  var done = false;

  xhr.onreadystatechange = function() {
    if (done) return;
    if (xhr.readyState != 4) return;
    done = true;
    var ok = xhr.status == 200;
    var response = {};
    try {
      if (xhr.responseText) response = JSON.parse(xhr.responseText);
    } catch (e) {
      ok = false;
    }
    if (!ok) {
      if (!response.error) response.error = "unknown error";
      response.status = xhr.status;
    }
    if (callback) safeCall(null, function() {callback(ok, response);});
  };
  xhr.send(params);
}

function login(email, password, register, subscribe, callback) {
  xhrAuthRequest("POST", "login", callback, "email", encodeURIComponent(email), "password", encodeURIComponent(password), "register", register, "subscribe", subscribe);
}

function forgotPassword(email, callback) {
  xhrAuthRequest("POST", "forgot", callback, "email", encodeURIComponent(email));
}

function logout(callback) {
  document.cookie = 'login=0;path=/;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
  xhrAuthRequest("GET", "logout", callback);
  recordLogin(false);
  window.knownPurchases = null;
  window.registered = false;
  if (typeof FB != "undefined" && FB.logout) FB.logout();
  if (typeof gapi != "undefined" && gapi.auth && gapi.auth.signOut) gapi.auth.signOut();
}

function recordLogin(registered, loginId, email, callback) {
  if (initStore()) {
    if (registered) recordEmail(email);
    window.store.set("login", loginId || 0, function() {safeCall(null, callback);});
    window.registered = registered;
  } else {
    safeTimeout(callback, 0);
  }
}

function getRemoteEmail(callback) {
  xhrAuthRequest("GET", "getuser", callback);
}

function saveCookie(callback, slot, stats, temps, lineNum, indent, deleted, undeleted) {
    var value = computeCookie(stats, temps, lineNum, indent, deleted, undeleted);
    return writeCookie(value, slot, callback);
}

function computeCookie(stats, temps, lineNum, indent, deleted, undeleted) {
  var scene = stats.scene;
  delete stats.scene;
  if (scene) stats.sceneName = scene.name;
  var version = "UNKNOWN";
  if (typeof(window) != "undefined" && window && window.version) version = window.version;
  var obj = { version: version, stats: stats, temps: temps, lineNum: lineNum, indent: indent };
  if (deleted) obj.deleted = deleted;
  if (undeleted) obj.undeleted = undeleted;
  var value = toJson(obj);
  stats.scene = scene;
  return value;
}

function writeCookie(value, slot, callback) {
  if (!_global.pseudoSave) _global.pseudoSave = {};
  if (!slot) {
    slot = "";
  }
  _global.pseudoSave[slot] = value;
  if (!initStore()) {
    if (callback) safeTimeout(callback, 0);
    return;
  }
  window.store.set("state"+slot, value, safeCallback(callback));
}

function clearCookie(callback, slot) {
    writeCookie('', slot, safeCallback(callback));
}

function areSaveSlotsSupported() {
  return !!(initStore() && window.Persist.type != "cookie");
}

function recordSave(slot, callback) {
  if (!areSaveSlotsSupported()) {
    safeTimeout(callback, 0);
    return;
  }
  restoreObject(initStore(), "save_list", [], function (saveList) {
    saveList.push(slot);
    window.store.set("save_list", toJson(saveList), safeCallback(callback));
  });
}

function recordDirtySlots(slots, callback) {
  if (!areSaveSlotsSupported()) {
    safeTimeout(callback, 0);
    return;
  }
  restoreObject(initStore(), "dirty_save_list", [], function (saveList) {
    saveSet = {};
    for (var i = 0; i < saveList.length; i++) {
      saveSet[saveList[i]] = 1;
    }
    for (i = 0; i < slots.length; i++) {
      if (!saveSet[slots[i]]) saveList.push(slots[i]);
    }
    window.store.set("dirty_save_list", toJson(saveList), safeCallback(callback));
  });
}

function recordEmail(email, callback) {
  if (initStore()) {
    window.recordedEmail = email;
    window.store.set("email", email, safeCallback(callback));
  } else {
    safeTimeout(callback, 0);
  }
}

function fetchEmail(callback) {
  if (!initStore()) {
    safeTimeout(function(){callback("");}, 0);
    return;
  }
  if (window.recordedEmail) {
    return safeTimeout(function() {
      callback(window.recordedEmail);
    })
  }
  if (window.isWeb) {
    var cookieEmail = getCookieByName("login");
    if (/@/.test(cookieEmail)) {
      return recordEmail(cookieEmail, function() {
        callback(cookieEmail);
      });
    }
  }
  // For some reason, this get seems to not respond sometimes
  // adding a fallback timeout
  window.store.get("email", function(ok, value) {
    safeCall(null, function() {
      if (ok) window.recordedEmail = value;
      if (!callback) return;
      var temp = callback;
      callback = null;
      if (ok && value) {
        temp(value);
      } else {
        temp("");
      }
    });
  });
  safeTimeout(function() {
    if (!callback) return;
    var temp = callback;
    callback = null;
    temp("");
  }, 1000);
}

function restoreObject(store, key, defaultValue, callback) {
  if (!store) {
    safeTimeout(function() {callback(defaultValue);}, 0);
    return;
  }
  store.get(key, function(ok, value) {
    var result = defaultValue;
    if (ok && value) {
      try{
        result = jsonParse(value);
      } catch (e) {}
    }
    safeCall(null, function() {callback(result);});
  });
}

function getDirtySaveList(callback) {
  restoreObject(initStore(), "dirty_save_list", [], function (slotList) {
    callback(slotList);
  });
}

function remoteSaveMerger(i, callback) {
  var remoteStore = new Persist.Store(window.remoteStoreNames[i]);
  restoreObject(remoteStore, "save_list", [], function (remoteSlotList) {
    fetchSavesFromSlotList(remoteStore, remoteSlotList, 0, [], function(remoteSaveList) {
      mergeRemoteSaves(remoteSaveList, 0/*recordDirty*/, function() {
        i++;
        if (i < window.remoteStoreNames.length) {
          remoteSaveMerger(i, callback);
        } else {
          callback.apply(null, arguments);
        }
      });
    });
  });
}

function getSaves(callback) {
  if (window.remoteStoreNames && window.remoteStoreNames.length) {
    remoteSaveMerger(0, callback);
  } else if (window.remoteStoreName && window.storeName != window.remoteStoreName) {
    var remoteStore = new Persist.Store(window.remoteStoreName);
    restoreObject(remoteStore, "save_list", [], function (remoteSlotList) {
      fetchSavesFromSlotList(remoteStore, remoteSlotList, 0, [], function(remoteSaveList) {
        mergeRemoteSaves(remoteSaveList, 0/*recordDirty*/, callback);
      });
    });
  } else {
    restoreObject(initStore(), "save_list", [], function (localSlotList) {
      fetchSavesFromSlotList(initStore(), localSlotList, 0, [], callback);
    });
  }
}

function fetchSavesFromSlotList(store, slotList, i, saveList, callback) {
  if (i >= slotList.length) {
    return safeCall(null, function() {callback(saveList);});
  }
  restoreObject(store, "state"+slotList[i], null, function(saveState) {
    if (saveState) {
      saveState.timestamp = slotList[i].substring(4/*"save".length*/);
      saveList.push(saveState);
    }
    fetchSavesFromSlotList(store, slotList, i+1, saveList, callback);
  });
}

function isWebSavePossible() {
  if (!initStore()) return false;
  if (!_global.isCogPublished) return false;
  if (/^http/.test(window.location.protocol)) {
    return document.domain == window.webSaveDomain || document.domain == "localhost";
  }
  // if it's a file URL with a valid store, either you're a 3rd party developer
  // who knows what you're doing, or you're a mobile app
  return true;
}


webSaveDomain = "www.choiceofgames.com";
webSaveUrl = "https://" + webSaveDomain + "/ajax_proxy.php/websave";

function submitRemoteSave(slot, email, subscribe, callback) {
  if (!isWebSavePossible()) return safeTimeout(function() { callback(false); });
  window.store.get("state"+slot, function(ok, value) {
    if (ok) {
      var timestamp = slot.substring(4/*"save".length*/);
      var xhr = findXhr();
      var gameName = window.remoteStoreName || window.storeName;
      var params = "email="+email+"&game="+gameName+"&realGame="+window.storeName+"&json="+encodeURIComponent(value)+"&timestamp="+ timestamp+"&subscribe="+subscribe;
      xhr.open("POST", webSaveUrl,true);
      xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
      var done = false;

      xhr.onreadystatechange = function() {
        if (done) return;
        if (xhr.readyState != 4) return;
        done = true;
        var ok = xhr.status == 200;
        if (ok) {
          safeCall(null, function() {callback(true);});
        } else {
          recordDirtySlots([slot], function() {
            safeCall(null, function() {callback(false);});
          });
        }
      };
      xhr.send(params);
    } else {
      recordDirtySlots([slot], function() {
        asyncAlert("There was a problem uploading the saved game. This is probably a bug; please contact support@choiceofgames.com with code 17891.", function() {
          safeCall(null, function() {callback(false);});
        });
      });
    }
  });
}

function submitDirtySaves(dirtySaveList, email, callback) {
  function submitDirtySave(i) {
    if (dirtySaveList[i]) {
      submitRemoteSave(dirtySaveList[i], email, false, function(ok) {
        if (ok) {
          submitDirtySave(i+1);
        } else {
          safeCall(null, function() {callback(false);});
        }
      });
    } else {
      window.store.remove("dirty_save_list", function() {
        safeCall(null, function() {callback(true);});
      });
    }
  }
  submitDirtySave(0);
}

function submitAnyDirtySaves(callback) {
  if (!callback) callback = function(ok) {};
  try {
    getDirtySaveList(function(dirtySaveList) {
      if (dirtySaveList && dirtySaveList.length) {
        try {
          fetchEmail(function(email) {
            if (email) {
              submitDirtySaves(dirtySaveList, email, callback);
            } else {
              callback(false);
            }
          });
        } catch (e) {
          callback(false);
        }
      }
    });
  } catch (e) {
    callback(false);
  }
}

function getRemoteSaves(email, callback) {
  if (!isWebSavePossible()) {
    safeTimeout(function() {callback([]);}, 0);
    return;
  }
  var xhr = findXhr();
  var gameName = window.remoteStoreName || window.storeName;
  xhr.open("GET", webSaveUrl + "?email="+email+"&game="+gameName, true);
  var done = false;
  xhr.onreadystatechange = function() {
    if (done) return;
    if (xhr.readyState != 4) return;
    done = true;
    if (xhr.status != 200) {
      if (window.console) console.log("Couldn't load remote saves. " + xhr.status + ": " + xhr.responseText);
      safeCall(null, function() {callback(null);});
    } else {
      var result = xhr.responseText;
      result = jsonParse(result);
      var remoteSaveList = [];
      for (var i = 0; i < result.length; i++) {
        if (!result[i]) continue;
        var save = result[i].json;
        if (!save) continue;
        save.timestamp = result[i].timestamp;
        remoteSaveList.push(save);
      }
      safeCall(null, function() {callback(remoteSaveList);});
    }
  };
  xhr.send();
}

function mergeRemoteSaves(remoteSaveList, recordDirty, callback) {
  if (!isWebSavePossible()) {
    safeTimeout(function() { callback([], 0, []); }, 0);
    return;
  }
  restoreObject(initStore(), "save_list", [], function (localSlotList) {
    fetchSavesFromSlotList(initStore(), localSlotList, 0, [], function(localSaveList) {
      var localSlotMap = {};
      for (var i = 0; i < localSlotList.length; i++) {
        localSlotMap[localSlotList[i]] = i;
      }
      var remoteSlotMap = {};
      for (i = 0; i < remoteSaveList.length; i++) {
        remoteSlotMap["save"+remoteSaveList[i].timestamp] = 1;
      }
      var newRemoteSaves = 0;
      for (i = 0; i < remoteSaveList.length; i++) {
        var remoteSave = remoteSaveList[i];
        var slot = "save"+remoteSave.timestamp;
        saveCookie(null, slot, remoteSave.stats, remoteSave.temps, remoteSave.lineNum, remoteSave.indent, remoteSave.deleted, remoteSave.undeleted);
        if (typeof localSlotMap[slot] !== 'undefined') {
          localSaveList[localSlotMap[slot]] = remoteSave;
        } else {
          localSlotList.push(slot);
          localSaveList.push(remoteSave);
          newRemoteSaves++;
        }
      }

      var dirtySaveList = [];
      for (i = 0; i < localSlotList.length; i++) {
        if (!remoteSlotMap[localSlotList[i]]) {
          dirtySaveList.push(localSlotList[i]);
        }
      }

      if (recordDirty) {
        window.store.set("dirty_save_list", toJson(dirtySaveList), finale);
      } else {
        finale();
      }

      function finale() {
        if (newRemoteSaves) {
          window.store.set("save_list", toJson(localSlotList), function() {
            safeCall(null, function() { callback(localSaveList, newRemoteSaves, dirtySaveList); });
          });
        } else {
          safeCall(null, function() {callback(localSaveList, newRemoteSaves, dirtySaveList);});
        }
      }
    });
  });
}

function getAppId() {
  if (window.isIosApp) {
    var appBanner = document.querySelector("meta[name=apple-itunes-app]");
    return /app-id=(\d+)/.exec(appBanner.getAttribute("content"))[1];
  } else if (window.isAndroidApp) {
    var androidLink = document.getElementById('androidLink');
    return /id=([\.\w]+)/.exec(androidLink.href)[1];
  }
}

function submitReceipts(receipts, callback) {
  console.log("submitReceipts: " + JSON.stringify(receipts));
  if (!callback) callback = function(error) {
    if (window.transferPurchaseCallback) {
      window.transferPurchaseCallback(error || "done");
    }
  };
  var appId = receipts.appId;
  var count = 0;
  var error;
  function submitCallback(product) {
    return function submitCallback(ok, response) {
      if (!ok) {
        console.log("failed: " + product + " " + JSON.stringify(response));
        if (!error) {
          var match = /^receipt transaction already processed: (\d+) current login (\d+)$/.exec(response.error);
          if (match) {
            callback("409-" + match[1] + "-" + match[2]);
          } else {
            callback("" + response.status + "r");
          }
        }
        error = true;
      }
      if (error) return;
      count--;
      if (!count) {
        if (!receipts.avoidOverrides) cacheKnownPurchases(response);
        callback();
      }
    }
  }

  if (window.isAndroidApp) {
    window.store.get("login", function(ok, loginId) {
      loginId = loginId || 0;
      var platform = window.isAmazonAndroidApp ? 'amazon' : 'google';
      if (receipts.prePurchased && platform === 'google') {
        for (var i = 0; i < receipts.prePurchased.length; i++) {
          var product = receipts.prePurchased[i];
          count++;
          xhrAuthRequest("POST", "submit-device-receipt", submitCallback(product),
            'platform', platform,
            'company', receipts.company,
            'game_id', window.storeName,
            'app_package', appId,
            'product_id', product,
            'signature', encodeURIComponent(receipts.signature),
            'receipt', encodeURIComponent(receipts.signedData),
            'login_id', loginId
          );
        }
      }
      if (receipts.iaps) {
        for (var product in receipts.iaps) {
          count++;
          xhrAuthRequest("POST", "submit-device-receipt", submitCallback(product),
            'platform', platform,
            'company', receipts.company,
            'game_id', window.storeName,
            'app_package', appId,
            'product_id', product,
            'receipt', encodeURIComponent(receipts.iaps[product]),
            'login_id', loginId
          );
        }
      }
      if (!count) safeTimeout(function () { callback(); }, 0);
    });
  } else {
    callback("error");
  }
}

function delayBreakStart(callback) {
  var nowInSeconds = Math.floor(new Date().getTime() / 1000);
  if (!initStore()) {
    safeTimeout(function() {callback(nowInSeconds);}, 0);
    return;
  }
  window.store.get("delayBreakStart", function(ok, value) {
    var valueNum = value*1;
    safeCall(null, function() {
      if (ok && value && !isNaN(valueNum)) {
        callback(valueNum);
      } else {
        window.store.set("delayBreakStart", nowInSeconds);
        callback(nowInSeconds);
      }
    });
  });
}

function delayBreakEnd() {
  if (initStore()) window.store.remove("delayBreakStart");
}

function initStore() {
  if (!window.storeName) return false;
  if (window.store) return window.store;
  try {
    window.store = new Persist.Store(window.storeName);
  } catch (e) {
    console.error(e);
  }
  return window.store;
}
function loadAndRestoreGame(slot, forcedScene, forcedStats, forcedTemps) {
  function valueLoaded(ok, value) {
    safeCall(null, function() {
      var state = null;
      if (ok && value && ""+value) {
        //console.log("successfully loaded slot " + slot);
        state = jsonParse(value);
      } else if (slot == "backup") {
        console.log("loadAndRestoreGame couldn't find backup");
        if (typeof alertify !== "undefined") alertify.log("Failed restarting chapter. Restarting the game from scratch.");
        return restartGame();
      }
      restoreGame(state, forcedScene, false, forcedStats, forcedTemps);
    });
  }
  if (!slot) slot = "";
  if (_global.pseudoSave && pseudoSave[slot]) return valueLoaded(true, pseudoSave[slot]);
  if (!initStore()) return restoreGame(null, forcedScene);
  window.store.get("state"+slot, valueLoaded);
}

function isStateValid(state) {
  if (!state) return false;
  if (!state.stats) return false;
  if (!state.stats.sceneName) return false;
  return true;
}

function restartGame(shouldPrompt) {
  if (_global.blockRestart) {
    asyncAlert("Please wait until the timer has run out.");
    return;
  }
  function actuallyRestart(result) {
    if (!result) return;
    delayBreakEnd();
    submitAnyDirtySaves();
    clearCookie(function() {}, 'temp');
    clearCookie(function() {
      _global.nav.resetStats(_global.stats);
      clearScreen(restoreGame);
    }, "");
  }
  if (shouldPrompt) {
    asyncConfirm("Start over from the beginning?", actuallyRestart);
  } else {
    actuallyRestart(true);
  }
}

function restoreGame(state, forcedScene, userRestored, forcedStats, forcedTemps) {
    var scene;
    var secondaryMode = null;
    var saveSlot = "";
    var forcedSceneLabel = null;
    if (/\|/.test(forcedScene)) {
      var parts = forcedScene.split("|");
      forcedScene = parts[0];
      forcedSceneLabel = parts[1];
    }
    if (forcedScene == "choicescript_stats") {
      secondaryMode = "stats";
      saveSlot = "temp";
    } else if (forcedScene == "choicescript_upgrade") {
      secondaryMode = "upgrade";
      saveSlot = "temp";
    }
    if (!isStateValid(state)) {
        var startupScene = forcedScene ? forcedScene : _global.nav.getStartupScene();
        scene = new Scene(startupScene, _global.stats, _global.nav, {debugMode:_global.debug, secondaryMode:secondaryMode, saveSlot:saveSlot});
    } else {
      if (forcedScene) state.stats.sceneName = forcedScene;
      if (forcedStats) {
        for (var stat in forcedStats) {
          state.stats[stat] = forcedStats[stat];
        }
      }
      if (forcedTemps) {
        for (var temp in forcedTemps) {
          state.temps[temp] = forcedTemps[temp];
        }
      }
      _global.stats = state.stats;
      // Someday, inflate the navigator using the state object
      scene = new Scene(state.stats.sceneName, state.stats, _global.nav, {debugMode:state.debug || _global.debug, secondaryMode:secondaryMode, saveSlot:saveSlot});
      if (!forcedScene) {
        scene.temps = state.temps;
        scene.lineNum = state.lineNum;
        scene.indent = state.indent;
      }
      if (userRestored) {
        scene.temps.choice_user_restored = true;
      }
    }
    if (forcedSceneLabel !== null) {
      scene.targetLabel = {label:forcedSceneLabel, origin:"url", originLine:0}
    }
    safeCall(scene, scene.execute);
}

function redirectScene(sceneName, label, originLine) {
  var scene = new Scene(sceneName, window.stats, window.nav, {debugMode:window.debug});
  if (label) scene.targetLabel = {label:label, origin:"choicescript_stats", originLine:originLine};
  scene.redirectingFromStats = true;
  clearScreen(function() {scene.execute();});
}

tempStatWrites = {};

function transferTempStatWrites() {
  if (!_global.isIosApp) return;
  callIos("transferwrites", JSON.stringify(tempStatWrites));
}

function getCookieByName(cookieName, ck) {
    if (!ck) ck = window.document.cookie;
    if (!ck) return null;
    var ckPairs = ck.split(/;/);
    for (var i = 0; i < ckPairs.length; i++) {
        var ckPair = trim(ckPairs[i]);
        var ckNameValue = ckPair.split(/=/);
        var ckName = decodeURIComponent(ckNameValue[0]);
        if (ckName === cookieName) {
            return decodeURIComponent(ckNameValue[1]);
        }
    }
    return null;
}

function parseQueryString(str) {
  if (!str) return null;
  str = String(str).substring(1);
  if (!str) return null;
  var map = {};
  var pairs = str.split("&");
  var i = pairs.length;
  while (i--) {
    var pair = pairs[i];
    var parts = pair.split("=");
    map[parts[0]] = parts[1];
  }
  return map;
}

function trim(str) {
    if (str === null || str === undefined) return null;
    var result = str.replace(/^\s+/g, "");
    // strip leading
    return result.replace(/\s+$/g, "");
    // strip trailing
}


function findOptimalDomain(docDomain) {
    if (!docDomain) docDomain = document.domain;
    // localhost and 127.0.0.1 will cause cookie not to be set; just omit them, it works fine
    if (docDomain == "localhost" || docDomain == "127.0.0.1") return null;
    // ip address
    if (/^\d+\.\d+\.\d+\.\d+$/.test(docDomain)) return null;
    // dotcom
    var result = docDomain.match(/(\w+\.\w{3}$)/);
    if (result) return result[1];
    return null;
}

function num(x, line, sceneName) {
    if (!line) line = "UNKNOWN";
    errorInfo = "line "+line;
    if (sceneName) errorInfo = sceneName + " " + errorInfo;
    var x_num = parseFloat(x);
    if (isNaN(x_num)) throw new Error(errorInfo+": Not a number: " + x);
    if (!isFinite(x_num)) throw new Error(errorInfo+": Not finite " + x);
    return x_num;
}

function bool(x, line, sceneName) {
  if (!line) line = "UNKNOWN";
  if ("boolean" == typeof x) {
    return x;
  } else if ("true" === x) {
    return true;
  } else if ("false" === x) {
    return false;
  }
  errorInfo = "line "+line;
  if (sceneName) errorInfo = sceneName + " " + errorInfo;
  throw new Error(errorInfo+": Neither true nor false: " + x);
}

function findXhr() {
  var ieFile = isIE && isFile;
  if (window.XMLHttpRequest && !ieFile) return new window.XMLHttpRequest();
  var ids = ['Msxml2.XMLHTTP', 'Microsoft.XMLHTTP', 'Msxml2.XMLHTTP.4.0'];
  for (var i = 0; i < 3; i++) {
    try {
      return new ActiveXObject(ids[i]);
    } catch (e) {}
  }
  throw new Error("Couldn't create XHR object");
}

    crcTable = "00000000 77073096 EE0E612C 990951BA 076DC419 706AF48F E963A535 9E6495A3 0EDB8832 79DCB8A4 E0D5E91E 97D2D988 09B64C2B 7EB17CBD E7B82D07 90BF1D91 1DB71064 6AB020F2 F3B97148 84BE41DE 1ADAD47D 6DDDE4EB F4D4B551 83D385C7 136C9856 646BA8C0 FD62F97A 8A65C9EC 14015C4F 63066CD9 FA0F3D63 8D080DF5 3B6E20C8 4C69105E D56041E4 A2677172 3C03E4D1 4B04D447 D20D85FD A50AB56B 35B5A8FA 42B2986C DBBBC9D6 ACBCF940 32D86CE3 45DF5C75 DCD60DCF ABD13D59 26D930AC 51DE003A C8D75180 BFD06116 21B4F4B5 56B3C423 CFBA9599 B8BDA50F 2802B89E 5F058808 C60CD9B2 B10BE924 2F6F7C87 58684C11 C1611DAB B6662D3D 76DC4190 01DB7106 98D220BC EFD5102A 71B18589 06B6B51F 9FBFE4A5 E8B8D433 7807C9A2 0F00F934 9609A88E E10E9818 7F6A0DBB 086D3D2D 91646C97 E6635C01 6B6B51F4 1C6C6162 856530D8 F262004E 6C0695ED 1B01A57B 8208F4C1 F50FC457 65B0D9C6 12B7E950 8BBEB8EA FCB9887C 62DD1DDF 15DA2D49 8CD37CF3 FBD44C65 4DB26158 3AB551CE A3BC0074 D4BB30E2 4ADFA541 3DD895D7 A4D1C46D D3D6F4FB 4369E96A 346ED9FC AD678846 DA60B8D0 44042D73 33031DE5 AA0A4C5F DD0D7CC9 5005713C 270241AA BE0B1010 C90C2086 5768B525 206F85B3 B966D409 CE61E49F 5EDEF90E 29D9C998 B0D09822 C7D7A8B4 59B33D17 2EB40D81 B7BD5C3B C0BA6CAD EDB88320 9ABFB3B6 03B6E20C 74B1D29A EAD54739 9DD277AF 04DB2615 73DC1683 E3630B12 94643B84 0D6D6A3E 7A6A5AA8 E40ECF0B 9309FF9D 0A00AE27 7D079EB1 F00F9344 8708A3D2 1E01F268 6906C2FE F762575D 806567CB 196C3671 6E6B06E7 FED41B76 89D32BE0 10DA7A5A 67DD4ACC F9B9DF6F 8EBEEFF9 17B7BE43 60B08ED5 D6D6A3E8 A1D1937E 38D8C2C4 4FDFF252 D1BB67F1 A6BC5767 3FB506DD 48B2364B D80D2BDA AF0A1B4C 36034AF6 41047A60 DF60EFC3 A867DF55 316E8EEF 4669BE79 CB61B38C BC66831A 256FD2A0 5268E236 CC0C7795 BB0B4703 220216B9 5505262F C5BA3BBE B2BD0B28 2BB45A92 5CB36A04 C2D7FFA7 B5D0CF31 2CD99E8B 5BDEAE1D 9B64C2B0 EC63F226 756AA39C 026D930A 9C0906A9 EB0E363F 72076785 05005713 95BF4A82 E2B87A14 7BB12BAE 0CB61B38 92D28E9B E5D5BE0D 7CDCEFB7 0BDBDF21 86D3D2D4 F1D4E242 68DDB3F8 1FDA836E 81BE16CD F6B9265B 6FB077E1 18B74777 88085AE6 FF0F6A70 66063BCA 11010B5C 8F659EFF F862AE69 616BFFD3 166CCF45 A00AE278 D70DD2EE 4E048354 3903B3C2 A7672661 D06016F7 4969474D 3E6E77DB AED16A4A D9D65ADC 40DF0B66 37D83BF0 A9BCAE53 DEBB9EC5 47B2CF7F 30B5FFE9 BDBDF21C CABAC28A 53B39330 24B4A3A6 BAD03605 CDD70693 54DE5729 23D967BF B3667A2E C4614AB8 5D681B02 2A6F2B94 B40BBE37 C30C8EA1 5A05DF1B 2D02EF8D";

    /* Number */
    function crc32( /* String */ str, /* Number */ crc ) {
        if( !crc ) crc = 0;
        var n = 0; //a number between 0 and 255 
        var x = 0; //an hex number 

        crc = crc ^ (-1);
        for( var i = 0, iTop = str.length; i < iTop; i++ ) {
            n = ( crc ^ str.charCodeAt( i ) ) & 0xFF;
            x = "0x" + crcTable.substr( n * 9, 8 );
            crc = ( crc >>> 8 ) ^ x;
        }
        return crc ^ (-1);
    }

function simpleDateFormat(date) {
  var day = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"][date.getDay()];
  var month = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][date.getMonth()];
  var minutes = date.getMinutes();
  if (minutes < 10) minutes = "0" + ("" + minutes);
  var oneYearInMillis = 1000 * 60 * 60 * 24 * 365;
  var millisAgo = new Date().getTime() - date.getTime();
  var yearString = ""
  if (millisAgo > oneYearInMillis) {
    yearString = ", " + date.getFullYear();
  }
  return day + ", " + month + " " + date.getDate() + yearString;
}

function simpleDateTimeFormat(date) {
  var minutes = date.getMinutes();
  if (minutes < 10) minutes = "0" + ("" + minutes);
  return simpleDateFormat(date) + ", " + date.getHours() + ":" + minutes;
}

function jsonParse(str) {
  if (typeof JSON != "undefined") {
    try {
      return JSON.parse(str);
    } catch (e) {
      // try to handle unquoted keys
      try {
        return eval('('+str+')');
      } catch (e2) {
        // that might have failed because eval is forbidden
        try {
          eval("1");
        } catch (e3) {
          // eval forbidden; let's try a hack to fix unquoted keys
          var str2 = (str+"").replace(/([,\{])\s*(\w+)\s*\:/g, '$1"$2":');
          try {
            return JSON.parse(str2);
          } catch (e4) {}
        }
        // at this point, just report a clear error
        return JSON.parse(str);
      }
    }
  } else {
    return eval('('+str+')');
  }
}

function cefQuerySimple(method) {
  cefQuery({
    request:method,
    onSuccess: function(response) {console.log(method + " success");},
    onFailure: function(error_code, error_message) {console.error(method + " error: " + error_message);}
  });
}

shortMonthStrings = [null, "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/parse
// "Given a date string of "March 7, 2014", parse() assumes a local time zone, but given an
// ISO format such as "2014-03-07" it will assume a time zone of UTC for ES5 or local for
// ECMAScript 2015."
function parseDateStringInCurrentTimezone(YYYY_MM_DD, line) {
  var result = /^(\d{4})-(\d{2})-(\d{2})$/.exec(YYYY_MM_DD);
  if (!result) throw new Error("line "+line+": invalid date string " + YYYY_MM_DD);
  var fullYear = result[1];
  var oneBasedMonthNumber = parseInt(result[2],10);
  var dayOfMonth = parseInt(result[3],10);
  var shortMonthString = shortMonthStrings[oneBasedMonthNumber];
  return new Date(shortMonthString + " " + dayOfMonth + ", " + fullYear);
}

function matchBracket(line, brackets, startIndex) {
  var openBracket = brackets[0];
  var closeBracket = brackets[1];
  var brackets = 0;
  for (var i = startIndex; i < line.length; i++) {
    var c = line.charAt(i);
    if (c === openBracket) {
      brackets++;
    } else if (c === closeBracket) {
      if (brackets) {
        brackets--;
      } else {
        return i;
      }
    }
  }
  return -1;
}

function isStoreSceneCacheRequired() {
  if (!(initStore() &&
    _global.purchases &&
    _global.checkPurchase &&
    _global.hashes &&
    !(_global.isOmnibusApp && _global.isIosApp) &&
    hashes.scenes
  )) return false;
  var empty = true;
  for (var scene in purchases) {
    if (/^fake:/.test(scene)) continue;
    empty = false;
    break;
  }
  return !empty;
}

function updateSinglePaidSceneCache(sceneName, callback) {
  sceneName = sceneName.replace(/ /g, "_");
  var fileName = sceneName + ".txt.json";
  if (initStore() && _global.hashes && hashes.scenes && hashes.scenes[fileName]) {
    function actualRequest(receiptsSent) {
      var xhr = new XMLHttpRequest();
      var canonical = document.querySelector("link[rel=canonical]");
      var canonicalHref = canonical && canonical.getAttribute("href");
      if (window.beta) {
        canonicalHref = canonicalHref.replace('https://www.choiceofgames.com/', 'https://www.choiceofgames.com/beta/');
      }
      var url = canonicalHref + "scenes/" + fileName + "?hash="+hashes.scenes[fileName];
      xhr.open("GET", url);
      xhr.withCredentials = true;
      xhr.onload = function() {
        var error;
        if (xhr.status !== 200) {
          try {
            error = JSON.parse(xhr.responseText).error;
          } catch (e) {}
        }
        if (xhr.status === 404) {
          try {
            if (error === "hash doesn't match") {
              return awaitAppUpdate(function() {
                callback("strange");
              })
            }
          } catch (e) {
            if (window.console) console.error(e, e.stack);
          }
        }
        if (xhr.status == 403 && _global.isOmnibusApp && _global.isAndroidApp) {
          if (!receiptsSent) {
            window.receiptRequestCallback = function(receipts) {
              window.receiptRequestCallback = null;
              submitReceipts(receipts, function(error) {
                if (error) {
                  return callback(error);
                } else {
                  actualRequest("receiptsSent");
                }
              });
            }
            androidBilling.requestReceipts();
            return;
          } else if (error === "not registered" || error == "not purchased") {
            return callback(error);
          }
        } else if (xhr.status !== 200) {
          return callback(xhr.status);
        }
        var result;
        try {
          result = jsonParse(xhr.responseText);
        } catch (e) {
          if (window.console) console.error(e, e.stack);
        }
        var ok = result && result.crc && result.lines && result.labels;
        if (!ok) return callback("network");
        window.store.set("cache_scene_"+sceneName, xhr.responseText, function() {
          window.store.set("cache_scene_hash_"+sceneName, hashes.scenes[fileName], function() {
            callback(null, result);
          });
        });
      };
      xhr.onerror = function() {
        callback("network");
      }
      console.log("updateSinglePaidSceneCache " + url);
      xhr.send();
    }
    actualRequest();
  }
}

function updateAllPaidSceneCaches(receiptsSent) {
  if (!isStoreSceneCacheRequired()) {
    if (window.isOmnibusApp && window.isAndroidApp) {
      window.receiptRequestCallback = submitReceipts;
      androidBilling.requestReceipts();
    }
    return;
  }
  if (_global.isOmnibusApp && _global.isAndroidApp && !receiptsSent) {
    window.receiptRequestCallback = function(receipts) {
      submitReceipts(receipts, function() {updateAllPaidSceneCaches("receiptsSent");});
    };
    androidBilling.requestReceipts();
    return;
  }
  var flipped = {};
  for (var scene in purchases) {
    if (/^fake:/.test(scene)) continue;
    scene = scene.replace(/ /g, "_");
    if (!flipped[purchases[scene]]) flipped[purchases[scene]] = [];
    flipped[purchases[scene]].push(scene);
  }
  var products = [];
  for (var product in flipped) {
    products.push(product);
  }
  if (!products.length) return;
  checkPurchase(products.join(" "), function(ok, result) {
    if (!ok || !result) return;
    var sceneList = [];
    var push = Array.prototype.push;
    for (var product in flipped) {
      if (result[product]) {
        push.apply(sceneList, flipped[product]);
      }
    }
    if (!sceneList.length) return;
    for (var i = 0; i < sceneList.length; i++) {
      (function(i) {
        var scene = sceneList[i];
        var fileName = scene + ".txt.json";
        window.store.get("cache_scene_hash_"+scene, function(ok, result) {
          if (!ok || result !== hashes.scenes[fileName]) {
            updateSinglePaidSceneCache(scene, function() {});
          }
        });
      })(i);
    }
  })
}

function checkForAppUpdates() {
  if (navigator.serviceWorker) {
    navigator.serviceWorker.getRegistration().then(function(reg) {
      if (reg) reg.update();
    });
  }
}

function refreshIfAppUpdateReady() {
  if (navigator.serviceWorker) {
    if (window.controllerchanged) {
      return window.location.reload();
    }
    navigator.serviceWorker.getRegistration().then(function(reg) {
      if (reg.waiting) {
        reg.waiting.postMessage('skipWaiting');
        return window.location.reload();
      }
    });
  }
}

function awaitAppUpdate(callback) {

  var serviceWorkerExists = (navigator.serviceWorker && navigator.serviceWorker.controller);
  if (!serviceWorkerExists) return callback();

  var calledBack = false;
  var maybeCallback = function() {
    if (calledBack) return;
    calledBack = true;
    callback();
  }

  if (window.controllerchanged) return maybeCallback();
  setTimeout(maybeCallback, 10000);
  navigator.serviceWorker.getRegistration().then(function(reg) {
    if (!reg) return maybeCallback();
    if (reg.waiting) {
      reg.waiting.postMessage('skipWaiting');
      return maybeCallback();
    }
    var watchStateChange = function() {
      if (this.state == 'installed') {
        if (reg.waiting) reg.waiting.postMessage('skipWaiting');
        maybeCallback();
      }
    };
    if (reg.installing) reg.installing.addEventListener('statechange', watchStateChange);
    reg.update();
    reg.addEventListener('updatefound', function() {
      reg.installing.addEventListener('statechange', watchStateChange);
    })
  });
}

function remoteConfig(variable, callback) {
  if (!_global.isOmnibusApp) {
    safeTimeout(function() {callback(null);}, 0);
    return;
  }
  if (_global.isIosApp) {
    var nonce = "remoteConfig" + variable + (+new Date);
    window[nonce] = function(value) {
      delete window[nonce];
      callback(value);
    }
    callIos("remoteconfig", variable + " " + nonce);
  } else {
    var result = (_global.androidRemoteConfig && androidRemoteConfig.remoteConfig(variable)) || null;
    return safeTimeout(function() {callback(result);}, 0);
  }
}

;
/*
 * Copyright 2010 by Dan Fabulich.
 *
 * Dan Fabulich licenses this file to you under the
 * ChoiceScript License, Version 1.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *  http://www.choiceofgames.com/LICENSE-1.0.txt
 *
 * See the License for the specific language governing
 * permissions and limitations under the License.
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied.
 */

;(function() {
  var lastTime = 0;
  if (!window.requestAnimationFrame)
    window.requestAnimationFrame = function(callback, element) {
        var currTime = new Date().getTime();
        var timeToCall = Math.max(0, 16 - (currTime - lastTime));
        var id = window.setTimeout(function() { callback(currTime + timeToCall); },
          timeToCall);
        lastTime = currTime + timeToCall;
        return id;
    };
})();

function printx(msg, parent) {
    if (msg === null || msg === undefined || msg === "") return;
    if (!parent) parent = document.getElementById('text');
    if (msg == " ") {
      // IE7 doesn't like innerHTML that's nothing but " "
      parent.appendChild(document.createTextNode(" "));
      return;
    }
    msg = replaceBbCode(msg);
    var frag = document.createDocumentFragment();
    temp = document.createElement('div');
    temp.innerHTML = msg;
    while (temp.firstChild) {
        frag.appendChild(temp.firstChild);
    }
    parent.appendChild(frag);
}

function replaceBbCode(msg) {
  return msg = String(msg).replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/\[url\=(.*?)\]/g, '<a href="$1">')
      .replace(/\[\/url\]/g, '</a>')
      .replace(/\[n\/\]/g, '<br>')
      .replace(/\[c\/\]/g, '')
      .replace(/\[b\]/g, '<b>')
      .replace(/\[\/b\]/g, '</b>')
      .replace(/\[i\]/g, '<i>')
      .replace(/\[\/i\]/g, '</i>')
      .replace(/\u2022([\s\S]*)/, '<ul>$1</ul>')
      .replace(/\u2022([^\u2022]*)/g, '<li>$1</li>')
}

function println(msg, parent) {
    if (!parent) parent = document.getElementById('text');
    printx(msg, parent);
    var br = window.document.createElement("br");
    parent.appendChild(br);
}

function printParagraph(msg, parent) {
  if (msg === null || msg === undefined || msg === "") return;
  if (!parent) parent = document.getElementById('text');
  msg = replaceBbCode(msg);
  p = document.createElement('p');
  p.innerHTML = msg;
  parent.appendChild(p);
  return p;
}

function showStats() {
    if (document.getElementById('loading')) return;
    var button = document.getElementById("statsButton");
    if (button && button.innerHTML == "Return to the Game") {
      return clearScreen(function() {
        setButtonTitles();
        loadAndRestoreGame();
      });
    }
    var currentScene = window.stats.scene;
    var scene = new Scene("choicescript_stats", window.stats, this.nav, {secondaryMode:"stats", saveSlot:"temp"});
    clearScreen(function() {
      setButtonTitles();
      scene.execute();
    })
}

function redirectFromStats(scene, label, originLine, callback) {
  if (window.isIosApp) {
    if (!label) label = "";
    callIos("redirectfromstats", scene + " " +label  + " " + originLine);
  } else if (window.isAndroidApp) {
    statsMode.redirectFromStats(scene, label || "", originLine);
  } else {
    safeTimeout(callback, 0);
  }
}

function returnFromStats() {
  if (window.isIosApp && !window.isIPad) {
    callIos("returntogame");
  } else if (window.isAndroidApp && window.statsMode.get()) {
    statsMode.returnToGame();
  } else {
    clearScreen(loadAndRestoreGame);
  }
}

function restoreCheckpointFromStats(callback) {
  safeTimeout(callback, 0);
}

function showAchievements(hideNextButton) {
  if (document.getElementById('loading')) return;
  var button = document.getElementById("achievementsButton");
  if (!button) return;
  if (button.innerHTML == "Return to the Game") {
    return clearScreen(function() {
      setButtonTitles();
      loadAndRestoreGame();
    });
  }
  clearScreen(function() {
    setButtonTitles();
    var button = document.getElementById("achievementsButton");
    button.innerHTML = "Return to the Game";
    checkAchievements(function() {
      printAchievements(document.getElementById("text"));
      if (!hideNextButton) printButton("Next", main, false, function() {
        clearScreen(function() {
          setButtonTitles();
          loadAndRestoreGame();
        });
      });
      curl();
    });
  });
}

function showMenu() {
  if (document.getElementById('loading')) return;
  var button = document.getElementById("menuButton");
  if (!button) return;
  if (button.innerHTML == "Return to the Game") {
    return clearScreen(function() {
      setButtonTitles();
      loadAndRestoreGame();
    });
  }
  function menu() {
    setButtonTitles();
    var button = document.getElementById("menuButton");
    button.innerHTML = "Return to the Game";
    options = [{name:"Return to the game.", group:"choice", resume:true}];
    if (window.isSteamworks) {
      options.push(
        {name:"Quit the game.", group:"choice", quit:true}
      )
    }
    if (nav.achievementList.length) options.push(
      { name: "View achievements.", group: "choice", achievements: true }
    );
    options.push(
      {name:"Restart the game.", group:"choice", restart:true},
      {name:"Change settings.", group:"choice", settings:true},
      {name:"Play more games like this.", group:"choice", moreGames:true}
    );
    if (isWebSavePossible() && !window.isSteamApp) {
      options.push(
        { name: "Email us at " + getSupportEmail() + ".", group: "choice", contactUs: true },
        { name: "Report a bug.", group: "choice", reportBug: true },
        { name: "Share this game with friends.", group: "choice", share: true },
      )
    }
    options.push(
      {name:"Email me when new games are available.", group:"choice", subscribe:true},
      {name:"Show keyboard shortcuts.", group:"choice", shortcuts:true}
    );
    if (document.getElementById("aboutLink")) {
      options.push({name:"View the credits.", group:"choice", credits:true});
    }
    var logoutLink = document.getElementById("logout");
    if (logoutLink && logoutLink.style.display !== "none") {
      options.push({ name: "Sign out.", group: "choice", logout: true });
    }
    printOptions([""], options, function(option) {
      if (option.resume) {
        return clearScreen(function() {
          setButtonTitles();
          loadAndRestoreGame();
        });
      } else if (option.quit) {
        require('electron').ipcRenderer.invoke('quit');
      } else if (option.achievements) {
        return showAchievements();
      } else if (option.restart) {
        if (_global.blockRestart) {
          asyncAlert("Please wait until the timer has run out.");
          return;
        }
        return clearScreen(function() {
          var text = document.getElementById('text');
          text.innerHTML = "Start over from the beginning?";
          var options = [
            {name: "Restart the game.", group:"choice", restart: true},
            {name: "Cancel.", group: "choice", restart: false },
          ]
          printOptions([""], options, function(option) {
            if (option.restart) {
              clearScreen(function() {
                setButtonTitles();
                restartGame();
              })
            } else {
              clearScreen(function() {
                setButtonTitles();
                loadAndRestoreGame();
              })
            }
          })
          curl();
        });
      } else if (option.settings) {
        textOptionsMenu({ size: 1, color: 1, animation: window.animationProperty, sliding: window.isMobile });
      } else if (option.credits) {
        absolutizeAboutLink();
        aboutClick();
      } else if (option.moreGames) {
        moreGames();
        curl();
      } else if (option.share) {
        clearScreen(function() {
          printShareLinks(document.getElementById("text"), "now");
          menu();
        });
      } else if (option.subscribe) {
        setButtonTitles();
        subscribeLink();
      } else if (option.contactUs) {
        window.location.href="mailto:"+getSupportEmail();
      } else if (option.reportBug) {
        clearScreen(function() {
          reportBug();
          showMenu();
        });
      } else if (option.shortcuts) {
        var dialog = document.getElementById('keyboardShortcuts');
        if (dialog && dialog.showModal) dialog.showModal();
      } else if (option.logout) {
        clearScreen(function() {
          logout();
          loginDiv();
          printParagraph("You have been signed out.");
          menu();
        })
      }
    });
    // show title and author on menu screen
    // this will be hidden on desktop web, but visible elsewhere
    changeTitle(document.title);
    changeAuthor(document.getElementById("author").innerText.substring(3));
    if (window.isSteamApp) {
      printParagraph("Need help? Email us at " + getSupportEmail() + ".");
    }
    curl();
  }
  clearScreen(menu);
}

function setButtonTitles() {
  var button;
  button = document.getElementById("menuButton");
  if (button) {
    button.innerHTML = "Menu";
  }
  button = document.getElementById("statsButton");
  if (button) {
    button.innerHTML = "Show Stats";
  }
  button = document.getElementById("achievementsButton");
  if (button) {
    if (nav.achievementList.length) {
      button.style.display = "";
      button.innerHTML = "Achievements";
    } else {
      button.style.display = "none";
    }
  }
}


function textOptionsMenu(categories) {
  if (!categories) {
    categories = {size:1, color:1, animation:window.animationProperty, sliding: window.isMobile};
  }
  clearScreen(function() {
    var button = document.getElementById("menuButton");
    if (button) button.innerHTML = "Return to the Game";
    var text = document.getElementById("text");
    var oldZoom = getZoomFactor();
    if (categories.settings) {
      text.innerHTML = "<p>Change the game's settings.</p>";
    } else if (categories.size && categories.color) {
      text.innerHTML = "<p>Change the game's appearance.</p>";
    } else if (categories.size) {
      text.innerHTML = "<p>Make the text bigger or smaller.</p>";
    } else if (categories.color) {
      text.innerHTML = "<p>Change the background color.</p>";
    } else if (categories.animation) {
      text.innerHTML = "<p>Change the animation between pages.</p>";
    } else if (categories.sliding) {
      text.innerHTML = "<p>Enable or disable touch slide controls.</p>";
    }
    options = [
      {name:"Return to the game.", group:"choice", resume:true},
    ];
    if (categories.size) {
      options.push(
        {name:"Make the text bigger.", group:"choice", bigger:true},
        {name:"Make the text smaller.", group:"choice", smaller:true}
      );
      if (oldZoom <= 0.5) {
        options[options.length-1].unselectable = true;
      }
      if (oldZoom !== 1) {
        options.push({name:"Reset the text to its original size.", group:"choice", reset:true});
      }
    }
    if (categories.color) options.push(
      {name:"Use a black background.", group:"choice", color:"black"},
      {name:"Use a sepia background.", group:"choice", color:"sepia"},
      {name:"Use a white background.", group:"choice", color:"white"}
    );
    if (categories.animation) {
      if (window.animateEnabled) {
        options.push({ name: "Don't animate between pages.", group: "choice", animation: 2 });
      } else {
        options.push({ name: "Animate between pages.", group: "choice", animation: 1 });
      }
    }
    if (categories.sliding) {
      if (window.slidingEnabled !== false) {
        options.push({ name: "Disable touch slide controls.", group: "choice", sliding: 1 });
      } else {
        options.push({ name: "Enable touch slide controls.", group: "choice", sliding: 2 });
      }
    }
    printOptions([""], options, function(option) {
      if (option.resume) {
        return clearScreen(function() {
          setButtonTitles();
          loadAndRestoreGame();
        });
      } else if (option.color) {
        changeBackgroundColor(option.color);
      } else if (option.reset) {
        setZoomFactor(1);
      } else if (option.animation) {
        window.animateEnabled = option.animation !== 2;
        if (initStore()) store.set("preferredAnimation", parseFloat(option.animation));
      } else if (option.sliding) {
        window.slidingEnabled = option.sliding == 2;
        if (initStore()) store.set("preferredSliding", window.slidingEnabled);
      } else {
        changeFontSize(option.bigger);
      }
      textOptionsMenu(categories);
    })
    curl();
  });
}

function getZoomFactor() {
  if (document.documentElement.style.fontSize === undefined) {
    return window.zoomFactor || 1;
  } else {
    var fontSize = parseFloat(document.documentElement.style.fontSize);
    if (isNaN(fontSize)) fontSize = 100;
    return fontSize / 100;
  }
}

function setZoomFactor(zoomFactor) {
  document.documentElement.style.fontSize = Math.round(100*zoomFactor) + "%";
  window.zoomFactor = zoomFactor;
  if (initStore()) store.set("preferredZoom", String(zoomFactor));
}

function changeFontSize(bigger) {
  var oldZoom = getZoomFactor();
  if (bigger) {
    setZoomFactor(oldZoom + 0.1);
  } else {
    setZoomFactor(oldZoom - 0.1);
  }
}

function changeBackgroundColor(color) {
  if (color === "sepia") {
    document.body.classList.remove("nightmode");
    document.body.classList.remove("whitemode");
  } else if (color === "black") {
    document.body.classList.remove("whitemode");
    document.body.classList.add("nightmode");
  } else if (color === "white") {
    document.body.classList.remove("nightmode");
    document.body.classList.add("whitemode");
  }
  if (initStore()) store.set("preferredBackground", color);
}

function isNightMode() {
  return document.body.classList.contains("nightmode");
}

function spell(num) {
  if (num > 99) return num;
  var smallNumbers = ["zero", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen", "sixteen", "seventeen", "eighteen", "nineteen"];
  var tens = ["zero", "ten", "twenty", "thirty", "forty", "fifty", "sixty", "seventy", "eighty", "ninety"];
  if (num < 20) {
    return smallNumbers[num];
  }
  var onesDigit = num % 10;
  if (onesDigit === 0) {
    return tens[num / 10];
  }
  var tensDigit = (num - onesDigit) / 10;
  return tens[tensDigit]+"-"+smallNumbers[onesDigit];
}

function printAchievements(target) {
  var unlockedBuffer = [];
  var lockedBuffer = [];
  var achievedCount = 0, hiddenCount = 0, score = 0, totalScore = 0;
  var totalAchievements = nav.achievementList.length;
  var buffer;
  for (var i = 0; i < totalAchievements; i++) {
    var name = nav.achievementList[i];
    var achievement = nav.achievements[name];
    var points = achievement.points;
    totalScore += points;

    var description;

    if (nav.achieved[name]) {
      achievedCount++;
      score += points;
      buffer = unlockedBuffer;
      description = achievement.earnedDescription;
    } else {
      if (achievement.visible) {
        buffer = lockedBuffer;
        description = achievement.preEarnedDescription;
      } else {
        hiddenCount++;
        continue;
      }
    }

    if (buffer.length) buffer.push("<br>");
    buffer.push("<b>");
    buffer.push(achievement.title.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'));
    buffer.push(":");
    buffer.push("</b> ");
    buffer.push(description.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;')
      .replace(/\[b\]/g, '<b>')
      .replace(/\[\/b\]/g, '</b>')
      .replace(/\[i\]/g, '<i>')
      .replace(/\[\/i\]/g, '</i>')
    );
    buffer.push(" (");
    buffer.push(points);
    buffer.push(" points)");
  }

  // What if there's exactly one achievement worth exactly one point?
  if (achievedCount === 0) {
    if (hiddenCount === 0) {
      buffer = ["You haven't unlocked any achievements yet. There are "+spell(totalAchievements)+" possible achievements, worth a total of "+totalScore+" points.<p>"];
    } else if (hiddenCount == 1) {
      buffer = ["You haven't unlocked any achievements yet. There are "+spell(totalAchievements)+" possible achievements (including one hidden achievement), worth a total of "+totalScore+" points.<p>"];
    } else if (hiddenCount == totalAchievements) {
      buffer = ["You haven't unlocked any achievements yet. There are "+spell(totalAchievements)+" hidden achievements, worth a total of "+totalScore+" points.<p>"];
    } else {
      buffer = ["You haven't unlocked any achievements yet. There are "+spell(totalAchievements)+" possible achievements (including "+spell(hiddenCount)+" hidden achievements), worth a total of "+totalScore+" points.<p>"];
    }
    if (lockedBuffer.length) {
      buffer.push.apply(buffer, lockedBuffer);
      buffer.push("<p>");
    }
  } else if (score == totalScore) {
    if (totalAchievements == 2) {
      buffer = ["Congratulations! You have unlocked both achievements, earning a total of "+score+" points, a perfect score.<p>"];
    } else {
      buffer = ["Congratulations! You have unlocked all "+spell(totalAchievements)+" achievements, earning a total of "+score+" points, a perfect score.<p>"];
    }
    buffer.push.apply(buffer, unlockedBuffer);
    buffer.push("<p>");
  } else {
    buffer = ["You have unlocked "+spell(achievedCount)+" out of "+spell(totalAchievements)+" possible achievements, earning you a score of "+score+" out of a possible "+totalScore+" points.<p>"];
    buffer.push.apply(buffer, unlockedBuffer);
    var remaining = totalAchievements-achievedCount;
    if (remaining == hiddenCount) {
      if (remaining == 1) {
        buffer.push("<p>There is still one hidden achievement remaining.<p>");
      } else {
        buffer.push("<p>There are still " + spell(remaining) + " hidden achievements remaining.<p>");
      }
    } else if (hiddenCount > 1) {
      buffer.push("<p>There are still "+spell(remaining)+" achievements remaining, including "+spell(hiddenCount)+" hidden achievements.<p>");
    } else if (hiddenCount == 1) {
      buffer.push("<p>There are still "+spell(remaining)+" achievements remaining, including one hidden achievement.<p>");
    } else if (remaining == 1) {
      buffer.push("<p>There is still one achievement remaining.<p>");
    } else {
      buffer.push("<p>There are still "+spell(remaining)+" achievements remaining.<p>");
    }
    if (lockedBuffer.length) {
      buffer.push.apply(buffer, lockedBuffer);
      buffer.push("<p>");
    }
  }

  target.innerHTML = buffer.join("");
}

function asyncAlert(message, callback) {
  if (!callback) callback = function(){};
  if (window.isIosApp) {
    window.alertCallback = callback;
    callIos("alert", message);
  } else if (window.isAndroidApp) {
    setTimeout(function() {
      alert(message);
      if (callback) callback();
    }, 0);
  } else if (window.isWinOldApp) {
    setTimeout(function() {
      window.external.Alert(message);
      if (callback) callback();
    }, 0);
  } else {
    alertify.alert(message, function() {safeCall(null, callback);});
  }
}

function asyncConfirm(message, callback) {
  if (false/*window.isIosApp*/) {
    // TODO asyncConfirm
    window.confirmCallback = callback;
    callIos("confirm", message);
  } else if (window.isAndroidApp) {
    setTimeout(function() {
      var result = confirm(message);
      if (callback) callback(result);
    }, 0);
  } else if (window.isWinOldApp) {
    setTimeout(function() {
      var result = window.external.Confirm(message);
      if (callback) callback(result);
    }, 0);
  } else {
    alertify.confirm(message, function(result) {safeCall(null, callback(result));});
  }
}


function clearScreen(code) {
    var text = document.getElementById("text");
    var container1 = document.getElementById("container1");
    if (!container1) throw new Error("<div id=container1> is missing from index.html");

    if (window.animateEnabled && window.animationProperty && !window.isIosApp && !document.getElementById('container2')) {
      var container2 = document.createElement("div");
      container2.setAttribute("id", "container2");
      container2.classList.add('container');
      document.body.classList.add('frozen');
      container2.style.opacity = 0;


      // get the vertical scroll position as pageYOffset
      // translate up by pageYOffset pixels, then scroll to the top
      // now we're scrolled up, but the viewport *looks* like it has retained its scroll position
      var pageYOffset = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
      var extraScroll = 0;
      if (window.isMobile && window.isWeb && window.isAndroid && !/Chrome/.test(navigator.userAgent)) {
        extraScroll = 1; // try to hide url bar
      }
      pageYOffset -= extraScroll;
      container1.style.transform = "translateY(-"+pageYOffset+ "px)";
      container1.style.webkitTransform = "translateY(-"+pageYOffset+ "px)";
      window.scrollTo(0,extraScroll);

      container2.innerHTML = container1.innerHTML;
      [].forEach.call(container1.querySelectorAll('input,button,a,textarea,label'), function(element) {
        element.setAttribute("tabindex", "-1");
        element.removeAttribute("accesskey");
      });

      document.body.insertBefore(container2, container1);
      main = document.getElementById("main");
      main.innerHTML = "";
      text = document.createElement("div");
      text.setAttribute("id", "text");
      main.appendChild(text);
      if (window.isChromeApp) fixChromeLinks();
    } else {
      main = document.getElementById("main");
      main.innerHTML = "";
      text = document.createElement("div");
      text.setAttribute("id", "text");
      main.appendChild(text);

      window.scrollTo(0,1);
    }


    var useAjax = true;
    if (isWeb && window.noAjax) {
      useAjax = false;
    }

    if (useAjax) {
      doneLoading();
      safeCall(null, code);
    } else {
      if (!initStore()) alert("Your browser has disabled cookies; this game requires cookies to work properly.  Please re-enable cookies and refresh this page to continue.");
      startLoading();
      var form = window.document.createElement("form");
      var axn = window.location.protocol + "//" + window.location.host + window.location.pathname;
      form.setAttribute("action", axn);
      form.setAttribute("method", "POST");
      main.appendChild(form);
      form.submit();
    }
}

// in the iOS app, display a page curl animation
function curl() {
  var focusFirst = function() {
    var text = document.getElementById("text");
    if (text && text.firstElementChild) {
      var focusable = text.firstElementChild;
      if (/^img$/i.test(focusable.tagName) && focusable.complete === false) {
        focusable.addEventListener("load", focusFirst);
        return;
      }
      focusable.setAttribute("tabindex", "-1");
      focusable.classList.add("tempfocus");
      focusable.focus();
      focusable.blur();
      requestAnimationFrame(function() {
        focusable.focus();
        requestAnimationFrame(function() {
          focusable.blur();
          focusable.removeAttribute("tabindex");
          focusable.classList.remove("tempfocus");
        });
      });
    }
  }

  // TODO force a reflow before curling the page
  var container2 = document.getElementById('container2');
  if (!container2) {
    focusFirst();
    return window.animateEnabled ? callIos("curl") : callIos("unfreeze");
  }

  var container1 = document.getElementById('container1');
  var onContainer1Disappeared = function(e) {
    if (container1.parentElement) container1.parentElement.removeChild(container1);
  };
  var onContainer2Appeared = function(e) {
    document.body.classList.remove('frozen');
    focusFirst();
    container2.removeEventListener('transitionend', onContainer2Appeared);
    container2.removeEventListener('webkitTransitionEnd', onContainer2Appeared);
  };

  if (!window.isIosApp && window.animationProperty) {
    var slideoutStyle = document.getElementById('slideoutStyle');
    if (!slideoutStyle) {
      slideoutStyle = document.createElement("style");
      slideoutStyle.setAttribute("id", "slideoutStyle");
      document.head.appendChild(slideoutStyle);
    }

    var shouldSlide = true;

    var timingFunction = "\n.container { transition-timing-function: ease-in; };";
    if (shouldSlide) timingFunction = "";

    slideoutStyle.innerHTML = "@keyframes containerslideout { "+
      "from { transform: "+container1.style.transform+"; } " +
      "to   { transform: "+container1.style.transform+" translateX(-105%); } }\n"+
      "@-webkit-keyframes containerslideout { "+
      "from { -webkit-transform: "+container1.style.webkitTransform+"; } " +
      "to   { -webkit-transform: "+container1.style.webkitTransform+" translateX(-105%); } }"+
      timingFunction;

    // double rAF so we start after container1 is transformed and scrolled to the top
    // minimizes flicker on iOS
    requestAnimationFrame(function() {
      requestAnimationFrame(function() {
        if (shouldSlide) {
          var fastApple = window.isIPad || window.isIPhone || window.isMacApp;
          var slowAndroid = window.isAndroidApp && /Android 4/.test(navigator.userAgent);
          var useCssAnimations = true; // fastApple || slowAndroid;
          if (useCssAnimations) {
            container1.style[window.animationProperty] = 'containerslideout';
            container2.style[window.animationProperty] = 'containerslidein';
          } else {
            var frames = 0;
            var durationInSeconds = 0.5;
            var framesPerSecond = 60;
            var totalSteps = framesPerSecond * durationInSeconds;
            var oldContainer1Transform = container1.style.transform;
            var rafSlide = function(stamp) {
              var fraction = frames / totalSteps;
              // ease approximation https://github.com/mietek/ease-tween/blob/master/src/index.js
              fraction = 1.0042954579734844 * Math.exp(
                -6.4041738958415664 * Math.exp(
                  -7.2908241330981340 * fraction));
              container1.style.transform = container1.style.webkitTransform =
                oldContainer1Transform + " translateX(-" + (105 * fraction) + "%)";
              container2.style.transform = container2.style.webkitTransform =
                "translateX(" + (100 - 100 * fraction) + "%)";
              if (frames < totalSteps) {
                frames++;
                requestAnimationFrame(rafSlide);
              }
            }
            requestAnimationFrame(rafSlide);
          }
        }
        container1.style.opacity = 0;
        container2.style.opacity = 1;
        container1.addEventListener('transitionend', onContainer1Disappeared);
        container2.addEventListener('transitionend', onContainer2Appeared);
        container1.addEventListener('webkitTransitionEnd', onContainer1Disappeared);
        container2.addEventListener('webkitTransitionEnd', onContainer2Appeared);
      })
    })
  } else {
    onContainer2Appeared();
    onContainer1Disappeared();
    window.animateEnabled ? callIos("curl") : callIos("unfreeze");
  }

  container1.removeAttribute("id");
  container2.setAttribute("id", "container1");
}

function safeSubmit(code) {
    return function safelySubmitted() {
        safeCall(code);
        return false;
    };
}

function startLoading() {
    var loading = document.getElementById('loading');
    if (!loading) {
      safeCall(null, function() {
        loading = document.createElement('div');
        loading.setAttribute("id", "loading");
        loading.innerHTML = (/MSIE [67]/.test(navigator.userAgent)?"":"<img src=\"data:image/gif;base64,R0lGODlhgAAPAPEAAPf08WJhYMvJx2JhYCH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAgAAPAAACo5QvoIC33NKKUtF3Z8RbN/55CEiNonMaJGp1bfiaMQvBtXzTpZuradUDZmY+opA3DK6KwaQTCbU9pVHc1LrDUrfarq765Ya9u+VRzLyO12lwG10yy39zY11Jz9t/6jf5/HfXB8hGWKaHt6eYyDgo6BaH6CgJ+QhnmWWoiVnI6ddJmbkZGkgKujhplNpYafr5OooqGst66Uq7OpjbKmvbW/p7UAAAIfkECQoAAAAsAAAAAIAADwAAArCcP6Ag7bLYa3HSZSG2le/Zgd8TkqODHKWzXkrWaq83i7V5s6cr2f2TMsSGO9lPl+PBisSkcekMJphUZ/OopGGfWug2Jr16x92yj3w247bh6teNXseRbyvc0rbr6/x5Ng0op4YSJDb4JxhI58eliEiYYujYmFi5eEh5OZnXhylp+RiaKQpWeDf5qQk6yprawMno2nq6KlsaSauqS5rLu8cI69k7+ytcvGl6XDtsyzxcAAAh+QQJCgAAACwAAAAAgAAPAAACvpw/oIC3IKIUb8pq6cpacWyBk3htGRk1xqMmZviOcemdc4R2kF3DvfyTtFiqnPGm+yCPQdzy2RQMF9Moc+fDArU0rtMK9SYzVUYxrASrxdc0G00+K8ruOu+9tmf1W06ZfsfXJfiFZ0g4ZvEndxjouPfYFzk4mcIICJkpqUnJWYiYs9jQVpm4edqJ+lkqikDqaZoquwr7OtHqAFerqxpL2xt6yQjKO+t7bGuMu1L8a5zsHI2MtOySVwo9fb0bVQAAIfkECQoAAAAsAAAAAIAADwAAAsucP6CAt9zSErSKZyvOd/KdgZaoeaFpRZKiPi1aKlwnfzBF4jcNzDk/e7EiLuLuhzwqayfmaNnjCCGNYhXqw9qcsWjT++TqxIKp2UhOprXf7PoNrpyvQ3p8fAdu82o+O5w3h2A1+Nfl5geHuLgXhEZVWBeZSMnY1oh5qZnyKOhgiGcJKHqYOSrVmWpHGmpauvl6CkvhaUD4qejaOqvH2+doV7tSqdsrexybvMsZrDrJaqwcvSz9i9qM/Vxs7Qs6/S18a+vNjUx9/v1TAAAh+QQJCgAAACwAAAAAgAAPAAAC0Zw/oIC33NKKUomLxct4c718oPV5nJmhGPWwU9TCYTmfdXp3+aXy+wgQuRRDSCN2/PWAoqVTCSVxilQZ0RqkSXFbXdf3ZWqztnA1eUUbEc9wm8yFe+VguniKPbNf6mbU/ubn9ieUZ6hWJAhIOKbo2Pih58C3l1a5OJiJuflYZidpgHSZCOnZGXc6l3oBWrE2aQnLWYpKq2pbV4h4OIq1eldrigt8i7d73Ns3HLjMKGycHC1L+hxsXXydO9wqOu3brPnLXL3C640sK+6cTaxNflEAACH5BAkKAAAALAAAAACAAA8AAALVnD+ggLfc0opS0SeyFnjn7oGbqJHf4mXXFD2r1bKNyaEpjduhPvLaC5nJEK4YTKhI1ZI334m5g/akJacAiDUGiUOHNUd9ApTgcTN81WaRW++Riy6Tv/S4dQ1vG4ps4NwOaBYlOEVYhYbnplexyJf3ZygGOXkWuWSZuNel+aboV0k5GFo4+qN22of6CMoq2kr6apo6m5fJWCoZm+vKu2Hr6KmqiHtJLKebRhuszNlYZ3ncewh9J9z8u3mLHA0rvetrzYjd2Wz8bB6oNO5MLq6FTp2+bVUAACH5BAkKAAAALAAAAACAAA8AAALanD+ggLfc0opS0XeX2Fy8zn2gp40ieHaZFWHt9LKNO5eo3aUhvisj6RutIDUZgnaEFYnJ4M2Z4210UykQ8BtqY0yHstk1UK+/sdk63i7VYLYX2sOa0HR41S5wi7/vcMWP1FdWJ/dUGIWXxqX3xxi4l0g4GEl5yOHIBwmY2cg1aXkHSjZXmbV4uoba5kkqelbaapo6u0rbN/SZG7trKFv7e6savKTby4voaoVpNAysiXscV4w8fSn8fN1pq1kd2j1qDLK8yYy9/ff9mgwrnv2o7QwvGO1ND049UgAAIfkECQoAAAAsAAAAAIAADwAAAticP6CAt9zSilLRd2d8onvBfV0okp/pZdamNRi7ui3yyoo4Ljio42h+w6kgNiJt5kAaasdYE7D78YKlXpX6GWphxqTT210qK1Cf9XT2SKXbYvv5Bg+jaWD5ekdjU9y4+PsXRuZHRrdnZ5inVidAyCTXF+nGlVhpdjil2OE49hjICVh4qZlpibcDKug5KAlHOWqqR8rWCjl564oLFruIucaYGlz7+XoKe2wsIqxLzMxaxIuILIs6/JyLbZsdGF063Uu6vH2tXc79LZ1MLWS96t4JH/rryzhPWgAAIfkECQoAAAAsAAAAAIAADwAAAtWcP6CAt9zSilLRd2fEe4kPCk8IjqTonZnVsQ33arGLwLV8Kyeqnyb5C60gM2LO6MAlaUukwdbcBUspYFXYcla00KfSywRzv1vpldqzprHFoTv7bsOz5jUaUMer5vL+Mf7Hd5RH6HP2AdiUKLa41Tj1Acmjp0bJFuinKKiZyUhnaBd5OLnzSNbluOnZWQZqeVdIYhqWyop6ezoquTs6O0aLC5wrHErqGnvJibms3LzKLIYMe7xnO/yL7TskLVosqa1aCy3u3FrJbSwbHpy9fr1NfR4fUgAAIfkECQoAAAAsAAAAAIAADwAAAsqcP6CAt9zSilLRd2fEW7cnhKIAjmFpZla3fh7CuS38OrUR04p5Ljzp46kgMqLOaJslkbhbhfkc/lAjqmiIZUFzy2zRe5wGTdYQuKs9N5XrrZPbFu94ZYE6ms5/9cd7/T824vdGyIa3h9inJQfA+DNoCHeomIhWGUcXKFIH6RZZ6Bna6Zg5l8JnSamayto2WtoI+4jqSjvZelt7+URKpmlmKykM2vnqa1r1axdMzPz5LLooO326Owxd7Bzam4x8pZ1t3Szu3VMOdF4AACH5BAkKAAAALAAAAACAAA8AAAK/nD+ggLfc0opS0XdnxFs3/i3CSApPSWZWt4YtAsKe/DqzXRsxDqDj6VNBXENakSdMso66WzNX6fmAKCXRasQil9onM+oziYLc8tWcRW/PbGOYWupG5Tsv3TlXe9/jqj7ftpYWaPdXBzbVF2eId+jYCAn1KKlIApfCSKn5NckZ6bnJpxB2t1kKinoqJCrlRwg4GCs4W/jayUqamaqryruES2b72StsqgvsKlurDEvbvOx8mzgazNxJbD18PN1aUgAAIfkECQoAAAAsAAAAAIAADwAAArKcP6CAt9zSilLRd2fEWzf+ecgjlKaQWZ0asqPowAb4urE9yxXUAqeZ4tWEN2IOtwsqV8YkM/grLXvTYbV4PTZpWGYU9QxTxVZyd4wu975ZZ/qsjsPn2jYpatdx62b+2y8HWMTW5xZoSIcouKjYePeTh7TnqFcpabmFSfhHeemZ+RkJOrp5OHmKKapa+Hiyyokaypo6q1CaGDv6akoLu3DLmLuL28v7CdypW6vsK9vsE1UAACH5BAkKAAAALAAAAACAAA8AAAKjnD+ggLfc0opS0XdnxFs3/nkISI2icxokanVt+JoxC8G1fNOlm6tp1QNmZj6ikDcMrorBpBMJtT2lUdzUusNSt9qurvrlhr275VHMvI7XaXAbXTLLf3NjXUnP23/qN/n8d9cHyEZYpoe3p5jIOCjoFofoKAn5CGeZZaiJWcjp10mZuRkaSAq6OGmU2lhp+vk6iioay3rpSrs6mNsqa9tb+ntQAAA7AAAAAAAAAAAA\">");
        document.body.appendChild(loading);
      });
    }
    callIos('startspinner');
}

function doneLoading() {
    var loading = document.getElementById('loading');
    if (loading) loading.parentNode.removeChild(loading);
    // TODO update header?
    callIos('stopspinner');
    if (window.doneLoadingCallback) {
      var callback = doneLoadingCallback;
      delete window.doneLoadingCallback;
      // long delay to ensure the spinner is fully stopped before continuing
      setTimeout(callback, 10);
    }
}

function setClass(element, classString) {
  element.setAttribute("class", classString);
  element.setAttribute("className", classString);
}

function printFooter() {
  // var footer = document.getElementById('footer');
  // We could put anything we want in the footer here, but perhaps we should avoid it.
  var statsButton = document.getElementById("statsButton");
  if (statsButton) {
    if (window.stats && stats.scene && stats.scene.secondaryMode == "stats") {
      statsButton.innerHTML = "Return to the Game";
    } else {
      statsButton.innerHTML = "Show Stats";
      if (window.isAndroidApp && window.statsMode.get()) {
        showStats();
      }
    }
  }
  curl();
}

// retrieve value of HTML form
function getFormValue(name) {
    var field = document.forms[0][name];
    if (!field) return "";
    // may return either one field or an array of fields
    if (field.checked) return field.value;
    for (var i = 0; i < field.length; i++) {
        var element = field[i];
        if (element.checked) return element.value;
    }
    return null;
}

function printCheckboxes(options, submitButtonNameFunction, callback) {
  var form = document.createElement("form");
  main.appendChild(form);
  var self = this;
  form.action = "#";
  form.onclick = function () {
    var count = 0;
    var checkboxes = optionsDiv.querySelectorAll('input[type=checkbox]');
    for (var i = 0; i < options.length; i++) {
      if (checkboxes[i].checked) count++;
    }
    var button = form.querySelector('input[type=submit]');
    button.value = button.name = submitButtonNameFunction(count);
  }
  form.onsubmit = function () {
    var results = [];
    var checkboxes = optionsDiv.querySelectorAll('input[type=checkbox]');
    for (var i = 0; i < options.length; i++) {
      results[i] = checkboxes[i].checked;
    }
    callback(results);
    return false;
  };
  var checked = false;
  var massSelections = document.createElement("div");
  var selectAll = document.createElement("button");
  selectAll.setAttribute("type", "button");
  massSelections.appendChild(selectAll);
  selectAll.innerHTML = "Select All";
  selectAll.addEventListener("click", function() {
    var checkboxes = optionsDiv.querySelectorAll('input[type=checkbox]');
    for (var i = 0; i < checkboxes.length; i++) {
      checkboxes[i].checked = true;
    }
  });
  massSelections.appendChild(document.createTextNode(' '));
  var selectNone = document.createElement("button");
  selectNone.setAttribute("type", "button");
  massSelections.appendChild(selectNone);
  selectNone.innerHTML = "Select None";
  selectNone.addEventListener("click", function () {
    var checkboxes = optionsDiv.querySelectorAll('input[type=checkbox]');
    for (var i = 0; i < checkboxes.length; i++) {
      checkboxes[i].checked = false;
    }
  });
  form.appendChild(massSelections);
  var optionsDiv = document.createElement("div");
  form.appendChild(optionsDiv);
  setClass(optionsDiv, "choice");
  for (var i = 0; i < options.length; i++) {
    var option = options[i];
    var isLast = (i == options.length - 1);
    printOptionButton(optionsDiv, "checkbox", null, option, i, i, isLast, checked);
  }
  printButton(submitButtonNameFunction(checked ? options.length : 0), form, true);
}

function printOptions(groups, options, callback) {
  var form = document.createElement("form");
  main.appendChild(form);
  var self = this;
  form.action="#";
  form.onsubmit = function() {
      safeCall(self, function() {
        var currentOptions = options;
        var option, group;
        for (var i = 0; i < groups.length; i++) {
            if (i > 0) {
                currentOptions = option.suboptions;
            }
            group = groups[i];
            if (!group) group = "choice";
            var value = getFormValue(group);
            if (value === null || value === undefined) {
              if (groups.length == 1) {
                asyncAlert("Please choose one of the available options first.");
              } else {
                var article = "a";
                if (/^[aeiou].*/i.test(group)) article = "an";
                asyncAlert("Please choose " + article + " " + group + " first.");
              }
              return;
            }
            option = currentOptions[value];
        }

        if (groups.length > 1 && option.unselectable) {
          asyncAlert("Sorry, that combination of choices is not allowed. Please select a different " + groups[groups.length-1] + ".");
          return;
        }
        safeCall(null, function() {callback(option);});
      });
      return false;
  };

  if (!options) throw new Error("undefined options");
  if (!options.length) throw new Error("no options");
  // global num will be used to assign accessKeys to the options
  var globalNum = 1;
  var currentOptions = options;
  for (var groupNum = 0; groupNum < groups.length; groupNum++) {
      var group = groups[groupNum];
      if (group) {
          var textBuilder = ["Select "];
          textBuilder.push(/^[aeiou]/i.test(group)?"an ":"a ");
          textBuilder.push(group);
          textBuilder.push(":");

          var p = document.createElement("p");
          p.appendChild(document.createTextNode(textBuilder.join("")));
          form.appendChild(p);
      }
      var div = document.createElement("div");
      form.appendChild(div);
      setClass(div, "choice");
      var checked = null;
      for (var optionNum = 0; optionNum < currentOptions.length; optionNum++) {
          var option = currentOptions[optionNum];
          if (!checked && !option.unselectable) checked = option;
          var isLast = (optionNum == currentOptions.length - 1);
          printOptionButton(div, "radio", group, option, optionNum, globalNum++, isLast, checked == option);
      }
      // for rendering, the first options' suboptions should be as good as any other
      currentOptions = currentOptions[0].suboptions;
  }

  var touchStartHandler = function (e) {
    if (e.touches.length > 1) return;
    var target = e.target;
    var rect = target.getBoundingClientRect();
    var shuttle;
    var shuttleWidth = rect.width * 0.2;
    //console.log(rect);
    var lastMouse = e.touches[0];
    var draw = function () {
      var transformX = rect.width + rect.left - lastMouse.clientX - (shuttleWidth/2);
      if (transformX < 0) transformX = 0;
      var maxX = rect.width - shuttleWidth - 2;
      if (transformX > maxX) transformX = maxX;
      if (target.parentElement) {
        if (transformX >= maxX * 0.8) {
          target.parentElement.classList.add('selected');
        } else {
          target.parentElement.classList.remove('selected');
        }
      }
      if (shuttle) {
        shuttle.style.transform = "translateX(-" + transformX + "px)"
        shuttle.style.webkitTransform = "translateX(-" + transformX + "px)"
      }
    };
    var outsideTimeout = null;
    var moveTracker = function(e) {
      e.preventDefault();
      lastMouse = e.touches[0];
      // on iPad app, touchend doesn't fire outside webview (touchmove does)
      // so, fire a fake touchend 300 ms after touchmove outside webview
      if (window.isIosApp && window.isIPad) {
        if (outsideTimeout) {
          clearTimeout(outsideTimeout);
          outsideTimeout = null;
        }
        if (lastMouse.pageY < 0 || lastMouse.pageX < 0) {
          outsideTimeout = setTimeout(function() {
            document.body.dispatchEvent(new Event('touchend'));
          }, 300);
        }
      }
      window.requestAnimationFrame(draw);
    }
    if ((e.touches[0].clientX - rect.left) > rect.width - shuttleWidth) {
      shuttle = document.createElement("div");
      shuttle.classList.add("shuttle");
      target.appendChild(shuttle);
      shuttle.style.width = shuttleWidth + "px";
      document.body.addEventListener('touchmove', moveTracker, {passive: false});
      var touchEnd = function(e) {
        document.body.removeEventListener('touchmove', moveTracker, {passive: false});
        document.body.removeEventListener('touchend', touchEnd);
        if (target.parentElement && target.parentElement.classList.contains('selected')) {
          if (target.click) {
            target.click();
          } else {
            var event = document.createEvent('Events');
            event.initEvent("click", true, true);
            target.dispatchEvent(event);
          }
          if (window.isIosApp) {
            window.freezeCallback = function() {
              window.freezeCallback = null;
              form.onsubmit();
            };
            callIos("freeze");
          } else {
            safeCall(null, function() {form.onsubmit();});
          }
        } else {
          if (shuttle.style.opacity !== "0") {
            shuttle.style.opacity = 0;
            var removeShuttle = function(e) {
              if (shuttle.parentElement) shuttle.parentElement.removeChild(shuttle);
            };
            shuttle.addEventListener('transitionend', removeShuttle);
            shuttle.addEventListener('webkitTransitionEnd', removeShuttle);
          } else {
            if (shuttle.parentElement) shuttle.parentElement.removeChild(shuttle);
          }
        }
      };
      document.body.addEventListener('touchend', touchEnd);
    }
    //console.log(e);
  };

  var slidingEnabled = true;
  if (window.slidingEnabled === false || groups.length > 1) slidingEnabled = false;

  if (slidingEnabled) [].forEach.call(document.querySelectorAll('.choice > div'), function(label) {
    label.addEventListener('touchstart', touchStartHandler);
    if (window.isMobile) label.addEventListener('click', function(e) {
      var target = e.currentTarget;
      if (document.body.querySelector(".shuttle.discovery")) return;
      var shuttle = document.createElement("div");
      shuttle.classList.add("shuttle");
      shuttle.classList.add("discovery");
      target.appendChild(shuttle);
      var animationEnd = function(e) {
        if (e.animationName === 'shuttlefadeout') {
          if (shuttle.parentElement) shuttle.parentElement.removeChild(shuttle);
        }
      };
      shuttle.addEventListener('animationend', animationEnd);
      shuttle.addEventListener('webkitAnimationEnd', animationEnd);
    })
  });

  var useRealForm = false;
  if (useRealForm) {
    printButton("Next", form, false);
  } else {
    printButton("Next", main, false, function() {
      form.onsubmit();
    });
  }
}

function printOptionButton(div, type, name, option, localChoiceNumber, globalChoiceNumber, isLast, checked) {
    var line = option.name;
    var unselectable = false;
    if (!name) unselectable = option.unselectable;
    var disabledString = unselectable ? " disabled" : "";
    var id = name + localChoiceNumber + "-" + Math.random().toString(36).substring(2);
    if (!name) name = "choice";
    var radio;
    var div2 = document.createElement("div");
    var label = document.createElement("label");
    // IE doesn't allow you to dynamically specify the name of radio buttons
    if (!/^\w+$/.test(name)) throw new Error("invalid choice group name: " + name);
    label.innerHTML = "<input type='"+type+"' name='"+name+
            "' value='"+localChoiceNumber+"' id='"+id+
            "' "+(checked?"checked":"")+disabledString+">";

    label.setAttribute("for", id);
    if (localChoiceNumber === 0) {
      if (isLast) {
        setClass(label, "onlyChild"+disabledString);
      } else {
        setClass(label, "firstChild"+disabledString);
      }
    } else if (isLast) {
      setClass(label, "lastChild"+disabledString);
    } else if (unselectable) {
      setClass(label, "disabled");
    }
    label.setAttribute("accesskey", globalChoiceNumber);
    if (!unselectable) {
      if (type === "radio" && window.Touch) { // Make labels clickable on iPhone
          label.onclick = function labelClick(evt) {
              try {
                var target = evt.target;
                if (!/label/i.test(target.tagName)) return;
                var button = document.getElementById(target.getAttribute("for"));
                button.checked = true;
              } catch (e) {}
          };
      } else if (/MSIE 6/.test(navigator.userAgent)) {
        label.onclick = function labelClick() {
          try {
            var target = window.event.srcElement;
            if (!/label/i.test(target.tagName)) return;
            var button = document.getElementById(target.getAttribute("for"));
            button.checked = true;
          } catch (e) {}
        };
      }
    }
    printx(line, label);
    
    div2.appendChild(label);
    div.appendChild(div2);
}

function printImage(source, alignment, alt, invert) {
  var img = document.createElement("img");
  if (typeof hashes != 'undefined' && hashes[source]) {
    source += "?hash=" + hashes[source];
  }
  img.src = source;
  if (alt !== null && String(alt).length > 0) img.setAttribute("alt", alt);
  var zoomFactor = getZoomFactor();
  if (zoomFactor !== 1) {
    var size = (zoomFactor * 100) + '%';
    img.style.height = size;
    img.style.width = size;
  }
  if (invert) {
    setClass(img, "invert align"+alignment);
  } else {
    setClass(img, "align"+alignment);
  }
  document.getElementById("text").appendChild(img);
}

function playSound(source) {
  for (var existingAudios = document.getElementsByTagName("audio"); existingAudios.length;) {
    existingAudios[0].parentNode.removeChild(existingAudios[0]);
  }
  if (typeof hashes != 'undefined' && hashes[source]) {
    source += "?hash=" + hashes[source];
  }
  var audio = document.createElement("audio");
  if (audio.play) {
    audio.setAttribute("src", source);
    document.body.appendChild(audio);
    audio.play();
  }
}

function printYoutubeFrame(slug) {
  var wrapper = document.createElement("div");
  setClass(wrapper, "videoWrapper");
  var iframe = document.createElement("iframe");
  iframe.width="560";
  iframe.height="315";
  iframe.src="https://www.youtube.com/embed/"+slug;
  iframe.setAttribute("frameborder", 0);
  iframe.setAttribute("allowfullscreen", true);
  wrapper.appendChild(iframe);
  document.getElementById("text").appendChild(wrapper);
}

function moreGames() {
    if (window.isIosApp) {
      window.location.href = "https://choiceofgames.app.link/jBm199qZXL/";
    } else if (window.isAndroidApp) {
      if (window.isNookAndroidApp) {
        asyncAlert("Please search the Nook App Store for \"Choice of Games\" for more games like this!");
        return;
      }
      if (window.isAmazonAndroidApp) {
        window.location.href = "https://www.amazon.com/gp/mas/dl/android?p=com.choiceofgames.omnibus&t=choofgam-20&ref=moreGames";
      } else {
        window.location.href = "https://play.google.com/store/apps/details?id=com.choiceofgames.omnibus&referrer=utm_medium%3Dweb%26utm_source%3Dmoregames";
      }
    } else if (window.isSteamApp) {
      window.location.href = "https://store.steampowered.com/curator/7026798-Choice-of-Games/";
    } else {
      try {
        if (window.isChromeApp) {
          window.open("https://www.choiceofgames.com/category/our-games/");
        } else if (window.isHeartsChoice) {
          window.location.href = "https://www.heartschoice.com/shop/";
        } else {
          window.location.href = "https://www.choiceofgames.com/category/our-games/";
        }
      } catch (e) {
        // in xulrunner, this will be blocked, but it will trigger opening the external browser
      }
    }
}

function printShareLinks(target, now) {
  if (!target) target = document.getElementById('text');
  var msgDiv = document.createElement("div");
  if (window.isIosApp) {
    if (now) {
      callIos("share");
      return;
    }
    var button = document.createElement("button");
    button.appendChild(document.createTextNode("Share This Game"));
    button.onclick = function() {
      callIos("share");
    };
    msgDiv.appendChild(button);
    target.appendChild(msgDiv);
    return;
  }

  var mobileMesg = "";
  if (window.isAndroidApp) {
    var androidLink = document.getElementById('androidLink');
    var androidUrl;
    if (window.isNookAndroidApp) {
      if (window.nookEan && nookEan != "UNKNOWN") {
        mobileMesg = "  <li><a href='choiceofgamesnook://"+window.nookEan+"'>Rate this app</a> in the Nook App Store</li>\n";
      }
    } else if (androidLink) {
      androidUrl = getAndroidReviewLink();
      if (androidUrl) {
        mobileMesg = "  <li><a href='"+androidUrl+"'>Rate this app</a> in the Google Play Store</li>\n";
      }
    }
  } else if (/webOS/.test(navigator.userAgent) && window.isFile) {
    var palmLink = document.getElementById('palmLink');
    var palmUrl;
    if (palmLink) {
      palmUrl = palmLink.href;
      if (palmUrl) {
        mobileMesg = "  <li><a href='"+palmUrl+"'>Rate this app</a> in the Palm App Catalog</li>\n";
      }
    }
  } else if (window.isChromeApp) {
    var chromeLink = document.getElementById('chromeLink');
    var chromeUrl;
    if (chromeLink) {
      chromeUrl = chromeLink.href;
      if (chromeUrl) {
        mobileMesg = "  <li><a href='"+chromeUrl+"/reviews'>Rate this app</a> in the Chrome Web Store</li>\n";
      }
    }
  }

  var url = window.location.href;
  var links = document.getElementsByTagName("link");
  for (var i = links.length - 1; i >= 0; i--) {
    if (links[i].getAttribute("rel") == "canonical") {
      url = links[i].getAttribute("href") || url;
      break;
    }
  }

  if (/^\//.test(url)) {
    if (window.isWeb) {
      url = window.location.protocol + "//" + window.location.hostname + url;
    } else {
      url = "https://www.choiceofgames.com" + url;
    }
  }

  url = encodeURIComponent(url);
  var title = encodeURIComponent(document.title);
  var dataUriSupported = !/MSIE [67]/.test(navigator.userAgent);

  var twitterHandle = window.isHeartsChoice ? "heartschoice" : "choiceofgames";

  var shareLinkText =
        '<li>'+(dataUriSupported?'<img height="16" width="16" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAsklEQVQ4EWNgoBAwgvQnVq75f+vBG5KMUlMQYZjfHsLIBNJFqmZkPSzEWKsqL8zQXebJICLIDVZuEzUTrg3sAjgPBwNZM7oSolyAzWaYQUS5AKYYG43XBUeWpaPogfGRwwCvAW/efwUbAPMCjI9sKl4DArKXgNXCbIbxkQ2gOAwoNgDsBS5ONgYNJTFkl2FlG2nLwMVv3HsFZlPHBTLifAznrj6Bm47OQI42mBwoM1EFAAAnVCliRFKHdQAAAABJRU5ErkJggg==">':"")+
        ' <a href="http://www.facebook.com/sharer.php?u='+url+'&amp;t='+title+'"'+
        'onclick="if (window.isFile || window.isXul) return true; '+
        'window.open(&quot;http://www.facebook.com/sharer.php?u='+url+'&amp;t='+title+
        '&quot;,&quot;sharer&quot;,&quot;toolbar=0,status=0,width=626,height=436&quot;);return false;" class="spacedLink">Facebook</a></li>'+

        '<li>'+(dataUriSupported?'<img height="16" width="16" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB/ElEQVQ4EYVTO24UQRB9/dmZkdfCIK0QBhMACQdwgDgMN4AEiYALcAFy7kNABkYkGzhAWMa2DHg9n+7iVfXMaAmAknp7tuvVq1dV3Q6j9SlJlzLEOXgIPPcmRjf5/7ZHdWQRaVPCOjucDYJlcHi8AFLOErz/J4kRQASXGfjYDmhIeDwAKx9xBzz8jxUCgjqSfE8CPWi5EpeTjOu+F36CVcGxrEBBMVDiaDOB5vqVBQu6WAU+dQmnwZuGwkACstxlRDckqWIhMQLPOtfXvfw0AmfA95thqwBNWGg04PktLbTYrEAlXxJTEciemtd+KdvZf7ESTjipEyaazAgyu/2lTTjP2ZpICZZQYSp7gg8kelh5PFj4Kd56ZvhE2IUSMOMVm/niZoPDOqJl0FSAYlYhoNoabSmBiI5pVNouv39w32G3l05wIwaqKRq00XErWGWYFvXz3uAbA4+51lyf+wy9h0JVRqAgfmehc8vmJt7n/CrKP6J81fzqfIPTVOOAo+S9soko+GkzhxgNocUkDfLmosPrsyvwtpTDP5KRWBz2Of4PB3vYr8o9mNuZncfLvRrPdmveJJVNDn0G8yKUMV/pO+p16MVmAn00yvnu9g7erpZ4xAbUrFtXMy42AE9YwmHNxo42lzAd6AtMQ48NgjVVOz+BVNQ9Zql4UI9P/TehBOJIi+EJIAAAAABJRU5ErkJggg==">':"")+
        ' <a href="https://twitter.com/intent/tweet?related='+twitterHandle+'&amp;text='+title+'&amp;url='+url+'&amp;via='+twitterHandle+'" class="spacedLink">Twitter</a></li>';

  var nowMsg = "";
  if (now) nowMsg = "<p>Please support our work by sharing this game with friends!  The more people play, the more resources we'll have to work on the next game.</p>";
  msgDiv.innerHTML = nowMsg + "<ul id='sharelist'>\n"+
    mobileMesg+
    shareLinkText+
    "</ul>\n";
  target.appendChild(msgDiv);
}

function isShareConfigured() {
  return !!document.getElementById("share");
}

function shareAction(e) {
  clearScreen(function() {
    var target = document.getElementById('text');
    printShareLinks(target, "now");
    printButton("Next", target, false, function () {
      clearScreen(loadAndRestoreGame);
    });
    curl();
  });
}

function isReviewSupported() {
  return !!(window.isIosApp || window.isAndroidApp);
}

function prepareReviewPrompt() {
  if (window.isAndroidApp && window.reviewManagerBridge) {
    window.reviewManagerBridge.requestReviewFlow();
  }
}

function promptForReview() {
  var store;
  target = document.getElementById('text');
  function printMessage(store) {
    println("Great! Please post a review of this game on "+store+". It really helps.[n/]", target);
  }
  var anchorText = "Review This Game";
  var href;
  if (window.isSteamApp) {
    printMessage("Steam");
    printLink(target, "#", anchorText, function(e) {
      preventDefault(e);
      try {
        purchase("adfree", function() {});
      } catch (x) {}
      return false;
    });
    return true;
  } else if (window.isIosApp) {
    println("Great! Please post a review of this version of the game on the App Store. It really helps.[n/]", target);
    printLink(target, "#", anchorText, function(e) {
      preventDefault(e);
      try {
        callIos("reviewapp");
      } catch (x) {}
      return false;
    });
    return true;
  } else if (window.isAndroidApp) {
    if (window.reviewManagerBridge) {
      window.reviewManagerBridge.launchReviewFlow();
      return false;
    }
    href = getAndroidReviewLink();
    if (window.isAmazonAndroidApp) {
      printMessage("Amazon's Appstore");
    } else {
      printMessage("the Google Play Store");
    }
    return true;
  } else if (window.isChromeApp) {
    href = document.getElementById('chromeLink').href;
  }
  
  printLink(target, href, anchorText);
  return true;
}

function getAndroidReviewLink() {
  var href = document.getElementById('androidLink').href;
  var package = /id=([\.\w]+)/.exec(href)[1];
  // TODO legacy hosted
  if (window.isOmnibusApp) {
    var omnibus;
    if (/^org\.hostedgames/.test(package)) {
      omnibus = "org.hostedgames.omnibus";
    } else if (/^com\.heartschoice/.test(package)) {
      omnibus = "com.heartschoice.o";
    } else {
      omnibus = "com.choiceofgames.omnibus";
    }
    if (window.isAmazonAndroidApp) {
      return "http://www.amazon.com/gp/mas/dl/android?p="+omnibus+"&t=choofgam-20&ref=rate"
    } else {
      return "https://play.google.com/store/apps/details?id="+omnibus+"&referrer=utm_medium%3Dweb%26utm_source%3D"+window.storeName+"Game";
    }
  } else if (window.isAmazonAndroidApp) {
    return "http://www.amazon.com/gp/mas/dl/android?p="+package+"&t=choofgam-20&ref=rate";
  } else {
    return href;
  }
}

function isFollowEnabled() {
  return false;
  if (!window.isWeb) return false;
  // iOS add to homescreen seems not to like these iframes
  if (window.navigator.standalone) return false;
  if ("localhost" != window.location.hostname && !/\.?choiceofgames\.com$/.test(window.location.hostname)) return false;
  return true;
}

function printFollowButtons() {
  if (!isFollowEnabled()) return;
  // Just FB Like, for now
  var target = document.getElementById('text');
  var iframe = document.createElement('iframe');
  var width = 300;
  var height = 66;
  iframe.setAttribute("src", "//www.facebook.com/plugins/like.php?href=https%3A%2F%2Fwww.facebook.com%2Fchoiceofgames"+
    "&amp;send=false&amp;layout=standard&amp;width="+width+"&amp;show_faces=true&amp;font&amp;colorscheme=light&amp;"+
    "action=like&amp;height="+height+"&amp;appId=190439350983878");
  iframe.setAttribute("scrolling", "no");
  iframe.setAttribute("frameborder", "0");
  iframe.setAttribute("style", "border:none; overflow:hidden; width:"+width+"px; height:"+height+"px;");
  iframe.setAttribute("allowTransparency", "true");
  target.appendChild(iframe);
}

function subscribeLink(e) {
  clearScreen(function() {
    subscribe(document.getElementById('text'), {now:1}, function() {
      clearScreen(loadAndRestoreGame);
    });
    curl();
  });
}

function subscribeByMail(target, options, callback, code) {
  if (options.now) {
    code();
    if (options.allowContinue) safeTimeout(function() {callback("now");}, 0);
  } else {
    println("Click here to subscribe to our mailing list; " + options.message);
    println("");
    printButton("Subscribe", target, false, function() {
        code();
      });
    if (options.allowContinue) {
      printButton("No, Thanks", target, false, function() {
        safeTimeout(function() {callback();}, 0);
      });
    }
    // why is this timeout necessary?
    safeTimeout(function() {printFooter();}, 0);
  }
}

function subscribe(target, options, callback) {
  if (!options.message) options.message = "we'll notify you when our next game is ready!";
  if (typeof options.allowContinue === "undefined") options.allowContinue = 1;
  if (!target) target = document.getElementById('text');
  if (window.isIosApp) {
    subscribeByMail(target, options, callback, function() {
      callIos("subscribe");
    });
    return;
  }
  var mailToSupported = isMobile && !window.isMacApp;
  if (window.isAndroidApp) mailToSupported = urlSupport.isSupported("mailto:support@choiceofgames.com");
  var domain = window.isHeartsChoice ? "heartschoice.com" : "choiceofgames.com";
  if (mailToSupported) {
    subscribeByMail(target, options, callback, function() {
      window.location.href = "mailto:subscribe-"+window.storeName+"-"+platformCode() + "@"+domain+"?subject=Sign me up&body=Please notify me when the next game is ready.";
    });
    return;
  }
  println("Type your email address below; " + options.message);
  println("");
  fetchEmail(function(defaultEmail) {
    promptEmailAddress(target, defaultEmail, options.allowContinue, function(cancel, email) {
      if (cancel) {
        return safeCall(null, callback);
      }
      var head= document.getElementsByTagName('head')[0];
      var script = document.createElement('script');
      script.type = 'text/javascript';
      var timestamp = new Date().getTime();
      var timeout = setTimeout(function() {
        window["jsonp"+timestamp]({
          result:"error", msg:"Couldn't connect. Please try again later."
        });
      }, 10000);
      window["jsonp"+timestamp] = function(response) {
        clearTimeout(timeout);
        if (response.result == "error") {
          var errElement = document.getElementById("errorMessage");
          if (errElement) errElement.innerHTML = response.msg;
        } else {
          clearScreen(function() {
            target = document.getElementById('text');
            println(response.msg, target);
            println("", target);
            if (options.allowContinue) {
              printButton("Next", target, false, function() {
                safeCall(null, callback);
              });
            }
            curl();
          });
        }
      };
      var listId = window.isHeartsChoice ? "fa4134344b" : "e9cdee1aaa";
      var mailParams = "u=eba910fddc9629b2810db6182&id="+listId+"&SIGNUP="+window.storeName+"-"+platformCode()+"&EMAIL="+encodeURIComponent(email);
      if (window.isChromeApp) {
        chrome.permissions.contains({origins: ["http://choiceofgames.us4.list-manage.com/"]},function(isXhrAllowed) {
          if (isXhrAllowed) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", 'http://choiceofgames.us4.list-manage.com/subscribe/post-json?'+mailParams, true);
            xhr.onreadystatechange = function() {
              if (xhr.readyState != 4) return;
              if (xhr.status == 200) {
                var response = JSON.parse(xhr.responseText);
                window["jsonp"+timestamp](response);
              } else if (xhr.status === 0) {
                window["jsonp"+timestamp]({result:"error", msg:"There was a network error submitting your registration. Please try again later, or email subscribe@choiceofgames.com instead."});
              } else {
                window["jsonp"+timestamp]({result:"error", msg:"Sorry, our mail server had an error. It's our fault. Please try again later, or email subscribe@choiceofgames.com instead."});
              }
            };
            xhr.send();
          } else {
            window.addEventListener('message', function(event) {
              if (window["jsonp"+timestamp]) {
                var jsonpt = window["jsonp"+timestamp];
                window["jsonp"+timestamp] = null;
                if (jsonpt) jsonpt(event.data);
              }
            });
            var iframe = document.createElement("IFRAME");
            iframe.setAttribute("src", "sandbox.html");
            iframe.setAttribute("name", "sandbox");
            iframe.onload = function() {
              iframe.contentWindow.postMessage({email:email, game:window.storeName, platform:platformCode()}, "*");
            };
            document.documentElement.appendChild(iframe);
            return;
          }
        });
      } else {
        if (isWinStoreApp || window.location.protocol == "https:") {
          var xhr = findXhr();
          xhr.open("GET", 'https://www.choiceofgames.com/mailchimp_proxy.php/subscribe/post-json?'+mailParams, true);
          var done = false;
          xhr.onreadystatechange = function() {
            if (done) return;
            if (xhr.readyState != 4) return;
            done = true;
            if (xhr.status == 200) {
              var response = JSON.parse(xhr.responseText);
              window["jsonp"+timestamp](response);
            } else if (xhr.status === 0) {
                window["jsonp"+timestamp]({result:"error", msg:"There was a network error submitting your registration. Please try again later, or email subscribe@choiceofgames.com instead."});
            } else {
              window["jsonp"+timestamp]({result:"error", msg:"Sorry, our mail server had an error. It's our fault. Please try again later, or email subscribe@choiceofgames.com instead."});
            }
          };
          xhr.send();
        } else {
          script.src = 'https://choiceofgames.us4.list-manage.com/subscribe/post-json?'+mailParams+'&c=jsonp' + timestamp;
          head.appendChild(script);
        }
      }
    });
  });
}

function downloadLink(e) {
  if (e && e.preventDefault) e.preventDefault();
  if (isPrerelease()) {
    return asyncAlert("You'll need to wait until after the game is released on " + window.releaseDate);
  }
  clearScreen(function() {
    var text = document.getElementById("text");
    if (window.knownPurchases && window.knownPurchases.adfree) {
      println("You can download the game using the links below.");
      println("");
      var files = {
        Windows: window.downloadName + " Setup " + window.downloadVersion + "-ia32.exe",
        Mac: window.downloadName + "-" + window.downloadVersion + ".dmg",
        Linux: window.downloadPackage + "-" + window.downloadVersion + "-ia32.deb"
      }
      var detectedOs;
      if (/Windows/.test(navigator.userAgent)) {
        detectedOs = "Windows";
      } else if (/Mac OS X/.test(navigator.userAgent)) {
        detectedOs = "Mac";
      } else if (/Linux/.test(navigator.userAgent)) {
        detectedOs = "Linux";
      }
      if (detectedOs) {
        printDownloadLink(detectedOs);
      }
      for (var os in files) {
        if (detectedOs != os) printDownloadLink(os);
      }
      function printDownloadLink(os) {
        var link = document.createElement("a");
        if (detectedOs == os) {
          setClass(link, "next linkButton");
        } else {
          link.style.display = "block";
        }
        link.innerHTML = "Download for " + os;
        link.href = "scenes/"+files[os];
        text.appendChild(link);
      }
      println("");
      printButton("Next", text, false, function() {
        safeCall(null, function() { clearScreen(loadAndRestoreGame); });
      });
    } else {
      println("To download this game for Windows, Mac, or Linux, you'll need to purchase it first.");
      println("");
      printOptions([""], [{name:"Purchase it now.", purchase:1}, {name:"No, thanks.", cancel:1}], function(option) {
        if (option.purchase) {
          purchase("adfree", downloadLink);
        } else {
          safeCall(null, function() { clearScreen(loadAndRestoreGame); });
        }
      });
    }
    curl();
  });
}

function cacheKnownPurchases(knownPurchases) {
  if (!knownPurchases) return;
  var output = {billingSupported:true};
  for (i = 0; i < knownPurchases.length; i++) {
    var parts = knownPurchases[i].split(/\./);
    if (parts[0] != window.storeName) continue;
    output[parts[1]] = true;
  }
  window.knownPurchases = output;
  fetchEmail(function(email) {
    if (email) window.store.set("knownPurchases"+email.replace(/[^A-z0-9]/g, "_"), JSON.stringify(window.knownPurchases));
  })
  if (window.isIosApp) {
    callIos("cachepurchases", knownPurchases);
  } else if (window.isAndroidApp) {
    if (window.isOmnibusApp) {
      androidBilling.cachePurchases(JSON.stringify(knownPurchases));
    }
    androidBilling.updateAdfree(!!output.adfree);
  }
}

// Callback expects a map from product ids to booleans
function checkPurchase(products, callback) {
  function publishPurchaseEvents(purchases) {
    if (purchases && window.purchaseSubscriptions) {
      for (var key in purchaseSubscriptions) {
        if (purchases[key]) purchaseSubscriptions[key].call();
      }
    }
  }

  function checkWebPurchases(callback) {
    isRegistered(function (registered) {
      if (!registered) return callback("ok", {billingSupported: true});
      if (window.knownPurchases) {
        safeTimeout(function() {
          callback("ok", window.knownPurchases);
          publishPurchaseEvents(knownPurchases);
        }, 0);
      } else {
        startLoading();
        xhrAuthRequest("GET", "get-purchases", function(ok, response) {
          doneLoading();
          if (ok) {
            cacheKnownPurchases(response);
            callback(ok, window.knownPurchases);
          } else {
            fetchEmail(function(email) {
              if (!email) return callback(ok, window.knownPurchases);
              window.store.get("knownPurchases"+email.replace(/[^A-z0-9]/g, "_"), function(ok, value) {
                if (ok) {
                  window.knownPurchases = JSON.parse(value);
                }
                callback(ok, window.knownPurchases);
                publishPurchaseEvents(window.knownPurchases);
              })
            });
          }
        });
      }
    });
  }

  function mergeKnownPurchases(purchases) {
    window.checkPurchaseCallback = null;
    checkWebPurchases(function(ok, knownPurchases) {
      if (knownPurchases) {
        var productList = products.split(/ /);
        for (i = 0; i < productList.length; i++) {
          if (knownPurchases[productList[i]]) purchases[productList[i]] = knownPurchases[productList[i]];
        }
      }
      callback("ok", purchases);
      publishPurchaseEvents(purchases);
    });
  }

  var i, oldCallback;
  if (window.isIosApp) {
    oldCallback = window.checkPurchaseCallback;
    window.checkPurchaseCallback = function (purchases) {
      if (oldCallback) oldCallback(purchases);
      mergeKnownPurchases(purchases);
    }
    if (!oldCallback) callIos("checkpurchase", products);
  } else if (window.isAndroidApp && !window.isNookAndroidApp) {
    oldCallback = window.checkPurchaseCallback;
    window.checkPurchaseCallback = function (purchases) {
      if (oldCallback) oldCallback(purchases);
      mergeKnownPurchases(purchases);
    }
    if (!oldCallback) androidBilling.checkPurchase(products);
  } else if (window.isWinOldApp) {
    safeTimeout(function() {
      var purchases = eval(window.external.CheckPurchase(products));
      callback("ok",purchases);
      publishPurchaseEvents(purchases);
    }, 0);
  } else if (window.isMacApp) {
    oldCallback = window.checkPurchaseCallback;
    window.checkPurchaseCallback = function (purchases) {
      if (oldCallback) oldCallback(purchases);
      window.checkPurchaseCallback = null;
      callback("ok",purchases);
      publishPurchaseEvents(purchases);
    }
    if (!oldCallback) callMac("checkpurchase", products);
  } else if (window.isCef) {
    cefQuery({
      request:"CheckPurchases " + products,
      onSuccess: function(response) {
        console.log("cp response " + response);
        var purchases = JSON.parse(response);
        callback("ok",purchases);
        publishPurchaseEvents(purchases);
      },
      onFailure: function(error_code, error_message) {
        console.error("CheckPurchases error: " + error_message);
        callback(!"ok");
      }
    });
  } else if (window.isSteamworks) {
    var steamworksApps = require('../package.json').products;
    var purchases = {};
    var productList = products.split(/ /);
    for (i = 0; i < productList.length; i++) {
      var appId = steamworksApps[productList[i]];
      var purchased = false;
      try {
        purchased = steamworks.apps.isSubscribedApp(appId);
      } catch (e) {
        // we pre-checked adfree on startup
        if (productList[i] === 'adfree') {
          purchased = !window.isTrial;
        } else {
          return safeTimeout(function () { callback(!"ok"); }, 0);
        }
      }
      purchases[productList[i]] = purchased;
    }
    purchases.billingSupported = true;
    publishPurchaseEvents(purchases);
    safeTimeout(function() {callback("ok", purchases);}, 0);
  } else if (window.beta === "beta") {
    var productList = products.split(/ /);
    var purchases = {};
    for (i = 0; i < productList.length; i++) {
      purchases[productList[i]] = true;
    }
    purchases.billingSupported = true;
    publishPurchaseEvents(purchases);
    safeTimeout(function () { callback("ok", purchases); }, 0);
  } else if (isWebPurchaseSupported()) {
    checkWebPurchases(function(ok, knownPurchases) {
      callback(ok, knownPurchases);
      publishPurchaseEvents(window.knownPurchases);
    });
  } else {
    var productList = products.split(/ /);
    var purchases = {};
    for (i = 0; i < productList.length; i++) {
      purchases[productList[i]] = !!window.isChromeApp;
    }
    purchases.billingSupported = false;
    publishPurchaseEvents(purchases);
    safeTimeout(function() {callback("ok", purchases);}, 0);
  }
}

function isWebPurchaseSupported() {
  var enableBilling = (typeof window.enableBilling === 'undefined' || window.enableBilling)
  return enableBilling && isWebSavePossible() && !!window.stripeKey;
}

function isRestorePurchasesSupported() {
  return !!window.isIosApp || !!window.isAndroidApp || isWebPurchaseSupported();
}

function restorePurchases(product, callback) {
  function webRestoreCallback() {
    var purchased = window.knownPurchases && window.knownPurchases[product];
    if (!purchased) {
      if (window.isAndroidApp) {
        return asyncAlert("Restore completed. This product is not yet purchased. "+
          "Sometimes purchases can fail to restore for reasons outside our control. "+
          "If you have already purchased this product, try uninstalling and reinstalling the app. "+
          "If that doesn't work, please email a copy of your receipt to " + getSupportEmail() + " "+
          "and we'll find a way to help you.", function() {
            callback(purchased);
          });
      } else {
        asyncAlert("Restore completed. This product is not yet purchased.");
      }
    } else {
      refreshIfAppUpdateReady();
      updateAllPaidSceneCaches();
    }
    callback(purchased);
  }
  function secondaryRestore(error) {
    window.restoreCallback = null;
    if (product) {
      checkPurchase(product, function(ok, purchases) {
        if (purchases[product]) {
          return callback("purchased");
        }

        if (window.isOmnibusApp && (window.purchaseTransfer || window.omnibusSupportsTransfer)) {
          var appId = getAppId();
          if (window.isAndroidApp || (window.isIosApp && (appId !== "1363309257" && appId !== "1302297731"))) {
            return omnibusRestore(appId);
          }
        }

        clearScreen(function() {
          isRegistered(function (registered) {
            if (registered) {
              startLoading();
              xhrAuthRequest("GET", "get-purchases", function(ok, response) {
                doneLoading();
                if (ok) {
                  cacheKnownPurchases(response);
                  webRestoreCallback();
                } else {
                  if (response.error === "not registered") {
                    logout();
                    secondaryRestore("error");
                  } else {
                    asyncAlert("There was an error restoring purchases. (Your network connection may be down.) Please try again later.");
                    callback();
                  }
                }
              });
            } else {
              var target = document.getElementById('text');
              if (error) {
                target.innerHTML="<p>Restore failed. Please try again later, or sign in to choiceofgames.com to restore purchases.</p>";
              } else {
                target.innerHTML="<p>Restore completed. This product is not yet purchased. You may also sign in to choiceofgames.com to restore purchases.</p>";
              }
              loginForm(document.getElementById('text'), /*optionality*/1, /*err*/null, webRestoreCallback);
              curl();
            }
          })
        });
      });
    } else {
      callback();
    }
  }
  function omnibusRestore(appId) {
    var omnibus = "Choice of Games";
    var canonical = document.querySelector("link[rel=canonical]");
    var canonicalHref = canonical && canonical.getAttribute("href");
    if (/\/user-contributed\//.test(canonicalHref)) {
      omnibus = "Hosted Games";
    }
    var appStore = window.isIosApp ? "App Store"
      : window.isAmazonAndroidApp ? "Amazon Appstore"
      : "Google Play Store";
    var gameTitle = document.getElementById("title").textContent;

    clearScreen(function() {
      printParagraph("Restore completed. "+appStore+" records indicate that "+
        "you have not purchased this product using the \""+omnibus+"\" app, "+
        "but you may have purchased the product in the \""+gameTitle+"\" app, "+
        "or on our website at choiceofgames.com.");

      options = [
        {name:"Restore purchases from choiceofgames.com.", group:"choice", webRestore:true},
        {name:"Restore purchases using the \""+gameTitle+"\" app.", group:"choice", transfer:true},
      ];

      printOptions([""], options, function(option) {
        if (option.webRestore) {
          clearScreen(function() {
            isRegistered(function (registered) {
              if (registered) {
                startLoading();
                xhrAuthRequest("GET", "get-purchases", function(ok, response) {
                  doneLoading();
                  if (ok) {
                    cacheKnownPurchases(response);
                    webRestoreCallback();
                  } else {
                    if (response.error === "not registered") {
                      logout();
                      printParagraph("Sign in to choiceofgames.com to restore purchases.");
                      loginForm(document.getElementById('text'), /*optionality*/1, /*err*/null, webRestoreCallback);
                    } else {
                      asyncAlert("There was an error restoring purchases. (Your network connection may be down.) Please try again later.");
                      callback();
                    }
                  }
                });
              } else {
                printParagraph("Sign in to choiceofgames.com to restore purchases.");
                loginForm(document.getElementById('text'), /*optionality*/1, /*err*/null, webRestoreCallback);
              }
            });
          });
        } else {
          var transferAttempted = false;
          var transferPurchaseCallback = function(result) {
            window.transferPurchaseCallback = null;
            clearScreen(function() {
              var transferPlatform = window.isIosApp ? "ios" : "android";

              if (result === "launch_failed") {
                if (!transferAttempted) {
                  transferAttempted = true;
                  printParagraph(
                    "The \""+gameTitle+"\" app is not installed on your current device. To transfer "+
                    "purchases from another app, you'll need to install the \""+gameTitle+"\" app and "+
                    "this \""+omnibus+"\" app at the same time."
                  );
                } else {
                  printParagraph(
                    "The \""+gameTitle+"\" app is not responding. Try uninstalling and reinstalling "+
                    "the \""+gameTitle+"\" app and trying again.");
                  printParagraph("Sometimes purchases can fail to "+
                    "restore for reasons outside our control. If you have already purchased "+
                    "this product, please email a copy of your receipt to "+
                    "[url=mailto:"+transferPlatform+"-transfer-"+storeName+"-missing@choiceofgames.com]"+transferPlatform+"-transfer-"+storeName+"-missing@choiceofgames.com[/url] and we'll find a way to help "+
                    "you."
                  );
                }

                var appLink = window.isIosApp ? "https://itunes.apple.com/app/id"+appId
                  : window.isAmazonAndroidApp ? "https://www.amazon.com/gp/mas/dl/android?p="+appId
                  : "https://play.google.com/store/apps/details?id="+appId;
                printParagraph("[url="+appLink+"]Download "+gameTitle+" from the "+appStore+"[/url]");

                printOptions([""], [
                  {name:"I've installed the \""+gameTitle+
                    "\" app. Try restoring purchases again.", group:"choice", retry:true},
                  {name:"Cancel.", group:"choice"},
                ], function (option) {
                  if (option.retry) {
                    window.transferPurchaseCallback = transferPurchaseCallback;
                    startLoading();
                    window.isIosApp ? callIos("transferpurchase") : purchaseTransfer.requestTransfer(appId);
                  } else {
                    callback(!"purchased");
                  }
                });
                curl();
              } else if (result === "done") {
                checkPurchase(product, function(ok, purchases) {
                  if (purchases[product]) {
                    callback("purchased");
                  } else {
                    printParagraph("Restore completed. "+appStore+" records indicate that you have not purchased "+
                    "this product in the \""+gameTitle+"\" app.");
                    printParagraph("Sometimes purchases can fail to restore for reasons outside our control. If you "+
                    "have already purchased this product, please email a copy of your receipt "+
                    "to [url=mailto:"+transferPlatform+"-transfer-"+storeName+"-failed@choiceofgames.com]"+transferPlatform+"-transfer-"+storeName+"-failed@choiceofgames.com[/url] and we'll find a "+
                    "way to help you.");
                    var target = document.getElementById('text');
                    printButton("Next", target, false, function() {
                      callback(!"purchased");
                    });
                    curl();
                  }
                });
              } else { // result === "error"
                printParagraph("Restore failed. Please try again later. If this error "+
                  "persists, please contact [url=mailto:"+transferPlatform+"-transfer-"+storeName+"-error@choiceofgames.com]"+transferPlatform+"-transfer-"+storeName+"-error@choiceofgames.com[/url] "+
                  "and we'll find a way to help you.")
                printOptions([""], [
                  {name:"Try again now.", group:"choice", retry:true},
                  {name:"Cancel.", group:"choice"},
                ], function(option) {
                  if (option.retry) {
                    window.transferPurchaseCallback = transferPurchaseCallback;
                    clearScreen(function() {
                      startLoading();
                      window.isIosApp ? callIos("transferpurchase") : purchaseTransfer.requestTransfer(appId);
                    });
                  } else {
                    callback(!"purchased");
                  }
                });
                curl();
              }
            });
          }
          if (window.isIosApp) {
            startLoading();
            window.transferPurchaseCallback = transferPurchaseCallback;
            callIos("transferpurchase");
          } else {
            isRegistered(function(registered) {
              if (registered) {
                window.transferPurchaseCallback = transferPurchaseCallback;
                clearScreen(function() {
                  startLoading();
                  purchaseTransfer.requestTransfer(appId);
                });
              } else {
                clearScreen(function() {
                  printParagraph("To restore purchases in the "+omnibus+" app using the "+gameTitle+" app, you'll first need to sign in using a choiceofgames.com account.");
                  loginForm(document.getElementById('text'), /*optionality*/1, /*err*/null, function(ok) {
                    if (ok) {
                      window.transferPurchaseCallback = transferPurchaseCallback;
                      clearScreen(function() {
                        startLoading();
                        purchaseTransfer.requestTransfer(appId);
                      });
                    } else {
                      webRestoreCallback();
                    }
                  });
                });
              }
            });
          }
        }
      });
      curl();
    });
  }

  if (window.isIosApp) {
    window.restoreCallback = secondaryRestore;
    callIos("restorepurchases");
  } else if (window.isAndroidApp) {
    window.restoreCallback = secondaryRestore;
    androidBilling.forceRestoreTransactions();
  } else if (isWebPurchaseSupported()) {
    isRegistered(function(registered) {
      if (registered) {
        startLoading();
        xhrAuthRequest("GET", "get-purchases", function(ok, response) {
          doneLoading();
          if (ok) {
            cacheKnownPurchases(response);
          } else {
            if (response.error != "not registered") {
              alertify.error("There was an error downloading your purchases from choiceofgames.com. "+
                "Please refresh this page to try again, or contact " + getSupportEmail() + " for assistance.", 15000);
            }
          }
          logout();
          restorePurchases(product, callback);
        });
      } else {
        clearScreen(function() {
          var target = document.getElementById('text');
          target.innerHTML="<p>Please sign in to choiceofgames.com to restore purchases.</p>";
          var steamRestore = false;
          var steamLink = document.getElementById('steamLink');
          if (steamLink && steamLink.href && !/INSERTINSERTINSERT/.test(steamLink.href)) {
            steamRestore = true;
          }
          if (steamRestore) {
            window.steamRestoreCallback = function(response) {
              window.steamRestoreCallback = null;
              if (response) cacheKnownPurchases(response);
              webRestoreCallback();
            }
          }
          loginForm(document.getElementById('text'), /*optional*/1, /*err*/null, webRestoreCallback);
          curl();
        });
      }
    });
  } else {
    safeTimeout(callback, 0);
  }
}
// Callback expects a localized string, or "", or "free", or "guess"
function getPrice(product, callback) {
  if (window.isIosApp) {
    checkForAppUpdates();
    window.priceCallback = callback;
    callIos("price", product);
  } else if (window.isAndroidApp) {
    window.priceCallback = callback;
    androidBilling.getPrice(product);
  } else if (window.isWeb) {
    checkForAppUpdates();
    if (window.productData && window.productData[product] && window.productData[product].amount) {
      safeTimeout(function () {
        callback.call(this, "$"+(productData[product].amount/100));
      }, 0);
    } else {
      safeTimeout(function() {
        if (window.productData && window.productData[product] && window.productData[product].amount) {
          callback.call(this, "$"+(productData[product].amount/100));
        } else {
          callback.call(this, "guess");
        }
      }, 500);
    }
  } else if (window.isSteamworks) {
    if (window.productData && window.productData[product]) {
      safeTimeout(function () {
        callback.call(this, productData[product]);
      }, 0);
    } else {
      window.awaitSteamProductData = function() {
        doneLoading();
        window.awaitSteamProductData = null;
        if (window.productData && window.productData[product]) {
          callback.call(this, productData[product]);
        } else {
          callback.call(this, "hide");
        }
      };
      startLoading();
      safeTimeout(function() {if (window.awaitSteamProductData) awaitSteamProductData();}, 5000);
    }
  } else {
    safeTimeout(function () {
      callback.call(this, "hide");
    }, 0);
  }
}
// Callback expects no args, but should only be called on success
function purchase(product, callback) {
  var purchaseCallback = function() {
    window.purchaseCallback = null;
    refreshIfAppUpdateReady();
    updateAllPaidSceneCaches();
    safeCall(null, callback);
    if (window.purchaseSubscriptions && purchaseSubscriptions[product]) {
      purchaseSubscriptions[product].call();
    }
  };
  if (window.isIosApp) {
    if (!window.purchaseRequiresLogin || window.registered) {
      window.purchaseCallback = purchaseCallback;
      return callIos("purchase", product);
    } else {
      clearScreen(function() {
        var target = document.getElementById('text');
        target.innerHTML="<p>Please sign in to choiceofgames.com to purchase.</p>";
        loginForm(target, /*optional*/1, /*err*/null, function(registered){
          if (registered) {
            if (window.knownPurchases && window.knownPurchases[product]) {
              purchaseCallback();
            } else {
              clearScreen(function() {loadAndRestoreGame("", window.forcedScene);});
              window.doneLoadingCallback = function() {
                window.purchaseCallback = purchaseCallback;
                callIos("purchase", product);
              }
            }
          } else {
            clearScreen(function() {loadAndRestoreGame("", window.forcedScene);});
          }
        });
        curl();
      });
    }
  } else if (window.isAndroidApp) {
    window.purchaseCallback = purchaseCallback;
    var androidStackTrace = androidBilling.purchase(product);
    if (androidStackTrace) throw new Error(androidStackTrace);
  } else if (window.isWinOldApp) {
    window.external.Purchase(product);
  } else if (window.isMacApp) {
    return callMac("purchase", product);
  } else if (window.isSteamworks) {
    var steamworksApps = require('../package.json').products;
    if (window.isSteamDeck) {
      var StoreFlagNone = 0;
      console.log('activating');
      steamworks.overlay.activateToStore(steamworksApps[product], StoreFlagNone);
      console.log('activated');
    } else {
      if (steamworksApps[product]) require("electron").shell.openExternal("steam://advertise/" + steamworksApps[product]);
    }
  } else if (window.isCef) {
    cefQuerySimple("Purchase " + product);
    // no callback; we'll refresh on purchase
  } else if (window.isWeb && !isPrerelease() && product == window.appPurchase) {
    var webStoreFallback = function() {
      window.appPurchase = null;
      purchase(product, callback);
    };
    var clickLink = function(id) {
      var link = document.getElementById(id);
      if (!link) return webStoreFallback();
      var href = link.getAttribute("href");
      if (!href) return webStoreFallback();
      window.location.href = href;
    };
    
    // instead of IAP, send Android users to a store
    if (/Silk/.test(navigator.userAgent)) {
      clickLink("kindleLink");
    } else if (/Android/.test(navigator.userAgent)) {
      clickLink("androidLink");
    } else if (window.steamClobber && document.getElementById("steamLink")) {
      clickLink("steamLink");
    } else {
      webStoreFallback();
    }
  } else if (isWebPurchaseSupported()) {
    if (!window.StripeCheckout) return asyncAlert("Sorry, we weren't able to initiate payment. (Your "+
      "network connection may be down.) Please refresh the page and try again, or contact "+
      "support@choiceofgames.com for assistance.");
    var fullProductName = window.storeName + "." + product;
    function stripe() {
      if (window.productData && window.productData[product]) {
        var data = productData[product];
        return StripeCheckout.open({
          key:         window.stripeKey,
          address:     false,
          amount:      data.amount,
          name:        data.display_name,
          email:       window.recordedEmail,
          panelLabel:  'Buy',
          token:       function(response) {
            clearScreen(function() {
              startLoading();
              xhrAuthRequest("POST", "purchase", function(ok, response) {
                doneLoading();
                if (ok) {
                  cacheKnownPurchases(response);
                  return purchaseCallback();
                } else if (/^card error: /.test(response.error)) {
                  var cardError = response.error.substring("card error: ".length);
                  asyncAlert(cardError);
                  clearScreen(function() {loadAndRestoreGame("", window.forcedScene);});
                } else if ("purchase already in flight" == response.error) {
                  asyncAlert("Sorry, there was an error handling your purchase. Please wait five minutes and try again, or contact support@choiceofgames.com for assistance.");
                  clearScreen(function() {loadAndRestoreGame("", window.forcedScene);});
                } else {
                  asyncAlert("Sorry, there was an error processing your card. (Your "+
                    "network connection may be down.) Please refresh the page and try again, or contact "+
                    "support@choiceofgames.com for assistance.");
                  clearScreen(function() {loadAndRestoreGame("", window.forcedScene);});
                }
                curl();
              }, "stripeToken", response.id, "product", fullProductName, "key", window.stripeKey);
            });
          }
        });
      } else {
        return asyncAlert("Sorry, we weren't able to initiate payment. (Your "+
          "network connection may be down.) Please refresh the page and try again, or contact "+
          "support@choiceofgames.com for assistance.");
      }
    }
    if (window.registered && window.recordedEmail) {
      stripe();
    }
    clearScreen(function() {
      var target = document.getElementById('text');
      target.innerHTML="<p>Please sign in to choiceofgames.com to purchase.</p>";
      loginForm(document.getElementById('text'), /*optional*/1, /*err*/null, function(registered){
        if (registered) {
          if (window.knownPurchases && window.knownPurchases[product]) {
            purchaseCallback();
          } else {
            clearScreen(function() {loadAndRestoreGame("", window.forcedScene);});
            return stripe();
          }
        } else {
          clearScreen(function() {loadAndRestoreGame("", window.forcedScene);});
        }
      });
      curl();
    });
  } else {
    safeTimeout(purchaseCallback, 0);
  }
}

function printDiscount(product, fullYear, oneBasedMonthNumber, dayOfMonth, line, options) {
  if (window.updatedDiscountDates && updatedDiscountDates[product]) {
    var udd = updatedDiscountDates[product];
    fullYear = udd.fullYear;
    oneBasedMonthNumber = udd.oneBasedMonthNumber;
    dayOfMonth = udd.dayOfMonth;
  }
  var shortMonthString = shortMonthStrings[oneBasedMonthNumber];
  var discountTimestamp = new Date(shortMonthString + " " + dayOfMonth + ", " + fullYear).getTime();
  var discountEligible = new Date().getTime() < discountTimestamp;
  var span;
  span = document.createElement("span");
  span.setAttribute("id", "discount_" + product);
  printx(line, span);
  span.innerHTML = span.innerHTML.replace("${choice_discount_ends}", "<span id=discountdate_"+product+">"+shortMonthString + " " + parseInt(dayOfMonth, 10) + "</span>") + " ";

  if (!discountEligible) {
    span.style.display = "none";
  }

  document.getElementById('text').appendChild(span);
}

function rewriteDiscount(product, fullYear, oneBasedMonthNumber, dayOfMonth) {
  if (!window.updatedDiscountDates) window.updatedDiscountDates = {};
  window.updatedDiscountDates[product] = {fullYear:fullYear, oneBasedMonthNumber:oneBasedMonthNumber, dayOfMonth:dayOfMonth};
  var span = document.getElementById("discount_"+product);
  if (!span) return;
  var shortMonthString = shortMonthStrings[oneBasedMonthNumber];
  var discountTimestamp = new Date(shortMonthString + " " + dayOfMonth + ", " + fullYear).getTime();
  var discountEligible = new Date().getTime() < discountTimestamp;
  if (discountEligible) {
    var dateSpan = document.getElementById("discountdate_"+product);
    if (!dateSpan) return;
    span.style.display = "";
    dateSpan.innerHTML = shortMonthString + " " + parseInt(dayOfMonth, 10);
  } else {
    span.style.display = "none";
  }
}

function handleDiscountResponse(ok, response) {
  if (!ok || !response || !window.storeName || !response[storeName]) return;
  if (!window.updatedDiscountDates) window.updatedDiscountDates = {};
  var udds = response[storeName];
  for (var product in udds) {
    if (!udds.hasOwnProperty(product)) continue;
    var udd = udds[product];
    var result = udd.split("-");
    rewriteDiscount(product, result[0], parseInt(result[1],10), parseInt(result[2], 10));
  }
}

function isPrerelease() {
  var steamTrial = window.isSteamApp && window.isTrial;
  if (typeof window != "undefined" && (window.isWeb || steamTrial) && window.releaseDate) {
    if (new Date() > window.releaseDate.getTime()) return false;
    if (/(fullaccess|preview)@choiceofgames.com/.test(getCookieByName("login"))) return false;
    var identity = document.getElementById("identity");
    return !(identity && /(fullaccess|preview)@choiceofgames.com/.test(identity.innerHTML));
  } else {
    return false;
  }
}

function registerNativeAchievement(name) {
  if (window.blockNativeAchievements) return;
  if (window.isIosApp) {
    callIos("achieve", name+"/");
  } else if (window.isMacApp) {
    callMac("achieve", name);
  } else if (window.isWinOldApp) {
    window.external.Achieve(name);
  } else if (window.isCef) {
    cefQuerySimple("Achieve " + name);
  } else if (window.isSteamworks) {
    steamworks.achievement.activate(name);
  }
}

function achieve(name, title, description) {
  if (initStore()) {
    checkAchievements(function() {
      window.store.set("achieved", toJson(nav.achieved));
    })
  }
  registerNativeAchievement(name);
  // Game Center shows a prominent banner; no need to show our own
  if (window.isIosApp && !window.isOmnibusApp) return;
  var escapedTitle = title+"".replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
  var escapedDescription = description+"".replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/\[b\]/g, '<b>')
    .replace(/\[\/b\]/g, '</b>')
    .replace(/\[i\]/g, '<i>')
    .replace(/\[\/i\]/g, '</i>');
  var html = "<b>Achievement: "+escapedTitle+"</b><br>" + escapedDescription;
  alertify.log(html);
}

function checkAchievements(callback) {
  safeTimeout(function() {
    if (!initStore()) return callback();
    window.store.get("achieved", function(ok, value){
      function mergeNativeAchievements(achieved) {
        window.checkAchievementCallback = null;
        var nativeRegistered = {};
        for (var i = 0; i < achieved.length; i++) {
          nav.achieved[achieved[i]] = true;
          nativeRegistered[achieved[i]] = true;
        }
        for (var achievement in nav.achieved) {
          if (nav.achieved[achievement] && !nativeRegistered[achievement]) {
            registerNativeAchievement(achievement);
          }
        }
        callback();
      }
      var alreadyLoadingAchievements = false;
      if (ok && value) {
        var achievementRecord = jsonParse(value);
        for (var achieved in achievementRecord) {
          if (achievementRecord[achieved]) nav.achieved[achieved] = true;
        }
      }
      if (window.isIosApp) {
        alreadyLoadingAchievements = !!window.checkAchievementCallback;
        window.checkAchievementCallback = mergeNativeAchievements;
        if (!alreadyLoadingAchievements) callIos("checkachievements");
      } else if (window.isSteamworks) {
        var nativeAchievements = [];
        for (var i = 0; i < window.achievements; i++) {
          if (steamworks.achievement.isActivated(window.achievements[i].name)) {
            nativeAchievements.push(achievement.name);
          }
        }
        mergeNativeAchievements(nativeAchievements);
      } else if (window.isMacApp) {
        alreadyLoadingAchievements = !!window.checkAchievementCallback;
        window.checkAchievementCallback = mergeNativeAchievements;
        if (!alreadyLoadingAchievements) callMac("checkachievements");
      } else if (window.isWinOldApp) {
        var checkWinAchievements = function () {
          var achieved = eval(window.external.GetAchieved());
          if (achieved) {
            mergeNativeAchievements(achieved);
          } else {
            safeTimeout(checkWinAchievements, 100);
          }
        };
        checkWinAchievements();
      } else if (window.isCef) {
        var checkCefAchievements = function() {
          cefQuery({
            request:"GetAchieved ",
            onSuccess: function(response) {
              //console.log("GetAchieved " + response);
              var achieved = eval(response);
              mergeNativeAchievements(achieved);
            },
            onFailure: function(error_code, error_message) {
              //console.error("GetAchieved error " + error_message);
              if (error_code == 1) {
                safeTimeout(checkCefAchievements, 100);
              } else {
                callback();
              }
            }
          });
        };
        checkCefAchievements();
      } else {
        callback();
      }
    });
  },0);
}

function isAdvertisingSupported() {
  if (typeof window === "undefined") return false;
  return (window.isIosApp || window.isAndroidApp || window.adSupportedDebug);
}

function isFullScreenAdvertisingSupported() {
  return isAdvertisingSupported();
}

function showFullScreenAdvertisement(callback) {
  if (window.isIosApp) {
    callIos("advertisement");
    safeTimeout(callback, 0);
  } else if (window.isAndroidApp && window.adBridge) {
    adBridge.displayFullScreenAdvertisement();
    safeTimeout(callback, 0);
  } else if (window.adSupportedDebug) {
    alert("ad!");
    safeTimeout(callback, 0);
  } else {
    safeTimeout(callback, 0);
  }
}

function showFullScreenAdvertisementButton(buttonName, skipCallback, doneCallback) {
  if (typeof isFullScreenAdvertisingSupported == "undefined" || !isFullScreenAdvertisingSupported()) {
    safeTimeout(skipCallback, 0);
    return;
  }
  startLoading();
  checkPurchase("adfree", function (ok, result) {
    doneLoading();
    if (result.adfree) {
      skipCallback();
    } else {
      printButton(buttonName, main, false, function () {
        showFullScreenAdvertisement(doneCallback);
      })
    }
  });
}

function showTicker(target, endTimeInSeconds, finishedCallback) {
  if (!target) target = document.getElementById('text');
  var div = document.createElement("span");
  div.setAttribute("id", "delayTicker");
  target.appendChild(div);
  var timerDisplay = document.createElement("span");
  div.appendChild(timerDisplay);
  var timer;

  var statsButton = document.getElementById("statsButton");
  if (statsButton) {
    var defaultStatsButtonDisplay = statsButton.style.display;
    statsButton.style.display = "none";
  }

  if (endTimeInSeconds > Math.floor(new Date().getTime() / 1000)) {
    if (window.isAndroidApp) {
      notificationBridge.scheduleNotification(endTimeInSeconds);
    } else if (window.isIosApp) {
      callIos("schedulenotification", endTimeInSeconds);
    }
  }

  function cleanUpTicker() {
    window.blockRestart = false;
    if (window.isAndroidApp) {
      notificationBridge.cancelNotification();
    } else if (window.isIosApp) {
      callIos("cancelnotifications");
    }
    clearInterval(timer);
    if (statsButton) statsButton.style.display = defaultStatsButtonDisplay;
  }

  function formatSecondsRemaining(secondsRemaining, forceMinutes) {
    if (!forceMinutes && secondsRemaining < 60) {
      return ""+secondsRemaining+"s";
    } else {
      var minutesRemaining = Math.floor(secondsRemaining / 60);
      var remainderSeconds;
      if (minutesRemaining < 60) {
        remainderSeconds = secondsRemaining - minutesRemaining * 60;
        return ""+minutesRemaining+"m " + formatSecondsRemaining(remainderSeconds);
      } else if (minutesRemaining < 6000) {
        var hoursRemaining = Math.floor(secondsRemaining / 3600);
        remainderSeconds = secondsRemaining - hoursRemaining * 3600;
        return ""+hoursRemaining+"h " + formatSecondsRemaining(remainderSeconds, true);
      } else {
        var daysRemaining = Math.floor(secondsRemaining / 86400);
        remainderSeconds = secondsRemaining - daysRemaining * 86400;
        return ""+daysRemaining+" days " + formatSecondsRemaining(remainderSeconds, true);
      }
    }
  }

  function tick() {
    var tickerElement = document.getElementById("delayTicker");
    var tickerStillVisible = tickerElement && tickerElement.parentNode && tickerElement.parentNode.parentNode;
    if (!tickerStillVisible) {
      cleanUpTicker();
      return;
    }
    var nowInSeconds = Math.floor(new Date().getTime() / 1000);
    var secondsRemaining = endTimeInSeconds - nowInSeconds;
    if (secondsRemaining >= 0) {
      timerDisplay.innerHTML = "" + formatSecondsRemaining(secondsRemaining) + " seconds remaining";
    } else {
      cleanUpTicker();
      tickerElement.innerHTML = "0s remaining";
      if (finishedCallback) safeCall(null, finishedCallback);
    }
  }

  timer = setInterval(tick, 1000);
  tick();
}

function printButton(name, parent, isSubmit, code) {
  var button;
  if (isSubmit) {
    button = document.createElement("input");
    button.type = "submit";
    button.value = name;
    button.name = name;
  } else {
    button = document.createElement("button");
    button.setAttribute("type", "button");
    printx(name, button);
  }
  setClass(button, "next");
  button.setAttribute("accesskey", "n");
  if (code) button.onclick = function(event) {
    if (window.isIosApp) {
      window.freezeCallback = function() {
        window.freezeCallback = null;
        code(event);
      };
      callIos("freeze");
    } else {
      safeCall(null, function() {code(event);});
    }
  };
  if (!isMobile) try { button.focus(); } catch (e) {}
  parent.appendChild(button);
  return button;
}

function printLink(target, href, anchorText, onclick) {
  if (!target) target = document.getElementById('text');
  var link = document.createElement("a");
  link.setAttribute("href", href);
  link.appendChild(document.createTextNode(anchorText));
  if (onclick) {
    if (link.addEventListener) {
      link.addEventListener("click", onclick, true);
    } else {
      link.onclick = onclick;
    }
  }
  target.appendChild(link);
  target.appendChild(document.createTextNode(" "));
}

function kindleButton(target, query, buttonName) {
  printButton(buttonName, main, false,
    function() {
      try {
        window.location.href="http://www.amazon.com/s?rh=n%3A133140011%2Ck%3A" + encodeURIComponent(query);
      } catch (e) {} // xulrunner will intercept this link and throw an exception, opening it in the external browser
    }
  );
}

function printInput(target, inputOptions, callback, minimum, maximum, step) {
    if (!target) target = document.getElementById('text');
    var form = document.createElement("form");
    target.appendChild(form);
    var self = this;
    form.action="#";


    if (inputOptions.long) {
      var input = document.createElement("textarea");
      input.setAttribute("rows", 4);
    } else {
      var input = document.createElement("input");
      if (inputOptions.numeric) {
        input.setAttribute("type", "number");
        input.setAttribute("min", minimum);
        input.setAttribute("max", maximum);
        step = step || "any";
        input.setAttribute("step", step);
      }
    }

    input.setAttribute("autocomplete", "off");

    input.name="text";
    input.setAttribute("style", "font-size: 25px; width: 90%;");
    form.appendChild(input);

    form.onsubmit = function(e) {
        preventDefault(e);
        if (!input.value && !inputOptions.allow_blank) {
            asyncAlert("Don't just leave it blank!  Type something!");
            return;
        }
        if (window.isIosApp) {
          window.freezeCallback = function() {
            window.freezeCallback = null;
            safeCall(null, function() {callback(input.value);});
          };
          callIos("freeze");
        } else {
          safeCall(null, function() {callback(input.value);});
        }
        return false;
    };

    printButton("Next", form, true);

}

function promptEmailAddress(target, defaultEmail, allowContinue, callback) {
  if (!target) target = document.getElementById('text');
  var form = document.createElement("form");
  var self = this;
  form.action="#";

  var message = document.createElement("div");
  message.style.color = "red";
  message.style.fontWeight = "bold";
  message.setAttribute("id", "errorMessage");
  form.appendChild(message);

  var input = document.createElement("input");
  // This can fail on IE
  try { input.type="email"; } catch (e) {}
  input.name="email";
  input.value=defaultEmail;
  input.setAttribute("style", "font-size: 25px; width: 90%;");
  form.appendChild(input);
  target.appendChild(form);
  println("", form);
  println("", form);
  printButton("Next", form, true);

  if (allowContinue) {
    printButton("No, Thanks", target, false, function() {
      callback(true);
    });
  }

  form.onsubmit = function(e) {
    preventDefault(e);
    safeCall(this, function() {
      var email = trim(input.value);
      if (!/^\S+@\S+\.\S+$/.test(email)) {
        var messageText = document.createTextNode("Sorry, \""+email+"\" is not an email address.  Please type your email address again.");
        message.innerHTML = "";
        message.appendChild(messageText);
      } else {
        recordEmail(email, function() {
          callback(false, email);
        });
      }
    });
  };

  curl();
}

function loginForm(target, optional, errorMessage, callback) {
  if (!isRegisterAllowed() || !initStore()) return safeTimeout(function() {
    callback(!"ok");
  }, 0);
  var optional_start = 1;
  var optional_returning_subscribe = 2;
  var optional_returning_no_subscribe = 3;
  var optional_new_subscribe = 4;
  var optional_new_no_subscribe = 5;
  startLoading();
  fetchEmail(function(defaultEmail) {
    isRegistered(function(registered) {
      if (registered) {
        if (defaultEmail) {
          doneLoading();
          loginDiv(registered, defaultEmail);
          return safeTimeout(callback, 0);
        }
        // Cookie says I'm logged in, but we have no local record of the email address
        return getRemoteEmail(function(ok, response) {
          doneLoading();
          if (ok) {
            if (response.email) {
              loginDiv(registered, response.email);
              return recordEmail(response.email, callback);
            } else {
              // not really logged in after all
              logout();
              loginDiv();
              return loginForm(target, optional, errorMessage, callback);
            }
          } else {
            // missed an opportunity to record email locally. meh.
            return safeCall(null, callback);
          }
        });
      }
      doneLoading();
      var form = document.createElement("form");

    if (!errorMessage) errorMessage = "";

      var escapedEmail = defaultEmail.replace(/'/g, "&apos;");
      var passwordButton;
      if (optional == optional_start) {
        form.innerHTML = "<div id=message style='color:red; font-weight:bold'>"+errorMessage+
          "</div><div class='choice'>"+
          "<div><label for=yes class=firstChild><input type=radio name=choice value=yes id=yes checked> My email address is: "+
          "<input type=email name=email id=email value='"+escapedEmail+"' style='font-size: 25px; width: 11em'></label></div>"+
          ((isWeb && window.facebookAppId) ?"<div><label for=facebook><input type=radio name=choice value=facebook id=facebook > Sign in with Facebook.</label></div>":"")+
          ((isWeb && window.googleAppId) ?"<div><label for=google><input type=radio name=choice value=google id=google > Sign in with Google.</label></div>":"")+
          ((window.steamRestoreCallback) ?"<div><label for=steam><input type=radio name=choice value=steam id=steam > Restore purchases from Steam.</label></div>":"")+
          "<div><label for=no class=lastChild><input type=radio name=choice value=no id=no > No, thanks.</label></div></div>"+
          "<p><label class=noBorder for=subscribe><input type=checkbox name=subscribe id=subscribe checked> "+
          "Email me when new games are available.</label></p>";

        form.email.onclick = function() {
          setTimeout(function() {form.email.focus();}, 0);
        };
        setTimeout(function() {form.email.focus();}, 0);
      } else {
        form.innerHTML = "<div id=message style='color:red; font-weight:bold'>"+errorMessage+
          "</div><span><span>My email address is: </span><input type=email name=email id=email value='"+
          escapedEmail+"' style='font-size: 25px; width: 12em'></span><p><label class=noBorder id=subscribeLabel for=subscribe>"+
          "<input type=checkbox name=subscribe id=subscribe checked> "+
          "Email me when new games are available.</label></p><p>Do you have a choiceofgames.com password?</p>"+
          "<div class='choice'>"+
          "<div><label for=new class=firstChild><input type=radio name=choice value=new id=new checked> No, I'm new.</label></div>"+
          "<div><label for=passwordButton><input type=radio name=choice value=passwordButton id=passwordButton> "+
          "Yes, I have a password: <input id=password type=password name=password disabled class=needsclick style='font-size: 25px; width: 11em'></label></div>"+
          "<div><label for=forgot><input type=radio name=choice value=forgot id=forgot> I forgot my password.</label></div>"+
          ((isWeb && window.facebookAppId)?"<div><label for=facebook><input type=radio name=choice value=facebook id=facebook> Sign in with Facebook.</label></div>":"")+
          ((isWeb && window.googleAppId)?"<div><label for=google><input type=radio name=choice value=google id=google> Sign in with Google.</label></div>":"")+
          (optional ? "<div><label for=no><input type=radio name=choice value=no id=no> Cancel.</label></div>" : "") +
          "</div>";

        var labels = form.getElementsByTagName("label");
        setClass(labels[labels.length-1], "lastChild");

        var password = form.password;
        passwordButton = form.passwordButton;

        passwordButton.parentNode.onclick = function() {
          passwordButton.checked = true;
          passwordButton.onchange();
        };

        var radioButtons = form.choice;
        var onchange = function() {
          var enabled = passwordButton.checked;
          password.disabled = !enabled;
          if (enabled) {
            password.focus();
            setTimeout(function() {password.parentNode.scrollIntoView();}, 0);
          }
        };
        for (var i = radioButtons.length - 1; i >= 0; i--) {
          radioButtons[i].onchange = onchange;
        }
        if (optional) {
          form.subscribe.checked = (optional == optional_returning_subscribe || optional == optional_new_subscribe);
          passwordButton.checked = (optional == optional_returning_subscribe || optional == optional_returning_no_subscribe);
        }
      }

      function showMessage(msg) {
        var message = document.getElementById('message');
        var messageText = document.createTextNode(msg);
        message.innerHTML = "";
        message.appendChild(messageText);
      }

      form.onsubmit = function(event) {
        preventDefault(event);
        var email = trim(form.email.value);
        var subscribe = form.subscribe.checked;
        var choice = getFormValue("choice");
        if ("steam" == choice) {
          window.location.href = "https://www.choiceofgames.com/profile/?steamRestore&gameId=" + window.storeName;
        }
        if ("facebook" == choice) {
          if (!window.FB) return asyncAlert("Sorry, we weren't able to sign you in with Facebook. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
          var loginParams = {scope:'email',return_scopes:true};
          if (window.facebookReRequest) loginParams.auth_type = "rerequest";
          return FB.login(function(response){
            if ("connected" == response.status) {
              var grantedScopes = [];
              try { grantedScopes = response.authResponse.grantedScopes.split(","); } catch (e) {}
              var grantedEmail = false;
              for (var i = 0; i < grantedScopes.length; i++) {
                if ("email" == grantedScopes[i]) {
                  grantedEmail = true;
                  break;
                }
              }
              if (grantedEmail) {
                xhrAuthRequest("POST", "facebook-login", function(ok, response){
                  if (ok) {
                    loginDiv(ok, response.email);
                    recordLogin(ok, response.id, response.email);
                    cacheKnownPurchases(response.purchases);
                    safeCall(null, function() {callback("ok");});
                  } else {
                    asyncAlert("Sorry, we weren't able to sign you in with Facebook. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
                  }
                }, "app_id", facebookAppId);
              } else {
                showMessage("Sorry, we require an email address to sign you in. Please grant access to your email address, or type your email address below.");
                window.facebookReRequest = true;
              }
            }
          },loginParams);
        }
        if ("google" == choice) {
          if (!window.gapi) return asyncAlert("Sorry, we weren't able to sign you in with Google. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
          var done = false;
          return gapi.auth.signIn({callback: function (authResult) {
            if (done) return;
            done = true;
            if (authResult['status']['signed_in']) {
              isRegistered(function(registered) {
                if (!registered) xhrAuthRequest("POST", "google-login", function(ok, response){
                  loginDiv(ok, response.email);
                  recordLogin(ok, response.id, response.email);
                  cacheKnownPurchases(response.purchases);
                  if (ok) {
                    callback("ok");
                  } else {
                    asyncAlert("Sorry, we weren't able to sign you in with Google. Please try again later, or contact support@choiceofgames.com for assistance.");
                  }
                }, "code", authResult['code'], "client_id", googleAppId);
              });
            } else {
              asyncAlert("Sorry, we weren't able to sign you in with Google. Please try again later, or contact support@choiceofgames.com for assistance.");
            }
          }});
        }
        if (!/^\S+@\S+\.\S+$/.test(email) && "no" != choice) {
          showMessage('Sorry, "'+email+'" is not an email address.  Please type your email address again.');
        } else {
          recordEmail(email, function() {
            if ("yes" == choice) {
              clearScreen(function() {
                if (defaultEmail) {
                  optional = subscribe ? optional_returning_subscribe : optional_returning_no_subscribe;
                } else {
                  optional = subscribe ? optional_new_subscribe : optional_new_no_subscribe;
                }
                loginForm(document.getElementById("text"), optional, null, callback);
                curl();
              });
            } else if ("no" == choice) {
              safeCall(null, function() {callback(false);});
            } else if ("new" == choice) {
              target.innerHTML = "";
              window.scrollTo(0,1);
              form = document.createElement("form");
              var escapedEmail = email.replace(/'/g, "&apos;");
              form.innerHTML = "<div id=message style='color:red; font-weight:bold'></div>"+
                "<div>My email address is: </div><div><input type=email name=email id=email value='"+
                escapedEmail+"' style='font-size: 25px; width: 12em'></div>"+
                "<div>Type it again: </div><div><input type=email name=email2 id=email2 autocomplete='off' style='font-size: 25px; width: 12em'></div>"+
                "<div>Enter a new password:&nbsp;</div><div>"+
                "<input type=password name=password id=password style='font-size: 25px; width: 12em'></div>";
              form.onsubmit = function(event) {
                preventDefault(event);
                var email = trim(form.email.value);
                var email2 = trim(form.email2.value);
                if (!/^\S+@\S+\.\S+$/.test(email)) {
                  showMessage('Sorry, "'+email+'" is not an email address.  Please type your email address again.');
                  return;
                } else if (email != email2) {
                  showMessage('Those email addresses don\'t match.  Please type your email address again.');
                  return;
                }
                startLoading();
                form.style.display = "none";
                window.scrollTo(0,1);
                login(email, form.password.value, /*register*/true, subscribe, function(ok, response) {
                  doneLoading();
                  if (ok) {
                    target.innerHTML = "";
                    loginDiv(ok, email);
                    recordLogin(ok, response.id, email);
                    cacheKnownPurchases(response.purchases);
                    // we need another click event so we can launch Stripe in a pop-up
                    if (window.isWeb) {
                      asyncAlert("You have registered successfully.", function() {
                        safeCall(null, function() {callback("ok");});
                      });
                    } else {
                      return safeCall(null, function() {callback("ok");});
                    }
                  } else if ("incorrect password" == response.error) {
                    target.innerHTML = "";
                    loginForm(target, optional, 'Sorry, the email address "'+email+'" is already in use. Please type your password below, or use a different email address.', callback);
                  } else {
                    form.style.display = "";
                    showMessage("Sorry, we weren't able to sign you in. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
                  }
                });
              };
              target.appendChild(form);
              println("", form);
              printButton("Next", form, true);
              if (optional) {
                printButton("Cancel", form, false, function() {
                  safeCall(null, function() {callback(false);});
                });
              }
            } else if ("passwordButton" == choice) {
              startLoading();
              form.style.display = "none";
              window.scrollTo(0,1);
              login(email, form.password.value, /*register*/false, form.subscribe.checked, function(ok, response) {
                doneLoading();
                form.style.display = "";
                if (ok) {
                  target.innerHTML = "";
                  loginDiv(ok, email);
                  recordLogin(ok, response.id, email);
                  cacheKnownPurchases(response.purchases);
                  // we need another click event so we can launch Stripe in a pop-up
                  if (window.isWeb) {
                    asyncAlert("You have registered successfully.", function() {
                      safeCall(null, function() {callback("ok");});
                    });
                  } else {
                    return safeCall(null, function() {callback("ok");});
                  }
                } else if ("unknown email" == response.error) {
                  showMessage('Sorry, we can\'t find a record for the email address "'+email+'". Please try a different email address, or create a new account.');
                } else if ("incorrect password" == response.error) {
                  showMessage('Sorry, that password is incorrect. Please try again, or select "I forgot my password" to reset your password.');
                } else {
                  showMessage("Sorry, we weren't able to sign you in. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
                }
              });
            } else if ("forgot" == choice) {
              startLoading();
              form.style.display = "none";
              window.scrollTo(0,1);
              forgotPassword(email, function(ok, response) {
                doneLoading();
                form.style.display = "";
                if (ok) {
                  showMessage("We've emailed you a link to reset your password. Please check your email and click on the link, then return here to sign in.");
                  document.getElementById('passwordButton').checked = true;
                  document.getElementById('passwordButton').onchange();
                } else if ("unknown email" == response.error) {
                  showMessage('Sorry, we can\'t find a record for the email address "'+email+'". Please try a different email address, or create a new account.');
                } else {
                  showMessage("Sorry, we weren't able to sign you in. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
                }
              });
            }
          });
        }
      };

      target.appendChild(form);
      if (passwordButton && passwordButton.checked) passwordButton.onchange();
      if (optional && optional > 1) document.getElementById("subscribeLabel").style.display = "none";
      printButton("Next", form, true);
      printFooter();
    });
  });
}

function loginDiv(registered, email) {
  var domain = "https://www.choiceofgames.com/";
  var identity = document.getElementById("identity");
  if (!identity) return;
  var emailLink = document.getElementById("email");
  var logoutLink = document.getElementById("logout");
  if (registered) {
    emailLink.setAttribute("href", domain + "profile" + "/");
    emailLink.innerHTML = "";
    emailLink.appendChild(document.createTextNode(email));
    logoutLink.onclick = function(event) {
      preventDefault(event);
      logout();
      loginDiv();
    };
    emailLink.style.display = "block";
    logoutLink.style.display = "block";
  } else {
    emailLink.style.display = "none";
    logoutLink.style.display = "none";
  }
}

function isRegistered(callback) {
  if (window.isWeb) {
    return safeTimeout(function() {
      if (!window.registered) window.registered = !!getCookieByName("login");
      callback(window.registered);
    }, 0);
  } else if (initStore()) {
    return window.store.get("login", function(ok, value) {
      safeTimeout(function() {
        window.registered = ok && value && "false" != value && "0" != value;
        callback(window.registered);
      }, 0);
    });
  } else {
    safeCall(null, function() {
      window.registered = false;
      callback(false);
    });
  }
}

function isRegisterAllowed() {
  return isWebSavePossible();
}

function preventDefault(event) {
  if (!event) event = window.event;
  if (!event) return;
  if (event.preventDefault) {
    event.preventDefault();
  } else {
    event.returnValue = false;
  }
}

function getPassword(target, code) {
  if (!target) target = document.getElementById('text');
  var textArea = document.createElement("textarea");
  textArea.cols = 41;
  textArea.rows = 30;
  setClass(textArea, "savePassword");
  target.appendChild(textArea);
  println("", target);
  printButton("Next", target, false, function() {
    code(false, textArea.value);
  });

  printButton("Cancel", target, false, function() {
    code(true);
  });
}

function showPassword(target, password) {
  if (!target) target = document.getElementById('text');

  var textBuffer = [];
  var colWidth = 40;
  for (var i = 0; i < password.length; i++) {
    textBuffer.push(password.charAt(i));
    if ((i + 1) % colWidth === 0) {
      textBuffer.push('\n');
    }
  }
  password = "----- BEGIN PASSWORD -----\n" + textBuffer.join('') + "\n----- END PASSWORD -----";

  var shouldButton = isMobile;
  if (shouldButton) {
    var button = printButton("Email My Password to Me", target, false,
      function() {
        safeCall(self, function() {
            if (isWeb) {
              // TODO more reliable system
            }
            window.location.href = "mailto:?subject=Save%20this%20password&body=" + encodeURIComponent(password);
        });
      }
    );
    setClass(button, "");
  }

  var shouldTextArea = !isMobile;
  if (shouldTextArea) {
    var textArea = document.createElement("textarea");
    textArea.cols = colWidth + 1;
    textArea.rows = 30;
    setClass(textArea, "savePassword");

    textArea.setAttribute("readonly", true);
    textArea.onclick = function() {textArea.select();};
    textArea.value = (password);
    target.appendChild(textArea);
  }
}

function changeTitle(title) {
  document.title = title;
  var titleTag = document.getElementById("title");
  if (titleTag) {
    titleTag.innerHTML = "";
    titleTag.appendChild(document.createTextNode(title));
  }
  var text = document.getElementById('text');
  if (text) {
    var textTitleTag = document.createElement('h1');
    textTitleTag.classList.add('gameTitle');
    textTitleTag.appendChild(document.createTextNode(title));
    text.appendChild(textTitleTag);
  }
}

function changeAuthor(author) {
  var authorTag = document.getElementById("author");
  if (authorTag) {
    authorTag.innerHTML = "";
    authorTag.appendChild(document.createTextNode("by " + author));
  }
  var text = document.getElementById('text');
  if (text) {
    var textAuthorTag = document.createElement('h2');
    textAuthorTag.classList.add('gameTitle');
    textAuthorTag.appendChild(document.createTextNode("by " + author));
    text.appendChild(textAuthorTag);
  }
}


function reportBug() {
  var prompt = "Please explain the problem. Be sure to describe what you expect, as well as what actually happened.";
  alertify.prompt(prompt, function(ok, body) {
    var statMsg = "(unknown)";
    try {
        var scene = window.stats.scene;
        statMsg = computeCookie(scene.stats, scene.temps, scene.lineNum, scene.indent);
    } catch (ex) {}
    body += "\n\nGame: " + window.storeName;
    if (window.stats && window.stats.scene) {
      body += "\nScene: " + window.stats.scene.name;
      body += "\nLine: " + (window.stats.scene.lineNum+1);
    }
    body += "\nUser Agent: " + navigator.userAgent;
    body += "\nLoad time: " + window.loadTime;
    if (window.Persist) body += "\nPersist: " + window.Persist.type;
    body += "\nversion=" + window.version;
    body += "\n\n" + statMsg;
    if (window.nav && window.nav.bugLog) body += "\n\n" + window.nav.bugLog.join("\n");
    console.log(body);
    if (ok) alertify.prompt("Please type your email address.", function(ok, email) {
      if (ok) xhrAuthRequest("POST", "support-mail", function(ok, response) {
        if (ok) {
          alertify.log("Thank you for reporting a bug!");
        } else {
          alertify.alert("Bug reporting failed. Please email your bug report to support@choiceofgames.com (and be sure to mention that the bug reporter failed!)");
        }
      }, "email", encodeURIComponent(email),
        "subject", encodeURIComponent("bug report " + window.storeName),
        "text", encodeURIComponent(body));
    });
  });
}

window.registered = false;

function getSupportEmail() {
  if (window.storeName) {
    return "support-" + storeName + "-" + platformCode() + "@choiceofgames.com";
  }
  try {
    return document.getElementById("supportEmail").getAttribute("href").substring(7);
  } catch (e) {
    return "support-external@choiceofgames.com";
  }
}

function absolutizeAboutLink() {
  var aboutAnchor = document.getElementById("aboutLink");
  if (aboutLink) {
    var aboutHref = aboutLink.getAttribute("href");
    if (/^https?:/.test(aboutHref)) return;

    var linkTags = document.getElementsByTagName("link");
    var canonical;
    for (var i = 0; i < linkTags.length; i++) {
      if (linkTags[i].getAttribute("rel") == "canonical") {
        canonical = linkTags[i].getAttribute("href");
        break;
      }
    }

    if (!canonical) return;

    var absoluteCanonical;
    if (/^https?:/.test(canonical)) {
      absoluteCanonical = canonical;
    } else if (/^\//.test(canonical)) {
      absoluteCanonical = "https://www.choiceofgames.com" + canonical;
    } else {
      absoluteCanonical = "https://www.choiceofgames.com/" + canonical;
    }
    if (!/\/$/.test(canonical)) {
      absoluteCanonical += "/";
    }

    aboutLink.setAttribute("href", absoluteCanonical + aboutHref);
  }
}

function aboutClick() {
    window.location.href = document.getElementById("aboutLink").href;
}

function loadPreferences() {
  if (initStore()) {
    store.get("preferredZoom", function(ok, preferredZoom) {
      if (ok && !isNaN(parseFloat(preferredZoom))) {
        setZoomFactor(parseFloat(preferredZoom));
      }
    });
    store.get("preferredBackground", function(ok, preferredBackground) {
      if (!/^(sepia|black|white)$/.test(preferredBackground)) {
        preferredBackground = "sepia";
      }
      if (preferredBackground === "black") {
        document.body.classList.add("nightmode");
      } else if (preferredBackground === "white") {
        document.body.classList.add("whitemode");
      }
    });
    store.get("preferredAnimation", function(ok, preferredAnimation) {
      window.animateEnabled = parseFloat(preferredAnimation) !== 2;
    });
    store.get("preferredSliding", function (ok, preferredSliding) {
      window.slidingEnabled = preferredSliding !== false && preferredSliding !== "false";
    });
  } else {
    window.animateEnabled = true;
  }
  if (typeof document.body.style.animationName === "undefined") {
    if (typeof document.body.style.webkitAnimationName === "undefined") {
      window.animateEnabled = false;
    } else {
      window.animationProperty = "webkitAnimationName";
    }
  } else {
    window.animationProperty = "animationName";
  }
  if (window.isCef || document.getElementsByTagName("audio").length) {
    delete window.animationProperty;
  }
}

window.addEventListener("error", function (event) {
    var msg = event.message;
    var file = event.source;
    var line = event.lineno;
    var column = event.colno;
    var error = event.error;
    window.reportError(msg, file, line, column, error);
});

window.reportError = function(msg, file, line, column, error) {
    if (window.console) {
      window.console.error(msg);
      if (file) window.console.error("file: " + file);
      if (line) window.console.error("line: " + line);
      if (column) window.console.error("column: " + column);
      if (error) window.console.error(error);
    }
    if (window.isWeb && error && error.name === "QuotaExceededError" && window.location.host === 'www.choiceofgames.com') {
      window.location.assign('https://www.choiceofgames.com/clear-site-data/?qee=1&path=' + encodeURIComponent(window.location.pathname));
    }
    alert(msg);
    if (!isWebSavePossible()) return;
    var ok = confirm("Sorry, an error occurred.  Click OK to email error data to support.");
    if (ok) {
        var statMsg = "(unknown)";
        try {
          var scene = window.stats.scene;
          statMsg = computeCookie(scene.stats, scene.temps, scene.lineNum, scene.indent);
        } catch (ex) {}
        var body = "What were you doing when the error occurred?\n\nError: " + msg;
        body += "\n\nGame: " + window.storeName;
        if (window.stats && window.stats.scene) {
          body += "\nScene: " + window.stats.scene.name;
          body += "\nLine: " + (window.stats.scene.lineNum + 1);
        }
        if (file) body += "\nJS File: " + file;
        if (line) body += "\nJS Line: " + line;
        if (column) body += "\nJS Column: " + column;
        if (error) body += "\nJS Stack: " + error;
        body += "\nUser Agent: " + navigator.userAgent;
        body += "\nLoad time: " + window.loadTime;
        if (window.Persist) body += "\nPersist: " + window.Persist.type;
        body += "\n\n" + statMsg + "\n\nversion=" + window.version;
        if (window.currentVersion) {
          body += "\ncurrentVersion=" + window.currentVersion;
        }
        if (window.nav && window.nav.bugLog) body += "\n\n" + window.nav.bugLog.join("\n");
        var supportEmailHref = "mailto:support-external@choiceofgames.com";
        try {
          supportEmailHref="mailto:"+getSupportEmail();
          supportEmailHref=supportEmailHref.replace(/\+/g,"%2B");
        } catch (e) {}
        window.location.href=(supportEmailHref + "?subject=Error Report&body=" + encodeURIComponent(body));
    }
}

window.onload=function() {
    if (window.alreadyLoaded) return;
    window.alreadyLoaded = true;
    setTimeout(updateAllPaidSceneCaches, 0);
    window.main = document.getElementById("main");
    var head = document.getElementsByTagName("head")[0];
    window.nav.setStartingStatsClone(window.stats);
    loadPreferences();
    if (window.achievements && window.achievements.length) {
      nav.loadAchievements(window.achievements);
      checkAchievements(function() {});
      setButtonTitles();
    }
    nav.loadProducts(window.knownProducts, window.purchases);
    stats.sceneName = window.nav.getStartupScene();
    var map = parseQueryString(window.location.search);
    if (!map) {
      var hashMap = parseQueryString(window.location.hash);
      var realHash = false;
      for (var key in hashMap) {
        if (/^utm_/.test(key)) continue;
        realHash = true;
        break;
      }
      if (realHash) map = hashMap;
    }

    if (!map) {
      if (window.androidQueryString) {
        map = parseQueryString(window.androidQueryString.get());
      } else if (window.forcedScreenshots) {
        map = {forcedScene:"screenshots"};
      }
    }

    if (map) {
      window.forcedScene = map.forcedScene;
      window.slot = map.slot;
      window.debug = map.debug;
      if (map.restart) {
        restartGame();
      } else if (map.achievements) {
        doneLoading();
        showAchievements("hideNextButton");
      } else if (map.omnibusRestore) {
        restorePurchases('adfree', function(purchased) {
          if (window.isIosApp) {
            callIos('close');
          } else {
            setTimeout(function() {window.closer.close()}, 0);
          }
        });
      } else if (map.forcedScene) {
        safeCall(null, function() {loadAndRestoreGame(window.slot, window.forcedScene);});
      } else if (map.persistence) {
        var persistenceParts = map.persistence.split("|");
        if (persistenceParts.length == 2) {
          window.storeName = persistenceParts[0];
          window.remoteStoreName = persistenceParts[1];
        } else {
          window.storeName = map.persistence;
        }
        var startupScene = new Scene("startup", window.stats, window.nav, {secondaryMode:"startup", saveSlot:"startup"});
        startupScene.startupCallback = function() {
          safeCall(null, loadAndRestoreGame);
        }
        startupScene.execute();
      } else if (map.textOptionsMenu) {
        if (initStore()) {
          store.get("preferredSliding", function (ok, preferredSliding) {
            textOptionsMenu();
          });
        } else {
          textOptionsMenu();
        }
      } else {
        safeCall(null, loadAndRestoreGame);
      }
    } else {
      safeCall(null, loadAndRestoreGame);
    }
    if (window.beta) {
      var reportBugButton = document.getElementById("bugButton");
      if (reportBugButton) reportBugButton.setAttribute("style", "");
    }
    if (window.Touch && window.isWeb) {
      // INSERT ADMOB AD
    }
    isRegistered(function(registered){
      if (registered) {
        fetchEmail(function(email) {
          loginDiv(registered, email);
        });
      } else {
        loginDiv();
      }
    });
    if (window.isWinStoreApp || window.isWinOldApp) {
        var subscribeAnchor = document.getElementById("subscribeLink");
        if (subscribeAnchor) {
            subscribeAnchor.onclick = function() {
              safeCall(null, subscribeLink);
              return false;
            };
        }
    }
    if (window.isWinOldApp) {
        absolutizeAboutLink();
        var h1s = document.getElementsByTagName("h1");
        if (h1s.length) window.external.SetTitle(document.getElementsByTagName("h1")[0].innerText);
    }
    if (isFollowEnabled()) {
      var shareElement = document.getElementById("share");
      if (shareElement) shareElement.innerHTML = '<iframe src="//www.facebook.com/plugins/like.php?href=https%3A%2F%2Fwww.facebook.com%2Fchoiceofgames&amp;send=false'+
      '&amp;layout=button_count&amp;width=90&amp;show_faces=true&amp;font&amp;colorscheme=light&amp;action=like&amp;height=20&amp;appId=190439350983878"'+
      ' scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:90px; height:20px;" allowTransparency="true"></iframe>'+
      '<iframe allowtransparency="true" frameborder="0" scrolling="no" '+
      'src="//platform.twitter.com/widgets/follow_button.html?screen_name=choiceofgames&amp;show_screen_name=false"'+
      ' style="width:160px; height:20px;"></iframe>';
    }
    var supportEmailLink = document.getElementById("supportEmail");
    if (window.storeName && supportEmailLink) {
      supportEmailLink.href = "mailto:" + getSupportEmail();
    }

    submitAnyDirtySaves();

    if (window.purchaseSubscriptions) {
      var productList = "";
      for (var key in purchaseSubscriptions) {
        productList += (productList ? " " : "") + key;
      }
      if (productList) checkPurchase(productList, function() {});
    }
    if (window.isWeb) {
      (function() {
        if (isPrerelease()) {
          var appLinks = document.getElementById('mobileLinks');
          if (appLinks) appLinks.style.display = 'none';
        }
        var productMap = {};
        if (typeof purchases === "object") {
          for (var scene in purchases) {
            productMap[purchases[scene]] = 1;
          }
        }
        if (!window.knownProducts) window.knownProducts = [];
        for (var product in productMap) {
          window.knownProducts.push(product);
        }

        var fullProducts = [];
        for (var i = 0; i < window.knownProducts.length; i++) {
          fullProducts[i] = window.storeName + "." + window.knownProducts[i];
        }
        xhrAuthRequest("GET", "product-data", function(ok, data) {
          if (!window.productData) window.productData = {};
          for (var i = 0; i < window.knownProducts.length; i++) {
            window.productData[window.knownProducts[i]] = data[window.storeName + "." + window.knownProducts[i]];
          }
        }, "products", fullProducts.join(","));
      })();
    }

    document.addEventListener('keydown', function(ev) {
      var inputType;
      if (ev.target && ev.target.tagName === 'INPUT') {
        inputType = ev.target.type;
      }
      if (inputType === 'text' || inputType === 'number' || inputType === 'email' || inputType === 'password') return;
      var dialog = document.getElementById('keyboardShortcuts');
      if (dialog && dialog.open) {
        dialog.close();
        return;
      }
      var key = ev.key;

      function clickRadio(value) {
        var newTarget = document.querySelector('input[type=radio][value="' + value + '"]');
        if (!newTarget) return;
        if (newTarget.disabled) return;
        newTarget.checked = true;
        newTarget.focus();
        newTarget.blur();
      }

      function clickButton(id) {
        var button = document.querySelector('#' + id);
        if (!button) return;
        button.click();
      }

      if (key === 'j') {
        var oldTarget = document.querySelector('input[type=radio]:checked');
        if (!oldTarget) {
          var input = document.querySelector('#main input');
          if (input) {
            setTimeout(function () { input.focus(); }, 0);
          }
          return;
        }
        var value = Number(oldTarget.value);
        var availableValues = [...oldTarget.form.querySelectorAll('input[type=radio]:not(:disabled)')].map(e => Number(e.value));
        var valueIndex = availableValues.indexOf(value);
        if (value === availableValues.at(-1)) {
          value = availableValues[0];
        } else {
          value = availableValues[valueIndex + 1];
        }
        clickRadio(value);
      } else if (key === 'k') {
        var oldTarget = document.querySelector('input[type=radio]:checked');
        if (!oldTarget) return;
        var value = Number(oldTarget.value);
        var availableValues = [...oldTarget.form.querySelectorAll('input[type=radio]:not(:disabled)')].map(e => Number(e.value));
        var valueIndex = availableValues.indexOf(value);
        if (value == availableValues[0]) {
          value = availableValues.at(-1);
        } else {
          value = availableValues[valueIndex - 1];
        }
        clickRadio(value);
      } else if (!isNaN(key)) {
        if (key === "0") {
          key = 10;
        }
        key--;
        clickRadio(key);
      } else if (key === 'q') {
        clickButton('statsButton');
      } else if (key === 'w') {
        clickButton('menuButton');
      } else if (key === 'Enter') {
        if (ev.target && (ev.target.tagName === "BUTTON" || ev.target.tagName === "A")) {
          if (ev.target.getAttribute("accesskey") === "n") {
            ev.preventDefault();
          } else {
            return;
          }
        }
        if (window.activatingNext) return;
        var checked = document.querySelector('input[type=radio]:checked');
        if (checked) {
          var label = document.querySelector('label[for="' + checked.id + '"]').parentElement;
          if (label) {
            label.scrollIntoView({ block: "nearest", behavior: 'smooth' });
            label.classList.add('selectedKeyboard');
          }
          window.activatingNext = Date.now();
        } else {
          var n;
          if (ev.target && (ev.target.tagName === "BUTTON" || ev.target.tagName === "A")) {
            n = ev.target;
          } else {
            n = document.querySelector('*[accesskey="n"]');
          }
          if (n) {
            n.scrollIntoView({block: "nearest", behavior: 'smooth'});
            n.classList.add('selectedKeyboard');
            window.activatingNext = Date.now();
          }
        }
      } else if (key === '?' || key === '/') {
        if (dialog && dialog.showModal) dialog.showModal();
      }
    }, false);

    document.addEventListener('keyup', function (ev) {
      var now = Date.now();
      var activatingNext = window.activatingNext;
      window.activatingNext = null;
      if (ev.key === 'Enter' && activatingNext && (now - activatingNext > 500)) {
        var n = document.querySelector('.selectedKeyboard');
        if (n && (n.tagName === 'BUTTON' || n.tagName === 'A')) {
          n.click();
        } else {
          n = document.querySelector('*[accesskey="n"]');
          if (n) n.click();
        }
      }
      document.querySelectorAll('.selectedKeyboard').forEach(function (selected) {
        selected.classList.remove('selectedKeyboard');
      })
    });

};

if ( document.addEventListener ) {
  document.addEventListener( "DOMContentLoaded", window.onload, false );
}

try {
  var style = document.createElement('style');
  style.type = 'text/css';
  try {style.innerHTML = 'noscript {display: none;}'; } catch (e) {}
  document.getElementsByTagName('head')[0].appendChild(style);
} catch (e) {}

if (window.isWeb) {
  document.getElementById("dynamic").innerHTML = ".webOnly { display: block; }";
  var checkoutScript = document.createElement("script");
  checkoutScript.async = 1;
  checkoutScript.src="https://checkout.stripe.com/v2/checkout.js";
  document.getElementsByTagName("head")[0].appendChild(checkoutScript);

  var metas = document.getElementsByTagName("meta");
  var facebookAppId, googleAppId;
  var googleLoginCallbackCallback;
  for (var i = 0; i < metas.length; i++) {
    var meta = metas[i];
    if ("fb:app_id" == meta.getAttribute("property")) {
      facebookAppId = meta.getAttribute("content");
    } else if ("google-signin-clientid" == meta.getAttribute("name")) {
      googleAppId = meta.getAttribute("content");
    }
  }

  if (facebookAppId) {
    window.fbAsyncInit = function() {
      FB.init({
        appId      : facebookAppId,
        cookie     : true,  // enable cookies to allow the server to access 
                            // the session
        xfbml      : true,  // parse social plugins on this page
        version    : 'v2.0' // use version 2.0
      });
    };

    (function(d, s, id){
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src ="//connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document,'script','facebook-jssdk'));
  }

  if (googleAppId) (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/client:plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
  
} else if (window.isIosApp) {
  document.getElementById("dynamic").innerHTML =
  "#text .gameTitle { display: block; }"+
  ""+
  "#header { display: none; }"+
  ""+
  "body { transition-duration: 0; }"+
  ""+
  "#emailUs { display: none; }"+
  ""+
  "#main { padding-top: 1em; }";
  // Use UIWebView width, not screen width, on iPad
  document.querySelector("meta[name=viewport]").setAttribute("content", "width="+window.innerWidth);
  window.addEventListener("resize", function() {
      document.querySelector("meta[name=viewport]").setAttribute("content", "width="+window.innerWidth);
      // this dummy element seems to be required to get the viewport to stick
      var dummy = document.createElement("p");
      dummy.innerHTML = "&nbsp;";
      document.body.appendChild(dummy);
      window.setTimeout(function() {document.body.removeChild(dummy);}, 10);
    }, false);
  callIos("checkdiscounts");
  // in a timeout because iOS may try to add to the head before mygame.js has run
  (function(){
    var requester = function() {
      if (window.stats) {
        callIos("requestscenes");
      } else {
        safeTimeout(requester, 1);
      }
    }
    if (window.isFile) safeTimeout(requester, 0);
  })();
} else if (window.isAndroidApp) {
  document.getElementById("dynamic").innerHTML =
  "#text .gameTitle { display: block; }" +
  "" +
  "#header { display: none; }"+
  ""+
  "#emailUs { display: none; }"+
  ""+
  "#main { padding-top: 1em; }";
} else if (window.isMacApp || window.isWinOldApp || window.isCef || window.isNode || window.isSteamApp) {
  document.getElementById("dynamic").innerHTML =
    "#header .gameTitle { display: none; }" +
    "" +
    "#text .gameTitle { display: block; }" +
    "" +
    "#headerLinks { display: none; }"+
    ""+
    "#emailUs { display: none; }";
}
// on touch devices, this hover state never goes away
if (!('ontouchstart' in window)) {
  document.getElementById("dynamic").innerHTML += ".choice > div:hover {background-color: #E4DED8;}\n" +
    "body.nightmode .choice > div:hover {background-color: #555;}\n"+
    "body.whitemode .choice > div:hover {background-color: #ddd;}\n";
}
function fixChromeLinks() {
  var aboutLink = document.getElementById("aboutLink");
  aboutLink.addEventListener("click", function() {
    if (chrome.app.window) {
      event.preventDefault();
      chrome.app.window.create("credits.html", {}, function(w) {
        w.contentWindow.addEventListener( "DOMContentLoaded", function() {
          var win = this;
          var back = win.document.getElementById("back");
          back.addEventListener("click", function(event) {
            event.preventDefault();
            win.close();
          }, false);
          var base = win.document.createElement('base');
          base.setAttribute("target", "_blank");
          win.document.head.appendChild(base);
          win.document.documentElement.style.overflowY = "scroll";
        }, false);
      });
    }
  }, false);

  var statsButton = document.getElementById("statsButton");
  if (statsButton) {
    statsButton.onclick = undefined;
    statsButton.addEventListener("click", function() {
      showStats();
    }, false);
  }

  var achievementsButton = document.getElementById("achievementsButton");
  if (achievementsButton) {
    achievementsButton.onclick = undefined;
    achievementsButton.addEventListener("click", function() {
      showAchievements();
    }, false);
  }

  var restartButton = document.getElementById("restartButton");
  restartButton.onclick = undefined;
  restartButton.addEventListener("click", function() {
    restartGame("prompt");
  }, false);

  var subscribeAnchor = document.getElementById("subscribeLink");
  subscribeAnchor.onclick = undefined;
  subscribeAnchor.addEventListener("click", function() {
    subscribeLink();
  }, false);

  var supportAnchor = document.getElementById("supportEmail");
  supportAnchor.addEventListener("click", function(event) {
    event.preventDefault();
  }, false);

  var menuButton = document.getElementById("menuButton");
  menuButton.onclick = undefined;
  menuButton.addEventListener("click", function() {
    textOptionsMenu();
  }, false);
}
if (window.isChromeApp) {
  var base = document.createElement('base');
  base.setAttribute("target", "_blank");
  document.head.appendChild(base);

  document.addEventListener("DOMContentLoaded", fixChromeLinks);
  setInterval(function() {
    document.body.style.height = document.querySelector(".container").offsetHeight + "px";
  }, 100);
}
if (window.isCef) {
  var pollPurchases = function() {
    cefQuery({
      request:"PollPurchases",
      onSuccess:function(response){
        //console.log("PollPurchases: '"+response+"'");
        if (response) {
          clearScreen(loadAndRestoreGame);
        }
        safeTimeout(pollPurchases, 100);
      },
      onFailure:function(error_code, error_message) {
        console.error("PollPurchases error: " + error_message);
      }
    });
  };
  pollPurchases();
} else if (window.isSteamworks) {
	(function() {
		var steamworksApps = require('../package.json').products;
		if (typeof steamworksApps === "undefined") throw new Error("package.json missing products");
		var steamworksAppId = window.isTrial ? steamworksApps.steam_demo : steamworksApps.adfree;
    if (steamworksApi.restartAppIfNecessary(steamworksAppId)) {
      require('electron').ipcRenderer.invoke('quit');
      return;
    }
    try {
      window.steamworks = steamworksApi.init(steamworksAppId);
    } catch (e) {
      alert("There was an error connecting to Steam. Steam must be running" +
        " to play this game. If you launched this game using Steam, try restarting Steam" +
        " or rebooting your computer. If that doesn't work, try completely uninstalling" +
        " Steam and downloading a fresh copy from steampowered.com.\n\nIf none of that works, please contact" +
        " support@choiceofgames.com and we'll try to help. (Mention error code 77779.)")
      require('electron').ipcRenderer.invoke('quit');
      return;
    }
    var adfreePurchased;
    try {
      adfreePurchased = steamworks.apps.isSubscribedApp(steamworksApps.adfree);
    } catch (e) {
      alert("There was an error connecting to Steam. Steam must be running" +
        " to play this game. If you launched this game using Steam, try restarting Steam" +
        " or rebooting your computer. If that doesn't work, try completely uninstalling" +
        " Steam and downloading a fresh copy from steampowered.com.\n\nIf none of that works, please contact" +
        " support@choiceofgames.com and we'll try to help. (Mention error code 77776.)")
      require('electron').ipcRenderer.invoke('quit');
      return;
    }
		if (window.isTrial && adfreePurchased) {
			alert("This is the demo version of the game, " +
				"but you now own the full version. The demo will now exit. Your progress has been saved." +
				" Please launch the full version of the game using Steam.");
			require('electron').ipcRenderer.invoke('quit');
    } else if (!window.isTrial && !adfreePurchased) {
      alert("There was an error connecting to Steam. Steam must be running" +
        " to play this game. If you launched this game using Steam, try restarting Steam" +
        " or rebooting your computer. If that doesn't work, try completely uninstalling" +
        " Steam and downloading a fresh copy from steampowered.com.\n\nIf none of that works, please contact" +
        " support@choiceofgames.com and we'll try to help. (Mention error code 77778.)")
      require('electron').ipcRenderer.invoke('quit');
      return;
    }
    window.isSteamDeck = !!(steamworks.utils.isSteamRunningOnSteamDeck && steamworks.utils.isSteamRunningOnSteamDeck());
		if (window.isSteamDeck) {
      window.addEventListener("DOMContentLoaded", function() {
        window.document.body.addEventListener('click', function (event) {
          if (event.target && event.target.tagName === 'A' && event.target.href !== '#') {
            event.preventDefault();
            var href = event.target.href;
            var intercepts = require('../package.json').intercepts;
            for (var intercept in intercepts) {
              if (href.startsWith(intercept)) {
                var StoreFlagNone = 0;
                console.log('activating to store');
                steamworks.overlay.activateToStore(intercepts[intercept], StoreFlagNone);
                console.log('activated');
                return;
              }
            }
            console.log('activating to web');
            steamworks.overlay.activateToWebPage(href);
            console.log('activated');
          }
        });
      })
    }
    var pollPurchases = function(oldCount) {
			var count = 0;
			for (var product in steamworksApps) {
				if (steamworks.apps.isSubscribedApp(steamworksApps[product])) {
					count++;
				}
			}
			if (count != oldCount && typeof oldCount !== "undefined") clearScreen(loadAndRestoreGame);
			safeTimeout(function() {pollPurchases(count)}, 100);
		};
		pollPurchases();

    var appIds = [];
    for (var product in steamworksApps) {
      appIds.push(steamworksApps[product]);
    }

    xhrAuthRequest("GET", "steam-price", function(ok, data) {
      if (!window.productData) window.productData = {};
      for (var product in steamworksApps) {
        window.productData[product] = data[steamworksApps[product]];
      }
      if (window.awaitSteamProductData) window.awaitSteamProductData();
    }, "user_id", steamworks.localplayer.getSteamId().steamId64, "app_ids", appIds.join(","));
	})();
}

function winStoreShareLinkHandler(e) {
    var request = e.request;
    var canonical = document.querySelector("link[rel=canonical]");
    var canonicalHref = canonical && canonical.getAttribute("href");
    if (!/^https?:/.test(canonicalHref)) {
        canonicalHref = "https://www.choiceofgames.com" + canonicalHref;
    }
    if (!/\/$/.test(canonicalHref)) {
        canonicalHref += "/";
    }
    canonicalHref += "redirect.php?src=winshare";
    request.data.properties.title = document.title;
    request.data.properties.description = document.querySelector("meta[name=description]").getAttribute("content");
    request.data.setUri(new Windows.Foundation.Uri(canonicalHref));
}

if (window.isWinStoreApp) {
    var dataTransferManager = Windows.ApplicationModel.DataTransfer.DataTransferManager.getForCurrentView();
    dataTransferManager.addEventListener("datarequested", winStoreShareLinkHandler);

    baseScript = document.createElement("script");
    baseScript.src = "//Microsoft.WinJS.1.0/js/base.js";
    baseScript.onload = function () {
        WinJS.Application.onsettings = function (e) {
            var privacyCmd = new Windows.UI.ApplicationSettings.SettingsCommand("privacy", "Privacy Policy", function () {
                window.open("https://www.choiceofgames.com/privacy-policy");
            });
            e.detail.e.request.applicationCommands.append(privacyCmd);
        };
        WinJS.Application.start();
    };
    document.head.appendChild(baseScript);

    uiScript = document.createElement("script");
    uiScript.src = "//Microsoft.WinJS.1.0/js/ui.js";
    document.head.appendChild(uiScript);
} else if (window.isWinOldApp) {
    console = {
        log: function (message) { window.external.ConsoleLog(message); },
        error: function (message) { window.external.ConsoleError(message); }
    };
    document.oncontextmenu = function() {return false;};
}

function platformCode() {
  var platform = "unknown";
  if (window.isIosApp) platform = "ios";
  else if (window.isAndroidApp) platform = "android";
  else if (window.isMacApp) platform = "mac";
  else if (window.isWinStoreApp) platform = "windows";
  else if (window.isWinOldApp) platform = "csharp";
  else if (window.isChromeApp) platform = "chrome";
  else if (window.isWebOS) platform = "palm";
  else if (window.isSteamApp) platform = "steam";
  else if (window.isCef) platform = "cef";
  else if (window.isNode) platform = "dl";
  else if (window.isWeb) platform = "web";
  if (window.isOmnibusApp) platform = "omnibus-" + platform;
  return platform;
}

function reinjectNavigator() {
  if (window.stats && window.stats.scene && window.stats.scene.nav) {
    var scene = window.stats.scene;
    scene.nav = window.nav;
    nav.repairStats(scene.stats);
  }
}

;
/*
 * Copyright 2010 by Dan Fabulich.
 *
 * Dan Fabulich licenses this file to you under the
 * ChoiceScript License, Version 1.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *  http://www.choiceofgames.com/LICENSE-1.0.txt
 *
 * See the License for the specific language governing
 * permissions and limitations under the License.
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied.
 */
function Scene(name, stats, nav, options) {
    if (!name) name = "";
    if (!stats) stats = {};
    // the name of the scene
    this.name = name;

    // the permanent statistics and the temporary values
    this.stats = stats;
    // implicit_control_flow controls whether goto is necessary to leave options (true means no)
    // _choiceEnds stores the line numbers to jump to when choice #options end.
    this.temps = {choice_reuse:"allow", choice_user_restored:false, _choiceEnds:{}, _looplimit: 1000};

    // the navigator determines which scene comes next
    this.nav = nav;

    options = options || {};

    // should we print debugging information?
    this.debugMode = options.debugMode || false;

    // used for stats screen, and maybe other secondary views someday
    this.secondaryMode = options.secondaryMode;

    this.saveSlot = options.saveSlot || "";

    // the array of lines in the scene file
    this.lines = [];

    // the current line number (WARNING 0-based!)
    this.lineNum = 0;
    this.rollbackLineCoverage();

    // when this is true, the main printLoop will halt
    this.finished = false;

    // map of label names to line numbers
    this.labels = {};

    // the current amount of indentation
    this.indent = 0;

    // Did the previous line contain text?
    this.prevLine = "empty";

    // Have we ever printed any text?
    this.screenEmpty = true;

    // Have we run any commands (except for create and scene_list) yet?
    this.initialCommands = true;

    this.stats.sceneName = name;

    // for easy reachability from the window
    this.stats.scene = this;

    // where should we print text?
    this.target = null;

    this.accumulatedParagraph = [];
}

Scene.prototype.reexecute = function reexecute() {
  this.lineNum = this.stats.testEntryPoint || 0;
  this.finished = 0;
  this.indent = this.getIndent(this.lines[this.lineNum]);
  this.prevLine = "empty";
  this.screenEmpty = true;
  this.execute();
};

// the main loop of the scene
Scene.prototype.printLoop = function printLoop() {
    var line;
    for (;!this.finished && this.lineNum < this.lines.length; this.lineNum++) {
        line = this.lines[this.lineNum];
        if (!trim(line)) {
            this.paragraph();
            continue;
        }
        var indent = this.getIndent(line);
        if (indent > this.indent) {
            // ignore indentation level of *comments
            if (/\s*\*comment\b/.test(line)) continue;
            throw new Error(this.lineMsg() + "increasing indent not allowed, expected " + this.indent + " was " + indent);
        } else if (indent < this.indent) {
            this.dedent(indent);
        }
        // Ability to end a choice #option without goto is guarded by implicit_control_flow variable
        if (this.temps._choiceEnds[this.lineNum] &&
                (this.getVar("implicit_control_flow") || this.temps._fakeChoiceDepth > 0)) {
            // Skip to the end of the choice if we hit the end of an #option
            this.rollbackLineCoverage();
            this.lineNum = this.temps._choiceEnds[this.lineNum];
            this.rollbackLineCoverage();
            if (this.temps._fakeChoiceDepth > 0) {
                this.temps._fakeChoiceDepth--;
            }
            continue;
        }
        this.indent = indent;
        if (/^\s*#/.test(line)) {
            throw new Error(this.lineMsg() + "It is illegal to fall out of a *choice statement; you must *goto or *finish before the end of the indented block.");
        }
        if (!this.runCommand(line)) {
            this.prevLine = "text";
            this.screenEmpty = false;
            this.initialCommands = false;
            this.printLine(line);
        }
    }
    this.rollbackLineCoverage();
    if (!this.finished) {
        this.autofinish();
    }
    this.save("temp");
    if (this.skipFooter) {
        this.skipFooter = false;
    } else {
        printFooter();
    }
};

Scene.prototype.dedent = function dedent(newDent) {};

Scene.prototype.printLine = function printLine(line) {
    if (!line) return null;
    this.screenEmpty = false;
    line = this.replaceVariables(line.replace(/^\s*/, ""));
    this.accumulatedParagraph.push(line);
    // insert extra space unless the line ends with hyphen or dash
    if (!/([-\u2011-\u2014]|\[c\/\])$/.test(line)) this.accumulatedParagraph.push(' ');
};

Scene.prototype.replaceVariables = function (line) {
  line = String(line);
  var replacer = /([$@](\!?\!?)\{)/;
  var index = 0;
  var output = [];
  for (var result = replacer.exec(line); result; result = replacer.exec(line.substring(index))) {
    output.push(line.substring(index, index + result.index));
    var curlies = 0;
    var closingCurly = -1;
    var exprStart = index + result.index + result[1].length;
    for (var i = exprStart; i < line.length; i++) {
      var c = line.charAt(i);
      if (c === "{") {
        curlies++;
      } else if (c === "}") {
        if (curlies) {
          curlies--;
        } else {
          closingCurly = i;
          break;
        }
      }
    }
    if (closingCurly == -1) {
      throw new Error(this.lineMsg() + "invalid "+result[0]+"} variable substitution at letter " + (index + result.index + 1));
    }
    var body = line.substring(exprStart, closingCurly);
    var stack, value;
    if (result[0].charAt(0) === "$") {
      stack = this.tokenizeExpr(body);
      value = this.evaluateExpr(stack);
    } else {
      var expr;
      var options;
      if (/^\s*\(/.test(body)) {
        var parens = 0;
        var closingParen = -1;
        for (var i = 1; i < body.length; i++) {
          var c = body.charAt(i);
          if (c === "(") {
            parens++;
          } else if (c === ")") {
            if (parens) {
              parens--;
            } else {
              closingParen = i;
              break;
            }
          }
        }
        if (closingParen == -1) {
          throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; missing closing parenthesis )");
        }
        if (body.charAt(closingParen+1) != " ") {
          throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; there should be a space after the closing parenthesis )");
        }
        expr = body.substring(1, closingParen);
        options = body.substring(closingParen+2).split("|");
      } else {
        if (!/^\S+ /.test(body)) {
          throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; there should be a space after the first word");
        }
        var spaceIndex = body.indexOf(' ');
        expr = body.substring(0, spaceIndex);
        options = body.substring(spaceIndex+1).split("|");
      }
      if (options.length < 2) {
        throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; there should be at least one pipe | to separate options");
      }
      stack = this.tokenizeExpr(expr);
      value = this.evaluateExpr(stack);
      if (typeof value === "boolean" || /^(true|false)$/i.test(value)) {
        value = bool(value) ? 1 : 2;
      }
      value = num(value, this.lineNum+1, this.name);
      if ((value | 0) !== value) {
        throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; '"+expr+"' is equal to " + value + " which is not a whole integer number");
      } else if (value < 1) {
        throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; '"+expr+"' is equal to " + value + " which is not a positive number");
      } else if (value > options.length) {
        throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; '"+expr+"' is equal to " + value + " but there are only " + options.length + " options");
      }
      value = options[value-1];
      value = this.replaceVariables(value);
    }
    var capitalize = result[2];
    if (capitalize) value = String(value);
    if (capitalize == "!") {
      value = value.charAt(0).toUpperCase() + value.slice(1);
    } else if (capitalize == "!!") {
      value = value.toUpperCase();
    }
    if (typeof highlightGenderPronouns != "undefined" && highlightGenderPronouns && /\b(he|him|his|she|her|hers)\b/gi.test(value)) {
      // this zero-width space will give us a hint for highlighting
      output.push("\u200b");
    }
    output.push(value);
    index = closingCurly+1;
  }
  if (index === 0) return line;
  output.push(line.substring(index));
  return output.join("");
};

Scene.prototype.paragraph = function paragraph() {
    printParagraph(this.accumulatedParagraph.join(""));
    this.accumulatedParagraph = [];
    this.prevLine = "empty";
};

Scene.prototype.loadSceneFast = function loadSceneFast(url) {
    if (this.loading) return;
    this.loading = true;
    var result;
    var self = this;
    if (typeof cachedResults != "undefined" && cachedResults && cachedResults[this.name]) {
      result = window.cachedResults[this.name];
      return safeTimeout(function() {self.loadLinesFast(result.crc, result.lines, result.labels);}, 0);
    } else if (typeof allScenes != "undefined") {
      result = allScenes[this.name];
      if (!result) throw new Error("Couldn't load scene '" + this.name + "'\nThe file doesn't exist.");
      return safeTimeout(function() {self.loadLinesFast(result.crc, result.lines, result.labels);}, 0);
    } else if (typeof window != "undefined" && window.isIosApp && window.isFile && !window.isOmnibusApp) {
      startLoading();
      var startedWaiting = new Date().getTime();

      function retryScenes(event, command) {
        if (!command) command = "retryscenes";
        clearScreen(function() {
          startLoading();
          if (command == "retryscenes") curl();
          window.downloadState = null;
          callIos(command);
          startedWaiting = new Date().getTime();
          awaitAllScenes();
        });
      }

      function awaitAllScenes() {
        if (typeof allScenes != "undefined") {
          result = allScenes[self.name];
          if (!result) throw new Error("Couldn't load scene '" + self.name + "'\nThe file doesn't exist.");
          self.loadLinesFast(result.crc, result.lines, result.labels);
        } else if (window.downloadState == "failed" || (new Date().getTime() - startedWaiting) > 5000) {
          doneLoading();
          if (window.downloadRequired) {
            self.printLine("We weren't able to download the latest version of the game.");
            self.paragraph();
            printButton("Try Again", main, false, retryScenes);
          } else {
            self.printLine("We weren't able to download the latest version of the game. Please try downloading again. The latest version may contain important fixes.");
            self.paragraph();
            var retry = {name: "Try downloading again."};
            var ignore = {name: "Continue playing without the latest version."}
            printOptions([""], [retry, ignore], function(option) {
              if (option == retry) {
                retryScenes();
              } else {
                retryScenes(null, "requestscenesforce");
              }
            });
          }
        } else {
          setTimeout(awaitAllScenes, 0);
        }
      }
      return awaitAllScenes();
    } else if (window.purchases[self.name] && isStoreSceneCacheRequired()) {
      var sceneName = this.name.replace(/ /g, "_");
      return window.store.get("cache_scene_hash_"+sceneName, function(ok, hash) {
        function keepScene(result) {
          if (!window.cachedResults) window.cachedResults = {};
          cachedResults[self.name] = result;
          self.loadLinesFast(result.crc, result.lines, result.labels);
        }
        function loadPaidScene() {
          startLoading();
          updateSinglePaidSceneCache(self.name, function(err, result) {
            doneLoading();
            if (err) {
              if (err === "not registered") {
                logout();
                loginDiv();
                return clearScreen(function() {
                  loginForm(main, 0/*optional*/,
                    "Please sign in to access this part of the game.", function() {
                      clearScreen(loadAndRestoreGame);
                    });
                });
              } else if (err === "not purchased") {
                window.rerestore = function () {
                  restorePurchases(window.purchases[self.name], function (purchased) {
                    window.location.reload(); 
                  });
                };
                main.innerHTML = "<div id='text'><p>Our apologies; we were unable to access your purchase while loading game data. (Error 403x)" +
                  "  Please restore purchases now; if that doesn't work, please email " + getSupportEmail() + " with details, including the error number 403x.</p>" +
                  " <p><button class='next' onclick='window.rerestore();'>Restore Now</button></p></div>";
                curl();
                return;
              } else if (/^409-/.test(err)) {
                main.innerHTML = "<div id='text'><p>There was a " + err + " error while loading game data." +
                  "  This error occurs when you've logged into this app with a different choiceofgames.com account from the account you originally used to buy the game." +
                  "  You can resolve this error by going to Settings, signing out, and signing in as the account that originally purchased the game." +
                  "  If you need additional assistance, you can email us at " + getSupportEmail() + " and mention error code " + err + ".</p>"
                curl();
                return;
              }
              main.innerHTML = "<div id='text'><p>Our apologies; there was a " + err + " error while loading game data."+
              "  Please refresh now; if that doesn't work, please click the Restart button and email "+getSupportEmail()+" with details, including the error number.</p>"+
              " <p><button class='next' onclick='window.location.reload();'>Refresh Now</button></p></div>";
              curl();
            } else {
              keepScene(result);
            }
          })
        }
        if (ok && hash == hashes.scenes[sceneName + ".txt.json"]) {
          window.store.get("cache_scene_"+sceneName, function(ok, text) {
            if (ok && text) {
              var parsed;
              try {
                parsed = jsonParse(text);
              } catch (e) {
                if (window.console) console.error(e, e.stack);
              }
              if (parsed && parsed.crc && parsed.lines && parsed.labels) return keepScene(parsed);
              loadPaidScene();
            } else {
              loadPaidScene();
            }
          })
        } else {
          loadPaidScene();
        }
      });
    }
    startLoading();
    if (!url) {
        var fileName = this.name.replace(/ /g, "_") + ".txt.json";
        url = Scene.baseUrl + "/" + fileName;
        if (window.location.protocol == "https:" && window.hashes && window.hashes.scenes[fileName]) {
          url += "?hash="+hashes.scenes[fileName];
        }
    }
    var xhr = findXhr();
    xhr.open("GET", url, true);
    var self = this;
    var done = false;
    xhr.onreadystatechange = function() {
        if (done) return;
        if (xhr.readyState != 4) return;
        if (xhr.status == 403) {
          try {
            var err = JSON.parse(xhr.responseText);
            if (err.error == "not registered") {
              return isRegistered(function(registered) {
                if (registered) {
                  logout();
                  loginDiv();
                }
                return clearScreen(function() {
                  loginForm(main, 0/*optional*/,
                    "Please sign in to access this part of the game.", function() {
                      clearScreen(loadAndRestoreGame);
                    });
                });
              });
            }
          } catch (e) {} // JSON parse failure? must not be a login prompt
        }
        done = true;

        var result;
        try {
          result = jsonParse(xhr.responseText);
        } catch (e) {
          if (window.console) console.error(e, e.stack);
        }
        if (window.isWeb && (xhr.status != 200 || !result)) {
          doneLoading();
          var status = xhr.status;
          if (status == 200 || !status) status = "network";
          main.innerHTML = "<div id='text'><p>Our apologies; there was a " + status + " error while loading game data."+
          "  Please refresh your browser now; if that doesn't work, please click the Restart button and email "+getSupportEmail()+" with details.</p>"+
          " <p><button onclick='window.location.reload();'>Refresh Now</button></p></div>";
          curl();
          return;
        } else if (xhr.responseText === "") {
          throw new Error("Couldn't load " + url + "\nThe file is probably missing or empty.");
        }

        if (!window.cachedResults) window.cachedResults = {};
        cachedResults[self.name] = result;
        self.loadLinesFast(result.crc, result.lines, result.labels);
    };
    if (isIE) {
      // IE8 swallows errors in onreadystatechange if xhr.send is in a try block
      xhr.send(null);
    } else {
      try {
        xhr.send(null);
      } catch (e) {
        if (window.location.protocol == "file:" && !window.isMobile) {
          if (/Chrome/.test(navigator.userAgent)) {
            window.reportError("We're sorry, Google Chrome has blocked ChoiceScript from functioning.  (\"file:\" URLs cannot "+
            "load files in Chrome.)  ChoiceScript works just fine in Chrome, but only on a published website like "+
            "choiceofgames.com.  For the time being, please try another browser like Mozilla Firefox.");
            return;
          }
        }
        window.reportError("Couldn't load URL: " + url + "\n" + e);
      }
    }
};

Scene.prototype.loadLinesFast = function loadLinesFast(crc, lines, labels) {
  this.crc = crc;
  this.lines = lines;
  this.labels = labels;
  this.loading = false;
  this.loaded = true;
  var self = this;
  if (this.executing) {
    safeCall(this, function() {
      doneLoading();
      self.execute();
    });
  }
};

// load the scene file from the specified URL (or from default URL by name)
Scene.prototype.loadScene = function loadScene() {
    if (this.loading) return;
    this.loading = true;
    if (window.isFile) return this.loadFile();
    startLoading();
    var url = Scene.baseUrl + "/" + this.name + ".txt";
    var xhr = findXhr();
    xhr.open("GET", url, true);
    var self = this;
    var done = false;
    xhr.onreadystatechange = function() {
        if (done) return;
        if (xhr.readyState != 4) return;
        done = true;
        if (xhr.status == 403) {
          try {
            var err = JSON.parse(xhr.responseText);
            if (err.error == "not registered") {
              return isRegistered(function(registered) {
                if (registered) {
                  logout();
                  loginDiv();
                }
                return clearScreen(function() {
                  loginForm(main, 0/*optional*/,
                    "Please sign in to access this part of the game.", function() {
                      clearScreen(loadAndRestoreGame);
                    });
                });
              });
            }
          } catch (e) {} // JSON parse failure? must not be a login prompt
        }
        if (window.isWeb && xhr.status != 200) {
            var status = xhr.status || "network";
            main.innerHTML = "<p>Our apologies; there was a " + status + " error while loading game data."+
            "  Please refresh your browser now; if that doesn't work, please email "+getSupportEmail()+" with details.</p>"+
            " <p><button onclick='window.location.reload();'>Refresh Now</button></p>";
            return;
        } else if (xhr.responseText === "") {
          if (window.location.protocol == "file:" && !window.isMobile && /Chrome/.test(navigator.userAgent)) {
            window.reportError("We're sorry, Google Chrome has blocked ChoiceScript from functioning.  (\"file:\" URLs cannot "+
            "load files in Chrome.)  ChoiceScript works just fine in Chrome, but only on a published website like "+
            "choiceofgames.com.  For the time being, please try another browser like Mozilla Firefox.");
            return;
          } else {
            window.reportError("Couldn't load " + url + "\nThe file is probably missing or empty.");
            return;
          }
        }
        var result = xhr.responseText;
        scene = result;
        scene = scene.replace(/\r/g, "");
        this.loading = false;
        self.loadLines(scene);
        if (self.executing) {
            safeCall(self, function () {
              doneLoading();
              self.execute();
            });
        }
    };
    if (isIE) {
      // IE8 swallows errors in onreadystatechange if xhr.send is in a try block
      xhr.send(null);
    } else {
      try {
        xhr.send(null);
      } catch (e) {
        if (window.location.protocol == "file:" && !window.isMobile) {
          if (/Chrome/.test(navigator.userAgent)) {
            window.reportError("We're sorry, Google Chrome has blocked ChoiceScript from functioning.  (\"file:\" URLs cannot "+
            "load files in Chrome.)  ChoiceScript works just fine in Chrome, but only on a published website like "+
            "choiceofgames.com.  For the time being, please try another browser like Mozilla Firefox.");
            return;
          } else if (e.code === 1012 /*NS_ERROR_DOM_BAD_URI*/) {
            window.reportError("Couldn't load scene file: " + url + "\nThe file is probably missing.");
            return;
          }
        }
        window.reportError("Couldn't load URL: " + url + "\n" + e);
      }
    }
};

Scene.prototype.loadFile = function loadFile() {
  var _this = this;
  if (typeof uploadedFiles !== "object") {
    clearScreen(function() {
      var header = document.getElementById('header');
      if (header) header.style.display = "none";
      var makeYourOwnGames = document.getElementById('makeyourowngames');
      if (makeYourOwnGames) makeYourOwnGames.style.display = "none";
      _this.printLine("[b]Please \"Upload\" ChoiceScript[/b]");
      _this.paragraph();
      _this.printLine("To begin, you'll need to grant permission to \"upload\" your choicescript folder containing index.html.")
      _this.paragraph();
      _this.printLine("Use the button below to select your choicescript folder.");
      _this.paragraph();
      var text = document.getElementById('text');
      var input = document.createElement('input');
      input.type = 'file';
      input.webkitdirectory = true;
      input.multiple = true;
      input.addEventListener('change', function searchForStartup(e) {
        var numFiles = input.files.length;
        var startupCandidates = [];
        for (var i = 0; i < numFiles; i++) {
          var file = input.files[i];
          if (file.name === "startup.txt") {
            startupCandidates.push(file);
          }
        }
        if (!startupCandidates.length) {
          return clearScreen(function() {
            _this.printLine("We couldn't find startup.txt in the folder you chose. Please try again.")
            _this.paragraph();
            document.getElementById('text').appendChild(input);
            curl();
          });
        }

        if (startupCandidates.length > 1) {
          return clearScreen(function() {
            _this.printLine("There were multiple files called startup.txt in the folder you chose. Please try again.");
            _this.paragraph();
            for (var i = 0; i < startupCandidates.length; i++) {
              _this.printLine("\u2022 " + startupCandidates[i].webkitRelativePath);
            }
            _this.paragraph();
            document.getElementById('text').appendChild(input);
            curl();
          });
        }

        var startup = startupCandidates[0];
        var rootDirTest = new RegExp("^" + startup.webkitRelativePath.replace(/\/startup.txt$/, "/[^/]+$"));
        var sceneFiles = {};
        for (var i = 0; i < numFiles; i++) {
          var file = input.files[i];
          if (rootDirTest.test(file.webkitRelativePath)) {
            sceneFiles[file.name] = file;
          }
        }
        window.uploadedFiles = sceneFiles;
        if (header) header.style.display = "";
        if (makeYourOwnGames) makeYourOwnGames.style.display = "";
        clearScreen(function() {
          _this.loadFile();
        });
      });
      text.appendChild(input);
      _this.paragraph();
      _this.printLine("(We're not actually going to transfer your code over the Internet, " +
        "but this web page needs permission to upload your choicescript folder in order to access " +
        "your code and run it. The power to access your code would also grant us the power to " +
        "transfer your code elsewhere, but we're not going to do that. JavaScript programmers " +
        "can read our JavaScript to verify that this is true.)");
      _this.paragraph();
      curl();
    });
  } else {
    var fileName = this.name + ".txt";
    if (uploadedFiles[fileName]) {
      startLoading();
      new Response(uploadedFiles[fileName]).text().then(function(result) {
        scene = result;
        scene = scene.replace(/\r/g, "");
        _this.loading = false;
        safeCall(_this, function() {
          _this.loadLines(scene);
          doneLoading();
          _this.execute();
        });
      });
    } else {
      for (var otherFileName in uploadedFiles) {
        if (fileName.toLowerCase() === otherFileName.toLowerCase()) {
          main.innerHTML = "<p>Couldn't find "+fileName+" in the uploaded folder, but we did find "+otherFileName+". Scene file names must match exactly, including capitalization.</p>"+
          " <p><button onclick='window.location.reload();'>Refresh Now</button></p>";
          curl();
          return;
        }
      }
      main.innerHTML = "<p>Couldn't find "+fileName+" in the uploaded folder.</p>"+
        " <p><button onclick='window.location.reload();'>Refresh Now</button></p>";
      curl();
    }
  }
}

Scene.prototype.checkSum = function checkSum() {
  if (this.temps.choice_crc) {
    if (!this.randomtest && !this.quicktest && this.temps.choice_crc != this.crc && this.lineNum) {
      // The scene has changed; restart the scene from backup
      if (typeof alertify !== 'undefined') {
        if (!initStore()) {
          alertify.log(this.name + ".txt has updated. Restarting chapter.");
        } else {
          alertify.log("The game has updated. Restarting chapter.");
        }
      }
      var self = this;
      safeTimeout(function () {
        clearScreen(function () {
          loadAndRestoreGame("backup");
        });
      }, 0);
      return false;
    }
  }
  this.temps.choice_crc = this.crc;
  return true;
};

Scene.prototype.loadLines = function loadLines(str) {
    this.crc = crc32(str);
    this.lines = str.split(/\r?\n/);
    this.parseLabels();
    this.loaded = true;
};

// launch the vignette as soon as it's available
Scene.prototype.execute = function execute() {
    if (!this.loaded) {
        this.executing = true;
        if (Scene.generatedFast || (typeof generatedFast != "undefined" && generatedFast) || typeof allScenes != 'undefined') {
          this.loadSceneFast();
        } else {
          this.loadScene();
        }
        return;
    }
    if (!this.checkSum()) {
      return;
    }
    if (this.nav) this.nav.repairStats(stats);
    if (!this.temps._choiceEnds) this.temps._choiceEnds = {};
    doneLoading();
    if (typeof this.targetLabel != "undefined") {
      var label = this.targetLabel.label.toLowerCase();
      if (typeof(this.labels[label]) != "undefined") {
          this.lineNum = this.labels[label];
          this.indent = this.getIndent(this.lines[this.lineNum]);
          delete this.targetLabel;
      } else {
          throw new Error(this.targetLabel.origin + " line " + (this.targetLabel.originLine+1) + ": "+this.name+" doesn't contain label " + label);
      }
    }
    // this backup slot will only be used when the scene crc changes during upgrades
    if (!this.lineNum) {
      var subsceneStack = this.stats.choice_subscene_stack || [];
      if (!subsceneStack.length) this.save("backup");
    }
    if (this.redirectingFromStats) {
      this.save("");
      delete this.redirectingFromStats;
    }
    this.printLoop();
};

// loop through the file looking for *label commands
Scene.prototype.parseLabels = function parseLabels() {
    var lineLength = this.lines.length;
    var oldLineNum = this.lineNum;
    var screenshots = ("choicescript_screenshots" == this.name);
    var seenChoiceWithoutSet = 0;
    for (this.lineNum = 0; this.lineNum < lineLength; this.lineNum++) {
        this.rollbackLineCoverage();
        var line = this.lines[this.lineNum];
        // strip byte order mark
        if (this.lineNum == 0 && line.charCodeAt(0) == 65279) lines[0] = line.substring(1);
        var invalidCharacter = line.match(/^(.*)\ufffd/);
        if (invalidCharacter) throw new Error(this.lineMsg() + "invalid character. (ChoiceScript text should be saved in the UTF-8 encoding.) " + invalidCharacter[0]);
        var result = /^(\s*)\*(\w+)(.*)/.exec(line);
        if (!result) continue;
        var indentation = result[1];
        var indent = indentation.length;
        var command = result[2].toLowerCase();
        var data = trim(result[3]);
        if ("label" == command) {
            data = data.toLowerCase();
            if (/\s/.test(data)) throw new Error(this.lineMsg() + "label '"+data+"' is not allowed to contain spaces");
            if (this.labels.hasOwnProperty(data)) {
              throw new Error(this.lineMsg() + "label '"+data+"' already defined on line " + (this.labels[data]*1+1));
            }
            this.labels[data] = this.lineNum;
        } else if (screenshots) {
          if ("fake_choice" == command) {
            if (seenChoiceWithoutSet) throw new Error(this.lineMsg() +
              "In choicescript_screenshots, you need to *set at least one variable between *fake_choice commands, so the stat screen looks interesting. " +
              "There was no *set since the last *fake_choice on line " + seenChoiceWithoutSet + ".");
            seenChoiceWithoutSet = this.lineNum+1;
          } else if ("set" == command) {
            seenChoiceWithoutSet = 0;
          }
        }
    }
    this.rollbackLineCoverage();
    this.lineNum = oldLineNum;
};

// if this is a command line, run it
Scene.prototype.runCommand = function runCommand(line) {
    var result = /^\s*\*(\w+)(.*)/.exec(line);
    if (!result) {
      if (this.secondaryMode == "startup" && this.startupCallback) {
        this.finished = true;
        this.skipFooter = true;
        this.startupCallback();
        return true;
      }
      return false;
    }
    var command = result[1].toLowerCase();
    var data = trim(result[2]);
    if (Scene.validCommands[command]) {
        if ("comment" == command) return true;
        if (Scene.initialCommands[command]) {
          if ("startup" != String(this.name).toLowerCase() || !this.initialCommands) {
            throw new Error(this.lineMsg() + "Invalid "+command+" instruction, only allowed at the top of startup.txt");
          }
        } else {
          if (this.secondaryMode == "startup" && this.startupCallback) {
            this.finished = true;
            this.skipFooter = true;
            this.startupCallback();
            return true;
          }
          // if we're here, we're running a non-initial command
          // except, *bug choice_beta can appear in the initial commands
          if (command !== 'bug') this.initialCommands = false;
        }
        if (command == "choice" && String(this.name).toLowerCase() == "choicescript_screenshots") {
          throw new Error(this.lineMsg() + "choicescript_screenshots files should only contain *fake_choice commands, not real *choice commands");
        }
        this[command](data);
    } else {
        throw new Error(this.lineMsg() + "Non-existent command '"+command+"'");
    }
    return true;
};

// *choice [group1] [group2] ...
// prompt the user with a multiple choice question.
// nested lines are options to be presented to the user
//
// Examples:
// *choice
//    good
//      Good choice
//      *finish
//    bad
//      Bad choice
//      *finish
//
// *choice toy
//    spaceship
//      Nice spaceship
//      *finish
//    train
//      Nice train
//      *finish
//    doll
//      Nice doll
//      *finish
//
// *choice color toy
//    red
//      spaceship
//        Nice red spaceship
//        *finish
//      train
//        Nice red train
//        *finish
//    blue
//       spaceship
//         Nice blue spaceship
//        *finish
//       train
//         Nice red train
//        *finish

// If a group is specified, generate a prompt message, e.g. "*choice toy" -> "Select a toy:"
// If no group is specified, don't generate a prompt message
// if multiple groups are specified, allow the user to make multiple choices simultaneously
//   all multi-dimensional choices must be valid (otherwise throw a parse error)
Scene.prototype.choice = function choice(data) {
    var startLineNum = this.lineNum;
    var groups = data.split(/ /);
    for (var i = 0; i < groups.length; i++) {
      if (!/^\w*$/.test(groups[i])) {
        throw new Error(this.lineMsg() + "invalid choice group name: " + groups[i]);
      }
    }
    var options = this.parseOptions(this.indent, groups);
    var self = this;
    this.renderOptions(groups, options, function(option) {
      self.standardResolution(option);
    });
    this.finished = true;
    if (this.temps._fakeChoiceDepth > 0 || this.getVar("implicit_control_flow")) {
      if (!this.temps._choiceEnds) {
        this.temps._choiceEnds = {};
      }
      for (i = 0; i < options.length; i++) {
        this.temps._choiceEnds[options[i].line-1] = this.lineNum;
      }
    }
    this.lineNum = startLineNum;
};

Scene.prototype.fake_choice = function fake_choice(data) {
    if (this.temps._fakeChoiceDepth === undefined) {
        this.temps._fakeChoiceDepth = 0;
    }
    this.temps._fakeChoiceDepth++;
    this.choice(data);
};

Scene.prototype.standardResolution = function(option) {
  var self = this;
  self.lineNum = option.line;
  self.indent = self.getIndent(self.nextNonBlankLine(true/*includingThisOne*/));
  if (option.reuse && option.reuse != "allow") self.temps.choice_used[option.line-1] = 1;
  if (this.nav) this.nav.bugLog.push("#"+(option.line+1) + " " + option.name);

  self.finished = false;
  self.resetPage();
};

Scene.prototype.nextNonBlankLine = function nextNonBlankLine(includingThisOne) {
    var line;
    var i = this.lineNum;
    if (!includingThisOne) i++;
    while(isDefined(line = this.lines[i]) && !trim(line)) {
      i++;
    }
    return line;
};

Scene.prototype.previousNonBlankLineNum = function previousNonBlankLineNum() {
  var line;
  var i = this.lineNum - 1;
  while(isDefined(line = this.lines[i]) && !trim(line)) {
    i--;
  }
  return i;
};


Scene.prototype.resetCheckedPurchases = function resetCheckedPurchases() {
  for (var temp in this.temps) {
    if (/^choice_purchased/.test(temp)) {
      delete this.temps[temp];
    }
  }
};

// reset the page and invoke code after clearing the screen
Scene.prototype.resetPage = function resetPage() {
    var self = this;
    this.resetCheckedPurchases();
    clearScreen(function() {
      // save in the background, eventually
      self.save("");
      self.prevLine = "empty";
      self.screenEmpty = true;
      self.execute();
    });
};

/* The function needs some explaining.
We want the game to be "refreshable," e.g. on the web.
So we only make a "real" autosave as you click "Next"
But if we do it that way, when we visit the stat screen, it's out of date
So we make a "temp" autosave slot, right as the page finishes redrawing,
and the stat screen uses the "temp" autosave to display your current data.
When you refresh the page, the "temp" autosave is rewritten.

If you save stats on the stat screen, they're written into tempStatWrites;
when the stat screen saves, we transfer tempStatWrites back to the main
game (if the main game is running in a separate iframe, e.g. iOS).

If the main game is about to write the main "" slot, we merge the temp
stat writes into the main stats (and clear the stat writes) before
saving.

Thus, stat changes on the stat screen will only be permanently saved when
the player clicks "Next" in the main game, ensuring that the game is still
refreshable.
*/
Scene.prototype.save = function save(slot) {
    if (this.saveSlot) {
      transferTempStatWrites();
    } else {
      if (!slot) {
        slot = "";
        for (var key in tempStatWrites) {
          if (tempStatWrites.hasOwnProperty(key)) {
            this.stats[key] = tempStatWrites[key];
          }
        }
        tempStatWrites = {};
      }

      saveCookie(function() {}, slot, this.stats, this.temps, this.lineNum, this.indent);
    }
};

// *goto labelName
// Go to the line labeled with the label command *label labelName
//
// goto by reference
//   *create foo "labelName"
//   *goto {foo}
Scene.prototype["goto"] = function scene_goto(line) {
    var label;
    if (/[\[\{]/.test(line)) {
      label = this.evaluateReference(this.tokenizeExpr(line));
    } else {
      label = String(line).toLowerCase();
    }
    if (typeof(this.labels[label]) != "undefined") {
        this.lineNum = this.labels[label];
        this.indent = this.getIndent(this.lines[this.lineNum]);
    } else {
        throw new Error(this.lineMsg() + "bad label " + label);
    }
    if (!this.localCoverage) this.localCoverage = {};
    if (this.localCoverage[this.lineNum]) {
        this.localCoverage[this.lineNum]++;
        if (this.temps._looplimit && this.localCoverage[this.lineNum] > this.temps._looplimit) {
            throw new Error(this.lineMsg() + "visited this line too many times (" + this.temps._looplimit + ")");
        }
    } else {
        this.localCoverage[this.lineNum] = 1;
    }
};

Scene.prototype.gosub = function scene_gosub(data) {
    var label = /\S+/.exec(data)[0];
    var rest = data.substring(label.length+1);
    var args = [];
    var stack = this.tokenizeExpr(rest);
    while (stack.length) {
      args.push(this.evaluateValueToken(stack.shift(), stack));
    }
    if (!this.temps.choice_substack) {
      this.temps.choice_substack = [];
    }
    this.temps.choice_substack.push({lineNum: this.lineNum, indent: this.indent});
    // Works exactly the same as gosub_scene, putting args in this.temps.param.
    // This means there's no notion of scope - param acts more like "registers" that
    // get clobbered the next time a sub is called.
    // This may be more intuitive to non-programmers than idea of scope?  Especially
    // if temp normally doesn't follow scoping rules.  gosub_scene can serve this function anyway.
    // The params can be retrieved and put in named temps with "params" command.
    this.temps.param = args;
    this["goto"](label);
};

Scene.prototype.gosub_scene = function scene_gosub_scene(data) {
    if (!this.stats.choice_subscene_stack) {
      this.stats.choice_subscene_stack = [];
    }
    this.stats.choice_subscene_stack.push({name:this.name, lineNum: this.lineNum + 1, indent: this.indent, temps: this.temps});
    this.goto_scene(data, true /*isGosubScene*/);
};

Scene.prototype.params = function scene_params(data) {
    // Name the parameters passed by gosub/gosub_scene.
    // Rules should be the same as for "create."
    // All parameters, even those not named, exposed as param_1, param_2 etc.
    var words = /\w+/.exec(data);
    var nextParamNum = 1;
    this.temps.param_count = this.temps.param.length;
    while (words) {
        var varName = words[0].toLowerCase();
        this.validateVariable(varName);
        if (this.temps.param.length < 1) {
            throw new Error(this.lineMsg() + "No parameter passed for " + varName);
        }
        var paramVal = this.temps.param.shift();
        this.temps[varName] = paramVal;
        this.temps["param_" + nextParamNum] = paramVal;
        nextParamNum++;
        data = data.substring(varName.length+1);
        words = /\w+/.exec(data);
    }
    // All remaining params are anonymous, but you still have to say "params"
    // if you want any of them.
    while (this.temps.param.length > 0) {
        var paramVal = this.temps.param.shift();
        this.temps["param_" + nextParamNum] = paramVal;
        nextParamNum++;
    }
};

Scene.prototype["return"] = function scene_return() {
    var stackFrame;
    if (this.temps.choice_substack && this.temps.choice_substack.length) {
      stackFrame = this.temps.choice_substack.pop();
      this.lineNum = stackFrame.lineNum;
      this.indent = stackFrame.indent;
    } else if (this.stats.choice_subscene_stack && this.stats.choice_subscene_stack.length) {
      stackFrame = this.stats.choice_subscene_stack.pop();
      if (stackFrame.name == this.name) {
        this.temps = stackFrame.temps;
        this.lineNum = stackFrame.lineNum-1;
        this.indent = stackFrame.indent;
        return;
      }
      this.finished = true;
      this.skipFooter = true;
      var scene = new Scene(stackFrame.name, this.stats, this.nav, {debugMode:this.debugMode, secondaryMode:this.secondaryMode, saveSlot:this.saveSlot});
      scene.temps = stackFrame.temps;
      scene.screenEmpty = this.screenEmpty;
      scene.prevLine = this.prevLine;
      scene.lineNum = stackFrame.lineNum;
      scene.indent = stackFrame.indent;
      scene.accumulatedParagraph = this.accumulatedParagraph;
      if (this.randomtest) {
        // pop the stack in randomtest to avoid overflow
        clearScreen(function() {scene.execute()});
      } else {
        scene.execute();
      }
    } else if (!this.temps.choice_substack && !this.stats.choice_subscene_stack) {
      throw new Error(this.lineMsg() + "invalid return; gosub has not yet been called");
    } else {
      throw new Error(this.lineMsg() + "invalid return; we've already returned from the last gosub");
    }

};

// *gotoref expression
// Go to the label identified by the expression
//
// *temp foo
// *set foo "bar"
// *gotoref foo
// Skipped!
// *label bar
Scene.prototype["gotoref"] = function scene_gotoref(expression) {
    var stack = this.tokenizeExpr(expression);
    var value = this.evaluateExpr(stack);
    this["goto"](value);
};


// *finish
// halt the scene
Scene.prototype.finish = function finish(buttonName) {
    this.paragraph();
    this.finished = true;
    var self = this;
    if (this.secondaryMode == "stats") {
      if (typeof window == "undefined") return;
      // In iPad app, the stats screen is always visible
      if (window.isIosApp && window.isIPad) return;

      if (this.screenEmpty) {
        returnFromStats();
        return;
      }
      if (!buttonName) buttonName = "Next";
      buttonName = this.replaceVariables(buttonName);
      printButton(buttonName, main, false,
        function() {
          returnFromStats();
        }
      );
      return;
    }
    var nextSceneName = this.nav && nav.nextSceneName(this.name);
    // if there are no more scenes, then just halt
    if (!nextSceneName) {
        if (!this.secondaryMode) this.ending();
        return;
    }
    if (this.screenEmpty) {
      this.goto_scene(nextSceneName);
      return;
    }
    if (!buttonName) buttonName = "Next Chapter";
    buttonName = this.replaceVariables(buttonName);


    printButton(buttonName, main, false,
      function() {
        safeCall(self, function() {
            var scene = new Scene(nextSceneName, self.stats, self.nav, {debugMode:self.debugMode, secondaryMode:self.secondaryMode});
            scene.resetPage();
        });
      }
    );
    if (this.debugMode) println(computeCookie(this.stats, this.temps, this.lineNum, this.indent));
};

Scene.prototype.autofinish = function autofinish(buttonName) {
  this.finish(buttonName);
};

// *reset
// clear all stats
Scene.prototype.reset = function reset() {
    this.nav.resetStats(this.stats);
    this.stats.scene = this;
};

Scene.prototype.parseGotoScene = function parseGotoScene(data) {
  var sceneName, label, param = [], stack;

  if (/[\[\{]/.test(data)) {
    stack = this.tokenizeExpr(data);
    sceneName = this.evaluateReference(stack, {toLowerCase: false});
    // Labels are required for arguments to avoid ambiguity
    if (stack.length) {
      label = this.evaluateReference(stack);
    }
    while (stack.length) {
      // Arguments when treating gosub_scene like a function call
      param.push(this.evaluateValueToken(stack.shift(), stack));
    }
  } else {
    // scenes and labels can contain hyphens and other non-expression punctuation
    // so we'll try to extract the first two words as the scene and label
    var match = /(\S+)\s+(\S+)\s*(.*)/.exec(data);
    if (match) {
      sceneName = match[1];
      label = match[2];
      stack = this.tokenizeExpr(match[3]);
      while (stack.length) {
        // Arguments when treating gosub_scene like a function call
        param.push(this.evaluateValueToken(stack.shift(), stack));
      }
    } else {
      if (data === "") throw new Error(this.lineMsg() + "missing scene name");
      sceneName = data;
    }
  }
  return {sceneName:sceneName, label:label, param:param};
};

// *goto_scene foo
//
Scene.prototype.goto_scene = function gotoScene(data, isGosubScene) {
    if (!isGosubScene && (this.stats.choice_subscene_stack || []).length) {
      var stackFrame = this.stats.choice_subscene_stack.pop();
      this.warning("You should *return before *goto_scene after *gosub_scene from from " + stackFrame.name + " line " + stackFrame.lineNum);
      delete this.stats.choice_subscene_stack;
    }
    var result = this.parseGotoScene(data);

    if (result.sceneName == this.name) {
      if (typeof result.label === "undefined") {
        this.lineNum = -1; // the printLoop will increment the line number to 0
      } else {
        this["goto"](result.label);
      }
      this.temps = {choice_reuse:"allow", choice_user_restored:false, _choiceEnds:{}};
      this.temps.param = result.param;
      this.initialCommands = true;
      return;
    }

    this.finished = true;
    this.skipFooter = true;
    var scene = new Scene(result.sceneName, this.stats, this.nav, {debugMode:this.debugMode, secondaryMode:this.secondaryMode, saveSlot:this.saveSlot});
    scene.screenEmpty = this.screenEmpty;
    scene.prevLine = this.prevLine;
    scene.accumulatedParagraph = this.accumulatedParagraph;
    if (typeof result.label != "undefined") scene.targetLabel = {label:result.label, origin:this.name, originLine:this.lineNum};
    if (typeof result.param != "undefined") scene.temps.param = result.param;
    if (this.redirectingFromStats) scene.redirectingFromStats = true;
    scene.execute();
};

// *redirect_scene foo
Scene.prototype.redirect_scene = function redirectScene(data) {
  if (this.secondaryMode != "stats") throw new Error(this.lineMsg() + "The *redirect_scene command can only be used from the stats screen.");
  var result = this.parseGotoScene(data);
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  redirectFromStats(result.sceneName, result.label, this.lineNum, function() {
    delete self.secondaryMode;
    delete self.saveSlot;
    self.redirectingFromStats = true;
    self.goto_scene(data);
  });
};

Scene.prototype.product = function product(productId) {
  if (!/^[a-z]+$/.test(productId)) throw new Error(this.lineMsg()+"Invalid product id (only lowercase letters, no numbers or punctuation): " +productId);
  if (this.nav) this.nav.products[productId] = {};
}

Scene.prototype.restore_purchases = function scene_restorePurchases(data) {
  var self = this;
  var target = this.target;
  if (!target) target = document.getElementById('text');
  var button = printButton("Restore Purchases", target, false,
    function() {
      safeCall(self, function() {
          restorePurchases(null, function() {
            self["goto"](data);
            self.finished = false;
            self.resetPage();
          });
      });
    }
  );

  setClass(button, "");
  this.prevLine = "block";
};

Scene.prototype.check_purchase = function scene_checkPurchase(data) {
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  var productList = data.split(/ /);
  for (var i = 0; i < productList.length; i++) {
    var product = productList[i];
    if (!this.nav.products[product] && product != "adfree") {
      throw new Error(this.lineMsg() + "The product " + product + " wasn't declared in a *product command");
    }
  }
  checkPurchase(data, function(ok, result) {
    self.finished = false;
    self.skipFooter = false;
    if (!ok) {
      result = {billingSupported:true};
      self.temps.choice_purchase_error = true;
    }
    result = result || {};
    var products = data.split(/ /);
    var everything = true;
    for (var i = 0; i < products.length; i++) {
      var purchasedProduct = result[products[i]] || false;
      self.temps["choice_purchased_"+products[i]] = purchasedProduct;
      if (!purchasedProduct) everything = false;
    }
    self.temps.choice_purchased_everything = everything;
    self.temps.choice_purchase_supported = !!result.billingSupported;
    self.execute();
  });
};

Scene.prototype.parsePurchase = function parsePurchase(data) {
  var result;
  if (/^\{/.test(data)) {
    try {
      result = JSON.parse(data);
    } catch (e) {
      throw new Error(this.lineMsg() + "Couldn't parse purchase JSON: " + e)
    }
    if (!result.product) {
      throw new Error(this.lineMsg() + "JSON missing product");
    }
    if (!result['goto']) {
      throw new Error(this.lineMsg() + "JSON missing goto");
    }
    if (result.priceGuess && result.discount) {
      throw new Error(this.lineMsg() + "JSON has both top-level priceGuess and discount; there should be one or the other");
    }
    if (!(result.priceGuess || result.discount)) {
      throw new Error(this.lineMsg() + "JSON has neither top-level priceGuess nor discount; there should be one or the other");
    }
    if (result.discount) {
      if (!result.discount.end) throw new Error(this.lineMsg() + "JSON discount doesn't include end");
      result.discount.end = parseDateStringInCurrentTimezone(result.discount.end, this.lineNum + 1);
      if (!result.discount.lowPrice) throw new Error(this.lineMsg() + "JSON discount doesn't include lowPrice");
      if (!/^\$/.test(result.discount.lowPrice)) throw new Error(this.lineMsg() + "lowPrice " + fullPriceGuess + "doesn't start with dollar");
      if (!result.discount.fullPrice) throw new Error(this.lineMsg() + "JSON discount doesn't include fullPrice");
      if (!/^\$/.test(result.discount.fullPrice)) throw new Error(this.lineMsg() + "fullPrice " + fullPriceGuess + "doesn't start with dollar");
    }
    if (!result.title) result.title = "It";
  } else {
    var parsed = /^(\w+)\s+(\S+)\s+(.*)/.exec(data);
    if (!parsed) throw new Error(this.lineMsg() + "invalid line; can't parse purchaseable product: " + data);
    result = {product: parsed[1], priceGuess: parsed[2], "goto": parsed[3], title: "It"};
  }
  return result;
}

Scene.prototype.purchase = function purchase(data) {
  var parsed = this.parsePurchase(data);
  if (parsed.discount) {
    this.buyButtonDiscount(parsed.product, parsed.discount.end, parsed.discount.fullPrice, parsed.discount.lowPrice, parsed['goto'], parsed.title);
  } else {
    this.buyButton(parsed.product, parsed.priceGuess, parsed['goto'], parsed.title);
  }
}

Scene.prototype.buyButton = function(product, priceGuess, label, title) {
  if (label && typeof this.temps["choice_purchased_" + product] === "undefined") {
    throw new Error(this.lineMsg() + "Didn't check_purchases on this page");
  }
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  var purchaseFinished = function() {
    if (label) self["goto"](label);
    self.finished = false;
    self.skipFooter = false;
    self.resetPage();
  }
  getPrice(product, function (price) {
    if (!price || "free" == price) {
      purchaseFinished();
    } else {
      if (price == "guess") price = priceGuess + " USD";
      var prerelease = self.getVar('choice_prerelease');
      var buttonText;
      if (prerelease) {
        buttonText = "Pre-Order " + title;
      } else {
        buttonText = "Buy "+title+" Now";
      }
      if (price != "hide") {
        buttonText += " for " + price;
      }
      var target = self.target;
      if (!target) target = document.getElementById('text');
      self.paragraph();
      var button = printButton(buttonText, target, false,
        function() {
          safeCall(self, function() {
              purchase(product, function() {
                safeCall(self, purchaseFinished);
              });
          });
        }
      );
      self.prevLine = "block";
      if (isRestorePurchasesSupported()) {
        self.prevLine = "text";
        printLink(printParagraph("If you've already purchased, click here to "), "#", "restore purchases",
          function(e) {
            preventDefault(e);
            safeCall(self, function() {
                restorePurchases(product, function(purchased) {
                  if (purchased) {
                    purchaseFinished();
                  } else {
                    // refresh, in case we're on web showing a full-screen login. Not necessary on mobile? But, meh.
                    clearScreen(function() {loadAndRestoreGame("", window.forcedScene);});
                  }
                });
            });
          }
        );
      }

      if (label) {
        self.skipFooter = false;
        self.finished = false;
        self.execute();
      }
    }
  });
};

Scene.prototype.purchase_discount = function purchase_discount(line) {
  this.paragraph();
  var args = trim(String(line)).split(" ");
  if (args.length != 5) throw new Error(this.lineMsg() + "expected five arguments, saw "+args.length+": " + line);
  var product = args[0];
  var expectedEndDateString = args[1];
  var expectedEndDate = parseDateStringInCurrentTimezone(expectedEndDateString, this.lineNum+1);
  var fullPriceGuess = this.replaceVariables(args[2]);
  var discountedPriceGuess = this.replaceVariables(args[3]);
  var label = args[4];
  var startsWithDollar = /^\$/;
  if (!startsWithDollar.test(fullPriceGuess)) {
    throw new Error(this.lineMsg() + "full price guess "+fullPriceGuess+"doesn't start with dollar: " + line);
  }
  if (!startsWithDollar.test(discountedPriceGuess)) {
    throw new Error(this.lineMsg() + "discounted price guess "+discountedPriceGuess+"doesn't start with dollar: " + line);
  }
  var title = "It";
  this.buyButtonDiscount(product, expectedEndDate, fullPriceGuess, discountedPriceGuess, label, title);
}

Scene.prototype.buyButtonDiscount = function buyButtonDiscount(product, expectedEndDate, fullPriceGuess, discountedPriceGuess, label, title) {
  var prerelease = this.getVar('choice_prerelease');
  var discountText;
  if (prerelease) {
    discountText = "[b]Buy now before the price increases![/b]";
  } else {
    discountText = "[b]On sale until "+shortMonthStrings[expectedEndDate.getMonth()+1]+" "+expectedEndDate.getDate()+"! Buy now before the price increases![/b]"
  }
  if (typeof printDiscount != "undefined") {
    printDiscount(product, expectedEndDate.getYear()+1900, expectedEndDate.getMonth()+1, expectedEndDate.getDate(), discountText);
  }
  var priceGuess;
  if (new Date().getTime() < expectedEndDate.getTime()) {
    priceGuess = discountedPriceGuess;
  } else {
    priceGuess = fullPriceGuess;
  }
  this.buyButton(product, priceGuess, label, title);
}

Scene.prototype.print_discount = function print_Discount(line) {
  var result = /(\w+) (\d{4})-(\d{2})-(\d{2}) (.*$)/.exec(line);
  if (!result) throw new Error("invalid discount: " + line);
  var product = result[1];
  var fullYear = result[2];
  var oneBasedMonthNumber = parseInt(result[3],10);
  var dayOfMonth = parseInt(result[4],10);
  var discountText = result[5];
  this.temps.choice_discount_ends = "POISONTOKEN";
  discountText = this.replaceVariables(discountText).replace("POISONTOKEN", "${choice_discount_ends}");
  delete this.temps.choice_discount_ends;
  if (typeof printDiscount != "undefined") printDiscount(product, fullYear, oneBasedMonthNumber, dayOfMonth, discountText);
};

// *abort
// halt the scene without showing a button
Scene.prototype.abort = function() {
  this.paragraph();
  this.finished = true;
};

// *create
// create a new permanent stat
Scene.prototype.create = function create(line) {
    var result = /^(\w*)(.*)/.exec(line);
    if (!result) throw new Error(this.lineMsg() + "Invalid create instruction, no variable specified: " + line);
    var variable = result[1];
    this.validateVariable(variable);
    variable = variable.toLowerCase();
    var expr = result[2];
    var stack = this.tokenizeExpr(expr);
    if (stack.length > 1) throw new Error(this.lineMsg() + "Invalid create instruction, too many values: " + line);
    this.createVariable(variable, stack[0], line);
}

Scene.prototype.createVariable = function createVariable(variable, token, line) {
  var self = this;
  if (!token) throw new Error(this.lineMsg() + "Invalid create instruction, no value specified: " + line);
  function complexError() {
    throw new Error(self.lineMsg() + "Invalid create instruction, value must be a number, true/false, or a quoted string: " + line);
  }
  if (!/STRING|NUMBER|VAR/.test(token.name)) complexError();
  if ("VAR" == token.name && !/^true|false$/i.test(token.value)) complexError();
  if ("STRING" == token.name && /(\$|@)!?!?{/.test(token.value)) throw new Error(this.lineMsg() + "Invalid create instruction, value must be a simple string without ${} or @{}: " + line);
  var value = this.evaluateExpr([token]);
  if (!this.created) this.created = {};
  if (this.created[variable]) throw new Error(this.lineMsg() + "Invalid create. " + variable + " was previously created on line " + this.created[variable]);
  this.created[variable] = this.lineNum + 1;
  this.stats[variable] = value;
  if (this.nav) this.nav.startingStats[variable] = value;
}

// *create_array {name} {length} {value(s)}
// create an "array" of permanent stats:
//    myarray_1
//    myarray_2
//    ...
//    myarray_count
Scene.prototype.create_array = function create(line) {
  this.defineArray("create", line);
};

// *temp
// create a temporary stat for the current scene
Scene.prototype.temp = function temp(line) {
    var result = /^(\w*)(.*)/.exec(line);
    if (!result) throw new Error(this.lineMsg()+"Invalid temp instruction, no variable specified: " + line);
    var variable = result[1];
    this.validateVariable(variable);
    var expr = result[2];
    var stack = this.tokenizeExpr(expr);
    if (stack.length === 0) {
      this.temps[variable.toLowerCase()] = null;
      return;
    }
    var value = this.evaluateExpr(stack);
    if (typeof this.stats[variable.toLowerCase()] !== 'undefined') {
      this.warning("This is a temp, but we already ran *create " + variable);
    }
    this.temps[variable.toLowerCase()] = value;
};

// *temp_array
// create an "array" of temporary stats for the current scene
Scene.prototype.temp_array = function temp_array(line) {
  this.defineArray("temp", line);
};

Scene.prototype.defineArray = function defineArray(command, line) {
  var result = /^(\w+)(.*)/.exec(line);
  if (!result) throw new Error(this.lineMsg() + "Invalid " + command + "_array instruction, no array name specified: " + line);
  var variable = result[1];
  this.validateVariable(variable);
  variable = variable.toLowerCase();
  var stack = this.tokenizeExpr(result[2].trim());
  if (!stack.length) {
    throw new Error(this.lineMsg() + "Invalid " + command + "_array instruction, missing length: " + line);
  }
  var length = Number(stack.shift().value);
  if (length !== Math.floor(length) || length < 1) {
    throw new Error(this.lineMsg() + "Invalid " + command + "_array instruction, length should be a whole number greater than 0: " + line);
  }

  var token;
  var value = null;
  var self = this;
  var i;
  function create(suffix) {
    if (command === "create") {
      self.createVariable(variable + "_" + suffix, token, line);
    } else {
      self.temps[variable + "_" + suffix] = value;
    }
  }

  function next() {
    token = stack[0];
    if (!token) throw new Error(self.lineMsg() + "Too few values. Expected 1 default value or " + length + " explicit values, not " + i + ": " + line);
    value = self.evaluateValueToken(stack.shift(), stack);
  }

  if (stack.length) next();
  
  if (!stack.length) {
    // Use first default value for all creations
    for (i = 0; i < length; i++) {
      create(i+1);
    }
  } else {
    create(1);
    for (i = 1; i < length; i++) {
      next();
      create(i+1);
    }
  }

  if (stack.length) {
    throw new Error(this.lineMsg() + "Too many values. Expected 1 default value or " + length + " explicit values: " + line);
  }

  token = { name: "NUMBER", value: length };
  value = length;
  create("count");
}

// retrieve the value of the variable, preferring temp scope
Scene.prototype.getVar = function getVar(variable) {
    var value;
    variable = String(variable).toLowerCase();
    if (variable && !isNaN(1*variable) && String(1*variable) === variable) return 1*variable;
    if (variable == "true") return true;
    if (variable == "false") return false;
    if (variable == "choice_subscribe_allowed") return true;
    if (variable == "choice_register_allowed") return isRegisterAllowed();
    if (variable == "choice_registered") return typeof window != "undefined" && !!window.registered;
    if (variable == "choice_is_web") return typeof window != "undefined" && !!window.isWeb;
    if (variable == "choice_is_steam") return typeof window != "undefined" && !!window.isSteamApp;
    if (variable == "choice_is_steam_deck") return typeof window != "undefined" && !!window.isSteamApp && !!window.isSteamDeck;
    if (variable == "choice_is_ios_app") return typeof window != "undefined" && !!window.isIosApp;
    if (variable == "choice_is_ipad_app") return typeof window != "undefined" && !!window.isIosApp && !!window.isIPad;
    if (variable == "choice_is_android_app") return typeof window != "undefined" && !!window.isAndroidApp;
    if (variable == "choice_is_omnibus_app") return typeof window != "undefined" && !!window.isOmnibusApp;
    if (variable == "choice_is_amazon_app") return typeof window != "undefined" && !!window.isAmazonApp;
    if (variable == "choice_is_advertising_supported") return typeof isAdvertisingSupported != "undefined" && !!isAdvertisingSupported();
    if (variable == "choice_is_trial") return !!(typeof isTrial != "undefined" && isTrial);
    if (variable == "choice_release_date") {
      if (typeof window != "undefined" && window.releaseDate) {
        return simpleDateFormat(window.releaseDate);
      }
      return "release day";
    }
    if (variable == "choice_prerelease") return typeof isPrerelease != "undefined" && !!isPrerelease();
    if (variable == "choice_kindle") return typeof isKindle !== "undefined" && !!isKindle;
    if (variable == "choice_randomtest") return !!this.randomtest;
    if (variable == "choice_quicktest") return false; // quicktest will explore "false" paths
    if (variable == "choice_linenum") return this.lineNum;
    if (variable == "choice_scene") return this.name;
    if (variable == "choice_restore_purchases_allowed") return isRestorePurchasesSupported();
    if (variable == "choice_save_allowed") return areSaveSlotsSupported();
    if (variable == "choice_time_stamp") return Math.floor(new Date()/1000);
    if (variable == "choice_nightmode") return typeof isNightMode != "undefined" && isNightMode();
    if (variable == "choice_title") {
      if (typeof this.stats.choice_title === "undefined") {
        throw new Error(this.lineMsg() + "This game is missing a *title command");
      }
    }
    if (variable.startsWith("choice_saved_checkpoint")) {
      return !!this.stats[variable];
    }
    if ((!this.temps.hasOwnProperty(variable))) {
        if ((!this.stats.hasOwnProperty(variable))) {
            if (variable == "implicit_control_flow") return false;
            throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
        }
        value = this.stats[variable];
        if (value === null || value === undefined) {
            throw new Error(this.lineMsg() + "Variable '"+variable+"' exists but has no value");
        }
        if (this.debugMode) println("stats["+ variable + "]==" + value);
        return value;
    }
    value = this.temps[variable];
    if (value === null || value === undefined) {
        throw new Error(this.lineMsg() + "Variable '"+variable+"' exists but has no value");
    }
    if (this.debugMode) println("temps["+ variable + "]==" + value);
    return value;
};

// set the value of the variable, preferring temp scope
Scene.prototype.setVar = function setVar(variable, value) {
    variable = variable.toLowerCase();
    if (this.debugMode) println(variable +"="+ value);
    if ("undefined" === typeof this.temps[variable]) {
        if ("undefined" === typeof this.stats[variable]) {
            throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
        }
        this.stats[variable] = value;
        if (this.saveSlot == "temp") tempStatWrites[variable] = value;
        // Implicit control flow flag is ideally set just once in startup.
        // Removing these lines makes this not possible with quicktest.
        if (variable == "implicit_control_flow" && this.nav) {
            this.nav.startingStats["implicit_control_flow"] = value;
        }
    } else {
        this.temps[variable] = value;
    }
};

// *delete variable
// deletes the named variable
Scene.prototype["delete"] = function scene_delete(variable) {
    variable = variable.toLowerCase();
    if ("undefined" === typeof this.temps[variable]) {
        if ("undefined" === typeof this.stats[variable]) {
            throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
        }
        delete this.stats[variable];
    } else {
        delete this.temps[variable];
    }
};

Scene.prototype["delete_array"] = function scene_delete_array(arrayName) {
  arrayName = arrayName.toLowerCase();
  if ("undefined" === typeof this.temps[arrayName + "_count"]) {
      if ("undefined" === typeof this.stats[arrayName + "_count"]) {
          throw new Error(this.lineMsg() + "Non-existent array '"+arrayName+"'");
      }
      var length = this.stats[arrayName + "_count"];
      delete this.stats[arrayName + "_count"];
      for (var i = 1; i <= length; i++) {
        delete this.stats[arrayName + ("_" + i)];
      }
  } else {
      var length = this.temps[arrayName + "_count"];
      delete this.temps[arrayName + "_count"];
      for (var i = 1; i <= length; i++) {
        delete this.temps[arrayName + ("_" + i)];
      }
  }
};

// during a choice, recursively parse the options
Scene.prototype.parseOptions = function parseOptions(startIndent, choicesRemaining, expectedSubOptions) {
    // nextIndent: the level of indentation after the current line
    // For example, in the color/toy sample above, we start at 0
    // then the nextIndent is 2 for "red"
    // then the nextIndent is 4 for "spaceship"
    var nextIndent = null;
    var options = [];
    var choiceEnds = [];
    var line;
    var currentChoice = choicesRemaining[0];
    if (!currentChoice) currentChoice = "choice";
    var suboptionsEncountered = false;
    var bodyExpected = false;
    var previousSubOptions;
    var namesEncountered = {};
    var atLeastOneSelectableOption = false;
    var prevOption, ifResult;
    var startingLine = this.lineNum;
    var self = this;
    function removeModifierCommand(stripParethentical) {
      if (stripParethentical) {
        var openParen = line.indexOf("(")+1;
        var closingParen = matchBracket(line, "()", openParen);
        if (closingParen == -1) {
          throw new Error(self.lineMsg() + "missing closing parenthesis");
        }
        line = trim(line.substr(closingParen+1));
      } else {
        line = trim(line.replace(/^\s*\*(\w+)(.*)/, "$2"));
      }
      parsed = /^\s*\*(\w+)(.*)/.exec(line);
      if (parsed) {
        command = parsed[1].toLowerCase();
        data = trim(parsed[2]);
      } else {
        command = "";
      }
    }
    while(isDefined(line = this.lines[++this.lineNum])) {
        if (!trim(line)) {
            this.rollbackLineCoverage();
            continue;
        }
        var indent = this.getIndent(line);
        if (nextIndent === null || nextIndent === undefined) {
            // initialize nextIndent with whatever indentation the line turns out to be
            // ...unless it's not indented at all
            if (indent <= startIndent) {
                throw new Error(this.lineMsg() + "invalid indent, expected at least one '" + currentChoice + "'");
            }
            this.indent = nextIndent = indent;
        }
        if (indent <= startIndent) {
            // it's over!
            break;
        }
        if (indent < this.indent) {
            // TODO drift detection
            if (false) /*(indent != nextIndent)*/ {
                // error: indentation has decreased, but not all the way back
                // Example:
                // *choice
                //     red
                //   blue
                throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
            }

            // we must be falling out of a sub-block
            this.dedent(indent);
            this.indent = indent;
        }
        if (indent > this.indent) {
            // body of the choice
            // ...unless we haven't identified our choices yet
            // TODO is this error test valid?
            if (choicesRemaining.length>1) throw new Error(this.lineMsg() + "invalid indent, there were subchoices remaining: [" + choicesRemaining.join(",") + "]");
            this.rollbackLineCoverage();
            bodyExpected = false;
            continue;
        }

        // here's the end of the previous option
        if (options.length) {
          prevOption = options[options.length-1];
          if (!prevOption.endLine) prevOption.endLine = this.lineNum;
        }

        // Execute *if commands (etc.) during option loop
        // sub-commands may modify this.indent
        var parsed = /^\s*\*(\w+)(.*)/.exec(line);
        var unselectable = false;
        var inlineIf = null;
        var selectableIf = null;
        var self = this;

        var overrideDefaultReuseSetting = false;
        var reuse = this.temps.choice_reuse;
        if (parsed) {
            var command = parsed[1].toLowerCase();
            var data = trim(parsed[2]);
            // TODO whitelist commands
            if ("hide_reuse" == command) {
              reuse = "hide";
              overrideDefaultReuseSetting = true;
              removeModifierCommand();
            }
            if ("disable_reuse" == command) {
              reuse = "disable";
              overrideDefaultReuseSetting = true;
              removeModifierCommand();
            }
            if ("allow_reuse" == command) {
              reuse = "allow";
              overrideDefaultReuseSetting = true;
              removeModifierCommand();
            }
            if ("random_weight" == command) {
              removeModifierCommand(true /*stripParenthetical*/);
            }

            if ("print" == command) {
                line = this.evaluateExpr(this.tokenizeExpr(data));
            } else if ("if" == command) {
              choiceEnds.push(this.lineNum);
              ifResult = this.parseOptionIf(data, command);
              if (ifResult) {
                inlineIf = ifResult.condition;
                if (ifResult.result) {
                  line = ifResult.line;
                } else {
                  continue;
                }
              } else {
                this["if"](data, true /*inChoice*/);
                continue;
              }
            } else if ("else" == command) {
              if (data) throw new Error(this.lineMsg() + "Invalid content after *" + command + "; move the #option to the next line, indented: " + data);
              this[command](data, true /*inChoice*/);
              continue;
            } else if (/^(elseif|elsif)$/.test(command)) {
              ifResult = this.parseOptionIf(data, command);
              if (ifResult) {
                throw new Error(this.lineMsg() + "Invalid content after *" + command + "; move the #option to the next line, indented: " + ifResult.line);
              }
              this[command](data, true /*inChoice*/);
              continue;
            } else if ("selectable_if" == command) {
              ifResult = this.parseOptionIf(data, command);
              if (!ifResult) throw new Error(this.lineMsg() + "Couldn't parse the line after *selectable_if: " + data);
              line = ifResult.line;
              selectableIf = ifResult.condition;
              unselectable = unselectable || !ifResult.result;
            } else if ("comment" == command) {
                continue;
            } else if (!command) {
              // command was rewritten by earlier modifier
            } else {
                if (Scene.validCommands[command]) {
                  throw new Error(this.lineMsg() + "Invalid indent? Expected an #option here, not *"+command);
                }  else {
                    throw new Error(this.lineMsg() + "Non-existent command '"+command+"'");
                }
            }
        }

        if ("allow" != reuse) {
          if (!this.temps.choice_used) this.temps.choice_used = {};
          if (this.temps.choice_used[this.lineNum]) {
            if ("hide" == reuse) continue;
            unselectable = true;
          }
        }

        // this line should be a valid option
        if (!/^\s*\#\s*\S/.test(line)) {
            throw new Error(this.lineMsg() + "Expected option starting with #");
        }
        // replace variables here and discard the result, so error messages display the correct line
        this.replaceVariables(line);
        line = trim(trim(line).substring(1));
        var option = {name:line, group:currentChoice};
        if (reuse != "allow") option.reuse = reuse;
        if (this.displayOptionConditions) {
          option.displayIf = [];
          for (var i = 0; i < this.displayOptionConditions.length; i++) {
            option.displayIf[i] = this.displayOptionConditions[i];
          }
          if (inlineIf) option.displayIf.push(inlineIf);
        } else if (inlineIf) {
          option.displayIf = [inlineIf];
        }
        if (selectableIf) {
          option.selectableIf = selectableIf;
        }
        option.line = this.lineNum + 1;
        if (unselectable) {
          option.unselectable = true;
        }
        if (namesEncountered[line]) {
            this.conflictingOptions(this.lineMsg() + "Invalid option; conflicts with option '"+option.name+"' on line " + namesEncountered[line]);
        } else {
            namesEncountered[line] = option.line;
        }
        options.push(option);
        if (choicesRemaining.length>1) {
            // recursive call will modify this.indent
            option.suboptions = this.parseOptions(this.indent, choicesRemaining.slice(1), previousSubOptions);
            // now restore it
            this.indent = nextIndent;
            if (!previousSubOptions) previousSubOptions = option.suboptions;
            suboptionsEncountered = true;
        } else {
            bodyExpected = true;
        }
        if (!unselectable) atLeastOneSelectableOption = true;
    }

    // TODO is this error test valid?
    if (choicesRemaining.length>1 && !suboptionsEncountered) {
        throw new Error(this.lineMsg() + "invalid indent, there were subchoices remaining: [" + choicesRemaining.join(",") + "]");
    }
    if (bodyExpected &&
            (this.temps._fakeChoiceDepth === undefined || this.temps._fakeChoiceDepth < 1)) {
        throw new Error(this.lineMsg() + "Expected choice body");
    }
    if (!atLeastOneSelectableOption) this.conflictingOptions(this.lineMsg() + "No selectable options");
    if (expectedSubOptions) {
        this.verifyOptionsMatch(expectedSubOptions, options);
    }
    this.rollbackLineCoverage();
    prevOption = options[options.length-1];
    this.lineNum = this.previousNonBlankLineNum();
    if (!prevOption.endLine) prevOption.endLine = this.lineNum+1;
    for (i = 0; i < choiceEnds.length; i++) {
        this.temps._choiceEnds[choiceEnds[i]] = this.lineNum;
    }
    this.rollbackLineCoverage();
    return options;
};

// compute *if statement during options
Scene.prototype.parseOptionIf = function parseOptionIf(data) {
  var parsed = /^\s*\((.*)\)\s+(#.*)/.exec(data);
  if (!parsed) {
    return;
  }
  var condition = parsed[1];
  var stack = this.tokenizeExpr(condition);
  var result = this.evaluateExpr(stack);
  if (this.debugMode) println(condition + " :: " + result);
  result = bool(result, this.lineNum+1);
  // In the autotester, all conditionals are enabled
  result = result || this.testPath;
  return {result:result, line:parsed[2], condition:null};
};

// Add this as a separate method so we can override it elsewhere
// We want this error during randomtest but not during autotest
// Because autotest makes impossible situations happen
Scene.prototype.conflictingOptions = function conflictingOptions(str) {
  throw new Error(str);
};

// verify that the current option set corresponds to the previous option set
// (for multichoices)
Scene.prototype.verifyOptionsMatch = function verifyOptionsMatch(prev, current) {
    // find matching option by name
    function findMatch(name, options) {
        for (var i = 0; i < options.length; i++) {
            var option = options[i];
            if (option && name == option.name) {
                return option;
            }
        }
        return null;
    }

    var prevOpt, curOpt;
    for (var i = 0; i < prev.length; i++) {
        prevOpt = prev[i];
        curOpt = findMatch(prevOpt.name, current);
        if (!curOpt) throw new Error(this.lineMsg()+"Missing expected suboption '"+prevOpt.name+"'; all suboptions must have same option list");
    }

    if (prev.length == current.length) return;

    for (i = 0; i < current.length; i++) {
        curOpt = current[i];
        prevOpt = findMatch(curOpt.name, prev);
        if (!prevOpt) throw new Error(this.lineMsg()+"Added unexpected suboption '"+curOpt.name+"'; all suboptions must have same option list");
    }

    throw new Error(this.lineMsg()+"Bug? previous options and current options mismatch, but no particular missing element");
};

// render the prompt and the radio buttons
Scene.prototype.renderOptions = function renderOptions(groups, options, callback) {
    var self = this;
    function replaceVars(options) {
      for (var i = 0; i < options.length; i++) {
        var option = options[i];
        option.name = self.replaceVariables(option.name);
        if (option.suboptions) replaceVars(option.suboptions);
      }
    }
    replaceVars(options);
    this.paragraph();
    printOptions(groups, options, callback);

    if (this.debugMode) println(computeCookie(this.stats, this.temps, this.lineNum, this.indent));

    if (this.finished) printFooter();
};

// *page_break
// pause and prompt the user to press "Next"
Scene.prototype.page_break = function page_break(buttonName) {
    if (this.screenEmpty) return;
    if (!buttonName) buttonName = "Next";
    buttonName = this.replaceVariables(buttonName);
    this.paragraph();
    this.finished = true;

    var self = this;
    printButton(buttonName, main, false,
      function() {
        delayBreakEnd();
        self.finished = false;
        self.resetPage();
      }
    );
    if (this.debugMode) println(computeCookie(this.stats, this.temps, this.lineNum, this.indent));
};

Scene.prototype.page_break_advertisement = function pageBreakAdvertisement(line) {
  if (line) throw new Error(this.lineMsg() + "*page_break_advertisement doesn't allow you to change the button message. This text will never be shown: " + line);
  var self = this;
  this.finished = true;
  showFullScreenAdvertisementButton("Watch an Ad to Continue", function () {
    self.finished = false;
    if (self.screenEmpty) {
      self.skipFooter = false;
      self.resetPage();
    } else {
      self.page_break("");
    }
  }, function () {
    delayBreakEnd();
    self.finished = false;
    self.skipFooter = false;
    self.resetPage();
  });
};

Scene.prototype.finish_advertisement = function finishAdvertisement(line) {
  if (line) throw new Error(this.lineMsg() + "*finish_advertisement doesn't allow you to change the button message. This text will never be shown: " + line);
  var self = this;
  this.finished = true;
  showFullScreenAdvertisementButton("Watch an Ad for the Next Chapter", function () {
    self.finish("");
  }, function () {
    var nextSceneName = self.nav && nav.nextSceneName(self.name);
    var scene = new Scene(nextSceneName, self.stats, self.nav, { debugMode: self.debugMode, secondaryMode: self.secondaryMode });
    scene.resetPage();
  });
};

// *line_break
// single line break in the middle of a paragraph
Scene.prototype.line_break = function line_break() {
    // We want to prevent a huge <p><br></p> between blocks
    // so if there's existing text we'll just toss in a [n/]
    // and if there's no text yet, we'll directly insert a <br>
    if (this.accumulatedParagraph.length) {
      this.accumulatedParagraph.push('[n/]');
    } else {
      println();
    }
};

// *image
// display named image
Scene.prototype.image = function image(data, invert) {
    this.paragraph();
    data = data || "";
    data = this.replaceVariables(data);
    var match = /(\S+) (\S+)(.*)/.exec(data);
    var source, alignment;
    var alt = null;
    if (match) {
      var source = match[1];
      var alignment = match[2];
      var alt = trim(match[3]);
    } else {
      source = data;
    }
    if (source === "") throw new Error(this.lineMsg()+"*image requires the file name of an image");
    alignment = alignment || "center";
    if (!/(right|left|center|none)/.test(alignment)) throw new Error(this.lineMsg()+"Invalid alignment, expected right, left, center, or none: " + data);
    printImage(source, alignment, alt, invert);
    if (this.verifyImage) this.verifyImage(source);
    if (alignment == "none") this.prevLine = "text";
    this.screenEmpty = false;
};

Scene.prototype.text_image = function textImage(data) {
  this.image(data, "invert");
}

// *sound
// play named sound file
Scene.prototype.sound = function sound(source) {
    if (typeof playSound == "function") playSound(source);
    if (this.verifyImage) this.verifyImage(source);
};

Scene.prototype.kindle_image = function kindle_image() {
  // Do nothing on non-Kindle devices; show only on Kindle
};

Scene.prototype.youtube = function youtube(slug) {
  if (typeof printYoutubeFrame !== "undefined") {
    printYoutubeFrame(slug);
    this.prevLine = "block";
    this.screenEmpty = false;
  }
}

Scene.prototype.kindle_search = Scene.prototype.kindle_product = function kindle_search(data) {
  var result = /^\((.+)\) ([^\)]+)/.exec(data);
  if (!result) throw new Error(this.lineMsg()+"Invalid arguments: " + data);
  var query = result[1];
  var buttonName = result[2];
  if ("undefined" != typeof kindleButton) kindleButton(this.target, query, buttonName);
};

// *link
// Display URL with anchor text
Scene.prototype.link = function link(data) {
    var result = /^(\S+)\s*(.*)/.exec(data);
    if (!result) throw new Error(this.lineMsg() + "invalid line; this line should have an URL: " + data);
    var href = result[1].replace(/\]/g, "%5D");
    var anchorText = trim(result[2]) || href;
    this.printLine("[url="+href+"]"+anchorText+"[/url]");
    this.prevLine = "text";
    this.screenEmpty = false;
};

// *link_button
// Display button that takes you to an URL
Scene.prototype.link_button = function linkButton(data) {
    if (typeof window == "undefined") return;
    var result = /^(\S+)\s*(.*)/.exec(data);
    if (!result) throw new Error(this.lineMsg() + "invalid line; this line should have an URL: " + data);
    var href = result[1];
    var anchorText = trim(result[2]) || href;
    this.paragraph();
    var target = this.target;
    if (!target) target = document.getElementById('text');
    printButton(anchorText, target, false, function() {
      window.location.href = href;
    });
    this.prevLine = "empty";
    this.screenEmpty = false;
};

// how many spaces is this line indented?
Scene.prototype.getIndent = function getIndent(line) {
    if (line === null || line === undefined) return 0;
    var spaces = line.match(/^(\s*)/);
    if (spaces === null || spaces === undefined) return 0;
    if (/[^ \t]/.test(spaces[1])) {
      throw new Error(this.lineMsg() + "The indentation on this line includes whitespace that is neither a space nor a tab. Delete the whitespace and replace it with spaces or tabs.");
    }
    var whitespace = spaces[0];
    var len = whitespace.length;
    if (0 === len) return 0;
    var tab = /\t/.test(whitespace);
    var space = / /.test(whitespace);
    if (tab && space) {
        throw new Error(this.lineMsg()+"Tabs and spaces appear on the same line");
    }
    if (tab) {
        this.firstTab = this.lineNum+1;
        if (this.firstSpace) {
            throw new Error(this.lineMsg()+"Illegal mixing of spaces and tabs; this line has a tab, but there were spaces on line " + this.firstSpace);
        }
    } else {
        this.firstSpace = this.lineNum + 1;
        if (this.firstTab) {
            throw new Error(this.lineMsg()+"Illegal mixing of spaces and tabs; this line has a space, but there were tabs on line " + this.firstTab);
        }
    }
    return len;
};

// *comment ignorable text
Scene.prototype.comment = function comment(line) {
    if (this.debugMode) println("*comment " + line);
};

Scene.prototype.advertisement = function advertisement(durationInSeconds) {
  if (/^\s*\*delay_break/.test(this.lines[this.lineNum - 1])) {
    throw new Error(this.lineMsg() + "*advertisement is not allowed immediately after *delay_break (*delay_break includes its own advertisement)");
  }
  if (this.getVar("choice_prerelease") || this.getVar("choice_is_steam")) return;
  var self = this;
  this.finished = true;
  this.skipFooter = true;
  startLoading();
  checkPurchase("adfree", function(ok, result) {
    doneLoading();
    if (result.adfree) {
      self.finished = false;
      self.skipFooter = false;
      self.execute();
      return;
    }
    self.printLine("Come back later to play the next part of [i]${choice_title}[/i]!");
    self.paragraph();
    self.printLine("Or you can buy the game now to skip the wait.");
    self.paragraph();
    self.buyButton("adfree", "$1.99", null, "It");
    self.delay_break(durationInSeconds || 300);
  });
};

// *looplimit 5
// The number of times a given line is allowed to be accessed
Scene.prototype.looplimit = function looplimit(count) {
  this.temps._looplimit = num(count, this.lineNum, this.name);
};

Scene.prototype.hide_reuse = function hide_reuse() {
  this.temps.choice_reuse = "hide";
};

Scene.prototype.disable_reuse = function disable_reuse() {
  this.temps.choice_reuse = "disable";
};

Scene.prototype.allow_reuse = function allow_reuse() {
  this.temps.choice_reuse = "allow";
};

// *label labelName
// Labels a line for use later in *goto
// Do nothing here; these labels are parsed in this.parseLabel
Scene.prototype.label = function label() {};

// *print expr
// print the value of the specified expression
Scene.prototype.print = function scene_print(expr) {
    var value = this.evaluateExpr(this.tokenizeExpr(expr));
    this.prevLine = "text";
    this.screenEmpty = false;
    this.printLine(value);
};

Scene.prototype.parseInputText = function parseInputText(line) {
  var stack = this.tokenizeExpr(line);
  var variable = this.evaluateReference(stack);
  if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
    throw new Error(this.lineMsg() + "Non-existent variable '" + variable + "'");
  }

  var inputOptions = { long: false, allow_blank: false };
  for (var i = 0; i < stack.length; i++) {
    var token = stack[i];
    if (token.name !== "VAR") {
      throw new Error(this.lineMsg() + "Couldn't understand this input_text line");
    }
    var option = token.value;
    if (typeof inputOptions[option] === "undefined") {
      throw new Error(this.lineMsg() + "Couldn't understand this input_text option: " + option);
    }
    inputOptions[option] = true;
  }
  return {variable:variable, inputOptions:inputOptions};
}

// *input_text var
// record text typed by the user and store it in the specified variable
Scene.prototype.input_text = function input_text(line) {
    var result = this.parseInputText(line);
    var variable = result.variable;

    this.finished = true;
    this.paragraph();
    var self = this;
    printInput(this.target, result.inputOptions, function(value) {
      safeCall(self, function() {
        value = trim(String(value));
        value = value.replace(/\n/g, "[n/]");
        if (self.nav) self.nav.bugLog.push("*input_text " + variable + " " + value);
        self.finished = false;
        self.setVar(variable, value);
        self.resetPage();
      });
    });
    if (this.debugMode) println(computeCookie(this.stats, this.temps, this.lineNum, this.indent));
};

// *input_number var min max
// record number typed by the user and store it in the specified variable
Scene.prototype.input_number = function input_number(data) {
    var stack = this.tokenizeExpr(data);
    if (!stack.length) throw new Error(this.lineMsg() + "Invalid input_number statement, expected three args: varname min max");
    var variable = this.evaluateReference(stack);
    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }

    var simpleConstants;
    if (stack.length == 2 && stack[0].name == "NUMBER" && stack[1].name == "NUMBER") {
      simpleConstants = true;
    } else {
      simpleConstants = false;
    }

    if (!stack.length) throw new Error(this.lineMsg() + "Invalid input_number statement, expected three args: varname min max");
    var minimum = this.evaluateValueToken(stack.shift(), stack);
    if (isNaN(minimum*1)) throw new Error(this.lineMsg() + "Invalid minimum, not numeric: " + minimum);
    if (!stack.length) throw new Error(this.lineMsg() + "Invalid input_number statement, expected three args: varname min max");

    var maximum = this.evaluateValueToken(stack.shift(), stack);
    if (stack.length) throw new Error(this.lineMsg() + "Invalid input_number statement, expected three args: varname min max");
    if (isNaN(maximum*1)) throw new Error(this.lineMsg() + "Invalid maximum, not numeric: " + maximum);

    // in quicktest, min and max can get mixed up as the interpreter "cheats" on if statements
    // so quicktest will ignore min/max errors unless they're simple constants e.g. *input_number x 6 4
    var checkMinMax = !this.quicktest || simpleConstants;
    if (checkMinMax && parseFloat(minimum) > parseFloat(maximum)) {
      throw new Error(this.lineMsg() + "Minimum " + minimum+ " should not be greater than maximum " + maximum);
    }

    function isInt(x) {
       var y=parseInt(x,10);
       if (isNaN(y)) return false;
       return x==y && x.toString()==y.toString();
    }
    var intRequired;
    if (isInt(minimum) && isInt(maximum)) {
      intRequired = 1;
    }
    this.finished = true;
    this.paragraph();
    var self = this;
    printInput(this.target, {numeric: true}, function(value) {
      safeCall(self, function() {
        var numValue = parseFloat(""+value);
        if (isNaN(numValue)) {
          asyncAlert("Please type in a number.");
          return;
        }
        if (intRequired && !isInt(value)) {
          asyncAlert("Please type in an integer number.");
          return;
        }
        if (numValue < minimum * 1) {
          asyncAlert("Please use a number greater than or equal to " + minimum);
          return;
        }
        if (numValue > maximum * 1 && !this.quicktest) {
          asyncAlert("Please use a number less than or equal to " + maximum);
          return;
        }
        if (self.nav) self.nav.bugLog.push("*input_number " + variable + " " + value);
        self.finished = false;
        self.setVar(variable, numValue);
        self.resetPage();
      });
    }, minimum, maximum, intRequired);
    if (this.debugMode) println(computeCookie(this.stats, this.temps, this.lineNum, this.indent));
};

// *script code
// evaluate the specified ECMAScript
Scene.prototype.script = function script(code) {
    var stats = this.stats;
    var temps = this.temps;
    try {
      if (typeof window == "undefined") {
        (function() {
          var window = _global;
          eval(code);
        }).call(this);
      } else {
        eval(code);
      }
    } catch (e) {
      throw new Error(this.lineMsg() + "error executing *script: " + e + (e.stack ? "\n" + e.stack : ""));
    }
};

// is this a valid variable name?
Scene.prototype.validateVariable = function validateVariable(variable) {
    if (!variable || !/^[a-zA-Z]/.test(variable)) {
        throw new Error(this.lineMsg()+"Invalid variable name, must start with a letter: " + variable);
    }
    if (!/^\w+$/.test(variable)) {
        throw new Error(this.lineMsg()+"Invalid variable name: '" + variable + "'");
    }
    if (/^(and|or|true|false|scene|scenename)$/i.test(variable)) throw new Error(this.lineMsg()+"Invalid variable name, '" + variable + "' is a reserved word");
    if (/^choice_/.test(variable)) throw new Error(this.lineMsg()+"Invalid variable name, variables may not start with 'choice_'; this is a reserved prefix");
};

// *rand varname min max
// Set varname to a random number from min to max
//
// Example:
// *rand foo 1 6
//   roll a cube die
// *rand foo 1.0 6.0
//   compute a decimal from [1.0,6.0)
Scene.prototype.rand = function rand(data) {
    var stack = this.tokenizeExpr(data);
    if (!stack.length) throw new Error(this.lineMsg() + "Invalid rand statement, expected three args: varname min max");
    var variable = this.evaluateReference(stack);
    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }

    if (!stack.length) throw new Error(this.lineMsg() + "Invalid rand statement, expected three args: varname min max");
    var minimum = this.evaluateValueToken(stack.shift(), stack);
    if (!stack.length) throw new Error(this.lineMsg() + "Invalid rand statement, expected three args: varname min max");
    var maximum = this.evaluateValueToken(stack.shift(), stack);
    if (stack.length) throw new Error(this.lineMsg() + "Invalid rand statement, expected three args: varname min max");
    var diff;

    diff = maximum - minimum;
    if (isNaN(diff)) {
        throw new Error(this.lineMsg() + "Invalid rand statement, min and max must be numbers");
    }
    if (diff < 0) {
        throw new Error(this.lineMsg() + "Invalid rand statement, min must be less than max: " + minimum + " > " + maximum);
    }
    if (diff === 0) {
      this.setVar(variable, minimum);
      return;
    }
    function isInt(x) {
       var y=parseInt(x,10);
       if (isNaN(y)) return false;
       return x==y && x.toString()==y.toString();
    }
    var result;
    var random = Math.random();
    if (isInt(minimum) && isInt(maximum)) {
        // int random
        result = 1*minimum + Math.floor(random*(diff+1));
    } else {
        result = 1*minimum + random*diff;
    }
    this.setVar(variable, result);
    if (this.randomLog) {
      this.randomLog("*rand " + variable + " " + result);
    }
    if (this.nav) this.nav.bugLog.push("*rand " + variable + " " + result);
};

// *set varname expr
// sets the specified varname to the value of the expr
//
// Examples:
//
// literal
//     literal int: 2
//     literal decimal: 2.3
//     boolean value: true
//     quoted string: "fie"
//         with backslash escaping "she said it was \"ironic\"!"  "c:\\foo"
//     variable name: foo
//
// math
//     +: 2+2
//     -: foo-3
//     *: 2*3
//     /: 8/2
//     if one operand is a string, we'll try to parse it as a number, fail if that doesn't work
//
// fairmath
//     %+: foo%+30
//     %-: foo%-20
//
// concatenate
//     &: "foo"&bar
//
// may omit leading operand
//     *set foo +2
//     *set foo %+30
//     *set foo &"blah blah"
//
// spaces optional
//     *set foo+2
//     *set foo bar + 2
//     *set bar% +30
//
// multiple operators in one line, parentheses mandatory
//     *set foo (foo+2)/4
//     *set foo 2+(foo/2)
//     *set foo (foo/2)+(bar/3)
//     *set foo +(bar/3)
//
// set variable by reference
//
//     *set foo bar
//     *set {foo} 3
//     *comment now bar=3
Scene.prototype.set = function set(line) {
    var stack = this.tokenizeExpr(line);
    var variable = this.evaluateReference(stack);
    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }
    if (stack.length === 0) throw new Error(this.lineMsg()+"Invalid set instruction, no expression specified: " + line);
    // if the first token is an operator, then it's implicitly based on the variable
    if (/OPERATOR|FAIRMATH/.test(stack[0].name)) stack.unshift({name:"VAR", value:variable, pos:"(implicit)"});
    var value = this.evaluateExpr(stack);
    this.setVar(variable, value);
};

// *setref variableExpr expr
// just like *set, but variableExpr is a string expression naming a variable reference
//
// Example:
// *set foo "bar"
// *setref foo 3
// *comment now bar=3
Scene.prototype.setref = function setref(line) {
    var stack = this.tokenizeExpr(line);
    var variable = this.evaluateValueToken(stack.shift(), stack);
    variable = String(variable).toLowerCase();

    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }

    // if the first token is an operator, then it's implicitly based on the variable
    if (/OPERATOR|FAIRMATH/.test(stack[0].name)) stack.unshift({name:"VAR", value:variable, pos:"(implicit)"});
    var value = this.evaluateExpr(stack);
    this.setVar(variable, value);
};

Scene.prototype.share_this_game = function share_links(now) {
  now = !!trim(now);
  this.paragraph();
  printShareLinks(this.target, now);
  this.prevLine = "empty"; // printShareLinks provides its own paragraph break
};

Scene.prototype.more_games = function more_games(now) {
  if (typeof window == "undefined" || typeof moreGames == "undefined") return;
  if (!!trim(now)) {
    moreGames();
    return;
  }
  var self = this;
  this.paragraph();
  var target = this.target;
  if (!target) target = document.getElementById('text');
  var button = printButton("Play More Games Like This", target, false,
    function() {
      safeCall(self, moreGames);
    }
  );

  setClass(button, "");
  this.prevLine = "block";
};

Scene.prototype.ending = function ending() {
    if (typeof window == "undefined") return;
    this.paragraph();
    var groups = [""];
    options = [];
    options.push({name:"Play again.", group:"choice", restart:true});
    if (!window.isOmnibusApp) options.push({name:"Play more games like this.", group:"choice", moreGames:true});
    options.push({name:"Share this game with friends.", group:"choice", share:true});
    options.push({name:"Email me when new games are available.", group:"choice", subscribe:true});

    var self = this;
    function endingMenu() {
      printFollowButtons();
      self.renderOptions([""], options, function(option) {
        if (option.restart) {
          return restartGame();
        } else if (option.moreGames) {
          self.more_games("now");
          if (typeof curl != "undefined") curl();
        } else if (option.share) {
          clearScreen(function() {
            self.share_this_game("now");
            endingMenu();
          });
        } else if (option.subscribe) {
          subscribeLink();
        }
      });
    }
    endingMenu();
    this.finished = true;
};

Scene.prototype.restart = function restart() {
  delayBreakEnd();
  if (this.secondaryMode) {
    if (this.secondaryMode == "stats") {
      this.reset();
      this.redirect_scene(this.nav.getStartupScene());
    } else {
      throw new Error(this.lineMsg() + "Cannot *restart in " + this.secondaryMode + " mode");
    }
  } else {
    restartGame();
  }
  this.finished = true;
};

/* Subscribe options, in JSON format.
"now" on mobile means we should immediately mailto: the subscribe address
otherwise, we should display a Subscribe button which launches the mailto:
On non-mailte: platforms, we ignore "now"

"allowContinue" is the default; setting it to false blocks the "No, Thanks"
button and the "Next" button after successfully subscribing
Only Coming Soon pages use "allowContinue"

"message" is the message we'll show to justify subscribing
the default message is: "we'll notify you when our next game is ready!" */
Scene.prototype.subscribe = function scene_subscribe(data) {
  this.paragraph();
  var options = {};
  if (data) {
    try {
      options = JSON.parse(data);
    } catch (e) {
      throw new Error(this.lineMsg() + "Couldn't parse subscribe arguments: " + data);
    }
  }
  this.prevLine = "block";
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  subscribe(this.target, options, function(now) {
    self.finished = false;
    // if "now" actually worked, then continue the scene
    // otherwise, reset the page before continuing
    if (now) {
      self.skipFooter = false;
      self.execute();
    } else {
      self.resetPage();
    }
  });
};

Scene.prototype.restore_game = function restore_game(data) {
  var cancelLabel;
  if (data) {
    var result = /^cancel=(\S+)$/.exec(data);
    if (!result) throw new Error(this.lineMsg() + "invalid restore_game line: " + data);
    cancelLabel = result[1];
  }
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  var daysToUndelete = 30;
  var unrestorableScenes = this.parseRestoreGame(false/*alreadyFinished*/);
  function renderRestoreMenu(saveList, dirtySaveList) {
    var recentlyDeletedCount = 0;
    self.paragraph();
    var options = [];
    for (var i = 0; i < saveList.length; i++) {
      var save = saveList[i];
      var date = new Date(save.timestamp*1);
      if (!save) continue;
      var name = "";
      if (save.temps && save.temps.choice_restore_name) name = save.temps.choice_restore_name;
      if (save.deleted) {
        if (!save.undeleted || save.undeleted < save.deleted) {
          if ((Date.now() - save.deleted) < daysToUndelete * 1000 * 60 * 60 * 24) {
            recentlyDeletedCount++;
          }
          continue;
        }
      }
      options.push({name:name + " ("+simpleDateTimeFormat(date)+")", group:"choice", state:save});
    }
    var anythingToDelete = options.length > 0;
    if (false) options.push({name:"Restore using a password.", group:"choice", password:true});
    options.push({name:"Retrieve saved games online from choiceofgames.com.", group:"choice", fetch:true});
    if (anythingToDelete) options.push({ name: "Delete saves.", group: "choice", deleting: true });
    if (recentlyDeletedCount) {
      var recentlyDeletedMessage;
      if (recentlyDeletedCount === 1) {
        recentlyDeletedMessage = "1 save recently deleted."
      } else {
        recentlyDeletedMessage = recentlyDeletedCount + " saves recently deleted."
      }
      options.push({ name: "Undelete saves. (" + recentlyDeletedMessage + ")", group: "choice", undeleting: true });
    }
    if (dirtySaveList.length) options.push({name:"Upload saved games to choiceofgames.com.", group:"choice", upload:true});
    options.push({name:"Cancel.", group:"choice", cancel:true});
    var groups = [""];
    self.renderOptions(groups, options, function(option) {
      function synchronizeBeforeEdit(renderMenu) {
        clearScreen(function () {
          fetchEmail(function (defaultEmail) {
            self.printLine("Please type your email address to identify yourself.");
            self.paragraph();
            promptEmailAddress(this.target, defaultEmail, "allowContinue", function (cancel, email) {
              if (cancel) {
                self.finished = false;
                if (typeof cancelLabel !== "undefined") {
                  self["goto"](cancelLabel);
                }
                self.resetPage();
                return;
              }
              clearScreen(function () {
                startLoading();
                getRemoteSaves(email, function (remoteSaveList) {
                  doneLoading();
                  self.prevLine = "text";
                  if (!remoteSaveList) {
                    self.printLine("Error downloading saves. Please try again later.");
                    renderRestoreMenu(saveList, dirtySaveList);
                  } else {
                    mergeRemoteSaves(remoteSaveList, "recordDirty", function (saveList, newRemoteSaves, dirtySaveList) {
                      if (dirtySaveList && dirtySaveList.length) {
                        submitDirtySaves(dirtySaveList, email, function (ok) {
                          if (ok) {
                            renderMenu(email);
                          } else {
                            self.printLine("Error downloading saves. Please try again later.");
                            renderRestoreMenu(saveList, dirtySaveList);
                          }
                        });
                      } else {
                        renderMenu(email);
                      }
                    });
                  }
                });
              });
            });
          });
        });
      }


      if (option.upload) {
        clearScreen(function() {
          fetchEmail(function(defaultEmail){
            self.printLine("Please type your email address to identify yourself.");
            self.paragraph();
            promptEmailAddress(this.target, defaultEmail, "allowContinue", function(cancel, email) {
              if (cancel) {
                self.finished = false;
                if (typeof cancelLabel !== "undefined") {
                  self["goto"](cancelLabel);
                }
                self.resetPage();
                return;
              }
              clearScreen(function() {
                startLoading();
                submitDirtySaves(dirtySaveList, email, function(ok) {
                  doneLoading();
                  self.prevLine = "text"; // Put some space between the message and the option list
                  if (!ok) {
                    self.printLine("Error uploading saves. Please try again later.");
                    renderRestoreMenu(saveList, dirtySaveList);
                  } else {
                    var count = dirtySaveList.length + (dirtySaveList.length == 1 ? " save" : " saves");
                    self.printLine("Uploaded " + count + ".");
                    renderRestoreMenu(saveList, []);
                  }
                });
              });
            });
          });
        });
      } else if (option.fetch) {
        clearScreen(function() {
          fetchEmail(function(defaultEmail){
            self.printLine("Please type your email address to identify yourself.");
            self.paragraph();
            promptEmailAddress(this.target, defaultEmail, "allowContinue", function(cancel, email) {
              if (cancel) {
                self.finished = false;
                if (typeof cancelLabel !== "undefined") {
                  self["goto"](cancelLabel);
                }
                self.resetPage();
                return;
              }
              clearScreen(function() {
                startLoading();
                getRemoteSaves(email, function (remoteSaveList) {
                  doneLoading();
                  self.prevLine = "text";
                  if (!remoteSaveList) {
                    self.printLine("Error downloading saves. Please try again later.");
                    renderRestoreMenu(saveList, dirtySaveList);
                  } else {
                    mergeRemoteSaves(remoteSaveList, "recordDirty", function(saveList, newRemoteSaves, dirtySaveList) {
                      if (!remoteSaveList.length) {
                        self.printLine("No saves downloaded for email address \""+email+"\". (Is that the correct email address?) If you're having trouble, please contact support at "+getSupportEmail()+".");
                        renderRestoreMenu(saveList, dirtySaveList);
                      } else {
                        var downloadCount = remoteSaveList.length + " saved " + (remoteSaveList.length == 1 ? "game" : "games");
                        var newCount = newRemoteSaves + " new saved " + (newRemoteSaves == 1 ? "game" : "games");
                        self.printLine("Synchronized " + downloadCount + ". Downloaded " + newCount + ".");
                        renderRestoreMenu(saveList, dirtySaveList);
                      }
                    });
                  }
                });
              });
            });
          });
        });
      } else if (option.deleting) {
        synchronizeBeforeEdit(function renderDeleteMenu(email) {
          var options = [];
          for (var i = 0; i < saveList.length; i++) {
            var save = saveList[i];
            var date = new Date(save.timestamp * 1);
            if (!save) continue;
            if (save.deleted) {
              if (!save.undeleted || save.undeleted < save.deleted) {
                continue;
              }
            }
            var name = "";
            if (save.temps && save.temps.choice_restore_name) name = save.temps.choice_restore_name;
            options.push({ name: name + " (" + simpleDateTimeFormat(date) + ")", group: "choice", state: save });
          }
          if (!options.length) {
            self.printLine("There are no saves to delete.");
            renderRestoreMenu(saveList, dirtySaveList);
            return;
          }
          function submitButtonNameFunction(count) {
            if (count == 1) {
              return "Delete 1 Save";
            } else {
              return "Delete " + count + " Saves";
            }
          }
          printCheckboxes(options, submitButtonNameFunction, function (results) {
            startLoading();
            var deletionDate = Date.now();
            clearScreen(function () {
              Promise.all(results.map(function (result, i) {
                if (result) {
                  return new Promise(function (resolve, reject) {
                    var save = options[i].state;
                    var slot = "save" + save.timestamp;
                    var oldDeleted = save.deleted;
                    save.deleted = deletionDate;
                    var value = computeCookie(save.stats, save.temps, save.lineNum, save.indent, save.deleted, save.undeleted);
                    writeCookie(value, slot, function(ok) {
                      submitRemoteSave(slot, email, !"subscribe", function (ok) {
                        if (ok) {
                          resolve();
                        } else {
                          save.deleted = oldDeleted;
                          var value = computeCookie(save.stats, save.temps, save.lineNum, save.indent, save.deleted, save.undeleted);
                          writeCookie(value, slot, function () {});
                          reject(new Error("Failed submitting " + slot));
                        }
                      })
                    })
                  });
                }
              })).then(function () {
                doneLoading();
                renderRestoreMenu(saveList, dirtySaveList);
              }).catch(function(err) {
                self.printLine("There was an error deleting saves. Please try again later.");
                renderRestoreMenu(saveList, dirtySaveList);
              });
            });
          });
          printFooter();
        });
      } else if (option.undeleting) {
        synchronizeBeforeEdit(function renderUndeleteMenu(email) {
          var options = [];
          for (var i = 0; i < saveList.length; i++) {
            var save = saveList[i];
            var date = new Date(save.timestamp * 1);
            if (!save) continue;
            if (!save.deleted || save.deleted < save.undeleted) {
              continue;
            }
            var name = "";
            if (save.temps && save.temps.choice_restore_name) name = save.temps.choice_restore_name;
            options.push({ name: name + " (" + simpleDateTimeFormat(date) + ")", group: "choice", state: save });
          }
          if (!options.length) {
            self.printLine("There are no recently deleted saves to undelete.");
            renderRestoreMenu(saveList, dirtySaveList);
            return;
          }
          function submitButtonNameFunction(count) {
            if (count == 1) {
              return "Undelete 1 Save";
            } else {
              return "Undelete " + count + " Saves";
            }
          }
          printCheckboxes(options, submitButtonNameFunction, function (results) {
            startLoading();
            var undeletionDate = Date.now();
            clearScreen(function () {
              Promise.all(results.map(function (result, i) {
                if (result) {
                  return new Promise(function (resolve) {
                    var save = options[i].state;
                    var slot = "save" + save.timestamp;
                    var oldUndeleted = save.undeleted;
                    save.undeleted = undeletionDate;
                    var value = computeCookie(save.stats, save.temps, save.lineNum, save.indent, save.deleted, save.undeleted);
                    writeCookie(value, slot, function (ok) {
                      submitRemoteSave(slot, email, !"subscribe", function (ok) {
                        if (ok) {
                          resolve();
                        } else {
                          save.undeleted = oldUndeleted;
                          var value = computeCookie(save.stats, save.temps, save.lineNum, save.indent, save.deleted, save.undeleted);
                          writeCookie(value, slot, function () { });
                          reject(new Error("Failed submitting " + slot));
                        }
                      })
                    })
                  });
                }
              })).then(function () {
                doneLoading();
                renderRestoreMenu(saveList, dirtySaveList);
              }).catch(function (err) {
                self.printLine("There was an error undeleting saves. Please try again later.");
                renderRestoreMenu(saveList, dirtySaveList);
              });
            });
          });
          printFooter();
        });
      } else if (option.password) {
        clearScreen(function() {
          self.restore_password();
        });
      } else {
        if (option.cancel) {
          self.finished = false;
          if (typeof cancelLabel !== "undefined") {
            self["goto"](cancelLabel);
          }
          self.resetPage();
        } else {
          var state = option.state;
          var sceneName = null;
          if (state.stats && state.stats.sceneName) sceneName = (""+state.stats.sceneName).toLowerCase();
          var unrestorable = unrestorableScenes[sceneName];

          if (unrestorable) {
            asyncAlert(unrestorable);
            self.finished = false;
            self.resetPage();
            return;
          }

          saveCookie(function() {
            clearScreen(function() {
              restoreGame(state, null, /*userRestored*/true);
            });
          }, "", state.stats, state.temps, state.lineNum, state.indent);
        }
      }
    });
  }
  getDirtySaveList(function(dirtySaveList) {
    getSaves(function(saveList) {
      renderRestoreMenu(saveList, dirtySaveList);
    });
  });
};

Scene.prototype.restore_password = function restore_password() {
  var alreadyFinished = this.finished;
  this.finished = true;
  this.paragraph();
  this.printLine('Please paste your password here, then press "Next" below to continue.');
  this.prevLine = "text";
  this.paragraph();
  var self = this;
  var unrestorableScenes = this.parseRestoreGame(alreadyFinished);
  getPassword(this.target, function (cancel, password) {
    if (cancel) {
      self.finished = false;
      self.resetPage();
      return;
    }
    password = password.replace(/\s/g, "");
    password = password.replace(/^.*BEGINPASSWORD-----/, "");
    var token = self.deobfuscatePassword(password);
    token = token.replace(/^[^\{]*/, "");
    token = token.replace(/[^\}]*$/, "");
    var state;
    try {
      state = jsonParse(token);
    } catch (e) {
      asyncAlert("Sorry, that password was invalid. Please contact " + getSupportEmail() + " for assistance. Be sure to include your password in the email.");
      return;
    }

    var sceneName = null;
    if (state.stats && state.stats.sceneName) sceneName = (""+state.stats.sceneName).toLowerCase();

    var unrestorable = unrestorableScenes[sceneName];
    if (unrestorable) {
      asyncAlert(unrestorable);
      self.finished = false;
      self.resetPage();
      return;
    }

    saveCookie(function() {
      clearScreen(function() {
        // we're going to pretend not to be user restored, so we get reprompted to save
        restoreGame(state, null, /*userRestored*/false);
      });
    }, "", state.stats, state.temps, state.lineNum, state.indent);
  });
  if (alreadyFinished) printFooter();
};

Scene.prototype.parseRestoreGame = function parseRestoreGame(alreadyFinished) {
    if (alreadyFinished) {
      // if we're already finished, the printLoop bumped us an extra line ahead
      this.lineNum--;
      this.rollbackLineCoverage();
    }
    // nextIndent: the level of indentation after the current line
    var nextIndent = null;
    var unrestorableScenes = {};
    var line;
    var startIndent = this.indent;
    while(isDefined(line = this.lines[++this.lineNum])) {
        if (!trim(line)) {
            this.rollbackLineCoverage();
            continue;
        }
        var indent = this.getIndent(line);
        if (nextIndent === null || nextIndent === undefined) {
            // initialize nextIndent with whatever indentation the line turns out to be
            // ...unless it's not indented at all
            if (indent > startIndent) {
                this.indent = nextIndent = indent;
            }
        }
        if (indent <= startIndent) {
            // it's over!
            if (!alreadyFinished) {
              this.lineNum--;
              this.rollbackLineCoverage();
            }
            return unrestorableScenes;
        }
        if (indent != this.indent) {
            // all chart rows are supposed to be at the same indentation level
            // anything at the wrong indentation level might be a mis-indented title/definition
            // or just a typo
            throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
        }

        //
        // *restore_game
        //   ending You can't restore to the ending.

        line = trim(line);
        var result = /^(\w+)\s+(.*)/.exec(line);
        if (!result) throw new Error(this.lineMsg() + "invalid line; this line should have a scene name followed by an error message: " + line);
        var sceneName = result[1].toLowerCase();
        var error = trim(result[2]);
        unrestorableScenes[sceneName] = error;
    }
    if (!alreadyFinished) {
      this.lineNum--;
      this.rollbackLineCoverage();
    }
    return unrestorableScenes;
};

Scene.prototype.check_registration = function scene_checkRegistration() {
  if (typeof window == "undefined" || typeof isRegistered == "undefined") return;
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  isRegistered(function() {
    self.finished = false;
    self.skipFooter = false;
    self.execute();
  });
};

Scene.prototype.login = function scene_login(optional) {
  if (typeof window == "undefined" || typeof loginForm == "undefined") return;
  optional = trim(optional);
  if (optional) {
    if (optional != "optional") throw new Error(this.lineMsg() + "invalid *login option: " + optional);
    optional = 1;
  }
  var self = this;
  this.finished = true;
  this.skipFooter = true;
  this.paragraph();
  var target = this.target;
  if (!target) target = document.getElementById('text');
  loginForm(target, optional, null, function() {
    clearScreen(function() {
      self.finished = false;
      self.prevLine = "empty";
      self.screenEmpty = true;
      self.execute();
    });
  });
};

Scene.prototype.save_game = function save_game(destinationSceneName) {
  if (!destinationSceneName) throw new Error(this.lineMsg()+"*save_game requires a destination file name, e.g. *save_game Episode2");
  if (this.temps.choice_user_restored) return;
  var self = this;
  this.finished = true;
  this.skipFooter = true;
  fetchEmail(function(defaultEmail){
    self.paragraph();
    var form = document.createElement("form");
    setClass(form, "saveGame");

    form.action="#";

    var message = document.createElement("div");
    message.style.color = "red";
    message.style.fontWeight = "bold";
    form.appendChild(message);

    var saveName = document.createElement("input");
    saveName.type="text";
    saveName.name="saveName";
    saveName.setAttribute("placeholder", "Type a name for your saved game");
    saveName.setAttribute("style", "display:block; font-size: 25px; width: 90%; margin: 1rem 0");
    form.appendChild(saveName);

    var hideEmailForm = false;
    // hideEmailForm = _global.automaticCloudStorage;
    if (!hideEmailForm) {
      println("Please login to the choiceofgames.com save system with your email address below.", form);

      var emailInput = document.createElement("input");
      // This can fail on IE
      try { emailInput.type="email"; } catch (e) {}
      emailInput.name="email";
      emailInput.value=defaultEmail;
      emailInput.setAttribute("placeholder", "you@example.com");
      emailInput.setAttribute("style", "display:block; font-size: 25px; width: 90%; margin: 1rem 0");
      form.appendChild(emailInput);

      var subscribeLabel = document.createElement("label");
      subscribeLabel.setAttribute("for", "subscribeBox");
      var subscribeBox = document.createElement("input");
      subscribeBox.type = "checkbox";
      subscribeBox.name = "subscribe";
      subscribeBox.setAttribute("id", "subscribeBox");
      subscribeBox.setAttribute("checked", true);
      subscribeLabel.appendChild(subscribeBox);
      subscribeLabel.appendChild(document.createTextNode("Email me when new games are available."));
      form.appendChild(subscribeLabel);
    }

    var target = this.target;
    if (!target) target = document.getElementById('text');
    target.appendChild(form);
    printButton("Next", form, true);

    printButton("Cancel", target, false, function() {
      clearScreen(function() {
        self.finished = false;
        self.prevLine = "empty";
        self.screenEmpty = true;
        self.execute();
      });
    });

    form.onsubmit = function(e) {
      preventDefault(e);
      safeCall(this, function() {
        var messageText;
        if (!trim(saveName.value)) {
          messageText = document.createTextNode("Please type a name for your saved game.");
          message.innerHTML = "";
          message.appendChild(messageText);
          return;
        }

        var slot = "save" + new Date().getTime();
        // create a clone stats object whose scene name is the destination scene
        var saveStats = {};
        for (var stat in self.stats) {
          if ("scene" == stat) continue;
          saveStats[stat] = self.stats[stat];
        }
        saveStats.scene = {name:destinationSceneName};

        if (hideEmailForm) {
          clearScreen(function() {
            saveCookie(function() {
              recordSave(slot, function() {
                self.finished = false;
                self.prevLine = "empty";
                self.screenEmpty = true;
                self.execute();
              });
            }, slot, saveStats, {choice_reuse:"allow", choice_user_restored:true, choice_restore_name:saveName.value}, 0, 0);
          });
          return;
        }

        var shouldSubscribe = subscribeBox.checked;
        var subscribe = shouldSubscribe && (window.isHeartsChoice ? "hc" : "cog");
        var email = trim(emailInput.value);
        if (!/^\S+@\S+\.\S+$/.test(email)) {
          messageText = document.createTextNode("Sorry, \""+email+"\" is not an email address.  Please type your email address again.");
          message.innerHTML = "";
          message.appendChild(messageText);
          return;
        }

        recordEmail(email, function() {
          clearScreen(function() {
            saveCookie(function() {
              recordSave(slot, function() {
                startLoading();
                submitRemoteSave(slot, email, subscribe, function(ok) {
                  doneLoading();
                  if (!ok) {
                    asyncAlert("Couldn't upload your saved game to choiceofgames.com. You can try again later from the Restore menu.", function() {
                      self.finished = false;
                      self.prevLine = "empty";
                      self.screenEmpty = true;
                      self.execute();
                    });
                  } else {
                    self.finished = false;
                    self.prevLine = "empty";
                    self.screenEmpty = true;
                    self.execute();
                  }
                });
              });
            }, slot, saveStats, {choice_reuse:"allow", choice_user_restored:true, choice_restore_name:saveName.value}, 0, 0);
          });
        });
      });
    };

    printFooter();
  });
};

Scene.prototype.show_password = function show_password() {
  if (this.temps.choice_user_restored) return;
  this.paragraph();
  if (typeof(window) != "undefined" && !window.isMobile) {
    this.printLine('Please copy and paste the password in a safe place, then press "Next" below to continue.');
    println("", this.target);
    println("", this.target);
  }
  var password = computeCookie(this.stats, this.temps, this.lineNum, this.indent);
  password = this.obfuscate(password);
  showPassword(this.target, password);
  this.prevLine = "block";
};

Scene.prototype.obfuscate = function obfuscate(password) {
  var self = this;
  return password.replace(/./g,
    function(x) {
      var y = self.obfuscator[x];
      return y;
    }
  );
};

// The obfuscator must take US-ASCII and obfuscate it
// for use in a password.  This password will be sent via
// HTML email and its whitespace handling will be unpredictable,
// So we can't output any of these characters: [ <>&]
// Since we're losing four characters of output, we JSON-escape
// four characters of input [^`|~].
Scene.prototype.obfuscator = {
  " ": "k",
  "!": "E",
  "\"": "`",
  "#": "\\",
  "$": "r",
  "%": "J",
  "&": "o",
  "'": "0",
  "(": "Z",
  ")": "M",
  "*": "G",
  "+": "t",
  ",": "Y",
  "-": "f",
  ".": "2",
  "/": "!",
  "0": "i",
  "1": "*",
  "2": "1",
  "3": "3",
  "4": "[",
  "5": "6",
  "6": "v",
  "7": "\"",
  "8": "F",
  "9": "9",
  ":": "{",
  ";": "Q",
  "<": "?",
  "=": "5",
  ">": "#",
  "?": "K",
  "@": "/",
  "A": "=",
  "B": "N",
  "C": "z",
  "D": "$",
  "E": "W",
  "F": "(",
  "G": ")",
  "H": "q",
  "I": "C",
  "J": "+",
  "K": "U",
  "L": ".",
  "M": "H",
  "N": "B",
  "O": "S",
  "P": "X",
  "Q": "I",
  "R": "-",
  "S": "m",
  "T": "D",
  "U": "^",
  "V": "A",
  "W": "a",
  "X": "y",
  "Y": ",",
  "Z": "d",
  "[": "O",
  "\\": "s",
  "]": "8",
  "^": "sVii6h",
  "_": "]",
  "`": "sViivi",
  "a": "4",
  "b": "g",
  "c": "%",
  "d": "w",
  "e": "h",
  "f": "n",
  "g": "b",
  "h": "7",
  "i": "x",
  "j": "~",
  "k": "_",
  "l": "l",
  "m": ":",
  "n": "c",
  "o": "L",
  "p": "j",
  "q": "u",
  "r": "R",
  "s": "}",
  "t": "p",
  "u": "V",
  "v": "P",
  "w": "'",
  "x": "T",
  "y": "|",
  "z": "@",
  "{": "e",
  "|": "sVii\"%",
  "}": ";",
  "~": "sVii\"h"
};
Scene.prototype.deobfuscator = {
  "k": " ",
  "E": "!",
  "`": "\"",
  "\\": "#",
  "r": "$",
  "J": "%",
  "o": "&",
  "0": "'",
  "Z": "(",
  "M": ")",
  "G": "*",
  "t": "+",
  "Y": ",",
  "f": "-",
  "2": ".",
  "!": "/",
  "i": "0",
  "*": "1",
  "1": "2",
  "3": "3",
  "[": "4",
  "6": "5",
  "v": "6",
  "\"": "7",
  "F": "8",
  "9": "9",
  "{": ":",
  "Q": ";",
  "?": "<",
  "5": "=",
  "#": ">",
  "K": "?",
  "/": "@",
  "=": "A",
  "N": "B",
  "z": "C",
  "$": "D",
  "W": "E",
  "(": "F",
  ")": "G",
  "q": "H",
  "C": "I",
  "+": "J",
  "U": "K",
  ".": "L",
  "H": "M",
  "B": "N",
  "S": "O",
  "X": "P",
  "I": "Q",
  "-": "R",
  "m": "S",
  "D": "T",
  "^": "U",
  "A": "V",
  "a": "W",
  "y": "X",
  ",": "Y",
  "d": "Z",
  "O": "[",
  "s": "\\",
  "8": "]",
  "]": "_",
  "4": "a",
  "g": "b",
  "%": "c",
  "w": "d",
  "h": "e",
  "n": "f",
  "b": "g",
  "7": "h",
  "x": "i",
  "~": "j",
  "_": "k",
  "l": "l",
  ":": "m",
  "c": "n",
  "L": "o",
  "j": "p",
  "u": "q",
  "R": "r",
  "}": "s",
  "p": "t",
  "V": "u",
  "P": "v",
  "'": "w",
  "T": "x",
  "|": "y",
  "@": "z",
  "e": "{",
  ";": "}"
};

Scene.prototype.deobfuscatePassword = function deobfuscatePassword(password) {
  var self = this;
  password = password.replace(/./g,
    function(x) {
      var y = self.deobfuscator[x];
      return y;
    }
  );
  return password;
};

Scene.prototype.stat_chart = function stat_chart() {
  this.paragraph();
  var rows = this.parseStatChart();
  var target = this.target;
  if (!target) target = document.getElementById('text');

  var barWidth = 0;
  var standardFontSize = 0;

  function fixFontSize(span1, span2) {
    if (!standardFontSize) {
      if (window.getComputedStyle) {
        standardFontSize = parseInt(getComputedStyle(document.body).fontSize, 10);
      } else if (document.body.currentStyle) {
        standardFontSize = parseInt(document.body.currentStyle.fontSize, 10);
      } else {
        standardFontSize = 16;
      }
    }
    if (!barWidth) barWidth = span1.parentNode.offsetWidth;
    var spanMaxWidth, biggestSpanWidth;
    if (span2) {
      spanMaxWidth = barWidth / 2 - 1; /* minus one as a fudge factor; why is this needed? */
      biggestSpanWidth = Math.max(span1.offsetWidth, span2.offsetWidth);
    } else {
      spanMaxWidth = barWidth;
      biggestSpanWidth = span1.offsetWidth;
    }

    if (biggestSpanWidth > spanMaxWidth) {
      var newSize = Math.floor(standardFontSize * spanMaxWidth / biggestSpanWidth);
      span1.parentNode.style.fontSize = newSize + "px";
      if (window.getComputedStyle) {
        // on Android, if the user is using non-standand styles, browser may try to ignore our font setting
        var actual = parseInt(getComputedStyle(span1).fontSize, 10);
        if (actual > newSize) {
          newSize *= newSize / actual;
          span1.parentNode.style.fontSize = newSize + "px";
        }
      }
    }

  }

  for (i = 0; i < rows.length; i++) {
    var row = rows[i];
    var type = row.type;
    var variable = row.variable;
    var value = this.evaluateExpr(this.tokenizeExpr(variable));
    var label = this.replaceVariables(row.label);
    var definition = this.replaceVariables(row.definition || "");

    var statWidth, div, span, statValue;
    if (type == "text") {
      div = document.createElement("div");
      setClass(div, "statText");
      span = document.createElement("span");
      if (trim(label) || trim(value)) {
        printx(label + ": " + value, span);
      } else {
        // unofficial line_break
        printx(" ", span);
      }
      div.appendChild(span);
      target.appendChild(div);
    } else if (type == "percent") {
      div = document.createElement("div");
      setClass(div, "statBar statLine");
      span = document.createElement("span");
      printx("\u00a0\u00a0"+label+": "+value+"%", span);
      div.appendChild(span);
      statValue = document.createElement("div");
      setClass(statValue, "statValue");
      statValue.style.width = value+"%";
      statValue.innerHTML = "&nbsp;";
      div.appendChild(statValue);
      target.appendChild(div);
      fixFontSize(span);
    } else if (type == "opposed_pair") {
      div = document.createElement("div");
      setClass(div, "statBar statLine opposed");
      span0 = document.createElement("span");
      printx("\u00a0\u00a0"+label+": "+value+"% ", span0);
      div.appendChild(span0);
      span = document.createElement("span");
      span.setAttribute("style", "float: right");
      printx(this.replaceVariables(row.opposed_label)+": "+(100-value)+"%\u00a0\u00a0", span);
      div.appendChild(span);
      statValue = document.createElement("div");
      setClass(statValue, "statValue");
      statValue.style.width = value+"%";
      statValue.innerHTML = "&nbsp;";
      div.appendChild(statValue);
      target.appendChild(div);
      fixFontSize(span0, span);
    } else {
      throw new Error("Bug! Parser accepted an unknown row type: " + type);
    }
  }
  this.prevLine = "block";
  this.screenEmpty = false;
};

Scene.prototype.save_checkpoint = function saveCheckpoint(slot) {
  var stat;
  if (slot) {
    if (!/^[a-zA-Z0-9_]+$/.test(slot)) throw new Error(this.lineMsg() + "Invalid *save_checkpoint slot, must be only letters, numbers, and _ underscores: " + slot);
    slot = slot.toLowerCase();
    stat = "choice_saved_checkpoint_" + slot;
  } else {
    slot = "checkpoint";
    stat = "choice_saved_checkpoint";
  }
  if (this.secondaryMode) throw new Error(this.lineMsg() + "Cannot *save_checkpoint in " + this.secondaryMode + " mode");
  this.stats[stat] = true;
  this.temps.choice_just_restored_checkpoint = false;
  saveCookie(function () {}, slot, this.stats, this.temps, this.lineNum + 1, this.indent, this.debugMode, this.nav);
}

Scene.prototype.restore_checkpoint = function restoreCheckpoint(slot) {
  var stat;
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  if (!this.testPath && this.secondaryMode) {
    if (this.secondaryMode === 'stats') {
      restoreCheckpointFromStats(function () {
        delete self.secondaryMode;
        delete self.saveSlot;
        self.restore_checkpoint(slot);
      })
      return;
    } else {
      throw new Error(this.lineMsg() + "Cannot *restore_checkpoint in " + this.secondaryMode + " mode");
    }
  }

  if (slot) {
    if (!/^[a-zA-Z0-9_]+$/.test(slot)) throw new Error(this.lineMsg() + "Invalid *restore_checkpoint slot, must be only letters, numbers, and _ underscores: " + slot);
    slot = slot.toLowerCase();
    stat = "choice_saved_checkpoint_" + slot;
  } else {
    slot = "checkpoint";
    stat = "choice_saved_checkpoint";
  }
  if (!this.stats[stat]) {
    var certainty = this.testPath ? " could fail; we might not have" : " failed; we haven't";
    if (slot === "checkpoint") {
      throw new Error(this.lineMsg() + "*restore_checkpoint" + certainty + " saved a checkpoint. Use *if " + stat);
    } else {
      throw new Error(this.lineMsg() + "*restore_checkpoint for slot " + slot + certainty + " reached *save_checkpoint " + slot + ". Use *if " + stat);
    }
  }

  if (this.testPath) return;

  var forcedStats = null;
  var forcedTemps = {choice_just_restored_checkpoint: true};
  if (this.stats.checkpoint_exclusions || this.temps.checkpoint_exclusions) {
    var exclusions = trim(this.getVar('checkpoint_exclusions').toLowerCase()).split(' ');
    for (var i = 0; i < exclusions.length; i++) {
      var exclusion = exclusions[i];
      if (exclusion in this.stats) {
        if (!forcedStats) forcedStats = {};
        forcedStats[exclusion] = this.stats[exclusion];
      }
      if (exclusion in this.temps) {
        if (!forcedTemps) forcedTemps = {};
        forcedTemps[exclusion] = this.temps[exclusion];
      }
    }
  }

  loadAndRestoreGame(slot, null, forcedStats, forcedTemps);
}

Scene.prototype.parseStatChart = function parseStatChart() {
    // nextIndent: the level of indentation after the current line
    var nextIndent = null;
    var rows = [];
    var line, line1, line2, line2indent;
    var startIndent = this.indent;
    while(isDefined(line = this.lines[++this.lineNum])) {
        if (!trim(line)) {
            this.rollbackLineCoverage();
            continue;
        }
        var indent = this.getIndent(line);
        if (nextIndent === null || nextIndent === undefined) {
            // initialize nextIndent with whatever indentation the line turns out to be
            // ...unless it's not indented at all
            if (indent <= startIndent) {
                throw new Error(this.lineMsg() + "invalid indent, expected at least one row");
            }
            this.indent = nextIndent = indent;
        }
        if (indent <= startIndent) {
            // it's over!
            this.rollbackLineCoverage();
            this.lineNum = this.previousNonBlankLineNum();
            this.rollbackLineCoverage();
            return rows;
        }
        if (indent != this.indent) {
            // all chart rows are supposed to be at the same indentation level
            // anything at the wrong indentation level might be a mis-indented title/definition
            // or just a typo
            throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
        }

        //
        // *stat_chart
        //   text wounds Wounds
        //     Definition
        //   percent Infamy Infamy
        //     Definition
        //   opposed_pair brutality
        //     Brutality
        //       Strength and cruelty
        //     Finesse
        //       Precision and aerial maneuverability
        //

        // TODO opposed_pair
        // TODO definitions
        // TODO variable substitutions
        // TODO *if/*else
        // TODO *line_break
        line = trim(line);
        var result = /^(text|percent|opposed_pair)\s+(.*)/.exec(line);
        if (!result) throw new Error(this.lineMsg() + "invalid line; this line should start with 'percent', 'text', or 'opposed_pair'");
        var type = result[1].toLowerCase();
        var data = trim(result[2]);
        if ("opposed_pair" == type) {
          this.getVar(data);
          line1 = this.lines[++this.lineNum];
          this.replaceVariables(line1);
          line1indent = this.getIndent(line1);
          if (line1indent <= this.indent) throw new Error(this.lineMsg() + "invalid indent; expected at least one indented line to indicate opposed pair name. indent: " + line1indent + ", expected greater than " + this.indent);
          line2 = this.lines[this.lineNum + 1];
          line2indent = this.getIndent(line2);
          if (line2indent <= this.indent) {
            // line1 was the only line
            rows.push({type: type, variable: data, label: data, opposed_label: trim(line1)});
          } else {
            this.lineNum++;
            this.replaceVariables(line2);
            if (line2indent == line1indent) {
              // two lines: first label, second label
              rows.push({type: type, variable: data, label: trim(line1), opposed_label: trim(line2)});
            } else if (line2indent > line1indent) {
              // line 2 is a definition; therefore the opposed_label and its definition must be on lines 3 and 4
              var line1definition = line2;
              var line3 = this.lines[++this.lineNum];
              this.replaceVariables(line3);
              var line3indent = this.getIndent(line3);
              if (line3indent != line1indent) throw new Error(this.lineMsg() + "invalid indent; this line should be the opposing label name. expected " + line1indent + " was " + line3indent);
              var line4 = this.lines[++this.lineNum];
              this.replaceVariables(line4);
              var line4indent = this.getIndent(line4);
              if (line4indent != line2indent) throw new Error(this.lineMsg() + "invalid indent; this line should be the opposing label definition. expected " + line2indent + " was " + line4indent);
              rows.push({type: type, variable: data, label: trim(line1), definition:trim(line2), opposed_label: trim(line3), opposed_definition: trim(line4)});
            } else {
              throw new Error(this.lineMsg() + "invalid indent; expected a second line with indent " + line1indent + " to match line " + this.lineNum + ", or else no more opposed_pair lines");
            }
          }
        } else {
          var variable, label;
          if (!/ /.test(data)) {
            variable = data;
            label = data;
          } else if (/^\(/.test(data)) {
            var parens = 0;
            var closingParen = -1;
            for (var i = 1; i < data.length; i++) {
              var c = data.charAt(i);
              if (c === "(") {
                parens++;
              } else if (c === ")") {
                if (parens) {
                  parens--;
                } else {
                  closingParen = i;
                  break;
                }
              }
            }
            if (closingParen == -1) {
              throw new Error(this.lineMsg() + "missing closing parenthesis");
            }
            variable = data.substring(1, closingParen);
            label = trim(data.substring(closingParen+1))
            if (label === "") {
              label = variable;
            }
          } else {
            result = /^(\S+) (.*)/.exec(data);
            if (!result) throw new Error(this.lineMsg() + "Bug! can't find a space when a space was found");
            variable = result[1];
            label = result[2];
          }
          this.evaluateExpr(this.tokenizeExpr(variable));
          this.replaceVariables(label);
          line2 = this.lines[this.lineNum + 1];
          line2indent = this.getIndent(line2);
          if (line2indent <= this.indent) {
            // No definition line
            rows.push({type: type, variable: variable, label: label});
          } else {
            this.lineNum++;
            this.replaceVariables(line2);
            rows.push({type: type, variable: variable, label: label, definition: trim(line2)});
          }
        }
    }
    return rows;
};

// *timer Dec 25, 2016 9:30:00 PDT
Scene.prototype.timer = function(dateString) {
  var end;
  if (dateString == "release") {
    if (typeof window === "undefined" || !window.releaseDate) return;
    end = window.releaseDate/1000;
  } else {
    end = Date.parse(dateString)/1000;
  }
  var now = new Date()/1000;
  if (now < end) {
    var target = this.target;
    if (!target) {
      target = document.createElement("p");
      document.getElementById('text').appendChild(target);
    }
    var self = this;
    showTicker(target, end, function() {
      clearScreen(loadAndRestoreGame());
    });
  }
}

// *delay_break 1200
Scene.prototype.delay_break = function(durationInSeconds) {
  if (isNaN(durationInSeconds * 1)) throw new Error(this.lineMsg() + "invalid duration");
  this.finished = true;
  this.skipFooter = true;
  var target = this.target;
  if (!target) {
    target = document.createElement("p");
    document.getElementById('text').appendChild(target);
  }
  this.paragraph();
  var self = this;
  delayBreakStart(function(delayStart) {
    window.blockRestart = true;
    var endTimeInSeconds = durationInSeconds * 1 + delayStart * 1;
    showTicker(target, endTimeInSeconds, function() {
      self.page_break_advertisement();
    });
    printFooter();
  });
};

// *delay_ending 1200 $2.99 $0.99
Scene.prototype.delay_ending = function(data) {
  // Steam doesn't do delay breaks and especially not skiponce
  if (typeof window != "undefined" && !!window.isSteamApp) {
    return this.ending();
  }
  var args = data.split(/ /);
  var durationInSeconds = args[0];
  var fullPriceGuess = args[1];
  var singleUsePriceGuess = args[2];
  if (isNaN(durationInSeconds * 1)) throw new Error(this.lineMsg() + "invalid duration");
  if (!/^\$/.test(fullPriceGuess)) throw new Error(this.lineMsg() + "invalid fullPriceGuess: \""+fullPriceGuess+"\"");
  if (singleUsePriceGuess && !/^\$/.test(singleUsePriceGuess)) throw new Error(this.lineMsg() + "invalid singleUsePriceGuess: \""+singleUsePriceGuess+"\"");
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  checkPurchase("adfree", function(ok, result) {
    if (result.adfree || !result.billingSupported) {
      self.ending();
      return;
    }
    getPrice("adfree", function (fullPrice) {
      if (fullPrice == "guess") fullPrice = fullPriceGuess;
      getPrice("skiponce", function (singleUsePrice) {
        if (singleUsePrice == "guess") singleUsePrice = singleUsePriceGuess;

        options = [];
        var finishedWaiting = {name: "Play again after a short wait. ", unselectable: true};
        options.push(finishedWaiting);
        var upgradeSkip = {name: "Upgrade to the unlimited version for " + fullPrice + " to skip the wait forever."};
        options.push(upgradeSkip);
        var skipOnce = {name: "Skip the wait one time for " + singleUsePrice + "."};
        if (singleUsePriceGuess) options.push(skipOnce);
        var restorePurchasesOption = {name: "Restore purchases from another device."};
        if (isRestorePurchasesSupported()) options.push(restorePurchasesOption);
        var playMoreGames = {name: "Play more games like this."};
        options.push(playMoreGames);
        var emailMe = {name: "Email me when new games are available."};
        options.push(emailMe);

        function restartNow() {
          window.blockRestart = false;
          restartGame();
        }

        self.paragraph();
        printOptions([""], options, function(option) {
          if (option == playMoreGames) {
            self.more_games("now");
            if (typeof curl != "undefined") curl();
          } else if (option == emailMe) {
            subscribeLink();
          } else if (option == upgradeSkip) {
            purchase("adfree", restartNow);
          } else if (option == skipOnce) {
            purchase("skiponce", restartNow);
          } else if (option == restorePurchasesOption) {
            restorePurchases("adfree", function() {
              clearScreen(loadAndRestoreGame);
            });
          } else {
            return restartGame();
          }
        });

        var target = document.querySelector(".choice label");

        delayBreakStart(function(delayStart) {
          window.blockRestart = true;
          var endTimeInSeconds = durationInSeconds * 1 + delayStart * 1;
          showTicker(target, endTimeInSeconds, function() {
            clearScreen(function() {
              self.ending();
            });
          });
          printFooter();
        });
      });
    });
  });

};

// *if booleanExpr
// execute different code depending on whether the booleanExpr is true or false
//
// Examples:
// *if bool-expression
//     blah
//     blah
// *elseif bool-expression
//     blah
//     blah
// *else
//     blah
//     blah
// bool-expression
//     by reference
//         *set foo true
//         *if foo ...
//     equality
//         foo=2
//         foo="blah"
//         2="2"
//             true
//     inequality
//         foo>2
//         foo<2
//         foo<=2
//         foo>=2
//     and/or logic, parentheses mandatory
//         (foo=2) or (foo=3)
//         ((foo>4) and (foo<8)) or (bar=0)
//
// NOTE: *if commands may be used inside *choices, to make some choices conditionally available
Scene.prototype["if"] = function scene_if(line) {
    var stack = this.tokenizeExpr(line);
    var result = this.evaluateExpr(stack);
    if (this.debugMode) println(line + " :: " + result);
    result = bool(result, this.lineNum+1);
    if (result) {
        // "true" branch, just go on to the next line
        this.indent = this.getIndent(this.nextNonBlankLine());
    } else {
        // "false" branch; skip over the true branch
        this.skipTrueBranch(false);
    }
};

// TODO Rename this function to just skipBranch
Scene.prototype.skipTrueBranch = function skipTrueBranch(inElse) {
  var startIndent = this.indent;
  var nextIndent = null;
  var line;
  while (isDefined(line = this.lines[++this.lineNum])) {
      this.rollbackLineCoverage();
      if (!trim(line)) continue;
      var indent = this.getIndent(line);
      if (nextIndent === null || nextIndent === undefined) {
          if (indent <= startIndent) throw new Error(this.lineMsg() + "invalid indent, expected at least one line in 'if' true block");
          nextIndent = indent;
      }
      if (indent <= startIndent) {
          // true block is over
          var parsed = null;
          // check to see if this is an *else or *elseif
          if (indent == startIndent) parsed = /^\s*\*(\w+)(.*)/.exec(line);
          if (!parsed || inElse) {
              this.lineNum = this.previousNonBlankLineNum();
              this.rollbackLineCoverage();
              this.indent = indent;
              return;
          }
          var command = parsed[1].toLowerCase();
          var data = trim(parsed[2]);
          if ("else" == command) {
              if (data) {
                if (/^if\b/.test(data)) {
                  throw new Error(this.lineMsg() + "'else if' is invalid, use 'elseif'");
                }
                throw new Error(this.lineMsg() + "nothing should appear on a line after 'else': " + data);
              }
              this.lineNum = this.lineNum; // code coverage
              // go on to the next line
              this.indent = this.getIndent(this.nextNonBlankLine());
          } else if (/^else?if$/.test(command)) {
              this.lineNum = this.lineNum; // code coverage
              this["if"](data);
          } else if ("comment" == command) {
              continue;
          } else {
              this.lineNum = this.previousNonBlankLineNum();
              this.rollbackLineCoverage();
              this.indent = this.getIndent(this.nextNonBlankLine());
          }
          return;
      }
      if (indent < nextIndent) {
          // *if foo
          //      foo
          //    bar
          throw new Error(this.lineMsg() + "invalid indent, expected "+nextIndent+", was " + indent);
      }
  }
};

Scene.prototype["else"] = Scene.prototype.elsif = Scene.prototype.elseif = function scene_else(data, inChoice) {
    // Authors can avoid using goto to get out of an if branch with:  *create implicit_control_flow true
    // This avoids the error message at the end of the function.
    if (inChoice || this.getVar("implicit_control_flow")) {
      this.skipTrueBranch(true);
      return;
    }
    throw new Error(this.lineMsg() + "It is illegal to fall in to an *else statement; you must *goto or *finish before the end of the indented block.");
};

// break the string up into a stack of tokens, defined in Scene.tokens below
Scene.prototype.tokenizeExpr = function tokenizeExpr(str) {
    var stack = [];
    var tokenTypes = Scene.tokens;
    var tokenTypesLength = tokenTypes.length;
    var pos = 0;
    while (str) {
        var matched = false;
        for (var i = 0; i < tokenTypesLength; i++) {
            var tokenType = tokenTypes[i];
            var token = tokenType.test(str, this.lineNum+1, this);
            if (token) {
                matched = true;
                str = str.substr(token.length);
                pos += token.length;
                var item = {name:tokenType.name, value:token, pos:pos};
                if (this.testPath && tokenType.name === "VAR" && /^choice_saved_checkpoint/i.test(token)) {
                  // handle choice_saved_checkpoint in quicktest
                  this.stats[token.toLowerCase()] = true;
                }
                if ("WHITESPACE" == tokenType.name) {
                    break;
                } else if ("CURLY_QUOTE" == tokenType.name) {
                  throw new Error(this.lineMsg()+"Invalid use of curly smart quote: " + token + "\nUse straight quotes \" instead")
                } else if ("FUNCTION" == tokenType.name) {
                  item.func = /^\w+/.exec(token)[0];
                }
                stack.push(item);
                break;
            }
        }
        if (!matched) throw new Error(this.lineMsg()+"Invalid expression, couldn't extract another token: " + str);
    }
    return stack;
};

// evaluate the stack of tokens
// parenthetical == true if we're evaluating a parenthetical expression
// all expressions consist of either a "singleton" value (2) or two values and one operator (2+2)
Scene.prototype.evaluateExpr = function evaluateExpr(stack, parenthetical) {
    if (!stack.length) {
        throw new Error(this.lineMsg() + "no expression specified");
    }
    var self = this;
    function getToken() {
        var token = stack.shift();
        if (!token) throw new Error(self.lineMsg() + "null token");
        return token;
    }

    var token, value1, value2, operator, result;

    value1 = this.evaluateValueToken(getToken(), stack);

    if (!stack.length) {
        if (parenthetical) {
            throw new Error(this.lineMsg() + "Invalid expression, expected " + parenthetical);
        }
        return value1;
    }

    token = getToken();

    if (parenthetical && parenthetical == token.name) {
        return value1;
    }

    // Since this isn't a singleton, it must be an operator
    operator = Scene.operators[token.value];
    if (!operator) {
      throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected OPERATOR"+
        (parenthetical?" or " + parenthetical : "")+
        ", was: " + token.name + " [" + token.value + "]");
    }

    if (token.value === '%') {
      this.warning("this is a bare % sign, which should be replaced with %+, %-, or modulo if you're really advanced.");
      this.warning("For more details on modulo, see: https://forum.choiceofgames.com/t/21176");
    }

    if (!stack[0]) {
      throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected something after a "+token.value);
    }

    if (stack[0].func == "auto") {
      value2 = this.autobalance(stack, token, value1);
    } else {
      value2 = this.evaluateValueToken(getToken(), stack);
    }

    // and do the operator
    result = operator(value1, value2, this.lineNum+1, this);

    if (parenthetical) {
        // expect close parenthesis
        if (stack.length) {
            token = getToken();
            if (parenthetical == token.name) {
                return result;
            } else {
                throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected "+parenthetical+", was: " + token.name + " [" + token.value + "]");
            }
        } else {
            throw new Error(this.lineMsg() + "Invalid expression, expected " + parenthetical);
        }
    } else {
        // if not parenthetical, expect no more tokens
        if (stack.length) {
            token = getToken();
            throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected no more tokens, found: " + token.name + " [" + token.value + "]");
        } else {
            return result;
        }
    }
    throw new Error(this.lineMsg() + "bug, how did I get here?");
};

// turn a number, string, or var token into its value
// or, if this is an open parenthesis, evaluate the parenthetical expression
Scene.prototype.evaluateValueToken = function evaluateValueToken(token, stack) {
    var name = token.name;
    var value;
    if ("OPEN_PARENTHESIS" == name) {
        return this.evaluateExpr(stack, "CLOSE_PARENTHESIS");
    } else if ("OPEN_CURLY" == name) {
        value = this.evaluateExpr(stack, "CLOSE_CURLY");
        return this.getVar(value);
    } else if ("FUNCTION" == name) {
        if (!this.functions[token.func]) throw new Error(this.lineMsg + "Unknown function " + token.func);
        value = this.evaluateExpr(stack, "CLOSE_PARENTHESIS");
        return this.functions[token.func].call(this, value);
    } else if ("NUMBER" == name) {
        return token.value;
    } else if ("STRING" == name) {
        // strip off the quotes and unescape backslashes
        return this.replaceVariables(token.value.slice(1,-1).replace(/\\(.)/g, "$1"));
    } else if ("VAR" == name) {
        var variable = String(token.value);
        while (stack.length && stack[0].name == "OPEN_SQUARE") {
          stack.shift();
          variable += "_" + this.evaluateExpr(stack, "CLOSE_SQUARE");
        }
        return this.getVar(variable);
    } else {
        throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected NUMBER, STRING, VAR or PARENTHETICAL, was: " + name + " [" + token.value + "]");
    }
};

// turn a var token into its name, remove it from the stack
// or if it's a curly parenthesis, evaluate that
// or if it's an array expression, convert it into its raw underscore name
Scene.prototype.evaluateReference = function evaluateReference(stack, options) {
  var toLowerCase = true;
  if (options && options.hasOwnProperty("toLowerCase")) toLowerCase = !!options.toLowerCase;
  function findClosingBracket(stack, type, offset) {
    if (!offset) offset = 0;
    var opens = 0;
    var openType = "OPEN_"+type;
    var closeType = "CLOSE_"+type;
    for (var i = offset; i < stack.length; i++) {
      if (stack[i].name == openType) {
        opens++;
      } else if (stack[i].name == closeType) {
        if (opens) {
          opens--;
        } else {
          return i;
        }
      }
    }
    return -1;
  }
  function normalizeCase(name) {
    if (toLowerCase) {
      return String(name).toLowerCase();
    } else {
      return name;
    }
  }
  if (!stack.length) throw new Error(this.lineMsg()+"Invalid expression, expected a name");
  var name;
  if (stack[0].name === "OPEN_CURLY") {
    stack.shift();
    var closingCurly = findClosingBracket(stack, "CURLY");
    if (closingCurly == -1) throw new Error(this.lineMsg()+"Invalid expression, no closing curly bracket: " + data);
    name = this.evaluateExpr(stack.slice(0, closingCurly));
    stack.splice(0, closingCurly+1);
    return normalizeCase(name);
  } else if (stack[0].name === "NUMBER") {
    // you could have a label that's just a number
    name = stack[0].value;
    stack.shift();
    return name;
  } else {
    if (stack[0].name !== "VAR") throw new Error(this.lineMsg() + "Invalid expression; expected name, found " + stack[0].name + " at char " + stack[0].pos);
    name = String(stack[0].value);
    stack.shift();
    while(stack.length && stack[0].name == "OPEN_SQUARE") {
      var closingBracket = findClosingBracket(stack, "SQUARE", 1);
      if (closingBracket == -1) throw new Error(this.lineMsg()+"Invalid expression, no closing array bracket at char " + stack[1].pos);
      var index = this.evaluateExpr(stack.slice(1, closingBracket));
      name += "_" + index;
      stack.splice(0, closingBracket+1);
    }
    return normalizeCase(name);
  }
};

Scene.prototype.functions = {
  not: function(value) {
    return !bool(value, this.lineNum+1);
  },
  round: function(value) {
    if (isNaN(value*1)) throw new Error(this.lineMsg()+"round() value is not a number: " + value);
    return Math.round(value);
  },
  timestamp: function(value) {
    return Date.parse(value)/1000;
  },
  log: function(value) {
    if (isNaN(value*1)) throw new Error(this.lineMsg()+"log() value is not a number: " + value);
    return Math.log(value)/Math.log(10);
  },
  length: function(value) {
    return String(value).length;
  },
  auto: function() {
    throw new Error(this.lineMsg()+"Invalid expression, auto() must come after a < or > symbol");
  }
};

Scene.prototype.autobalance = function autobalance(stack, operatorToken, value) {
  if (operatorToken.name !== "INEQUALITY") {
    throw new Error(this.lineMsg()+"Invalid expression, auto() must come after a < or > symbol");
  }
  stack.shift(); // remove auto function

  if (stack.length < 4 ||
    stack[0].name !== "NUMBER" ||
    stack[1].name !== "COMMA" ||
    !(stack[2].name == "VAR" || stack[2].name == "NUMBER") ||
    stack[3].name !== "CLOSE_PARENTHESIS"
  ) {
    throw new Error(this.lineMsg()+"Invalid expression, auto() requires (percentage, id)");
  }
  var rateString = stack.shift().value;
  var rate = parseFloat(rateString);
  if (isNaN(rate) || rate < 1 || rate > 99) {
    throw new Error(this.lineMsg()+"the first auto() parameter should be a number between 1 and 99: " + rateString);
  }
  stack.shift(); // comma
  var id = stack.shift().value;
  stack.shift(); // close parenthesis
  var result = this.stats['auto' + '_' + this.name + '_' + id];
  if (typeof result != "undefined") {
    return result;
  } else if (this.recordBalance) {
    return this.recordBalance(value, operatorToken.value, rate, id);
  }
  return 50;
}

Scene.prototype.evaluateValueExpr = function evaluateValueExpr(expr) {
    var stack = this.tokenizeExpr(expr);
    var token = stack.shift();
    if (!token) throw new Error(this.lineMsg() + "null token");
    var value = this.evaluateValueToken(token, stack);
    if (stack.length) {
        token = stack.shift();
        if (!token) throw new Error(this.lineMsg() + "null token");
        throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected no more tokens, found: " + token.name + " [" + token.value + "]");
    }
    return value;
};

Scene.prototype.goto_random_scene = function gotoRandomScene(data) {
  var parsed = this.parseGotoRandomScene(data);
  var allowReuseGlobally = /\ballow_reuse\b/.test(data);
  var allowNoSelection = /\ballow_no_selection\b/.test(data);
  var option = this.computeRandomSelection(Math.random(), parsed, allowReuseGlobally);

  if (option) {
    this.goto_scene(option.name);
  } else {
    if (allowNoSelection) {
      return;
    } else {
      throw new Error(this.lineMsg() + "No selectable scenes");
    }
  }

};

Scene.prototype.parseGotoRandomScene = function parseGotoRandomScene(data) {
    data = data || "";
    var directives = data.split(" ");
    var allowReuseGlobally = false;
    var allowNoSelection = false;
    for (var i = 0; i < directives; i++) {
      var directive = trim(directives[i]);
      if (!directive) continue;
      if (directive == "allow_reuse") {
        allowReuseGlobally = true;
      } else if (directive == "allow_no_selection") {
        allowNoSelection = true;
      } else {
        throw new Error(this.lineMsg() + "invalid command: '" + directive + "'");
      }
    }

    // nextIndent: the level of indentation after the current line
    var nextIndent = null;
    var options = [];
    var line;
    var startIndent = this.indent;
    while(isDefined(line = this.lines[++this.lineNum])) {
        if (!trim(line)) {
            this.rollbackLineCoverage();
            continue;
        }
        var indent = this.getIndent(line);
        if (nextIndent === null || nextIndent === undefined) {
            // initialize nextIndent with whatever indentation the line turns out to be
            // ...unless it's not indented at all
            if (indent <= startIndent) {
                throw new Error(this.lineMsg() + "invalid indent, expected at least one line in *goto_random_scene");
            }
            this.indent = nextIndent = indent;
        }
        if (indent <= startIndent) {
            // it's over!
            this.rollbackLineCoverage();
            this.lineNum--;
            this.rollbackLineCoverage();
            break;
        }
        if (indent != this.indent) {
            // all chart rows are supposed to be at the same indentation level
            // anything at the wrong indentation level might be a mis-indented title/definition
            // or just a typo
            throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
        }
        line = trim(line);

        var option = {allowReuse:allowReuseGlobally};
        var command;
        while(!!(command = /^\*(\S+)/.exec(line))) {
          command = command[1];
          if ("allow_reuse" == command) {
            option.allowReuse = true;
            line = trim(line.substring("*allow_reuse".length));
            command = /^\*(\S+)/.exec(line);
            continue;
          } else if ("if" == command) {
            var conditional = /^\*if\s+\((.+)\)\s+([^\)]+)/.exec(line);
            if (!conditional) throw new Error(this.lineMsg() + " invalid *if, expected () followed by scene name: " + line);
            line = conditional[2];
            var stack = this.tokenizeExpr(conditional[1]);
            this.evaluateExpr(stack);
            option.conditional = conditional[1];
          } else {
            throw new Error(this.lineMsg() + " invalid command: " + line);
          }
        }
        // TODO weights
        option.name = trim(line);
        options.push(option);
    }
    return options;
};

Scene.prototype.computeRandomSelection = function computeRandomSelection(randomFloat, options, allowReuseGlobally) {
  var filtered = [];
  var finished = {};
  if (!allowReuseGlobally) {
    if (!this.stats.choice_grs) this.stats.choice_grs = [];
  }
  var grs = this.stats.choice_grs;
  for (var i = 0; i < grs.length; i++) {
    finished[grs[i]] = 1;
  }
  var option;
  for (i = 0; i < options.length; i++) {
    option = options[i];
    if (!option.allowReuse) {
      if (finished[option.name]) continue;
    }
    if (option.conditional) {
      var stack = this.tokenizeExpr(option.conditional);
      var pass = this.evaluateExpr(stack);
      if (!pass) continue;
    }
    filtered.push(option);
  }
  if (!filtered.length) return null;
  // TODO weights
  var randomSelection = Math.floor(randomFloat*filtered.length);
  option = filtered[randomSelection];
  if (!option.allowReuse) {
    this.stats.choice_grs.push(option.name);
  }
  return option;
};

Scene.prototype.end_trial = function endTrial() {
  this.paragraph();
  printLink(this.target, "#", "Start Over from the Beginning", function(e) {
    preventDefault(e);
    return restartGame("prompt");
  });
  this.prevLine = "block";
  this.screenEmpty = false;
  this.finished = true;
};

Scene.prototype.achieve = function scene_achieve(name) {
  name = name.toLowerCase();
  if (!this.nav.achievements.hasOwnProperty(name)) {
    throw new Error(this.lineMsg() + "the achievement name "+name+" was not declared as an *achievement in startup");
  }
  var achievement = this.nav.achievements[name];
  this.nav.achieved[name] = true;
  if (typeof achieve != "undefined") {
    achieve(name, achievement.title, achievement.earnedDescription);
  }
};

Scene.prototype.check_achievements = function scene_checkAchievements() {
  var self = this;
  function callback(immediately) {
    for (var achievement in nav.achievements) {

      self.temps["choice_achieved_"+achievement] = nav.achieved.hasOwnProperty(achievement);
    }
    if (!immediately) {
      self.finished = false;
      self.skipFooter = false;
      self.execute();
    }
  }
  if (typeof checkAchievements == "undefined") {
    callback("immediately");
  } else {
    this.finished = true;
    this.skipFooter = true;
    checkAchievements(callback);
  }
};

Scene.prototype.scene_list = function scene_list() {
  var scenes = this.parseSceneList();
  this.nav.setSceneList(scenes);
};

Scene.prototype.parseSceneList = function parseSceneList() {
  var nextIndent = null;
  var scenes = [];
  var line;
  var startIndent = this.indent;
  while(isDefined(line = this.lines[++this.lineNum])) {
      if (!trim(line)) {
          this.rollbackLineCoverage();
          continue;
      }
      var indent = this.getIndent(line);
      if (nextIndent === null || nextIndent === undefined) {
          // initialize nextIndent with whatever indentation the line turns out to be
          // ...unless it's not indented at all
          if (indent <= startIndent) {
              throw new Error(this.lineMsg() + "invalid indent, expected at least one row");
          }
          this.indent = nextIndent = indent;
      }
      if (indent <= startIndent) {
          // it's over!
          this.rollbackLineCoverage();
          this.lineNum--;
          this.rollbackLineCoverage();
          return scenes;
      }
      if (indent != this.indent) {
          // all scenes are supposed to be at the same indentation level
          throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
      }

      line = trim(line);
      var purchaseMatch = /^\$(\w*)\s+(.*)/.exec(line);
      if (purchaseMatch) {
        line = purchaseMatch[2];
      }
      if (!scenes.length && "startup" != String(line).toLowerCase()) scenes.push("startup");
      scenes.push(line);
  }
  return scenes;
};

Scene.prototype.title = function scene_title(title) {
  this.stats.choice_title = trim(title);
  if (this.nav) this.nav.startingStats.choice_title = trim(title);
  if (typeof changeTitle != "undefined") {
    changeTitle(title);
  }
};

Scene.prototype.author = function scene_author(author) {
  if (typeof changeAuthor != "undefined") {
    changeAuthor(author);
  }
};

// *achievement name hidden|visible 100 Achievement Title
//     Earned description
//     Pre-earned description
Scene.prototype.achievement = function scene_achievement(data) {
  var parsed = /(\S+)\s+(\S+)\s+(\S+)\s+(.*)/.exec(data);
  if (!parsed) throw new Error(this.lineMsg() + "Invalid *achievement, requires short name, visibility, points, and display title: " + data);
  var achievementName = parsed[1];
  if (!/^[a-z][a-z0-9_]+$/.test(achievementName)) throw new Error(this.lineMsg()+"Invalid achievement name: " +achievementName);

  if (!this.parsedAnAchievment && Object.keys(this.nav.achievements).length > 0) {
    // blow away pre-existing mygame.js achievements
    this.nav.achievements = {};
    this.nav.achievementList = [];
    this.achievementTotal = 0;
    this.seenAchievementTitles = {};
  }

  this.parsedAnAchievment = true;

  if (this.nav.achievements.hasOwnProperty(achievementName)) {
    var preExisting = this.nav.achievements[achievementName];
    throw new Error(this.lineMsg()+"Achievement "+achievementName+" already defined on line " + this.nav.achievements[achievementName].lineNumber);
  }

  var lineNumber = this.lineNum+1;
  var visibility = parsed[2];
  if (visibility != "hidden" && visibility != "visible") {
    throw new Error(this.lineMsg()+"Invalid *achievement, the second word should be either 'hidden' or 'visible': " +visibility);
  }
  var visible = (visibility != "hidden");
  var pointString = parsed[3];
  if (!/[1-9][0-9]*/.test(pointString)) {
    throw new Error(this.lineMsg()+"Invalid *achievement, the third word should be an integer number of points: " + pointString);
  }
  var points = parseInt(pointString, 10);
  if (points > 100) throw new Error(this.lineMsg()+"Invalid *achievement, no achievement may be worth more than 100 points: " + points);
  if (points < 1) throw new Error(this.lineMsg()+"Invalid *achievement, no achievement may be worth less than 1 point: " + points);
  if (!this.achievementTotal) this.achievementTotal = 0;
  this.achievementTotal += points;
  if (this.achievementTotal > 1000) {
    throw new Error(this.lineMsg()+"Invalid achievements. Adding " + points + " would add up to more than 1,000 points: " + this.achievementTotal);
  }
  var title = parsed[4];
  if (/(\$\{)/.test(title)) throw new Error(this.lineMsg()+"Invalid *achievement. ${} not permitted in achievement title: " + title);
  if (/(\@\{)/.test(title)) throw new Error(this.lineMsg()+"Invalid *achievement. @{} not permitted in achievement title: " + title);
  if (/(\[)/.test(title)) throw new Error(this.lineMsg()+"Invalid *achievement. [] not permitted in achievement title: " + title);
  if (title.length > 50) throw new Error(this.lineMsg()+"Invalid *achievement. Title must be 50 characters or fewer: " + title);

  // Get the description from the next indented line
  var line = this.lines[++this.lineNum];
  var indent = this.getIndent(line);
  if (!indent) {
    throw new Error(this.lineMsg()+"Invalid *achievement. An indented description is required.");
  }
  var preEarnedDescription = trim(line);
  if (/(\$\{)/.test(preEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. ${} not permitted in achievement description: " + preEarnedDescription);
  if (/(\@\{)/.test(preEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. @{} not permitted in achievement description: " + preEarnedDescription);
  if (/(\[)/.test(preEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. [] not permitted in achievement description: " + preEarnedDescription);
  if (preEarnedDescription.length > 200) throw new Error(this.lineMsg()+"Invalid *achievement. Pre-earned description must be 200 characters or fewer: " + preEarnedDescription);

  if (!visible) {
    if (preEarnedDescription.toLowerCase() != "hidden") throw new Error(this.lineMsg()+"Invalid *achievement. Hidden achievements must set their pre-earned description to 'hidden'.");
  }

  // Optionally get a post-earned description from the next line
  var postEarnedDescription = null;
  while(isDefined(line = this.lines[++this.lineNum])) {
    if (trim(line)) break;
    this.rollbackLineCoverage();
  }
  indent = this.getIndent(line);
  if (indent) {
    postEarnedDescription = trim(line);
    if (/(\$\{)/.test(postEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. ${} not permitted in achievement description: " + postEarnedDescription);
    if (/(\@\{)/.test(postEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. @{} not permitted in achievement description: " + postEarnedDescription);
    if (/(\[)/.test(postEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. [] not permitted in achievement description: " + postEarnedDescription);
    if (postEarnedDescription.length > 200) throw new Error(this.lineMsg()+"Invalid *achievement. Post-earned description must be 200 characters or fewer: " + postEarnedDescription);
  } else {
    // No indent means the next line is not a post-earned description
    this.rollbackLineCoverage();
    this.lineNum--;
    this.rollbackLineCoverage();
  }

  if (!postEarnedDescription) {
    if (!visible) throw new Error(this.lineMsg()+"Invalid *achievement. Hidden achievements must set a post-earned description.");
    postEarnedDescription = preEarnedDescription;
  }

  if (!this.nav.achievements.hasOwnProperty(achievementName)) {
    this.nav.achievementList.push(achievementName);
    if (this.nav.achievementList.length > 100) {
      throw new Error(this.lineMsg()+"Too many *achievements. Each game can have up to 100 achievements.");
    }
  }

  if (!this.seenAchievementTitles) this.seenAchievementTitles = {};

  if (this.seenAchievementTitles[title]) {
    throw new Error(this.lineMsg()+"An achievement with display title \"" + title + "\" was already defined at line " + this.seenAchievementTitles[title]);
  }

  this.seenAchievementTitles[title] = this.lineNum+1;

  this.nav.achievements[achievementName] = {
    visible: visible,
    points: points,
    title: title,
    earnedDescription: postEarnedDescription,
    preEarnedDescription: preEarnedDescription,
    lineNumber: lineNumber
  };

  if (typeof setButtonTitles != "undefined") setButtonTitles();
};


Scene.prototype.bug = function scene_bug(message) {
  if (message) {
    message = "Bug: " + this.replaceVariables(message);
  } else {
    message = "Bug";
  }
  if (message === "Bug: choice_beta" && _global.beta) return;
  throw new Error(this.lineMsg() + message);
};

Scene.prototype.warning = function scene_warning(message) {
  // quicktest implements this
}

Scene.prototype.feedback = function scene_feedback() {
  this.stats.choice_feedback_requested = true;
  if (typeof window == "undefined" || this.randomtest) return;
  this.paragraph();
  this.printLine("On a scale from 1 to 10, how likely are you to recommend this game to a friend?");
  this.paragraph();
  var options = [{name:"10 (Most likely)"}];
  for (var i = 9; i > 1; i--) {
    options.push({name:i});
  }
  options.push({name:"1 (Least likely)"});
  options.push({name:"No response."});
  var self = this;
  if (window.prepareReviewPrompt) window.prepareReviewPrompt();
  this.renderOptions([""], options, function(option) {
    var value = "null";
    var numberMatch = /^(\d+)/.exec(option.name);
    if (numberMatch) value = numberMatch[1]*1;
    if (!isWebSavePossible()) {
      self.finished = false;
      self.resetPage();
      return;
    }

    var postFeedback = function() {
      xhrAuthRequest("POST", "feedback", function(ok, response) {
        if (window.console) console.log("ok", ok, response);
      }, "game", window.storeName, "platform", platformCode(), "rating", value);
      if (/^(9|10)/.test(option.name)) {
        if (isReviewSupported()) {
          return clearScreen(function() {
            if (promptForReview()) {
              self.screenEmpty = false;
              self.prevLine = "text";
              self.page_break();
              printFooter();
            } else {
              self.finished = false;
              self.resetPage();
            }
          });
        }
      }
      self.finished = false;
      self.resetPage();
    }

    if (value == "null") {
      self.finished = false;
      self.resetPage();
      return;
    }

    isRegistered(function(registered) {
      if (registered) {
        postFeedback();
      } else {
        clearScreen(function() {
          loginForm(main, 1/*optional*/, "Please sign in to have your vote counted!", postFeedback);
        });
      }
    });
  });
  this.finished = true;
};

Scene.prototype.parseTrackEvent = function(data) {
  var event = {};
  var stack = this.tokenizeExpr(data);
  if (!stack.length) throw new Error(this.lineMsg() + "Invalid track_event statement, expected at least two args: category and action");
  event.category = this.evaluateValueToken(stack.shift(), stack);
  if (!stack.length) throw new Error(this.lineMsg() + "Invalid track_event statement, expected at least two args: category and action");
  event.action = this.evaluateValueToken(stack.shift(), stack);
  if (stack.length) {
    event.label = this.evaluateValueToken(stack.shift(), stack);
    if (stack.length) {
      event.value = this.evaluateValueToken(stack.shift(), stack);
      if (stack.length) {
        throw new Error(this.lineMsg() + "Invalid track_event statement, expected at most four args: category, action, label, value");
      }
      var intValue = parseInt(event.value, 10);
      if (isNaN(intValue) || event.value != intValue || event.value.toString() != intValue.toString()) {
        throw new Error(this.lineMsg() + "Invalid track_event statement, value must be an integer: " + event.value);
      }
    }
  }
  return event;
}

Scene.prototype.track_event = function track_event(data) {
  var event = this.parseTrackEvent(data);
  if (typeof ga !== "undefined") {
    ga('send', 'event', event.category, event.action, event.label, event.value);
  }
}

Scene.prototype.ai = function ai(data) {}

Scene.prototype.config = function config(data) {
    var stack = this.tokenizeExpr(data);
    var variable = this.evaluateReference(stack);
    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }
    if (stack.length === 0) throw new Error(this.lineMsg()+"Invalid set instruction, no expression specified: " + line);
    var value = this.evaluateExpr(stack);
    this.setVar(variable, value);
    if ("undefined" !== typeof remoteConfig && !this.randomtest && !this.quicktest) {
      this.finished = true;
      this.skipFooter = true;
      var self = this;
      remoteConfig(variable, function(result) {
        if (result !== null) self.setVar(variable, result);
        self.finished = false;
        self.skipFooter = false;
        self.execute();
      })
    }
};

Scene.prototype.ifid = function ifid(id) {
  if (!/^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/.test(id)) {
    var example = "a0a0a0a0-a0a0-a0a0-a0a0-a0a0a0a0a0a0";
    try {
      example = crypto.randomUUID();
    } catch (e) {}
    throw new Error(this.lineMsg() + "Invalid IFID. It should have five parts, like \""+example+"\": " + id);
  }
  if (!/^[A-F0-9\-]{36}$/i.test(id)) {
    throw new Error(this.lineMsg() + "Invalid IFID. It should contain only numbers, letters A-F, and dashes: " + id);
  }
}

Scene.prototype.lineMsg = function lineMsg() {
    return this.name + " line " + (this.lineNum+1) + ": ";
};

Scene.prototype.rollbackLineCoverage = function() {};

Scene.baseUrl = "scenes";
Scene.regexpMatch = function regexpMatch(str, re) {
    var result = re.exec(str);
    if (!result) return null;
    return result[0];
};
// Each token has a name and a test, which returns the matching string
Scene.tokens = [
    {name:"OPEN_PARENTHESIS", test:function(str){ return Scene.regexpMatch(str,/^\(/); } },
    {name:"CLOSE_PARENTHESIS", test:function(str){ return Scene.regexpMatch(str,/^\)/); } },
    {name:"OPEN_CURLY", test:function(str){ return Scene.regexpMatch(str,/^\{/); } },
    {name:"CLOSE_CURLY", test:function(str){ return Scene.regexpMatch(str,/^\}/); } },
    {name:"OPEN_SQUARE", test:function(str){ return Scene.regexpMatch(str,/^\[/); } },
    {name:"CLOSE_SQUARE", test:function(str){ return Scene.regexpMatch(str,/^\]/); } },
    {name:"FUNCTION", test:function(str){ return Scene.regexpMatch(str,/^(not|round|timestamp|log|length|auto)\s*\(/); } },
    {name:"NUMBER", test:function(str){ return Scene.regexpMatch(str,/^\d+(\.\d+)?\b/); } },
    {name:"STRING", test:function(str, line, sceneObj) {
            var i;
            if (!/^\"/.test(str)) return null;
            for (i = 1; i < str.length; i++) {
                var x = str.charAt(i);
                if ("\\" == x) {
                    i++;
                } else if ('"' == x) {
                    return str.substring(0,i+1);
                }
            }
            var errMessage = "line " + line + ": ";
            if (sceneObj) {
              errMessage = sceneObj.lineMsg();
            }
            throw new Error(errMessage+"Invalid string, open quote with no close quote: " + str);
        }
    },
    {name:"CURLY_QUOTE", test:function(str){ return Scene.regexpMatch(str,/^[\u201c\u201d]/); } },
    {name:"WHITESPACE", test:function(str){ return Scene.regexpMatch(str,/^\s+/); } },
    {name:"NAMED_OPERATOR", test:function(str){ return Scene.regexpMatch(str,/^(and|or|modulo)\b/); } },
    {name:"VAR", test:function(str){ return Scene.regexpMatch(str,/^\w*/); } },
    {name:"FAIRMATH", test:function(str){ return Scene.regexpMatch(str,/^%[\+\-]/); } },
    {name:"OPERATOR", test:function(str){ return Scene.regexpMatch(str,/^[\+\-\*\/\&\%\^\#]/); } },
    {name:"INEQUALITY", test:function(str){ return Scene.regexpMatch(str,/^[\!<>]\=?/); } },
    {name:"EQUALITY", test:function(str){ return Scene.regexpMatch(str,/^=/); } },
    {name:"COMMA", test:function(str){ return Scene.regexpMatch(str,/^,/); } }
    //
];
Scene.operators = {
    "+": function add(v1,v2,line,sceneObj) { var name = null; if (sceneObj) name = sceneObj.name; return num(v1,line,name) + num(v2,line,name); },
    "-": function subtract(v1,v2,line,sceneObj) { var name = null; if (sceneObj) name = sceneObj.name; return num(v1,line,name) - num(v2,line,name); },
    "*": function multiply(v1,v2,line,sceneObj) { var name = null; if (sceneObj) name = sceneObj.name; return num(v1,line,name) * num(v2,line,name); },
    "/": function divide(v1,v2,line,sceneObj) {
      var name = null; if (sceneObj) name = sceneObj.name; 
      v2 = num(v2, line, name);
      if (v2 === 0) throw new Error(name+" line "+line+": can't divide by zero");
      return num(v1,line,name) / num(v2,line,name);
    },
    "^": function exponent(v1,v2,line,sceneObj) { var name = null; if (sceneObj) name = sceneObj.name; return Math.pow(num(v1,line,name), num(v2,line,name)); },
    "&": function concatenate(v1,v2) { return [v1,v2].join(""); },
    "#": function charAt(v1,v2,line,sceneObj) {
      var name = null;
      var errMessage = "line " + line + ": ";
      if (sceneObj) {
        name = sceneObj.name;
        errMessage = sceneObj.lineMsg();
      }
      var i = num(v2,line,name);
      if (i < 1) {
        throw new Error(errMessage+"There is no character at position " + i + "; the position must be greater than or equal to 1.");
      }
      if (i > String(v1).length) {
        throw new Error(errMessage+"There is no character at position " + i + ". \""+v1+"\" is only " + String(v1).length + " characters long.");
      }
      return String(v1).charAt(i-1);
    },
    "%+": function fairAdd(v1, v2, line, sceneObj) {
        var name = null;
        var errMessage = "line " + line + ": ";
        if (sceneObj) {
          name = sceneObj.name;
          errMessage = sceneObj.lineMsg();
        }
        v1 = num(v1,line,name);
        v2 = num(v2,line,name);
        var validValue = (v1 >= 0 && v1 <= 100);
        if (!validValue) {
            throw new Error(errMessage+"Can't fairAdd to non-percentile value: " + v1);
        }
        if (v2 > 0) {
          var multiplier = (100 - v1) / 100;
          var actualModifier = v2 * multiplier;
          var value = 1 * v1 + actualModifier;
          value = Math.floor(value);
          if (value > 99) value = 99;
          return value;
        } else {
          var multiplier = v1 / 100;
          var actualModifier = (0-v2) * multiplier;
          var value = v1 - actualModifier;
          value = Math.ceil(value);
          if (value < 1) value = 1;
          return value;
        }
    },
    "%-": function fairSubtract(v1, v2, line, sceneObj) {
        var name = null; if (sceneObj) name = sceneObj.name; 
        v2 = num(v2,line,name);
        return Scene.operators["%+"](v1,0-v2,line,sceneObj);
    },
    "=": function equals(v1,v2) { return v1 == v2 || String(v1) == String(v2); },
    "<": function lessThan(v1,v2,line,sceneObj) {
        var name = null; if (sceneObj) name = sceneObj.name; 
        return num(v1,line,name) < num(v2,line,name); },
    ">": function greaterThan(v1,v2,line,sceneObj) { var name = null; if (sceneObj) name = sceneObj.name; return num(v1,line,name) > num(v2,line,name); },
    "<=": function lessThanOrEquals(v1,v2,line,sceneObj) { var name = null; if (sceneObj) name = sceneObj.name; return num(v1,line,name) <= num(v2,line,name); },
    ">=": function greaterThanOrEquals(v1,v2,line,sceneObj) { var name = null; if (sceneObj) name = sceneObj.name; return num(v1,line,name) >= num(v2,line,name); },
    "!=": function notEquals(v1,v2) { return v1 != v2; },
    "and": function and(v1, v2, line, sceneObj) {
        var name = null; if (sceneObj) name = sceneObj.name; 
        return bool(v1,line,name) && bool(v2,line,name);
    },
    "or": function or(v1, v2, line, sceneObj) {
        var name = null; if (sceneObj) name = sceneObj.name; 
        return bool(v1,line,name) || bool(v2,line,name);
    },
    "modulo": function modulo(v1,v2,line,sceneObj) { var name = null; if (sceneObj) name = sceneObj.name; return num(v1,line,name) % num(v2,line,name); },
};

Scene.initialCommands = {"create":1,"create_array":1,"scene_list":1,"title":1,"author":1,"comment":1,"achievement":1,"product":1,"ifid":1};

Scene.validCommands = {"comment":1, "goto":1, "gotoref":1, "label":1, "looplimit":1, "finish":1, "abort":1,
    "choice":1, "create":1, "create_array": 1, "temp":1, "temp_array": 1, "delete":1, "delete_array":1, "set":1, "setref":1, "print":1, "if":1, "rand":1,
    "page_break":1, "line_break":1, "script":1, "else":1, "elseif":1, "elsif":1, "reset":1,
    "goto_scene":1, "fake_choice":1, "input_text":1, "ending":1, "share_this_game":1, "stat_chart":1,
    "subscribe":1, "show_password":1, "gosub":1, "return":1, "hide_reuse":1, "disable_reuse":1, "allow_reuse":1,
    "check_purchase":1,"restore_purchases":1,"purchase":1,"restore_game":1,"advertisement":1,
    "kindle_search":1,"kindle_product":1,"feedback":1,
    "save_game":1,"delay_break":1,"image":1,"kindle_image":1,"link":1,"input_number":1,"goto_random_scene":1,
    "restart":1,"more_games":1,"delay_ending":1,"end_trial":1,"login":1,"achieve":1,"scene_list":1,"title":1,
    "bug":1,"link_button":1,"check_registration":1,"sound":1,"author":1,"gosub_scene":1,"achievement":1,
    "check_achievements":1,"redirect_scene":1,"print_discount":1,"purchase_discount":1,"track_event":1,
    "timer":1,"youtube":1,"product":1,"text_image":1,"ai":1,"params":1,"config":1,"ifid":1,
    "page_break_advertisement":1, "finish_advertisement":1, "save_checkpoint": 1, "restore_checkpoint": 1
    };

;
/*
 * Copyright 2010 by Dan Fabulich.
 * 
 * Dan Fabulich licenses this file to you under the
 * ChoiceScript License, Version 1.0 (the "License"); you may
 * not use this file except in compliance with the License. 
 * You may obtain a copy of the License at
 * 
 *  http://www.choiceofgames.com/LICENSE-1.0.txt
 * 
 * See the License for the specific language governing
 * permissions and limitations under the License.
 * 
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied.
 */
function SceneNavigator(sceneList) {
    this.setSceneList(sceneList);
    this.startingStats = {};
}

SceneNavigator.prototype.setSceneList = function setSceneList(sceneList) {
    this._sceneList = sceneList;
    this._sceneMap = {};
    for (var i = 0; i < sceneList.length-1; i++) {
        var scene1 = sceneList[i];
        var scene2 = sceneList[i+1];
        this._sceneMap[scene1] = scene2;
    }
    this._startupScene = sceneList[0];
};

SceneNavigator.prototype.nextSceneName = function nextSceneName(currentSceneName) {
    var nextScene = this._sceneMap[currentSceneName];
    //if (!nextScene) throw new Error("No scene follows " + currentSceneName);
    return nextScene;
};

SceneNavigator.prototype.getStartupScene = function getStartupScene() {
    return this._startupScene;
};

SceneNavigator.prototype.setStartingStatsClone = function setStartingStatsClone(stats) {
  this.startingStats = {};
  for (var i in stats) {
    this.startingStats[i] = stats[i];
  }
};

SceneNavigator.prototype.resetStats = function resetStats(stats) {
  for (var i in stats) {
    delete stats[i];
  }
  for (i in this.startingStats) {
    stats[i] = this.startingStats[i];
  }
  this.bugLog = [];
};

SceneNavigator.prototype.repairStats = function repairStats(stats) {
  for (var i in this.startingStats) {
    var startingStat = this.startingStats[i];
    if (startingStat === null || startingStat === undefined) continue;
    if (typeof(stats[i]) === "undefined" || stats[i] === null) {
      stats[i] = this.startingStats[i];
    }
  }
};

SceneNavigator.prototype.bugLog = [];
SceneNavigator.prototype.achievements = {};
SceneNavigator.prototype.achievementList = [];
SceneNavigator.prototype.achieved = {};
SceneNavigator.prototype.products = {};

SceneNavigator.prototype.loadAchievements = function(achievementArray) {
  if (!achievementArray) return;
  this.achievements = {};
  this.achievementList = [];
  for (var i = 0; i < achievementArray.length; i++) {
    var achievement = achievementArray[i];
    var achievementName = achievement[0];
    var visible = achievement[1];
    var points = achievement[2];
    var title = achievement[3];
    var earnedDescription = achievement[4];
    var preEarnedDescription = achievement[5];
    this.achievements[achievementName] = {
      visible: visible,
      points: points,
      title: title,
      earnedDescription: earnedDescription,
      preEarnedDescription: preEarnedDescription
    };
    this.achievementList.push(achievementName);
  }
};
SceneNavigator.prototype.loadProducts = function(productArray, purchaseMap) {
  if (!productArray && !purchaseMap) return;
  this.products = {};
  for (var i = 0; i < productArray; i++) {
    this.products[productArray[i]] = {};
  }
  for (var scene in purchaseMap) {
    var product = purchaseMap[scene];
    this.products[product] = {};
  }
}

;
Scene.prototype.sm_save=function(line){var stack=this.tokenizeExpr(line);if(stack.length>2)throw new Error("sm_save: Invalid number of arguments, expected 0, 1 (save name) or 2 (id).");ChoiceScriptSavePlugin._save((new Date).getTime(),stack.length==1?this.evaluateExpr(stack):null)};Scene.prototype.sm_load=function(line){var stack=this.tokenizeExpr(line);var variable=this.evaluateExpr(stack);this.finished=true;this.skipFooter=true;this.screenEmpty=true;ChoiceScriptSavePlugin._load(variable)};Scene.prototype.sm_delete=function(line){var stack=this.tokenizeExpr(line);if(stack.length!=1)throw new Error("sm_delete: Invalid number of arguments, expected 1.");ChoiceScriptSavePlugin._delete(this.evaluateExpr(stack))};Scene.prototype.sm_update=function(){if(typeof this.stats._sm_save_count==="undefined")this.stats._sm_save_count=0;ChoiceScriptSavePlugin._getSaveList(function(saveList){if(!saveList)return;ChoiceScriptSavePlugin._syncHelperVariables(saveList,function(){})})};Scene.prototype.sm_menu=function(data){data=data||"";data=data.toLowerCase();var selectEle=document.getElementById("quickSaveMenu");if(!selectEle)return;var active=false;if(data==="false"){active=false}else if(data==="true"){active=true}else if(!data){active=selectEle.style.display=="none"}else{throw new Error("*sm_menu: expected true, false (or nothing) as an argument!")}selectEle.style.display=active?"inline":"none";var btns=document.getElementsByClassName("savePluginBtn");for(var i=0;i<btns.length;i++){btns[i].style.display=active?"inline":"none"}};Scene.validCommands["sm_save"]=1;Scene.validCommands["sm_load"]=1;Scene.validCommands["sm_delete"]=1;Scene.validCommands["sm_update"]=1;Scene.validCommands["sm_menu"]=1;var ChoiceScriptSavePlugin={};ChoiceScriptSavePlugin._CSS="#quickSaveMenu {        margin: 5px;        width: 100px;    }";ChoiceScriptSavePlugin._save=function(saveId,saveName){restoreObject(initStore(),"state",null,function(baseSave){if(baseSave){baseSave.stats["_smSaveName"]=saveName||"";baseSave.stats["_smSaveDateId"]=saveId;ChoiceScriptSavePlugin._addToSaveList(saveId,function(success){if(!success)return;saveCookie(function(){},ChoiceScriptSavePlugin._formatSlotName(saveId),baseSave.stats,baseSave.temps,baseSave.lineNum,baseSave.indent,this.debugMode,this.nav);setTimeout(function(){var selectEle=document.getElementById("quickSaveMenu");if(selectEle){selectEle.innerHTML="";ChoiceScriptSavePlugin._populateSaveMenu(selectEle)}},3e3)})}else{}})};ChoiceScriptSavePlugin._formatSlotName=function(saveId){return window.storeName+"_SAVE_"+saveId};ChoiceScriptSavePlugin._load=function(saveId){clearScreen(loadAndRestoreGame.bind(stats.scene,ChoiceScriptSavePlugin._formatSlotName(saveId)))};ChoiceScriptSavePlugin._delete=function(saveId){ChoiceScriptSavePlugin._removeFromSaveList(saveId,function(success){if(!success)return;var select=document.getElementById("quickSaveMenu");if(select){var deletedOption=select.options[select.selectedIndex];if(deletedOption)deletedOption.parentElement.removeChild(deletedOption)}initStore().remove("state"+ChoiceScriptSavePlugin._formatSlotName(saveId),function(success,val){})})};ChoiceScriptSavePlugin._createQuickSaveMenu=function(){var p=document.getElementById("menuButton");if(!p){alert("Error: unable to attach quick save menu");return}p=p.parentElement;var head=document.getElementsByTagName("head")[0];var style=document.createElement("style");style.innerHTML=ChoiceScriptSavePlugin._CSS;head.appendChild(style);var selectEle=document.createElement("select");selectEle.setAttribute("id","quickSaveMenu");p.appendChild(selectEle);var buttonArr=[{innerHTML:"New Save",clickFunc:"ChoiceScriptSavePlugin.save();"},{innerHTML:"Load",clickFunc:"ChoiceScriptSavePlugin.load();"},{innerHTML:"Delete",clickFunc:"ChoiceScriptSavePlugin.delete();"}];for(var i=0;i<buttonArr.length;i++){var btn=document.createElement("button");btn.innerHTML=buttonArr[i].innerHTML;btn.setAttribute("class","spacedLink savePluginBtn");btn.setAttribute("onclick",buttonArr[i].clickFunc);p.appendChild(btn)}return selectEle};ChoiceScriptSavePlugin._populateSaveMenu=function(selectEle){ChoiceScriptSavePlugin._getSaveList(function(saveList){if(!saveList)return;saveList.forEach(function(saveId){ChoiceScriptSavePlugin._getSaveData(saveId,function(saveData){if(!saveData){return}var option=document.createElement("option");option.setAttribute("value",saveData.stats._smSaveDateId);if(!saveData){option.innerHTML="Failed to load save."}else{var slotDesc=saveData.stats.sceneName+".txt ("+simpleDateTimeFormat(new Date(parseInt(saveData.stats._smSaveDateId)))+")";if(saveData.stats._smSaveName){slotDesc=saveData.stats._smSaveName+" &mdash; "+slotDesc}option.innerHTML=slotDesc}selectEle.appendChild(option)})})})};ChoiceScriptSavePlugin._getSaveData=function(saveId,callback){restoreObject(initStore(),"state"+ChoiceScriptSavePlugin._formatSlotName(saveId),null,function(saveData){if(saveData){callback(saveData)}else{callback(null)}})};ChoiceScriptSavePlugin._removeFromSaveList=function(saveId,callback){ChoiceScriptSavePlugin._getSaveList(function(saveList){if(!saveList)return;var index=saveList.indexOf(saveId.toString());if(index>-1)saveList.splice(index,1);initStore().set("save_list",saveList.join(" "),function(success,val){ChoiceScriptSavePlugin._syncHelperVariables(saveList,function(){callback(success)})})})};ChoiceScriptSavePlugin._addToSaveList=function(saveId,callback){ChoiceScriptSavePlugin._getSaveList(function(saveList){if(!saveList)return;saveList.push(saveId.toString());initStore().set("save_list",saveList.join(" "),function(success,val){ChoiceScriptSavePlugin._syncHelperVariables(saveList,function(){callback(success)})})})};ChoiceScriptSavePlugin._syncHelperVariables=function(saveList,callback){self.stats._sm_save_count=saveList.length;saveList.forEach(function(save,index){ChoiceScriptSavePlugin._getSaveData(save,function(saveData){if(saveData){self.stats["_sm_save_id_"+index]=save;self.stats["_sm_save_name_"+index]=saveData.stats._smSaveName||"";self.stats["_sm_save_date_"+index]=simpleDateTimeFormat(new Date(parseInt(save)))}})});callback()};ChoiceScriptSavePlugin._getSaveList=function(callback){initStore().get("save_list",function(success,val){if(!success)callback(null);if(!val)callback([]);else callback(saveList=val.split(" ").sort(function(a,b){return b-a}))})};ChoiceScriptSavePlugin._init=function(){if("file:"===window.location.protocol&&(typeof window.uploadedFiles==="undefined"&&typeof allScenes==="undefined")){setTimeout(ChoiceScriptSavePlugin._init,3e3);return}if(!window.storeName){Scene.validCommands["sm_save"]=0;Scene.validCommands["sm_load"]=0;Scene.validCommands["sm_delete"]=0;Scene.validCommands["sm_menu"]=0;Scene.validCommands["sm_menu"]=0;return alertify.error("Disabling ChoiceScript Save Plugin as there is no storeName detected. Please check your index.html.")}ChoiceScriptSavePlugin._populateSaveMenu(ChoiceScriptSavePlugin._createQuickSaveMenu())};ChoiceScriptSavePlugin.save=function(){if(stats.sceneName=="choicescript_stats"){alert("Error: Unable to save at this point.");return}var date=new Date;var message="What would you like to call this save?<br>Leaving this blank will result in a scene and date identifier.";alertify.prompt(message,function(e,saveName){if(e){ChoiceScriptSavePlugin._save(date.getTime(),saveName)}else{}},"Quick Save")};ChoiceScriptSavePlugin.delete=function(){var select=document.getElementById("quickSaveMenu");if(select.value<=0)return;var message="Delete save '"+select.options[select.selectedIndex].text+"'?<br>This cannot be undone!";alertify.confirm(message,function(result){if(!result){return}else{ChoiceScriptSavePlugin._delete(parseInt(select.value))}})};ChoiceScriptSavePlugin.load=function(){var select=document.getElementById("quickSaveMenu");if(select.value<=0)return;alertify.confirm("Are you sure you wish to load this save?<br>Current progress will be lost!",function(result){if(!result){return}else{ChoiceScriptSavePlugin._load(select.value)}})};setTimeout(ChoiceScriptSavePlugin._init,3e3);
;
nav = new SceneNavigator([
 "startup",
 "chapter0",
 "chapter1",
 "chapter2",
 "chapter3",
 "chapter4",
 "ending",
 "eric_fight",
 "eric_subplot",
 "katie_fight",
 "katie_subplot",
 "danny_fight",
 "danny_subplot",
 "chloe_fight",
 "chloe_subplot",
 "training_montages",
 "upgrades",
 "utils"
]);
stats = {
 "implicit_control_flow": "true",
 "choice_title": "Below the Skyline",
 "gender": "None",
 "gender_num": "1",
 "first_name": "Boxing",
 "last_name": "Enthusiast",
 "he": "he",
 "stat_power": "10",
 "stat_technique": "10",
 "stat_toughness": "10",
 "stat_mental": "10",
 "stat_energy": "100",
 "adj_power": "0",
 "adj_technique": "0",
 "adj_toughness": "0",
 "adj_mental": "0",
 "boxing_insights": "0",
 "trait_analysis": "0",
 "trait_composure": "0",
 "trait_empathy": "0",
 "highest_trait": "analysis",
 "highest_trait_num": "0",
 "jab": "[i]Fast Jab[/i]",
 "jab_level": "0",
 "flurry": "[i]Desperate Rush[/i]",
 "flurry_level": "0",
 "combo": "[i]Beginner's Luck[/i]",
 "combo_level": "0",
 "ultimate": "[i]Last Resort[/i]",
 "ultimate_level": "0",
 "block": "[i]Panicked Block[/i]",
 "block_level": "0",
 "parry": "[i]Reflex Flinch[/i]",
 "parry_level": "0",
 "dodge": "[i]No Dodge Training[/i]",
 "dodge_level": "0",
 "counter": "[i]Untrained Counter[/i]",
 "counter_level": "0",
 "food_expo_companion": "None",
 "police_crackdown_active": "false",
 "eric_fought": "false",
 "katie_fought": "false",
 "danny_fought": "false",
 "chloe_fought": "false",
 "camille_fought": "false",
 "eric_subplot_scene": "1",
 "eric_subplot_status": "locked",
 "eric_friendship": "0",
 "katie_subplot_scene": "1",
 "katie_subplot_status": "locked",
 "katie_friendship": "0",
 "danny_subplot_scene": "1",
 "danny_subplot_status": "locked",
 "danny_friendship": "0",
 "danny_investigation_success": "false",
 "chloe_subplot_scene": "1",
 "chloe_subplot_status": "locked",
 "chloe_friendship": "0",
 "eric_plot_timer": "0",
 "katie_plot_timer": "0",
 "danny_plot_timer": "0",
 "chloe_plot_timer": "0",
 "fighting_power": "0",
 "trait_bonus_amount": "0",
 "trait_bonus_applied": "0",
 "upgrade_multiplier": "0",
 "upgrade_bonus": "0",
 "fight_momentum": "3",
 "fight_opponent_name": "Opponent",
 "record_wins": "1",
 "record_losses": "0",
 "record_draws": "0",
 "unlocked_eric_training": "false",
 "unlocked_katie_training": "false",
 "unlocked_danny_training": "false",
 "unlocked_chloe_training": "false",
 "dieroll": "0",
 "can_spend_insight": "false",
 "jab_upgradeable": "false",
 "flurry_upgradeable": "false",
 "combo_upgradeable": "false",
 "ultimate_upgradeable": "false",
 "block_upgradeable": "false",
 "parry_upgradeable": "false",
 "dodge_upgradeable": "false",
 "counter_upgradeable": "false",
 "dodge_learnable": "false",
 "counter_learnable": "false"
};
purchases = {};
achievements = [];
nav.setStartingStatsClone(stats);if (achievements.length) {
  nav.loadAchievements(achievements);
}
if (nav.loadProducts) nav.loadProducts([], purchases);
</script><style>html {
  font: -apple-system-body; /* we'll override the font, but keep the size from iOS dynamic text sizing */
}

body {
  position: relative;
  max-width: 80ch;
  min-height: 100vh; /* keep iOS address bar from popping in and out */
  font-size: 100%;  /* reset for CWS */
  font-family: Georgia,"Times New Roman",serif;
  background-color: #F7F4F1;
  color: rgba(0, 0, 0, 0.85);
  margin: 1ch auto;
  padding: 0;
  -webkit-user-select: text; /* selectable text for Chrome app support */
  transition-property: background-color, color;
  transition-duration: 2s;
  -webkit-transition-property: background-color, color;
  -webkit-transition-duration: 2s;
}

a {
  /* colored underlined links for XULRunner support */
  color: blue;
  text-decoration: underline;
  cursor: pointer;
}

#main {
	line-height: 1.5;
}

.container {
  position: absolute; /* so containers can overlap */
  left: 0;
  right: 0;
  margin: 0 1ch;
  animation-duration: 0.5s;
  -webkit-animation-duration: 0.5s;
  transition-property: opacity;
  transition-duration: 0.5s;
  transition-timing-function: ease-in;
  -webkit-transition-property: opacity;
  -webkit-transition-duration: 0.5s;
  -webkit-transition-timing-function: ease-in;
}

@keyframes containerslidein {
  from {
    transform: translateX(100%);
  }

  to {
    transform: none;
  }
}

@-webkit-keyframes containerslidein {
  from {
    -webkit-transform: translateX(100%);
  }

  to {
    -webkit-transform: none;
  }
}

.tempfocus:focus {
  outline: none;
}

#loading {
  position: fixed;
  bottom: 0;
  right: 0;
}

.frozen {
  overflow-x: hidden;
  pointer-events: none;
}

#text img {
  max-width: 100%;
}

/*credits*/
#main.container img {
  max-width: 100%;
}

.statBar {
  background-color: #949291;
  height: 2rem;
  line-height: 2rem;
  margin: 0.5ch 0;
  width: 20rem;
  max-width: 100%;
  color: #f7f4f1;
  position: relative; /* to allow absolute positioned value */
  z-index: 0;
}
.opposed {
  background-color: #6D6DFC;
}

table {
  margin-bottom: 1.5em;
}

.statText {
  margin-left: 2ex;
  text-indent: -1ex;
}

.statBar > span, .statLine > span {
  position: relative;
  z-index: 1; /* visible over stat value */
  white-space: nowrap; /* remain on single line so we can resize font based on width */
}
.statValue {
  background-color: #ff5955;
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  z-index: -1;
  /* width will be determined at runtime, 0-100% */
}

.choice {
  margin: 1rem 0;
}

.choice > div {
  position: relative; /* so the .shuttle can be positioned absolutely within it */
  min-height: 1.25cm;
  display: flex;
  flex-direction: column;
  justify-content: center;
  border-color:#a9acaf;
  border-style:solid;
  border-width: 1px 1px 0px 1px;
}

.choice label{
    transition-property: background-color, color;
    transition-duration: 0.1s;
    -webkit-transition-property: background-color, color;
    -webkit-transition-duration: 0.1s;
    -webkit-tap-highlight-color: transparent;
    padding: 0.5em 1ch;
    display:block;
}

.shuttle {
  position: absolute;
  right: 0px;
  top: 0px;
  width: 20%;
  height: 100%;
  background-color: #626160; /* match next */
  opacity: 0.25;
  transition-property: opacity;
  transition-duration: 0.3s;
  -webkit-transition-property: opacity;
  -webkit-transition-duration: 0.3s;
}

.shuttle.discovery {
  width: 20%;
  animation-name: shuttlefadein, shuttleslide, shuttlefadeout;
  animation-duration: 0.75s, 1s, 1s;
  animation-delay: 0s, 0.75s, 1.75s;
  -webkit-animation-name: shuttlefadein, shuttleslide, shuttlefadeout;
  -webkit-animation-duration: 0.75s, 1s, 1s;
  -webkit-animation-delay: 0s, 0.75s, 1.75s;
}

@keyframes shuttlefadein {
  from {opacity: 0;}
  to {opacity: 0.25;}
}

@keyframes shuttlefadeout {
  from {opacity: 0.25; transform: translateX(-401%);} /* borders, maybe? */
  to {opacity: 0; transform: translateX(-401%);}
}

@keyframes shuttleslide {
  from { opacity: 0.25; transform: translateX(0);}
  to { opacity: 0.25; transform: translateX(-401%); }
}

@-webkit-keyframes shuttlefadein {
  from {opacity: 0;}
  to {opacity: 0.25;}
}

@-webkit-keyframes shuttlefadeout {
  from {opacity: 0.25; -webkit-transform: translateX(-401%);} /* borders, maybe? */
  to {opacity: 0; -webkit-transform: translateX(-401%);}
}

@-webkit-keyframes shuttleslide {
  from { opacity: 0.25; -webkit-transform: translateX(0);}
  to { opacity: 0.25; -webkit-transform: translateX(-401%); }
}

.selected {
  color: rgba(255,255,255,0.85);
  background-color: #007AFF;
}

.selectedKeyboard, .choice>div.selectedKeyboard:hover, .next.selectedKeyboard {
  color: rgba(255, 255, 255, 0.85);
  background-color: #007AFF;
  transition-property: background-color, color;
  transition-duration: 0.5s;
  transition-timing-function: linear;
  -webkit-transition-property: background-color, color;
  -webkit-transition-duration: 0.5s;
  -webkit-transition-timing-function: linear;
}

.choice>div:first-child{
    border-top-width:1px;
    -webkit-border-top-right-radius:1ch;
    -webkit-border-top-left-radius:1ch;
    border-top-right-radius:1ch;
    border-top-left-radius:1ch;
}
/* IE doesn't support label:last-child */
.choice>div:last-child{
    border-bottom-width:1px;
    -webkit-border-bottom-right-radius:1ch;
    -webkit-border-bottom-left-radius:1ch;
    border-bottom-right-radius:1ch;
    border-bottom-left-radius:1ch;
}

.choice .noBorder {
  border-width: 0;
}

input[type="radio"], input[type="checkbox"] {
  margin-right: 1ch;
}

.saveGame>label {
  display:block;
}

.choice .disabled {
  color: gray;
}

input[type=password]:disabled {
  background-color: lightgray;
}

/* Reset for Firefox vs. Chrome */
input[type=email],input[type=password] {
  padding: 1px;
  margin: 2px 0;
}

button {
  font-size: 100%;
}

.next {
    clear: both;
    display:block;
    width:100%;
    font-size:1.5em;
    font-weight:bolder;
    font-family: -apple-system, sans-serif; /* reset, for Android */
    margin: 1rem 0; /* reset button margin */
    -webkit-appearance: none; /* Safari, don't override my CSS styles */
    color: #f7f4f1; /* Match background color */ 
    background-color: #626160;
    border: none;
    -webkit-border-radius: 0.5em;
    -moz-border-radius: 0.5em;
    border-radius: 0.5em;
    padding: 6px;
}

.linkButton {
  text-align: center;
  text-decoration: none;
}

.next:hover {
  color: #E4DED8;
}

h1 {
  font-size: 1.5em;
  font-weight: normal;
}

h2 {
  font-size: 1.125em;
  font-weight: normal;
}

#identity {
  float: right;
}

#identity > a {
  display: block;
  text-align: end;
}

#footer {
  margin:10px 0px 75px 0px;
}

#mobileLinks a img {
  border: 0;
}

.mobileBadges {
  margin: 0;
}

.spacedLink {
  margin-right:0.5em;
}

.spacedLink:last-child {
  margin-right:0;
}

#sharelist {
  margin: 0; /* Eliminate leading space before share links */
}

#sharelist li {
  line-height: 1cm; /* Don't let the links bunch up */
}

.alertify-cover {
  background-color: black;
  filter:alpha(opacity=50);
  opacity: 0.5;
}

#greybackground {
    position: fixed;
    width:100%;
    height:100%;
    background-color: black;
    filter:alpha(opacity=50);
    opacity: 0.5;
    top:0;
    left:0;
}

.savePassword {
  font-family: monospace;
  display: block;
}

.webOnly { /* We'll override this in JavaScript */
  display: none;
}

.alignleft {
  display: inline;
  float: left;
  margin-right: 1.625em;
  margin-bottom: 1.5em;
}
.alignright {
  display: inline;
  float: right;
  margin-left: 1.625em;
  margin-bottom: 1.5em;
}
.aligncenter {
  clear: both;
  display: block;
  margin-left: auto;
  margin-right: auto;
  margin-bottom: 1.5em;
}

#main form {
  clear: both;
}

.paidOnly {
  display: none;
}

.videoWrapper {
  position: relative;
  padding-bottom: 56.25%; /* 16:9 */
  height: 0;
}

.videoWrapper iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

body.nightmode {
  background-color: #242424;
  color: rgba(255,255,255,0.85);
}

body.nightmode a {
  color: #7bc8fa;
}

body.nightmode .next {
  color: #242424; /* Match background color */
  background-color: #D9D9D9;
}

body.nightmode .shuttle {
  background-color: #D9D9D9;
}

body.nightmode .next:hover {
  color: #555;
}

body.nightmode .alertify {
  color: black;
}

body.nightmode a.alertify-button {
  color: white;
}

body.nightmode img.invert {
  -webkit-filter: invert(100%);
  filter: invert(100%);
}

body.whitemode {
  background-color: white;
}

body.whitemode .next {
  color: white; /* Match background color */
}

body.whitemode .next:hover {
  color: #ddd;
}

/* hide <dialog> on old browsers */
dialog:not([open]) {
  display: none;
}

#keyboardShortcuts {
  font-family: system-ui;
}

#keyboardShortcuts::backdrop {
  background: rgba(0, 0, 0, 0.4);
}

#keyboardShortcuts header {
  display: flex;
  justify-content: space-between;
}

#keyboardShortcuts header span {
  font-weight: bold;
}

#keyboardShortcuts .table {
  display: grid;
  grid-template-columns: 1fr 1fr;
}

#keyboardShortcuts .table div {
  padding: 0.5em;
}

#keyboardShortcuts .key {
  background-color: ghostwhite;
  border: thin solid lightgrey;
  border-radius: 5px;
  padding: 0.3em;
  font-family: monospace;
}

#text .gameTitle {
  display: none;
}

@media (max-width: 480px) or (max-height: 640px) {
  .definition{
    display: none;
  }
  
  #headerLinks {
    display: none;
  }

  #title {
    font-size: 1.125em;
  }

  #author {
    display: none;
  }

  #text .gameTitle {
    display: block;
  }

  #advertisement {
    margin: -8px;
  }
  
  .mobileBadges {
    float: none;
  }
  
  #header {
    margin-top: 30px;
  }

  /** Floating images should leave enough room for text */
  #text .alignleft, #text .alignright {
    max-width: 45%;
  }
  
  #identity {
    display: none;
  }
}

@media (max-width: 375px) {
  #achievementsButton {
    display: none;
  }
}.alertify-show,
.alertify-log {
	-webkit-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1); /* older webkit */
	-webkit-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275);
	   -moz-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275);
	    -ms-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275);
	     -o-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275);
	        transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275); /* easeOutBack */
}
.alertify-hide {
	-webkit-transition: all 250ms cubic-bezier(0.600, 0, 0.735, 0.045); /* older webkit */
	-webkit-transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045);
	   -moz-transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045);
	    -ms-transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045);
	     -o-transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045);
	        transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045); /* easeInBack */
}
.alertify-cover {
	position: fixed; z-index: 99999;
	top: 0; right: 0; bottom: 0; left: 0;
}
.alertify {
	position: fixed; z-index: 99999;
	top: 50px; left: 50%;
	width: 550px;
	margin-left: -275px;
}
	.alertify-hidden {
		top: -50px;
		visibility: hidden;
	}
.alertify-logs {
	position: fixed;
	z-index: 5000;
	bottom: 10px;
	right: 10px;
	width: 300px;
}
	.alertify-log {
		display: block;
		margin-top: 10px;
		position: relative;
		right: -300px;
	}
	.alertify-log-show {
		right: 0;
	}
	.alertify-dialog {
		padding: 25px;
	}
		.alertify-resetFocus {
			border: 0;
			clip: rect(0 0 0 0);
			height: 1px;
			margin: -1px;
			overflow: hidden;
			padding: 0;
			position: absolute;
			width: 1px;
		}
		.alertify-inner {
			text-align: center;
		}
		.alertify-text {
			margin-bottom: 15px;
			width: 100%;
			-webkit-box-sizing: border-box;
			   -moz-box-sizing: border-box;
			        box-sizing: border-box;
			font-size: 100%;
		}
		.alertify-buttons {
		}
			.alertify-button {
				/* line-height and font-size for input button */
				line-height: 1.5;
				font-size: 100%;
				display: inline-block;
				cursor: pointer;
				margin-left: 5px;
			}

@media only screen and (max-width: 680px) {
	.alertify,
	.alertify-logs {
		width: 90%;
		-webkit-box-sizing: border-box;
		   -moz-box-sizing: border-box;
		        box-sizing: border-box;
	}
	.alertify {
		left: 5%;
		margin: 0;
	}
}
/**
 * Default Look and Feel
 */
.alertify,
.alertify-log {
	font-family: sans-serif;
}
.alertify {
	background: #FFF;
	border: 10px solid #333; /* browsers that don't support rgba */
	border: 10px solid rgba(0,0,0,.7);
	border-radius: 8px;
	box-shadow: 0 3px 3px rgba(0,0,0,.3);
	-webkit-background-clip: padding;     /* Safari 4? Chrome 6? */
	   -moz-background-clip: padding;     /* Firefox 3.6 */
	        background-clip: padding-box; /* Firefox 4, Safari 5, Opera 10, IE 9 */
}
	.alertify-text {
		border: 1px solid #CCC;
		padding: 10px;
		border-radius: 4px;
	}
	.alertify-button {
		border-radius: 4px;
		color: #FFF;
		font-weight: bold;
		padding: 6px 15px;
		text-decoration: none;
		text-shadow: 1px 1px 0 rgba(0,0,0,.5);
		box-shadow: inset 0 1px 0 0 rgba(255,255,255,.5);
		background-image: -webkit-linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
		background-image:    -moz-linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
		background-image:     -ms-linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
		background-image:      -o-linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
		background-image:         linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
	}
	.alertify-button:hover,
	.alertify-button:focus {
		outline: none;
		box-shadow: 0 0 15px #2B72D5;
		background-image: -webkit-linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
		background-image:    -moz-linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
		background-image:     -ms-linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
		background-image:      -o-linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
		background-image:         linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
	}
	.alertify-button:active {
		position: relative;
		top: 1px;
	}
		.alertify-button-cancel {
			background-color: #FE1A00;
			border: 1px solid #D83526;
		}
		.alertify-button-ok {
			background-color: #5CB811;
			border: 1px solid #3B7808;
		}
		
.alertify-log {
	background: #1F1F1F;
	background: rgba(0,0,0,.9);
	padding: 15px;
	border-radius: 4px;
	color: #FFF;
	text-shadow: -1px -1px 0 rgba(0,0,0,.5);
}
	.alertify-log-error {
		background: #FE1A00;
		background: rgba(254,26,0,.9);
	}
	.alertify-log-success {
		background: #5CB811;
		background: rgba(92,184,17,.9);
	}</style></head>
<body><div class="container" id="container1">
<div id="advertisement">
</div>
<div id="header">
  <div id="identity"><a href="#" id="email" style="display: none">you@example.com</a>
  <a href="#" onclick="logout(); loginDiv(); return false;" id="logout" style="display: none">Sign Out</a>
  </div>

  <h1 class='gameTitle'>Below the Skyline</h1>
<h2 id="author" class="gameTitle">by dozendietcokesaday</h2>

  <p id="headerLinks">
      <!-- <a href="credits.html" id="aboutLink" class="spacedLink">About</a> -->
    </p>
  <p id="buttons">
    <button id="statsButton" class="spacedLink" onclick="showStats()">Show Stats</button>
    <button id="achievementsButton" onclick="showAchievements()" class="spacedLink" style="display: none">Achievements</button>
    <button id="bugButton" onclick="reportBug()" class="spacedLink" style="display: none">Report Bug</button>
    <button id="menuButton" onclick="showMenu()" class="spacedLink">Menu</button>
  </p>
</div>
<div id="main">
<div id="text">
</div>
<script>
startLoading();
</script>
</div>
<div id="mobileLinks" class="webOnly">
</div>
<noscript>
<p>This game requires JavaScript; please enable JavaScript and refresh this page.</p>
</noscript>
<p><a id="makeyourowngames" href="https://www.choiceofgames.com/make-your-own-games/choicescript-intro/">Make your own games with ChoiceScript</a></p>
<div id="tools"></div>
<script type="module">
if (window.location.hostname === 'localhost') {
  const links = ['quicktest', 'randomtest', 'compile'];
  await Promise.all(Object.values(links).map(async file => {
    const link = `../../${file}.html`;
    const response = await fetch(link);
    if (!response.ok) throw new Error(`invalid link ${link}: ${response.status} ${response.statusText} ${await response.text()}`);
  }));
  window.tools.innerHTML = `
    <p>Tests: <a href="../../quicktest.html">Quicktest</a> <a href="../../randomtest.html">Randomtest</a></p>
    <p><a href="../../compile.html">Export to HTML</a></p>
  `
}
</script>
<dialog id="keyboardShortcuts" onclick="event.target === this && this.close()">
<header><span>Keyboard Shortcuts</span> <form method=dialog><button>X</button></form></header>
<div class="table">
  <div>Scroll Down</div>
  <div><span class="key">Space</span></div>
  <div>Scroll Up</div>
  <div><span class="key">Shift</span> + <span class="key">Space</span></div>
  <div>Next Option</div>
  <div><span class="key">J</span></div>
  <div>Previous Option</div>
  <div><span class="key">K</span></div>
  <div>Next (Press and Hold)</div>
  <div><span class="key">Enter</span></div>
  <div>Jump to Option</div>
  <div><span class="key">1</span> - <span class="key">9</span></div>
  <div>Show Stats</div>
  <div><span class="key">Q</span></div>
  <div>Menu</div>
  <div><span class="key">W</span></div>
  <div>Show Shortcuts</div>
  <div><span class="key">?</span></div>
</div>
</dialog>
</body>
</html>
